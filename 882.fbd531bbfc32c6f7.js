"use strict";(self.webpackChunkfretboard_explorer=self.webpackChunkfretboard_explorer||[]).push([[882],{467:(dh,Ba,_r)=>{function dt(zi,cs,ds,Wt,Vt,Oe,nt){try{var ot=zi[Oe](nt),Rs=ot.value}catch(Ui){return void ds(Ui)}ot.done?cs(Rs):Promise.resolve(Rs).then(Wt,Vt)}function _a(zi){return function(){var cs=this,ds=arguments;return new Promise(function(Wt,Vt){var Oe=zi.apply(cs,ds);function nt(Rs){dt(Oe,Wt,Vt,nt,ot,"next",Rs)}function ot(Rs){dt(Oe,Wt,Vt,nt,ot,"throw",Rs)}nt(void 0)})}}_r.d(Ba,{A:()=>_a})},882:(dh,Ba,_r)=>{_r.d(Ba,{OH:()=>_});var dt=_r(467);typeof Symbol.dispose>"u"&&(Symbol.dispose=Symbol("Symbol.dispose")),typeof window<"u"&&("ResizeObserver"in globalThis||(globalThis.ResizeObserver=class _a{constructor(t){this._targets=new Set,this._callback=t,window.addEventListener("resize",this.onWindowResize.bind(this),!1)}observe(t){this._targets.add(t)}unobserve(t){this._targets.delete(t)}disconnect(){this._targets.clear()}onWindowResize(){const t=[];for(const e of this._targets)t.push({target:e,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this._callback(t,this)}}),"IntersectionObserver"in globalThis||(globalThis.IntersectionObserver=class zi{constructor(t){this._elements=[];let e=null;const s=this.check.bind(this);this.check=()=>{e||(e=setTimeout(()=>{s(),e=null},100))},this._callback=t,window.addEventListener("resize",this.check,!0),document.addEventListener("scroll",this.check,!0)}observe(t){this._elements.indexOf(t)>=0||(this._elements.push(t),this.check())}unobserve(t){this._elements=this._elements.filter(e=>e!==t)}check(){const t=[];for(const e of this._elements){const s=e.getBoundingClientRect();s.top+s.height>=0&&s.top<=window.innerHeight&&s.left+s.width>=0&&s.left<=window.innerWidth&&t.push({target:e,isIntersecting:!0})}t.length&&this._callback(t,this)}}),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...r){this.innerHTML="",this.append(...r)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren)),"replaceAll"in String.prototype||(String.prototype.replaceAll=function(r,t){return this.replace(new RegExp(r,"g"),t)});var cs=function(r){return r[r.Page=0]="Page",r[r.Horizontal=1]="Horizontal",r}(cs||{}),ds=function(r){return r[r.Default=0]="Default",r[r.ScoreTab=1]="ScoreTab",r[r.Score=2]="Score",r[r.Tab=3]="Tab",r[r.TabMixed=4]="TabMixed",r}(ds||{});class Wt{static getValue(t){return Wt._values||(Wt._values=new Map),t=t.toLowerCase().replaceAll(" ",""),Wt._values.has(t)?Wt._values.get(t):0}static isPiano(t){return t<=7||t>=16&&t<=23}static isGuitar(t){return t>=24&&t<=39||105===t||43===t}}Wt._values=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]);var Vt=function(r){return r[r.NoBrackets=0]="NoBrackets",r[r.GroupStaves=1]="GroupStaves",r[r.GroupSimilarInstruments=2]="GroupSimilarInstruments",r}(Vt||{}),Oe=function(r){return r[r.Hidden=0]="Hidden",r[r.FirstSystem=1]="FirstSystem",r[r.AllSystems=2]="AllSystems",r}(Oe||{}),nt=function(r){return r[r.FullName=0]="FullName",r[r.ShortName=1]="ShortName",r}(nt||{}),ot=function(r){return r[r.Horizontal=0]="Horizontal",r[r.Vertical=1]="Vertical",r}(ot||{});class Rs{constructor(){this.hideDynamics=!1,this.bracketExtendMode=Vt.GroupStaves,this.useSystemSignSeparator=!1,this.globalDisplayTuning=!0,this.perTrackDisplayTuning=null,this.globalDisplayChordDiagramsOnTop=!0,this.perTrackChordDiagramsOnTop=null,this.singleTrackTrackNamePolicy=Oe.FirstSystem,this.multiTrackTrackNamePolicy=Oe.FirstSystem,this.firstSystemTrackNameMode=nt.ShortName,this.otherSystemsTrackNameMode=nt.ShortName,this.firstSystemTrackNameOrientation=ot.Vertical,this.otherSystemsTrackNameOrientation=ot.Vertical,this.multiTrackMultiBarRest=!1,this.perTrackMultiBarRest=null}}class Ui{constructor(){this.masterBars=[],this.opening=null,this.closings=[],this.isClosed=!1}get openings(){const t=this.opening;return t?[t]:[]}get isOpened(){return!0===this.opening?.isRepeatStart}addMasterBar(t){null===this.opening&&(this.opening=t),this.masterBars.push(t),t.repeatGroup=this,t.isRepeatEnd&&(this.closings.push(t),this.isClosed=!0)}}class di{constructor(){this.colors=new Map}}var Se=function(r){return r[r.Neutral=0]="Neutral",r[r.C3=1]="C3",r[r.C4=2]="C4",r[r.F4=3]="F4",r[r.G2=4]="G2",r}(Se||{}),le=function(r){return r[r._15ma=0]="_15ma",r[r._8va=1]="_8va",r[r.Regular=2]="Regular",r[r._8vb=3]="_8vb",r[r._15mb=4]="_15mb",r}(le||{}),je=function(r){return r[r.None=0]="None",r[r.Simple=1]="Simple",r[r.FirstOfDouble=2]="FirstOfDouble",r[r.SecondOfDouble=3]="SecondOfDouble",r}(je||{}),ye=function(r){return r[r.Cb=-7]="Cb",r[r.Gb=-6]="Gb",r[r.Db=-5]="Db",r[r.Ab=-4]="Ab",r[r.Eb=-3]="Eb",r[r.Bb=-2]="Bb",r[r.F=-1]="F",r[r.C=0]="C",r[r.G=1]="G",r[r.D=2]="D",r[r.A=3]="A",r[r.E=4]="E",r[r.B=5]="B",r[r.FSharp=6]="FSharp",r[r.CSharp=7]="CSharp",r}(ye||{}),It=function(r){return r[r.Major=0]="Major",r[r.Minor=1]="Minor",r}(It||{}),rt=function(r){return r[r.Down=0]="Down",r[r.Hold=1]="Hold",r[r.Up=2]="Up",r}(rt||{});class Ks{constructor(){this.ratioPosition=0,this.pedalType=rt.Down,this.nextPedalMarker=null,this.previousPedalMarker=null}}var Be=function(r){return r[r.StandardNotationRepeats=0]="StandardNotationRepeats",r[r.GuitarTabsRepeats=1]="GuitarTabsRepeats",r[r.SlashRepeats=2]="SlashRepeats",r[r.NumberedRepeats=3]="NumberedRepeats",r[r.StandardNotationBarNumber=4]="StandardNotationBarNumber",r[r.GuitarTabsBarNumber=5]="GuitarTabsBarNumber",r[r.SlashBarNumber=6]="SlashBarNumber",r[r.NumberedBarNumber=7]="NumberedBarNumber",r[r.StandardNotationBarLines=8]="StandardNotationBarLines",r[r.GuitarTabsBarLines=9]="GuitarTabsBarLines",r[r.SlashBarLines=10]="SlashBarLines",r[r.NumberedBarLines=11]="NumberedBarLines",r[r.StandardNotationClef=12]="StandardNotationClef",r[r.GuitarTabsClef=13]="GuitarTabsClef",r[r.StandardNotationKeySignature=14]="StandardNotationKeySignature",r[r.NumberedKeySignature=15]="NumberedKeySignature",r[r.StandardNotationTimeSignature=16]="StandardNotationTimeSignature",r[r.GuitarTabsTimeSignature=17]="GuitarTabsTimeSignature",r[r.SlashTimeSignature=18]="SlashTimeSignature",r[r.NumberedTimeSignature=19]="NumberedTimeSignature",r[r.StandardNotationStaffLine=20]="StandardNotationStaffLine",r[r.GuitarTabsStaffLine=21]="GuitarTabsStaffLine",r[r.SlashStaffLine=22]="SlashStaffLine",r[r.NumberedStaffLine=23]="NumberedStaffLine",r}(Be||{});class On extends di{}var te=function(r){return r[r.Automatic=0]="Automatic",r[r.Dashed=1]="Dashed",r[r.Dotted=2]="Dotted",r[r.Heavy=3]="Heavy",r[r.HeavyHeavy=4]="HeavyHeavy",r[r.HeavyLight=5]="HeavyLight",r[r.LightHeavy=6]="LightHeavy",r[r.LightLight=7]="LightLight",r[r.None=8]="None",r[r.Regular=9]="Regular",r[r.Short=10]="Short",r[r.Tick=11]="Tick",r}(te||{});let Ts=(()=>{class r{constructor(){this.id=r._globalBarId++,this.index=0,this.nextBar=null,this.previousBar=null,this.clef=Se.G2,this.clefOttava=le.Regular,this.voices=[],this.simileMark=je.None,this.isMultiVoice=!1,this.displayScale=1,this.displayWidth=-1,this.sustainPedals=[],this._isEmpty=!0,this._isRestOnly=!0,this.barLineLeft=te.Automatic,this.barLineRight=te.Automatic,this.keySignature=ye.C,this.keySignatureType=It.Major}static resetIds(){r._globalBarId=0}get masterBar(){return this.staff.track.score.masterBars[this.index]}get isEmpty(){return this._isEmpty}get hasChanges(){return 0===this.index||this.keySignature!==this.previousBar.keySignature||this.keySignatureType!==this.previousBar.keySignatureType||this.clef!==this.previousBar.clef||this.clefOttava!==this.previousBar.clefOttava||this.simileMark!==je.None||this.sustainPedals.length>0||this.barLineLeft!==te.Automatic||this.barLineRight!==te.Automatic}get isRestOnly(){return this._isRestOnly}getActualBarLineLeft(e){return r.actualBarLine(this,!1,e)}getActualBarLineRight(){return r.actualBarLine(this,!0,!1)}static automaticToActualType(e,s,i){let a;return a=s?e.isRepeatEnd?te.LightHeavy:e.nextMasterBar?e.isFreeTime?te.Dashed:e.isDoubleBar?te.LightLight:te.Regular:te.LightHeavy:e.isRepeatStart?te.HeavyLight:i?te.Regular:te.None,a}static actualBarLine(e,s,i){const n=s?e.barLineRight:e.barLineLeft;let o;return o=n===te.Automatic?r.automaticToActualType(e.masterBar,s,i):n,o}addVoice(e){e.bar=this,e.index=this.voices.length,this.voices.push(e)}finish(e,s=null){this.isMultiVoice=!1,this._isEmpty=!0,this._isRestOnly=!0;for(let a=0,n=this.voices.length;a<n;a++){const o=this.voices[a];o.finish(e,s),a>0&&!o.isEmpty&&(this.isMultiVoice=!0),o.isEmpty||(this._isEmpty=!1),o.isRestOnly||(this._isRestOnly=!1)}const i=this.sustainPedals;if(i.length>0){let a=null;this.sustainPedals=[],this.previousBar&&this.previousBar.sustainPedals.length>0&&(a=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1]);const n=null!==a&&a.pedalType!==rt.Up;for(const o of i){if(a&&a.pedalType!==rt.Up){if(a.bar===this&&o.ratioPosition<=a.ratioPosition)continue;a.nextPedalMarker=o,o.previousPedalMarker=a}n&&o.pedalType===rt.Down&&(o.pedalType=rt.Hold),o.bar=this,this.sustainPedals.push(o),a=o}}else if(this.previousBar&&this.previousBar.sustainPedals.length>0){const a=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1];if(a.pedalType!==rt.Up){const n=new Ks;n.ratioPosition=0,n.bar=this,n.pedalType=rt.Hold,this.sustainPedals.push(n),a.nextPedalMarker=n,n.previousPedalMarker=a}}}calculateDuration(){let e=0;for(const s of this.voices){const i=s.calculateDuration();i>e&&(e=i)}return e}}return r._globalBarId=0,r})();var J=function(r){return r[r.PPP=0]="PPP",r[r.PP=1]="PP",r[r.P=2]="P",r[r.MP=3]="MP",r[r.MF=4]="MF",r[r.F=5]="F",r[r.FF=6]="FF",r[r.FFF=7]="FFF",r[r.PPPP=8]="PPPP",r[r.PPPPP=9]="PPPPP",r[r.PPPPPP=10]="PPPPPP",r[r.FFFF=11]="FFFF",r[r.FFFFF=12]="FFFFF",r[r.FFFFFF=13]="FFFFFF",r[r.SF=14]="SF",r[r.SFP=15]="SFP",r[r.SFPP=16]="SFPP",r[r.FP=17]="FP",r[r.RF=18]="RF",r[r.RFZ=19]="RFZ",r[r.SFZ=20]="SFZ",r[r.SFFZ=21]="SFFZ",r[r.FZ=22]="FZ",r[r.N=23]="N",r[r.PF=24]="PF",r[r.SFZP=25]="SFZP",r}(J||{});let C=(()=>{class r{static ticksToMillis(e,s){return e*(6e4/(s*r.QuarterTime))|0}static millisToTicks(e,s){return e/(6e4/(s*r.QuarterTime))|0}static toTicks(e){return r.valueToTicks(e)}static valueToTicks(e){let s=e;return s<0&&(s=1/-s),r.QuarterTime*(4/s)|0}static applyDot(e,s){return s?e+3*(e/4|0):e+(e/2|0)}static applyTuplet(e,s,i){return e*i/s|0}static removeTuplet(e,s,i){return e*s/i|0}static dynamicToVelocity(e,s=0){let i=1;switch(e){case J.PPP:i=r.MinVelocity+0*r.VelocityIncrement;break;case J.PP:i=r.MinVelocity+1*r.VelocityIncrement;break;case J.P:i=r.MinVelocity+2*r.VelocityIncrement;break;case J.MP:i=r.MinVelocity+3*r.VelocityIncrement;break;case J.MF:i=r.MinVelocity+4*r.VelocityIncrement;break;case J.F:i=r.MinVelocity+5*r.VelocityIncrement;break;case J.FF:i=r.MinVelocity+6*r.VelocityIncrement;break;case J.FFF:i=r.MinVelocity+7*r.VelocityIncrement;break;case J.PPPP:i=10;break;case J.PPPPP:i=5;break;case J.PPPPPP:i=3;break;case J.FFFF:i=r.MinVelocity+8*r.VelocityIncrement;break;case J.FFFFF:i=r.MinVelocity+9*r.VelocityIncrement;break;case J.FFFFFF:i=r.MinVelocity+10*r.VelocityIncrement;break;case J.SF:case J.SFP:case J.SFZP:case J.SFPP:case J.SFZ:case J.FZ:i=r.MinVelocity+6*r.VelocityIncrement;break;case J.FP:case J.RF:case J.RFZ:case J.SFFZ:i=r.MinVelocity+5*r.VelocityIncrement;break;case J.N:i=1;break;case J.PF:i=r.MinVelocity+(4.5*r.VelocityIncrement|0)}return i+=s*r.VelocityIncrement,Math.min(Math.max(i,1),127)}}return r.QuarterTime=960,r.MinVelocity=15,r.VelocityIncrement=16,r})();var Ge=function(r){return r[r.Tempo=0]="Tempo",r[r.Volume=1]="Volume",r[r.Instrument=2]="Instrument",r[r.Balance=3]="Balance",r[r.SyncPoint=4]="SyncPoint",r}(Ge||{});class Yi{constructor(){this.barOccurence=0,this.millisecondOffset=0}}class Qe{constructor(){this.isLinear=!1,this.type=Ge.Tempo,this.value=0,this.ratioPosition=0,this.text=""}static buildTempoAutomation(t,e,s,i){(i<1||i>5)&&(i=2);const a=new Float32Array([1,.5,1,1.5,2,3]),n=new Qe;return n.type=Ge.Tempo,n.isLinear=t,n.ratioPosition=e,n.value=s*a[i],n}static buildInstrumentAutomation(t,e,s){const i=new Qe;return i.type=Ge.Instrument,i.isLinear=t,i.ratioPosition=e,i.value=s,i}}let R=(()=>{class r{constructor(e=0,s=0){this.offset=e,this.value=s}}return r.MaxPosition=60,r.MaxValue=12,r})();var Ie=function(r){return r[r.Default=0]="Default",r[r.Gradual=1]="Gradual",r[r.Fast=2]="Fast",r}(Ie||{}),z=function(r){return r[r.None=0]="None",r[r.Custom=1]="Custom",r[r.Bend=2]="Bend",r[r.Release=3]="Release",r[r.BendRelease=4]="BendRelease",r[r.Hold=5]="Hold",r[r.Prebend=6]="Prebend",r[r.PrebendBend=7]="PrebendBend",r[r.PrebendRelease=8]="PrebendRelease",r}(z||{}),V=function(r){return r[r.None=0]="None",r[r.BrushUp=1]="BrushUp",r[r.BrushDown=2]="BrushDown",r[r.ArpeggioUp=3]="ArpeggioUp",r[r.ArpeggioDown=4]="ArpeggioDown",r}(V||{}),Ft=function(r){return r[r.None=0]="None",r[r.Crescendo=1]="Crescendo",r[r.Decrescendo=2]="Decrescendo",r}(Ft||{}),m=function(r){return r[r.QuadrupleWhole=-4]="QuadrupleWhole",r[r.DoubleWhole=-2]="DoubleWhole",r[r.Whole=1]="Whole",r[r.Half=2]="Half",r[r.Quarter=4]="Quarter",r[r.Eighth=8]="Eighth",r[r.Sixteenth=16]="Sixteenth",r[r.ThirtySecond=32]="ThirtySecond",r[r.SixtyFourth=64]="SixtyFourth",r[r.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",r[r.TwoHundredFiftySixth=256]="TwoHundredFiftySixth",r}(m||{}),K=function(r){return r[r.None=0]="None",r[r.OnBeat=1]="OnBeat",r[r.BeforeBeat=2]="BeforeBeat",r[r.BendGrace=3]="BendGrace",r}(K||{}),et=function(r){return r[r.None=0]="None",r[r.Normal=1]="Normal",r[r.Heavy=2]="Heavy",r[r.Tenuto=3]="Tenuto",r}(et||{}),Q=function(r){return r[r.Unknown=-2]="Unknown",r[r.NoOrDead=-1]="NoOrDead",r[r.Thumb=0]="Thumb",r[r.IndexFinger=1]="IndexFinger",r[r.MiddleFinger=2]="MiddleFinger",r[r.AnnularFinger=3]="AnnularFinger",r[r.LittleFinger=4]="LittleFinger",r}(Q||{}),Z=function(r){return r[r.None=0]="None",r[r.Natural=1]="Natural",r[r.Artificial=2]="Artificial",r[r.Pinch=3]="Pinch",r[r.Tap=4]="Tap",r[r.Semi=5]="Semi",r[r.Feedback=6]="Feedback",r}(Z||{}),ge=function(r){return r[r.Default=0]="Default",r[r.ForceNone=1]="ForceNone",r[r.ForceNatural=2]="ForceNatural",r[r.ForceSharp=3]="ForceSharp",r[r.ForceDoubleSharp=4]="ForceDoubleSharp",r[r.ForceFlat=5]="ForceFlat",r[r.ForceDoubleFlat=6]="ForceDoubleFlat",r}(ge||{}),ut=function(r){return r[r.None=0]="None",r[r.IntoFromBelow=1]="IntoFromBelow",r[r.IntoFromAbove=2]="IntoFromAbove",r}(ut||{}),ce=function(r){return r[r.None=0]="None",r[r.Shift=1]="Shift",r[r.Legato=2]="Legato",r[r.OutUp=3]="OutUp",r[r.OutDown=4]="OutDown",r[r.PickSlideDown=5]="PickSlideDown",r[r.PickSlideUp=6]="PickSlideUp",r}(ce||{}),ke=function(r){return r[r.None=0]="None",r[r.Slight=1]="Slight",r[r.Wide=2]="Wide",r}(ke||{}),ps=function(r){return r[r.Hidden=0]="Hidden",r[r.ShowWithBeams=1]="ShowWithBeams",r[r.ShowWithBars=2]="ShowWithBars",r[r.Automatic=3]="Automatic",r}(ps||{}),xs=function(r){return r[r.ScoreDefault=0]="ScoreDefault",r[r.ScoreForcePiano=1]="ScoreForcePiano",r[r.SingleNoteEffectBand=2]="SingleNoteEffectBand",r[r.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano",r}(xs||{}),_t=function(r){return r[r.GuitarPro=0]="GuitarPro",r[r.SongBook=1]="SongBook",r}(_t||{}),fe=function(r){return r[r.ScoreTitle=0]="ScoreTitle",r[r.ScoreSubTitle=1]="ScoreSubTitle",r[r.ScoreArtist=2]="ScoreArtist",r[r.ScoreAlbum=3]="ScoreAlbum",r[r.ScoreWords=4]="ScoreWords",r[r.ScoreMusic=5]="ScoreMusic",r[r.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",r[r.ScoreCopyright=7]="ScoreCopyright",r[r.GuitarTuning=8]="GuitarTuning",r[r.TrackNames=9]="TrackNames",r[r.ChordDiagrams=10]="ChordDiagrams",r[r.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",r[r.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",r[r.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",r[r.EffectAlternateEndings=14]="EffectAlternateEndings",r[r.EffectCapo=15]="EffectCapo",r[r.EffectChordNames=16]="EffectChordNames",r[r.EffectCrescendo=17]="EffectCrescendo",r[r.EffectDynamics=18]="EffectDynamics",r[r.EffectFadeIn=19]="EffectFadeIn",r[r.EffectFermata=20]="EffectFermata",r[r.EffectFingering=21]="EffectFingering",r[r.EffectHarmonics=22]="EffectHarmonics",r[r.EffectLetRing=23]="EffectLetRing",r[r.EffectLyrics=24]="EffectLyrics",r[r.EffectMarker=25]="EffectMarker",r[r.EffectOttavia=26]="EffectOttavia",r[r.EffectPalmMute=27]="EffectPalmMute",r[r.EffectPickSlide=28]="EffectPickSlide",r[r.EffectPickStroke=29]="EffectPickStroke",r[r.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",r[r.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",r[r.EffectTap=32]="EffectTap",r[r.EffectTempo=33]="EffectTempo",r[r.EffectText=34]="EffectText",r[r.EffectTrill=35]="EffectTrill",r[r.EffectTripletFeel=36]="EffectTripletFeel",r[r.EffectWhammyBar=37]="EffectWhammyBar",r[r.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",r[r.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",r[r.EffectLeftHandTap=40]="EffectLeftHandTap",r[r.EffectFreeTime=41]="EffectFreeTime",r[r.EffectSustainPedal=42]="EffectSustainPedal",r[r.EffectGolpe=43]="EffectGolpe",r[r.EffectWahPedal=44]="EffectWahPedal",r[r.EffectBeatBarre=45]="EffectBeatBarre",r[r.EffectNoteOrnament=46]="EffectNoteOrnament",r[r.EffectRasgueado=47]="EffectRasgueado",r[r.EffectDirections=48]="EffectDirections",r[r.EffectBeatTimer=49]="EffectBeatTimer",r}(fe||{});class Xi{constructor(){this.notationMode=_t.GuitarPro,this.fingeringMode=xs.ScoreDefault,this.elements=new Map,this.rhythmMode=ps.Automatic,this.rhythmHeight=15,this.transpositionPitches=[],this.displayTranspositionPitches=[],this.smallGraceTabNotes=!0,this.extendBendArrowsOnTiedNotes=!0,this.extendLineEffectsToBeatEnd=!1,this.slurHeight=5}isNotationElementVisible(t){return this.elements.has(t)?this.elements.get(t):!Xi.defaultElements.has(t)||Xi.defaultElements.get(t)}}Xi.defaultElements=new Map([[fe.ZerosOnDiveWhammys,!1]]);class Ji{constructor(t){this._value=void 0,this._factory=t}get value(){return void 0===this._value&&(this._value=this._factory()),this._value}}var Ns=function(r){return r[r.None=0]="None",r[r.Debug=1]="Debug",r[r.Info=2]="Info",r[r.Warning=3]="Warning",r[r.Error=4]="Error",r}(Ns||{});class ui{static format(t,e){return`[AlphaTab][${t}] ${e}`}debug(t,e,...s){console.debug(ui.format(t,e),...s)}warning(t,e,...s){console.warn(ui.format(t,e),...s)}info(t,e,...s){console.info(ui.format(t,e),...s)}error(t,e,...s){console.error(ui.format(t,e),...s)}}ui.logLevel=Ns.Info;class x{static shouldLog(t){return x.logLevel!==Ns.None&&t>=x.logLevel}static debug(t,e,...s){x.shouldLog(Ns.Debug)&&x.log.debug(t,e,...s)}static warning(t,e,...s){x.shouldLog(Ns.Warning)&&x.log.warning(t,e,...s)}static info(t,e,...s){x.shouldLog(Ns.Info)&&x.log.info(t,e,...s)}static error(t,e,...s){x.shouldLog(Ns.Error)&&x.log.error(t,e,...s)}}x.logLevel=Ns.Info,x.log=new ui;var ue=function(r){return r[r.NoTripletFeel=0]="NoTripletFeel",r[r.Triplet16th=1]="Triplet16th",r[r.Triplet8th=2]="Triplet8th",r[r.Dotted16th=3]="Dotted16th",r[r.Dotted8th=4]="Dotted8th",r[r.Scottish16th=5]="Scottish16th",r[r.Scottish8th=6]="Scottish8th",r}(ue||{});let Ps=(()=>{class r{constructor(){this.alternateEndings=0,this.nextMasterBar=null,this.previousMasterBar=null,this.index=0,this.isDoubleBar=!1,this.isRepeatStart=!1,this.repeatCount=0,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.timeSignatureCommon=!1,this.isFreeTime=!1,this.tripletFeel=ue.NoTripletFeel,this.section=null,this.tempoAutomations=[],this.fermata=null,this.start=0,this.isAnacrusis=!1,this.displayScale=1,this.displayWidth=-1,this.directions=null}get hasChanges(){return 0!==this.index&&(this.timeSignatureCommon!==this.previousMasterBar.timeSignatureCommon||this.timeSignatureNumerator!==this.previousMasterBar.timeSignatureNumerator||this.timeSignatureDenominator!==this.previousMasterBar.timeSignatureDenominator||this.tripletFeel!==this.previousMasterBar.tripletFeel||0!==this.alternateEndings||this.isRepeatStart||this.isRepeatEnd||this.isFreeTime||this.isSectionStart||this.tempoAutomations.length>0||this.syncPoints&&this.syncPoints.length>0||null!==this.fermata&&this.fermata.size>0||null!==this.directions&&this.directions.size>0||this.isAnacrusis)}get keySignature(){return this.score.tracks[0].staves[0].bars[this.index].keySignature}set keySignature(e){this.score.tracks[0].staves[0].bars[this.index].keySignature=e}get keySignatureType(){return this.score.tracks[0].staves[0].bars[this.index].keySignatureType}set keySignatureType(e){this.score.tracks[0].staves[0].bars[this.index].keySignatureType=e}get isRepeatEnd(){return this.repeatCount>0}get isSectionStart(){return!!this.section}get tempoAutomation(){return this.tempoAutomations.length>0?this.tempoAutomations[0]:null}calculateDuration(e=!0){if(this.isAnacrusis&&e){let s=0;for(const i of this.score.tracks)for(const a of i.staves){const n=this.index<a.bars.length?a.bars[this.index].calculateDuration():0;n>s&&(s=n)}return s}return this.timeSignatureNumerator*C.valueToTicks(this.timeSignatureDenominator)}addFermata(e,s){let i=this.fermata;null===i&&(i=new Map,this.fermata=i),i.set(e,s)}addDirection(e){null==this.directions&&(this.directions=new Set),this.directions.add(e)}getFermata(e){const s=this.fermata;return null===s?null:s.has(e.playbackStart)?s.get(e.playbackStart):null}addSyncPoint(e){this.syncPoints||(this.syncPoints=[]),this.syncPoints.push(e)}}return r.MaxAlternateEndings=8,r})();class q{}q.DefaultChannelCount=17,q.MetronomeChannel=q.DefaultChannelCount-1,q.MetronomeKey=33,q.AudioChannels=2,q.MinVolume=0,q.MinProgram=0,q.MaxProgram=127,q.MinPlaybackSpeed=.125,q.MaxPlaybackSpeed=8,q.PercussionChannel=9,q.PercussionBank=128,q.MaxPitchWheel=16384,q.MaxPitchWheel20=4294967296,q.DefaultPitchWheel=q.MaxPitchWheel/2,q.MicroBufferCount=32,q.MicroBufferSize=64;class Tr{constructor(){this.beats=[],this.id="empty",this.isComplete=!1}addBeat(t){t.graceIndex=this.beats.length,t.graceGroup=this,this.beats.push(t)}finish(){this.beats.length>0&&(this.id=`${this.beats[0].absoluteDisplayStart}_${this.beats[0].voice.index}`)}}var qi=function(r){return r[r.Glyphs=0]="Glyphs",r}(qi||{});class Hn extends di{}let es=(()=>{let r=class Rn{constructor(){this._isEmpty=!0,this._isRestOnly=!0,this.id=Rn._globalVoiceId++,this.index=0,this.beats=[]}static resetIds(){Rn._globalVoiceId=0}get isEmpty(){return this._isEmpty}forceNonEmpty(){this._isEmpty=!1}get isRestOnly(){return this._isRestOnly}insertBeat(e,s){s.nextBeat=e.nextBeat,s.nextBeat&&(s.nextBeat.previousBeat=s),s.previousBeat=e,s.voice=this,e.nextBeat=s,this.beats.splice(e.index+1,0,s)}addBeat(e){e.voice=this,e.index=this.beats.length,this.beats.push(e),e.isEmpty||(this._isEmpty=!1),e.isRest||(this._isRestOnly=!1)}chain(e,s=null){if(this.bar){if(e.index<this.beats.length-1)e.nextBeat=this.beats[e.index+1],e.nextBeat.previousBeat=e;else if(e.isLastOfVoice&&e.voice.bar.nextBar){const i=this.bar.nextBar.voices[this.index];i.beats.length>0&&(e.nextBeat=i.beats[0]),e.nextBeat.previousBeat=e}e.chain(s)}}addGraceBeat(e){if(0===this.beats.length)return void this.addBeat(e);const s=this.beats[this.beats.length-1];this.beats.splice(this.beats.length-1,1),this.addBeat(e),this.addBeat(s),this._isEmpty=!1,this._isRestOnly=!1}getBeatAtPlaybackStart(e){return this._beatLookup.has(e)?this._beatLookup.get(e):null}finish(e,s=null){this._isEmpty=!0,this._isRestOnly=!0,this._beatLookup=new Map;let i=null;for(let o=0;o<this.beats.length;o++){const h=this.beats[o];h.index=o,this.chain(h,s),h.graceType===K.None?(h.graceGroup=i,i&&(i.isComplete=!0),i=null):(i||(i=new Tr),i.addBeat(h)),h.isEmpty||(this._isEmpty=!1),h.isRest||(this._isRestOnly=!1)}let a=0,n=0;for(let o=0;o<this.beats.length;o++){const h=this.beats[o];if(h.index=o,h.finish(e,s),h.graceType===K.None){if(h.graceGroup){const c=h.graceGroup.beats[0],d=h.graceGroup.beats[h.graceGroup.beats.length-1];if(c.graceType!==K.BendGrace){const u=d.playbackStart+d.playbackDuration-c.playbackStart;switch(c.graceType){case K.BeforeBeat:c.previousBeat?(c.previousBeat.playbackDuration-=u,n=c.previousBeat.voice===this?c.previousBeat.playbackStart+c.previousBeat.playbackDuration:-u):n=-u;for(const f of h.graceGroup.beats)this._beatLookup.delete(f.playbackStart),f.playbackStart=n,this._beatLookup.set(f.playbackStart,h),n+=f.playbackDuration;break;case K.OnBeat:h.playbackDuration-=u,n=d.voice===this?d.playbackStart+d.playbackDuration:-u}}}h.displayStart=a,h.playbackStart=n,h.fermata?this.bar.masterBar.addFermata(h.playbackStart,h.fermata):h.fermata=this.bar.masterBar.getFermata(h),this._beatLookup.set(h.playbackStart,h)}else h.displayStart=a,h.playbackStart=n;h.finishTuplet(),h.graceGroup&&h.graceGroup.finish(),a+=h.displayDuration,n+=h.playbackDuration}}calculateDuration(){if(this.isEmpty||0===this.beats.length)return 0;const e=this.beats[this.beats.length-1];return e.playbackStart+e.playbackDuration-this.beats[0].playbackStart}};return r._globalVoiceId=0,r})();class uh{constructor(){this.note=null,this.tone=new Wn,this.octave=0}get realValue(){return 12*this.octave+this.tone.noteValue}}class Wn{constructor(t=0,e=ge.Default){this.noteValue=t,this.accidentalMode=e}}class O{static getIndex(t){return t<0?0:0|Math.log2(t)}static keySignatureIsFlat(t){return t<0}static keySignatureIsNatural(t){return 0===t}static keySignatureIsSharp(t){return t>0}static applyPitchOffsets(t,e){for(let s=0;s<e.tracks.length;s++){if(s<t.notation.displayTranspositionPitches.length)for(const i of e.tracks[s].staves)i.displayTranspositionPitch=-t.notation.displayTranspositionPitches[s];if(s<t.notation.transpositionPitches.length)for(const i of e.tracks[s].staves)i.transpositionPitch=-t.notation.transpositionPitches[s]}}static fingerToString(t,e,s,i){if(t.notation.fingeringMode===xs.ScoreForcePiano||t.notation.fingeringMode===xs.SingleNoteEffectBandForcePiano||Wt.isPiano(e.voice.bar.staff.track.playbackInfo.program))switch(s){case Q.Unknown:case Q.NoOrDead:return null;case Q.Thumb:return"1";case Q.IndexFinger:return"2";case Q.MiddleFinger:return"3";case Q.AnnularFinger:return"4";case Q.LittleFinger:return"5";default:return null}if(i)switch(s){case Q.Unknown:return null;case Q.NoOrDead:return"0";case Q.Thumb:return"t";case Q.IndexFinger:return"1";case Q.MiddleFinger:return"2";case Q.AnnularFinger:return"3";case Q.LittleFinger:return"4";default:return null}switch(s){case Q.Unknown:case Q.NoOrDead:return null;case Q.Thumb:return"p";case Q.IndexFinger:return"i";case Q.MiddleFinger:return"m";case Q.AnnularFinger:return"a";case Q.LittleFinger:return"c";default:return null}}static isTuning(t){return!!O.parseTuning(t)}static parseTuning(t){let e="",s="";for(let a=0;a<t.length;a++){const n=t.charCodeAt(a);if(n>=48&&n<=57){if(!e)return null;s+=String.fromCharCode(n)}else{if(!O.TuningLetters.has(n))return null;e+=String.fromCharCode(n)}}if(!s||!e)return null;const i=new uh;return i.octave=Number.parseInt(s)+1,i.note=e.toLowerCase(),i.tone=O.getToneForText(i.note),i.tone.noteValue<0&&(i.octave--,i.tone.noteValue+=12),i}static getTuningForText(t){const e=O.parseTuning(t);return e?e.realValue:-1}static getToneForText(t){const e=t.substring(0,1),s=t.substring(1);let i,a;switch(e.toLowerCase()){case"c":default:i=0;break;case"d":i=2;break;case"e":i=4;break;case"f":i=5;break;case"g":i=7;break;case"a":i=9;break;case"b":i=11}switch(a=O.parseAccidentalMode(s),a){case ge.Default:case ge.ForceNone:case ge.ForceNatural:break;case ge.ForceSharp:i++;break;case ge.ForceDoubleSharp:i+=2;break;case ge.ForceFlat:i--;break;case ge.ForceDoubleFlat:i-=2}return new Wn(i,a)}static parseAccidentalMode(t){const e=t.toLowerCase();return O.accidentalModeMapping.has(e)?O.accidentalModeMapping.get(e):ge.Default}static newGuid(){return`${Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}`}static isAlmostEqualTo(t,e){return Math.abs(t-e)<1e-5}static toHexString(t,e=0){let s="";do{s=String.fromCharCode("0123456789ABCDEF".charCodeAt(15&t))+s,t>>=4}while(t>0);for(;s.length<e;)s=`0${s}`;return s}static getAlternateEndingsList(t){const e=[];for(let s=0;s<Ps.MaxAlternateEndings;s++)t&1<<s&&e.push(s);return e}static deltaFretToHarmonicValue(t){switch(t){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return t;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}static clamp(t,e,s){return t<=e?e:t>=s?s:t}static buildMultiBarRestInfo(t,e,s){if(!t)return null;const i=t[0].score.stylesheet;if(!(t.length>1?i.multiTrackMultiBarRest:!0===i.perTrackMultiBarRest?.has(t[0].index)))return null;const n=new Map,o=t[0].score;let h=e,c=o.tempo;for(;h<=s;){const d=h;let u=null;for(;h<=s;){const f=o.masterBars[h];let p=!1;for(const b of f.tempoAutomations)b.value!==c&&(p=!0),c=b.value;if(f.alternateEndings||f.isRepeatStart&&f.index!==d||f.isFreeTime||f.isAnacrusis||null!==f.section||f.index!==d&&p||null!==f.fermata&&f.fermata.size>0||null!==f.directions&&f.directions.size>0||d>e&&f.previousMasterBar&&(f.timeSignatureCommon!==f.previousMasterBar.timeSignatureCommon||f.timeSignatureNumerator!==f.previousMasterBar.timeSignatureNumerator||f.timeSignatureDenominator!==f.previousMasterBar.timeSignatureDenominator||f.tripletFeel!==f.previousMasterBar.tripletFeel))break;let g=!0;for(const b of t){for(const w of b.staves){const S=w.bars[f.index];if(!S.isRestOnly){g=!1;break}if(S.index>0&&(S.keySignature!==S.previousBar.keySignature||S.keySignatureType!==S.previousBar.keySignatureType)){g=!1;break}}if(!g)break}if(!g||(h++,f.index>d&&(null===u?u=[f.index]:u.push(f.index)),f.isRepeatEnd))break}u?n.set(d,u):h++}return n}static computeFirstDisplayedBarIndex(t,e){let s=e.display.startBar;return s--,s=Math.min(t.masterBars.length-1,Math.max(0,s)),s}static computeLastDisplayedBarIndex(t,e,s){let i=e.display.barCount;return i<0&&(i=t.masterBars.length),i=s+i-1,i=Math.min(t.masterBars.length-1,Math.max(0,i)),i}static getOrCreateHeaderFooterStyle(t,e){let i,s=t.style;if(t.style||(s=new fi,t.style=s),s.headerAndFooter.has(e))i=s.headerAndFooter.get(e);else{if(i=new is,fi.defaultHeaderAndFooter.has(e)){const a=fi.defaultHeaderAndFooter.get(e);i.template=a.template,i.textAlign=a.textAlign}s.headerAndFooter.set(e,i)}return i}static consolidate(t){if(0===t.masterBars.length){const s=new Ps;t.addMasterBar(s);const i=new Qe;i.isLinear=!1,i.type=Ge.Tempo,i.value=t.tempo,s.tempoAutomations.push(i);const a=new Ts;t.tracks[0].staves[0].addBar(a);const n=new es;a.addVoice(n);const o=new xt;return o.isEmpty=!0,void n.addBeat(o)}const e=new Set([q.PercussionChannel]);for(const s of t.tracks){if(1===s.staves.length&&s.staves[0].isPercussion)s.playbackInfo.primaryChannel=q.PercussionChannel,s.playbackInfo.secondaryChannel=q.PercussionChannel;else{if(s.playbackInfo.primaryChannel!==q.PercussionChannel)for(;e.has(s.playbackInfo.primaryChannel);)s.playbackInfo.primaryChannel++;if(e.add(s.playbackInfo.primaryChannel),s.playbackInfo.secondaryChannel!==q.PercussionChannel)for(;e.has(s.playbackInfo.secondaryChannel);)s.playbackInfo.secondaryChannel++;e.add(s.playbackInfo.secondaryChannel)}for(const i of s.staves){for(const n of i.bars)for(const o of n.voices)if(o.isEmpty&&0===o.beats.length){const h=new xt;h.isEmpty=!0,o.addBeat(h)}const a=0===i.bars.length?1:i.bars[0].voices.length;for(;i.bars.length<t.masterBars.length;){const n=new Ts;i.addBar(n);const o=n.previousBar;o&&(n.clef=o.clef,n.clefOttava=o.clefOttava,n.keySignature=n.previousBar.keySignature,n.keySignatureType=n.previousBar.keySignatureType);for(let h=0;h<a;h++){const c=new es;n.addVoice(c);const d=new xt;d.isEmpty=!0,c.addBeat(d)}}}}}static trimEmptyBarsAtEnd(t){for(;t.masterBars.length>1;){const e=t.masterBars.length-1,s=t.masterBars[e];if(s.hasChanges)return;for(const i of t.tracks)for(const a of i.staves)if(e<a.bars.length){const n=a.bars[e];if(!n.isEmpty||n.hasChanges)return}for(const i of t.tracks)for(const a of i.staves)if(e<a.bars.length){const n=a.bars[e];a.bars.pop(),n.previousBar.nextBar=null}t.masterBars.pop(),s.previousMasterBar.nextMasterBar=null}}}O.TuningLetters=new Set([67,68,69,70,71,65,66,99,100,101,102,103,97,98,35]),O.accidentalModeMapping=new Map([["default",ge.Default],["d",ge.Default],["forcenone",ge.ForceNone],["-",ge.ForceNone],["forcenatural",ge.ForceNatural],["n",ge.ForceNatural],["forcesharp",ge.ForceSharp],["#",ge.ForceSharp],["forcedoublesharp",ge.ForceDoubleSharp],["##",ge.ForceDoubleSharp],["x",ge.ForceDoubleSharp],["forceflat",ge.ForceFlat],["b",ge.ForceFlat],["forcedoubleflat",ge.ForceDoubleFlat],["bb",ge.ForceDoubleFlat]]);var yt=function(r){return r[r.None=0]="None",r[r.Up=1]="Up",r[r.Down=2]="Down",r}(yt||{}),l=function(r){return r[r.None=-1]="None",r[r.Space=32]="Space",r[r.Brace=57344]="Brace",r[r.BracketTop=57347]="BracketTop",r[r.BracketBottom=57348]="BracketBottom",r[r.SystemDivider=57351]="SystemDivider",r[r.GClef=57424]="GClef",r[r.CClef=57436]="CClef",r[r.FClef=57442]="FClef",r[r.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",r[r.SixStringTabClef=57453]="SixStringTabClef",r[r.FourStringTabClef=57454]="FourStringTabClef",r[r.TimeSig0=57472]="TimeSig0",r[r.TimeSig1=57473]="TimeSig1",r[r.TimeSig2=57474]="TimeSig2",r[r.TimeSig3=57475]="TimeSig3",r[r.TimeSig4=57476]="TimeSig4",r[r.TimeSig5=57477]="TimeSig5",r[r.TimeSig6=57478]="TimeSig6",r[r.TimeSig7=57479]="TimeSig7",r[r.TimeSig8=57480]="TimeSig8",r[r.TimeSig9=57481]="TimeSig9",r[r.TimeSigCommon=57482]="TimeSigCommon",r[r.TimeSigCutCommon=57483]="TimeSigCutCommon",r[r.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",r[r.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",r[r.NoteheadWhole=57506]="NoteheadWhole",r[r.NoteheadHalf=57507]="NoteheadHalf",r[r.NoteheadBlack=57508]="NoteheadBlack",r[r.NoteheadNull=57509]="NoteheadNull",r[r.NoteheadXOrnate=57514]="NoteheadXOrnate",r[r.NoteheadPlusDoubleWhole=57516]="NoteheadPlusDoubleWhole",r[r.NoteheadPlusWhole=57517]="NoteheadPlusWhole",r[r.NoteheadPlusHalf=57518]="NoteheadPlusHalf",r[r.NoteheadPlusBlack=57519]="NoteheadPlusBlack",r[r.NoteheadSquareWhite=57528]="NoteheadSquareWhite",r[r.NoteheadSquareBlack=57529]="NoteheadSquareBlack",r[r.NoteheadTriangleUpDoubleWhole=57530]="NoteheadTriangleUpDoubleWhole",r[r.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",r[r.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",r[r.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",r[r.NoteheadTriangleRightWhite=57537]="NoteheadTriangleRightWhite",r[r.NoteheadTriangleRightBlack=57538]="NoteheadTriangleRightBlack",r[r.NoteheadTriangleDownDoubleWhole=57548]="NoteheadTriangleDownDoubleWhole",r[r.NoteheadTriangleDownWhole=57540]="NoteheadTriangleDownWhole",r[r.NoteheadTriangleDownHalf=57541]="NoteheadTriangleDownHalf",r[r.NoteheadTriangleDownBlack=57543]="NoteheadTriangleDownBlack",r[r.NoteheadDiamondDoubleWhole=57559]="NoteheadDiamondDoubleWhole",r[r.NoteheadDiamondWhole=57560]="NoteheadDiamondWhole",r[r.NoteheadDiamondHalf=57561]="NoteheadDiamondHalf",r[r.NoteheadDiamondBlack=57563]="NoteheadDiamondBlack",r[r.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",r[r.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",r[r.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",r[r.NoteheadCircleXDoubleWhole=57520]="NoteheadCircleXDoubleWhole",r[r.NoteheadCircleXWhole=57521]="NoteheadCircleXWhole",r[r.NoteheadCircleXHalf=57522]="NoteheadCircleXHalf",r[r.NoteheadCircleX=57523]="NoteheadCircleX",r[r.NoteheadXDoubleWhole=57510]="NoteheadXDoubleWhole",r[r.NoteheadXWhole=57511]="NoteheadXWhole",r[r.NoteheadXHalf=57512]="NoteheadXHalf",r[r.NoteheadXBlack=57513]="NoteheadXBlack",r[r.NoteheadParenthesis=57550]="NoteheadParenthesis",r[r.NoteheadSlashedBlack1=57551]="NoteheadSlashedBlack1",r[r.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",r[r.NoteheadSlashedHalf1=57553]="NoteheadSlashedHalf1",r[r.NoteheadSlashedHalf2=57554]="NoteheadSlashedHalf2",r[r.NoteheadSlashedWhole1=57555]="NoteheadSlashedWhole1",r[r.NoteheadSlashedWhole2=57556]="NoteheadSlashedWhole2",r[r.NoteheadSlashedDoubleWhole1=57557]="NoteheadSlashedDoubleWhole1",r[r.NoteheadSlashedDoubleWhole2=57558]="NoteheadSlashedDoubleWhole2",r[r.NoteheadCircledBlack=57572]="NoteheadCircledBlack",r[r.NoteheadCircledHalf=57573]="NoteheadCircledHalf",r[r.NoteheadCircledWhole=57574]="NoteheadCircledWhole",r[r.NoteheadCircledDoubleWhole=57575]="NoteheadCircledDoubleWhole",r[r.NoteheadCircleSlash=57591]="NoteheadCircleSlash",r[r.NoteheadHeavyX=57592]="NoteheadHeavyX",r[r.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",r[r.NoteheadSlashVerticalEnds=57600]="NoteheadSlashVerticalEnds",r[r.NoteheadSlashWhiteWhole=57602]="NoteheadSlashWhiteWhole",r[r.NoteheadSlashWhiteHalf=57603]="NoteheadSlashWhiteHalf",r[r.NoteheadRoundWhiteWithDot=57621]="NoteheadRoundWhiteWithDot",r[r.NoteheadSquareBlackLarge=57626]="NoteheadSquareBlackLarge",r[r.NoteheadSquareBlackWhite=57627]="NoteheadSquareBlackWhite",r[r.NoteheadClusterDoubleWhole3rd=57640]="NoteheadClusterDoubleWhole3rd",r[r.NoteheadClusterWhole3rd=57641]="NoteheadClusterWhole3rd",r[r.NoteheadClusterHalf3rd=57642]="NoteheadClusterHalf3rd",r[r.NoteheadClusterQuarter3rd=57643]="NoteheadClusterQuarter3rd",r[r.NoteShapeRoundWhite=57776]="NoteShapeRoundWhite",r[r.NoteShapeRoundBlack=57777]="NoteShapeRoundBlack",r[r.NoteShapeSquareWhite=57778]="NoteShapeSquareWhite",r[r.NoteShapeSquareBlack=57779]="NoteShapeSquareBlack",r[r.NoteShapeTriangleRightWhite=57780]="NoteShapeTriangleRightWhite",r[r.NoteShapeTriangleRightBlack=57781]="NoteShapeTriangleRightBlack",r[r.NoteShapeTriangleLeftWhite=57782]="NoteShapeTriangleLeftWhite",r[r.NoteShapeTriangleLeftBlack=57783]="NoteShapeTriangleLeftBlack",r[r.NoteShapeDiamondWhite=57784]="NoteShapeDiamondWhite",r[r.NoteShapeDiamondBlack=57785]="NoteShapeDiamondBlack",r[r.NoteShapeTriangleUpWhite=57786]="NoteShapeTriangleUpWhite",r[r.NoteShapeTriangleUpBlack=57787]="NoteShapeTriangleUpBlack",r[r.NoteShapeMoonWhite=57788]="NoteShapeMoonWhite",r[r.NoteShapeMoonBlack=57789]="NoteShapeMoonBlack",r[r.NoteShapeTriangleRoundWhite=57790]="NoteShapeTriangleRoundWhite",r[r.NoteShapeTriangleRoundBlack=57791]="NoteShapeTriangleRoundBlack",r[r.NoteQuarterUp=57813]="NoteQuarterUp",r[r.NoteEighthUp=57815]="NoteEighthUp",r[r.TextBlackNoteLongStem=57841]="TextBlackNoteLongStem",r[r.TextBlackNoteFrac8thLongStem=57843]="TextBlackNoteFrac8thLongStem",r[r.TextBlackNoteFrac16thLongStem=57845]="TextBlackNoteFrac16thLongStem",r[r.TextBlackNoteFrac32ndLongStem=57846]="TextBlackNoteFrac32ndLongStem",r[r.TextCont8thBeamLongStem=57848]="TextCont8thBeamLongStem",r[r.TextCont16thBeamLongStem=57850]="TextCont16thBeamLongStem",r[r.TextCont32ndBeamLongStem=57851]="TextCont32ndBeamLongStem",r[r.TextAugmentationDot=57852]="TextAugmentationDot",r[r.TextTupletBracketStartLongStem=57857]="TextTupletBracketStartLongStem",r[r.TextTuplet3LongStem=57858]="TextTuplet3LongStem",r[r.TextTupletBracketEndLongStem=57859]="TextTupletBracketEndLongStem",r[r.Tremolo3=57890]="Tremolo3",r[r.Tremolo2=57889]="Tremolo2",r[r.Tremolo1=57888]="Tremolo1",r[r.FlagEighthUp=57920]="FlagEighthUp",r[r.FlagEighthDown=57921]="FlagEighthDown",r[r.FlagSixteenthUp=57922]="FlagSixteenthUp",r[r.FlagSixteenthDown=57923]="FlagSixteenthDown",r[r.FlagThirtySecondUp=57924]="FlagThirtySecondUp",r[r.FlagThirtySecondDown=57925]="FlagThirtySecondDown",r[r.FlagSixtyFourthUp=57926]="FlagSixtyFourthUp",r[r.FlagSixtyFourthDown=57927]="FlagSixtyFourthDown",r[r.FlagOneHundredTwentyEighthUp=57928]="FlagOneHundredTwentyEighthUp",r[r.FlagOneHundredTwentyEighthDown=57929]="FlagOneHundredTwentyEighthDown",r[r.FlagTwoHundredFiftySixthUp=57930]="FlagTwoHundredFiftySixthUp",r[r.FlagTwoHundredFiftySixthDown=57931]="FlagTwoHundredFiftySixthDown",r[r.AccidentalFlat=57952]="AccidentalFlat",r[r.AccidentalNatural=57953]="AccidentalNatural",r[r.AccidentalSharp=57954]="AccidentalSharp",r[r.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",r[r.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",r[r.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",r[r.AccidentalQuarterToneSharpArrowUp=57972]="AccidentalQuarterToneSharpArrowUp",r[r.AccidentalQuarterToneNaturalArrowUp=57970]="AccidentalQuarterToneNaturalArrowUp",r[r.Segno=57415]="Segno",r[r.Coda=57416]="Coda",r[r.ArticAccentAbove=58528]="ArticAccentAbove",r[r.ArticAccentBelow=58529]="ArticAccentBelow",r[r.ArticStaccatoAbove=58530]="ArticStaccatoAbove",r[r.ArticStaccatoBelow=58531]="ArticStaccatoBelow",r[r.ArticTenutoAbove=58532]="ArticTenutoAbove",r[r.ArticTenutoBelow=58533]="ArticTenutoBelow",r[r.ArticMarcatoAbove=58540]="ArticMarcatoAbove",r[r.ArticMarcatoBelow=58541]="ArticMarcatoBelow",r[r.FermataAbove=58560]="FermataAbove",r[r.FermataShortAbove=58564]="FermataShortAbove",r[r.FermataLongAbove=58566]="FermataLongAbove",r[r.RestLonga=58593]="RestLonga",r[r.RestDoubleWhole=58594]="RestDoubleWhole",r[r.RestWhole=58595]="RestWhole",r[r.RestHalf=58596]="RestHalf",r[r.RestQuarter=58597]="RestQuarter",r[r.RestEighth=58598]="RestEighth",r[r.RestSixteenth=58599]="RestSixteenth",r[r.RestThirtySecond=58600]="RestThirtySecond",r[r.RestSixtyFourth=58601]="RestSixtyFourth",r[r.RestOneHundredTwentyEighth=58602]="RestOneHundredTwentyEighth",r[r.RestTwoHundredFiftySixth=58603]="RestTwoHundredFiftySixth",r[r.RestHBarLeft=58607]="RestHBarLeft",r[r.RestHBarMiddle=58608]="RestHBarMiddle",r[r.RestHBarRight=58609]="RestHBarRight",r[r.Repeat1Bar=58624]="Repeat1Bar",r[r.Repeat2Bars=58625]="Repeat2Bars",r[r.Ottava=58640]="Ottava",r[r.OttavaAlta=58641]="OttavaAlta",r[r.OttavaBassaVb=58652]="OttavaBassaVb",r[r.Quindicesima=58644]="Quindicesima",r[r.QuindicesimaAlta=58645]="QuindicesimaAlta",r[r.DynamicPPPPPP=58663]="DynamicPPPPPP",r[r.DynamicPPPPP=58664]="DynamicPPPPP",r[r.DynamicPPPP=58665]="DynamicPPPP",r[r.DynamicPPP=58666]="DynamicPPP",r[r.DynamicPP=58667]="DynamicPP",r[r.DynamicPiano=58656]="DynamicPiano",r[r.DynamicMP=58668]="DynamicMP",r[r.DynamicMF=58669]="DynamicMF",r[r.DynamicPF=58670]="DynamicPF",r[r.DynamicForte=58658]="DynamicForte",r[r.DynamicFF=58671]="DynamicFF",r[r.DynamicFFF=58672]="DynamicFFF",r[r.DynamicFFFF=58673]="DynamicFFFF",r[r.DynamicFFFFF=58674]="DynamicFFFFF",r[r.DynamicFFFFFF=58675]="DynamicFFFFFF",r[r.DynamicFortePiano=58676]="DynamicFortePiano",r[r.DynamicNiente=58662]="DynamicNiente",r[r.DynamicSforzando1=58678]="DynamicSforzando1",r[r.DynamicSforzandoPiano=58679]="DynamicSforzandoPiano",r[r.DynamicSforzandoPianissimo=58680]="DynamicSforzandoPianissimo",r[r.DynamicSforzato=58681]="DynamicSforzato",r[r.DynamicSforzatoPiano=58682]="DynamicSforzatoPiano",r[r.DynamicSforzatoFF=58683]="DynamicSforzatoFF",r[r.DynamicRinforzando1=58684]="DynamicRinforzando1",r[r.DynamicRinforzando2=58685]="DynamicRinforzando2",r[r.DynamicForzando=58677]="DynamicForzando",r[r.OrnamentTrill=58726]="OrnamentTrill",r[r.OrnamentTurn=58727]="OrnamentTurn",r[r.OrnamentTurnInverted=58728]="OrnamentTurnInverted",r[r.OrnamentShortTrill=58732]="OrnamentShortTrill",r[r.OrnamentMordent=58733]="OrnamentMordent",r[r.StringsDownBow=58896]="StringsDownBow",r[r.StringsUpBow=58898]="StringsUpBow",r[r.KeyboardPedalPed=58960]="KeyboardPedalPed",r[r.KeyboardPedalUp=58965]="KeyboardPedalUp",r[r.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",r[r.GuitarString0=59443]="GuitarString0",r[r.GuitarString1=59444]="GuitarString1",r[r.GuitarString2=59445]="GuitarString2",r[r.GuitarString3=59446]="GuitarString3",r[r.GuitarString4=59447]="GuitarString4",r[r.GuitarString5=59448]="GuitarString5",r[r.GuitarString6=59449]="GuitarString6",r[r.GuitarString7=59450]="GuitarString7",r[r.GuitarString8=59451]="GuitarString8",r[r.GuitarString9=59452]="GuitarString9",r[r.GuitarOpenPedal=59453]="GuitarOpenPedal",r[r.GuitarClosePedal=59455]="GuitarClosePedal",r[r.GuitarGolpe=59458]="GuitarGolpe",r[r.GuitarFadeIn=59459]="GuitarFadeIn",r[r.GuitarFadeOut=59460]="GuitarFadeOut",r[r.GuitarVolumeSwell=59461]="GuitarVolumeSwell",r[r.FretboardX=59481]="FretboardX",r[r.FretboardO=59482]="FretboardO",r[r.WiggleTrill=60068]="WiggleTrill",r[r.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",r[r.OctaveBaselineM=60565]="OctaveBaselineM",r[r.OctaveBaselineB=60563]="OctaveBaselineB",r}(l||{}),U=function(r){return r[r.Left=0]="Left",r[r.Center=1]="Center",r[r.Right=2]="Right",r}(U||{}),re=function(r){return r[r.Top=0]="Top",r[r.Middle=1]="Middle",r[r.Bottom=2]="Bottom",r}(re||{});class $i{constructor(t,e){this.width=t,this.height=e}}class W{constructor(t="",e=0,s=0,i=l.None,a=l.None,n=l.None,o=l.None,h=re.Middle){this.elementType=t,this.outputMidiNumber=s,this.staffLine=e,this.noteHeadDefault=i,this.noteHeadHalf=a!==l.None?a:i,this.noteHeadWhole=n!==l.None?n:i,this.techniqueSymbol=o,this.techniqueSymbolPlacement=h}getSymbol(t){switch(t){case m.Whole:return this.noteHeadWhole;case m.Half:return this.noteHeadHalf;default:return this.noteHeadDefault}}}class ht{static articulationFromElementVariation(t,e){return t<ht.gp6ElementAndVariationToArticulation.length?(e>=ht.gp6ElementAndVariationToArticulation.length&&(e=0),ht.gp6ElementAndVariationToArticulation[t][e]):38}static getArticulation(t){const e=t.percussionArticulation;if(e<0)return null;const s=t.beat.voice.bar.staff.track.percussionArticulations;return e<s.length?s[e]:ht.getArticulationByInputMidiNumber(e)}static getElementAndVariation(t){const e=ht.getArticulation(t);if(!e)return[-1,-1];for(let s=0;s<ht.gp6ElementAndVariationToArticulation.length;s++){const i=ht.gp6ElementAndVariationToArticulation[s];for(let a=0;a<i.length;a++)if(ht.getArticulationByInputMidiNumber(i[a])?.outputMidiNumber===e.outputMidiNumber)return[s,a]}return[-1,-1]}static getArticulationByInputMidiNumber(t){return ht.instrumentArticulations.has(t)?ht.instrumentArticulations.get(t):null}}ht.gp6ElementAndVariationToArticulation=[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]],ht.instrumentArticulations=new Map([[38,new W("snare",3,38,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[37,new W("snare",3,37,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[91,new W("snare",3,38,l.NoteheadDiamondWhite,l.NoteheadDiamondWhite,l.NoteheadDiamondWhite)],[42,new W("hiHat",-1,42,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[92,new W("hiHat",-1,46,l.NoteheadCircleSlash,l.NoteheadCircleSlash,l.NoteheadCircleSlash)],[46,new W("hiHat",-1,46,l.NoteheadCircleX,l.NoteheadCircleX,l.NoteheadCircleX)],[44,new W("hiHat",9,44,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[35,new W("kickDrum",8,35,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[36,new W("kickDrum",7,36,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[50,new W("tom",1,50,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[48,new W("tom",2,48,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[47,new W("tom",4,47,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[45,new W("tom",5,45,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[43,new W("tom",6,43,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[93,new W("ride",0,51,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack,l.PictEdgeOfCymbal,re.Bottom)],[51,new W("ride",0,51,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[53,new W("ride",0,53,l.NoteheadDiamondWhite,l.NoteheadDiamondWhite,l.NoteheadDiamondWhite)],[94,new W("ride",0,51,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack,l.ArticStaccatoAbove,re.Top)],[55,new W("splash",-2,55,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[95,new W("splash",-2,55,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack,l.ArticStaccatoAbove,re.Bottom)],[52,new W("china",-3,52,l.NoteheadHeavyXHat,l.NoteheadHeavyXHat,l.NoteheadHeavyXHat)],[96,new W("china",-3,52,l.NoteheadHeavyXHat,l.NoteheadHeavyXHat,l.NoteheadHeavyXHat)],[49,new W("crash",-2,49,l.NoteheadHeavyX,l.NoteheadHeavyX,l.NoteheadHeavyX)],[97,new W("crash",-2,49,l.NoteheadHeavyX,l.NoteheadHeavyX,l.NoteheadHeavyX,l.ArticStaccatoAbove,re.Bottom)],[57,new W("crash",-1,57,l.NoteheadHeavyX,l.NoteheadHeavyX,l.NoteheadHeavyX)],[98,new W("crash",-1,57,l.NoteheadHeavyX,l.NoteheadHeavyX,l.NoteheadHeavyX,l.ArticStaccatoAbove,re.Bottom)],[99,new W("cowbell",1,56,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpHalf,l.NoteheadTriangleUpWhole)],[100,new W("cowbell",1,56,l.NoteheadXBlack,l.NoteheadXHalf,l.NoteheadXWhole)],[56,new W("cowbell",0,56,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpHalf,l.NoteheadTriangleUpWhole)],[101,new W("cowbell",0,56,l.NoteheadXBlack,l.NoteheadXHalf,l.NoteheadXWhole)],[102,new W("cowbell",-1,56,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpHalf,l.NoteheadTriangleUpWhole)],[103,new W("cowbell",-1,56,l.NoteheadXBlack,l.NoteheadXHalf,l.NoteheadXWhole)],[77,new W("woodblock",-9,77,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpBlack)],[76,new W("woodblock",-10,76,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpBlack)],[60,new W("bongo",-4,60,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[104,new W("bongo",-5,60,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole,l.NoteheadParenthesis,re.Middle)],[105,new W("bongo",-6,60,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[61,new W("bongo",-7,61,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[106,new W("bongo",-8,61,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole,l.NoteheadParenthesis,re.Middle)],[107,new W("bongo",-16,61,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[66,new W("timbale",10,66,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[65,new W("timbale",9,65,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[68,new W("agogo",12,68,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[67,new W("agogo",11,67,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[64,new W("conga",17,64,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[108,new W("conga",16,64,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[109,new W("conga",15,64,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole,l.NoteheadParenthesis,re.Middle)],[63,new W("conga",14,63,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[110,new W("conga",13,63,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[62,new W("conga",19,62,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole,l.NoteheadParenthesis,re.Middle)],[72,new W("whistle",-11,72,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[71,new W("whistle",-17,71,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[73,new W("guiro",38,73,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[74,new W("guiro",37,74,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[86,new W("surdo",36,86,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[87,new W("surdo",35,87,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadParenthesis,re.Middle)],[54,new W("tambourine",3,54,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpBlack)],[111,new W("tambourine",2,54,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpBlack,l.StringsUpBow,re.Bottom)],[112,new W("tambourine",1,54,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpBlack,l.NoteheadTriangleUpBlack,l.StringsDownBow,re.Bottom)],[113,new W("tambourine",-7,54,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[79,new W("cuica",30,79,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[78,new W("cuica",29,78,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[58,new W("vibraslap",28,58,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[81,new W("triangle",27,81,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[80,new W("triangle",26,80,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadParenthesis,re.Middle)],[114,new W("grancassa",25,43,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[115,new W("piatti",18,49,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[116,new W("piatti",24,49,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[69,new W("cabasa",23,69,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[117,new W("cabasa",22,69,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole,l.StringsUpBow,re.Bottom)],[85,new W("castanets",21,85,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[75,new W("claves",20,75,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[70,new W("maraca",-12,70,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[118,new W("maraca",-13,70,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole,l.StringsUpBow,re.Bottom)],[119,new W("maraca",-14,70,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[120,new W("maraca",-15,70,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole,l.StringsUpBow,re.Bottom)],[82,new W("shaker",-23,54,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[122,new W("shaker",-24,54,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole,l.StringsUpBow,re.Bottom)],[84,new W("bellTree",-18,53,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[123,new W("bellTree",-19,53,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole,l.StringsUpBow,re.Bottom)],[83,new W("jingleBell",-20,53,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[124,new W("unpitched",-21,62,l.NoteheadNull,l.NoteheadNull,l.NoteheadNull,l.GuitarGolpe,re.Top)],[125,new W("unpitched",-22,62,l.NoteheadNull,l.NoteheadNull,l.NoteheadNull,l.GuitarGolpe,re.Bottom)],[39,new W("handClap",3,39,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[40,new W("snare",3,40,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[31,new W("snare",3,40,l.NoteheadSlashedBlack2,l.NoteheadSlashedBlack2,l.NoteheadSlashedBlack2)],[41,new W("tom",5,41,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole)],[59,new W("ride",2,59,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack,l.PictEdgeOfCymbal,re.Bottom)],[126,new W("ride",2,59,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[127,new W("ride",2,59,l.NoteheadDiamondWhite,l.NoteheadDiamondWhite,l.NoteheadDiamondWhite)],[29,new W("ride",2,59,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack,l.ArticStaccatoAbove,re.Top)],[30,new W("crash",-3,49,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[33,new W("snare",3,37,l.NoteheadXBlack,l.NoteheadXBlack,l.NoteheadXBlack)],[34,new W("snare",3,38,l.NoteheadBlack,l.NoteheadBlack,l.NoteheadBlack)]]),ht.instrumentArticulationNames=new Map([["Ride (choke)",29],["Cymbal (hit)",30],["Snare (side stick)",31],["Snare (side stick) 2",33],["Snare (hit)",34],["Kick (hit)",35],["Kick (hit) 2",36],["Snare (side stick) 3",37],["Snare (hit) 2",38],["Hand Clap (hit)",39],["Snare (hit) 3",40],["Low Floor Tom (hit)",41],["Hi-Hat (closed)",42],["Very Low Tom (hit)",43],["Pedal Hi-Hat (hit)",44],["Low Tom (hit)",45],["Hi-Hat (open)",46],["Mid Tom (hit)",47],["High Tom (hit)",48],["Crash high (hit)",49],["High Floor Tom (hit)",50],["Ride (middle)",51],["China (hit)",52],["Ride (bell)",53],["Tambourine (hit)",54],["Splash (hit)",55],["Cowbell medium (hit)",56],["Crash medium (hit)",57],["Vibraslap (hit)",58],["Ride (edge)",59],["Hand (hit)",60],["Hand (hit)",61],["Conga high (mute)",62],["Conga high (hit)",63],["Conga low (hit)",64],["Timbale high (hit)",65],["Timbale low (hit)",66],["Agogo high (hit)",67],["Agogo tow (hit)",68],["Cabasa (hit)",69],["Left Maraca (hit)",70],["Whistle high (hit)",71],["Whistle low (hit)",72],["Guiro (hit)",73],["Guiro (scrap-return)",74],["Claves (hit)",75],["Woodblock high (hit)",76],["Woodblock low (hit)",77],["Cuica (mute)",78],["Cuica (open)",79],["Triangle (rnute)",80],["Triangle (hit)",81],["Shaker (hit)",82],["Tinkle Bell (hat)",83],["Jingle Bell (hit)",83],["Bell Tree (hit)",84],["Castanets (hit)",85],["Surdo (hit)",86],["Surdo (mute)",87],["Snare (rim shot)",91],["Hi-Hat (half)",92],["Ride (edge) 2",93],["Ride (choke) 2",94],["Splash (choke)",95],["China (choke)",96],["Crash high (choke)",97],["Crash medium (choke)",98],["Cowbell low (hit)",99],["Cowbell low (tip)",100],["Cowbell medium (tip)",101],["Cowbell high (hit)",102],["Cowbell high (tip)",103],["Hand (mute)",104],["Hand (slap)",105],["Hand (mute) 2",106],["Hand (slap) 2",107],["Conga low (slap)",108],["Conga low (mute)",109],["Conga high (slap)",110],["Tambourine (return)",111],["Tambourine (roll)",112],["Tambourine (hand)",113],["Grancassa (hit)",114],["Piatti (hat)",115],["Piatti (hand)",116],["Cabasa (return)",117],["Left Maraca (return)",118],["Right Maraca (hit)",119],["Right Maraca (return)",120],["Shaker (return)",122],["Bell Tee (return)",123],["Golpe (thumb)",124],["Golpe (finger)",125],["Ride (middle) 2",126],["Ride (bell) 2",127]]);var tt=function(r){return r[r.None=0]="None",r[r.InvertedTurn=1]="InvertedTurn",r[r.Turn=2]="Turn",r[r.UpperMordent=3]="UpperMordent",r[r.LowerMordent=4]="LowerMordent",r}(tt||{});class Zs{constructor(){this.tieDestinationNoteId=-1,this.tieOriginNoteId=-1,this.slurDestinationNoteId=-1,this.slurOriginNoteId=-1,this.hammerPullDestinationNoteId=-1,this.hammerPullOriginNoteId=-1,this.slideTargetNoteId=-1,this.slideOriginNoteId=-1}}var Et=function(r){return r[r.Effects=0]="Effects",r[r.StandardNotationNoteHead=1]="StandardNotationNoteHead",r[r.StandardNotationAccidentals=2]="StandardNotationAccidentals",r[r.StandardNotationEffects=3]="StandardNotationEffects",r[r.GuitarTabFretNumber=4]="GuitarTabFretNumber",r[r.GuitarTabEffects=5]="GuitarTabEffects",r[r.SlashNoteHead=6]="SlashNoteHead",r[r.SlashEffects=7]="SlashEffects",r[r.NumberedNumber=8]="NumberedNumber",r[r.NumberedAccidentals=9]="NumberedAccidentals",r[r.NumberedEffects=10]="NumberedEffects",r}(Et||{});class Ta extends di{}let ts=(()=>{class r{constructor(){this.id=r.GlobalNoteId++,this.index=0,this.accentuated=et.None,this.bendType=z.None,this.bendStyle=Ie.Default,this.bendOrigin=null,this.isContinuedBend=!1,this.bendPoints=null,this.maxBendPoint=null,this.fret=-1,this.string=-1,this.showStringNumber=!1,this.octave=-1,this.tone=-1,this.percussionArticulation=-1,this.isVisible=!0,this.isLeftHandTapped=!1,this.isHammerPullOrigin=!1,this.hammerPullOrigin=null,this.hammerPullDestination=null,this.isSlurDestination=!1,this.slurOrigin=null,this.slurDestination=null,this.harmonicType=Z.None,this.harmonicValue=0,this.isGhost=!1,this.isLetRing=!1,this.letRingDestination=null,this.isPalmMute=!1,this.palmMuteDestination=null,this.isDead=!1,this.isStaccato=!1,this.slideInType=ut.None,this.slideOutType=ce.None,this.slideTarget=null,this.slideOrigin=null,this.vibrato=ke.None,this.tieOrigin=null,this.tieDestination=null,this.isTieDestination=!1,this.leftHandFinger=Q.Unknown,this.rightHandFinger=Q.Unknown,this.trillValue=-1,this.trillSpeed=m.ThirtySecond,this.durationPercent=1,this.accidentalMode=ge.Default,this.dynamics=J.F,this.isEffectSlurOrigin=!1,this.hasEffectSlur=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this.ornament=tt.None,this._noteIdBag=null}static resetIds(){r.GlobalNoteId=0}get hasBend(){return null!==this.bendPoints&&this.bendType!==z.None}get isStringed(){return this.string>=0}get isPiano(){return!this.isStringed&&this.octave>=0&&this.tone>=0}get isPercussion(){return!this.isStringed&&this.percussionArticulation>=0}get element(){return this.isPercussion?ht.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?ht.getElementAndVariation(this)[1]:-1}get isHammerPullDestination(){return!!this.hammerPullOrigin}get isSlurOrigin(){return!!this.slurDestination}get isHarmonic(){return this.harmonicType!==Z.None}get isTieOrigin(){return null!==this.tieDestination}get isFingering(){return this.leftHandFinger!==Q.Unknown||this.rightHandFinger!==Q.Unknown}get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return this.trillValue>=0}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get stringTuning(){return this.beat.voice.bar.staff.capo+r.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(e,s){return e.tuning.length>0?e.tuning[e.tuning.length-(s-1)-1]:0}get realValue(){return this.calculateRealValue(!0,!0)}get realValueWithoutHarmonic(){return this.calculateRealValue(!0,!1)}calculateRealValue(e,s){const i=e?this.beat.voice.bar.staff.transpositionPitch:0;if(s){let a=this.calculateRealValue(e,!1);return this.isStringed&&(this.harmonicType===Z.Natural?a=this.harmonicPitch+this.stringTuning-i:a+=this.harmonicPitch),a}return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-i:this.isPiano?12*this.octave+this.tone-i:0}get harmonicPitch(){if(this.harmonicType===Z.None||!this.isStringed)return 0;const e=this.harmonicValue;return O.isAlmostEqualTo(e,2.4)?36:O.isAlmostEqualTo(e,2.7)?34:e<3?0:e<=3.5?31:e<=4?28:e<=5?24:e<=6?34:e<=7?19:e<=8.5?36:e<=9?28:e<=10?34:e<=11?0:e<=12?12:e<14?0:e<=15?34:e<=16?28:e<=17?36:e<=18?0:e<=19?19:e<=21?0:e<=22?36:e<=24?24:0}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let e=this.realValue;switch(this.harmonicType!==Z.Natural&&this.harmonicType!==Z.None&&(e-=this.harmonicPitch),this.beat.ottava){case le._15ma:e-=24;break;case le._8va:e-=12;break;case le.Regular:break;case le._8vb:e+=12;break;case le._15mb:e+=24}switch(this.beat.voice.bar.clefOttava){case le._15ma:e-=24;break;case le._8va:e-=12;break;case le.Regular:break;case le._8vb:e+=12;break;case le._15mb:e+=24}return e-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!=0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!=0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!=0:!!this.beat.isContinuedWhammy&&this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!=0}addBendPoint(e){let s=this.bendPoints;null===s&&(s=[],this.bendPoints=s),s.push(e),(!this.maxBendPoint||e.value>this.maxBendPoint.value)&&(this.maxBendPoint=e),this.bendType===z.None&&(this.bendType=z.Custom)}finish(e,s=null){const i=new Ji(()=>r.nextNoteOnSameLine(this)),a=e&&e.notation.notationMode===_t.SongBook;if(this.isTieDestination&&(this.chain(s),a&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0)),this.isLetRing&&(this.letRingDestination=i.value&&i.value.isLetRing?i.value:this,a&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1)),this.isPalmMute&&(this.palmMuteDestination=i.value&&i.value.isPalmMute?i.value:this),this.isHammerPullOrigin){const c=r.findHammerPullDestination(this);c?(this.hammerPullDestination=c,c.hammerPullOrigin=this):this.isHammerPullOrigin=!1}switch(this.slideOutType){case ce.Shift:case ce.Legato:this.slideTarget||(this.slideTarget=i.value),this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=ce.None}let n=null;this.isHammerPullOrigin&&this.hammerPullDestination?n=this.hammerPullDestination:this.slideOutType===ce.Legato&&this.slideTarget&&(n=this.slideTarget),n&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&this.beat.pickStroke===yt.None?(this.effectSlurOrigin.effectSlurDestination=n,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=n,this.effectSlurDestination.effectSlurOrigin=this));const o=this.bendPoints,h=null!=o&&o.length>0;if(h?this.isContinuedBend=this.isTieDestination&&this.tieOrigin.hasBend:this.bendType=z.None,h&&this.bendType===z.Custom)if(4===o.length){const c=o[0],d=o[1],f=o[3];d.value===o[2].value?f.value>c.value?d.value>f.value?this.bendType=z.BendRelease:!this.isContinuedBend&&c.value>0?(this.bendType=z.PrebendBend,o.splice(2,1),o.splice(1,1)):(this.bendType=z.Bend,o.splice(2,1),o.splice(1,1)):f.value<c.value?this.isContinuedBend?(this.bendType=z.Release,o.splice(2,1),o.splice(1,1)):(this.bendType=z.PrebendRelease,o.splice(2,1),o.splice(1,1)):d.value>c.value?this.bendType=z.BendRelease:c.value>0&&!this.isContinuedBend?(this.bendType=z.Prebend,o.splice(2,1),o.splice(1,1)):(this.bendType=z.Hold,o.splice(2,1),o.splice(1,1)):x.warning("Model","Unsupported bend type detected, fallback to custom",null)}else if(2===o.length){const c=o[0],d=o[1];this.bendType=d.value>c.value?!this.isContinuedBend&&c.value>0?z.PrebendBend:z.Bend:d.value<c.value?this.isContinuedBend?z.Release:z.PrebendRelease:c.value>0&&!this.isContinuedBend?z.Prebend:z.Hold}this.initialBendValue>0&&(this.accidentalMode=ge.Default)}static nextNoteOnSameLine(e){let s=e.beat.nextBeat;for(;s&&s.voice.bar.index<=e.beat.voice.bar.index+r.MaxOffsetForSameLineSearch;){const i=s.getNoteOnString(e.string);if(i)return i;s=s.nextBeat}return null}static findHammerPullDestination(e){let s=e.beat.nextBeat;for(;s&&s.voice.bar.index<=e.beat.voice.bar.index+r.MaxOffsetForSameLineSearch;){let i=s.getNoteOnString(e.string);if(i)return i;for(let a=e.string;a>0;a--)if(i=s.getNoteOnString(a),i){if(i.isLeftHandTapped)return i;break}for(let a=e.string;a<=e.beat.voice.bar.staff.tuning.length;a++)if(i=s.getNoteOnString(a),i){if(i.isLeftHandTapped)return i;break}s=s.nextBeat}return null}static findTieOrigin(e){let s=e.beat.previousBeat;for(;s&&s.voice.bar.index>=e.beat.voice.bar.index-r.MaxOffsetForSameLineSearch;){if(e.isStringed){const i=s.getNoteOnString(e.string);if(i)return i}else if(-1===e.octave&&-1===e.tone){if(e.index<s.notes.length)return s.notes[e.index]}else{const i=s.getNoteWithRealValue(e.realValue);if(i)return i}s=s.previousBeat}return null}chain(e=null){if(null!==e)if(null!==this._noteIdBag){let s;e.has(r.NoteIdLookupKey)?s=e.get(r.NoteIdLookupKey):(s=new Map,e.set(r.NoteIdLookupKey,s)),(-1!==this._noteIdBag.hammerPullDestinationNoteId||-1!==this._noteIdBag.tieDestinationNoteId||-1!==this._noteIdBag.slurDestinationNoteId||-1!==this._noteIdBag.slideTargetNoteId)&&s.set(this.id,this),-1!==this._noteIdBag.hammerPullOriginNoteId&&(this.hammerPullOrigin=s.get(this._noteIdBag.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),-1!==this._noteIdBag.tieOriginNoteId&&(this.tieOrigin=s.get(this._noteIdBag.tieOriginNoteId),this.tieOrigin.tieDestination=this),-1!==this._noteIdBag.slurOriginNoteId&&(this.slurOrigin=s.get(this._noteIdBag.slurOriginNoteId),this.slurOrigin.slurDestination=this),-1!==this._noteIdBag.slideOriginNoteId&&(this.slideOrigin=s.get(this._noteIdBag.slideOriginNoteId),this.slideOrigin.slideTarget=this),this._noteIdBag=null}else{if(!this.isTieDestination&&null===this.tieOrigin)return;const s=this.tieOrigin??r.findTieOrigin(this);s?(s.tieDestination=this,this.tieOrigin=s,this.fret=s.fret,this.octave=s.octave,this.tone=s.tone,s.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1}}toJson(e){null!==this.tieDestination&&e.set("tiedestinationnoteid",this.tieDestination.id),null!==this.tieOrigin&&e.set("tieoriginnoteid",this.tieOrigin.id),null!==this.slurDestination&&e.set("slurdestinationnoteid",this.slurDestination.id),null!==this.slurOrigin&&e.set("sluroriginnoteid",this.slurOrigin.id),null!==this.hammerPullOrigin&&e.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),null!==this.hammerPullDestination&&e.set("hammerpulldestinationnoteid",this.hammerPullDestination.id),null!==this.slideTarget&&e.set("slidetargetnoteid",this.slideTarget.id),null!==this.slideOrigin&&e.set("slideoriginnoteid",this.slideOrigin.id)}setProperty(e,s){switch(e){case"tiedestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Zs),this._noteIdBag.tieDestinationNoteId=s,!0;case"tieoriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Zs),this._noteIdBag.tieOriginNoteId=s,!0;case"slurdestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Zs),this._noteIdBag.slurDestinationNoteId=s,!0;case"sluroriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Zs),this._noteIdBag.slurOriginNoteId=s,!0;case"hammerpulloriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Zs),this._noteIdBag.hammerPullOriginNoteId=s,!0;case"hammerpulldestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Zs),this._noteIdBag.hammerPullDestinationNoteId=s,!0;case"slidetargetnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Zs),this._noteIdBag.slideTargetNoteId=s,!0;case"slideoriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Zs),this._noteIdBag.slideOriginNoteId=s,!0}return!1}}return r.GlobalNoteId=0,r.MaxOffsetForSameLineSearch=3,r.NoteIdLookupKey="NoteIdLookup",r})();class Tt{constructor(t){this._isEqualLengthTuplet=!0,this.totalDuration=0,this.beats=[],this.isFull=!1,this.voice=t}check(t){if(0===this.beats.length)return this.beats.push(t),this.totalDuration+=t.playbackDuration,!0;if(t.graceType!==K.None)return!0;if(t.voice!==this.voice||this.isFull||t.tupletNumerator!==this.beats[0].tupletNumerator||t.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(t.playbackDuration!==this.beats[0].playbackDuration&&(this._isEqualLengthTuplet=!1),this.beats.push(t),this.totalDuration+=t.playbackDuration,this._isEqualLengthTuplet)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{const e=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(const s of Tt.AllTicks)if(this.totalDuration===s*e){this.isFull=!0;break}}return!0}}Tt.HalfTicks=1920,Tt.QuarterTicks=960,Tt.EighthTicks=480,Tt.SixteenthTicks=240,Tt.ThirtySecondTicks=120,Tt.SixtyFourthTicks=60,Tt.OneHundredTwentyEighthTicks=30,Tt.TwoHundredFiftySixthTicks=15,Tt.AllTicks=[Tt.HalfTicks,Tt.QuarterTicks,Tt.EighthTicks,Tt.SixteenthTicks,Tt.ThirtySecondTicks,Tt.SixtyFourthTicks,Tt.OneHundredTwentyEighthTicks,Tt.TwoHundredFiftySixthTicks];var _e=function(r){return r[r.None=0]="None",r[r.Custom=1]="Custom",r[r.Dive=2]="Dive",r[r.Dip=3]="Dip",r[r.Hold=4]="Hold",r[r.Predive=5]="Predive",r[r.PrediveDive=6]="PrediveDive",r}(_e||{});class Vn{static clone(t){const e=new R;return e.offset=t.offset,e.value=t.value,e}}class Gn{static clone(t){const e=new ts;if(e.index=t.index,e.accentuated=t.accentuated,e.bendType=t.bendType,e.bendStyle=t.bendStyle,e.isContinuedBend=t.isContinuedBend,t.bendPoints){e.bendPoints=[];for(const s of t.bendPoints)e.addBendPoint(Vn.clone(s))}return e.fret=t.fret,e.string=t.string,e.showStringNumber=t.showStringNumber,e.octave=t.octave,e.tone=t.tone,e.percussionArticulation=t.percussionArticulation,e.isVisible=t.isVisible,e.isLeftHandTapped=t.isLeftHandTapped,e.isHammerPullOrigin=t.isHammerPullOrigin,e.isSlurDestination=t.isSlurDestination,e.harmonicType=t.harmonicType,e.harmonicValue=t.harmonicValue,e.isGhost=t.isGhost,e.isLetRing=t.isLetRing,e.isPalmMute=t.isPalmMute,e.isDead=t.isDead,e.isStaccato=t.isStaccato,e.slideInType=t.slideInType,e.slideOutType=t.slideOutType,e.vibrato=t.vibrato,e.isTieDestination=t.isTieDestination,e.leftHandFinger=t.leftHandFinger,e.rightHandFinger=t.rightHandFinger,e.trillValue=t.trillValue,e.trillSpeed=t.trillSpeed,e.durationPercent=t.durationPercent,e.accidentalMode=t.accidentalMode,e.dynamics=t.dynamics,e.ornament=t.ornament,e}}class fh{static clone(t){const e=new Yi;return e.barOccurence=t.barOccurence,e.millisecondOffset=t.millisecondOffset,e}}class ph{static clone(t){const e=new Qe;return e.isLinear=t.isLinear,e.type=t.type,e.value=t.value,e.syncPointValue=t.syncPointValue?fh.clone(t.syncPointValue):void 0,e.ratioPosition=t.ratioPosition,e.text=t.text,e}}class xa{static clone(t){const e=new xt;e.index=t.index,e.notes=[];for(const s of t.notes)e.addNote(Gn.clone(s));e.isEmpty=t.isEmpty,e.whammyStyle=t.whammyStyle,e.ottava=t.ottava,e.isLegatoOrigin=t.isLegatoOrigin,e.duration=t.duration,e.isLetRing=t.isLetRing,e.isPalmMute=t.isPalmMute,e.automations=[];for(const s of t.automations)e.automations.push(ph.clone(s));if(e.dots=t.dots,e.fade=t.fade,e.lyrics=t.lyrics?t.lyrics.slice():null,e.pop=t.pop,e.slap=t.slap,e.tap=t.tap,e.text=t.text,e.slashed=t.slashed,e.deadSlapped=t.deadSlapped,e.brushType=t.brushType,e.brushDuration=t.brushDuration,e.tupletDenominator=t.tupletDenominator,e.tupletNumerator=t.tupletNumerator,e.isContinuedWhammy=t.isContinuedWhammy,e.whammyBarType=t.whammyBarType,t.whammyBarPoints){e.whammyBarPoints=[];for(const s of t.whammyBarPoints)e.addWhammyBarPoint(Vn.clone(s))}return e.vibrato=t.vibrato,e.chordId=t.chordId,e.graceType=t.graceType,e.pickStroke=t.pickStroke,e.tremoloSpeed=t.tremoloSpeed,e.crescendo=t.crescendo,e.displayStart=t.displayStart,e.playbackStart=t.playbackStart,e.displayDuration=t.displayDuration,e.playbackDuration=t.playbackDuration,e.overrideDisplayDuration=t.overrideDisplayDuration,e.golpe=t.golpe,e.dynamics=t.dynamics,e.invertBeamDirection=t.invertBeamDirection,e.preferredBeamDirection=t.preferredBeamDirection,e.isEffectSlurOrigin=t.isEffectSlurOrigin,e.beamingMode=t.beamingMode,e.wahPedal=t.wahPedal,e.barreFret=t.barreFret,e.barreShape=t.barreShape,e.rasgueado=t.rasgueado,e.showTimer=t.showTimer,e.timer=t.timer,e}}var Gt=function(r){return r[r.None=0]="None",r[r.Thumb=1]="Thumb",r[r.Finger=2]="Finger",r}(Gt||{}),ct=function(r){return r[r.None=0]="None",r[r.FadeIn=1]="FadeIn",r[r.FadeOut=2]="FadeOut",r[r.VolumeSwell=3]="VolumeSwell",r}(ct||{}),Jt=function(r){return r[r.None=0]="None",r[r.Open=1]="Open",r[r.Closed=2]="Closed",r}(Jt||{}),qt=function(r){return r[r.None=0]="None",r[r.Full=1]="Full",r[r.Half=2]="Half",r}(qt||{}),G=function(r){return r[r.None=0]="None",r[r.Ii=1]="Ii",r[r.Mi=2]="Mi",r[r.MiiTriplet=3]="MiiTriplet",r[r.MiiAnapaest=4]="MiiAnapaest",r[r.PmpTriplet=5]="PmpTriplet",r[r.PmpAnapaest=6]="PmpAnapaest",r[r.PeiTriplet=7]="PeiTriplet",r[r.PeiAnapaest=8]="PeiAnapaest",r[r.PaiTriplet=9]="PaiTriplet",r[r.PaiAnapaest=10]="PaiAnapaest",r[r.AmiTriplet=11]="AmiTriplet",r[r.AmiAnapaest=12]="AmiAnapaest",r[r.Ppp=13]="Ppp",r[r.Amii=14]="Amii",r[r.Amip=15]="Amip",r[r.Eami=16]="Eami",r[r.Eamii=17]="Eamii",r[r.Peami=18]="Peami",r}(G||{}),ze=function(r){return r[r.Auto=0]="Auto",r[r.ForceSplitToNext=1]="ForceSplitToNext",r[r.ForceMergeWithNext=2]="ForceMergeWithNext",r[r.ForceSplitOnSecondaryToNext=3]="ForceSplitOnSecondaryToNext",r}(ze||{}),Ae=function(r){return r[r.Effects=0]="Effects",r[r.StandardNotationStem=1]="StandardNotationStem",r[r.StandardNotationFlags=2]="StandardNotationFlags",r[r.StandardNotationBeams=3]="StandardNotationBeams",r[r.StandardNotationTuplet=4]="StandardNotationTuplet",r[r.StandardNotationEffects=5]="StandardNotationEffects",r[r.StandardNotationRests=6]="StandardNotationRests",r[r.GuitarTabStem=7]="GuitarTabStem",r[r.GuitarTabFlags=8]="GuitarTabFlags",r[r.GuitarTabBeams=9]="GuitarTabBeams",r[r.GuitarTabTuplet=10]="GuitarTabTuplet",r[r.GuitarTabEffects=11]="GuitarTabEffects",r[r.GuitarTabRests=12]="GuitarTabRests",r[r.SlashStem=13]="SlashStem",r[r.SlashFlags=14]="SlashFlags",r[r.SlashBeams=15]="SlashBeams",r[r.SlashTuplet=16]="SlashTuplet",r[r.SlashRests=17]="SlashRests",r[r.SlashEffects=18]="SlashEffects",r[r.NumberedDuration=19]="NumberedDuration",r[r.NumberedEffects=20]="NumberedEffects",r[r.NumberedRests=21]="NumberedRests",r[r.NumberedTuplet=22]="NumberedTuplet",r}(Ae||{});class zn extends di{}let xt=(()=>{class r{constructor(){this.id=r._globalBeatId++,this.index=0,this.previousBeat=null,this.nextBeat=null,this.notes=[],this.noteStringLookup=new Map,this.noteValueLookup=new Map,this.isEmpty=!1,this.whammyStyle=Ie.Default,this.ottava=le.Regular,this.fermata=null,this.isLegatoOrigin=!1,this.minNote=null,this.maxNote=null,this.maxStringNote=null,this.minStringNote=null,this.duration=m.Quarter,this.isLetRing=!1,this.isPalmMute=!1,this.automations=[],this.dots=0,this.fade=ct.None,this.lyrics=null,this.pop=!1,this.slap=!1,this.tap=!1,this.text=null,this.slashed=!1,this.deadSlapped=!1,this.brushType=V.None,this.brushDuration=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.tupletGroup=null,this.isContinuedWhammy=!1,this.whammyBarType=_e.None,this.whammyBarPoints=null,this.maxWhammyPoint=null,this.minWhammyPoint=null,this.vibrato=ke.None,this.chordId=null,this.graceType=K.None,this.graceGroup=null,this.graceIndex=-1,this.pickStroke=yt.None,this.tremoloSpeed=null,this.crescendo=Ft.None,this.displayStart=0,this.playbackStart=0,this.displayDuration=0,this.playbackDuration=0,this.golpe=Gt.None,this.dynamics=J.F,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.isEffectSlurOrigin=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this.beamingMode=ze.Auto,this.wahPedal=Jt.None,this.barreFret=-1,this.barreShape=qt.None,this.rasgueado=G.None,this.showTimer=!1,this.timer=null}static resetIds(){r._globalBeatId=0}get isLastOfVoice(){return this.index===this.voice.beats.length-1}get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}get isRest(){return this.isEmpty||!this.deadSlapped&&0===this.notes.length}get isFullBarRest(){return this.isRest&&1===this.voice.beats.length&&this.duration===m.Whole}get fadeIn(){return this.fade===ct.FadeIn}set fadeIn(e){this.fade=e?ct.FadeIn:ct.None}get hasRasgueado(){return this.rasgueado!==G.None}get hasTuplet(){return!(-1===this.tupletDenominator&&-1===this.tupletNumerator||1===this.tupletDenominator&&1===this.tupletNumerator)}get hasWhammyBar(){return null!==this.whammyBarPoints&&this.whammyBarType!==_e.None}get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}get isTremolo(){return!!this.tremoloSpeed}get displayEnd(){return this.displayStart+this.displayDuration}get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get isBarre(){return this.barreShape!==qt.None&&this.barreFret>=0}addWhammyBarPoint(e){let s=this.whammyBarPoints;null===s&&(s=[],this.whammyBarPoints=s),s.push(e),(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e),(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e),this.whammyBarType===_e.None&&(this.whammyBarType=_e.Custom)}removeWhammyBarPoint(e){const s=this.whammyBarPoints;if(null===s||e<0||e>=s.length)return;s.splice(e,1);const i=s[e];if(i===this.maxWhammyPoint){this.maxWhammyPoint=null;for(const a of s)(!this.maxWhammyPoint||a.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=a)}if(i===this.minWhammyPoint){this.minWhammyPoint=null;for(const a of s)(!this.minWhammyPoint||a.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=a)}}addNote(e){e.beat=this,e.index=this.notes.length,this.notes.push(e),e.isStringed&&this.noteStringLookup.set(e.string,e)}removeNote(e){const s=this.notes.indexOf(e);s>=0&&(this.notes.splice(s,1),e.isStringed&&this.noteStringLookup.delete(e.string))}getAutomation(e){for(let s=0,i=this.automations.length;s<i;s++){const a=this.automations[s];if(a.type===e)return a}return null}getNoteOnString(e){return this.noteStringLookup.has(e)?this.noteStringLookup.get(e):null}calculateDuration(){if(void 0!==this.overrideDisplayDuration)return this.overrideDisplayDuration;if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let e=C.toTicks(this.duration);return 2===this.dots?e=C.applyDot(e,!0):1===this.dots&&(e=C.applyDot(e,!1)),this.tupletDenominator>0&&this.tupletNumerator>=0&&(e=C.applyTuplet(e,this.tupletNumerator,this.tupletDenominator)),e}updateDurations(){const e=this.calculateDuration();switch(this.playbackDuration=e,this.graceType){case K.BeforeBeat:case K.OnBeat:switch(this.duration){case m.Sixteenth:this.playbackDuration=C.toTicks(m.SixtyFourth);break;case m.ThirtySecond:this.playbackDuration=C.toTicks(m.OneHundredTwentyEighth);break;default:this.playbackDuration=C.toTicks(m.ThirtySecond)}this.displayDuration=0;break;case K.BendGrace:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=e;const s=this.previousBeat;s&&s.graceType===K.BendGrace&&(this.playbackDuration=s.playbackDuration)}}finishTuplet(){const e=this.previousBeat;let s=e?e.tupletGroup:null;if((this.hasTuplet||this.graceType!==K.None&&s)&&((!e||!s||!s.check(this))&&(s=new Tt(this.voice),s.check(this)),this.tupletGroup=s),this.index>0){const i=this.voice.bar.masterBar.calculateDuration(),a=[];for(const n of this.automations)0===n.ratioPosition&&(n.ratioPosition=this.playbackStart/i),n.type!==Ge.Volume&&a.push(n);this.automations=a}}finish(e,s=null){switch(null===this.getAutomation(Ge.Instrument)&&0===this.index&&0===this.voice.index&&0===this.voice.bar.index&&0===this.voice.bar.staff.index&&this.automations.push(Qe.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case K.OnBeat:case K.BeforeBeat:const u=this.graceGroup.beats.length;this.duration=1===u?m.Eighth:2===u?m.Sixteenth:m.ThirtySecond}const i=e?e.notation.notationMode:_t.GuitarPro;let a="grad"===this.text||"grad."===this.text;a&&i===_t.SongBook&&(this.text="");let n=!1;this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null;let o=0,h=!1;for(let u=0,f=this.notes.length;u<f;u++){const p=this.notes[u];if(p.dynamics=this.dynamics,p.finish(e,s),p.isLetRing&&(this.isLetRing=!0),p.isPalmMute&&(this.isPalmMute=!0),i===_t.SongBook&&p.hasBend&&this.graceType!==K.BendGrace){if(!p.isTieOrigin)switch(p.bendType){case z.Bend:case z.PrebendRelease:case z.PrebendBend:n=!0}a||p.bendStyle===Ie.Gradual?(a=!0,p.bendStyle=Ie.Gradual,n=!1):p.bendStyle=Ie.Fast}p.isVisible&&(o++,(!this.minNote||p.realValue<this.minNote.realValue)&&(this.minNote=p),(!this.maxNote||p.realValue>this.maxNote.realValue)&&(this.maxNote=p),(!this.minStringNote||p.string<this.minStringNote.string)&&(this.minStringNote=p),(!this.maxStringNote||p.string>this.maxStringNote.string)&&(this.maxStringNote=p),p.hasEffectSlur&&(h=!0))}if(h&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),this.notes.length>0&&0===o&&(this.isEmpty=!0),this.isRest||this.isLetRing&&this.isPalmMute)this.isRest&&this.previousBeat&&e&&e.notation.notationMode===_t.GuitarPro&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute&&(this.isPalmMute=!0));else{let u=this.previousBeat;for(;u&&u.isRest;)this.isLetRing||(u.isLetRing=!1),this.isPalmMute||(u.isPalmMute=!1),u=u.previousBeat}const c=this.whammyBarPoints,d=null!==c&&c.length>0;if(d?this.isContinuedWhammy=!!this.previousBeat&&this.previousBeat.hasWhammyBar:this.whammyBarType=_e.None,d&&this.whammyBarType===_e.Custom&&(i===_t.SongBook&&(this.whammyStyle=a?Ie.Gradual:Ie.Fast),4===c.length)){const u=c[0],f=c[1],p=c[2],g=c[3];f.value===p.value&&(u.value<f.value&&f.value<g.value||u.value>f.value&&f.value>g.value?(this.whammyBarType=0===u.value||this.isContinuedWhammy?_e.Dive:_e.PrediveDive,c.splice(2,1),c.splice(1,1)):u.value>f.value&&f.value<g.value||u.value<f.value&&f.value>g.value?(this.whammyBarType=_e.Dip,(f.offset===p.offset||i===_t.SongBook)&&c.splice(2,1)):u.value===f.value&&f.value===g.value&&(this.whammyBarType=0===u.value||this.isContinuedWhammy?_e.Hold:_e.Predive,c.splice(2,1),c.splice(1,1)))}if(this.updateDurations(),n){const u=xa.clone(this);u.id=r._globalBeatId++,u.pickStroke=yt.None;for(let f=0,p=u.notes.length;f<p;f++){const g=u.notes[f],b=this.notes[f];if(g.bendType=z.None,g.maxBendPoint=null,g.bendPoints=null,g.bendStyle=Ie.Default,g.id=ts.GlobalNoteId++,b.isTieOrigin&&(g.tieDestination=b.tieDestination,b.tieDestination.tieOrigin=g),b.isTieDestination&&(g.tieOrigin=b.tieOrigin?b.tieOrigin:null,b.tieOrigin.tieDestination=g),b.hasBend&&b.isTieOrigin){const w=ts.findTieOrigin(b);if(w&&w.hasBend){g.bendType=z.Hold;const S=b.bendPoints[b.bendPoints.length-1];g.addBendPoint(new R(0,S.value)),g.addBendPoint(new R(R.MaxPosition,S.value))}}g.isTieDestination=!0}this.graceType=K.BendGrace,this.graceGroup=new Tr,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,u),u.graceGroup=new Tr,u.graceGroup.addBeat(this),u.graceGroup.isComplete=!0,u.graceGroup.finish()}}isBefore(e){return this.voice.bar.index<e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index<e.index}isAfter(e){return this.voice.bar.index>e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index>e.index}hasNoteOnString(e){return this.noteStringLookup.has(e)}getNoteWithRealValue(e){return this.noteValueLookup.has(e)?this.noteValueLookup.get(e):null}chain(e=null){for(const s of this.notes)this.noteValueLookup.set(s.realValue,s),s.chain(e)}}return r._globalBeatId=0,r})();var H=function(r){return r[r.Title=0]="Title",r[r.SubTitle=1]="SubTitle",r[r.Artist=2]="Artist",r[r.Album=3]="Album",r[r.Words=4]="Words",r[r.Music=5]="Music",r[r.WordsAndMusic=6]="WordsAndMusic",r[r.Transcriber=7]="Transcriber",r[r.Copyright=8]="Copyright",r[r.CopyrightSecondLine=9]="CopyrightSecondLine",r[r.ChordDiagramList=10]="ChordDiagramList",r}(H||{});let is=(()=>{class r{constructor(e="",s=void 0,i=U.Left){this.template=e,this.isVisible=s,this.textAlign=i}buildText(e){let s=!1,i=!1;const a=this.template.replace(r.PlaceholderPattern,(n,o)=>{i=!0;let h="";switch(o){case"TITLE":h=e.title;break;case"SUBTITLE":h=e.subTitle;break;case"ARTIST":h=e.artist;break;case"ALBUM":h=e.album;break;case"WORDS":case"WORDSMUSIC":h=e.words;break;case"MUSIC":h=e.music;break;case"TABBER":h=e.tab;break;case"COPYRIGHT":h=e.copyright;break;default:h=""}return h&&(s=!0),h});return i&&!s?"":a}}return r.PlaceholderPattern=/%([^%]+)%/g,r})();class fi extends di{constructor(){super(...arguments),this.headerAndFooter=new Map}}fi.defaultHeaderAndFooter=new Map([[H.Title,new is("%TITLE%",void 0,U.Center)],[H.SubTitle,new is("%SUBTITLE%",void 0,U.Center)],[H.Artist,new is("%ARTIST%",void 0,U.Center)],[H.Album,new is("%ALBUM%",void 0,U.Center)],[H.Words,new is("Words by %WORDS%",void 0,U.Left)],[H.Music,new is("Music by %MUSIC%",void 0,U.Right)],[H.WordsAndMusic,new is("Words & Music by %MUSIC%",void 0,U.Right)],[H.Transcriber,new is("Tabbed by %TABBER%",!1,U.Right)],[H.Copyright,new is("%COPYRIGHT%",void 0,U.Center)],[H.CopyrightSecondLine,new is("All Rights Reserved - International Copyright Secured",!0,U.Center)]]);class Cs{constructor(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0,this.album="",this.artist="",this.copyright="",this.instructions="",this.music="",this.notices="",this.subTitle="",this.title="",this.words="",this.tab="",this.tempo=120,this.tempoLabel="",this.masterBars=[],this.tracks=[],this.defaultSystemsLayout=3,this.systemsLayout=[],this.stylesheet=new Rs}static resetIds(){Ts.resetIds(),xt.resetIds(),es.resetIds(),ts.resetIds()}rebuildRepeatGroups(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0;for(const t of this.masterBars)this.addMasterBarToRepeatGroups(t)}addMasterBar(t){t.score=this,t.index=this.masterBars.length,0!==this.masterBars.length&&(t.previousMasterBar=this.masterBars[this.masterBars.length-1],t.previousMasterBar.nextMasterBar=t,t.start=t.previousMasterBar.start+(t.previousMasterBar.isAnacrusis?0:t.previousMasterBar.calculateDuration())),this.addMasterBarToRepeatGroups(t),this.masterBars.push(t)}addMasterBarToRepeatGroups(t){t.isRepeatStart?(this._currentRepeatGroup?.isClosed&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--),this._currentRepeatGroup=new Ui,this._openedRepeatGroups.push(this._currentRepeatGroup),this._properlyOpenedRepeatGroups++):this._currentRepeatGroup||(this._currentRepeatGroup=new Ui,this._openedRepeatGroups.push(this._currentRepeatGroup)),this._currentRepeatGroup.addMasterBar(t),t.isRepeatEnd&&this._properlyOpenedRepeatGroups>1&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--,this._currentRepeatGroup=this._openedRepeatGroups.length>0?this._openedRepeatGroups[this._openedRepeatGroups.length-1]:null)}addTrack(t){t.score=this,t.index=this.tracks.length,this.tracks.push(t)}finish(t){const e=new Map;for(let s=0,i=this.tracks.length;s<i;s++)this.tracks[s].finish(t,e)}applyFlatSyncPoints(t){for(const e of this.masterBars)e.syncPoints=void 0;for(const e of t){const s=new Qe;s.ratioPosition=Math.min(1,Math.max(0,e.barPosition)),s.type=Ge.SyncPoint,s.syncPointValue=new Yi,s.syncPointValue.millisecondOffset=e.millisecondOffset,s.syncPointValue.barOccurence=e.barOccurence,e.barIndex<this.masterBars.length&&this.masterBars[e.barIndex].addSyncPoint(s)}for(const e of this.masterBars)e.syncPoints&&e.syncPoints.sort((s,i)=>{const a=s.syncPointValue.barOccurence-i.syncPointValue.barOccurence;return 0!==a?a:s.ratioPosition-i.ratioPosition})}exportFlatSyncPoints(){const t=[];for(const e of this.masterBars){const s=e.syncPoints;if(s)for(const i of s)t.push({barIndex:e.index,barOccurence:i.syncPointValue.barOccurence,barPosition:i.ratioPosition,millisecondOffset:i.syncPointValue.millisecondOffset})}return t}}class pi{init(t,e){this.data=t,this.settings=e,Cs.resetIds()}}var Fe=function(r){return r[r.General=0]="General",r[r.Format=1]="Format",r[r.AlphaTex=2]="AlphaTex",r}(Fe||{});class Le extends Error{constructor(t,e="",s){super(e??"",{cause:s}),this.type=t,Object.setPrototypeOf(this,Le.prototype)}}class st extends Le{constructor(t=null,e){super(Fe.Format,t??"Unsupported format",e),Object.setPrototypeOf(this,st.prototype)}}class Os{constructor(){this.name="",this.firstFret=1,this.strings=[],this.barreFrets=[],this.showName=!0,this.showDiagram=!0,this.showFingering=!0}get uniqueId(){return[this.name,this.firstFret.toString(),this.strings.join(","),this.barreFrets.join(","),this.showDiagram.toString(),this.showFingering.toString(),this.showName.toString()].join("|")}}var Mt=function(r){return r[r.IgnoreSpaces=0]="IgnoreSpaces",r[r.Begin=1]="Begin",r[r.Text=2]="Text",r[r.Comment=3]="Comment",r[r.Dash=4]="Dash",r}(Mt||{});let Li=(()=>{class r{constructor(){this.startBar=0,this.text=""}finish(e=!1){this.chunks=[],this.parse(this.text,0,this.chunks,e)}parse(e,s,i,a){if(!e)return;let n=Mt.Begin,o=Mt.Begin,h=!1,c=0;for(;s<e.length;){const d=e.charCodeAt(s);switch(n){case Mt.IgnoreSpaces:switch(d){case r.CharCodeLF:case r.CharCodeCR:case r.CharCodeTab:break;case r.CharCodeSpace:if(!h){n=o;continue}break;default:h=!1,n=o;continue}break;case Mt.Begin:if(d!==r.CharCodeBrackedOpen){c=s,n=Mt.Text;continue}n=Mt.Comment;break;case Mt.Comment:d===r.CharCodeBrackedClose&&(n=Mt.Begin);break;case Mt.Text:switch(d){case r.CharCodeDash:n=Mt.Dash;break;case r.CharCodeCR:case r.CharCodeLF:case r.CharCodeSpace:const u=e.substr(c,s-c);this.addChunk(u,a),n=Mt.IgnoreSpaces,o=Mt.Begin}break;case Mt.Dash:if(d!==r.CharCodeDash){const u=e.substr(c,s-c);this.addChunk(u,a),h=!0,n=Mt.IgnoreSpaces,o=Mt.Begin;continue}}s+=1}n===Mt.Text&&s!==c&&this.addChunk(e.substr(c,s-c),a)}addChunk(e,s){e=this.prepareChunk(e),(!s||e.length>0&&"-"!==e)&&this.chunks.push(e)}prepareChunk(e){const s=e.split("+").join(" ");let i=s.length;for(;i>0&&"_"===s.charAt(i-1);)i--;return i!==s.length?s.substr(0,i):s}}return r.CharCodeLF=10,r.CharCodeTab=9,r.CharCodeCR=13,r.CharCodeSpace=32,r.CharCodeBrackedClose=93,r.CharCodeBrackedOpen=91,r.CharCodeDash=45,r})();class Fi{constructor(){this.marker="",this.text=""}}class ft extends Le{constructor(t){super(Fe.Format,t),Object.setPrototypeOf(this,ft.prototype)}}let Ee=(()=>{class r{constructor(e,s,i,a=255){this.raw=0,this.raw=(255&a)<<24|(255&e)<<16|(255&s)<<8|255&i,this.updateRgba()}updateRgba(){this.rgba=255===this.a?`#${O.toHexString(this.r,2)}${O.toHexString(this.g,2)}${O.toHexString(this.b,2)}`:`rgba(${this.r},${this.g},${this.b},${this.a/255})`}get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return 255&this.raw}static random(e=100){return new r(255*Math.random()|0,255*Math.random()|0,255*Math.random()|0,e)}static fromJson(e){if(e instanceof r)return e;switch(typeof e){case"number":{const s=new r(0,0,0,0);return s.raw=e,s.updateRgba(),s}case"string":{const s=e;if(s.startsWith("#")){if(4===s.length)return new r(17*Number.parseInt(s[1],16),17*Number.parseInt(s[2],16),17*Number.parseInt(s[3],16));if(5===s.length)return new r(17*Number.parseInt(s[1],16),17*Number.parseInt(s[2],16),17*Number.parseInt(s[3],16),17*Number.parseInt(s[4],16));if(7===s.length)return new r(Number.parseInt(s.substring(1,3),16),Number.parseInt(s.substring(3,5),16),Number.parseInt(s.substring(5,7),16));if(9===s.length)return new r(Number.parseInt(s.substring(1,3),16),Number.parseInt(s.substring(3,5),16),Number.parseInt(s.substring(5,7),16),Number.parseInt(s.substring(7,9),16))}else if(s.startsWith("rgba")||s.startsWith("rgb")){const i=s.indexOf("("),a=s.lastIndexOf(")");if(-1===i||-1===a)throw new ft("No values specified for rgb/rgba function");const n=s.substring(i+1,a).split(",");if(3===n.length)return new r(Number.parseInt(n[0]),Number.parseInt(n[1]),Number.parseInt(n[2]));if(4===n.length)return new r(Number.parseInt(n[0]),Number.parseInt(n[1]),Number.parseInt(n[2]),255*Number.parseFloat(n[3]))}return null}}throw new ft("Unsupported format for color")}static toJson(e){return null===e?null:e.raw}}return r.BlackRgb="#000000",r})();class Na{constructor(){this.volume=15,this.balance=8,this.port=1,this.program=0,this.primaryChannel=0,this.secondaryChannel=0,this.isMute=!1,this.isSolo=!1}}class F{static getTextForTuning(t,e){const s=F.getTextPartsForTuning(t);return e?s.join(""):s[0]}static getTextPartsForTuning(t,e=-1){return[["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"][t%12],((t/12|0)+e).toString()]}static getDefaultTuningFor(t){return F._defaultTunings.has(t)?F._defaultTunings.get(t):null}static getPresetsFor(t){switch(t){case 7:return F._sevenStrings;case 6:return F._sixStrings;case 5:return F._fiveStrings;case 4:return F._fourStrings}return[]}static initialize(){F._defaultTunings.set(7,new F("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),F._sevenStrings.push(F._defaultTunings.get(7)),F._defaultTunings.set(6,new F("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),F._sixStrings.push(F._defaultTunings.get(6)),F._sixStrings.push(new F("Guitar Tune down \xbd step",[63,58,54,49,44,39],!1)),F._sixStrings.push(new F("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),F._sixStrings.push(new F("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),F._sixStrings.push(new F("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),F._sixStrings.push(new F("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),F._sixStrings.push(new F("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),F._sixStrings.push(new F("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),F._sixStrings.push(new F("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),F._sixStrings.push(new F("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),F._sixStrings.push(new F("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),F._sixStrings.push(new F("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),F._sixStrings.push(new F("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),F._sixStrings.push(new F("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),F._sixStrings.push(new F("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),F._sixStrings.push(new F("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),F._sixStrings.push(new F("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),F._sixStrings.push(new F("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),F._sixStrings.push(new F("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),F._sixStrings.push(new F("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),F._sixStrings.push(new F("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),F._sixStrings.push(new F("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),F._sixStrings.push(new F("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),F._sixStrings.push(new F("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),F._sixStrings.push(new F("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),F._sixStrings.push(new F("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),F._sixStrings.push(new F("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),F._sixStrings.push(new F("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),F._sixStrings.push(new F("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),F._sixStrings.push(new F("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),F._sixStrings.push(new F("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),F._defaultTunings.set(5,new F("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),F._fiveStrings.push(F._defaultTunings.get(5)),F._fiveStrings.push(new F("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),F._fiveStrings.push(new F("Banjo Open D Tuning",[62,57,54,50,69],!1)),F._fiveStrings.push(new F("Banjo Open G Tuning",[62,59,55,50,67],!1)),F._fiveStrings.push(new F("Banjo G Minor Tuning",[62,58,55,50,67],!1)),F._fiveStrings.push(new F("Banjo G Modal Tuning",[62,57,55,50,67],!1)),F._defaultTunings.set(4,new F("Bass Standard Tuning",[43,38,33,28],!0)),F._fourStrings.push(F._defaultTunings.get(4)),F._fourStrings.push(new F("Bass Tune down \xbd step",[42,37,32,27],!1)),F._fourStrings.push(new F("Bass Tune down 1 step",[41,36,31,26],!1)),F._fourStrings.push(new F("Bass Tune down 2 step",[39,34,29,24],!1)),F._fourStrings.push(new F("Bass Dropped D Tuning",[43,38,33,26],!1)),F._fourStrings.push(new F("Ukulele C Tuning",[45,40,36,43],!1)),F._fourStrings.push(new F("Ukulele G Tuning",[52,47,43,38],!1)),F._fourStrings.push(new F("Mandolin Standard Tuning",[64,57,50,43],!1)),F._fourStrings.push(new F("Mandolin or Violin Tuning",[76,69,62,55],!1)),F._fourStrings.push(new F("Viola Tuning",[69,62,55,48],!1)),F._fourStrings.push(new F("Cello Tuning",[57,50,43,36],!1))}static findTuning(t){const e=F.getPresetsFor(t.length);for(let s=0,i=e.length;s<i;s++){const a=e[s];let n=!0;for(let o=0,h=t.length;o<h;o++)if(t[o]!==a.tunings[o]){n=!1;break}if(n)return a}return null}constructor(t="",e=null,s=!1){this.isStandard=s,this.name=t,this.tunings=e??[]}finish(){const t=F.findTuning(this.tunings);t&&(this.name=t.name,this.isStandard=t.isStandard),this.name=this.name.trim()}}F._sevenStrings=[],F._sixStrings=[],F._fiveStrings=[],F._fourStrings=[],F._defaultTunings=new Map,F.defaultAccidentals=["","#","","#","","","#","","#","","#",""],F.defaultSteps=["C","C","D","D","E","F","F","G","G","A","A","B"],F.initialize();let xr=(()=>{class r{constructor(){this.index=0,this.bars=[],this.chords=null,this.capo=0,this.transpositionPitch=0,this.displayTranspositionPitch=0,this.stringTuning=new F("",[],!1),this.showSlash=!1,this.showNumbered=!1,this.showTablature=!0,this.showStandardNotation=!0,this.isPercussion=!1,this.standardNotationLineCount=r.DefaultStandardNotationLineCount}get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return this.stringTuning.tunings.length>0}finish(e,s=null){this.stringTuning.finish();for(let i=0,a=this.bars.length;i<a;i++)this.bars[i].finish(e,s)}addChord(e,s){s.staff=this;let i=this.chords;null===i&&(i=new Map,this.chords=i),i.set(e,s)}hasChord(e){return this.chords?.has(e)??!1}getChord(e){return this.chords?.get(e)??null}addBar(e){const s=this.bars;e.staff=this,e.index=s.length,s.length>0&&(e.previousBar=s[s.length-1],e.previousBar.nextBar=e),s.push(e)}}return r.DefaultStandardNotationLineCount=5,r})();var Ds=function(r){return r[r.TrackName=0]="TrackName",r[r.BracesAndBrackets=1]="BracesAndBrackets",r[r.SystemSeparator=2]="SystemSeparator",r[r.StringTuning=3]="StringTuning",r}(Ds||{});class Un extends di{}let gi=(()=>{class r{constructor(){this.index=0,this.staves=[],this.playbackInfo=new Na,this.color=new Ee(200,0,0,255),this.name="",this.isVisibleOnMultiTrack=!0,this.shortName="",this.defaultSystemsLayout=3,this.systemsLayout=[],this.percussionArticulations=[]}addLineBreaks(e){this.lineBreaks||(this.lineBreaks=new Set),this.lineBreaks.add(e)}ensureStaveCount(e){for(;this.staves.length<e;)this.addStaff(new xr)}addStaff(e){e.index=this.staves.length,e.track=this,this.staves.push(e)}finish(e,s=null){this.shortName||(this.shortName=this.name,this.shortName.length>r.ShortNameMaxLength&&(this.shortName=this.shortName.substr(0,r.ShortNameMaxLength)));for(let i=0,a=this.staves.length;i<a;i++)this.staves[i].finish(e,s)}applyLyrics(e){for(const i of e)i.finish();const s=this.staves[0];for(let i=0;i<e.length;i++){const a=e[i];if(a.startBar>=0&&a.startBar<s.bars.length){let n=s.bars[a.startBar].voices[0].beats[0];for(let o=0;o<a.chunks.length&&n;o++){for(;n&&(n.isEmpty||n.isRest);)n=n.nextBeat;n&&(n.lyrics||(n.lyrics=new Array(e.length),n.lyrics.fill("")),n.lyrics[i]=a.chunks[o],n=n.nextBeat)}}}}}return r.ShortNameMaxLength=10,r})();class oe{static float64ToBytes(t){return oe._dataView.setFloat64(0,t,!0),oe._conversionByteArray}static bytesToInt64LE(t){oe._conversionByteArray.set(t,0);const e=oe._dataView.getBigInt64(0,!0);return e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER?Number(e):Number.MAX_SAFE_INTEGER}static bytesToFloat64LE(t){return oe._conversionByteArray.set(t,0),oe._dataView.getFloat64(0,!0)}static bytesToFloat32LE(t){return oe._conversionByteArray.set(t,0),oe._dataView.getFloat32(0,!0)}static float32BEToBytes(t){return oe._dataView.setFloat32(0,t,!1),oe._conversionByteArray.slice(0,4)}static uint16ToInt16(t){return oe._dataView.setUint16(0,t,!0),oe._dataView.getInt16(0,!0)}static int16ToUint32(t){return oe._dataView.setInt16(0,t,!0),oe._dataView.getUint32(0,!0)}static int32ToUint16(t){return oe._dataView.setInt32(0,t,!0),oe._dataView.getUint16(0,!0)}static int32ToInt16(t){return oe._dataView.setInt32(0,t,!0),oe._dataView.getInt16(0,!0)}static int32ToUint32(t){return oe._dataView.setInt32(0,t,!0),oe._dataView.getUint32(0,!0)}static uint8ToInt8(t){return oe._dataView.setUint8(0,t),oe._dataView.getInt8(0)}}oe._conversionBuffer=new ArrayBuffer(8),oe._conversionByteArray=new Uint8Array(oe._conversionBuffer),oe._dataView=new DataView(oe._conversionBuffer);class k{static readInt32BE(t){return t.readByte()<<24|t.readByte()<<16|t.readByte()<<8|t.readByte()}static readFloat32BE(t){const e=new Uint8Array(4);return t.read(e,0,e.length),e.reverse(),oe.bytesToFloat32LE(e)}static readFloat64BE(t){const e=new Uint8Array(8);return t.read(e,0,e.length),e.reverse(),oe.bytesToFloat64LE(e)}static readInt32LE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte();return t.readByte()<<24|i<<16|s<<8|e}static readInt64LE(t){const e=new Uint8Array(8);return t.read(e,0,e.length),oe.bytesToInt64LE(e)}static readUInt32LE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte();return t.readByte()<<24|i<<16|s<<8|e}static decodeUInt32LE(t,e){return t[e+3]<<24|t[e+2]<<16|t[e+1]<<8|t[e]}static readUInt16LE(t){const e=t.readByte(),s=t.readByte();return oe.int32ToUint16(s<<8|e)}static readInt16LE(t){const e=t.readByte(),s=t.readByte();return oe.int32ToInt16(s<<8|e)}static readUInt32BE(t){const e=t.readByte(),s=t.readByte(),i=t.readByte(),a=t.readByte();return oe.int32ToUint32(e<<24|s<<16|i<<8|a)}static readUInt16BE(t){const e=t.readByte(),s=t.readByte();return oe.int32ToInt16(e<<8|s)}static readInt16BE(t){const e=t.readByte(),s=t.readByte();return oe.int32ToInt16(e<<8|s)}static readByteArray(t,e){const s=new Uint8Array(e);return t.read(s,0,e),s}static read8BitChars(t,e){const s=new Uint8Array(e);return t.read(s,0,s.length),k.toString(s,"utf-8")}static read8BitString(t){let e="",s=t.readByte();for(;0!==s;)e+=String.fromCharCode(s),s=t.readByte();return e}static read8BitStringLength(t,e){let s="",i=-1;for(let n=0;n<e;n++){const o=t.readByte();0===o&&-1===i&&(i=n),s+=String.fromCharCode(o)}const a=s;return i>=0?a.substr(0,i):a}static readSInt8(t){const e=t.readByte();return-256*((255&e)>>7)+(255&e)}static readInt24(t,e){let s=t[e]|t[e+1]<<8|t[e+2]<<16;return!(8388608&~s)&&(s|=255<<24),s}static readInt16(t,e){return oe.int32ToInt16(t[e]|t[e+1]<<8)}static toString(t,e){const s=k.detectEncoding(t);return s&&(e=s),e||(e="utf-8"),new TextDecoder(e).decode(t.buffer)}static detectEncoding(t){return t.length>2&&254===t[0]&&255===t[1]?"utf-16be":t.length>2&&255===t[0]&&254===t[1]?"utf-16le":t.length>4&&0===t[0]&&0===t[1]&&254===t[2]&&255===t[3]?"utf-32be":t.length>4&&255===t[0]&&254===t[1]&&0===t[2]&&0===t[3]?"utf-32le":null}static stringToBytes(t){return(new TextEncoder).encode(t)}static writeInt32BE(t,e){t.writeByte(e>>24&255),t.writeByte(e>>16&255),t.writeByte(e>>8&255),t.writeByte(255&e)}static writeInt32LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255),t.writeByte(e>>16&255),t.writeByte(e>>24&255)}static writeUInt16LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255)}static writeInt16LE(t,e){t.writeByte(255&e),t.writeByte(e>>8&255)}static writeInt16BE(t,e){t.writeByte(e>>8&255),t.writeByte(255&e)}static writeFloat32BE(t,e){const s=oe.float32BEToBytes(e);t.write(s,0,s.length)}}class Ke{constructor(){this.length=0,this.position=0}get bytesWritten(){return this.position}getBuffer(){return this._buffer}static empty(){return Ke.withCapacity(0)}static withCapacity(t){const e=new Ke;return e._buffer=new Uint8Array(t),e}static fromBuffer(t){const e=new Ke;return e._buffer=t,e.length=t.length,e}static fromString(t){const e=k.stringToBytes(t);return Ke.fromBuffer(e)}reset(){this.position=0}skip(t){this.position+=t}readByte(){return this.length-this.position<=0?-1:this._buffer[this.position++]}read(t,e,s){let i=this.length-this.position;return i>s&&(i=s),i<=0?0:(t.set(this._buffer.subarray(this.position,this.position+i),e),this.position+=i,i)}writeByte(t){const e=this.position+1;this.ensureCapacity(e),this._buffer[this.position]=255&t,e>this.length&&(this.length=e),this.position=e}write(t,e,s){const i=this.position+s;this.ensureCapacity(i);const a=Math.min(s,t.length-e);this._buffer.set(t.subarray(e,e+a),this.position),i>this.length&&(this.length=i),this.position=i}ensureCapacity(t){if(t>this._buffer.length){let e=t;e<256&&(e=256),e<2*this._buffer.length&&(e=2*this._buffer.length);const s=new Uint8Array(e);this.length>0&&s.set(this._buffer.subarray(0,0+this.length),0),this._buffer=s}}readAll(){return this.toArray()}toArray(){const t=new Uint8Array(this.length);return t.set(this._buffer.subarray(0,0+this.length),0),t}copyTo(t){t.write(this._buffer,0,this.length)}}var I=function(r){return r[r.TargetFine=0]="TargetFine",r[r.TargetSegno=1]="TargetSegno",r[r.TargetSegnoSegno=2]="TargetSegnoSegno",r[r.TargetCoda=3]="TargetCoda",r[r.TargetDoubleCoda=4]="TargetDoubleCoda",r[r.JumpDaCapo=5]="JumpDaCapo",r[r.JumpDaCapoAlCoda=6]="JumpDaCapoAlCoda",r[r.JumpDaCapoAlDoubleCoda=7]="JumpDaCapoAlDoubleCoda",r[r.JumpDaCapoAlFine=8]="JumpDaCapoAlFine",r[r.JumpDalSegno=9]="JumpDalSegno",r[r.JumpDalSegnoAlCoda=10]="JumpDalSegnoAlCoda",r[r.JumpDalSegnoAlDoubleCoda=11]="JumpDalSegnoAlDoubleCoda",r[r.JumpDalSegnoAlFine=12]="JumpDalSegnoAlFine",r[r.JumpDalSegnoSegno=13]="JumpDalSegnoSegno",r[r.JumpDalSegnoSegnoAlCoda=14]="JumpDalSegnoSegnoAlCoda",r[r.JumpDalSegnoSegnoAlDoubleCoda=15]="JumpDalSegnoSegnoAlDoubleCoda",r[r.JumpDalSegnoSegnoAlFine=16]="JumpDalSegnoSegnoAlFine",r[r.JumpDaCoda=17]="JumpDaCoda",r[r.JumpDaDoubleCoda=18]="JumpDaDoubleCoda",r}(I||{}),Ct=function(r){return r[r.Short=0]="Short",r[r.Medium=1]="Medium",r[r.Long=2]="Long",r}(Ct||{});class Ei{constructor(){this.type=Ct.Short,this.length=0}}var P=function(r){return r[r.Up=0]="Up",r[r.Down=1]="Down",r}(P||{}),y=function(r){return r[r.No=0]="No",r[r.Eof=1]="Eof",r[r.Number=2]="Number",r[r.DoubleDot=3]="DoubleDot",r[r.Dot=4]="Dot",r[r.String=5]="String",r[r.Tuning=6]="Tuning",r[r.LParensis=7]="LParensis",r[r.RParensis=8]="RParensis",r[r.LBrace=9]="LBrace",r[r.RBrace=10]="RBrace",r[r.Pipe=11]="Pipe",r[r.MetaCommand=12]="MetaCommand",r[r.Multiply=13]="Multiply",r[r.LowerThan=14]="LowerThan",r}(y||{}),bt=function(r){return r[r.KnownStaffMeta=0]="KnownStaffMeta",r[r.UnknownStaffMeta=1]="UnknownStaffMeta",r[r.EndOfMetaDetected=2]="EndOfMetaDetected",r}(bt||{});class mi extends Le{constructor(t,e,s,i,a,n,o,h=null){super(Fe.AlphaTex,t),this.position=e,this.line=s,this.col=i,this.nonTerm=a??"",this.expected=n??y.No,this.symbol=o??y.No,this.symbolData=h,Object.setPrototypeOf(this,mi.prototype)}static symbolError(t,e,s,i,a,n,o=null){let h=`MalFormed AlphaTex: @${t} (line ${e}, col ${s}): Error on block ${i}`;return a!==n?(h+=`, expected a ${y[a]} found a ${y[n]}`,null!==o&&(h+=`: '${o}'`)):h+=`, invalid value: '${o}'`,new mi(h,t,e,s,i,a,n,o)}static errorMessage(t,e,s,i){return new mi(t=`MalFormed AlphaTex: @${e} (line ${s}, col ${i}): ${t}`,e,s,i,null,null,null,null)}}var Qi=function(r){return r[r.Auto=0]="Auto",r[r.Explicit=1]="Explicit",r}(Qi||{});let Nr=(()=>{class r extends pi{constructor(){super(...arguments),this._trackChannel=0,this._barIndex=0,this._voiceIndex=0,this._input="",this._ch=r.Eof,this._curChPos=0,this._line=1,this._col=0,this._lastValidSpot=[0,1,0],this._sy=y.No,this._syData="",this._allowNegatives=!1,this._allowFloat=!1,this._allowTuning=!1,this._currentDuration=m.QuadrupleWhole,this._currentDynamics=J.PPP,this._currentTuplet=0,this._staffHasExplicitDisplayTransposition=!1,this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._percussionArticulationNames=new Map,this._sustainPedalToBeat=new Map,this._slurs=new Map,this._articulationValueToIndex=new Map,this._accidentalMode=Qi.Explicit,this._syncPoints=[],this.logErrors=!1}get name(){return"AlphaTex"}initFromString(e,s){this.data=Ke.empty(),this._input=e,this.settings=s,Cs.resetIds()}readScore(){try{if(this.data.length>0&&(this._input=k.toString(this.data.readAll(),this.settings.importer.encoding)),this._allowTuning=!0,this._lyrics=new Map,this._sustainPedalToBeat=new Map,this.createDefaultScore(),this._curChPos=0,this._line=1,this._col=0,this.saveValidSpot(),this._currentDuration=m.Quarter,this._currentDynamics=J.F,this._currentTuplet=1,this._ch=this.nextChar(),this._sy=this.newSy(),this._sy===y.LowerThan)throw new st("Unknown start sign '<' (meant to import as XML?)");if(this._sy!==y.Eof){const e=this.metaData(),s=this.bars();if(!e&&!s)throw new st("No alphaTex data found");this._sy===y.Dot&&(this._sy=this.newSy(),this.syncPoints())}O.consolidate(this._score),this._score.finish(this.settings),O.trimEmptyBarsAtEnd(this._score),this._score.rebuildRepeatGroups(),this._score.applyFlatSyncPoints(this._syncPoints);for(const[e,s]of this._lyrics)this._score.tracks[e].applyLyrics(s);for(const[e,s]of this._sustainPedalToBeat){const i=s.voice.bar.masterBar.calculateDuration();e.ratioPosition=s.playbackStart/i}return this._score}catch(e){throw e instanceof mi?new st(e.message,e):e}}syncPoints(){for(;this._sy!==y.Eof;)this.syncPoint()}syncPoint(){(this._sy!==y.MetaCommand||"sync"!==this._syData)&&this.error("syncPoint",y.MetaCommand,!0),this._sy=this.newSy(),this._sy!==y.Number&&this.error("syncPointBarIndex",y.Number,!0);const e=this._syData;this._sy=this.newSy(),this._sy!==y.Number&&this.error("syncPointBarOccurence",y.Number,!0);const s=this._syData;this._sy=this.newSy(),this._sy!==y.Number&&this.error("syncPointBarMillis",y.Number,!0);const i=this._syData;this._allowFloat=!0,this._sy=this.newSy(),this._allowFloat=!1;let a=0;this._sy===y.Number&&(a=this._syData,this._sy=this.newSy()),this._syncPoints.push({barIndex:e,barOccurence:s,barPosition:a,millisecondOffset:i})}error(e,s,i=!0){let a,n=!1;i?(a=this._sy,(a===y.String||a===y.Number||a===y.MetaCommand)&&(n=!0)):a=s;const o=mi.symbolError(this._lastValidSpot[0],this._lastValidSpot[1],this._lastValidSpot[2],e,s,a,n?this._syData:null);throw this.logErrors&&x.error(this.name,o.message),o}errorMessage(e){const s=mi.errorMessage(e,this._lastValidSpot[0],this._lastValidSpot[1],this._lastValidSpot[2]);throw this.logErrors&&x.error(this.name,s.message),s}createDefaultScore(){this._score=new Cs,this._score.tempo=120,this._score.tempoLabel="",this.newTrack()}newTrack(){this._currentTrack=new gi,this._currentTrack.ensureStaveCount(1),this._currentTrack.playbackInfo.program=25,this._currentTrack.playbackInfo.primaryChannel=this._trackChannel++,this._currentTrack.playbackInfo.secondaryChannel=this._trackChannel++;const e=this._currentTrack.staves[0];e.displayTranspositionPitch=0,e.stringTuning.tunings=F.getDefaultTuningFor(6).tunings,this._articulationValueToIndex.clear(),this.beginStaff(e),this._score.addTrack(this._currentTrack),this._lyrics.set(this._currentTrack.index,[]),this._currentDynamics=J.F}parseClefFromString(e){switch(e.toLowerCase()){case"g2":case"treble":default:return Se.G2;case"f4":case"bass":return Se.F4;case"c3":case"tenor":return Se.C3;case"c4":case"alto":return Se.C4;case"n":case"neutral":return Se.Neutral}}parseClefFromInt(e){switch(e){case 43:default:return Se.G2;case 65:return Se.F4;case 48:return Se.C3;case 60:return Se.C4}}parseTripletFeelFromString(e){switch(e.toLowerCase()){case"no":case"none":default:return ue.NoTripletFeel;case"t16":case"triplet-16th":return ue.Triplet16th;case"t8":case"triplet-8th":return ue.Triplet8th;case"d16":case"dotted-16th":return ue.Dotted16th;case"d8":case"dotted-8th":return ue.Dotted8th;case"s16":case"scottish-16th":return ue.Scottish16th;case"s8":case"scottish-8th":return ue.Scottish8th}}parseTripletFeelFromInt(e){switch(e){case 0:default:return ue.NoTripletFeel;case 1:return ue.Triplet16th;case 2:return ue.Triplet8th;case 3:return ue.Dotted16th;case 4:return ue.Dotted8th;case 5:return ue.Scottish16th;case 6:return ue.Scottish8th}}parseKeySignature(e){switch(e.toLowerCase()){case"cb":case"cbmajor":case"abminor":return ye.Cb;case"gb":case"gbmajor":case"ebminor":return ye.Gb;case"db":case"dbmajor":case"bbminor":return ye.Db;case"ab":case"abmajor":case"fminor":return ye.Ab;case"eb":case"ebmajor":case"cminor":return ye.Eb;case"bb":case"bbmajor":case"gminor":return ye.Bb;case"f":case"fmajor":case"dminor":return ye.F;case"c":case"cmajor":case"aminor":default:return ye.C;case"g":case"gmajor":case"eminor":return ye.G;case"d":case"dmajor":case"bminor":return ye.D;case"a":case"amajor":case"f#minor":return ye.A;case"e":case"emajor":case"c#minor":return ye.E;case"b":case"bmajor":case"g#minor":return ye.B;case"f#":case"f#major":case"d#minor":return ye.FSharp;case"c#":case"c#major":case"a#minor":return ye.CSharp}}parseKeySignatureType(e){return e.toLowerCase().endsWith("minor")?It.Minor:It.Major}nextChar(){return this._curChPos<this._input.length?(this._ch=this._input.charCodeAt(this._curChPos++),10===this._ch?(this._line++,this._col=0):this._col++):this._ch=r.Eof,this._ch}saveValidSpot(){this._lastValidSpot=[this._curChPos,this._line,this._col]}newSy(){for(this.saveValidSpot(),this._sy=y.No;this._sy===y.No;)if(this._ch===r.Eof)this._sy=y.Eof;else if(r.isWhiteSpace(this._ch))this._ch=this.nextChar(),this.saveValidSpot();else if(47===this._ch){if(this._ch=this.nextChar(),47===this._ch)for(;13!==this._ch&&10!==this._ch&&this._ch!==r.Eof;)this._ch=this.nextChar();else if(42===this._ch)for(;this._ch!==r.Eof;)if(42===this._ch){if(this._ch=this.nextChar(),47===this._ch){this._ch=this.nextChar();break}}else this._ch=this.nextChar();else this.error("comment",y.String,!1);this.saveValidSpot()}else if(34===this._ch||39===this._ch){const e=this._ch;this._ch=this.nextChar();let s="";for(this._sy=y.String;this._ch!==e&&this._ch!==r.Eof;)92===this._ch?(this._ch=this.nextChar(),92===this._ch?s+="\\":this._ch===e?s+=String.fromCharCode(this._ch):82===this._ch||114===this._ch?s+="\r":78===this._ch||110===this._ch?s+="\n":84===this._ch||116===this._ch?s+="\t":this.errorMessage("Unsupported escape sequence")):s+=String.fromCharCode(this._ch),this._ch=this.nextChar();this._ch===r.Eof&&this.errorMessage("String opened but never closed"),this._syData=s,this._ch=this.nextChar()}else if(45===this._ch)this._allowNegatives?this.readNumberOrName():(this._sy=y.String,this._syData=this.readName());else if(46===this._ch)this._sy=y.Dot,this._ch=this.nextChar();else if(58===this._ch)this._sy=y.DoubleDot,this._ch=this.nextChar();else if(40===this._ch)this._sy=y.LParensis,this._ch=this.nextChar();else if(92===this._ch)this._ch=this.nextChar(),this._sy=y.MetaCommand,92===this._ch&&(this._ch=this.nextChar()),this._syData=this.readName();else if(41===this._ch)this._sy=y.RParensis,this._ch=this.nextChar();else if(123===this._ch)this._sy=y.LBrace,this._ch=this.nextChar();else if(125===this._ch)this._sy=y.RBrace,this._ch=this.nextChar();else if(124===this._ch)this._sy=y.Pipe,this._ch=this.nextChar();else if(42===this._ch)this._sy=y.Multiply,this._ch=this.nextChar();else if(60===this._ch)this._sy=y.LowerThan,this._ch=this.nextChar();else if(this.isDigit(this._ch))this.readNumberOrName();else if(r.isNameLetter(this._ch)){const e=this.readName(),s=this._allowTuning?O.parseTuning(e):null;s?(this._sy=y.Tuning,this._syData=s):(this._sy=y.String,this._syData=e)}else this.error("symbol",y.String,!1);return this._sy}readNumberOrName(){let e="",s=!0;do{e+=String.fromCharCode(this._ch),this.isDigit(this._ch)||(s=!1),this._ch=this.nextChar()}while(this.isDigit(this._ch)||r.isNameLetter(this._ch));s?(this._sy=y.Number,this._syData=this._allowFloat?Number.parseFloat(e):Number.parseInt(e)):(this._sy=y.String,this._syData=e)}static isNameLetter(e){return!r.isTerminal(e)&&(33<=e&&e<=47||58<=e&&e<=126||128<=e)}static isTerminal(e){return 46===e||123===e||125===e||91===e||93===e||40===e||41===e||124===e||39===e||34===e||42===e||92===e}static isWhiteSpace(e){return 9===e||10===e||11===e||13===e||32===e}isDigit(e){return e>=48&&e<=57||this._allowNegatives&&45===e||this._allowFloat&&46===e}readName(){let e="";do{e+=String.fromCharCode(this._ch),this._ch=this.nextChar()}while(r.isNameLetter(this._ch)||this.isDigit(this._ch));return e}metaData(){let e=!1,s=!1,i=!0;for(;this._sy===y.MetaCommand&&i;){const a=this._syData.toLowerCase();switch(a){case"title":case"subtitle":case"artist":case"album":case"words":case"music":case"copyright":case"instructions":case"notices":case"tab":this._sy=this.newSy(),this._sy!==y.String&&this.error(a,y.String,!0);const n=this._syData;this._sy=this.newSy(),e=!0;let o=H.ChordDiagramList;switch(a){case"title":this._score.title=n,o=H.Title;break;case"subtitle":this._score.subTitle=n,o=H.SubTitle;break;case"artist":this._score.artist=n,o=H.Artist;break;case"album":this._score.album=n,o=H.Album;break;case"words":this._score.words=n,o=H.Words;break;case"music":this._score.music=n,o=H.Music;break;case"copyright":this._score.copyright=n,o=H.Copyright;break;case"instructions":this._score.instructions=n;break;case"notices":this._score.notices=n;break;case"tab":this._score.tab=n,o=H.Transcriber}o!==H.ChordDiagramList&&this.headerFooterStyle(o);break;case"copyright2":this._sy=this.newSy(),this._sy!==y.String&&this.error(a,y.String,!0),this.headerFooterStyle(H.CopyrightSecondLine),e=!0;break;case"wordsandmusic":this._sy=this.newSy(),this._sy!==y.String&&this.error(a,y.String,!0),this.headerFooterStyle(H.WordsAndMusic),e=!0;break;case"tempo":this._allowFloat=!0,this._sy=this.newSy(),this._allowFloat=!1,this._sy===y.Number?this._score.tempo=this._syData:this.error("tempo",y.Number,!0),this._sy=this.newSy(),this._sy===y.String&&(this._score.tempoLabel=this._syData,this._sy=this.newSy()),e=!0;break;case"defaultsystemslayout":this._sy=this.newSy(),this._sy===y.Number?(this._score.defaultSystemsLayout=this._syData,this._sy=this.newSy(),e=!0):this.error("default-systems-layout",y.Number,!0);break;case"systemslayout":for(this._sy=this.newSy(),e=!0;this._sy===y.Number;)this._score.systemsLayout.push(this._syData),this._sy=this.newSy();break;case"hidedynamics":this._score.stylesheet.hideDynamics=!0,this._sy=this.newSy(),e=!0;break;case"showdynamics":this._score.stylesheet.hideDynamics=!1,this._sy=this.newSy(),e=!0;break;case"bracketextendmode":this._sy=this.newSy(),this._sy!==y.String&&this.error("bracketExtendMode",y.String,!0),this._score.stylesheet.bracketExtendMode=this.parseBracketExtendMode(this._syData),this._sy=this.newSy(),e=!0;break;case"usesystemsignseparator":this._score.stylesheet.useSystemSignSeparator=!0,this._sy=this.newSy(),e=!0;break;case"multibarrest":this._score.stylesheet.multiTrackMultiBarRest=!0,this._sy=this.newSy(),e=!0;break;case"singletracktracknamepolicy":this._sy=this.newSy(),this._sy!==y.String&&this.error("singleTrackTrackNamePolicy",y.String,!0),this._score.stylesheet.singleTrackTrackNamePolicy=this.parseTrackNamePolicy(this._syData),this._sy=this.newSy(),e=!0;break;case"multitracktracknamepolicy":this._sy=this.newSy(),this._sy!==y.String&&this.error("multiTrackTrackNamePolicy",y.String,!0),this._score.stylesheet.multiTrackTrackNamePolicy=this.parseTrackNamePolicy(this._syData),this._sy=this.newSy(),e=!0;break;case"firstsystemtracknamemode":this._sy=this.newSy(),this._sy!==y.String&&this.error("firstSystemTrackNameMode",y.String,!0),this._score.stylesheet.firstSystemTrackNameMode=this.parseTrackNameMode(this._syData),this._sy=this.newSy(),e=!0;break;case"othersystemstracknamemode":this._sy=this.newSy(),this._sy!==y.String&&this.error("otherSystemsTrackNameMode",y.String,!0),this._score.stylesheet.otherSystemsTrackNameMode=this.parseTrackNameMode(this._syData),this._sy=this.newSy(),e=!0;break;case"firstsystemtracknameorientation":this._sy=this.newSy(),this._sy!==y.String&&this.error("firstSystemTrackNameOrientation",y.String,!0),this._score.stylesheet.firstSystemTrackNameOrientation=this.parseTrackNameOrientation(this._syData),this._sy=this.newSy(),e=!0;break;case"othersystemstracknameorientation":this._sy=this.newSy(),this._sy!==y.String&&this.error("otherSystemsTrackNameOrientation",y.String,!0),this._score.stylesheet.otherSystemsTrackNameOrientation=this.parseTrackNameOrientation(this._syData),this._sy=this.newSy(),e=!0;break;default:switch(this.handleStaffMeta()){case bt.KnownStaffMeta:s=!0;break;case bt.UnknownStaffMeta:e||s?this.error("metaDataTags",y.String,!1):i=!1;break;case bt.EndOfMetaDetected:i=!1}}}return e?(this._sy!==y.Dot&&this.error("song",y.Dot,!0),this._sy=this.newSy()):this._sy===y.Dot&&(this._sy=this.newSy(),e=!0),e||s}headerFooterStyle(e){const s=O.getOrCreateHeaderFooterStyle(this._score,e);if(void 0===s.isVisible&&(s.isVisible=!0),this._sy===y.String){const i=this._syData;i?s.template=i:s.isVisible=!1,this._sy=this.newSy()}if(this._sy===y.String){switch(this._syData.toLowerCase()){case"left":s.textAlign=U.Left;break;case"center":s.textAlign=U.Center;break;case"right":s.textAlign=U.Right}this._sy=this.newSy()}}parseTrackNamePolicy(e){switch(e.toLowerCase()){case"hidden":return Oe.Hidden;case"allsystems":return Oe.AllSystems;default:return Oe.FirstSystem}}parseTrackNameMode(e){return"fullname"===e.toLowerCase()?nt.FullName:nt.ShortName}parseTrackNameOrientation(e){return"horizontal"===e.toLowerCase()?ot.Horizontal:ot.Vertical}handleStaffMeta(){switch(this._syData.toLowerCase()){case"capo":return this._sy=this.newSy(),this._sy===y.Number?this._currentStaff.capo=this._syData:this.error("capo",y.Number,!0),this._sy=this.newSy(),bt.KnownStaffMeta;case"tuning":this._sy=this.newSy();const e=this._currentStaff.tuning.length;switch(this._staffHasExplicitTuning=!0,this._staffTuningApplied=!1,this._sy){case y.String:const o=this._syData.toLowerCase();"piano"===o||"none"===o||"voice"===o?this.makeCurrentStaffPitched():this.error("tuning",y.Tuning,!0),this._sy=this.newSy();break;case y.Tuning:const h=[];do{h.push(this._syData.realValue),this._sy=this.newSy()}while(this._sy===y.Tuning);this._currentStaff.stringTuning.tunings=h;break;default:this.error("tuning",y.Tuning,!0)}return this._sy===y.String&&"hide"===this._syData.toLowerCase()&&(this._score.stylesheet.perTrackDisplayTuning||(this._score.stylesheet.perTrackDisplayTuning=new Map),this._score.stylesheet.perTrackDisplayTuning.set(this._currentTrack.index,!1),this._sy=this.newSy()),e!==this._currentStaff.tuning.length&&(this._currentStaff.chords?.size??0)>0&&this.errorMessage("Tuning must be defined before any chord"),bt.KnownStaffMeta;case"instrument":if(this._sy=this.newSy(),this._staffTuningApplied=!1,this._sy===y.Number){const o=this._syData;o>=0&&o<=127?this._currentTrack.playbackInfo.program=this._syData:this.error("instrument",y.Number,!1)}else if(this._sy===y.String){const o=this._syData.toLowerCase();if("percussion"===o){for(const h of this._currentTrack.staves)this.applyPercussionStaff(h);this._currentTrack.playbackInfo.primaryChannel=q.PercussionChannel,this._currentTrack.playbackInfo.secondaryChannel=q.PercussionChannel}else this._currentTrack.playbackInfo.program=Wt.getValue(o)}else this.error("instrument",y.Number,!0);return this._sy=this.newSy(),bt.KnownStaffMeta;case"lyrics":this._sy=this.newSy();const s=new Li;return s.startBar=0,s.text="",this._sy===y.Number&&(s.startBar=this._syData,this._sy=this.newSy()),this._sy===y.String?(s.text=this._syData,this._sy=this.newSy()):this.error("lyrics",y.String,!0),this._lyrics.get(this._currentTrack.index).push(s),bt.KnownStaffMeta;case"chord":this._sy=this.newSy();const i=new Os;this.chordProperties(i),this._sy===y.String?(i.name=this._syData,this._sy=this.newSy()):this.error("chord-name",y.String,!0);for(let o=0;o<this._currentStaff.tuning.length;o++)this._sy===y.Number?i.strings.push(this._syData):this._sy===y.String&&"x"===this._syData.toLowerCase()&&i.strings.push(-1),this._sy=this.newSy();return this._currentStaff.addChord(this.getChordId(this._currentStaff,i.name),i),bt.KnownStaffMeta;case"articulation":this._sy=this.newSy();let a="";if(this._sy===y.String?(a=this._syData,this._sy=this.newSy()):this.error("articulation-name",y.String,!0),"defaults"===a){for(const[o,h]of ht.instrumentArticulationNames)this._percussionArticulationNames.set(o.toLowerCase(),h),this._percussionArticulationNames.set(r.toArticulationId(o),h);return bt.KnownStaffMeta}let n=0;return this._sy===y.Number?(n=this._syData,this._sy=this.newSy()):this.error("articulation-number",y.Number,!0),ht.instrumentArticulations.has(n)||this.errorMessage(`Unknown articulation ${n}. Refer to https://www.alphatab.net/docs/alphatex/percussion for available ids`),this._percussionArticulationNames.set(a.toLowerCase(),n),bt.KnownStaffMeta;case"accidentals":return this.handleAccidentalMode(),bt.KnownStaffMeta;case"displaytranspose":return this._allowNegatives=!0,this._sy=this.newSy(),this._sy===y.Number?(this._currentStaff.displayTranspositionPitch=-1*this._syData,this._staffHasExplicitDisplayTransposition=!0):this.error("displaytranspose",y.Number,!0),this._allowNegatives=!1,this._sy=this.newSy(),bt.KnownStaffMeta;case"transpose":return this._allowNegatives=!0,this._sy=this.newSy(),this._sy===y.Number?this._currentStaff.transpositionPitch=-1*this._syData:this.error("transpose",y.Number,!0),this._allowNegatives=!1,this._sy=this.newSy(),bt.KnownStaffMeta;case"track":case"staff":return bt.EndOfMetaDetected;case"voice":return this._sy=this.newSy(),this.handleNewVoice()?bt.EndOfMetaDetected:bt.KnownStaffMeta;default:return bt.UnknownStaffMeta}}handleAccidentalMode(){switch(this._sy=this.newSy(),this._sy!==y.String&&this.error("accidental-mode",y.String,!0),this._syData){case"auto":this._accidentalMode=Qi.Auto;break;case"explicit":this._accidentalMode=Qi.Explicit}this._sy=this.newSy()}makeCurrentStaffPitched(){this._currentStaff.stringTuning.tunings=[],this._staffHasExplicitDisplayTransposition||(this._currentStaff.displayTranspositionPitch=0)}static toArticulationId(e){return e.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}applyPercussionStaff(e){e.isPercussion=!0,e.showTablature=!1}chordProperties(e){if(this._sy===y.LBrace){for(this._sy=this.newSy();this._sy===y.String;)switch(this._syData.toLowerCase()){case"firstfret":this._sy=this.newSy(),this._sy===y.Number?e.firstFret=this._syData:this.error("chord-firstfret",y.Number,!0),this._sy=this.newSy();break;case"showdiagram":switch(this._sy=this.newSy(),this._sy){case y.String:e.showDiagram="false"!==this._syData.toLowerCase();break;case y.Number:e.showDiagram=0!==this._syData;break;default:this.error("chord-showdiagram",y.String,!0)}this._sy=this.newSy();break;case"showfingering":switch(this._sy=this.newSy(),this._sy){case y.String:e.showDiagram="false"!==this._syData.toLowerCase();break;case y.Number:e.showFingering=0!==this._syData;break;default:this.error("chord-showfingering",y.String,!0)}this._sy=this.newSy();break;case"showname":switch(this._sy=this.newSy(),this._sy){case y.String:e.showName="false"!==this._syData.toLowerCase();break;case y.Number:e.showName=0!==this._syData;break;default:this.error("chord-showname",y.String,!0)}this._sy=this.newSy();break;case"barre":for(this._sy=this.newSy();this._sy===y.Number;)e.barreFrets.push(this._syData),this._sy=this.newSy();break;default:this.error("chord-properties",y.String,!1)}this._sy!==y.RBrace&&this.error("chord-properties",y.RBrace,!0),this._sy=this.newSy()}}bars(){const e=this.bar();for(;this._sy!==y.Eof;)if(this._sy===y.Pipe)this._sy=this.newSy(),this.bar();else{if(this._sy!==y.MetaCommand)break;this.bar()}return e}trackStaffMeta(){if(this._sy!==y.MetaCommand)return!1;if("track"===this._syData.toLowerCase()&&(this._staffHasExplicitDisplayTransposition=!1,this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._sy=this.newSy(),this._score.masterBars.length>0&&this.newTrack(),this._sy===y.String&&(this._currentTrack.name=this._syData,this._sy=this.newSy()),this._sy===y.String&&(this._currentTrack.shortName=this._syData,this._sy=this.newSy()),this.trackProperties()),this._sy===y.MetaCommand&&"staff"===this._syData.toLowerCase()){if(this._staffHasExplicitDisplayTransposition=!1,this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._sy=this.newSy(),this._currentTrack.staves[0].bars.length>0){const e=this._currentStaff.isPercussion;this._currentTrack.ensureStaveCount(this._currentTrack.staves.length+1),this.beginStaff(this._currentTrack.staves[this._currentTrack.staves.length-1]),e&&this.applyPercussionStaff(this._currentStaff),this._currentDynamics=J.F}this.staffProperties()}return this._sy===y.MetaCommand&&"voice"===this._syData.toLowerCase()&&(this._sy=this.newSy(),this.handleNewVoice()),!0}handleNewVoice(){if(0===this._voiceIndex&&(0===this._currentStaff.bars.length||1===this._currentStaff.bars.length&&this._currentStaff.bars[0].isEmpty))return!1;for(const e of this._currentStaff.bars){const s=new es;e.addVoice(s)}return this._voiceIndex++,this._barIndex=0,!0}beginStaff(e){this._currentStaff=e,this._slurs.clear(),this._barIndex=0,this._voiceIndex=0}trackProperties(){if(this._sy===y.LBrace){for(this._sy=this.newSy();this._sy===y.String;)switch(this._syData.toLowerCase()){case"color":this._sy=this.newSy(),this._sy!==y.String&&this.error("track-color",y.String,!0),this._currentTrack.color=Ee.fromJson(this._syData),this._sy=this.newSy();break;case"defaultsystemslayout":this._sy=this.newSy(),this._sy===y.Number?(this._currentTrack.defaultSystemsLayout=this._syData,this._sy=this.newSy()):this.error("default-systems-layout",y.Number,!0);break;case"systemslayout":for(this._sy=this.newSy();this._sy===y.Number;)this._currentTrack.systemsLayout.push(this._syData),this._sy=this.newSy();break;case"volume":this._sy=this.newSy(),this._sy!==y.Number&&this.error("track-volume",y.Number,!0),this._currentTrack.playbackInfo.volume=O.clamp(this._syData,0,16),this._sy=this.newSy();break;case"balance":this._sy=this.newSy(),this._sy!==y.Number&&this.error("track-balance",y.Number,!0),this._currentTrack.playbackInfo.balance=O.clamp(this._syData,0,16),this._sy=this.newSy();break;case"mute":this._sy=this.newSy(),this._currentTrack.playbackInfo.isMute=!0;break;case"solo":this._sy=this.newSy(),this._currentTrack.playbackInfo.isSolo=!0;break;case"multibarrest":this._sy=this.newSy(),this._score.stylesheet.perTrackMultiBarRest||(this._score.stylesheet.perTrackMultiBarRest=new Set),this._score.stylesheet.perTrackMultiBarRest.add(this._currentTrack.index);break;default:this.error("track-properties",y.String,!1)}this._sy!==y.RBrace&&this.error("track-properties",y.RBrace,!0),this._sy=this.newSy()}}staffProperties(){if(this._sy!==y.LBrace)return;this._sy=this.newSy();let e=!1,s=!1,i=!1,a=!1;for(;this._sy===y.String;)switch(this._syData.toLowerCase()){case"score":e=!0,this._sy=this.newSy(),this._sy===y.Number&&(this._currentStaff.standardNotationLineCount=this._syData,this._sy=this.newSy());break;case"tabs":s=!0,this._sy=this.newSy();break;case"slash":i=!0,this._sy=this.newSy();break;case"numbered":a=!0,this._sy=this.newSy();break;default:this.error("staff-properties",y.String,!1)}(e||s||i||a)&&(this._currentStaff.showStandardNotation=e,this._currentStaff.showTablature=s,this._currentStaff.showSlash=i,this._currentStaff.showNumbered=a),this._sy!==y.RBrace&&this.error("staff-properties",y.RBrace,!0),this._sy=this.newSy()}bar(){const e=this.trackStaffMeta(),s=this.newBar(this._currentStaff);if(this._currentStaff.bars.length>this._score.masterBars.length){const c=new Ps;this._score.addMasterBar(c),c.index>0&&(c.timeSignatureDenominator=c.previousMasterBar.timeSignatureDenominator,c.timeSignatureNumerator=c.previousMasterBar.timeSignatureNumerator,c.tripletFeel=c.previousMasterBar.tripletFeel)}const i=this.barMeta(s),a=this._currentTrack.playbackInfo.program;!this._staffTuningApplied&&!this._staffHasExplicitTuning&&(this._currentStaff.stringTuning.tunings=[],15===a||a>=24&&a<=31?this._currentStaff.stringTuning.tunings=F.getDefaultTuningFor(6).tunings:a>=32&&a<=39?this._currentStaff.stringTuning.tunings=[43,38,33,28]:40===a||44===a||45===a||48===a||49===a||50===a||51===a?this._currentStaff.stringTuning.tunings=[52,57,50,43]:41===a?this._currentStaff.stringTuning.tunings=[57,50,43,36]:42===a?this._currentStaff.stringTuning.tunings=[45,38,31,24]:43===a?this._currentStaff.stringTuning.tunings=[43,38,33,28]:105===a?this._currentStaff.stringTuning.tunings=[50,47,43,38,55]:106===a?this._currentStaff.stringTuning.tunings=[57,52,45]:107===a?this._currentStaff.stringTuning.tunings=[52,45,38,31]:110===a&&(this._currentStaff.stringTuning.tunings=[64,57,50,43]),this._staffTuningApplied=!0),this._staffHasExplicitDisplayTransposition||(this._currentStaff.displayTranspositionPitch=a>=24&&a<=31||a>=32&&a<=39||43===a?-12:0);let n=!1;const o=s.voices[this._voiceIndex];if(this._sy!==y.MetaCommand||"track"!==this._syData.toLowerCase()&&"staff"!==this._syData.toLowerCase())for(;this._sy!==y.Pipe&&this._sy!==y.Eof&&this.beat(o);)n=!0;if(0===o.beats.length){const c=new xt;c.isEmpty=!0,o.addBeat(c)}return e||i||n}newBar(e){if(this._barIndex<e.bars.length){const a=e.bars[this._barIndex];return this._barIndex++,a}const s=0===e.bars.length?1:e.bars[0].voices.length,i=new Ts;e.addBar(i),i.previousBar&&(i.clef=i.previousBar.clef,i.clefOttava=i.previousBar.clefOttava,i.keySignature=i.previousBar.keySignature,i.keySignatureType=i.previousBar.keySignatureType),this._barIndex++;for(let a=0;a<s;a++){const n=new es;i.addVoice(n)}return i}beat(e){this.beatDuration();const s=new xt;if(e.addBeat(s),this._allowTuning=!this._currentStaff.isPercussion,this._sy===y.LParensis){for(this._sy=this.newSy(),this.note(s);this._sy!==y.RParensis&&this._sy!==y.Eof&&(this._allowTuning=!this._currentStaff.isPercussion,this.note(s)););this._sy!==y.RParensis&&this.error("note-list",y.RParensis,!0),this._sy=this.newSy()}else if(this._sy===y.String&&"r"===this._syData.toLowerCase())this._sy=this.newSy();else if(!this.note(s))return e.beats.splice(e.beats.length-1,1),!1;this._sy===y.Dot&&(this._allowNegatives=!0,this._sy=this.newSy(),this._allowNegatives=!1,this._sy!==y.Number&&this.error("duration",y.Number,!0),this._currentDuration=this.parseDuration(this._syData),this._sy=this.newSy()),s.duration=this._currentDuration,s.dynamics=this._currentDynamics,1!==this._currentTuplet&&!s.hasTuplet&&r.applyTuplet(s,this._currentTuplet);let i=1;this._sy===y.Multiply&&(this._sy=this.newSy(),this._sy!==y.Number?this.error("multiplier",y.Number,!0):i=this._syData,this._sy=this.newSy()),this.beatEffects(s);for(let a=0;a<i-1;a++)e.addBeat(xa.clone(s));return!0}beatDuration(){if(this._sy===y.DoubleDot&&(this._allowNegatives=!0,this._sy=this.newSy(),this._allowNegatives=!1,this._sy!==y.Number&&this.error("duration",y.Number,!0),this._currentDuration=this.parseDuration(this._syData),this._currentTuplet=1,this._sy=this.newSy(),this._sy===y.LBrace)){for(this._sy=this.newSy();this._sy===y.String;)"tu"===this._syData.toLowerCase()?(this._sy=this.newSy(),this._sy!==y.Number&&this.error("duration-tuplet",y.Number,!0),this._currentTuplet=this._syData,this._sy=this.newSy()):this.error("beat-duration",y.String,!1);this._sy!==y.RBrace&&this.error("beat-duration",y.RBrace,!0),this._sy=this.newSy()}}beatEffects(e){if(this._sy===y.LBrace){for(this._sy=this.newSy();this._sy===y.String;)this.applyBeatEffect(e)||this.error("beat-effects",y.String,!1);this._sy!==y.RBrace&&this.error("beat-effects",y.RBrace,!0),this._sy=this.newSy()}}applyBeatEffect(e){const s=this._syData.toLowerCase();if("f"===s)e.fade=ct.FadeIn;else if("fo"===s)e.fade=ct.FadeOut;else if("vs"===s)e.fade=ct.VolumeSwell;else if("v"===s)e.vibrato=ke.Slight;else if("vw"===s)e.vibrato=ke.Wide;else if("s"===s)e.slap=!0;else if("p"===s)e.pop=!0;else if("tt"===s)e.tap=!0;else if("txt"===s){if(this._sy=this.newSy(),this._sy!==y.String)return this.error("beat-text",y.String,!0),!1;e.text=this._syData}else if("dd"===s)e.dots=2;else if("d"===s)e.dots=1;else if("su"===s)e.pickStroke=yt.Up;else if("sd"===s)e.pickStroke=yt.Down;else{if("tu"===s){if(this._sy=this.newSy(),this._sy!==y.Number)return this.error("tuplet",y.Number,!0),!1;const i=this._syData;if(this._sy=this.newSy(),this._sy===y.Number){const a=this._syData;this._sy=this.newSy(),e.tupletNumerator=i,e.tupletDenominator=a}else r.applyTuplet(e,i);return!0}if("tb"===s||"tbe"===s){this._sy=this.newSy();const i="tbe"===s;for(this._sy===y.String&&(e.whammyBarType=this.parseWhammyType(this._syData),this._sy=this.newSy()),this._sy===y.String&&(e.whammyStyle=this.parseBendStyle(this._syData),this._sy=this.newSy()),this._sy!==y.LParensis&&this.error("tremolobar-effect",y.LParensis,!0),this._allowNegatives=!0,this._allowFloat=!0,this._sy=this.newSy();this._sy!==y.RParensis&&this._sy!==y.Eof;){let a=0,n=0;i?(this._sy!==y.Number&&this.error("tremolobar-effect",y.Number,!0),a=this._syData,this._sy=this.newSy(),this._sy!==y.Number&&this.error("tremolobar-effect",y.Number,!0),n=this._syData):(this._sy!==y.Number&&this.error("tremolobar-effect",y.Number,!0),a=0,n=this._syData),e.addWhammyBarPoint(new R(a,n)),this._sy=this.newSy()}if(null!=e.whammyBarPoints){for(;e.whammyBarPoints.length>60;)e.removeWhammyBarPoint(e.whammyBarPoints.length-1);if(i)e.whammyBarPoints.sort((a,n)=>a.offset-n.offset);else{const a=e.whammyBarPoints.length,n=60/a|0;let o=0;for(;o<a;)e.whammyBarPoints[o].offset=Math.min(60,o*n),o++}}this._allowNegatives=!1,this._allowFloat=!1,this._sy!==y.RParensis&&this.error("tremolobar-effect",y.RParensis,!0)}else{if("bu"===s||"bd"===s||"au"===s||"ad"===s){switch(s){case"bu":e.brushType=V.BrushUp;break;case"bd":e.brushType=V.BrushDown;break;case"au":e.brushType=V.ArpeggioUp;break;case"ad":e.brushType=V.ArpeggioDown}return this._sy=this.newSy(),this._sy===y.Number?(e.brushDuration=this._syData,this._sy=this.newSy(),!0):(e.updateDurations(),"bu"===s||"bd"===s?e.brushDuration=e.playbackDuration/4/e.notes.length:("au"===s||"ad"===s)&&(e.brushDuration=e.playbackDuration/e.notes.length),!0)}if("ch"===s){this._sy=this.newSy();const i=this._syData,a=this.getChordId(this._currentStaff,i);if(!this._currentStaff.hasChord(a)){const n=new Os;n.showDiagram=!1,n.name=i,this._currentStaff.addChord(a,n)}e.chordId=a}else{if("gr"===s)return this._sy=this.newSy(),"ob"===this._syData.toLowerCase()?(e.graceType=K.OnBeat,this._sy=this.newSy()):"b"===this._syData.toLowerCase()?(e.graceType=K.BendGrace,this._sy=this.newSy()):e.graceType=K.BeforeBeat,!0;if("dy"===s){this._sy=this.newSy();const i=this._syData.toUpperCase();switch(i){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":e.dynamics=J[i]}this._currentDynamics=e.dynamics}else if("cre"===s)e.crescendo=Ft.Crescendo;else if("dec"===s)e.crescendo=Ft.Decrescendo;else{if("tempo"===s){const i=this.readTempoAutomation();return e.automations.push(i),e.voice.bar.masterBar.tempoAutomations.push(i),!0}if("tp"===s){if(this._sy=this.newSy(),e.tremoloSpeed=m.Eighth,this._sy===y.Number){switch(this._syData){case 8:default:e.tremoloSpeed=m.Eighth;break;case 16:e.tremoloSpeed=m.Sixteenth;break;case 32:e.tremoloSpeed=m.ThirtySecond}this._sy=this.newSy()}return!0}if("spd"===s){const i=new Ks;return i.pedalType=rt.Down,i.ratioPosition=e.voice.bar.sustainPedals.length,this._sustainPedalToBeat.set(i,e),e.voice.bar.sustainPedals.push(i),this._sy=this.newSy(),!0}if("spu"===s){const i=new Ks;return i.pedalType=rt.Up,i.ratioPosition=e.voice.bar.sustainPedals.length,this._sustainPedalToBeat.set(i,e),e.voice.bar.sustainPedals.push(i),this._sy=this.newSy(),!0}if("spe"===s){const i=new Ks;return i.pedalType=rt.Up,i.ratioPosition=1,e.voice.bar.sustainPedals.push(i),this._sy=this.newSy(),!0}if("slashed"===s)return e.slashed=!0,this._sy=this.newSy(),!0;if("ds"===s)return e.deadSlapped=!0,this._sy=this.newSy(),!0;if("glpf"===s)return this._sy=this.newSy(),e.golpe=Gt.Finger,!0;if("glpt"===s)return this._sy=this.newSy(),e.golpe=Gt.Thumb,!0;if("waho"===s)return this._sy=this.newSy(),e.wahPedal=Jt.Open,!0;if("wahc"===s)return this._sy=this.newSy(),e.wahPedal=Jt.Closed,!0;if("barre"===s){if(this._sy=this.newSy(),this._sy!==y.Number&&this.error("beat-barre",y.Number,!0),e.barreFret=this._syData,e.barreShape=qt.Full,this._sy=this.newSy(),this._sy===y.String)switch(this._syData.toLowerCase()){case"full":e.barreShape=qt.Full,this._sy=this.newSy();break;case"half":e.barreShape=qt.Half,this._sy=this.newSy()}return!0}if("rasg"===s){switch(this._sy=this.newSy(),this._sy!==y.String&&this.error("rasgueado",y.String,!0),this._syData.toLowerCase()){case"ii":e.rasgueado=G.Ii;break;case"mi":e.rasgueado=G.Mi;break;case"miitriplet":e.rasgueado=G.MiiTriplet;break;case"miianapaest":e.rasgueado=G.MiiAnapaest;break;case"pmptriplet":e.rasgueado=G.PmpTriplet;break;case"pmpanapaest":e.rasgueado=G.PmpAnapaest;break;case"peitriplet":e.rasgueado=G.PeiTriplet;break;case"peianapaest":e.rasgueado=G.PeiAnapaest;break;case"paitriplet":e.rasgueado=G.PaiTriplet;break;case"paianapaest":e.rasgueado=G.PaiAnapaest;break;case"amitriplet":e.rasgueado=G.AmiTriplet;break;case"amianapaest":e.rasgueado=G.AmiAnapaest;break;case"ppp":e.rasgueado=G.Ppp;break;case"amii":e.rasgueado=G.Amii;break;case"amip":e.rasgueado=G.Amip;break;case"eami":e.rasgueado=G.Eami;break;case"eamii":e.rasgueado=G.Eamii;break;case"peami":e.rasgueado=G.Peami}return this._sy=this.newSy(),!0}if("ot"===s)this._sy=this.newSy(),this._sy!==y.String&&this.error("beat-ottava",y.String,!0),e.ottava=this.parseClefOttavaFromString(this._syData);else if("legatoorigin"===s)e.isLegatoOrigin=!0;else{if("instrument"!==s){if("fermata"===s){this._sy=this.newSy(),this._sy!==y.String&&this.error("fermata",y.Number,!0);const i=new Ei;return i.type=this.parseFermataFromString(this._syData),this._allowFloat=!0,this._sy=this.newSy(),this._sy===y.Number&&(i.length=this._syData,this._sy=this.newSy()),this._allowFloat=!1,e.fermata=i,!0}if("beam"===s){switch(this._sy=this.newSy(),this._sy!==y.String&&this.error("beam",y.Number,!0),this._syData.toLowerCase()){case"invert":e.invertBeamDirection=!0;break;case"up":e.preferredBeamDirection=P.Up;break;case"down":e.preferredBeamDirection=P.Down;break;case"auto":e.beamingMode=ze.Auto;break;case"split":e.beamingMode=ze.ForceSplitToNext;break;case"merge":e.beamingMode=ze.ForceMergeWithNext;break;case"splitsecondary":e.beamingMode=ze.ForceSplitOnSecondaryToNext}return this._sy=this.newSy(),!0}return"timer"===s&&(e.showTimer=!0,this._sy=this.newSy(),!0)}{this._sy=this.newSy();let i=0;this._sy===y.Number?i=this._syData:this._sy===y.String?i=Wt.getValue(this._syData):this.error("instrument-change",y.Number,!0);const a=new Qe;a.isLinear=!1,a.type=Ge.Instrument,a.value=i,e.automations.push(a)}}}}}}return this._sy=this.newSy(),!0}parseBracketExtendMode(e){switch(e.toLowerCase()){case"nobrackets":return Vt.NoBrackets;case"groupstaves":default:return Vt.GroupStaves;case"groupsimilarinstruments":return Vt.GroupSimilarInstruments}}parseFermataFromString(e){switch(e.toLowerCase()){case"short":return Ct.Short;case"medium":default:return Ct.Medium;case"long":return Ct.Long}}parseClefOttavaFromString(e){switch(e.toLowerCase()){case"15ma":return le._15ma;case"8va":return le._8va;case"regular":default:return le.Regular;case"8vb":return le._8vb;case"15mb":return le._15mb}}getChordId(e,s){return s.toLowerCase()+e.index+e.track.index}static applyTuplet(e,s){switch(s){case 3:e.tupletNumerator=3,e.tupletDenominator=2;break;case 5:e.tupletNumerator=5,e.tupletDenominator=4;break;case 6:e.tupletNumerator=6,e.tupletDenominator=4;break;case 7:e.tupletNumerator=7,e.tupletDenominator=4;break;case 9:e.tupletNumerator=9,e.tupletDenominator=8;break;case 10:e.tupletNumerator=10,e.tupletDenominator=8;break;case 11:e.tupletNumerator=11,e.tupletDenominator=8;break;case 12:e.tupletNumerator=12,e.tupletDenominator=8;break;default:e.tupletNumerator=1,e.tupletDenominator=1}}isNoteText(e){return"x"===e||"-"===e||"r"===e}note(e){let s=!1,i=!1,a=-1,n=-1,o=-1,h=ge.Default;switch(this._sy){case y.Number:a=this._syData,this._currentStaff.isPercussion&&!ht.instrumentArticulations.has(a)&&this.errorMessage(`Unknown percussion articulation ${a}`);break;case y.String:if(this._currentStaff.isPercussion){const p=this._syData.toLowerCase();this._percussionArticulationNames.has(p)?a=this._percussionArticulationNames.get(p):this.errorMessage(`Unknown percussion articulation '${this._syData}'`)}else s="x"===this._syData,i="-"===this._syData,i||s?a=0:this.error("note-fret",y.Number,!0);break;case y.Tuning:0===e.index&&0===e.voice.index&&0===e.voice.bar.index&&this.makeCurrentStaffPitched();const f=this._syData;n=f.octave,o=f.tone.noteValue,this._accidentalMode===Qi.Explicit&&(h=f.tone.accidentalMode);break;default:return!1}this._sy=this.newSy();const c=-1===n&&this._currentStaff.tuning.length>0&&!this._currentStaff.isPercussion;let d=-1;c&&(this._sy!==y.Dot&&this.error("note",y.Dot,!0),this._sy=this.newSy(),this._sy!==y.Number&&this.error("note-string",y.Number,!0),d=this._syData,(d<1||d>this._currentStaff.tuning.length)&&this.error("note-string",y.Number,!1),this._sy=this.newSy());const u=new ts;if(c)u.string=this._currentStaff.tuning.length-(d-1),u.isDead=s,u.isTieDestination=i,i||(u.fret=a);else if(this._currentStaff.isPercussion){const f=a;let p=0;if(this._articulationValueToIndex.has(f))p=this._articulationValueToIndex.get(f);else{p=this._currentTrack.percussionArticulations.length;const g=ht.getArticulationByInputMidiNumber(f);null===g&&this.errorMessage(`Unknown articulation value ${f}`),this._currentTrack.percussionArticulations.push(g),this._articulationValueToIndex.set(f,p)}u.percussionArticulation=p}else u.octave=n,u.tone=o,u.accidentalMode=h,u.isTieDestination=i;return e.addNote(u),this.noteEffects(u),!0}noteEffects(e){if(this._sy===y.LBrace){for(this._sy=this.newSy();this._sy===y.String;){const s=this._syData.toLowerCase();if("b"===s||"be"===s){this._sy=this.newSy();const i="be"===s;for(this._sy===y.String&&(e.bendType=this.parseBendType(this._syData),this._sy=this.newSy()),this._sy===y.String&&(e.bendStyle=this.parseBendStyle(this._syData),this._sy=this.newSy()),this._sy!==y.LParensis&&this.error("bend-effect",y.LParensis,!0),this._sy=this.newSy();this._sy!==y.RParensis&&this._sy!==y.Eof;){let n=0,o=0;i?(this._sy!==y.Number&&this.error("bend-effect-value",y.Number,!0),n=this._syData,this._sy=this.newSy(),this._sy!==y.Number&&this.error("bend-effect-value",y.Number,!0),o=this._syData):(this._sy!==y.Number&&this.error("bend-effect-value",y.Number,!0),o=this._syData),e.addBendPoint(new R(n,o)),this._sy=this.newSy()}const a=e.bendPoints;if(null!=a){for(;a.length>60;)a.splice(a.length-1,1);if(i)a.sort((n,o)=>n.offset-o.offset);else{const n=a.length,o=60/(n-1)|0;let h=0;for(;h<n;)a[h].offset=Math.min(60,h*o),h++}}this._sy!==y.RParensis&&this.error("bend-effect",y.RParensis,!0),this._sy=this.newSy()}else if("nh"===s)e.harmonicType=Z.Natural,e.harmonicValue=O.deltaFretToHarmonicValue(e.fret),this._sy=this.newSy();else if("ah"===s)e.harmonicType=Z.Artificial,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("th"===s)e.harmonicType=Z.Tap,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("ph"===s)e.harmonicType=Z.Pinch,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("sh"===s)e.harmonicType=Z.Semi,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("fh"===s)e.harmonicType=Z.Feedback,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("tr"===s){this._sy=this.newSy(),this._sy!==y.Number&&this.error("trill-effect",y.Number,!0);const i=this._syData;this._sy=this.newSy();let a=m.Sixteenth;if(this._sy===y.Number){switch(this._syData){case 16:default:a=m.Sixteenth;break;case 32:a=m.ThirtySecond;break;case 64:a=m.SixtyFourth}this._sy=this.newSy()}e.trillValue=i+e.stringTuning,e.trillSpeed=a}else if("v"===s)this._sy=this.newSy(),e.vibrato=ke.Slight;else if("sl"===s)this._sy=this.newSy(),e.slideOutType=ce.Legato;else if("ss"===s)this._sy=this.newSy(),e.slideOutType=ce.Shift;else if("sib"===s)this._sy=this.newSy(),e.slideInType=ut.IntoFromBelow;else if("sia"===s)this._sy=this.newSy(),e.slideInType=ut.IntoFromAbove;else if("sou"===s)this._sy=this.newSy(),e.slideOutType=ce.OutUp;else if("sod"===s)this._sy=this.newSy(),e.slideOutType=ce.OutDown;else if("psd"===s)this._sy=this.newSy(),e.slideOutType=ce.PickSlideDown;else if("psu"===s)this._sy=this.newSy(),e.slideOutType=ce.PickSlideUp;else if("h"===s)this._sy=this.newSy(),e.isHammerPullOrigin=!0;else if("lht"===s)this._sy=this.newSy(),e.isLeftHandTapped=!0;else if("g"===s)this._sy=this.newSy(),e.isGhost=!0;else if("ac"===s)this._sy=this.newSy(),e.accentuated=et.Normal;else if("hac"===s)this._sy=this.newSy(),e.accentuated=et.Heavy;else if("ten"===s)this._sy=this.newSy(),e.accentuated=et.Tenuto;else if("pm"===s)this._sy=this.newSy(),e.isPalmMute=!0;else if("st"===s)this._sy=this.newSy(),e.isStaccato=!0;else if("lr"===s)this._sy=this.newSy(),e.isLetRing=!0;else if("x"===s)this._sy=this.newSy(),e.fret=0,e.isDead=!0;else if("-"===s||"t"===s)this._sy=this.newSy(),e.isTieDestination=!0;else if("lf"===s){this._sy=this.newSy();let i=Q.Thumb;this._sy===y.Number&&(i=this.toFinger(this._syData),this._sy=this.newSy()),e.leftHandFinger=i}else if("rf"===s){this._sy=this.newSy();let i=Q.Thumb;this._sy===y.Number&&(i=this.toFinger(this._syData),this._sy=this.newSy()),e.rightHandFinger=i}else if("acc"===s)this._sy=this.newSy(),this._sy!==y.String&&this.error("note-accidental",y.String,!0),e.accidentalMode=O.parseAccidentalMode(this._syData),this._sy=this.newSy();else if("turn"===s)this._sy=this.newSy(),e.ornament=tt.Turn;else if("iturn"===s)this._sy=this.newSy(),e.ornament=tt.InvertedTurn;else if("umordent"===s)this._sy=this.newSy(),e.ornament=tt.UpperMordent;else if("lmordent"===s)this._sy=this.newSy(),e.ornament=tt.LowerMordent;else if("string"===s)this._sy=this.newSy(),e.showStringNumber=!0;else if("hide"===s)this._sy=this.newSy(),e.isVisible=!1;else if("slur"===s){this._sy=this.newSy(),this._sy!==y.String&&this.error("slur",y.String,!0);const i=this._syData;if(this._slurs.has(i)){const a=this._slurs.get(i);a.slurDestination=e,e.slurOrigin=a,e.isSlurDestination=!0}else this._slurs.set(i,e);this._sy=this.newSy()}else this.applyBeatEffect(e.beat)||this.error(s,y.String,!1)}this._sy!==y.RBrace&&this.error("note-effect",y.RBrace,!1),this._sy=this.newSy()}}harmonicValue(e){return this._allowNegatives=!0,this._allowFloat=!0,this._sy=this.newSy(),this._sy===y.Number&&(e=this._syData,this._sy=this.newSy()),this._allowNegatives=!1,this._allowFloat=!1,e}toFinger(e){switch(e){case 1:return Q.Thumb;case 2:return Q.IndexFinger;case 3:return Q.MiddleFinger;case 4:return Q.AnnularFinger;case 5:return Q.LittleFinger}return Q.Thumb}parseDuration(e){switch(e){case-4:return m.QuadrupleWhole;case-2:return m.DoubleWhole;case 1:return m.Whole;case 2:return m.Half;case 4:return m.Quarter;case 8:return m.Eighth;case 16:return m.Sixteenth;case 32:return m.ThirtySecond;case 64:return m.SixtyFourth;case 128:return m.OneHundredTwentyEighth;case 256:return m.TwoHundredFiftySixth;default:return m.Quarter}}parseBendStyle(e){switch(e.toLowerCase()){case"gradual":return Ie.Gradual;case"fast":return Ie.Fast;default:return Ie.Default}}parseBendType(e){switch(e.toLowerCase()){case"none":return z.None;case"custom":default:return z.Custom;case"bend":return z.Bend;case"release":return z.Release;case"bendrelease":return z.BendRelease;case"hold":return z.Hold;case"prebend":return z.Prebend;case"prebendbend":return z.PrebendBend;case"prebendrelease":return z.PrebendRelease}}barMeta(e){let s=!1;const i=e.masterBar;let a=!1;for(;!a&&this._sy===y.MetaCommand;){s=!0;const n=this._syData.toLowerCase();if("ts"===n)this._sy=this.newSy(),this._sy===y.String?"common"===this._syData.toLowerCase()?(i.timeSignatureCommon=!0,i.timeSignatureNumerator=4,i.timeSignatureDenominator=4,this._sy=this.newSy()):this.error("timesignature-numerator",y.String,!0):(this._sy!==y.Number&&this.error("timesignature-numerator",y.Number,!0),i.timeSignatureNumerator=this._syData,this._sy=this.newSy(),this._sy!==y.Number&&this.error("timesignature-denominator",y.Number,!0),i.timeSignatureDenominator=this._syData,this._sy=this.newSy());else if("ft"===n)i.isFreeTime=!0,this._sy=this.newSy();else if("ro"===n)i.isRepeatStart=!0,this._sy=this.newSy();else if("rc"===n)this._sy=this.newSy(),this._sy!==y.Number&&this.error("repeatclose",y.Number,!0),this._syData>2048&&this.error("repeatclose",y.Number,!1),i.repeatCount=this._syData,this._sy=this.newSy();else if("ae"===n)if(this._sy=this.newSy(),this._sy===y.LParensis){for(this._sy=this.newSy(),this._sy!==y.Number&&this.error("alternateending",y.Number,!0),this.applyAlternateEnding(i);this._sy===y.Number;)this.applyAlternateEnding(i);this._sy!==y.RParensis&&this.error("alternateending-list",y.RParensis,!0),this._sy=this.newSy()}else this._sy!==y.Number&&this.error("alternateending",y.Number,!0),this.applyAlternateEnding(i);else if("ks"===n)this._sy=this.newSy(),this._sy!==y.String&&this.error("keysignature",y.String,!0),e.keySignature=this.parseKeySignature(this._syData),e.keySignatureType=this.parseKeySignatureType(this._syData),this._sy=this.newSy();else if("clef"===n){switch(this._sy=this.newSy(),this._sy){case y.String:e.clef=this.parseClefFromString(this._syData);break;case y.Number:e.clef=this.parseClefFromInt(this._syData);break;case y.Tuning:e.clef=this.parseClefFromInt(this._syData.realValue);break;default:this.error("clef",y.String,!0)}this._sy=this.newSy()}else if("tempo"===n){const o=this.readTempoAutomation();i.tempoAutomations.push(o)}else if("section"===n){this._sy=this.newSy(),this._sy!==y.String&&this.error("section",y.String,!0);let o=this._syData;this._sy=this.newSy();let h="";this._sy===y.String&&!this.isNoteText(this._syData.toLowerCase())&&(h=o,o=this._syData,this._sy=this.newSy());const c=new Fi;c.marker=h,c.text=o,i.section=c}else if("tf"===n){switch(this._allowTuning=!1,this._sy=this.newSy(),this._allowTuning=!0,this._sy){case y.String:i.tripletFeel=this.parseTripletFeelFromString(this._syData);break;case y.Number:i.tripletFeel=this.parseTripletFeelFromInt(this._syData);break;default:this.error("triplet-feel",y.String,!0)}this._sy=this.newSy()}else if("ac"===n)i.isAnacrusis=!0,this._sy=this.newSy();else if("db"===n)i.isDoubleBar=!0,e.barLineRight=te.LightLight,this._sy=this.newSy();else if("barlineleft"===n)this._sy=this.newSy(),this._sy!==y.String&&this.error("barlineleft",y.String,!0),e.barLineLeft=this.parseBarLineStyle(this._syData),this._sy=this.newSy();else if("barlineright"===n)this._sy=this.newSy(),this._sy!==y.String&&this.error("barlineright",y.String,!0),e.barLineRight=this.parseBarLineStyle(this._syData),this._sy=this.newSy();else if("accidentals"===n)this.handleAccidentalMode();else if("jump"===n)this.handleDirections(i);else if("ottava"===n)this._sy=this.newSy(),this._sy!==y.String&&this.error("ottava",y.String,!0),e.clefOttava=this.parseClefOttavaFromString(this._syData),this._sy=this.newSy();else if("simile"===n)this._sy=this.newSy(),this._sy!==y.String&&this.error("simile",y.String,!0),e.simileMark=this.parseSimileMarkFromString(this._syData),this._sy=this.newSy();else if("scale"===n)this._allowFloat=!0,this._sy=this.newSy(),this._allowFloat=!1,this._sy!==y.Number&&this.error("scale",y.Number,!0),i.displayScale=this._syData,e.displayScale=this._syData,this._sy=this.newSy();else if("width"===n)this._sy=this.newSy(),this._sy!==y.Number&&this.error("width",y.Number,!0),i.displayWidth=this._syData,e.displayWidth=this._syData,this._sy=this.newSy();else if(0===e.index)switch(this.handleStaffMeta()){case bt.KnownStaffMeta:break;case bt.UnknownStaffMeta:this.error("measure-effects",y.String,!1);break;case bt.EndOfMetaDetected:a=!0}else this.handleStaffMeta()===bt.EndOfMetaDetected?a=!0:this.error("measure-effects",y.String,!1)}if(0===i.index&&0===i.tempoAutomations.length){const n=new Qe;n.isLinear=!1,n.type=Ge.Tempo,n.value=this._score.tempo,n.text=this._score.tempoLabel,i.tempoAutomations.push(n)}return s}parseBarLineStyle(e){switch(e.toLowerCase()){case"automatic":return te.Automatic;case"dashed":return te.Dashed;case"dotted":return te.Dotted;case"heavy":return te.Heavy;case"heavyheavy":return te.HeavyHeavy;case"heavylight":return te.HeavyLight;case"lightheavy":return te.LightHeavy;case"lightlight":return te.LightLight;case"none":return te.None;case"regular":return te.Regular;case"short":return te.Short;case"tick":return te.Tick}return te.Automatic}parseSimileMarkFromString(e){switch(e.toLowerCase()){case"none":default:return je.None;case"simple":return je.Simple;case"firstofdouble":return je.FirstOfDouble;case"secondofdouble":return je.SecondOfDouble}}handleDirections(e){switch(this._sy=this.newSy(),this._sy!==y.String&&this.error("direction",y.String,!0),this._syData.toLowerCase()){case"fine":e.addDirection(I.TargetFine);break;case"segno":e.addDirection(I.TargetSegno);break;case"segnosegno":e.addDirection(I.TargetSegnoSegno);break;case"coda":e.addDirection(I.TargetCoda);break;case"doublecoda":e.addDirection(I.TargetDoubleCoda);break;case"dacapo":e.addDirection(I.JumpDaCapo);break;case"dacapoalcoda":e.addDirection(I.JumpDaCapoAlCoda);break;case"dacapoaldoublecoda":e.addDirection(I.JumpDaCapoAlDoubleCoda);break;case"dacapoalfine":e.addDirection(I.JumpDaCapoAlFine);break;case"dalsegno":e.addDirection(I.JumpDalSegno);break;case"dalsegnoalcoda":e.addDirection(I.JumpDalSegnoAlCoda);break;case"dalsegnoaldoublecoda":e.addDirection(I.JumpDalSegnoAlDoubleCoda);break;case"dalsegnoalfine":e.addDirection(I.JumpDalSegnoAlFine);break;case"dalsegnosegno":e.addDirection(I.JumpDalSegnoSegno);break;case"dalsegnosegnoalcoda":e.addDirection(I.JumpDalSegnoSegnoAlCoda);break;case"dalsegnosegnoaldoublecoda":e.addDirection(I.JumpDalSegnoSegnoAlDoubleCoda);break;case"dalsegnosegnoalfine":e.addDirection(I.JumpDalSegnoSegnoAlFine);break;case"dacoda":e.addDirection(I.JumpDaCoda);break;case"dadoublecoda":e.addDirection(I.JumpDaDoubleCoda);break;default:return void this.errorMessage(`Unexpected direction value: '${this._syData}'`)}this._sy=this.newSy()}readTempoAutomation(){this._allowFloat=!0,this._sy=this.newSy(),this._allowFloat=!1,this._sy!==y.Number&&this.error("tempo",y.Number,!0);const e=new Qe;return e.isLinear=!1,e.type=Ge.Tempo,e.value=this._syData,this._sy=this.newSy(),this._sy===y.String&&(e.text=this._syData,this._sy=this.newSy()),e}applyAlternateEnding(e){const s=this._syData;s<1&&this.error("alternateending",y.Number,!0),e.alternateEndings|=1<<s-1,this._sy=this.newSy()}parseWhammyType(e){switch(e.toLowerCase()){case"none":return _e.None;case"custom":default:return _e.Custom;case"dive":return _e.Dive;case"dip":return _e.Dip;case"hold":return _e.Hold;case"predive":return _e.Predive;case"predivedive":return _e.PrediveDive}}}return r.Eof=0,r})(),gh=(()=>{class r extends pi{constructor(){super(...arguments),this._versionNumber=0,this._globalTripletFeel=ue.NoTripletFeel,this._lyricsTrack=0,this._lyrics=[],this._barCount=0,this._trackCount=0,this._playbackInfos=[],this._doubleBars=new Set,this._keySignatures=new Map,this._beatTextChunksByTrack=new Map,this._directionLookup=new Map}get name(){return"Guitar Pro 3-5"}readScore(){if(this._directionLookup.clear(),this.readVersion(),this._score=new Cs,this.readScoreInformation(),this._versionNumber<500&&(this._globalTripletFeel=Te.gpReadBool(this.data)?ue.Triplet8th:ue.NoTripletFeel),this._versionNumber>=400&&this.readLyrics(),this._versionNumber>=510&&this.data.skip(19),this._versionNumber>=500&&(this.readPageSetup(),this._score.tempoLabel=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this._score.tempo=k.readInt32LE(this.data),this._versionNumber>=510&&Te.gpReadBool(this.data),k.readInt32LE(this.data),this._versionNumber>=400&&this.data.readByte(),this.readPlaybackInfos(),this._versionNumber>=500&&(this.readDirection(I.TargetCoda),this.readDirection(I.TargetDoubleCoda),this.readDirection(I.TargetSegno),this.readDirection(I.TargetSegnoSegno),this.readDirection(I.TargetFine),this.readDirection(I.JumpDaCapo),this.readDirection(I.JumpDaCapoAlCoda),this.readDirection(I.JumpDaCapoAlDoubleCoda),this.readDirection(I.JumpDaCapoAlFine),this.readDirection(I.JumpDalSegno),this.readDirection(I.JumpDalSegnoAlCoda),this.readDirection(I.JumpDalSegnoAlDoubleCoda),this.readDirection(I.JumpDalSegnoAlFine),this.readDirection(I.JumpDalSegnoSegno),this.readDirection(I.JumpDalSegnoSegnoAlCoda),this.readDirection(I.JumpDalSegnoSegnoAlDoubleCoda),this.readDirection(I.JumpDalSegnoSegnoAlFine),this.readDirection(I.JumpDaCoda),this.readDirection(I.JumpDaDoubleCoda),this.data.skip(4)),this._barCount=k.readInt32LE(this.data),this._trackCount=k.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),this._score.masterBars.length>0){const e=Qe.buildTempoAutomation(!1,0,this._score.tempo,2);e.text=this._score.tempoLabel,this._score.masterBars[0].tempoAutomations.push(e)}return O.consolidate(this._score),this._score.finish(this.settings),this._lyrics&&this._lyricsTrack>=0&&this._score.tracks[this._lyricsTrack].applyLyrics(this._lyrics),this._score}readDirection(e){let i,s=k.readInt16LE(this.data);-1!==s&&(s--,this._directionLookup.has(s)?i=this._directionLookup.get(s):(i=[],this._directionLookup.set(s,i)),i.push(e))}readVersion(){let e=Te.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!e.startsWith(r.VersionString))throw new st("Unsupported format");e=e.substr(r.VersionString.length+1);const s=e.indexOf(".");this._versionNumber=100*Number.parseInt(e.substr(0,s))+Number.parseInt(e.substr(s+1)),x.debug(this.name,`Guitar Pro version ${e} detected`)}readScoreInformation(){this._score.title=Te.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.subTitle=Te.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.artist=Te.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.album=Te.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.words=Te.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.music=this._versionNumber>=500?Te.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this._score.words,this._score.copyright=Te.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.tab=Te.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.instructions=Te.gpReadStringIntUnused(this.data,this.settings.importer.encoding);const e=k.readInt32LE(this.data);let s="";for(let i=0;i<e;i++)i>0&&(s+="\r\n"),s+=Te.gpReadStringIntUnused(this.data,this.settings.importer.encoding)?.toString();this._score.notices=s}readLyrics(){this._lyrics=[],this._lyricsTrack=k.readInt32LE(this.data)-1;for(let e=0;e<5;e++){const s=new Li;s.startBar=k.readInt32LE(this.data)-1,s.text=Te.gpReadStringInt(this.data,this.settings.importer.encoding),this._lyrics.push(s)}}readPageSetup(){this.data.skip(28);const e=k.readInt16LE(this.data);O.getOrCreateHeaderFooterStyle(this._score,H.Title).isVisible=!!(1&e),O.getOrCreateHeaderFooterStyle(this._score,H.Title).template=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),O.getOrCreateHeaderFooterStyle(this._score,H.SubTitle).isVisible=!!(2&e),O.getOrCreateHeaderFooterStyle(this._score,H.SubTitle).template=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),O.getOrCreateHeaderFooterStyle(this._score,H.Artist).isVisible=!!(4&e),O.getOrCreateHeaderFooterStyle(this._score,H.Artist).template=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),O.getOrCreateHeaderFooterStyle(this._score,H.Album).isVisible=!!(8&e),O.getOrCreateHeaderFooterStyle(this._score,H.Album).template=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),O.getOrCreateHeaderFooterStyle(this._score,H.Words).isVisible=!!(16&e),O.getOrCreateHeaderFooterStyle(this._score,H.Words).template=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),O.getOrCreateHeaderFooterStyle(this._score,H.Music).isVisible=!!(32&e),O.getOrCreateHeaderFooterStyle(this._score,H.Music).template=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),O.getOrCreateHeaderFooterStyle(this._score,H.WordsAndMusic).isVisible=!!(64&e),O.getOrCreateHeaderFooterStyle(this._score,H.WordsAndMusic).template=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),O.getOrCreateHeaderFooterStyle(this._score,H.Copyright).isVisible=!!(128&e),O.getOrCreateHeaderFooterStyle(this._score,H.Copyright).template=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),O.getOrCreateHeaderFooterStyle(this._score,H.CopyrightSecondLine).isVisible=!!(128&e),O.getOrCreateHeaderFooterStyle(this._score,H.CopyrightSecondLine).template=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),Te.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this._playbackInfos=[];let e=0;for(let s=0;s<64;s++){const i=new Na;i.primaryChannel=e++,i.secondaryChannel=e++,i.program=k.readInt32LE(this.data),i.volume=this.data.readByte(),i.balance=this.data.readByte(),this.data.skip(6),this._playbackInfos.push(i)}}readMasterBars(){for(let e=0;e<this._barCount;e++)this.readMasterBar()}readMasterBar(){let e=null;this._score.masterBars.length>0&&(e=this._score.masterBars[this._score.masterBars.length-1]);const s=new Ps,i=this.data.readByte();if(1&i?s.timeSignatureNumerator=this.data.readByte():e&&(s.timeSignatureNumerator=e.timeSignatureNumerator),2&i?s.timeSignatureDenominator=this.data.readByte():e&&(s.timeSignatureDenominator=e.timeSignatureDenominator),s.isRepeatStart=!!(4&i),!!(8&i)&&(s.repeatCount=this.data.readByte()+(this._versionNumber>=500?0:1)),16&i&&this._versionNumber<500){let o=e,h=0;for(;o&&!(o.isRepeatEnd&&o!==e||o.isRepeatStart);)h|=o.alternateEndings,o=o.previousMasterBar;let c=0;const d=this.data.readByte();for(let u=0;u<8;u++){const f=1<<u;d>u&&0===(h&f)&&(c|=f)}s.alternateEndings=c}if(32&i){const o=new Fi;o.text=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),o.marker="",Te.gpReadColor(this.data,!1),s.section=o}if(!!(64&i)&&this._keySignatures.set(this._score.masterBars.length,[k.readSInt8(this.data),this.data.readByte()]),this._versionNumber>=500&&!!(3&i)&&this.data.skip(4),this._versionNumber>=500&&(s.alternateEndings=this.data.readByte()),this._versionNumber>=500){switch(this.data.readByte()){case 1:s.tripletFeel=ue.Triplet8th;break;case 2:s.tripletFeel=ue.Triplet16th}this.data.readByte()}else s.tripletFeel=this._globalTripletFeel;const a=!!(128&i);s.isDoubleBar=a;const n=this._score.masterBars.length;if(this._directionLookup.has(n))for(const o of this._directionLookup.get(n))s.addDirection(o);this._score.addMasterBar(s),a&&this._doubleBars.add(s.index)}readTracks(){for(let e=0;e<this._trackCount;e++)this.readTrack()}readTrack(){const e=new gi;e.ensureStaveCount(1),this._score.addTrack(e);const s=e.staves[0],i=this.data.readByte();e.name=Te.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),!!(1&i)&&(s.isPercussion=!0),this._versionNumber>=500&&(e.isVisibleOnMultiTrack=!!(8&i)),null===this._score.stylesheet.perTrackDisplayTuning&&(this._score.stylesheet.perTrackDisplayTuning=new Map),this._score.stylesheet.perTrackDisplayTuning.set(e.index,!!(128&i));const a=k.readInt32LE(this.data),n=[];for(let d=0;d<7;d++){const u=k.readInt32LE(this.data);a>d&&n.push(u)}s.stringTuning.tunings=n;const o=k.readInt32LE(this.data),h=k.readInt32LE(this.data)-1,c=k.readInt32LE(this.data)-1;if(this.data.skip(4),h>=0&&h<this._playbackInfos.length){const d=this._playbackInfos[h];d.port=o,d.isSolo=!!(16&i),d.isMute=!!(32&i),d.secondaryChannel=c,Wt.isGuitar(d.program)&&(s.displayTranspositionPitch=-12),e.playbackInfo=d}if(s.capo=k.readInt32LE(this.data),e.color=Te.gpReadColor(this.data,!1),this._versionNumber>=500){const d=this.data.readByte();s.showTablature=!!(1&d),s.showStandardNotation=!!(2&d);const u=!!(100&d);null===this._score.stylesheet.perTrackChordDiagramsOnTop&&(this._score.stylesheet.perTrackChordDiagramsOnTop=new Map),this._score.stylesheet.perTrackChordDiagramsOnTop.set(e.index,u),this.data.readByte(),this.data.skip(43)}this._versionNumber>=510&&(this.data.skip(4),Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),Te.gpReadStringIntByte(this.data,this.settings.importer.encoding))}readBars(){for(let e=0;e<this._barCount;e++)for(let s=0;s<this._trackCount;s++)this.readBar(this._score.tracks[s])}readBar(e){const s=new Ts,i=e.staves[0];if(i.isPercussion&&(s.clef=Se.Neutral),i.addBar(s),this._keySignatures.has(s.index)){const n=this._keySignatures.get(s.index);s.keySignature=n[0],s.keySignatureType=n[1]}else s.index>0&&(s.keySignature=s.previousBar.keySignature,s.keySignatureType=s.previousBar.keySignatureType);this._doubleBars.has(s.index)&&(s.barLineRight=te.LightLight);let a=1;this._versionNumber>=500&&(this.data.readByte(),a=2);for(let n=0;n<a;n++)this.readVoice(e,s)}readVoice(e,s){const i=k.readInt32LE(this.data);if(0===i)return;const a=new es;s.addVoice(a);for(let n=0;n<i;n++)this.readBeat(e,s,a)}readBeat(e,s,i){const a=new xt,n=this.data.readByte();if(!!(1&n)&&(a.dots=1),64&n){const u=this.data.readByte();a.isEmpty=!(2&u)}switch(i.addBeat(a),k.readSInt8(this.data)){case-2:a.duration=m.Whole;break;case-1:a.duration=m.Half;break;case 0:a.duration=m.Quarter;break;case 1:a.duration=m.Eighth;break;case 2:a.duration=m.Sixteenth;break;case 3:a.duration=m.ThirtySecond;break;case 4:a.duration=m.SixtyFourth;break;default:a.duration=m.Quarter}if(32&n)switch(a.tupletNumerator=k.readInt32LE(this.data),a.tupletNumerator){case 1:a.tupletDenominator=1;break;case 3:a.tupletDenominator=2;break;case 5:case 6:case 7:a.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:a.tupletDenominator=8;break;case 2:case 4:case 8:break;default:a.tupletNumerator=1,a.tupletDenominator=1}2&n&&this.readChord(a);const h=this.settings.importer.beatTextAsLyrics&&e.index!==this._lyricsTrack;if(4&n){const u=Te.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(h){const f=new Li;f.text=u.trim(),f.finish(!0);const p=[];for(let g=f.chunks.length-1;g>=0;g--)p.push(f.chunks[g]);this._beatTextChunksByTrack.set(e.index,p)}else a.text=u}let c=Z.None;!!(8&n)&&(c=this.readBeatEffects(a)),16&n&&this.readMixTableChange(a);const d=this.data.readByte();for(let u=6;u>=0;u--)if(d&1<<u&&6-u<s.staff.tuning.length){const f=this.readNote(e,s,i,a,6-u);c!==Z.None&&(f.harmonicType=c,f.harmonicType===Z.Natural&&(f.harmonicValue=O.deltaFretToHarmonicValue(f.fret)))}if(this._versionNumber>=500){const u=k.readInt16LE(this.data);if(!!(1&u)&&a.index>0&&(i.beats[a.index-1].beamingMode=ze.ForceSplitToNext),!!(2&u)&&(a.preferredBeamDirection=P.Down),!!(4&u)&&a.index>0&&(i.beats[a.index-1].beamingMode=ze.ForceMergeWithNext),!!(8&u)&&(a.preferredBeamDirection=P.Up),!!(16&u)&&(a.ottava=le._8va),!!(32&u)&&(a.ottava=le._8vb),!!(64&u)&&(a.ottava=le._15ma),!!(256&u)&&(a.ottava=le._15mb),2048&u){const f=0!==this.data.readByte();a.index>0&&f&&(i.beats[a.index-1].beamingMode=ze.ForceSplitOnSecondaryToNext)}}h&&!a.isRest&&this._beatTextChunksByTrack.has(e.index)&&this._beatTextChunksByTrack.get(e.index).length>0&&(a.lyrics=[this._beatTextChunksByTrack.get(e.index).pop()])}readChord(e){const s=new Os,i=O.newGuid();if(this._versionNumber>=500){this.data.skip(17),s.name=Te.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),s.firstFret=k.readInt32LE(this.data);for(let o=0;o<7;o++){const h=k.readInt32LE(this.data);o<e.voice.bar.staff.tuning.length&&s.strings.push(h)}const a=this.data.readByte(),n=new Uint8Array(5);this.data.read(n,0,n.length);for(let o=0;o<a;o++)s.barreFrets.push(n[o]);this.data.skip(26)}else if(0!==this.data.readByte())if(this._versionNumber>=400){this.data.skip(16),s.name=Te.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),s.firstFret=k.readInt32LE(this.data);for(let o=0;o<7;o++){const h=k.readInt32LE(this.data);o<e.voice.bar.staff.tuning.length&&s.strings.push(h)}const a=this.data.readByte(),n=new Uint8Array(5);this.data.read(n,0,n.length);for(let o=0;o<a;o++)s.barreFrets.push(n[o]);this.data.skip(26)}else{this.data.skip(25),s.name=Te.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),s.firstFret=k.readInt32LE(this.data);for(let a=0;a<6;a++){const n=k.readInt32LE(this.data);a<e.voice.bar.staff.tuning.length&&s.strings.push(n)}this.data.skip(36)}else{const a=this._versionNumber>=406?7:6;if(s.name=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),s.firstFret=k.readInt32LE(this.data),s.firstFret>0)for(let n=0;n<a;n++){const o=k.readInt32LE(this.data);n<e.voice.bar.staff.tuning.length&&s.strings.push(o)}}s.name&&(e.chordId=i,e.voice.bar.staff.addChord(e.chordId,s))}readBeatEffects(e){const s=this.data.readByte();let i=0;if(this._versionNumber>=400&&(i=this.data.readByte()),!!(16&s)&&(e.fade=ct.FadeIn),(this._versionNumber<400&&!!(1&s)||!!(2&s))&&(e.vibrato=ke.Slight),!!(1&i)&&(e.rasgueado=G.Ii),32&s&&this._versionNumber>=400)switch(k.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0}else if(32&s){switch(k.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0}this.data.skip(4)}if(!!(4&i)&&this.readTremoloBarEffect(e),64&s){let a=0,n=0;this._versionNumber<500?(n=this.data.readByte(),a=this.data.readByte()):(a=this.data.readByte(),n=this.data.readByte()),a>0?(e.brushType=V.BrushUp,e.brushDuration=r.toStrokeValue(a)):n>0&&(e.brushType=V.BrushDown,e.brushDuration=r.toStrokeValue(n))}if(2&i)switch(k.readSInt8(this.data)){case 0:e.pickStroke=yt.None;break;case 1:e.pickStroke=yt.Up;break;case 2:e.pickStroke=yt.Down}if(this._versionNumber<400){if(4&s)return Z.Natural;if(8&s)return Z.Artificial}return Z.None}readTremoloBarEffect(e){this.data.readByte(),k.readInt32LE(this.data);const s=k.readInt32LE(this.data);if(s>0)for(let i=0;i<s;i++){const a=new R(0,0);a.offset=k.readInt32LE(this.data),a.value=k.readInt32LE(this.data)/r.BendStep|0,Te.gpReadBool(this.data),e.addWhammyBarPoint(a)}}static toStrokeValue(e){switch(e){case 1:case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}readMixTableChange(e){const s=new mh;s.instrument=k.readSInt8(this.data),this._versionNumber>=500&&this.data.skip(16),s.volume=k.readSInt8(this.data),s.balance=k.readSInt8(this.data);const i=k.readSInt8(this.data),a=k.readSInt8(this.data),n=k.readSInt8(this.data),o=k.readSInt8(this.data);if(this._versionNumber>=500&&(s.tempoName=Te.gpReadStringIntByte(this.data,this.settings.importer.encoding)),s.tempo=k.readInt32LE(this.data),s.volume>=0&&this.data.readByte(),s.balance>=0&&this.data.readByte(),i>=0&&this.data.readByte(),a>=0&&this.data.readByte(),n>=0&&this.data.readByte(),o>=0&&this.data.readByte(),s.tempo>=0&&(s.duration=k.readSInt8(this.data),this._versionNumber>=510&&this.data.readByte()),this._versionNumber>=400&&this.data.readByte(),this._versionNumber>=500){const h=k.readSInt8(this.data);h>=100?e.wahPedal=Jt.Closed:h>=0&&(e.wahPedal=Jt.Open)}if(this._versionNumber>=510&&(Te.gpReadStringIntByte(this.data,this.settings.importer.encoding),Te.gpReadStringIntByte(this.data,this.settings.importer.encoding)),s.volume>=0){const h=new Qe;h.isLinear=!0,h.type=Ge.Volume,h.value=s.volume,e.automations.push(h)}if(s.balance>=0){const h=new Qe;h.isLinear=!0,h.type=Ge.Balance,h.value=s.balance,e.automations.push(h)}if(s.instrument>=0){const h=new Qe;h.isLinear=!0,h.type=Ge.Instrument,h.value=s.instrument,e.automations.push(h)}if(s.tempo>=0){const h=new Qe;h.isLinear=!0,h.type=Ge.Tempo,h.value=s.tempo,e.automations.push(h),e.voice.bar.masterBar.tempoAutomations.push(h)}}readNote(e,s,i,a,n){const o=new ts;o.string=s.staff.tuning.length-n;const h=this.data.readByte();if(2&h?o.accentuated=et.Heavy:!!(64&h)&&(o.accentuated=et.Normal),o.isGhost=!!(4&h),32&h){const d=this.data.readByte();3===d?o.isDead=!0:2===d&&(o.isTieDestination=!0)}if(!!(1&h)&&this._versionNumber<500&&(this.data.readByte(),this.data.readByte()),16&h){const d=k.readSInt8(this.data);o.dynamics=this.toDynamicValue(d),a.dynamics=o.dynamics}!!(32&h)&&(o.fret=k.readSInt8(this.data)),128&h&&(o.leftHandFinger=k.readSInt8(this.data),o.rightHandFinger=k.readSInt8(this.data));let c=!1;if(this._versionNumber>=500&&(!!(1&h)&&(o.durationPercent=k.readFloat64BE(this.data)),c=!!(2&this.data.readByte())),a.addNote(o),!!(8&h)&&this.readNoteEffects(e,i,a,o),s.staff.isPercussion&&(o.percussionArticulation=o.fret,o.string=-1,o.fret=-1),c){const d=F.defaultAccidentals[o.realValueWithoutHarmonic%12];"#"===d?o.accidentalMode=ge.ForceFlat:"b"===d&&(o.accidentalMode=ge.ForceSharp)}return o}toDynamicValue(e){switch(e){case 1:return J.PPP;case 2:return J.PP;case 3:return J.P;case 4:return J.MP;case 5:return J.MF;case 6:default:return J.F;case 7:return J.FF;case 8:return J.FFF}}readNoteEffects(e,s,i,a){const n=this.data.readByte();let o=0;this._versionNumber>=400&&(o=this.data.readByte()),!!(1&n)&&this.readBend(a),!!(16&n)&&this.readGrace(s,a),!!(4&o)&&this.readTremoloPicking(i),8&o?this.readSlide(a):this._versionNumber<400&&!!(4&n)&&(a.slideOutType=ce.Shift),!!(16&o)&&this.readArtificialHarmonic(a),!!(32&o)&&this.readTrill(a),a.isLetRing=!!(8&n),a.isHammerPullOrigin=!!(2&n),!!(64&o)&&(a.vibrato=ke.Slight),a.isPalmMute=!!(2&o),a.isStaccato=!!(1&o)}readBend(e){this.data.readByte(),k.readInt32LE(this.data);const s=k.readInt32LE(this.data);if(s>0)for(let i=0;i<s;i++){const a=new R(0,0);a.offset=k.readInt32LE(this.data),a.value=k.readInt32LE(this.data)/r.BendStep|0,Te.gpReadBool(this.data),e.addBendPoint(a)}}readGrace(e,s){const i=new xt,a=new ts;switch(a.string=s.string,a.fret=k.readSInt8(this.data),i.duration=m.ThirtySecond,i.dynamics=this.toDynamicValue(k.readSInt8(this.data)),k.readSInt8(this.data)){case 0:case 2:break;case 1:a.slideOutType=ce.Legato,a.slideTarget=s;break;case 3:a.isHammerPullOrigin=!0}if(a.dynamics=i.dynamics,this.data.skip(1),this._versionNumber<500)i.graceType=K.BeforeBeat;else{const o=this.data.readByte();a.isDead=!!(1&o),i.graceType=2&o?K.OnBeat:K.BeforeBeat}e.addGraceBeat(i),i.addNote(a)}readTremoloPicking(e){switch(this.data.readByte()){case 1:e.tremoloSpeed=m.Eighth;break;case 2:e.tremoloSpeed=m.Sixteenth;break;case 3:e.tremoloSpeed=m.ThirtySecond}}readSlide(e){if(this._versionNumber>=500){const s=k.readSInt8(this.data);1&s?e.slideOutType=ce.Shift:2&s?e.slideOutType=ce.Legato:4&s?e.slideOutType=ce.OutDown:!!(8&s)&&(e.slideOutType=ce.OutUp),16&s?e.slideInType=ut.IntoFromBelow:32&s&&(e.slideInType=ut.IntoFromAbove)}else switch(k.readSInt8(this.data)){case 1:e.slideOutType=ce.Shift;break;case 2:e.slideOutType=ce.Legato;break;case 3:e.slideOutType=ce.OutDown;break;case 4:e.slideOutType=ce.OutUp;break;case-1:e.slideInType=ut.IntoFromBelow;break;case-2:e.slideInType=ut.IntoFromAbove}}readArtificialHarmonic(e){const s=this.data.readByte();if(this._versionNumber>=500)switch(s){case 1:e.harmonicType=Z.Natural,e.harmonicValue=O.deltaFretToHarmonicValue(e.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),e.harmonicType=Z.Artificial;break;case 3:e.harmonicType=Z.Tap,e.harmonicValue=O.deltaFretToHarmonicValue(this.data.readByte());break;case 4:e.harmonicType=Z.Pinch,e.harmonicValue=12;break;case 5:e.harmonicType=Z.Semi,e.harmonicValue=12}else if(this._versionNumber>=400)switch(s){case 1:e.harmonicType=Z.Natural;break;case 3:e.harmonicType=Z.Tap;break;case 4:e.harmonicType=Z.Pinch;break;case 5:e.harmonicType=Z.Semi;break;case 15:case 17:case 22:e.harmonicType=Z.Artificial}}readTrill(e){switch(e.trillValue=this.data.readByte()+e.stringTuning,this.data.readByte()){case 1:e.trillSpeed=m.Sixteenth;break;case 2:e.trillSpeed=m.ThirtySecond;break;case 3:e.trillSpeed=m.SixtyFourth}}}return r.VersionString="FICHIER GUITAR PRO ",r.BendStep=25,r})();class Te{static gpReadColor(t,e=!1){const s=t.readByte(),i=t.readByte(),a=t.readByte();let n=255;return e?n=t.readByte():t.skip(1),new Ee(s,i,a,n)}static gpReadBool(t){return 0!==t.readByte()}static gpReadStringIntUnused(t,e){return t.skip(4),Te.gpReadString(t,t.readByte(),e)}static gpReadStringInt(t,e){return Te.gpReadString(t,k.readInt32LE(t),e)}static gpReadStringIntByte(t,e){const s=k.readInt32LE(t)-1;return t.readByte(),Te.gpReadString(t,s,e)}static gpReadString(t,e,s){const i=new Uint8Array(e);return t.read(i,0,i.length),k.toString(i,s)}static gpWriteString(t,e){const s=k.stringToBytes(e);t.writeByte(e.length),t.write(s,0,s.length)}static gpReadStringByteLength(t,e,s){const i=t.readByte(),a=Te.gpReadString(t,i,s);return i<e&&t.skip(e-i),a}}class mh{constructor(){this.volume=-1,this.balance=-1,this.instrument=-1,this.tempoName="",this.tempo=-1,this.duration=-1}}class St{constructor(){this.x=0,this.y=0,this.w=0,this.h=0}scaleWith(t){this.x*=t,this.y*=t,this.w*=t,this.h*=t}}var De=function(r){return r[r.Boolean=0]="Boolean",r[r.Integer=1]="Integer",r[r.Float=2]="Float",r[r.String=3]="String",r[r.Point=4]="Point",r[r.Size=5]="Size",r[r.Rectangle=6]="Rectangle",r[r.Color=7]="Color",r}(De||{});class $t{constructor(t){this._types=new Map,this.raw=new Map,t&&this.read(t)}read(t){const e=Ke.fromBuffer(t),s=k.readInt32BE(e);for(let i=0;i<s;i++){const a=Te.gpReadString(e,e.readByte(),"utf-8"),n=e.readByte();switch(this._types.set(a,n),n){case De.Boolean:const o=1===e.readByte();this.addValue(a,o);break;case De.Integer:const h=k.readInt32BE(e);this.addValue(a,h);break;case De.Float:const c=k.readFloat32BE(e);this.addValue(a,c);break;case De.String:const d=Te.gpReadString(e,k.readInt16BE(e),"utf-8");this.addValue(a,d);break;case De.Point:const u=k.readInt32BE(e),f=k.readInt32BE(e);this.addValue(a,new R(u,f));break;case De.Size:const p=k.readInt32BE(e),g=k.readInt32BE(e);this.addValue(a,new R(p,g));break;case De.Rectangle:const b=new St;b.x=k.readInt32BE(e),b.y=k.readInt32BE(e),b.w=k.readInt32BE(e),b.h=k.readInt32BE(e),this.addValue(a,b);break;case De.Color:const w=Te.gpReadColor(e,!0);this.addValue(a,w)}}}apply(t){for(const[e,s]of this.raw)switch(e){case"StandardNotation/hideDynamics":t.stylesheet.hideDynamics=s;break;case"System/bracketExtendMode":t.stylesheet.bracketExtendMode=s;break;case"Global/useSystemSignSeparator":t.stylesheet.useSystemSignSeparator=s;break;case"Global/DisplayTuning":t.stylesheet.globalDisplayTuning=s;break;case"Global/DrawChords":t.stylesheet.globalDisplayChordDiagramsOnTop=s;break;case"System/showTrackNameSingle":s||(t.stylesheet.singleTrackTrackNamePolicy=Oe.Hidden);break;case"System/showTrackNameMulti":s||(t.stylesheet.multiTrackTrackNamePolicy=Oe.Hidden);break;case"System/trackNameModeSingle":if(t.stylesheet.singleTrackTrackNamePolicy!==Oe.Hidden)switch(s){case 0:case 1:t.stylesheet.singleTrackTrackNamePolicy=Oe.FirstSystem;break;case 2:t.stylesheet.singleTrackTrackNamePolicy=Oe.AllSystems}break;case"System/trackNameModeMulti":if(t.stylesheet.multiTrackTrackNamePolicy!==Oe.Hidden)switch(s){case 0:case 1:t.stylesheet.multiTrackTrackNamePolicy=Oe.FirstSystem;break;case 2:t.stylesheet.multiTrackTrackNamePolicy=Oe.AllSystems}break;case"System/shortTrackNameOnFirstSystem":t.stylesheet.firstSystemTrackNameMode=s?nt.ShortName:nt.FullName;break;case"System/shortTrackNameOnOtherSystems":t.stylesheet.otherSystemsTrackNameMode=s?nt.ShortName:nt.FullName;break;case"System/horizontalTrackNameOnFirstSystem":t.stylesheet.firstSystemTrackNameOrientation=s?ot.Horizontal:ot.Vertical;break;case"System/horizontalTrackNameOnOtherSystems":t.stylesheet.otherSystemsTrackNameOrientation=s?ot.Horizontal:ot.Vertical;break;case"Header/Title":O.getOrCreateHeaderFooterStyle(t,H.Title).template=s;break;case"Header/TitleAlignment":O.getOrCreateHeaderFooterStyle(t,H.Title).textAlign=this.toTextAlign(s);break;case"Header/drawTitle":O.getOrCreateHeaderFooterStyle(t,H.Title).isVisible=s;break;case"Header/Subtitle":O.getOrCreateHeaderFooterStyle(t,H.SubTitle).template=s;break;case"Header/SubtitleAlignment":O.getOrCreateHeaderFooterStyle(t,H.SubTitle).textAlign=this.toTextAlign(s);break;case"Header/drawSubtitle":O.getOrCreateHeaderFooterStyle(t,H.SubTitle).isVisible=s;break;case"Header/Artist":O.getOrCreateHeaderFooterStyle(t,H.Artist).template=s;break;case"Header/ArtistAlignment":O.getOrCreateHeaderFooterStyle(t,H.Artist).textAlign=this.toTextAlign(s);break;case"Header/drawArtist":O.getOrCreateHeaderFooterStyle(t,H.Artist).isVisible=s;break;case"Header/Album":O.getOrCreateHeaderFooterStyle(t,H.Album).template=s;break;case"Header/AlbumAlignment":O.getOrCreateHeaderFooterStyle(t,H.Album).textAlign=this.toTextAlign(s);break;case"Header/drawAlbum":O.getOrCreateHeaderFooterStyle(t,H.Album).isVisible=s;break;case"Header/Words":O.getOrCreateHeaderFooterStyle(t,H.Words).template=s;break;case"Header/WordsAlignment":O.getOrCreateHeaderFooterStyle(t,H.Words).textAlign=this.toTextAlign(s);break;case"Header/drawWords":O.getOrCreateHeaderFooterStyle(t,H.Words).isVisible=s;break;case"Header/Music":O.getOrCreateHeaderFooterStyle(t,H.Music).template=s;break;case"Header/MusicAlignment":O.getOrCreateHeaderFooterStyle(t,H.Music).textAlign=this.toTextAlign(s);break;case"Header/drawMusic":O.getOrCreateHeaderFooterStyle(t,H.Music).isVisible=s;break;case"Header/WordsAndMusic":O.getOrCreateHeaderFooterStyle(t,H.WordsAndMusic).template=s;break;case"Header/WordsAndMusicAlignment":O.getOrCreateHeaderFooterStyle(t,H.WordsAndMusic).textAlign=this.toTextAlign(s);break;case"Header/drawWordsAndMusic":O.getOrCreateHeaderFooterStyle(t,H.WordsAndMusic).isVisible=s;break;case"Header/Tabber":O.getOrCreateHeaderFooterStyle(t,H.Transcriber).template=s;break;case"Header/TabberAlignment":O.getOrCreateHeaderFooterStyle(t,H.Transcriber).textAlign=this.toTextAlign(s);break;case"Header/drawTabber":O.getOrCreateHeaderFooterStyle(t,H.Transcriber).isVisible=s;break;case"Footer/Copyright":O.getOrCreateHeaderFooterStyle(t,H.Copyright).template=s;break;case"Footer/CopyrightAlignment":O.getOrCreateHeaderFooterStyle(t,H.Copyright).textAlign=this.toTextAlign(s);break;case"Footer/drawCopyright":O.getOrCreateHeaderFooterStyle(t,H.Copyright).isVisible=s;break;case"Footer/Copyright2":O.getOrCreateHeaderFooterStyle(t,H.CopyrightSecondLine).template=s;break;case"Footer/Copyright2Alignment":O.getOrCreateHeaderFooterStyle(t,H.CopyrightSecondLine).textAlign=this.toTextAlign(s);break;case"Footer/drawCopyright2":O.getOrCreateHeaderFooterStyle(t,H.CopyrightSecondLine).isVisible=s}}toTextAlign(t){switch(t){case 0:return U.Left;case 1:return U.Center;case 2:return U.Right}return U.Left}addValue(t,e,s){this.raw.set(t,e),void 0!==s&&this._types.set(t,s)}writeTo(t){k.writeInt32BE(t,this.raw.size);for(const[e,s]of this.raw){const i=this.getDataType(e,s);switch(Te.gpWriteString(t,e),t.writeByte(i),i){case De.Boolean:t.writeByte(s?1:0);break;case De.Integer:k.writeInt32BE(t,s);break;case De.Float:k.writeFloat32BE(t,s);break;case De.String:const a=k.stringToBytes(s);k.writeInt16BE(t,a.length),t.write(a,0,a.length);break;case De.Point:case De.Size:k.writeInt32BE(t,s.offset),k.writeInt32BE(t,s.value);break;case De.Rectangle:k.writeInt32BE(t,s.x),k.writeInt32BE(t,s.y),k.writeInt32BE(t,s.w),k.writeInt32BE(t,s.h);break;case De.Color:t.writeByte(s.r),t.writeByte(s.g),t.writeByte(s.b),t.writeByte(s.a)}}}getDataType(t,e){if(this._types.has(t))return this._types.get(t);const s=typeof e;switch(typeof e){case"string":return De.String;case"number":return e===(0|e)?De.Integer:De.Float;case"object":if(e instanceof R)return De.Point;if(e instanceof St)return De.Rectangle;if(e instanceof Ee)return De.Color}throw new Le(Fe.General,`Unknown value type in BinaryStylesheet: ${s}`)}static writeForScore(t){const e=new $t;switch(e.addValue("StandardNotation/hideDynamics",t.stylesheet.hideDynamics,De.Boolean),e.addValue("System/bracketExtendMode",t.stylesheet.bracketExtendMode,De.Integer),e.addValue("Global/useSystemSignSeparator",t.stylesheet.useSystemSignSeparator,De.Boolean),e.addValue("Global/DisplayTuning",t.stylesheet.globalDisplayTuning,De.Boolean),e.addValue("Global/DrawChords",t.stylesheet.globalDisplayChordDiagramsOnTop,De.Boolean),t.stylesheet.singleTrackTrackNamePolicy){case Oe.Hidden:e.addValue("System/showTrackNameSingle",!1,De.Boolean);break;case Oe.FirstSystem:e.addValue("System/trackNameModeSingle",0,De.Integer);break;case Oe.AllSystems:e.addValue("System/trackNameModeSingle",2,De.Integer)}switch(t.stylesheet.multiTrackTrackNamePolicy){case Oe.Hidden:e.addValue("System/showTrackNameMulti",!1,De.Boolean);break;case Oe.FirstSystem:e.addValue("System/trackNameModeMulti",0,De.Integer);break;case Oe.AllSystems:e.addValue("System/trackNameModeMulti",2,De.Integer)}switch(t.stylesheet.firstSystemTrackNameMode){case nt.FullName:e.addValue("System/shortTrackNameOnFirstSystem",!1,De.Boolean);break;case nt.ShortName:e.addValue("System/shortTrackNameOnFirstSystem",!0,De.Boolean)}switch(t.stylesheet.otherSystemsTrackNameMode){case nt.FullName:e.addValue("System/shortTrackNameOnOtherSystems",!1,De.Boolean);break;case nt.ShortName:e.addValue("System/shortTrackNameOnOtherSystems",!0,De.Boolean)}switch(t.stylesheet.firstSystemTrackNameOrientation){case ot.Horizontal:e.addValue("System/horizontalTrackNameOnFirstSystem",!0,De.Boolean);break;case ot.Vertical:e.addValue("System/horizontalTrackNameOnFirstSystem",!1,De.Boolean)}switch(t.stylesheet.otherSystemsTrackNameOrientation){case ot.Horizontal:e.addValue("System/horizontalTrackNameOnOtherSystems",!0,De.Boolean);break;case ot.Vertical:e.addValue("System/horizontalTrackNameOnOtherSystems",!1,De.Boolean)}const s=t.style;if(s)for(const[a,n]of s.headerAndFooter)switch(a){case H.Title:$t.addHeaderAndFooter(e,n,"Header/","Title");break;case H.SubTitle:$t.addHeaderAndFooter(e,n,"Header/","Subtitle");break;case H.Artist:$t.addHeaderAndFooter(e,n,"Header/","Artist");break;case H.Album:$t.addHeaderAndFooter(e,n,"Header/","Album");break;case H.Words:$t.addHeaderAndFooter(e,n,"Header/","Words");break;case H.Music:$t.addHeaderAndFooter(e,n,"Header/","Music");break;case H.WordsAndMusic:$t.addHeaderAndFooter(e,n,"Header/","WordsAndMusic");break;case H.Transcriber:$t.addHeaderAndFooter(e,n,"Header/","Tabber");break;case H.Copyright:$t.addHeaderAndFooter(e,n,"Footer/","Copyright");break;case H.CopyrightSecondLine:$t.addHeaderAndFooter(e,n,"Footer/","Copyright2")}const i=Ke.withCapacity(128);return e.writeTo(i),i.toArray()}static addHeaderAndFooter(t,e,s,i){t.addValue(`${s}${i}`,e.template,De.String),t.addValue(`${s}${i}Alignment`,e.textAlign,De.Integer),void 0!==e.isVisible&&t.addValue(`${s}draw${i}`,e.isVisible,De.Boolean)}}var Ye=function(r){return r[r.None=0]="None",r[r.Element=1]="Element",r[r.Text=2]="Text",r[r.CDATA=3]="CDATA",r[r.Document=4]="Document",r[r.DocumentType=5]="DocumentType",r[r.Comment=6]="Comment",r}(Ye||{});class rs{constructor(){this.nodeType=Ye.None,this.localName=null,this.value=null,this.childNodes=[],this.attributes=new Map,this.firstChild=null,this.firstElement=null}*childElements(){for(const t of this.childNodes)t.nodeType===Ye.Element&&(yield t)}addChild(t){this.childNodes.push(t),this.firstChild=t,(t.nodeType===Ye.Element||t.nodeType===Ye.CDATA)&&(this.firstElement=t)}getAttribute(t,e=""){return this.attributes.has(t)?this.attributes.get(t):e}getElementsByTagName(t,e=!1){const s=[];return this.searchElementsByTagName(this.childNodes,s,t,e),s}searchElementsByTagName(t,e,s,i=!1){for(const a of t)a&&a.nodeType===Ye.Element&&a.localName===s&&e.push(a),i&&this.searchElementsByTagName(a.childNodes,e,s,!0)}findChildElement(t){for(const e of this.childNodes)if(e&&e.nodeType===Ye.Element&&e.localName===t)return e;return null}addElement(t){const e=new rs;return e.nodeType=Ye.Element,e.localName=t,this.addChild(e),e}get innerText(){if(this.nodeType===Ye.Element||this.nodeType===Ye.Document){if(this.firstElement&&this.firstElement.nodeType===Ye.CDATA)return this.firstElement.innerText;let t="";for(const s of this.childNodes)t+=s.innerText?.toString();return t.trim()}return this.value??""}set innerText(t){const e=new rs;e.nodeType=Ye.Text,e.value=t,this.childNodes=[e]}setCData(t){const e=new rs;e.nodeType=Ye.CDATA,e.value=t,this.childNodes=[e]}}class Qt extends Le{constructor(t,e,s){super(Fe.Format,t),this.pos=0,this.xml=e,this.pos=s,Object.setPrototypeOf(this,Qt.prototype)}}var he=function(r){return r[r.IgnoreSpaces=0]="IgnoreSpaces",r[r.Begin=1]="Begin",r[r.BeginNode=2]="BeginNode",r[r.TagName=3]="TagName",r[r.Body=4]="Body",r[r.AttribName=5]="AttribName",r[r.Equals=6]="Equals",r[r.AttvalBegin=7]="AttvalBegin",r[r.AttribVal=8]="AttribVal",r[r.Childs=9]="Childs",r[r.Close=10]="Close",r[r.WaitEnd=11]="WaitEnd",r[r.WaitEndRet=12]="WaitEndRet",r[r.Pcdata=13]="Pcdata",r[r.Header=14]="Header",r[r.Comment=15]="Comment",r[r.Doctype=16]="Doctype",r[r.Cdata=17]="Cdata",r[r.Escape=18]="Escape",r}(he||{});class X{static parse(t,e,s){let i=t.charCodeAt(e),a=he.Begin,n=he.Begin,o=0,h="",c=he.Begin,d=null,u=null,f=0,p=0;for(;e<t.length;){switch(i=t.charCodeAt(e),a){case he.IgnoreSpaces:switch(i){case X.CharCodeLF:case X.CharCodeCR:case X.CharCodeTab:case X.CharCodeSpace:break;default:a=n;continue}break;case he.Begin:if(i!==X.CharCodeLowerThan){o=e,a=he.Pcdata;continue}a=he.IgnoreSpaces,n=he.BeginNode;break;case he.Pcdata:if(i===X.CharCodeLowerThan){h+=t.substr(o,e-o);const g=new rs;g.nodeType=Ye.Text,g.value=h,h="",s.addChild(g),a=he.IgnoreSpaces,n=he.BeginNode}else i===X.CharCodeAmp&&(h+=t.substr(o,e-o),a=he.Escape,c=he.Pcdata,o=e+1);break;case he.Cdata:if(i===X.CharCodeBrackedClose&&t.charCodeAt(e+1)===X.CharCodeBrackedClose&&t.charCodeAt(e+2)===X.CharCodeGreaterThan){const g=new rs;g.nodeType=Ye.CDATA,g.value=t.substr(o,e-o),s.addChild(g),e+=2,a=he.Begin}break;case he.BeginNode:switch(i){case X.CharCodeExclamation:if(t.charCodeAt(e+1)===X.CharCodeBrackedOpen){if("CDATA["!==t.substr(e+=2,6).toUpperCase())throw new Qt("Expected <![CDATA[",t,e);a=he.Cdata,o=(e+=5)+1}else if(t.charCodeAt(e+1)===X.CharCodeUpperD||t.charCodeAt(e+1)===X.CharCodeLowerD){if("OCTYPE"!==t.substr(e+2,6).toUpperCase())throw new Qt("Expected <!DOCTYPE",t,e);a=he.Doctype,o=(e+=8)+1}else{if(t.charCodeAt(e+1)!==X.CharCodeMinus||t.charCodeAt(e+2)!==X.CharCodeMinus)throw new Qt("Expected \x3c!--",t,e);a=he.Comment,o=(e+=2)+1}break;case X.CharCodeQuestion:a=he.Header,o=e;break;case X.CharCodeSlash:if(!s)throw new Qt("Expected node name",t,e);o=e+1,a=he.IgnoreSpaces,n=he.Close;break;default:a=he.TagName,o=e;continue}break;case he.TagName:if(!X.isValidChar(i)){if(e===o)throw new Qt("Expected node name",t,e);d=new rs,d.nodeType=Ye.Element,d.localName=t.substr(o,e-o),s.addChild(d),a=he.IgnoreSpaces,n=he.Body;continue}break;case he.Body:switch(i){case X.CharCodeSlash:a=he.WaitEnd;break;case X.CharCodeGreaterThan:a=he.Childs;break;default:a=he.AttribName,o=e;continue}break;case he.AttribName:if(!X.isValidChar(i)){if(o===e)throw new Qt("Expected attribute name",t,e);if(u=t.substr(o,e-o),d.attributes.has(u))throw new Qt(`Duplicate attribute [${u}]`,t,e);a=he.IgnoreSpaces,n=he.Equals;continue}break;case he.Equals:if(i!==X.CharCodeEquals)throw new Qt("Expected =",t,e);a=he.IgnoreSpaces,n=he.AttvalBegin;break;case he.AttvalBegin:switch(i){case X.CharCodeDoubleQuote:case X.CharCodeSingleQuote:h="",a=he.AttribVal,o=e+1,p=i}break;case he.AttribVal:if(i===X.CharCodeAmp)h+=t.substr(o,e-o),a=he.Escape,c=he.AttribVal,o=e+1;else if(i===p){h+=t.substr(o,e-o);const g=h;h="",d.attributes.set(u,g),a=he.IgnoreSpaces,n=he.Body}break;case he.Childs:o=e=X.parse(t,e,d),a=he.Begin;break;case he.WaitEnd:if(i!==X.CharCodeGreaterThan)throw new Qt("Expected >",t,e);a=he.Begin;break;case he.WaitEndRet:if(i===X.CharCodeGreaterThan)return e;throw new Qt("Expected >",t,e);case he.Close:if(!X.isValidChar(i)){if(o===e)throw new Qt("Expected node name",t,e);if(t.substr(o,e-o)!==s.localName)throw new Qt(`Expected </${s.localName}>`,t,e);a=he.IgnoreSpaces,n=he.WaitEndRet;continue}break;case he.Comment:i===X.CharCodeMinus&&t.charCodeAt(e+1)===X.CharCodeMinus&&t.charCodeAt(e+2)===X.CharCodeGreaterThan&&(e+=2,a=he.Begin);break;case he.Doctype:if(i===X.CharCodeBrackedOpen)f++;else if(i===X.CharCodeBrackedClose)f--;else if(i===X.CharCodeGreaterThan&&0===f){const g=new rs;g.nodeType=Ye.DocumentType,g.value=t.substr(o,e-o),s.addChild(g),a=he.Begin}break;case he.Header:i===X.CharCodeQuestion&&t.charCodeAt(e+1)===X.CharCodeGreaterThan&&(e++,a=he.Begin);break;case he.Escape:if(i===X.CharCodeSemi){const g=t.substr(o,e-o);if(g.charCodeAt(0)===X.CharCodeSharp){const b=g.charCodeAt(1)===X.CharCodeLowerX?Number.parseInt(`0${g.substr(1,g.length-1)}`):Number.parseInt(g.substr(1,g.length-1));h+=String.fromCharCode(b)}else X.Escapes.has(g)?h+=X.Escapes.get(g):h+=`&${g};`?.toString();o=e+1,a=c}else!X.isValidChar(i)&&i!==X.CharCodeSharp&&(h+="&",h+=t.substr(o,e-o),o=1+--e,a=c)}e++}if(a===he.Begin&&(o=e,a=he.Pcdata),a===he.Pcdata){if(e!==o){h+=t.substr(o,e-o);const g=new rs;g.nodeType=Ye.Text,g.value=h,s.addChild(g)}return e}if(a===he.Escape&&c===he.Pcdata){h+="&",h+=t.substr(o,e-o);const g=new rs;return g.nodeType=Ye.Text,g.value=h,s.addChild(g),e}throw new Qt("Unexpected end",t,e)}static isValidChar(t){return t>=X.CharCodeLowerA&&t<=X.CharCodeLowerZ||t>=X.CharCodeUpperA&&t<=X.CharCodeUpperZ||t>=X.CharCode0&&t<=X.CharCode9||t===X.CharCodeColon||t===X.CharCodeDot||t===X.CharCodeUnderscore||t===X.CharCodeMinus}}X.CharCodeLF=10,X.CharCodeTab=9,X.CharCodeCR=13,X.CharCodeSpace=32,X.CharCodeLowerThan=60,X.CharCodeAmp=38,X.CharCodeBrackedClose=93,X.CharCodeBrackedOpen=91,X.CharCodeGreaterThan=62,X.CharCodeExclamation=33,X.CharCodeUpperD=68,X.CharCodeLowerD=100,X.CharCodeMinus=45,X.CharCodeQuestion=63,X.CharCodeSlash=47,X.CharCodeEquals=61,X.CharCodeDoubleQuote=34,X.CharCodeSingleQuote=39,X.CharCodeSharp=35,X.CharCodeLowerX=120,X.CharCodeLowerA=97,X.CharCodeLowerZ=122,X.CharCodeUpperA=65,X.CharCodeUpperZ=90,X.CharCode0=48,X.CharCode9=57,X.CharCodeColon=58,X.CharCodeDot=46,X.CharCodeUnderscore=95,X.CharCodeSemi=59,X.Escapes=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]);class Pa{static write(t,e,s){const i=new Pa(e,s);return i.writeNode(t),i.toString()}constructor(t,e){this._result=[],this._indention=t,this._xmlHeader=e,this._currentIndention="",this._isStartOfLine=!0}writeNode(t){switch(t.nodeType){case Ye.None:break;case Ye.Element:this._result.length>0&&this.writeLine(),this.write(`<${t.localName}`);for(const[e,s]of t.attributes)this.write(` ${e}="`),this.writeAttributeValue(s),this.write('"');if(0===t.childNodes.length)this.write("/>");else{if(this.write(">"),1!==t.childNodes.length||t.firstElement){this.indent();for(const e of t.childNodes)(e.nodeType===Ye.Element||e.nodeType===Ye.Comment)&&this.writeNode(e);this.unindend(),this.writeLine()}else this.writeNode(t.childNodes[0]);this.write(`</${t.localName}>`)}break;case Ye.Text:t.value&&this.write(t.value);break;case Ye.CDATA:null!==t.value&&this.write(`<![CDATA[${t.value}]]>`);break;case Ye.Document:this._xmlHeader&&this.write('<?xml version="1.0" encoding="utf-8"?>');for(const e of t.childNodes)this.writeNode(e);break;case Ye.DocumentType:this.write(`<!DOCTYPE ${t.value}>`);break;case Ye.Comment:this.write(`\x3c!-- ${t.value} --\x3e`)}}unindend(){this._currentIndention=this._currentIndention.substr(0,this._currentIndention.length-this._indention.length)}indent(){this._currentIndention+=this._indention}writeAttributeValue(t){for(let e=0;e<t.length;e++){const s=t.charAt(e);switch(s){case"<":this._result.push("&lt;");break;case">":this._result.push("&gt;");break;case"&":this._result.push("&amp;");break;case"'":this._result.push("&apos;");break;case'"':this._result.push("&quot;");break;default:this._result.push(s)}}}write(t){this._isStartOfLine&&this._result.push(this._currentIndention),this._result.push(t),this._isStartOfLine=!1}writeLine(t=null){t&&this.write(t),this._indention.length>0&&!this._isStartOfLine&&(this._result.push("\n"),this._isStartOfLine=!0)}toString(){return this._result.join("").trimRight()}}class Ki extends rs{constructor(){super(),this.nodeType=Ye.Document}parse(t){X.parse(t,0,this)}toString(){return this.toFormattedString()}toFormattedString(t="",e=!1){return Pa.write(this,t,e)}}class Ca{}class yh{constructor(){this.id="",this.dots=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.value=m.Quarter}}class bh{constructor(){this.name="",this.path="",this.role="",this.program=0}get uniqueId(){return`${this.path};${this.name};${this.role}`}}class M{constructor(){this._hasAnacrusis=!1,this._skipApplyLyrics=!1,this._backingTrackPadding=0,this._doubleBars=new Set,this._keySignatures=new Map}parseXml(t,e){this._masterTrackAutomations=new Map,this._automationsPerTrackIdAndBarIndex=new Map,this._sustainPedalsPerTrackIdAndBarIndex=new Map,this._tracksMapping=[],this._tracksById=new Map,this._masterBars=[],this._barsOfMasterBar=[],this._voicesOfBar=new Map,this._barsById=new Map,this._voiceById=new Map,this._beatsOfVoice=new Map,this._beatById=new Map,this._rhythmOfBeat=new Map,this._rhythmById=new Map,this._notesOfBeat=new Map,this._noteById=new Map,this._tappedNotes=new Map,this._lyricsByTrack=new Map,this._soundsByTrack=new Map,this._skipApplyLyrics=!1;const s=new Ki;try{s.parse(t)}catch(i){throw new st("Could not parse XML",i)}if(this.parseDom(s),this.buildModel(),O.consolidate(this.score),this.score.finish(e),!this._skipApplyLyrics&&this._lyricsByTrack.size>0)for(const[i,a]of this._lyricsByTrack)this._tracksById.get(i).applyLyrics(a)}parseDom(t){const e=t.firstElement;if(e){if("GPIF"!==e.localName)throw new st("Root node of XML was not GPIF");this.score=new Cs;for(const s of e.childElements())switch(s.localName){case"Score":this.parseScoreNode(s);break;case"MasterTrack":this.parseMasterTrackNode(s);break;case"BackingTrack":this.parseBackingTrackNode(s);break;case"Tracks":this.parseTracksNode(s);break;case"MasterBars":this.parseMasterBarsNode(s);break;case"Bars":this.parseBars(s);break;case"Voices":this.parseVoices(s);break;case"Beats":this.parseBeats(s);break;case"Notes":this.parseNotes(s);break;case"Rhythms":this.parseRhythms(s);break;case"Assets":this.parseAssets(s)}}}parseAssets(t){for(const e of t.childElements())"Asset"===e.localName&&e.getAttribute("id")===this._backingTrackAssetId&&this.parseBackingTrackAsset(e)}parseBackingTrackAsset(t){let e="";for(const i of t.childElements())"EmbeddedFilePath"===i.localName&&(e=i.innerText);const s=this.loadAsset;if(s){const i=s(e);i?this.score.backingTrack.rawAudioFile=i:this.score.backingTrack=void 0}}parseScoreNode(t){for(const e of t.childElements())switch(e.localName){case"Title":this.score.title=e.innerText;break;case"SubTitle":this.score.subTitle=e.innerText;break;case"Artist":this.score.artist=e.innerText;break;case"Album":this.score.album=e.innerText;break;case"Words":this.score.words=e.innerText;break;case"Music":this.score.music=e.innerText;break;case"WordsAndMusic":const s=e.innerText;""!==s&&(s&&!this.score.words&&(this.score.words=s),s&&!this.score.music&&(this.score.music=s));break;case"Copyright":this.score.copyright=e.innerText;break;case"Tabber":this.score.tab=e.innerText;break;case"Instructions":this.score.instructions=e.innerText;break;case"Notices":this.score.notices=e.innerText;break;case"ScoreSystemsDefaultLayout":this.score.defaultSystemsLayout=M.parseIntSafe(e.innerText,4);break;case"ScoreSystemsLayout":this.score.systemsLayout=M.splitSafe(e.innerText).map(i=>M.parseIntSafe(i,4))}}static parseIntSafe(t,e){if(!t)return e;const s=Number.parseInt(t);return Number.isNaN(s)?e:s}static parseFloatSafe(t,e){if(!t)return e;const s=Number.parseFloat(t);return Number.isNaN(s)?e:s}static splitSafe(t,e=" "){return t?t.split(e).map(s=>s.trim()).filter(s=>s.length>0):[]}parseBackingTrackNode(t){const e=new Ca;let s=!1,i="",a="";for(const n of t.childElements())switch(n.localName){case"Enabled":s="true"===n.innerText;break;case"Source":i=n.innerText;break;case"AssetId":a=n.innerText;break;case"FramePadding":this._backingTrackPadding=M.parseIntSafe(n.innerText,0)/M.SampleRate*1e3}s&&"Local"===i&&(this.score.backingTrack=e,this._backingTrackAssetId=a)}parseMasterTrackNode(t){for(const e of t.childElements())switch(e.localName){case"Automations":this.parseAutomations(e,this._masterTrackAutomations,null,null);break;case"Tracks":this._tracksMapping=M.splitSafe(e.innerText);break;case"Anacrusis":this._hasAnacrusis=!0}}parseAutomations(t,e,s,i){for(const a of t.childElements())"Automation"===a.localName&&this.parseAutomation(a,e,s,i)}parseAutomation(t,e,s,i){let p,a=null,n=!1,o=-1,h=0,c=0,d=null,u=0,f=null;for(const b of t.childElements())switch(b.localName){case"Type":a=b.innerText;break;case"Linear":n="true"===b.innerText.toLowerCase();break;case"Bar":o=M.parseIntSafe(b.innerText,0);break;case"Position":h=M.parseFloatSafe(b.innerText,0);break;case"Value":if(b.firstElement&&b.firstElement.nodeType===Ye.CDATA)d=b.innerText;else if(b.firstElement&&b.firstElement.nodeType===Ye.Element&&"SyncPoint"===a){p=new Yi;for(const w of b.childElements())switch(w.localName){case"BarIndex":o=M.parseIntSafe(w.innerText,0);break;case"BarOccurrence":p.barOccurence=M.parseIntSafe(w.innerText,0);break;case"FrameOffset":const S=M.parseFloatSafe(w.innerText,0);p.millisecondOffset=S/M.SampleRate*1e3}}else{const w=M.splitSafe(b.innerText);1===w.length?(c=M.parseFloatSafe(w[0],0),u=1):(c=M.parseFloatSafe(w[0],0),u=M.parseIntSafe(w[1],0))}break;case"Text":f=b.innerText}if(!a)return;let g=null;switch(a){case"Tempo":g=Qe.buildTempoAutomation(n,h,c,u);break;case"SyncPoint":g=new Qe,g.type=Ge.SyncPoint,g.isLinear=n,g.ratioPosition=h,g.syncPointValue=p;break;case"Sound":d&&s&&s.has(d)&&(g=Qe.buildInstrumentAutomation(n,h,s.get(d).program));break;case"SustainPedal":if(i){let b;i.has(o)?b=i.get(o):(b=[],i.set(o,b));const w=new Ks;switch(w.ratioPosition=h,u){case 1:w.pedalType=rt.Down;break;case 3:w.pedalType=rt.Up}b.push(w)}}g&&(f&&(g.text=f),o>=0&&(e.has(o)||e.set(o,[]),e.get(o).push(g)))}parseTracksNode(t){for(const e of t.childElements())"Track"===e.localName&&this.parseTrack(e)}parseTrack(t){this._articulationByName=new Map;const e=new gi;e.ensureStaveCount(1),e.staves[0].showStandardNotation=!0;const i=t.getAttribute("id");for(const a of t.childElements())switch(a.localName){case"Name":e.name=a.innerText;break;case"Color":const n=M.splitSafe(a.innerText);if(n.length>=3){const c=M.parseIntSafe(n[0],0),d=M.parseIntSafe(n[1],0),u=M.parseIntSafe(n[2],0);e.color=new Ee(c,d,u,255)}break;case"Instrument":const o=a.getAttribute("ref");(o.endsWith("-gs")||o.endsWith("GrandStaff"))&&(e.ensureStaveCount(2),e.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this.parseInstrumentSet(e,a);break;case"NotationPatch":this.parseNotationPatch(e,a);break;case"ShortName":e.shortName=a.innerText;break;case"SystemsDefautLayout":e.defaultSystemsLayout=M.parseIntSafe(a.innerText,4);break;case"SystemsLayout":e.systemsLayout=M.splitSafe(a.innerText).map(c=>M.parseIntSafe(c,4));break;case"Lyrics":this.parseLyrics(i,a);break;case"Properties":this.parseTrackProperties(e,a);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this.parseGeneralMidi(e,a);break;case"Sounds":this.parseSounds(i,e,a);break;case"PlaybackState":const h=a.innerText;e.playbackInfo.isSolo="Solo"===h,e.playbackInfo.isMute="Mute"===h;break;case"PartSounding":this.parsePartSounding(e,a);break;case"Staves":this.parseStaves(e,a);break;case"Transpose":this.parseTranspose(e,a);break;case"RSE":this.parseRSE(e,a);break;case"Automations":this.parseTrackAutomations(i,a)}this._tracksById.set(i,e)}parseTrackAutomations(t,e){const s=new Map;this._automationsPerTrackIdAndBarIndex.set(t,s);const i=new Map;this._sustainPedalsPerTrackIdAndBarIndex.set(t,i),this.parseAutomations(e,s,this._soundsByTrack.get(t),i)}parseNotationPatch(t,e){for(const s of e.childElements())switch(s.localName){case"LineCount":const i=M.parseIntSafe(s.innerText,5);for(const a of t.staves)a.standardNotationLineCount=i;break;case"Elements":this.parseElements(t,s)}}parseInstrumentSet(t,e){for(const s of e.childElements())switch(s.localName){case"Type":if("drumKit"===s.innerText)for(const a of t.staves)a.isPercussion=!0;break;case"Elements":this.parseElements(t,s);break;case"LineCount":const i=M.parseIntSafe(s.innerText,5);for(const a of t.staves)a.standardNotationLineCount=i}}parseElements(t,e){for(const s of e.childElements())"Element"===s.localName&&this.parseElement(t,s)}parseElement(t,e){const s=e.findChildElement("Type")?.innerText??"";for(const i of e.childElements())switch(i.localName){case"Name":case"Articulations":this.parseArticulations(t,i,s)}}parseArticulations(t,e,s){for(const i of e.childElements())"Articulation"===i.localName&&this.parseArticulation(t,i,s)}parseArticulation(t,e,s){const i=new W;i.outputMidiNumber=-1,i.elementType=s;let a="";for(const n of e.childElements()){const o=n.innerText;switch(n.localName){case"Name":a=n.innerText;break;case"OutputMidiNumber":i.outputMidiNumber=M.parseIntSafe(o,0);break;case"TechniqueSymbol":i.techniqueSymbol=this.parseTechniqueSymbol(o);break;case"TechniquePlacement":switch(o){case"outside":case"above":i.techniqueSymbolPlacement=re.Bottom;break;case"inside":i.techniqueSymbolPlacement=re.Middle;break;case"below":i.techniqueSymbolPlacement=re.Top}break;case"Noteheads":const h=M.splitSafe(o);h.length>=1&&(i.noteHeadDefault=this.parseNoteHead(h[0])),h.length>=2&&(i.noteHeadHalf=this.parseNoteHead(h[1])),h.length>=3&&(i.noteHeadWhole=this.parseNoteHead(h[2])),i.noteHeadHalf===l.None&&(i.noteHeadHalf=i.noteHeadDefault),i.noteHeadWhole===l.None&&(i.noteHeadWhole=i.noteHeadDefault);break;case"StaffLine":i.staffLine=M.parseIntSafe(o,0)}}-1!==i.outputMidiNumber?(t.percussionArticulations.push(i),a.length>0&&this._articulationByName.set(a,i)):a.length>0&&this._articulationByName.has(a)&&(this._articulationByName.get(a).staffLine=i.staffLine)}parseTechniqueSymbol(t){switch(t){case"pictEdgeOfCymbal":return l.PictEdgeOfCymbal;case"articStaccatoAbove":return l.ArticStaccatoAbove;case"noteheadParenthesis":return l.NoteheadParenthesis;case"stringsUpBow":return l.StringsUpBow;case"stringsDownBow":return l.StringsDownBow;case"guitarGolpe":return l.GuitarGolpe;default:return l.None}}parseNoteHead(t){switch(t){case"noteheadDoubleWholeSquare":return l.NoteheadDoubleWholeSquare;case"noteheadDoubleWhole":return l.NoteheadDoubleWhole;case"noteheadWhole":return l.NoteheadWhole;case"noteheadHalf":return l.NoteheadHalf;case"noteheadBlack":return l.NoteheadBlack;case"noteheadNull":return l.NoteheadNull;case"noteheadXOrnate":return l.NoteheadXOrnate;case"noteheadTriangleUpWhole":return l.NoteheadTriangleUpWhole;case"noteheadTriangleUpHalf":return l.NoteheadTriangleUpHalf;case"noteheadTriangleUpBlack":return l.NoteheadTriangleUpBlack;case"noteheadDiamondBlackWide":return l.NoteheadDiamondBlackWide;case"noteheadDiamondWhite":return l.NoteheadDiamondWhite;case"noteheadDiamondWhiteWide":return l.NoteheadDiamondWhiteWide;case"noteheadCircleX":return l.NoteheadCircleX;case"noteheadXWhole":return l.NoteheadXWhole;case"noteheadXHalf":return l.NoteheadXHalf;case"noteheadXBlack":return l.NoteheadXBlack;case"noteheadParenthesis":return l.NoteheadParenthesis;case"noteheadSlashedBlack2":return l.NoteheadSlashedBlack2;case"noteheadCircleSlash":return l.NoteheadCircleSlash;case"noteheadHeavyX":return l.NoteheadHeavyX;case"noteheadHeavyXHat":return l.NoteheadHeavyXHat;default:return x.warning("GPIF","Unknown notehead symbol",t),l.None}}parseStaves(t,e){let s=0;for(const i of e.childElements())"Staff"===i.localName&&(t.ensureStaveCount(s+1),this.parseStaff(t.staves[s],i),s++)}parseStaff(t,e){for(const s of e.childElements())"Properties"===s.localName&&this.parseStaffProperties(t,s)}parseStaffProperties(t,e){for(const s of e.childElements())"Property"===s.localName&&this.parseStaffProperty(t,s)}parseStaffProperty(t,e){switch(e.getAttribute("name")){case"Tuning":for(const a of e.childElements())switch(a.localName){case"Pitches":const n=M.splitSafe(e.findChildElement("Pitches")?.innerText),o=new Array(n.length);for(let h=0;h<o.length;h++)o[o.length-1-h]=M.parseIntSafe(n[h],0);t.stringTuning.tunings=o;break;case"Label":t.stringTuning.name=a.innerText}t.isPercussion||(t.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this.parseDiagramCollectionForStaff(t,e);break;case"CapoFret":const i=M.parseIntSafe(e.findChildElement("Fret")?.innerText,0);t.capo=i}}parseLyrics(t,e){const s=[];for(const i of e.childElements())"Line"===i.localName&&s.push(this.parseLyricsLine(i));this._lyricsByTrack.set(t,s)}parseLyricsLine(t){const e=new Li;for(const s of t.childElements())switch(s.localName){case"Offset":e.startBar=M.parseIntSafe(s.innerText,0);break;case"Text":e.text=s.innerText}return e}parseDiagramCollectionForTrack(t,e){const s=e.findChildElement("Items");if(s)for(const i of s.childElements())"Item"===i.localName&&this.parseDiagramItemForTrack(t,i)}parseDiagramCollectionForStaff(t,e){const s=e.findChildElement("Items");if(s)for(const i of s.childElements())"Item"===i.localName&&this.parseDiagramItemForStaff(t,i)}parseDiagramItemForTrack(t,e){const s=new Os,i=e.getAttribute("id");for(const a of t.staves)a.addChord(i,s);this.parseDiagramItemForChord(s,e)}parseDiagramItemForStaff(t,e){const s=new Os,i=e.getAttribute("id");t.addChord(i,s),this.parseDiagramItemForChord(s,e)}parseDiagramItemForChord(t,e){t.name=e.getAttribute("name");const s=e.findChildElement("Diagram");if(!s)return t.showDiagram=!1,void(t.showFingering=!1);const i=M.parseIntSafe(s.getAttribute("stringCount"),6),a=M.parseIntSafe(s.getAttribute("baseFret"),0);t.firstFret=a+1;for(let n=0;n<i;n++)t.strings.push(-1);for(const n of s.childElements())switch(n.localName){case"Fret":const o=M.parseIntSafe(n.getAttribute("string"),0);t.strings[i-o-1]=a+M.parseIntSafe(n.getAttribute("fret"),0);break;case"Fingering":const h=new Map;for(const c of n.childElements())if("Position"===c.localName){let d=Q.Unknown;const u=a+M.parseIntSafe(c.getAttribute("fret"),0);switch(c.getAttribute("finger")){case"Index":d=Q.IndexFinger;break;case"Middle":d=Q.MiddleFinger;break;case"Rank":d=Q.AnnularFinger;break;case"Pinky":d=Q.LittleFinger;break;case"Thumb":d=Q.Thumb}d!==Q.Unknown&&(h.has(d)?t.barreFrets.push(u):h.set(d,!0))}break;case"Property":switch(n.getAttribute("name")){case"ShowName":t.showName="true"===n.getAttribute("value");break;case"ShowDiagram":t.showDiagram="true"===n.getAttribute("value");break;case"ShowFingering":t.showFingering="true"===n.getAttribute("value")}}}parseTrackProperties(t,e){for(const s of e.childElements())"Property"===s.localName&&this.parseTrackProperty(t,s)}parseTrackProperty(t,e){switch(e.getAttribute("name")){case"Tuning":const i=M.splitSafe(e.findChildElement("Pitches")?.innerText),a=new Array(i.length);for(let o=0;o<a.length;o++)a[a.length-1-o]=M.parseIntSafe(i[o],0);for(const o of t.staves)o.stringTuning.tunings=a,o.showStandardNotation=!0,o.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this.parseDiagramCollectionForTrack(t,e);break;case"CapoFret":const n=M.parseIntSafe(e.findChildElement("Fret")?.innerText,0);for(const o of t.staves)o.capo=n}}parseGeneralMidi(t,e){for(const i of e.childElements())switch(i.localName){case"Program":t.playbackInfo.program=M.parseIntSafe(i.innerText,0);break;case"Port":t.playbackInfo.port=M.parseIntSafe(i.innerText,0);break;case"PrimaryChannel":t.playbackInfo.primaryChannel=M.parseIntSafe(i.innerText,0);break;case"SecondaryChannel":t.playbackInfo.secondaryChannel=M.parseIntSafe(i.innerText,0)}if("Percussion"===e.getAttribute("table"))for(const i of t.staves)i.isPercussion=!0}parseSounds(t,e,s){for(const i of s.childElements())"Sound"===i.localName&&this.parseSound(t,e,i)}parseSound(t,e,s){const i=new bh;for(const a of s.childElements())switch(a.localName){case"Name":i.name=a.innerText;break;case"Path":i.path=a.innerText;break;case"Role":i.role=a.innerText;break;case"MIDI":this.parseSoundMidi(i,a)}("Factory"===i.role||0===e.playbackInfo.program)&&(e.playbackInfo.program=i.program),this._soundsByTrack.has(t)||this._soundsByTrack.set(t,new Map),this._soundsByTrack.get(t).set(i.uniqueId,i)}parseSoundMidi(t,e){for(const s of e.childElements())"Program"===s.localName&&(t.program=M.parseIntSafe(s.innerText,0))}parsePartSounding(t,e){for(const s of e.childElements())if("TranspositionPitch"===s.localName)for(const i of t.staves)i.displayTranspositionPitch=M.parseIntSafe(s.innerText,0)}parseTranspose(t,e){let s=0,i=0;for(const a of e.childElements())switch(a.localName){case"Chromatic":i=M.parseIntSafe(a.innerText,0);break;case"Octave":s=M.parseIntSafe(a.innerText,0)}for(const a of t.staves)a.displayTranspositionPitch=12*s+i}parseRSE(t,e){for(const s of e.childElements())"ChannelStrip"===s.localName&&this.parseChannelStrip(t,s)}parseChannelStrip(t,e){for(const s of e.childElements())"Parameters"===s.localName&&this.parseChannelStripParameters(t,s)}parseChannelStripParameters(t,e){if(e.firstChild&&e.firstChild.value){const s=M.splitSafe(e.firstChild.value);s.length>=12&&(t.playbackInfo.balance=Math.floor(16*M.parseFloatSafe(s[11],.5)),t.playbackInfo.volume=Math.floor(16*M.parseFloatSafe(s[12],.9)))}}parseMasterBarsNode(t){for(const e of t.childElements())"MasterBar"===e.localName&&this.parseMasterBar(e)}parseMasterBar(t){const e=new Ps;0===this._masterBars.length&&this._hasAnacrusis&&(e.isAnacrusis=!0);for(const s of t.childElements())switch(s.localName){case"Time":const i=s.innerText.split("/");e.timeSignatureNumerator=M.parseIntSafe(i[0],4),e.timeSignatureDenominator=M.parseIntSafe(i[1],4);break;case"FreeTime":e.isFreeTime=!0;break;case"DoubleBar":e.isDoubleBar=!0,this._doubleBars.add(e);break;case"Section":e.section=new Fi,e.section.marker=s.findChildElement("Letter")?.innerText??"",e.section.text=s.findChildElement("Text")?.innerText??"";break;case"Repeat":"true"===s.getAttribute("start").toLowerCase()&&(e.isRepeatStart=!0),"true"===s.getAttribute("end").toLowerCase()&&s.getAttribute("count")&&(e.repeatCount=M.parseIntSafe(s.getAttribute("count"),1));break;case"AlternateEndings":const a=M.splitSafe(s.innerText);let n=0;for(let d=0;d<a.length;d++)n|=1<<-1+M.parseIntSafe(a[d],0);e.alternateEndings=n;break;case"Bars":this._barsOfMasterBar.push(M.splitSafe(s.innerText));break;case"TripletFeel":switch(s.innerText){case"NoTripletFeel":e.tripletFeel=ue.NoTripletFeel;break;case"Triplet8th":e.tripletFeel=ue.Triplet8th;break;case"Triplet16th":e.tripletFeel=ue.Triplet16th;break;case"Dotted8th":e.tripletFeel=ue.Dotted8th;break;case"Dotted16th":e.tripletFeel=ue.Dotted16th;break;case"Scottish8th":e.tripletFeel=ue.Scottish8th;break;case"Scottish16th":e.tripletFeel=ue.Scottish16th}break;case"Key":const o=M.parseIntSafe(s.findChildElement("AccidentalCount")?.innerText,0),h=s.findChildElement("Mode");let c=It.Major;if(h)switch(h.innerText.toLowerCase()){case"major":c=It.Major;break;case"minor":c=It.Minor}this._keySignatures.set(this._masterBars.length,[o,c]);break;case"Fermatas":this.parseFermatas(e,s);break;case"XProperties":this.parseMasterBarXProperties(e,s);break;case"Directions":this.parseDirections(e,s)}this._masterBars.push(e)}parseDirections(t,e){for(const s of e.childElements())switch(s.localName){case"Target":switch(s.innerText){case"Coda":t.addDirection(I.TargetCoda);break;case"DoubleCoda":t.addDirection(I.TargetDoubleCoda);break;case"Segno":t.addDirection(I.TargetSegno);break;case"SegnoSegno":t.addDirection(I.TargetSegnoSegno);break;case"Fine":t.addDirection(I.TargetFine)}break;case"Jump":switch(s.innerText){case"DaCapo":t.addDirection(I.JumpDaCapo);break;case"DaCapoAlCoda":t.addDirection(I.JumpDaCapoAlCoda);break;case"DaCapoAlDoubleCoda":t.addDirection(I.JumpDaCapoAlDoubleCoda);break;case"DaCapoAlFine":t.addDirection(I.JumpDaCapoAlFine);break;case"DaSegno":t.addDirection(I.JumpDalSegno);break;case"DaSegnoAlCoda":t.addDirection(I.JumpDalSegnoAlCoda);break;case"DaSegnoAlDoubleCoda":t.addDirection(I.JumpDalSegnoAlDoubleCoda);break;case"DaSegnoAlFine":t.addDirection(I.JumpDalSegnoAlFine);break;case"DaSegnoSegno":t.addDirection(I.JumpDalSegnoSegno);break;case"DaSegnoSegnoAlCoda":t.addDirection(I.JumpDalSegnoSegnoAlCoda);break;case"DaSegnoSegnoAlDoubleCoda":t.addDirection(I.JumpDalSegnoSegnoAlDoubleCoda);break;case"DaSegnoSegnoAlFine":t.addDirection(I.JumpDalSegnoSegnoAlFine);break;case"DaCoda":t.addDirection(I.JumpDaCoda);break;case"DaDoubleCoda":t.addDirection(I.JumpDaDoubleCoda)}}}parseFermatas(t,e){for(const s of e.childElements())"Fermata"===s.localName&&this.parseFermata(t,s)}parseFermata(t,e){let s=0;const i=new Ei;for(const a of e.childElements())switch(a.localName){case"Type":switch(a.innerText){case"Short":i.type=Ct.Short;break;case"Medium":i.type=Ct.Medium;break;case"Long":i.type=Ct.Long}break;case"Length":i.length=M.parseFloatSafe(a.innerText,0);break;case"Offset":const n=a.innerText.split("/");2===n.length&&(s=M.parseIntSafe(n[0],4)/M.parseIntSafe(n[1],4)*C.QuarterTime|0)}t.addFermata(s,i)}parseBars(t){for(const e of t.childElements())"Bar"===e.localName&&this.parseBar(e)}parseBar(t){const e=new Ts,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Voices":this._voicesOfBar.set(s,M.splitSafe(i.innerText));break;case"Clef":switch(i.innerText){case"Neutral":e.clef=Se.Neutral;break;case"G2":e.clef=Se.G2;break;case"F4":e.clef=Se.F4;break;case"C4":e.clef=Se.C4;break;case"C3":e.clef=Se.C3}break;case"Ottavia":switch(i.innerText){case"8va":e.clefOttava=le._8va;break;case"15ma":e.clefOttava=le._15ma;break;case"8vb":e.clefOttava=le._8vb;break;case"15mb":e.clefOttava=le._15mb}break;case"SimileMark":switch(i.innerText){case"Simple":e.simileMark=je.Simple;break;case"FirstOfDouble":e.simileMark=je.FirstOfDouble;break;case"SecondOfDouble":e.simileMark=je.SecondOfDouble}break;case"XProperties":this.parseBarXProperties(i,e)}this._barsById.set(s,e)}parseVoices(t){for(const e of t.childElements())"Voice"===e.localName&&this.parseVoice(e)}parseVoice(t){const e=new es,s=t.getAttribute("id");for(const i of t.childElements())"Beats"===i.localName&&this._beatsOfVoice.set(s,M.splitSafe(i.innerText));this._voiceById.set(s,e)}parseBeats(t){for(const e of t.childElements())"Beat"===e.localName&&this.parseBeat(e)}parseBeat(t){const e=new xt,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Notes":this._notesOfBeat.set(s,M.splitSafe(i.innerText));break;case"Rhythm":this._rhythmOfBeat.set(s,i.getAttribute("ref"));break;case"Fadding":switch(i.innerText){case"FadeIn":e.fade=ct.FadeIn;break;case"FadeOut":e.fade=ct.FadeOut;break;case"VolumeSwell":e.fade=ct.VolumeSwell}break;case"Tremolo":switch(i.innerText){case"1/2":e.tremoloSpeed=m.Eighth;break;case"1/4":e.tremoloSpeed=m.Sixteenth;break;case"1/8":e.tremoloSpeed=m.ThirtySecond}break;case"Chord":e.chordId=i.innerText;break;case"Hairpin":switch(i.innerText){case"Crescendo":e.crescendo=Ft.Crescendo;break;case"Decrescendo":e.crescendo=Ft.Decrescendo}break;case"Arpeggio":e.brushType="Up"===i.innerText?V.ArpeggioUp:V.ArpeggioDown;break;case"Properties":this.parseBeatProperties(i,e);break;case"XProperties":this.parseBeatXProperties(i,e);break;case"FreeText":e.text=i.innerText;break;case"TransposedPitchStemOrientation":switch(i.innerText){case"Upward":e.preferredBeamDirection=P.Up;break;case"Downward":e.preferredBeamDirection=P.Down}break;case"Dynamic":switch(i.innerText){case"PPP":e.dynamics=J.PPP;break;case"PP":e.dynamics=J.PP;break;case"P":e.dynamics=J.P;break;case"MP":e.dynamics=J.MP;break;case"MF":e.dynamics=J.MF;break;case"F":e.dynamics=J.F;break;case"FF":e.dynamics=J.FF;break;case"FFF":e.dynamics=J.FFF}break;case"GraceNotes":switch(i.innerText){case"OnBeat":e.graceType=K.OnBeat;break;case"BeforeBeat":e.graceType=K.BeforeBeat}break;case"Legato":"true"===i.getAttribute("origin")&&(e.isLegatoOrigin=!0);break;case"Whammy":const a=new R(0,0);a.value=this.toBendValue(M.parseFloatSafe(i.getAttribute("originValue"),0)),a.offset=this.toBendOffset(M.parseFloatSafe(i.getAttribute("originOffset"),0)),e.addWhammyBarPoint(a);const n=new R(0,0);n.value=this.toBendValue(M.parseFloatSafe(i.getAttribute("middleValue"),0)),n.offset=this.toBendOffset(M.parseFloatSafe(i.getAttribute("middleOffset1"),0)),e.addWhammyBarPoint(n);const o=new R(0,0);o.value=this.toBendValue(M.parseFloatSafe(i.getAttribute("middleValue"),0)),o.offset=this.toBendOffset(M.parseFloatSafe(i.getAttribute("middleOffset2"),0)),e.addWhammyBarPoint(o);const h=new R(0,0);h.value=this.toBendValue(M.parseFloatSafe(i.getAttribute("destinationValue"),0)),h.offset=this.toBendOffset(M.parseFloatSafe(i.getAttribute("destinationOffset"),0)),e.addWhammyBarPoint(h);break;case"Ottavia":switch(i.innerText){case"8va":e.ottava=le._8va;break;case"8vb":e.ottava=le._8vb;break;case"15ma":e.ottava=le._15ma;break;case"15mb":e.ottava=le._15mb}break;case"Lyrics":e.lyrics=this.parseBeatLyrics(i),this._skipApplyLyrics=!0;break;case"Slashed":e.slashed=!0;break;case"DeadSlapped":e.deadSlapped=!0;break;case"Golpe":switch(i.innerText){case"Finger":e.golpe=Gt.Finger;break;case"Thumb":e.golpe=Gt.Thumb}break;case"Wah":switch(i.innerText){case"Open":e.wahPedal=Jt.Open;break;case"Closed":e.wahPedal=Jt.Closed}break;case"UserTransposedPitchStemOrientation":switch(i.innerText){case"Downward":e.preferredBeamDirection=P.Down;break;case"Upward":e.preferredBeamDirection=P.Up}break;case"Timer":e.showTimer=!0,e.timer=M.parseIntSafe(i.innerText,-1),e.timer<0&&(e.timer=null)}this._beatById.set(s,e)}parseBeatLyrics(t){const e=[];for(const s of t.childElements())"Line"===s.localName&&e.push(s.innerText);return e}parseBeatXProperties(t,e){for(const s of t.childElements())if("XProperty"===s.localName){let a=0;switch(s.getAttribute("id")){case"1124204546":switch(a=M.parseIntSafe(s.findChildElement("Int")?.innerText,0),a){case 1:e.beamingMode=ze.ForceMergeWithNext;break;case 2:e.beamingMode=ze.ForceSplitToNext}break;case"1124204552":1===(a=M.parseIntSafe(s.findChildElement("Int")?.innerText,0),a)&&e.beamingMode!==ze.ForceSplitToNext&&(e.beamingMode=ze.ForceSplitOnSecondaryToNext);break;case"1124204545":a=M.parseIntSafe(s.findChildElement("Int")?.innerText,0),e.invertBeamDirection=1===a;break;case"687935489":a=M.parseIntSafe(s.findChildElement("Int")?.innerText,0),e.brushDuration=a}}}parseBarXProperties(t,e){for(const s of t.childElements())if("XProperty"===s.localName&&"1124139520"===s.getAttribute("id")){const a=s.findChildElement("Double")??s.findChildElement("Float");e.displayScale=M.parseFloatSafe(a?.innerText,1)}}parseMasterBarXProperties(t,e){for(const s of e.childElements())"XProperty"===s.localName&&"1124073984"===s.getAttribute("id")&&(t.displayScale=M.parseFloatSafe(s.findChildElement("Double")?.innerText,1))}parseBeatProperties(t,e){let s=!1,i=null,a=null,n=null,o=null,h=null;for(const c of t.childElements())if("Property"===c.localName)switch(c.getAttribute("name")){case"Brush":e.brushType="Up"===c.findChildElement("Direction")?.innerText?V.BrushUp:V.BrushDown;break;case"PickStroke":e.pickStroke="Up"===c.findChildElement("Direction")?.innerText?yt.Up:yt.Down;break;case"Slapped":c.findChildElement("Enable")&&(e.slap=!0);break;case"Popped":c.findChildElement("Enable")&&(e.pop=!0);break;case"VibratoWTremBar":switch(c.findChildElement("Strength")?.innerText){case"Wide":e.vibrato=ke.Wide;break;case"Slight":e.vibrato=ke.Slight}break;case"WhammyBar":s=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":i||(i=new R(0,0)),i.value=this.toBendValue(M.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarOriginOffset":i||(i=new R(0,0)),i.offset=this.toBendOffset(M.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleValue":a=this.toBendValue(M.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset1":n=this.toBendOffset(M.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset2":o=this.toBendOffset(M.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationValue":h||(h=new R(R.MaxPosition,0)),h.value=this.toBendValue(M.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationOffset":h||(h=new R(0,0)),h.offset=this.toBendOffset(M.parseFloatSafe(c.findChildElement("Float")?.innerText,0));break;case"BarreFret":e.barreFret=M.parseIntSafe(c.findChildElement("Fret")?.innerText,0);break;case"BarreString":switch(c.findChildElement("String")?.innerText){case"0":e.barreShape=qt.Full;break;case"1":e.barreShape=qt.Half}break;case"Rasgueado":switch(c.findChildElement("Rasgueado")?.innerText){case"ii_1":e.rasgueado=G.Ii;break;case"mi_1":e.rasgueado=G.Mi;break;case"mii_1":e.rasgueado=G.MiiTriplet;break;case"mii_2":e.rasgueado=G.MiiAnapaest;break;case"pmp_1":e.rasgueado=G.PmpTriplet;break;case"pmp_2":e.rasgueado=G.PmpAnapaest;break;case"pei_1":e.rasgueado=G.PeiTriplet;break;case"pei_2":e.rasgueado=G.PeiAnapaest;break;case"pai_1":e.rasgueado=G.PaiTriplet;break;case"pai_2":e.rasgueado=G.PaiAnapaest;break;case"ami_1":e.rasgueado=G.AmiTriplet;break;case"ami_2":e.rasgueado=G.AmiAnapaest;break;case"ppp_1":e.rasgueado=G.Ppp;break;case"amii_1":e.rasgueado=G.Amii;break;case"amip_1":e.rasgueado=G.Amip;break;case"eami_1":e.rasgueado=G.Eami;break;case"eamii_1":e.rasgueado=G.Eamii;break;case"peami_1":e.rasgueado=G.Peami}}s&&(i||(i=new R(0,0)),h||(h=new R(R.MaxPosition,0)),e.addWhammyBarPoint(i),n&&a&&e.addWhammyBarPoint(new R(n,a)),o&&a&&e.addWhammyBarPoint(new R(o,a)),!n&&!o&&a&&e.addWhammyBarPoint(new R(R.MaxPosition/2|0,a)),e.addWhammyBarPoint(h))}parseNotes(t){for(const e of t.childElements())"Note"===e.localName&&this.parseNote(e)}parseNote(t){const e=new ts,s=t.getAttribute("id");for(const i of t.childElements())switch(i.localName){case"Properties":this.parseNoteProperties(i,e,s);break;case"AntiAccent":"normal"===i.innerText.toLowerCase()&&(e.isGhost=!0);break;case"LetRing":e.isLetRing=!0;break;case"Trill":e.trillValue=M.parseIntSafe(i.innerText,-1),e.trillSpeed=m.Sixteenth;break;case"Accent":const a=M.parseIntSafe(i.innerText,0);!!(1&a)&&(e.isStaccato=!0),!!(4&a)&&(e.accentuated=et.Heavy),!!(8&a)&&(e.accentuated=et.Normal),16&a&&(e.accentuated=et.Tenuto);break;case"Tie":"true"===i.getAttribute("destination").toLowerCase()&&(e.isTieDestination=!0);break;case"Vibrato":switch(i.innerText){case"Slight":e.vibrato=ke.Slight;break;case"Wide":e.vibrato=ke.Wide}break;case"LeftFingering":switch(i.innerText){case"P":e.leftHandFinger=Q.Thumb;break;case"I":e.leftHandFinger=Q.IndexFinger;break;case"M":e.leftHandFinger=Q.MiddleFinger;break;case"A":e.leftHandFinger=Q.AnnularFinger;break;case"C":e.leftHandFinger=Q.LittleFinger}break;case"RightFingering":switch(i.innerText){case"P":e.rightHandFinger=Q.Thumb;break;case"I":e.rightHandFinger=Q.IndexFinger;break;case"M":e.rightHandFinger=Q.MiddleFinger;break;case"A":e.rightHandFinger=Q.AnnularFinger;break;case"C":e.rightHandFinger=Q.LittleFinger}break;case"InstrumentArticulation":e.percussionArticulation=M.parseIntSafe(i.innerText,0);break;case"Ornament":switch(i.innerText){case"Turn":e.ornament=tt.Turn;break;case"InvertedTurn":e.ornament=tt.InvertedTurn;break;case"UpperMordent":e.ornament=tt.UpperMordent;break;case"LowerMordent":e.ornament=tt.LowerMordent}}this._noteById.set(s,e)}parseNoteProperties(t,e,s){let i=!1,a=null,n=null,o=null,h=null,c=null,d=-1,u=-1;for(const f of t.childElements())if("Property"===f.localName)switch(f.getAttribute("name")){case"ShowStringNumber":f.findChildElement("Enable")&&(e.showStringNumber=!0);break;case"String":e.string=M.parseIntSafe(f.findChildElement("String")?.innerText,0)+1;break;case"Fret":e.fret=M.parseIntSafe(f.findChildElement("Fret")?.innerText,0);break;case"Element":d=M.parseIntSafe(f.findChildElement("Element")?.innerText,0);break;case"Variation":u=M.parseIntSafe(f.findChildElement("Variation")?.innerText,0);break;case"Tapped":this._tappedNotes.set(s,!0);break;case"HarmonicType":const g=f.findChildElement("HType");if(g)switch(g.innerText){case"NoHarmonic":e.harmonicType=Z.None;break;case"Natural":e.harmonicType=Z.Natural;break;case"Artificial":e.harmonicType=Z.Artificial;break;case"Pinch":e.harmonicType=Z.Pinch;break;case"Tap":e.harmonicType=Z.Tap;break;case"Semi":e.harmonicType=Z.Semi;break;case"Feedback":e.harmonicType=Z.Feedback}break;case"HarmonicFret":const b=f.findChildElement("HFret");b&&(e.harmonicValue=M.parseFloatSafe(b.innerText,0));break;case"Muted":f.findChildElement("Enable")&&(e.isDead=!0);break;case"PalmMuted":f.findChildElement("Enable")&&(e.isPalmMute=!0);break;case"Octave":e.octave=M.parseIntSafe(f.findChildElement("Number")?.innerText,0),-1===e.tone&&(e.tone=0);break;case"Tone":e.tone=M.parseIntSafe(f.findChildElement("Step")?.innerText,0);break;case"ConcertPitch":this.parseConcertPitch(f,e);break;case"Bended":i=!0;break;case"BendOriginValue":a||(a=new R(0,0)),a.value=this.toBendValue(M.parseFloatSafe(f.findChildElement("Float")?.innerText,0));break;case"BendOriginOffset":a||(a=new R(0,0)),a.offset=this.toBendOffset(M.parseFloatSafe(f.findChildElement("Float")?.innerText,0));break;case"BendMiddleValue":n=this.toBendValue(M.parseFloatSafe(f.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset1":o=this.toBendOffset(M.parseFloatSafe(f.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset2":h=this.toBendOffset(M.parseFloatSafe(f.findChildElement("Float")?.innerText,0));break;case"BendDestinationValue":c||(c=new R(R.MaxPosition,0)),c.value=this.toBendValue(M.parseFloatSafe(f.findChildElement("Float")?.innerText,0));break;case"BendDestinationOffset":c||(c=new R(0,0)),c.offset=this.toBendOffset(M.parseFloatSafe(f.findChildElement("Float")?.innerText,0));break;case"HopoOrigin":f.findChildElement("Enable")&&(e.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":e.isLeftHandTapped=!0;break;case"Slide":const w=M.parseIntSafe(f.findChildElement("Flags")?.innerText,0);1&w?e.slideOutType=ce.Shift:2&w?e.slideOutType=ce.Legato:4&w?e.slideOutType=ce.OutDown:!!(8&w)&&(e.slideOutType=ce.OutUp),16&w?e.slideInType=ut.IntoFromBelow:!!(32&w)&&(e.slideInType=ut.IntoFromAbove),64&w?e.slideOutType=ce.PickSlideDown:128&w&&(e.slideOutType=ce.PickSlideUp)}i&&(a||(a=new R(0,0)),c||(c=new R(R.MaxPosition,0)),e.addBendPoint(a),o&&n&&e.addBendPoint(new R(o,n)),h&&n&&e.addBendPoint(new R(h,n)),!o&&!h&&n&&e.addBendPoint(new R(R.MaxPosition/2|0,n)),e.addBendPoint(c)),-1!==d&&-1!==u&&(e.percussionArticulation=ht.articulationFromElementVariation(d,u))}parseConcertPitch(t,e){const s=t.findChildElement("Pitch");if(s)for(const i of s.childElements())if("Accidental"===i.localName)switch(i.innerText){case"x":e.accidentalMode=ge.ForceDoubleSharp;break;case"#":e.accidentalMode=ge.ForceSharp;break;case"b":e.accidentalMode=ge.ForceFlat;break;case"bb":e.accidentalMode=ge.ForceDoubleFlat}}toBendValue(t){return t*M.BendPointValueFactor|0}toBendOffset(t){return t*M.BendPointPositionFactor}parseRhythms(t){for(const e of t.childElements())"Rhythm"===e.localName&&this.parseRhythm(e)}parseRhythm(t){const e=new yh,s=t.getAttribute("id");e.id=s;for(const i of t.childElements())switch(i.localName){case"NoteValue":switch(i.innerText){case"Long":e.value=m.QuadrupleWhole;break;case"DoubleWhole":e.value=m.DoubleWhole;break;case"Whole":e.value=m.Whole;break;case"Half":e.value=m.Half;break;case"Quarter":e.value=m.Quarter;break;case"Eighth":e.value=m.Eighth;break;case"16th":e.value=m.Sixteenth;break;case"32nd":e.value=m.ThirtySecond;break;case"64th":e.value=m.SixtyFourth;break;case"128th":e.value=m.OneHundredTwentyEighth;break;case"256th":e.value=m.TwoHundredFiftySixth}break;case"PrimaryTuplet":e.tupletNumerator=M.parseIntSafe(i.getAttribute("num"),-1),e.tupletDenominator=M.parseIntSafe(i.getAttribute("den"),-1);break;case"AugmentationDot":e.dots=M.parseIntSafe(i.getAttribute("count"),0)}this._rhythmById.set(s,e)}buildModel(){for(let s=0,i=this._masterBars.length;s<i;s++)this.score.addMasterBar(this._masterBars[s]);const t=this._masterBars[this._masterBars.length-1];this._doubleBars.has(t)&&(this._doubleBars.delete(t),t.isDoubleBar=!1);for(const s of this._tracksMapping){if(!s)continue;const i=this._tracksById.get(s);this.score.addTrack(i)}let e;for(const s of this._barsOfMasterBar){let i=0;e=[ye.C,It.Major];for(let a=0,n=0;a<s.length&&n<this.score.tracks.length;a++){const o=s[a];if(o!==M.InvalidId){const h=this._barsById.get(o),c=this.score.tracks[n],d=c.staves[i];d.addBar(h);const u=d.bars.length-1;if(this._keySignatures.has(u)&&(e=this._keySignatures.get(u)),h.keySignature=e[0],h.keySignatureType=e[1],this._doubleBars.has(h.masterBar)&&(h.barLineRight=te.LightLight),this._voicesOfBar.has(o))for(const f of this._voicesOfBar.get(o))if(f!==M.InvalidId){const p=this._voiceById.get(f);if(h.addVoice(p),this._beatsOfVoice.has(f))for(const g of this._beatsOfVoice.get(f))if(g!==M.InvalidId){const b=xa.clone(this._beatById.get(g));p.addBeat(b);const w=this._rhythmOfBeat.get(g),S=this._rhythmById.get(w);if(b.duration=S.value,b.dots=S.dots,b.tupletNumerator=S.tupletNumerator,b.tupletDenominator=S.tupletDenominator,this._notesOfBeat.has(g))for(const D of this._notesOfBeat.get(g))if(D!==M.InvalidId){const N=Gn.clone(this._noteById.get(D));d.isPercussion?(N.fret=-1,N.string=-1):N.percussionArticulation=-1,b.addNote(N),this._tappedNotes.has(D)&&(b.tap=!0)}}}else{const p=new es;h.addVoice(p);const g=new xt;g.isEmpty=!0,g.duration=m.Quarter,p.addBeat(g)}i===c.staves.length-1?(n++,i=0,e=[ye.C,It.Major]):(i++,e=[ye.C,It.Major])}else n++}}for(const s of this._tracksMapping){if(!s)continue;const i=this._tracksById.get(s);let a=!1;for(const n of i.staves)if(n.isPercussion){a=!0;break}if(a||(i.percussionArticulations=[]),this._automationsPerTrackIdAndBarIndex.has(s)){const n=this._automationsPerTrackIdAndBarIndex.get(s);for(const[o,h]of n)if(i.staves.length>0&&o<i.staves[0].bars.length){const c=i.staves[0].bars[o];if(c.voices.length>0&&c.voices[0].beats.length>0){const d=c.voices[0].beats[0];for(const u of h)d.automations.push(u)}}}if(this._sustainPedalsPerTrackIdAndBarIndex.has(s)){const n=this._sustainPedalsPerTrackIdAndBarIndex.get(s);for(const[o,h]of n)i.staves.length>0&&o<i.staves[0].bars.length&&(i.staves[0].bars[o].sustainPedals=h)}}for(const[s,i]of this._masterTrackAutomations){const a=this.score.masterBars[s];for(let n=0,o=i.length;n<o;n++){const h=i[n];switch(h.type){case Ge.Tempo:0===s&&(this.score.tempo=0|h.value,h.text&&(this.score.tempoLabel=h.text)),a.tempoAutomations.push(h);break;case Ge.SyncPoint:h.syncPointValue.millisecondOffset-=this._backingTrackPadding,a.addSyncPoint(h)}}}}}M.InvalidId="-1",M.BendPointPositionFactor=R.MaxPosition/100,M.BendPointValueFactor=.04,M.SampleRate=44100;class Da{constructor(){this.isMultiRest=!1,this.trackViewGroups=[]}}class Yn{constructor(){this.showNumbered=!1,this.showSlash=!1,this.showStandardNotation=!1,this.showTablature=!1}}class La{apply(t){if(this.scoreViews.length>0){let e=0;t.stylesheet.multiTrackMultiBarRest=this.scoreViews[0].isMultiRest;for(const s of this.scoreViews[0].trackViewGroups){if(e<t.tracks.length){const i=t.tracks[e];for(const a of i.staves)a.showTablature=s.showTablature,a.showStandardNotation=s.showStandardNotation,a.showSlash=s.showSlash,a.showNumbered=s.showNumbered}e++}for(let s=1;s<this.scoreViews.length;s++)this.scoreViews[s].isMultiRest&&(t.stylesheet.perTrackMultiBarRest||(t.stylesheet.perTrackMultiBarRest=new Set),e=s-1,t.stylesheet.perTrackMultiBarRest.add(e))}}constructor(t){this.scoreViews=[];const e=Ke.fromBuffer(t),s=k.readInt32BE(e);for(let i=0;i<s;i++){const a=new Da;this.scoreViews.push(a),a.isMultiRest=Te.gpReadBool(e);const n=k.readInt32BE(e);for(let o=0;o<n;o++){let h=e.readByte();0===h&&(h=1);const c=new Yn;c.showStandardNotation=!!(1&h),c.showTablature=!!(2&h),c.showSlash=!!(4&h),c.showNumbered=!!(8&h),a.trackViewGroups.push(c)}}}static writeForScore(t){const e=Ke.withCapacity(128),s=[new Da];s[0].isMultiRest=t.stylesheet.multiTrackMultiBarRest;for(const i of t.tracks){const a=new Yn;a.showStandardNotation=i.staves[0].showStandardNotation,a.showTablature=i.staves[0].showTablature,a.showSlash=i.staves[0].showSlash,a.showNumbered=i.staves[0].showNumbered,s[0].trackViewGroups.push(a);const n=new Da;n.isMultiRest=!0===t.stylesheet.perTrackMultiBarRest?.has(i.index),n.trackViewGroups.push(a),s.push(n)}k.writeInt32BE(e,s.length);for(const i of s){e.writeByte(i.isMultiRest?1:0),k.writeInt32BE(e,i.trackViewGroups.length);for(const a of i.trackViewGroups){let n=0;a.showStandardNotation&&(n|=1),a.showTablature&&(n|=2),a.showSlash&&(n|=4),a.showNumbered&&(n|=8),e.writeByte(n)}}return k.writeInt32BE(e,1),e.toArray()}}let Fa=class{};class Pr extends Fa{constructor(t){super(),this.n=t}}class yi extends Fa{constructor(t,e){super(),this.left=t,this.right=e}}class Ea extends Fa{constructor(t,e){super(),this.n=t,this.table=e}}class Dt{static make(t,e,s,i){const a=[],n=[];if(i>32)throw new ft("Invalid huffman");for(let c=0;c<i;c++)a.push(0),n.push(0);for(let c=0;c<s;c++){const d=t[c+e];if(d>=i)throw new ft("Invalid huffman");a[d]++}let o=0;for(let c=1;c<i-1;c++)o=o+a[c]<<1,n[c]=o;const h=new Map;for(let c=0;c<s;c++){const d=t[c+e];if(0!==d){const u=n[d-1];n[d-1]=u+1,h.set(u<<5|d,c)}}return Dt.treeCompress(new yi(Dt.treeMake(h,i,0,1),Dt.treeMake(h,i,1,1)))}static treeMake(t,e,s,i){if(i>e)throw new ft("Invalid huffman");const a=s<<5|i;return t.has(a)?new Pr(t.get(a)):new yi(Dt.treeMake(t,e,s<<=1,i+=1),Dt.treeMake(t,e,1|s,i))}static treeCompress(t){const e=Dt.treeDepth(t);if(0===e)return t;if(1===e){if(t instanceof yi)return new yi(Dt.treeCompress(t.left),Dt.treeCompress(t.right));throw new ft("assert")}const s=1<<e,i=[];for(let a=0;a<s;a++)i.push(new Pr(-1));return Dt.treeWalk(i,0,0,e,t),new Ea(e,i)}static treeWalk(t,e,s,i,a){a instanceof yi&&i>0?(Dt.treeWalk(t,e,s+1,i-1,a.left),Dt.treeWalk(t,e|1<<s,s+1,i-1,a.right)):t[e]=Dt.treeCompress(a)}static treeDepth(t){if(t instanceof Pr)return 0;if(t instanceof Ea)throw new ft("assert");if(t instanceof yi){const e=Dt.treeDepth(t.left),s=Dt.treeDepth(t.right);return 1+(e<s?e:s)}return 0}}var pt=function(r){return r[r.Head=0]="Head",r[r.Block=1]="Block",r[r.CData=2]="CData",r[r.Flat=3]="Flat",r[r.Crc=4]="Crc",r[r.Dist=5]="Dist",r[r.DistOne=6]="DistOne",r[r.Done=7]="Done",r}(pt||{});let Sh=(()=>{class r{constructor(){this.buffer=new Uint8Array(r.BufferSize),this.pos=0}slide(){const e=new Uint8Array(r.BufferSize);this.pos-=r.Size,e.set(this.buffer.subarray(r.Size,r.Size+this.pos),0),this.buffer=e}addBytes(e,s,i){this.pos+i>r.BufferSize&&this.slide(),this.buffer.set(e.subarray(s,s+i),this.pos),this.pos+=i}addByte(e){this.pos===r.BufferSize&&this.slide(),this.buffer[this.pos]=e,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}}return r.Size=32768,r.BufferSize=65536,r})();class Rt{static buildFixedHuffman(){const t=[];for(let e=0;e<288;e++)t.push(e<=143?8:e<=255?9:e<=279?7:8);return Dt.make(t,0,288,10)}constructor(t){this._nbits=0,this._bits=0,this._state=pt.Block,this._isFinal=!1,this._huffman=Rt._fixedHuffman,this._huffdist=null,this._len=0,this._dist=0,this._needed=0,this._output=null,this._outpos=0,this._lengths=[],this._window=new Sh,this._input=t;for(let e=0;e<19;e++)this._lengths.push(-1)}readBytes(t,e,s){if(this._needed=s,this._outpos=e,this._output=t,s>0)for(;this.inflateLoop(););return s-this._needed}inflateLoop(){switch(this._state){case pt.Head:const t=this._input.readByte();if(8!=(15&t))throw new ft("Invalid data");const s=this._input.readByte(),i=!!(32&s);if(((t<<8)+s)%31!=0)throw new ft("Invalid data");if(i)throw new ft("Unsupported dictionary");return this._state=pt.Block,!0;case pt.Crc:return this._state=pt.Done,!0;case pt.Done:return!1;case pt.Block:switch(this._isFinal=this.getBit(),this.getBits(2)){case 0:if(this._len=k.readUInt16LE(this._input),k.readUInt16LE(this._input)!==65535-this._len)throw new ft("Invalid data");this._state=pt.Flat;const d=this.inflateLoop();return this.resetBits(),d;case 1:return this._huffman=Rt._fixedHuffman,this._huffdist=null,this._state=pt.CData,!0;case 2:const u=this.getBits(5)+257,f=this.getBits(5)+1,p=this.getBits(4)+4;for(let b=0;b<p;b++)this._lengths[Rt.CodeLengthsPos[b]]=this.getBits(3);for(let b=p;b<19;b++)this._lengths[Rt.CodeLengthsPos[b]]=0;this._huffman=Dt.make(this._lengths,0,19,8);const g=[];for(let b=0;b<u+f;b++)g.push(0);return this.inflateLengths(g,u+f),this._huffdist=Dt.make(g,u,f,16),this._huffman=Dt.make(g,0,u,16),this._state=pt.CData,!0;default:throw new ft("Invalid data")}case pt.Flat:{const c=this._len<this._needed?this._len:this._needed,d=k.readByteArray(this._input,c);return this._len-=c,this.addBytes(d,0,c),0===this._len&&(this._state=this._isFinal?pt.Crc:pt.Block),this._needed>0}case pt.DistOne:{const c=this._len<this._needed?this._len:this._needed;return this.addDistOne(c),this._len-=c,0===this._len&&(this._state=pt.CData),this._needed>0}case pt.Dist:for(;this._len>0&&this._needed>0;){const c=this._len<this._dist?this._len:this._dist,d=this._needed<c?this._needed:c;this.addDist(this._dist,d),this._len-=d}return 0===this._len&&(this._state=pt.CData),this._needed>0;case pt.CData:let a=this.applyHuffman(this._huffman);if(a<256)return this.addByte(a),this._needed>0;if(256===a)return this._state=this._isFinal?pt.Crc:pt.Block,!0;a=a-257&255;let n=Rt.LenExtraBitsTbl[a];if(-1===n)throw new ft("Invalid data");this._len=Rt.LenBaseValTbl[a]+this.getBits(n);const o=this._huffdist,h=o?this.applyHuffman(o):this.getRevBits(5);if(n=Rt.DistExtraBitsTbl[h],-1===n)throw new ft("Invalid data");if(this._dist=Rt.DistBaseValTbl[h]+this.getBits(n),this._dist>this._window.available())throw new ft("Invalid data");return this._state=1===this._dist?pt.DistOne:pt.Dist,!0}return!1}addDistOne(t){const e=this._window.getLastChar();for(let s=0;s<t;s++)this.addByte(e)}addByte(t){this._window.addByte(t),this._output[this._outpos]=t,this._needed--,this._outpos++}addDist(t,e){this.addBytes(this._window.buffer,this._window.pos-t,e)}getBit(){0===this._nbits&&(this._nbits=8,this._bits=this._input.readByte());const t=!(1&~this._bits);return this._nbits--,this._bits=this._bits>>1,t}getBits(t){for(;this._nbits<t;)this._bits=this._bits|this._input.readByte()<<this._nbits,this._nbits+=8;const e=this._bits&(1<<t)-1;return this._nbits-=t,this._bits=this._bits>>t,e}getRevBits(t){return 0===t?0:this.getBit()?1<<t-1|this.getRevBits(t-1):this.getRevBits(t-1)}resetBits(){this._bits=0,this._nbits=0}addBytes(t,e,s){this._window.addBytes(t,e,s),this._output.set(t.subarray(e,e+s),this._outpos),this._needed-=s,this._outpos+=s}inflateLengths(t,e){let s=0,i=0;for(;s<e;){const a=this.applyHuffman(this._huffman);switch(a){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:i=a,t[s]=a,s++;break;case 16:const n=s+3+this.getBits(2);if(n>e)throw new ft("Invalid data");for(;s<n;)t[s]=i,s++;break;case 17:if(s+=3+this.getBits(3),s>e)throw new ft("Invalid data");break;case 18:if(s+=11+this.getBits(7),s>e)throw new ft("Invalid data");break;default:throw new ft("Invalid data")}}}applyHuffman(t){if(t instanceof Pr)return t.n;if(t instanceof yi)return this.applyHuffman(this.getBit()?t.right:t.left);if(t instanceof Ea)return this.applyHuffman(t.table[this.getBits(t.n)]);throw new ft("Invalid data")}}Rt.LenExtraBitsTbl=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1],Rt.LenBaseValTbl=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],Rt.DistExtraBitsTbl=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1],Rt.DistBaseValTbl=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],Rt.CodeLengthsPos=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Rt._fixedHuffman=Rt.buildFixedHuffman();let zt=(()=>{class r{constructor(e,s){this.fullName=e;const i=e.lastIndexOf("/");this.fileName=-1===i||i===e.length-1?this.fullName:e.substr(i+1),this.data=s}}return r.OptionalDataDescriptorSignature=134695760,r.CompressionMethodDeflate=8,r.LocalFileHeaderSignature=67324752,r.CentralFileHeaderSignature=33639248,r.EndOfCentralDirSignature=101010256,r})();class va{constructor(t){this._readable=t}read(){const t=[];for(;;){const e=this.readEntry();if(!e)break;t.push(e)}return t}readEntry(){const t=this._readable;if(k.readInt32LE(t)!==zt.LocalFileHeaderSignature)return null;k.readUInt16LE(t);const s=k.readUInt16LE(t),i=k.readUInt16LE(t),a=0!==i;if(a&&i!==zt.CompressionMethodDeflate)return null;k.readInt16LE(this._readable),k.readInt16LE(this._readable),k.readInt32LE(t),k.readInt32LE(t);const n=k.readInt32LE(t),o=k.readInt16LE(t),h=k.readInt16LE(t),c=k.toString(k.readByteArray(t,o),"utf-8");let d;if(t.skip(h),a){const u=Ke.empty(),f=new Rt(this._readable),p=new Uint8Array(65536);for(;;){const g=f.readBytes(p,0,p.length);if(u.write(p,0,g),g<p.length)break}d=u.toArray()}else d=k.readByteArray(this._readable,n);return!!(8&s)&&(k.readInt32LE(this._readable)===zt.OptionalDataDescriptorSignature&&k.readInt32LE(this._readable),k.readInt32LE(this._readable),k.readInt32LE(this._readable)),new zt(c,d)}}class wh{constructor(){this.trackViewGroups=[]}}class kh{constructor(){this.isVisible=!1}}var Xn=function(r){return r[r.PageVertical=0]="PageVertical",r[r.PageGrid=1]="PageGrid",r[r.PageParchment=2]="PageParchment",r[r.ScreenVertical=3]="ScreenVertical",r[r.ScreenHorizontal=4]="ScreenHorizontal",r[r.PageHorizontal=5]="PageHorizontal",r}(Xn||{});class Ia{constructor(t,e){this.zoomLevel=4,this.view=Xn.PageVertical,this.muiltiVoiceCursor=!1,this.scoreViews=[];const s=Ke.fromBuffer(e);this.zoomLevel=k.readInt32BE(s),this.view=s.readByte(),this.muiltiVoiceCursor=0!==s.readByte();const i=t.scoreViews.length;for(let a=0;a<i;a++){const n=new wh;this.scoreViews.push(n);const o=t.scoreViews[a];for(let h=0;h<o.trackViewGroups.length;h++){const c=new kh;c.isVisible=0!==s.readByte(),n.trackViewGroups.push(c)}}}apply(t){if(this.scoreViews.length>0){let e=0;for(const s of this.scoreViews[0].trackViewGroups)e<t.tracks.length&&(t.tracks[e].isVisibleOnMultiTrack=s.isVisible),e++}}static writeForScore(t){const e=Ke.withCapacity(128);k.writeInt32BE(e,4),e.writeByte(0),e.writeByte(t.tracks.length>0&&t.tracks[0].staves[0].bars[0].isMultiVoice?255:0);for(const i of t.tracks)e.writeByte(i.isVisibleOnMultiTrack?255:0);for(const i of t.tracks)e.writeByte(255);return e.toArray()}}class Bh extends pi{get name(){return"Guitar Pro 7-8"}readScore(){x.debug(this.name,"Loading ZIP entries");const t=new va(this.data);let e;try{e=t.read()}catch(u){throw new st("No Zip archive",u)}x.debug(this.name,"Zip entries loaded");let s=null,i=null,a=null,n=null;const o=new Map;for(const u of e)switch(o.set(u.fullName,u),u.fileName){case"score.gpif":s=k.toString(u.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=u.data;break;case"PartConfiguration":a=u.data;break;case"LayoutConfiguration":n=u.data}if(!s)throw new st("No score.gpif found in zip archive");x.debug(this.name,"Start Parsing score.gpif");const h=new M;h.loadAsset=u=>{if(o.has(u))return o.get(u).data},h.parseXml(s,this.settings),x.debug(this.name,"score.gpif parsed");const c=h.score;i&&(x.debug(this.name,"Start Parsing BinaryStylesheet"),new $t(i).apply(c),x.debug(this.name,"BinaryStylesheet parsed"));let d=null;return a&&(x.debug(this.name,"Start Parsing Part Configuration"),d=new La(a),d.apply(c),x.debug(this.name,"Part Configuration parsed")),n&&null!=d&&(x.debug(this.name,"Start Parsing Layout Configuration"),new Ia(d,n).apply(c),x.debug(this.name,"Layout Configuration parsed")),c}}class Zi extends Le{constructor(){super(Fe.Format,"Unexpected end of data within reader"),Object.setPrototypeOf(this,Zi.prototype)}}let _h=(()=>{class r{constructor(e){this._currentByte=0,this._position=r.ByteSize,this._source=e}readByte(){return this.readBits(8)}readBytes(e){const s=new Uint8Array(e);for(let i=0;i<e;i++)s[i]=255&this.readByte();return s}readBits(e){let s=0,i=e-1;for(;i>=0;)s|=this.readBit()<<i,i--;return s}readBitsReversed(e){let s=0;for(let i=0;i<e;i++)s|=this.readBit()<<i;return s}readBit(){if(this._position>=8){if(this._currentByte=this._source.readByte(),-1===this._currentByte)throw new Zi;this._position=0}const e=this._currentByte>>r.ByteSize-this._position-1&1;return this._position++,e}readAll(){const e=Ke.empty();try{for(;;)e.writeByte(255&this.readByte())}catch(s){if(!(s instanceof Zi))throw s}return e.toArray()}}return r.ByteSize=8,r})();class Th{constructor(){this.fileName="",this.fileSize=0,this.data=null}}let xh=(()=>{class r{constructor(){this.files=[],this.files=[],this.fileFilter=e=>!0}load(e){const s=new _h(e);this.readBlock(s)}readHeader(e){return this.getString(e.readBytes(4),0,4)}decompress(e,s=!1){const i=Ke.empty();let a;const n=this.getInteger(e.readBytes(4),0);try{for(;i.length<n;)if(1===e.readBits(1)){const f=e.readBits(4),p=e.readBitsReversed(f),g=e.readBitsReversed(f),b=i.length-p,w=Math.min(p,g);a=i.getBuffer(),i.write(a,b,w)}else{const f=e.readBitsReversed(2);for(let p=0;p<f;p++)i.writeByte(e.readByte())}}catch(u){if(!(u instanceof Zi))throw u}a=i.getBuffer();const o=s?4:0,h=i.length-o,c=new Uint8Array(h);return c.set(a.subarray(o,o+h),0),c}readBlock(e){const s=this.readHeader(e);if("BCFZ"===s)this.readUncompressedBlock(this.decompress(e,!0));else{if("BCFS"!==s)throw new st("Unsupported format");this.readUncompressedBlock(e.readAll())}}readUncompressedBlock(e){let i=4096;for(;i+3<e.length;){if(2===this.getInteger(e,i)){const n=new Th;n.fileName=this.getString(e,i+4,127),n.fileSize=this.getInteger(e,i+140);const o=!this.fileFilter||this.fileFilter(n.fileName);o&&this.files.push(n);const h=i+148;let c=0,d=0;const u=o?Ke.withCapacity(n.fileSize):null;for(;c=this.getInteger(e,h+4*d++),0!==c;)i=4096*c,o&&u.write(e,i,4096);if(o){n.data=new Uint8Array(Math.min(n.fileSize,u.length));const f=u.toArray();n.data.set(f.subarray(0,0+n.data.length),0)}}i+=4096}}getString(e,s,i){let a="";for(let n=0;n<i;n++){const o=255&e[s+n];if(0===o)break;a+=String.fromCharCode(o)}return a}getInteger(e,s){return e[s+3]<<24|e[s+2]<<16|e[s+1]<<8|e[s]}}return r.HeaderBcFs="BCFS",r.HeaderBcFz="BCFZ",r})();class Nh extends pi{get name(){return"Guitar Pro 6"}readScore(){x.debug(this.name,"Loading GPX filesystem");const t=new xh;t.fileFilter=c=>c.endsWith("score.gpif")||c.endsWith("BinaryStylesheet")||c.endsWith("PartConfiguration")||c.endsWith("LayoutConfiguration"),t.load(this.data),x.debug(this.name,"GPX filesystem loaded");let e=null,s=null,i=null,a=null;for(const c of t.files)switch(c.fileName){case"score.gpif":e=k.toString(c.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=c.data;break;case"PartConfiguration":i=c.data;break;case"LayoutConfiguration":a=c.data}if(!e)throw new st("No score.gpif found in GPX");x.debug(this.name,"Start Parsing score.gpif");const n=new M;n.parseXml(e,this.settings),x.debug(this.name,"score.gpif parsed");const o=n.score;s&&(x.debug(this.name,"Start Parsing BinaryStylesheet"),new $t(s).apply(o),x.debug(this.name,"BinaryStylesheet parsed"));let h=null;return i&&(x.debug(this.name,"Start Parsing Part Configuration"),h=new La(i),h.apply(o),x.debug(this.name,"Part Configuration parsed")),a&&null!=h&&(x.debug(this.name,"Start Parsing Layout Configuration"),new Ia(h,a).apply(o),x.debug(this.name,"Layout Configuration parsed")),o}}var j=function(r){return r[r.None=0]="None",r[r.Natural=1]="Natural",r[r.Sharp=2]="Sharp",r[r.Flat=3]="Flat",r[r.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",r[r.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",r[r.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",r[r.DoubleSharp=7]="DoubleSharp",r[r.DoubleFlat=8]="DoubleFlat",r}(j||{});class Ph{constructor(){this.maxLine=-1e3,this.minLine=-1e3}}let gs=(()=>{class r{constructor(e){this._registeredAccidentals=new Map,this._appliedScoreLines=new Map,this._appliedScoreLinesByValue=new Map,this._notesByValue=new Map,this._beatLines=new Map,this.maxLineBeat=null,this.minLineBeat=null,this.maxLine=-1e3,this.minLine=-1e3,this._barRenderer=e,this._bar=e.bar}static getPercussionLine(e,s){return s<e.staff.track.percussionArticulations.length?e.staff.track.percussionArticulations[s].staffLine:ht.getArticulationByInputMidiNumber(s)?.staffLine??0}static getNoteValue(e){if(e.isPercussion)return e.percussionArticulation;let s=e.displayValue;switch(e.accidentalMode){case ge.ForceDoubleFlat:s+=2;break;case ge.ForceDoubleSharp:s-=2;break;case ge.ForceFlat:s+=1;break;case ge.ForceSharp:s-=1}return s}applyAccidental(e){const s=r.getNoteValue(e);return this.getAccidental(s,e.hasQuarterToneOffset,e.beat,!1,e)}applyAccidentalForValue(e,s,i,a){return this.getAccidental(s,i,e,a,null)}static computeLineWithoutAccidentals(e,s){let i=0;const a=r.getNoteValue(s);return i=s.isPercussion?r.getPercussionLine(e,a):r.calculateNoteSteps(e.keySignature,e.clef,a),i}static computeAccidental(e,s,i,a,n=null){const h=e+7,c=i%12,d=h<7?j.Flat:j.Sharp,u=r.KeySignatureLookup[h][c],f=r.AccidentalNotes[c];let p=j.None;if(a)switch(p=f?d:j.Natural,p){case j.Natural:p=j.NaturalQuarterNoteUp;break;case j.Sharp:p=j.SharpQuarterNoteUp;break;case j.Flat:p=j.FlatQuarterNoteUp}else{switch(s){case ge.ForceSharp:p=j.Sharp;break;case ge.ForceDoubleSharp:p=j.DoubleSharp;break;case ge.ForceFlat:p=j.Flat;break;case ge.ForceDoubleFlat:p=j.DoubleFlat;break;default:f?p=d:u&&(p=j.Natural)}p!==j.None?null!=n?n===p&&(p=j.None):u&&p===d&&(p=j.None):null!==n&&(p=n===j.Natural?j.None:j.Natural)}return p}getAccidental(e,s,i,a,n=null){let o=0,h=j.None;if(null!=n?n.isPercussion:this._bar.staff.isPercussion)o=r.getPercussionLine(this._bar,e);else{const d=n?n.accidentalMode:ge.Default;o=r.calculateNoteSteps(this._bar.keySignature,this._bar.clef,e);const u=this._registeredAccidentals.has(o)?this._registeredAccidentals.get(o):null;h=r.computeAccidental(this._bar.keySignature,d,e,s,u);let f=!1;switch(h){case j.NaturalQuarterNoteUp:case j.SharpQuarterNoteUp:case j.FlatQuarterNoteUp:break;default:if(n&&n.isTieDestination&&0===n.beat.index){const p=this._barRenderer.scoreRenderer.layout?.getRendererForBar(this._barRenderer.staff.staffId,n.tieOrigin.beat.voice.bar);p&&p.staff===this._barRenderer.staff&&p.accidentalHelper.getNoteLine(n.tieOrigin)===o&&(f=!0)}f?h=j.None:h!==j.None&&this._registeredAccidentals.set(o,h)}}return n?(this._appliedScoreLines.set(n.id,o),this._notesByValue.set(e,n)):this._appliedScoreLinesByValue.set(e,o),(-1e3===this.minLine||this.minLine<o)&&(this.minLine=o,this.minLineBeat=i),(-1e3===this.maxLine||this.maxLine>o)&&(this.maxLine=o,this.maxLineBeat=i),a||this.registerLine(i,o),h}registerLine(e,s){let i;this._beatLines.has(e.id)?i=this._beatLines.get(e.id):(i=new Ph,this._beatLines.set(e.id,i)),(-1e3===i.minLine||s<i.minLine)&&(i.minLine=s),(-1e3===i.minLine||s>i.maxLine)&&(i.maxLine=s)}getMaxLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).maxLine:0}getMinLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).minLine:0}static calculateNoteSteps(e,s,i){const n=e,h=i%12;let d=r.OctaveSteps[s];return d-=((i/12|0)-1)*r.StepsPerOctave,d-=(O.keySignatureIsSharp(n)||O.keySignatureIsNatural(n)?r.SharpNoteSteps:r.FlatNoteSteps)[h],d}getNoteLine(e){return this._appliedScoreLines.get(e.id)}getNoteLineForValue(e,s=!1){return this._appliedScoreLinesByValue.has(e)?this._appliedScoreLinesByValue.get(e):s&&this._notesByValue.has(e)?this.getNoteLine(this._notesByValue.get(e)):0}}return r.KeySignatureLookup=[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],r.AccidentalNotes=[!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!0,!1],r.StepsPerOctave=7,r.OctaveSteps=[38,32,30,26,38],r.SharpNoteSteps=[0,0,1,1,2,3,3,4,4,5,5,6],r.FlatNoteSteps=[0,1,1,2,2,3,4,4,5,5,6,6],r})();class Ch{constructor(){this.currentDynamics=J.F,this.slideOrigins=new Map,this.transpose=0,this.isExplicitlyBeamed=!1,this.tieStarts=new Set,this.tieStartIds=new Map,this.slideOrigins=new Map,this.slurStarts=new Map}}class Dh extends W{constructor(){super(...arguments),this.outputMidiChannel=-1,this.outputMidiProgram=-1,this.outputVolume=-1,this.outputBalance=-1}}class Cr{constructor(t){this.instruments=new Map,this._instrumentIdToArticulationIndex=new Map,this._lyricsLine=0,this._lyricsLines=new Map,this.track=t}getLyricLine(t){if(this._lyricsLines.has(t))return this._lyricsLines.get(t);const e=this._lyricsLine;return this._lyricsLines.set(t,e),this._lyricsLine++,e}getOrCreateArticulation(t,e){const s=12*e.octave+e.tone,i=`${t}_${s}`;if(this._instrumentIdToArticulationIndex.has(i))return this._instrumentIdToArticulationIndex.get(i);let a;a=this.instruments.has(t)?this.instruments.get(t):Cr.defaultNoteArticulation;const n=this.track.percussionArticulations.length,o=e.beat.voice.bar;let h;h=0===s?4:gs.calculateNoteSteps(o.keySignature,o.clef,s);const p=new W(a.elementType,h-(9-(2*e.beat.voice.bar.staff.standardNotationLineCount-1)),a.outputMidiNumber,a.noteHeadDefault,a.noteHeadHalf,a.noteHeadWhole,a.techniqueSymbol,a.techniqueSymbolPlacement);return this._instrumentIdToArticulationIndex.set(i,n),this.track.percussionArticulations.push(p),n}}Cr.defaultNoteArticulation=new W("Default",0,0,l.NoteheadBlack,l.NoteheadHalf,l.NoteheadWhole);class ve extends pi{constructor(){super(...arguments),this._idToTrackInfo=new Map,this._indexToTrackInfo=new Map,this._staffToContext=new Map,this._divisionsPerQuarterNote=1,this._currentDynamics=J.F,this._musicalPosition=0,this._lastBeat=null,this._nextMasterBarRepeatEnding=0,this._nextBeatAutomations=null,this._nextBeatChord=null,this._nextBeatCrescendo=null,this._nextBeatLetRing=!1,this._nextBeatPalmMute=!1,this._nextBeatOttavia=null,this._nextBeatText=null,this._simileMarkAllStaves=null,this._simileMarkPerStaff=null,this._isBeatSlash=!1,this._keyAllStaves=null,this._currentTrillStep=-1}get name(){return"MusicXML"}readScore(){const t=this.extractMusicXml(),e=new Ki;try{e.parse(t)}catch(s){throw new st("Unsupported format",s)}return this._score=new Cs,this._score.tempo=120,this._score.stylesheet.hideDynamics=!0,this.parseDom(e),O.consolidate(this._score),this._score.finish(this.settings),this._score.rebuildRepeatGroups(),this._score}extractMusicXml(){const t=new va(this.data);let e;try{e=t.read()}catch{e=[]}if(0===e.length)return this.data.reset(),k.toString(this.data.readAll(),this.settings.importer.encoding);const s=e.find(c=>"META-INF/container.xml"===c.fullName);if(!s)throw new st("No compressed MusicXML");const i=new Ki;try{i.parse(k.toString(s.data,this.settings.importer.encoding))}catch(c){throw new st("Malformed container.xml, could not parse as XML",c)}const a=i.firstElement;if(!a||"container"!==a.localName)throw new st("Malformed container.xml, root element not 'container'");const n=a.findChildElement("rootfiles");if(!n)throw new st("Malformed container.xml, 'container/rootfiles' not found");let o="";for(const c of n.childElements())if("rootfile"===c.localName){o=c.getAttribute("full-path");break}if(!o)throw new st("Unsupported compressed MusicXML, missing rootfile");const h=e.find(c=>c.fullName===o);if(!h)throw new st(`Malformed container.xml, '${o}' not contained in zip`);return k.toString(h.data,this.settings.importer.encoding)}parseDom(t){const e=t.firstElement;if(!e)throw new st("Unsupported format");switch(e.localName){case"score-partwise":this.parsePartwise(e);break;case"score-timewise":this.parseTimewise(e);break;default:throw new st("Unsupported format")}}parsePartwise(t){for(const e of t.childElements())switch(e.localName){case"credit":this.parseCredit(e);break;case"identification":this.parseIdentification(e);break;case"movement-title":this.parseMovementTitle(e);break;case"part":this.parsePartwisePart(e);break;case"part-list":this.parsePartList(e);break;case"work":this.parseWork(e)}}parseTimewise(t){let e=0;for(const s of t.childElements())switch(s.localName){case"credit":this.parseCredit(s);break;case"identification":this.parseIdentification(s);break;case"movement-title":this.parseMovementTitle(s);break;case"part-list":this.parsePartList(s);break;case"work":this.parseWork(s);break;case"measure":this.parseTimewiseMeasure(s,e),e++}}parseCredit(t){if("1"!==t.getAttribute("page","1"))return;const e=[];let s=null,i="";for(const a of t.childElements())switch(a.localName){case"credit-type":e.push(a.innerText);break;case"credit-words":null===s&&(s=a),i+=a.innerText}if(e.length>0)for(const a of e)switch(a){case"title":this._score.title=ve.sanitizeDisplay(i);break;case"subtitle":this._score.subTitle=ve.sanitizeDisplay(i);break;case"composer":case"arranger":this._score.artist=ve.sanitizeDisplay(i);break;case"lyricist":this._score.words=ve.sanitizeDisplay(i);break;case"rights":this._score.copyright=ve.sanitizeDisplay(i)}else if(s){const a=s.getAttribute("font-size","0"),n=s.getAttribute("font-size","top"),o=s.getAttribute("halign","left");if("top"===n){if(i.includes("copyright")||i.includes("Copyright")||i.includes("\xa9")||i.includes("(c)")||i.includes("(C)"))return void(this._score.copyright=ve.sanitizeDisplay(i));if("center"===o||"center"===a){if(0===this._score.title.length)return void(this._score.title=ve.sanitizeDisplay(i));if(0===this._score.subTitle.length)return void(this._score.subTitle=ve.sanitizeDisplay(i));if(0===this._score.album.length)return void(this._score.album=ve.sanitizeDisplay(i))}else if(("right"===o||"right"===a)&&0===this._score.music.length)return void(this._score.music=ve.sanitizeDisplay(i));if(0===this._score.artist.length)return void(this._score.artist=ve.sanitizeDisplay(i));if(0===this._score.words.length)return void(this._score.words=ve.sanitizeDisplay(i))}}}static sanitizeDisplay(t){return t.replaceAll("\r","").replaceAll("\n"," ").replaceAll("\t","\xa0\xa0").replaceAll(" ","\xa0")}parseIdentification(t){for(const e of t.childElements())switch(e.localName){case"creator":if(e.attributes.has("type"))switch(e.attributes.get("type")){case"composer":this._score.artist=ve.sanitizeDisplay(e.innerText);break;case"lyricist":this._score.words=ve.sanitizeDisplay(e.innerText);break;case"arranger":this._score.music=ve.sanitizeDisplay(e.innerText)}else this._score.artist=ve.sanitizeDisplay(e.innerText);break;case"rights":this._score.copyright.length>0&&(this._score.copyright+=", "),this._score.copyright+=e.innerText,e.attributes.has("type")&&(this._score.copyright+=` (${e.attributes.get("type")})`);break;case"encoding":this.parseEncoding(e)}}parseEncoding(t){for(const e of t.childElements())switch(e.localName){case"encoder":this._score.tab.length>0&&(this._score.tab+=", "),this._score.tab+=e.innerText,e.attributes.has("type")&&(this._score.tab+=` (${e.attributes.get("type")})`);break;case"encoding-description":this._score.notices+=ve.sanitizeDisplay(e.innerText)}}parseMovementTitle(t){0===this._score.title.length?this._score.title=ve.sanitizeDisplay(t.innerText):this._score.subTitle=ve.sanitizeDisplay(t.innerText)}parsePartList(t){for(const e of t.childElements())"score-part"===e.localName&&this.parseScorePart(e)}parseScorePart(t){const e=new gi;e.ensureStaveCount(1),this._score.addTrack(e);const s=t.attributes.get("id"),i=new Cr(e);this._idToTrackInfo.set(s,i),this._indexToTrackInfo.set(e.index,i);for(const a of t.childElements())switch(a.localName){case"part-name":e.name=ve.sanitizeDisplay(a.innerText);break;case"part-name-display":e.name=this.parsePartDisplayAsText(a);break;case"part-abbreviation":e.shortName=ve.sanitizeDisplay(a.innerText);break;case"part-abbreviation-display":e.shortName=this.parsePartDisplayAsText(a);break;case"score-instrument":this.parseScoreInstrument(a,i);break;case"midi-device":a.attributes.has("port")&&(e.playbackInfo.port=Number.parseInt(a.attributes.get("port"),10));break;case"midi-instrument":this.parseScorePartMidiInstrument(a,i)}i.firstArticulation&&(i.firstArticulation.outputMidiProgram>=0&&(e.playbackInfo.program=i.firstArticulation.outputMidiProgram),i.firstArticulation.outputBalance>=0&&(e.playbackInfo.balance=i.firstArticulation.outputBalance),i.firstArticulation.outputVolume>=0&&(e.playbackInfo.volume=i.firstArticulation.outputVolume),i.firstArticulation.outputMidiChannel>=0&&(e.playbackInfo.primaryChannel=i.firstArticulation.outputMidiChannel,e.playbackInfo.secondaryChannel=i.firstArticulation.outputMidiChannel))}parseScoreInstrument(t,e){const s=new Dh;e.firstArticulation||(e.firstArticulation=s),e.instruments.set(t.getAttribute("id",""),s)}parseScorePartMidiInstrument(t,e){const s=t.getAttribute("id","");if(!e.instruments.has(s))return;const i=e.instruments.get(s);for(const a of t.childElements())switch(a.localName){case"midi-channel":i.outputMidiChannel=Number.parseInt(a.innerText)-1;break;case"midi-program":i.outputMidiProgram=Number.parseInt(a.innerText)-1;break;case"midi-unpitched":i.outputMidiNumber=Number.parseInt(a.innerText)-1;break;case"volume":i.outputVolume=ve.interpolatePercent(Number.parseFloat(a.innerText));break;case"pan":i.outputBalance=ve.interpolatePan(Number.parseFloat(a.innerText))}}static interpolatePercent(t){return 0|ve.interpolate(0,100,0,16,t)}static interpolatePan(t){return 0|ve.interpolate(-90,90,0,16,t)}static interpolate(t,e,s,i,a){return s+(a-t)/(e-t)*(i-s)}parsePartDisplayAsText(t){let e="";for(const s of t.childElements())switch(s.localName){case"display-text":e+=s.innerText;break;case"accidental-text":switch(s.innerText){case"sharp":e+="\u266f";break;case"natural":e+="\u266e";break;case"flat":e+="\u266d";break;case"double-sharp":e+="\u{1d12a}";break;case"sharp-sharp":e+="\u266f\u266f";break;case"flat-flat":e+="\u{1d12b}";break;case"natural-sharp":e+="\u266e\u266f";break;case"natural-flat":e+="\u266e\u266d";break;case"sharp-down":e+="\u{1d131}";break;case"sharp-up":e+="\u{1d130}";break;case"natural-down":e+="\u{1d12f}";break;case"natural-up":e+="\u{1d12e}";break;case"flat-down":e+="\u{1d12d}";break;case"flat-up":e+="\u{1d12c}";break;case"arrow-down":e+="\u2193";break;case"arrow-up":e+="\u2191";break;case"triple-sharp":e+="\u266f\u{1d12a}";break;case"triple-flat":e+="\u{1d12c}\u{1d12c}\u{1d12c}";break;case"sharp-1":e+="\u266f\xb9";break;case"sharp-2":e+="\u266f\xb2";break;case"sharp-3":e+="\u266f\xb3";break;case"sharp-4":e+="\u266f\u2074";break;case"sharp-5":e+="\u266f\u2075";break;case"flat-1":e+="\u266d\xb9";break;case"flat-2":e+="\u266d\xb2";break;case"flat-3":e+="\u266d\xb3";break;case"flat-4":e+="\u266d\u2074";break;case"flat-5":e+="\u266d\u2075"}}return ve.sanitizeDisplay(e)}parseWork(t){for(const e of t.childElements())"work-title"===e.localName&&(this._score.title=ve.sanitizeDisplay(e.innerText))}parsePartwisePart(t){const e=t.attributes.get("id");if(!e||!this._idToTrackInfo.has(e))return;const s=this._idToTrackInfo.get(e).track;let i=0;for(const a of t.childElements())"measure"===a.localName&&(this.parsePartwiseMeasure(a,s,i),i++)}parsePartwiseMeasure(t,e,s){const i=this.getOrCreateMasterBar(t,s);this.parsePartMeasure(t,i,e)}parseTimewiseMeasure(t,e){const s=this.getOrCreateMasterBar(t,e);for(const i of t.childElements())"part"===i.localName&&this.parseTimewisePart(i,s)}getOrCreateMasterBar(t,e){const s="yes"===t.attributes.get("implicit");for(;this._score.masterBars.length<=e;){const a=new Ps;s&&(a.isAnacrusis=!0),this._score.addMasterBar(a),a.index>0&&(a.timeSignatureDenominator=a.previousMasterBar.timeSignatureDenominator,a.timeSignatureNumerator=a.previousMasterBar.timeSignatureNumerator,a.tripletFeel=a.previousMasterBar.tripletFeel)}return this._score.masterBars[e]}parseTimewisePart(t,e){const s=t.attributes.get("id");if(!s||!this._idToTrackInfo.has(s))return;const i=this._idToTrackInfo.get(s).track;this.parsePartMeasure(t,e,i)}parsePartMeasure(t,e,s){this._musicalPosition=0,this._lastBeat=null,e.alternateEndings=this._nextMasterBarRepeatEnding;const i=[];for(const n of t.childElements())switch(n.localName){case"note":this.parseNote(n,e,s);break;case"backup":this.parseBackup(n);break;case"forward":this.parseForward(n);break;case"direction":this.parseDirection(n,e,s);break;case"attributes":this.parseAttributes(n,e,s);break;case"harmony":this.parseHarmony(n,s);break;case"print":this.parsePrint(n,e,s);break;case"sound":this.parseSound(n,e,s);break;case"barline":i.push(n)}for(const n of i)this.parseBarLine(n,e,s);this.applySimileMarks(e,s);const a=this.getOrCreateStaff(s,0);this.getOrCreateBar(a,e),this._keyAllStaves=null}parsePrint(t,e,s){("yes"===t.getAttribute("new-system","no")||"yes"===t.getAttribute("new-page","no"))&&s.addLineBreaks(e.index)}applySimileMarks(t,e){if(null!==this._simileMarkAllStaves){for(const s of e.staves){const i=this.getOrCreateBar(s,t);i.simileMark=this._simileMarkAllStaves,i.simileMark!==je.None&&this.clearBar(i)}this._simileMarkAllStaves=this._simileMarkAllStaves===je.FirstOfDouble?je.SecondOfDouble:null}if(null!==this._simileMarkPerStaff){const s=Array.from(this._simileMarkPerStaff.keys());for(const i of s){const a=this.getOrCreateStaff(e,i),n=this.getOrCreateBar(a,t);n.simileMark=this._simileMarkPerStaff.get(i),n.simileMark!==je.None&&this.clearBar(n),n.simileMark===je.FirstOfDouble?this._simileMarkPerStaff.set(i,je.SecondOfDouble):this._simileMarkPerStaff.delete(i)}0===this._simileMarkPerStaff.size&&(this._simileMarkPerStaff=null)}}clearBar(t){for(const e of t.voices){const s=new xt;s.isEmpty=!0,e.addBeat(s)}}parseBarLine(t,e,s){for(const i of t.childElements())switch(i.localName){case"bar-style":this.parseBarStyle(i,e,s,t.getAttribute("location","right"));break;case"ending":this.parseEnding(i,e);break;case"repeat":this.parseRepeat(i,e)}}parseRepeat(t,e){const s=t.getAttribute("direction");let i=Number.parseInt(t.getAttribute("times"));(i<0||Number.isNaN(i))&&(i=2),"backward"===s?e.repeatCount=i:"forward"===s&&(e.isRepeatStart=!0)}parseEnding(t,e){const s=t.getAttribute("number").split(",").map(a=>Number.parseInt(a));let i=0;for(const a of s)i|=1<<a-1&255;switch(e.alternateEndings=i,t.getAttribute("type","")){case"start":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding|i;break;case"stop":case"discontinue":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding&~i}}parseBarStyle(t,e,s,i){let a=te.Automatic;switch(t.innerText){case"dashed":a=te.Dashed;break;case"dotted":a=te.Dotted;break;case"heavy":a=te.Heavy;break;case"heavy-heavy":a=te.HeavyHeavy;break;case"heavy-light":a=te.HeavyLight;break;case"light-heavy":a=te.LightHeavy;break;case"light-light":a=te.LightLight;break;case"none":a=te.None;break;case"regular":a=te.Regular;break;case"short":a=te.Short;break;case"tick":a=te.Tick}for(const n of s.staves){const o=this.getOrCreateBar(n,e);switch(i){case"left":o.barLineLeft=a;break;case"right":o.barLineRight=a}}}parseSound(t,e,s){for(const i of t.childElements())switch(i.localName){case"midi-instrument":this.parseSoundMidiInstrument(i,e);break;case"swing":this.parseSwing(i,e)}if(t.attributes.has("coda")&&e.addDirection(I.TargetCoda),t.attributes.has("tocoda")&&e.addDirection(I.JumpDaCoda),t.attributes.has("dacapo")&&e.addDirection(I.JumpDaCapo),t.attributes.has("dalsegno")&&e.addDirection(I.JumpDalSegno),t.attributes.has("fine")&&e.addDirection(I.TargetFine),t.attributes.has("segno")&&e.addDirection(I.TargetSegno),t.attributes.has("pan")){this._nextBeatAutomations||(this._nextBeatAutomations=[]);const i=new Qe;i.type=Ge.Balance,i.value=ve.interpolatePan(Number.parseFloat(t.attributes.get("pan"))),this._nextBeatAutomations.push(i)}if(t.attributes.has("tempo")){this._nextBeatAutomations||(this._nextBeatAutomations=[]);const i=new Qe;i.type=Ge.Tempo,i.value=ve.interpolatePercent(Number.parseFloat(t.attributes.get("tempo"))),this._nextBeatAutomations.push(i)}}parseSwing(t,e){let s=0,i=0,a=null;for(const n of t.childElements())switch(n.localName){case"straight":return void(e.tripletFeel=ue.NoTripletFeel);case"first":s=Number.parseInt(n.innerText);break;case"second":i=Number.parseInt(n.innerText);break;case"swing-type":a=this.parseBeatDuration(n)}a||(a=m.Eighth),a===m.Eighth?2===s&&1===i?e.tripletFeel=ue.Triplet8th:3===s&&1===i?e.tripletFeel=ue.Dotted8th:1===s&&3===i&&(e.tripletFeel=ue.Scottish8th):a===m.Sixteenth&&(2===s&&1===i?e.tripletFeel=ue.Triplet16th:3===s&&1===i?e.tripletFeel=ue.Dotted16th:1===s&&3===i&&(e.tripletFeel=ue.Scottish16th))}parseSoundMidiInstrument(t,e){let s;for(const i of t.childElements())switch(i.localName){case"midi-program":this._nextBeatAutomations||(this._nextBeatAutomations=[]),s=new Qe,s.type=Ge.Instrument,s.value=Number.parseInt(i.innerText)-1,this._nextBeatAutomations.push(s);break;case"volume":this._nextBeatAutomations||(this._nextBeatAutomations=[]),s=new Qe,s.type=Ge.Volume,s.value=ve.interpolatePercent(Number.parseFloat(i.innerText)),this._nextBeatAutomations.push(s);break;case"pan":this._nextBeatAutomations||(this._nextBeatAutomations=[]),s=new Qe,s.type=Ge.Balance,s.value=ve.interpolatePan(Number.parseFloat(i.innerText)),this._nextBeatAutomations.push(s)}}parseHarmony(t,e){const s=new Os;let i=!1,a="";for(const n of t.childElements())switch(n.localName){case"root":s.name=this.parseHarmonyRoot(n);break;case"kind":s.name=s.name+this.parseHarmonyKind(n),"yes"===n.getAttribute("parentheses-degrees","no")&&(i=!0);break;case"frame":this.parseHarmonyFrame(n,s);break;case"degree":a+=this.parseDegree(n)}a&&(s.name+=i?`(${a})`:a),null===this._nextBeatChord&&(this._nextBeatChord=s)}parseDegree(t){let e="",s="",i="";for(const a of t.childElements())switch(a.localName){case"degree-value":e=a.innerText;break;case"degree-alter":switch(a.innerText){case"-1":s="\u266d";break;case"1":s="\u266f"}break;case"degree-type":i+=a.getAttribute("text","")}return`${i}${s}${e}`}parseHarmonyRoot(t){let e="",s="";for(const i of t.childElements())switch(i.localName){case"root-step":e=i.innerText;break;case"root-alter":switch(Number.parseFloat(i.innerText)){case-2:s="bb";break;case-1:s="b";break;case 0:s="";break;case 1:s="#";break;case 2:s="##"}}return e+s}parseHarmonyKind(t){const e=t.getAttribute("text");let s="";if(e)s=e;else{const i=t.innerText;switch(i){case"major":s="";break;case"minor":s="m";break;case"augmented":s="+";break;case"diminished":s="\u25cb";break;case"dominant":s="7";break;case"major-seventh":s="7M";break;case"minor-seventh":s="m7";break;case"diminished-seventh":s="\u25cb7";break;case"augmented-seventh":s="+7";break;case"half-diminished":s="\u2349";break;case"major-minor":s="mMaj";break;case"major-sixth":s="maj6";break;case"minor-sixth":s="m6";break;case"dominant-ninth":s="9";break;case"major-ninth":s="maj9";break;case"minor-ninth":s="m9";break;case"dominant-11th":s="11";break;case"major-11th":s="maj11";break;case"minor-11th":s="m11";break;case"dominant-13th":s="13";break;case"major-13th":s="maj13";break;case"minor-13th":s="m13";break;case"suspended-second":s="sus2";break;case"suspended-fourth":s="sus4";break;case"Neapolitan":s="\u266dII";break;case"Italian":s="It\u207a\u2076";break;case"French":case"German":s="Fr\u207a\u2076";break;default:s=i}}return s}parseHarmonyFrame(t,e){for(const s of t.childElements())switch(s.localName){case"frame-strings":const i=Number.parseInt(s.innerText);e.strings=new Array(i);for(let o=0;o<i;o++)e.strings[o]=-1;break;case"first-fret":e.firstFret=Number.parseInt(s.innerText);break;case"frame-note":let a=null,n=null;for(const o of s.childElements())switch(o.localName){case"string":a=Number.parseInt(o.innerText);break;case"fret":n=Number.parseInt(o.innerText),a&&n>=0&&(e.strings[a-1]=n);break;case"barre":a&&n&&"start"===o.getAttribute("type")&&e.barreFrets.push(n)}}}parseAttributes(t,e,s){let i,a,n;if(null==this._lastBeat)for(const o of t.childElements())switch(o.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(o.innerText);break;case"key":this.parseKey(o,e,s);break;case"time":this.parseTime(o,e);break;case"staves":s.ensureStaveCount(Number.parseInt(o.innerText));break;case"clef":i=Number.parseInt(o.getAttribute("number","1"))-1,a=this.getOrCreateStaff(s,i),n=this.getOrCreateBar(a,e),this.parseClef(o,n);break;case"staff-details":i=Number.parseInt(o.getAttribute("number","1"))-1,a=this.getOrCreateStaff(s,i),this.parseStaffDetails(o,a);break;case"transpose":this.parseTranspose(o,s);break;case"measure-style":this.parseMeasureStyle(o,s,!1)}else for(const o of t.childElements())switch(o.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(o.innerText);break;case"measure-style":this.parseMeasureStyle(o,s,!0)}}parseMeasureStyle(t,e,s){for(const i of t.childElements())switch(i.localName){case"measure-repeat":if(!s){let a=null;switch(i.getAttribute("type")){case"start":switch(Number.parseInt(i.getAttribute("slashes","1"))){case 1:a=je.Simple;break;case 2:a=je.FirstOfDouble}break;case"stop":a=null}if(t.attributes.has("number")){this._simileMarkPerStaff=this._simileMarkPerStaff??new Map;const n=Number.parseInt(t.attributes.get("number"))-1;null==a?this._simileMarkPerStaff.delete(n):this._simileMarkPerStaff.set(n,a)}else this._simileMarkAllStaves=a}break;case"slash":switch(i.getAttribute("type")){case"start":this._isBeatSlash=!0;break;case"stop":this._isBeatSlash=!1}}}parseTranspose(t,e){let s=0;for(const i of t.childElements())switch(i.localName){case"chromatic":s+=Number.parseFloat(i.innerText);break;case"octave-change":s+=12*Number.parseFloat(i.innerText)}if(t.attributes.has("number")){const i=this.getOrCreateStaff(e,Number.parseInt(t.attributes.get("number"))-1);this.getStaffContext(i).transpose=s,i.displayTranspositionPitch=s}else for(const i of e.staves)this.getStaffContext(i).transpose=s,i.displayTranspositionPitch=s}parseStaffDetails(t,e){for(const s of t.childElements())switch(s.localName){case"staff-lines":e.standardNotationLineCount=Number.parseInt(s.innerText);break;case"staff-tuning":this.parseStaffTuning(s,e);break;case"capo":e.capo=Number.parseInt(s.innerText)}}parseStaffTuning(t,e){0===e.stringTuning.tunings.length&&(e.showTablature=!0,e.showStandardNotation=!1,e.stringTuning.tunings=new Array(e.standardNotationLineCount).fill(0));const s=Number.parseInt(t.getAttribute("line"));let i="C",a="",n=0;for(const h of t.childElements())switch(h.localName){case"tuning-step":i=h.innerText;break;case"tuning-alter":n=Number.parseFloat(h.innerText);break;case"tuning-octave":a=h.innerText}const o=O.getTuningForText(i+a)+n;e.tuning[e.tuning.length-s]=o}parseClef(t,e){let s="s",i=0;for(const a of t.childElements())switch(a.localName){case"sign":s=a.innerText.toLowerCase();break;case"line":i=Number.parseInt(a.innerText);break;case"clef-octave-change":switch(Number.parseInt(a.innerText)){case-2:e.clefOttava=le._15mb;break;case-1:e.clefOttava=le._8vb;break;case 1:e.clefOttava=le._8va;break;case 2:e.clefOttava=le._15mb}}switch(s){case"g":default:e.clef=Se.G2;break;case"f":e.clef=Se.F4;break;case"c":e.clef=3===i?Se.C3:Se.C4;break;case"percussion":e.clef=Se.Neutral,e.staff.isPercussion=!0;break;case"tab":e.clef=Se.G2,e.staff.showTablature=!0}}parseTime(t,e){let s=!1,i=!1;for(const a of t.childElements()){const n=a.innerText;switch(a.localName){case"beats":s||(e.timeSignatureNumerator=-1===n.indexOf("+")?Number.parseInt(n):n.split("+").map(o=>Number.parseInt(o)).reduce((o,h)=>h+o,0),s=!0);break;case"beat-type":i||(e.timeSignatureDenominator=-1===n.indexOf("+")?Number.parseInt(n):n.split("+").map(o=>Number.parseInt(o)).reduce((o,h)=>h+o,0),i=!0)}}switch(t.getAttribute("symbol","")){case"common":case"cut":e.timeSignatureCommon=!0}}parseKey(t,e,s){let n,o,i=-ye.C,a="";for(const h of t.childElements())switch(h.localName){case"fifths":i=Number.parseInt(h.innerText);break;case"mode":a=h.innerText}if(n=-7<=i&&i<=7?i:ye.C,o="minor"===a?It.Minor:It.Major,t.attributes.has("number")){const h=this.getOrCreateStaff(s,Number.parseInt(t.attributes.get("number"))-1),c=this.getOrCreateBar(h,e);c.keySignature=n,c.keySignatureType=o}else{this._keyAllStaves=[n,o];for(const h of s.staves)h.bars.length>e.index&&(h.bars[e.index].keySignature=n,h.bars[e.index].keySignatureType=o)}}parseDirection(t,e,s){const i=[];let a=null,n=-1,o=-1;for(const f of t.childElements())switch(f.localName){case"direction-type":const p=f.firstElement;p&&i.push(p);break;case"offset":a=Number.parseFloat(f.innerText);break;case"voice":break;case"staff":n=Number.parseInt(f.innerText)-1;break;case"sound":f.attributes.has("tempo")&&(o=Number.parseFloat(f.attributes.get("tempo")))}let h=null;h=n>=0?this.getOrCreateStaff(s,n):null!==this._lastBeat?this._lastBeat.voice.bar.staff:this.getOrCreateStaff(s,0);const c=h?this.getOrCreateBar(h,e):null,d=()=>{let f=this._musicalPosition;return null!==a&&(f+=a),f/e.calculateDuration(!1)};if(o>0){const f=new Qe;f.type=Ge.Tempo,f.value=o,f.ratioPosition=d(),this.hasSameTempo(e,f)||(e.tempoAutomations.push(f),0===e.index&&(e.score.tempo=f.value))}let u="";for(const f of i)switch(f.localName){case"rehearsal":e.section=new Fi,e.section.marker=f.innerText;break;case"segno":e.addDirection(I.TargetSegno);break;case"coda":e.addDirection(I.TargetCoda);break;case"words":u=f.innerText;break;case"wedge":switch(f.getAttribute("type")){case"crescendo":this._nextBeatCrescendo=Ft.Crescendo;break;case"diminuendo":this._nextBeatCrescendo=Ft.Decrescendo;break;case"stop":this._nextBeatCrescendo=null}break;case"dynamics":const p=this.parseDynamics(f);null!==p&&(this._currentDynamics=p,this._score.stylesheet.hideDynamics=!1);break;case"dashes":const g=f.getAttribute("type","start");switch(u){case"LetRing":this._nextBeatLetRing="start"===g||"continue"===g;break;case"P.M.":this._nextBeatPalmMute="start"===g||"continue"===g}u="";break;case"pedal":const b=this.parsePedal(f);b&&c&&(b.ratioPosition=d(),(b.pedalType!==rt.Up||c.sustainPedals.length>0&&c.sustainPedals[c.sustainPedals.length-1].pedalType!==rt.Up)&&c.sustainPedals.push(b));break;case"metronome":this.parseMetronome(f,e,d());break;case"octave-shift":this._nextBeatOttavia=this.parseOctaveShift(f)}u&&(this._nextBeatText=u)}parseOctaveShift(t){const e=t.getAttribute("type");switch(Number.parseInt(t.getAttribute("size","8"))){case 15:switch(e){case"up":return le._15mb;case"down":return le._15ma;case"stop":return le.Regular;case"continue":return this._nextBeatOttavia}break;case 8:switch(e){case"up":return le._8vb;case"down":return le._8va;case"stop":return le.Regular;case"continue":return this._nextBeatOttavia}}return null}parseMetronome(t,e,s){let i=null,a=-1;for(const n of t.childElements())switch(n.localName){case"beat-unit":i=this.parseBeatDuration(n);break;case"per-minute":a=Number.parseFloat(n.innerText)}if(null!==i&&a>0){const n=new Qe;n.type=Ge.Tempo,n.value=a*(i/4)|0,n.ratioPosition=s,this.hasSameTempo(e,n)||(e.tempoAutomations.push(n),0===e.index&&(e.score.tempo=n.value))}}hasSameTempo(t,e){for(const s of t.tempoAutomations)if(e.ratioPosition===s.ratioPosition&&e.value===s.value)return!0;return!1}parsePedal(t){const e=new Ks;switch(t.getAttribute("type")){case"start":e.pedalType=rt.Down;break;case"stop":e.pedalType=rt.Up;break;case"continue":e.pedalType=rt.Hold;break;default:return null}return e}parseDynamics(t){for(const e of t.childElements()){const s=e.localName.toUpperCase();switch(s){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":return J[s]}}return null}parseForward(t){for(const e of t.childElements())"duration"===e.localName&&(this._musicalPosition+=this.musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(e.innerText)))}parseBackup(t){for(const e of t.childElements())if("duration"===e.localName&&this._lastBeat){let i=this._musicalPosition;i-=this.musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(e.innerText)),i<0&&(i=0),this._musicalPosition=i}}getOrCreateStaff(t,e){for(;t.staves.length<=e;){const s=new xr;t.addStaff(s),this._score.masterBars.length>0&&this.getOrCreateBar(s,this._score.masterBars[this._score.masterBars.length-1])}return t.staves[e]}getOrCreateBar(t,e){const s=0===t.bars.length?1:t.bars[0].voices.length;for(;t.bars.length<=e.index;){const i=new Ts;t.addBar(i),i.previousBar&&(i.clef=i.previousBar.clef,i.clefOttava=i.previousBar.clefOttava,i.keySignature=i.previousBar.keySignature,i.keySignatureType=i.previousBar.keySignatureType),null!=this._keyAllStaves&&(i.keySignature=this._keyAllStaves[0],i.keySignatureType=this._keyAllStaves[1]);for(let a=0;a<s;a++){const n=new es;i.addVoice(n)}}return t.bars[e.index]}getOrCreateVoice(t,e){let s=!1;for(;t.voices.length<=e;)t.addVoice(new es),s=!0;if(s)for(const i of t.staff.bars)for(;i.voices.length<=e;)i.addVoice(new es);return t.voices[e]}parseNote(t,e,s){let i=null,a=K.None,n=0,o=null,h=!1,c=0,d=0,u=-1,f=null,p=0,g=-1,b=-1,w=null,S=null,D=!1,N=null;const L="no"!==t.getAttribute("print-object","yes"),$=()=>{if(null!==i)return;h&&!this._lastBeat&&(x.warning("MusicXML","Malformed MusicXML, <chord /> cannot be set on the first note of a measure"),h=!1),h&&!S&&(x.warning("MusicXML","Cannot mix <chord /> and <rest />"),h=!1);const E=this.getOrCreateStaff(s,c);if(h)return i=this._lastBeat,void i.addNote(S);const B=this.getOrCreateBar(E,e),ie=this.getOrCreateVoice(B,d);let Ne=this._musicalPosition-(0===ie.beats.length?0:ie.beats[ie.beats.length-1].displayEnd);if(Ne>0){if(this._lastBeat&&this._lastBeat.beamingMode===ze.ForceMergeWithNext&&this._lastBeat.voice.bar.staff.index!==c&&ie.beats.length>0&&ie.beats[ie.beats.length-1].beamingMode===ze.ForceMergeWithNext){const Bt=ie.beats[ie.beats.length-1].duration;for(;Ne>0;){const Ht=this.createRestForGap(Ne,Bt);if(null===Ht)break;this.insertBeatToVoice(Ht,ie),Ne-=Ht.playbackDuration}}if(Ne>0){const Bt=new xt;Bt.dynamics=this._currentDynamics,Bt.isEmpty=!0,Bt.duration=m.TwoHundredFiftySixth,Bt.overrideDisplayDuration=Ne,Bt.updateDurations(),this.insertBeatToVoice(Bt,ie)}}else Ne<0&&x.error("MusicXML","Unsupported forward/backup detected. Cannot fill new beats into already filled area of voice");u<0&&null!==f&&(u=C.toTicks(f),p>0&&(u=C.applyDot(u,2===p)));const ee=new xt;i=ee,null===o?ee.beamingMode=this.getStaffContext(E).isExplicitlyBeamed?ze.ForceSplitToNext:ze.Auto:(ee.beamingMode=o,this.getStaffContext(E).isExplicitlyBeamed=!0),ee.isEmpty=!1,ee.dynamics=this._currentDynamics,this._isBeatSlash&&(ee.slashed=!0);const Ve=this._nextBeatAutomations;if(this._nextBeatAutomations=null,null!==Ve)for(const Bt of Ve)ee.automations.push(Bt);const At=this._nextBeatChord;this._nextBeatChord=null,null!==At&&(ee.chordId=At.uniqueId,ie.bar.staff.hasChord(At.uniqueId)||ie.bar.staff.addChord(ee.chordId,At));const ss=this._nextBeatCrescendo;null!==ss&&(ee.crescendo=ss);const ls=this._nextBeatOttavia;if(null!==ls&&(ee.ottava=ls),ee.isLetRing=this._nextBeatLetRing,ee.isPalmMute=this._nextBeatPalmMute,this._nextBeatText&&(ee.text=this._nextBeatText,this._nextBeatText=null),null!==S&&ee.addNote(S),this.insertBeatToVoice(ee,ie),null!==S){S.isVisible=L;const Bt=this._indexToTrackInfo.get(s.index);null!==N?S.percussionArticulation=Bt.getOrCreateArticulation(N,S):D||(S.percussionArticulation=Bt.getOrCreateArticulation("",S))}a!==K.None?(ee.graceType=a,this.applyBeatDurationFromTicks(ee,n,null,!1)):(ee.tupletNumerator=g,ee.tupletDenominator=b,ee.dots=p,ee.preferredBeamDirection=w,this.applyBeatDurationFromTicks(ee,u,f,!0)),this._musicalPosition=ee.displayEnd,this._lastBeat=ee};for(const E of t.childElements())switch(E.localName){case"grace":const B=Number.parseFloat(E.getAttribute("make-time","-1"));B>=0?(n=this.musicXmlDivisionsToAlphaTabTicks(B),a=K.BeforeBeat):a=K.OnBeat,"yes"===E.getAttribute("slash")&&(a=K.BeforeBeat);break;case"chord":h=!0;break;case"cue":return;case"pitch":S=this.parsePitch(E),D=!0;break;case"unpitched":S=this.parseUnpitched(E,s);break;case"rest":S=null,null===f&&(f=m.Whole);break;case"duration":u=this.parseDuration(E);break;case"instrument":N=E.getAttribute("id","");break;case"voice":d=Number.parseInt(E.innerText),Number.isNaN(d)?(x.warning("MusicXML","Voices need to be specified as numbers"),d=0):d-=1;break;case"type":f=this.parseBeatDuration(E);break;case"dot":p++;break;case"accidental":null===S?x.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.parseAccidental(E,S);break;case"time-modification":for(const ie of E.childElements())switch(ie.localName){case"actual-notes":g=Number.parseInt(ie.innerText);break;case"normal-notes":b=Number.parseInt(ie.innerText)}break;case"stem":w=this.parseStem(E);break;case"notehead":null===S?x.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.parseNoteHead(E,S,f??m.Quarter,w??this.estimateBeamDirection(S));break;case"staff":c=Number.parseInt(E.innerText)-1;break;case"beam":if("1"===E.getAttribute("number","1"))switch(E.innerText){case"begin":case"continue":o=ze.ForceMergeWithNext;break;case"end":o=ze.ForceSplitToNext}break;case"notations":$(),this.parseNotations(E,S,i);break;case"lyric":$(),this.parseLyric(E,i,s);break;case"play":this.parsePlay(E,S)}if(D){const E=this.getOrCreateStaff(s,c),B=this.getStaffContext(E).transpose;if(0!==B){const ie=12*S.octave+S.tone+B;S.octave=ie/12|0,S.tone=ie-12*S.octave}}$()}parsePlay(t,e){for(const s of t.childElements())"mute"===s.localName&&e&&"palm"===s.innerText&&(e.isPalmMute=!0)}estimateBeamDirection(t){return t.calculateRealValue(!1,!1)<ve.B4Value?P.Down:P.Up}parseNoteHead(t,e,s,i){"yes"===t.getAttribute("parentheses","no")&&(e.isGhost=!0);const a=t.getAttribute("filled","");let n;switch("yes"===a?n=!0:"no"===a&&(n=!1),e.style=new Ta,t.innerText){case"arrow down":e.style.noteHeadCenterOnStem=!0,this.applyNoteHead(e,s,n,l.NoteheadTriangleDownDoubleWhole,l.NoteheadTriangleDownWhole,l.NoteheadTriangleDownHalf,l.NoteheadTriangleDownBlack);break;case"arrow up":e.style.noteHeadCenterOnStem=!0,this.applyNoteHead(e,s,n,l.NoteheadTriangleUpDoubleWhole,l.NoteheadTriangleUpWhole,l.NoteheadTriangleUpHalf,l.NoteheadTriangleUpBlack);break;case"back slashed":this.applyNoteHead(e,s,n,l.NoteheadSlashedDoubleWhole2,l.NoteheadSlashedWhole2,l.NoteheadSlashedHalf2,l.NoteheadSlashedBlack2);break;case"circle dot":e.style.noteHead=l.NoteheadRoundWhiteWithDot;break;case"circle-x":this.applyNoteHead(e,s,n,l.NoteheadCircleXDoubleWhole,l.NoteheadCircleXWhole,l.NoteheadCircleXHalf,l.NoteheadCircleX);break;case"circled":this.applyNoteHead(e,s,n,l.NoteheadCircledDoubleWhole,l.NoteheadCircledWhole,l.NoteheadCircledHalf,l.NoteheadCircledBlack);break;case"cluster":this.applyNoteHead(e,s,n,l.NoteheadClusterDoubleWhole3rd,l.NoteheadClusterWhole3rd,l.NoteheadClusterHalf3rd,l.NoteheadClusterQuarter3rd);break;case"cross":this.applyNoteHead(e,s,n,l.NoteheadPlusDoubleWhole,l.NoteheadPlusWhole,l.NoteheadPlusHalf,l.NoteheadPlusBlack);break;case"diamond":this.applyNoteHead(e,s,n,l.NoteheadDiamondDoubleWhole,l.NoteheadDiamondWhole,l.NoteheadDiamondHalf,l.NoteheadDiamondBlack);break;case"do":this.applyNoteHead(e,s,n,l.NoteShapeTriangleUpWhite,l.NoteShapeTriangleUpWhite,l.NoteShapeTriangleUpWhite,l.NoteShapeTriangleUpBlack);break;case"fa":i===P.Up?this.applyNoteHead(e,s,n,l.NoteShapeTriangleRightWhite,l.NoteShapeTriangleRightWhite,l.NoteShapeTriangleRightWhite,l.NoteShapeTriangleRightBlack):this.applyNoteHead(e,s,n,l.NoteShapeTriangleLeftWhite,l.NoteShapeTriangleLeftWhite,l.NoteShapeTriangleLeftWhite,l.NoteShapeTriangleLeftBlack);break;case"fa up":this.applyNoteHead(e,s,n,l.NoteShapeTriangleLeftWhite,l.NoteShapeTriangleLeftWhite,l.NoteShapeTriangleLeftWhite,l.NoteShapeTriangleLeftBlack);break;case"inverted triangle":this.applyNoteHead(e,s,n,l.NoteheadTriangleDownDoubleWhole,l.NoteheadTriangleDownWhole,l.NoteheadTriangleDownHalf,l.NoteheadTriangleDownBlack);break;case"la":case"square":this.applyNoteHead(e,s,n,l.NoteShapeSquareWhite,l.NoteShapeSquareWhite,l.NoteShapeSquareWhite,l.NoteShapeSquareBlack);break;case"left triangle":this.applyNoteHead(e,s,n,l.NoteheadTriangleRightWhite,l.NoteheadTriangleRightWhite,l.NoteheadTriangleRightWhite,l.NoteheadTriangleRightBlack);break;case"mi":this.applyNoteHead(e,s,n,l.NoteShapeDiamondWhite,l.NoteShapeDiamondWhite,l.NoteShapeDiamondWhite,l.NoteShapeDiamondBlack);break;case"none":e.style.noteHead=l.NoteheadNull;break;case"normal":this.applyNoteHead(e,s,n,l.NoteheadDoubleWhole,l.NoteheadWhole,l.NoteheadHalf,l.NoteheadBlack);break;case"re":this.applyNoteHead(e,s,n,l.NoteShapeMoonWhite,l.NoteShapeMoonWhite,l.NoteShapeMoonWhite,l.NoteShapeMoonBlack);break;case"rectangle":this.applyNoteHead(e,s,n,l.NoteheadSquareWhite,l.NoteheadSquareWhite,l.NoteheadSquareWhite,l.NoteheadSquareBlack);break;case"slash":this.applyNoteHead(e,s,n,l.NoteheadSlashWhiteWhole,l.NoteheadSlashWhiteWhole,l.NoteheadSlashWhiteHalf,l.NoteheadSlashVerticalEnds);break;case"slashed":this.applyNoteHead(e,s,n,l.NoteheadSlashedDoubleWhole1,l.NoteheadSlashedWhole1,l.NoteheadSlashedHalf1,l.NoteheadSlashedBlack1);break;case"so":this.applyNoteHead(e,s,n,l.NoteShapeRoundWhite,l.NoteShapeRoundWhite,l.NoteShapeRoundWhite,l.NoteShapeRoundBlack);break;case"ti":this.applyNoteHead(e,s,n,l.NoteShapeTriangleRoundWhite,l.NoteShapeTriangleRoundWhite,l.NoteShapeTriangleRoundWhite,l.NoteShapeTriangleRoundBlack);break;case"triangle":this.applyNoteHead(e,s,n,l.NoteheadTriangleUpDoubleWhole,l.NoteheadTriangleUpWhole,l.NoteheadTriangleUpHalf,l.NoteheadTriangleUpBlack);break;case"x":this.applyNoteHead(e,s,n,l.NoteheadXDoubleWhole,l.NoteheadXWhole,l.NoteheadXHalf,l.NoteheadXBlack)}}createRestForGap(t,e){let s=C.toTicks(e);for(;s>t;){if(e===m.TwoHundredFiftySixth)return null;s=C.toTicks(e*=2)}const i=new xt;return i.dynamics=this._currentDynamics,i.isEmpty=!1,i.duration=e,i.overrideDisplayDuration=s,i.updateDurations(),i}insertBeatToVoice(t,e){if(e.beats.length>0){const s=e.beats[e.beats.length-1];s.nextBeat=t,t.previousBeat=s;let i=s;for(;null!==i&&i.graceType!==K.None;)i=i.index>0?i.previousBeat:null;null!==i&&(t.displayStart=i.displayEnd)}e.addBeat(t)}musicXmlDivisionsToAlphaTabTicks(t){return t*C.QuarterTime/this._divisionsPerQuarterNote}parseBeatDuration(t){switch(t.innerText){case"1024th":case"512th":case"256th":return m.TwoHundredFiftySixth;case"128th":return m.OneHundredTwentyEighth;case"64th":return m.SixtyFourth;case"32nd":return m.ThirtySecond;case"16th":return m.Sixteenth;case"eighth":return m.Eighth;case"quarter":return m.Quarter;case"half":return m.Half;case"whole":return m.Whole;case"breve":return m.DoubleWhole;case"long":return m.QuadrupleWhole}return null}applyBeatDurationFromTicks(t,e,s,i){if(!s)for(let a=0;a<ve.allDurations.length&&e>=ve.allDurationTicks[a];a++)s=ve.allDurations[a];t.duration=s??m.Sixteenth,i&&(t.overrideDisplayDuration=e),t.updateDurations()}parseLyric(t,e,s){const a=this._indexToTrackInfo.get(s.index).getLyricLine(t.getAttribute("number",""));for(null===e.lyrics&&(e.lyrics=[]);e.lyrics.length<=a;)e.lyrics.push("");for(const n of t.childElements())switch(n.localName){case"text":e.lyrics[a]?e.lyrics[a]+=` ${n.innerText}`:e.lyrics[a]=n.innerText;break;case"elision":e.lyrics[a]+=n.innerText}}parseNotations(t,e,s){for(const i of t.childElements())switch(i.localName){case"tied":e&&this.parseTied(i,e,s.voice.bar.staff);break;case"slur":e&&this.parseSlur(i,e);break;case"glissando":e&&this.parseGlissando(i,e);break;case"slide":e&&this.parseSlide(i,e);break;case"ornaments":e&&this.parseOrnaments(i,e);break;case"technical":this.parseTechnical(i,e,s);break;case"articulations":e&&this.parseArticulations(i,e);break;case"dynamics":const a=this.parseDynamics(i);null!==a&&(s.dynamics=a,this._currentDynamics=a);break;case"fermata":this.parseFermata(i,s);break;case"arpeggiate":this.parseArpeggiate(i,s)}}getStaffContext(t){if(!this._staffToContext.has(t)){const e=new Ch;return this._staffToContext.set(t,e),e}return this._staffToContext.get(t)}parseGlissando(t,e){const s=t.getAttribute("type"),i=t.getAttribute("number","1"),a=this.getStaffContext(e.beat.voice.bar.staff);switch(s){case"start":a.slideOrigins.set(i,e);break;case"stop":if(a.slideOrigins.has(i)){const n=a.slideOrigins.get(i);n.slideTarget=e,e.slideOrigin=n,n.slideOutType=ce.Shift}}}parseSlur(t,e){const s=t.getAttribute("number","1"),i=this.getStaffContext(e.beat.voice.bar.staff);switch(t.getAttribute("type")){case"start":i.slurStarts.set(s,e);break;case"stop":if(i.slurStarts.has(s)){e.isSlurDestination=!0;const a=i.slurStarts.get(s);a.slurDestination=e,e.slurOrigin=a,i.slurStarts.delete(s)}}}parseArpeggiate(t,e){switch(t.getAttribute("direction","down")){case"down":e.brushType=V.ArpeggioDown;break;case"up":e.brushType=V.ArpeggioUp}}parseFermata(t,e){let s;switch(t.innerText){case"normal":default:s=Ct.Medium;break;case"angled":s=Ct.Short;break;case"square":s=Ct.Long}e.fermata=new Ei,e.fermata.type=s}parseArticulations(t,e){for(const s of t.childElements())switch(s.localName){case"accent":e.accentuated=et.Normal;break;case"strong-accent":e.accentuated=et.Heavy;break;case"staccato":e.isStaccato=!0;break;case"tenuto":e.accentuated=et.Tenuto}}parseTechnical(t,e,s){const i=[];for(const a of t.childElements())switch(a.localName){case"up-bow":s.pickStroke=yt.Up;break;case"down-bow":s.pickStroke=yt.Down;break;case"harmonic":break;case"fingering":e&&(e.leftHandFinger=this.parseFingering(a));break;case"pluck":e&&(e.rightHandFinger=this.parseFingering(a));break;case"fret":e&&(e.fret=Number.parseInt(a.innerText));break;case"string":e&&(e.string=s.voice.bar.staff.tuning.length-Number.parseInt(a.innerText)+1);break;case"hammer-on":case"pull-off":e&&(e.isHammerPullOrigin=!0);break;case"bend":i.push(a);break;case"tap":s.tap=!0;break;case"smear":e&&(e.vibrato=ke.Slight);break;case"golpe":switch(a.getAttribute("placement","above")){case"above":s.golpe=Gt.Finger;break;case"below":s.golpe=Gt.Thumb}}e&&i.length>0&&this.parseBends(i,e)}parseBends(t,e){const s=R.MaxPosition/t.length;let i=0,a=0,n=!0;for(const o of t){const h=o.findChildElement("bend-alter");if(h){const c=Math.round(2*Math.abs(Number.parseFloat(h.innerText)));o.findChildElement("pre-bend")?n?(i+=c,e.addBendPoint(new R(a,i)),a+=s,e.addBendPoint(new R(a,i)),n=!1):a+=s:o.findChildElement("release")?(n&&(i+=c),e.addBendPoint(new R(a,i)),a+=s,i-=c,e.addBendPoint(new R(a,i)),n=!1):(e.addBendPoint(new R(a,i)),i+=c,a+=s,e.addBendPoint(new R(a,i)),n=!1)}}}parseFingering(t){switch(t.innerText){case"0":return Q.NoOrDead;case"1":case"p":case"t":return Q.Thumb;case"2":case"i":return Q.IndexFinger;case"3":case"m":return Q.MiddleFinger;case"4":case"a":return Q.AnnularFinger;case"5":case"c":return Q.LittleFinger}return Q.Unknown}parseOrnaments(t,e){let s=-1;for(const i of t.childElements())switch(i.localName){case"trill-mark":s=Number.parseInt(i.getAttribute("trill-step","2")),e.isStringed?e.trillValue=e.stringTuning+s:e.isPercussion||(e.trillValue=e.calculateRealValue(!1,!1)+s);break;case"turn":e.ornament=tt.Turn;break;case"inverted-turn":e.ornament=tt.InvertedTurn;break;case"wavy-line":s>0?"start"===i.getAttribute("type")&&(this._currentTrillStep=s):this._currentTrillStep>0?"stop"===i.getAttribute("type")?this._currentTrillStep=-1:e.isStringed?e.trillValue=e.stringTuning+this._currentTrillStep:e.isPercussion||(e.trillValue=e.calculateRealValue(!1,!1)+this._currentTrillStep):e.vibrato=ke.Slight;break;case"mordent":e.ornament=tt.LowerMordent;break;case"inverted-mordent":e.ornament=tt.UpperMordent;break;case"tremolo":switch(i.innerText){case"1":e.beat.tremoloSpeed=m.Eighth;break;case"2":e.beat.tremoloSpeed=m.Sixteenth;break;case"3":e.beat.tremoloSpeed=m.ThirtySecond}}}parseSlide(t,e){const s=t.getAttribute("type"),i=t.getAttribute("number","1"),a=this.getStaffContext(e.beat.voice.bar.staff);switch(s){case"start":a.slideOrigins.set(i,e);break;case"stop":if(a.slideOrigins.has(i)){const n=a.slideOrigins.get(i);n.slideTarget=e,e.slideOrigin=n,n.slideOutType=ce.Shift}}}parseTied(t,e,s){const i=t.getAttribute("type"),a=t.getAttribute("number",""),n=this.getStaffContext(s);if("start"===i){if(a){if(n.tieStartIds.has(a)){const o=n.tieStartIds.get(a);n.tieStarts.delete(o)}n.tieStartIds.set(a,e)}n.tieStarts.add(e)}else if("stop"===i&&!e.isTieDestination){let o=null;if(a){if(!n.tieStartIds.has(a))return;o=n.tieStartIds.get(a),n.tieStartIds.delete(a),n.tieStarts.delete(e)}else{const h=this.calculatePitchedNoteValue(e);for(const c of n.tieStarts)if(this.calculatePitchedNoteValue(c)===h){o=c,n.tieStarts.delete(o);break}}if(!o)return;e.isTieDestination=!0,e.tieOrigin=o}}parseStem(t){switch(t.innerText){case"down":return P.Down;case"up":return P.Up;default:return null}}parseAccidental(t,e){switch(t.innerText){case"sharp":e.accidentalMode=ge.ForceSharp;break;case"natural":e.accidentalMode=ge.ForceNatural;break;case"flat":e.accidentalMode=ge.ForceFlat;break;case"double-sharp":e.accidentalMode=ge.ForceDoubleSharp;break;case"flat-flat":e.accidentalMode=ge.ForceDoubleFlat}}calculatePitchedNoteValue(t){return 12*t.octave+t.tone}parseDuration(t){return this.musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(t.innerText))}parseUnpitched(t,e){let s="",i=0;for(const n of t.childElements())switch(n.localName){case"display-step":s=n.innerText;break;case"display-octave":i=Number.parseInt(n.innerText)+1}const a=new ts;if(""===s)a.octave=0,a.tone=0;else{const n=12*i+O.getToneForText(s).noteValue;a.octave=n/12|0,a.tone=n-12*a.octave}return a}parsePitch(t){let e="",s=0,i=0;for(const o of t.childElements())switch(o.localName){case"step":e=o.innerText;break;case"alter":s=Number.parseFloat(o.innerText),Number.isNaN(s)&&(s=0);break;case"octave":i=Number.parseInt(o.innerText)+1}s|=0;const a=12*i+O.getToneForText(e).noteValue+s,n=new ts;return n.octave=a/12|0,n.tone=a-12*n.octave,n}applyNoteHead(t,e,s,i,a,n,o){if(void 0===s)switch(e){case m.QuadrupleWhole:case m.DoubleWhole:t.style.noteHead=i;break;case m.Whole:t.style.noteHead=a;break;case m.Half:t.style.noteHead=n;break;default:t.style.noteHead=o}else if(!0===s)t.style.noteHead=o;else switch(e){case m.QuadrupleWhole:case m.DoubleWhole:t.style.noteHead=i;break;case m.Whole:t.style.noteHead=a;break;default:t.style.noteHead=n}}}ve.B4Value=71,ve.allDurations=[m.TwoHundredFiftySixth,m.OneHundredTwentyEighth,m.SixtyFourth,m.ThirtySecond,m.Sixteenth,m.Eighth,m.Quarter,m.Half,m.Whole,m.DoubleWhole,m.QuadrupleWhole],ve.allDurationTicks=ve.allDurations.map(r=>C.toTicks(r));var vi=function(r){return r[r.SingleTrackMultiChannel=0]="SingleTrackMultiChannel",r[r.MultiTrack=1]="MultiTrack",r}(vi||{});class Aa{constructor(){this.events=[]}addEvent(t){if(0===this.events.length||t.tick>=this.events[this.events.length-1].tick)this.events.push(t);else{let e=this.events.length;for(;e>0&&this.events[e-1].tick>t.tick;)e--;this.events.splice(e,0,t)}}writeTo(t){const e=Ke.empty();let s=0;for(const n of this.events)Ls.writeVariableInt(e,n.tick-s),n.writeTo(e),s=n.tick;const i=new Uint8Array([77,84,114,107]);t.write(i,0,i.length);const a=e.toArray();k.writeInt32BE(t,a.length),t.write(a,0,a.length)}}class Ls{constructor(){this.format=vi.SingleTrackMultiChannel,this.division=C.QuarterTime,this.tracks=[]}get events(){if(1===this.tracks.length)return this.tracks[0].events;const t=[];for(const e of this.tracks)this.events.push(...e.events);return t.sort((e,s)=>e.tick-s.tick),t}ensureTracks(t){for(;this.tracks.length<t;)this.tracks.push(new Aa)}addEvent(t){this.format===vi.SingleTrackMultiChannel?(this.ensureTracks(1),this.tracks[0].addEvent(t)):(this.ensureTracks(t.track+1),this.tracks[t.track].addEvent(t))}toBinary(){const t=Ke.empty();return this.writeTo(t),t.toArray()}writeTo(t){const e=new Uint8Array([77,84,104,100]);t.write(e,0,e.length),k.writeInt32BE(t,6),k.writeInt16BE(t,this.format),k.writeInt16BE(t,this.tracks.length),k.writeInt16BE(t,this.division);for(const s of this.tracks)s.writeTo(t)}static writeVariableInt(t,e){const s=new Uint8Array(4);let i=0;do{s[i++]=127&e,e>>=7}while(e>0);for(;i>0;)i--,t.writeByte(i>0?128|s[i]:s[i])}}var xe=function(r){return r[r.TimeSignature=88]="TimeSignature",r[r.NoteOn=128]="NoteOn",r[r.NoteOff=144]="NoteOff",r[r.ControlChange=176]="ControlChange",r[r.ProgramChange=192]="ProgramChange",r[r.TempoChange=81]="TempoChange",r[r.PitchBend=224]="PitchBend",r[r.PerNotePitchBend=96]="PerNotePitchBend",r[r.EndOfTrack=47]="EndOfTrack",r[r.AlphaTabRest=241]="AlphaTabRest",r[r.AlphaTabMetronome=242]="AlphaTabMetronome",r[r.SystemExclusive=240]="SystemExclusive",r[r.SystemExclusive2=247]="SystemExclusive2",r[r.Meta=255]="Meta",r}(xe||{});class ms{constructor(t,e,s){this.track=t,this.tick=e,this.type=s}get command(){return this.type}get message(){return 0}get data1(){return 0}get data2(){return 0}}class Ma extends ms{constructor(t,e,s,i,a,n){super(t,e,xe.TimeSignature),this.track=t,this.tick=e,this.numerator=s,this.denominatorIndex=i,this.midiClocksPerMetronomeClick=a,this.thirtySecondNodesInQuarter=n}writeTo(t){t.writeByte(255),t.writeByte(88),Ls.writeVariableInt(t,4),t.writeByte(255&this.numerator),t.writeByte(255&this.denominatorIndex),t.writeByte(255&this.midiClocksPerMetronomeClick),t.writeByte(255&this.thirtySecondNodesInQuarter)}}let ji=(()=>{class r extends ms{writeTo(e){e.writeByte(240);const s=Ke.withCapacity(16);s.writeByte(r.AlphaTabManufacturerId),this.writeEventData(s),s.writeByte(247),Ls.writeVariableInt(e,s.length),s.copyTo(e)}}return r.AlphaTabManufacturerId=125,r.MetronomeEventId=0,r.RestEventId=1,r})();class Ra extends ji{constructor(t,e,s,i,a){super(t,e,xe.AlphaTabMetronome),this.isMetronome=!0,this.metronomeNumerator=s,this.metronomeDurationInMilliseconds=a,this.metronomeDurationInTicks=i}writeEventData(t){t.writeByte(ji.MetronomeEventId),t.writeByte(this.metronomeNumerator),k.writeInt32LE(t,this.metronomeDurationInTicks),k.writeInt32LE(t,this.metronomeDurationInMilliseconds)}}class Oa extends ji{constructor(t,e,s){super(t,e,xe.AlphaTabRest),this.channel=s}writeEventData(t){t.writeByte(ji.RestEventId),t.writeByte(this.channel)}}class Ha extends ms{constructor(t,e,s,i,a,n){super(t,e,s),this.channel=i,this.noteKey=a,this.noteVelocity=n}get data1(){return this.noteKey}get data2(){return this.noteVelocity}}class Wa extends Ha{constructor(t,e,s,i,a){super(t,e,xe.NoteOn,s,i,a)}writeTo(t){t.writeByte(15&this.channel|144),t.writeByte(255&this.noteKey),t.writeByte(255&this.noteVelocity)}}class Va extends Ha{constructor(t,e,s,i,a){super(t,e,xe.NoteOff,s,i,a)}writeTo(t){t.writeByte(15&this.channel|128),t.writeByte(255&this.noteKey),t.writeByte(255&this.noteVelocity)}}class Ga extends ms{constructor(t,e,s,i,a){super(t,e,xe.ControlChange),this.channel=s,this.controller=i,this.value=a}writeTo(t){t.writeByte(15&this.channel|176),t.writeByte(255&this.controller),t.writeByte(255&this.value)}get data1(){return this.controller}get data2(){return this.value}}class za extends ms{constructor(t,e,s,i){super(t,e,xe.ProgramChange),this.channel=s,this.program=i}writeTo(t){t.writeByte(15&this.channel|192),t.writeByte(255&this.program)}get data1(){return this.program}}class Ua extends ms{get microSecondsPerQuarterNote(){return 6e7/this.beatsPerMinute}set microSecondsPerQuarterNote(t){this.beatsPerMinute=6e7/t}constructor(t,e){super(0,t,xe.TempoChange),this.beatsPerMinute=0,this.microSecondsPerQuarterNote=e}writeTo(t){t.writeByte(255),t.writeByte(81),t.writeByte(3),t.writeByte(this.microSecondsPerQuarterNote>>16&255),t.writeByte(this.microSecondsPerQuarterNote>>8&255),t.writeByte(255&this.microSecondsPerQuarterNote)}}class Ya extends ms{constructor(t,e,s,i){super(t,e,xe.PitchBend),this.channel=s,this.value=i}writeTo(t){t.writeByte(15&this.channel|224),t.writeByte(127&this.value),t.writeByte(this.value>>7&127)}get data1(){return 127&this.value}get data2(){return this.value>>7&127}}class Xa extends ms{constructor(t,e,s,i,a){super(t,e,xe.PerNotePitchBend),this.channel=s,this.noteKey=i,this.value=a}writeTo(t){throw new Le(Fe.General,"Note Bend (Midi2.0) events cannot be exported to SMF1.0")}}class Ja extends ms{constructor(t,e){super(t,e,xe.EndOfTrack)}writeTo(t){t.writeByte(255),t.writeByte(47),t.writeByte(0)}}class er{constructor(t,e){this.time=0,this.eventIndex=t,this.event=e,this.isMetronome=this.event.type===xe.AlphaTabMetronome}static newMetronomeEvent(t,e,s,i,a){const n=new Ra(0,e,s,i,a);return new er(t,n)}}class Ii{constructor(){this.masterBarIndex=0,this.masterBarOccurence=0,this.synthBpm=0,this.synthTime=0,this.synthTick=0,this.syncTime=0,this.syncBpm=0}updateSyncBpm(t,e){this.syncBpm=(t-this.synthTime)/(e-this.syncTime)*this.synthBpm}}class Jn{constructor(t,e,s){this.bpm=t,this.ticks=e,this.time=s}}class qa{constructor(){this.tempoChanges=[],this.tempoChangeIndex=0,this.syncPoints=[],this.firstProgramEventPerChannel=new Map,this.firstTimeSignatureNumerator=0,this.firstTimeSignatureDenominator=0,this.synthData=[],this.division=C.QuarterTime,this.eventIndex=0,this.currentTime=0,this.syncPointIndex=0,this.playbackRange=null,this.playbackRangeStartTime=0,this.playbackRangeEndTime=0,this.endTick=0,this.endTime=0,this.currentTempo=0,this.syncPointTempo=0}}class qn{get isPlayingMain(){return this._currentState===this._mainState}get isPlayingOneTimeMidi(){return this._currentState===this._oneTimeState}get isPlayingCountIn(){return this._currentState===this._countInState}constructor(t){this._oneTimeState=null,this._countInState=null,this.isLooping=!1,this.playbackSpeed=1,this.instrumentPrograms=new Set,this.percussionKeys=new Set,this._synthesizer=t,this._mainState=new qa,this._currentState=this._mainState}get mainPlaybackRange(){return this._mainState.playbackRange}set mainPlaybackRange(t){this._mainState.playbackRange=t,t&&(this._mainState.playbackRangeStartTime=this.tickPositionToTimePositionWithSpeed(this._mainState,t.startTick,1),this._mainState.playbackRangeEndTime=this.tickPositionToTimePositionWithSpeed(this._mainState,t.endTick,1))}get currentTime(){return this._currentState.currentTime/this.playbackSpeed}get currentEndTick(){return this._currentState.endTick}get currentEndTime(){return this._currentState.endTime/this.playbackSpeed}get currentTempo(){return this._currentState.currentTempo}get modifiedTempo(){return this._currentState.syncPointTempo*this.playbackSpeed}get syncPointTempo(){return this._currentState.syncPointTempo}get currentSyncPoints(){return this._currentState.syncPoints}mainSeek(t){if(t*=this.playbackSpeed,this.mainPlaybackRange&&(t<this._mainState.playbackRangeStartTime?t=this._mainState.playbackRangeStartTime:t>this._mainState.playbackRangeEndTime&&(t=this._mainState.playbackRangeEndTime)),t>this._mainState.currentTime)this.mainSilentProcess(t-this._mainState.currentTime);else if(t<this._mainState.currentTime){if(this._mainState.currentTime=0,this._mainState.eventIndex=0,this._mainState.syncPointIndex=0,this._mainState.tempoChangeIndex=0,this._mainState.currentTempo=this._mainState.tempoChanges[0].bpm,this._mainState.syncPointTempo=this._mainState.syncPoints.length>0?this._mainState.syncPoints[0].syncBpm:this._mainState.currentTempo,this.isPlayingMain){const e=this._synthesizer.metronomeVolume;this._synthesizer.noteOffAll(!0),this._synthesizer.resetSoft(),this._synthesizer.setupMetronomeChannel(e)}this.mainSilentProcess(t)}}mainSilentProcess(t){if(t<=0)return;const e=Date.now(),s=this._mainState.currentTime+t;if(this.isPlayingMain)for(;this._mainState.currentTime<s;)this.fillMidiEventQueueLimited(s-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(q.MicroBufferSize);this._mainState.currentTime=s;const i=Date.now()-e;x.debug("Sequencer",`Silent seek finished in ${i}ms (main)`)}loadOneTimeMidi(t){this._oneTimeState=this.createStateFromFile(t),this._currentState=this._oneTimeState}loadMidi(t){this.instrumentPrograms.clear(),this.percussionKeys.clear(),this._mainState=this.createStateFromFile(t),this._currentState=this._mainState}createStateFromFile(t){const e=new qa;this.percussionKeys.add(q.MetronomeKey),e.tempoChanges=[],e.division=t.division,e.eventIndex=0,e.currentTime=0,e.synthData=[];let s=120,i=0,a=0,n=0,o=0,h=0,c=0,d=0,u=0;for(const f of t.events){const p=new er(e.synthData.length,f);e.synthData.push(p);const g=f.tick-u;if(i+=g,a+=g*(6e4/(s*t.division)),p.time=a,u=f.tick,o>0)for(;c<i;){const b=er.newMetronomeEvent(e.synthData.length,c,Math.floor(c/o)%n,o,h);e.synthData.push(b),b.time=d,c+=o,d+=h}if(f.type===xe.TempoChange)s=f.beatsPerMinute,e.tempoChanges.push(new Jn(s,i,a)),h=o*(6e4/(s*t.division));else if(f.type===xe.TimeSignature){const b=f,w=Math.pow(2,b.denominatorIndex);n=b.numerator,o=e.division*(4/w)|0,h=o*(6e4/(s*t.division)),0===e.firstTimeSignatureDenominator&&(e.firstTimeSignatureNumerator=b.numerator,e.firstTimeSignatureDenominator=w)}else if(f.type===xe.ProgramChange){const b=f,w=b.channel;e.firstProgramEventPerChannel.has(w)||e.firstProgramEventPerChannel.set(w,p),w===q.PercussionChannel||this.instrumentPrograms.add(b.program)}else f.type===xe.NoteOn&&f.channel===q.PercussionChannel&&this.percussionKeys.add(f.noteKey)}return e.currentTempo=e.tempoChanges.length>0?e.tempoChanges[0].bpm:s,e.syncPointTempo=e.currentTempo,e.synthData.sort((f,p)=>f.time>p.time?1:f.time<p.time?-1:f.eventIndex-p.eventIndex),e.endTime=a,e.endTick=i,e}fillMidiEventQueue(){return this.fillMidiEventQueueLimited(-1)}fillMidiEventQueueToEndTime(t){for(;this._mainState.currentTime<t;)this.fillMidiEventQueueLimited(t-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(q.MicroBufferSize);let e=!1;for(this._currentState.currentTime=t;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime;)this._synthesizer.dispatchEvent(this._currentState.synthData[this._currentState.eventIndex]),this._currentState.eventIndex++,e=!0;return e}fillMidiEventQueueLimited(t){let e=q.MicroBufferSize/this._synthesizer.outSampleRate*1e3*this.playbackSpeed,s=this.internalEndTime;t>0&&(t<e&&(e=t),s=Math.min(this.internalEndTime,this._currentState.currentTime+t));let i=!1;for(this._currentState.currentTime+=e;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime&&this._currentState.currentTime<s;)this._synthesizer.dispatchEvent(this._currentState.synthData[this._currentState.eventIndex]),this._currentState.eventIndex++,i=!0;return i}mainTickPositionToTimePosition(t){return this.tickPositionToTimePositionWithSpeed(this._mainState,t,this.playbackSpeed)}mainUpdateSyncPoints(t){const e=this._mainState;if(t.sort((s,i)=>s.synthTick-i.synthTick),e.syncPoints=[],t.length>=0){let s=120,i=0,a=0,n=0;for(let o=0;o<t.length;o++){const h=t[o];let d,u,f,c=0;if(0===o)d=s,u=0,f=0;else{const p=t[o-1];d=p.syncBpm,u=p.syncTime,f=p.synthTick}for(;n<e.tempoChanges.length&&e.tempoChanges[n].ticks<=h.synthTick;){if(c=e.tempoChanges[n].ticks-i,c>0){i+=c,a+=c*(6e4/(s*e.division));const g=(h.syncTime-u)/(h.synthTick-f)*(i-f)+u,b=new Ii;b.synthTick=i,b.synthBpm=s,b.synthTime=a,b.syncTime=g,b.syncBpm=d}s=e.tempoChanges[n].bpm,n++}c=h.synthTick-i,i+=c,a+=c*(6e4/(s*e.division)),e.syncPoints.push(h)}}e.syncPointIndex=0,e.syncPointTempo=e.syncPoints.length>0?e.syncPoints[0].syncBpm:e.currentTempo}currentTimePositionToTickPosition(t){const e=this._currentState;if(0===e.tempoChanges.length)return 0;this.updateCurrentTempo(e,t*=this.playbackSpeed);const s=e.tempoChanges[e.tempoChangeIndex];return s.ticks+((t-s.time)/(6e4/(s.bpm*e.division))|0)+1}currentUpdateCurrentTempo(t){this.updateCurrentTempo(this._mainState,t*this.playbackSpeed)}updateCurrentTempo(t,e){let s=t.tempoChangeIndex;for(e<t.tempoChanges[s].time&&(s=0);s+1<t.tempoChanges.length&&t.tempoChanges[s+1].time<=e;)s++;s!==t.tempoChangeIndex&&(t.tempoChangeIndex=s,t.currentTempo=t.tempoChanges[t.tempoChangeIndex].bpm,0===t.syncPoints.length&&(t.syncPointTempo=t.currentTempo))}currentUpdateSyncPoints(t){this.updateSyncPoints(this._mainState,t)}updateSyncPoints(t,e){const s=t.syncPoints;if(s.length>0){let i=Math.min(t.syncPointIndex,s.length-1);for(e<s[i].syncTime&&(i=0);i+1<s.length&&s[i+1].syncTime<=e;)i++;i!==t.syncPointIndex&&(t.syncPointIndex=i,t.syncPointTempo=s[i].syncBpm)}else t.syncPointTempo=t.currentTempo}mainTimePositionFromBackingTrack(t,e){const s=this._mainState,i=s.syncPoints;if(t<0||0===i.length)return t;this.updateSyncPoints(this._mainState,t);const a=Math.min(s.syncPointIndex,i.length-1),n=i[a],o=t-n.syncTime;let h;if(a+1<i.length){const c=i[a+1];h=o/(c.syncTime-n.syncTime)*(c.synthTime-n.synthTime)}else h=o/(e-n.syncTime)*(s.endTime-n.synthTime);return(n.synthTime+h)/this.playbackSpeed}mainTimePositionToBackingTrack(t,e){const s=this._mainState,i=s.syncPoints;if(t<0||0===i.length)return t;t*=this.playbackSpeed;let a=Math.min(s.syncPointIndex,i.length-1);for(t<i[a].synthTime&&(a=0);a+1<i.length&&i[a+1].synthTime<=t;)a++;const n=i[a],o=t-n.synthTime;let h;if(a+1<i.length){const c=i[a+1];h=n.syncTime+o/(c.synthTime-n.synthTime)*(c.syncTime-n.syncTime)}else h=n.syncTime+o/(s.endTime-n.synthTime)*(e-n.syncTime);return h}tickPositionToTimePositionWithSpeed(t,e,s){let i=0,a=120,n=0;for(const o of t.tempoChanges){if(e<o.ticks)break;i=o.time,a=o.bpm,n=o.ticks}return i+=(e-=n)*(6e4/(a*t.division)),i/s}get internalEndTime(){return this.isPlayingMain&&this.mainPlaybackRange?this._currentState.playbackRangeEndTime:this._currentState.endTime}get isFinished(){return this._currentState.currentTime>=this.internalEndTime}stop(){this._currentState.currentTime=this.isPlayingMain&&this.mainPlaybackRange?this.mainPlaybackRange.startTick:0,this._currentState.eventIndex=0}resetOneTimeMidi(){this._oneTimeState=null,this._currentState=this._mainState}resetCountIn(){this._countInState=null,this._currentState=this._mainState}startCountIn(){this.generateCountInMidi(),this._currentState=this._countInState,this.stop(),this._synthesizer.noteOffAll(!0)}generateCountInMidi(){const t=new qa;t.division=this._mainState.division;let e=120,s=4,i=4;0===this._mainState.eventIndex?(e=this._mainState.tempoChanges[0].bpm,s=this._mainState.firstTimeSignatureNumerator,i=this._mainState.firstTimeSignatureDenominator):(e=this._synthesizer.currentTempo,s=this._synthesizer.timeSignatureNumerator,i=this._synthesizer.timeSignatureDenominator),t.tempoChanges.push(new Jn(e,0,0));const a=t.division*(4/i)|0,n=a*(6e4/(e*this._mainState.division));let o=0,h=0;for(let c=0;c<s;c++){const d=er.newMetronomeEvent(t.synthData.length,o,c,a,n);t.synthData.push(d),d.time=h,o+=a,h+=n}t.synthData.sort((c,d)=>c.time>d.time?1:c.time<d.time?-1:c.eventIndex-d.eventIndex),t.endTime=h,t.endTick=o,t.currentTempo=e,t.syncPointTempo=e,this._countInState=t}}var wt=function(r){return r[r.Paused=0]="Paused",r[r.Playing=1]="Playing",r}(wt||{});class bi{constructor(t,e){this.state=t,this.stopped=e}}class Fs{constructor(t,e,s,i,a,n,o){this.originalTempo=0,this.modifiedTempo=0,this.currentTime=t,this.endTime=e,this.currentTick=s,this.endTick=i,this.isSeek=a,this.originalTempo=n,this.modifiedTempo=o}}let Si=(()=>{class r{constructor(){this.id="",this.size=0}static load(e,s,i){if(e&&r.HeaderSize>e.size||i.position+r.HeaderSize>=i.length||(s.id=k.read8BitStringLength(i,4),s.id.charCodeAt(0)<=32||s.id.charCodeAt(0)>=122)||(s.size=k.readUInt32LE(i),e&&r.HeaderSize+s.size>e.size))return!1;e&&(e.size-=r.HeaderSize+s.size);const a="RIFF"===s.id;return!(a&&e||(a||"LIST"===s.id)&&(s.id=k.read8BitStringLength(i,4),s.id.charCodeAt(0)<=32||s.id.charCodeAt(0)>=122||(s.size-=4,0)))}}return r.HeaderSize=8,r})();class Lh{constructor(t,e,s,i){this.packetData=t,this.isBeginningOfStream=e,this.isEndOfStream=s,this.granulePosition=s?i:null}addData(t){const e=this.packetData,s=new Uint8Array(e.length+t.length);s.set(e,0),s.set(t,e.length)}}var Dr=function(r){return r[r.ContinuesPacket=1]="ContinuesPacket",r[r.BeginningOfStream=2]="BeginningOfStream",r[r.EndOfStream=4]="EndOfStream",r}(Dr||{});class Fh{constructor(t){this._readable=t}read(){const t=[];for(;this.findAndReadPage(t););return t}findAndReadPage(t){return!!this.seekPageHeader()&&this.readPage(t)}seekPageHeader(){for(let t=0;t<65536;t++){if(1399285583===k.readInt32LE(this._readable))return!0;this._readable.position-=3}return!1}readPage(t){const e=this._readable.readByte();if(-1===e||0!==e)return!1;const s=this._readable.readByte(),i=k.readInt64LE(this._readable);this._readable.skip(4),this._readable.skip(4),this._readable.skip(4);const a=this._readable.readByte();if(-1===a)return!1;const n=[];let o=0;for(let h=0;h<a;h++){const c=this._readable.readByte();o===n.length&&n.push(0),n[o]+=c,c<255&&o++}for(let h=0;h<n.length;h++){const c=new Uint8Array(n[h]);if(this._readable.read(c,0,c.length)!==c.length)return!1;if(0!==(s&Dr.ContinuesPacket)){if(0===t.length)throw new Le(Fe.Format,"OGG: Continuation page without any previous packets");t[t.length-1].addData(c)}else{const u=new Lh(c,0!==(s&Dr.BeginningOfStream)&&0===h,0!==(s&Dr.EndOfStream)&&h===n.length-1,i);t.push(u)}}return!0}}class Eh{constructor(){this.audioChannels=0,this.audioSampleRate=0,this.samples=new Float32Array(0),this.bitrateMaximum=0,this.bitrateNominal=0,this.bitrateMinimum=0,this.blocksize0=0,this.blocksize1=0}}class $n{constructor(){this.value=0,this.bitsRead=0}}let Qn=(()=>{class r{constructor(e){this._bitBucket=0n,this._bitCount=0n,this._overflowBits=0n,this._source=e}readByte(){return this.readBits(r.ByteSize)}readBit(){return 1===this.readBits(1)}readBytes(e){const s=new Uint8Array(e);for(let i=0;i<e;i++)s[i]=255&this.readByte();return s}readBits(e){if(0===e)return 0;const s=this.tryPeekBits(e);return this.skipBits(e),s.value}tryPeekBits(e){if(e<0||e>32)throw new Le(Fe.General,"IO: Cannot read more than 32 bits in one go");if(0===e)return new $n;const s=new $n;for(;this._bitCount<e;){const a=BigInt(this._source.readByte());if(-1n===a)return s.bitsRead=Number(this._bitCount),s.value=Number(this._bitBucket),this._bitBucket=0n,this._bitCount=0n,s;this._bitBucket=(0xffn&a)<<this._bitCount|this._bitBucket,this._bitCount+=8n,this._bitCount>32&&(this._overflowBits=a>>40n-this._bitCount&0xffn)}let i=this._bitBucket;return e<64&&(i&=(1n<<BigInt(e))-1n),s.value=Number(i),s.bitsRead=e,s}skipBits(e){let s=BigInt(e);if(0!==e)if(this._bitCount>s){if(this._bitBucket=e>31?0n:this._bitBucket>>s,this._bitCount>32){const i=this._bitCount-32n;this._bitBucket=this._bitBucket|this._overflowBits<<this._bitCount-s-i,i>e&&(this._overflowBits=this._overflowBits>>s&0xffn)}this._bitCount-=s}else if(this._bitCount===s)this._bitBucket=0n,this._bitCount=0n;else{for(s-=this._bitCount,this._bitCount=0n,this._bitBucket=0n;s>8;){if(-1===this._source.readByte()){s=0n;break}s-=8n}if(s>0){const i=BigInt(this._source.readByte());-1n===i||(this._bitBucket=i>>s,this._bitCount=8n-s)}}}}return r.ByteSize=8,r})();class vh{constructor(){this.codebooks=[],this.timeDomainTransforms=[],this.floors=[],this.residues=[],this.mappings=[],this.modes=[]}}class Es{static ilog(t){let e=0;for(;t>0;)++e,t>>=1;return e}static bitReverse(t,e=32){let s=BigInt(t);return s=(s&BigInt(2863311530))>>1n|(s&BigInt(1431655765))<<1n,s=(s&BigInt(3435973836))>>2n|(s&BigInt(858993459))<<2n,s=(s&BigInt(4042322160))>>4n|(s&BigInt(252645135))<<4n,s=(s&BigInt(4278255360))>>8n|(s&BigInt(16711935))<<8n,s=(s>>16n|s<<16n)>>32n-BigInt(e),Number(BigInt.asUintN(32,s))}static convertFromVorbisFloat32(t){const e=BigInt(t);let s=e&BigInt(2097151);const i=e&BigInt(2147483648),a=(e&BigInt(2145386496))>>21n;return 0n!==i&&(s=-s),Number(s)*Math.pow(2,Number(a)-788)}}class Ih{constructor(t){this._data=t}get(t){return this._data[t]}}class $a{get(t){return t}}$a.instance=new $a;class Ah{constructor(t,e){if(this._maxBits=0,this._overflowList=null,this._prefixList=null,this._prefixBitLength=0,this.dimensions=0,this.entries=0,this.mapType=0,5653314!==t.readBits(24))throw new Le(Fe.Format,"Vorbis: Book header had invalid signature!");this.dimensions=t.readBits(16),this.entries=t.readBits(24),this._lengths=new Int32Array(this.entries),this.initTree(t,e),this.initLookupTable(t)}get(t,e){return this._lookupTable[t*this.dimensions+e]}decodeScalar(t){let e=t.tryPeekBits(this._prefixBitLength);if(0===e.bitsRead)return-1;let s=this._prefixList[e.value];if(null!=s)return t.skipBits(s.length),s.value;if(e=t.tryPeekBits(this._maxBits),null!==this._overflowList)for(let i=0;i<this._overflowList.length;i++)if(s=this._overflowList[i],s.bits===(e.value&s.mask))return t.skipBits(s.length),s.value;return-1}initTree(t,e){let s,a,i=0;if(t.readBit()){let n=t.readBits(5)+1;for(let o=0;o<this.entries;){let h=t.readBits(Es.ilog(this.entries-o));for(;--h>=0;)this._lengths[o++]=n;++n}i=0,s=!1,a=n}else{a=-1,s=t.readBit();for(let n=0;n<this.entries;n++)!s||t.readBit()?(this._lengths[n]=t.readBits(5)+1,++i):this._lengths[n]=-1,this._lengths[n]>a&&(a=this._lengths[n])}if(this._maxBits=a,a>-1){let o,n=null;s&&i>=this.entries>>2&&(n=new Int32Array(this.entries),n.set(this._lengths.subarray(0,this.entries),0),s=!1),o=s?i:0;let h=null,c=null;if(s?0!==o&&(n=new Int32Array(o),c=new Int32Array(o),h=new Int32Array(o)):c=new Int32Array(this.entries),!this.computeCodewords(s,c,n,this._lengths,this.entries,h))throw new Le(Fe.Format,"Vorbis: Failed to compute codewords");const d=null==h?$a.instance:new Ih(h);e.generateTable(d,n??this._lengths,c),this._prefixList=e.prefixTree,this._prefixBitLength=e.tableBits,this._overflowList=e.overflowList}}computeCodewords(t,e,s,i,a,n){const o=new Uint32Array(32);let h=0,c=0;for(h=0;h<a&&!(i[h]>0);++h);if(h===a)return!0;this.addEntry(t,e,s,0,h,c++,i[h],n);for(let d=1;d<=i[h];++d)o[d]=1<<32-d;for(let d=h+1;d<a;++d){let u=i[d];if(u<=0)continue;for(;u>0&&0===o[u];)--u;if(0===u)return!1;const f=o[u];if(o[u]=0,this.addEntry(t,e,s,Es.bitReverse(f),d,c++,i[d],n),u!==i[d])for(let p=i[d];p>u;--p)o[p]=f+(1<<32-p)}return!0}addEntry(t,e,s,i,a,n,o,h){t?(e[n]=i,s[n]=o,h[n]=a):e[a]=i}initLookupTable(t){if(this.mapType=t.readBits(4),0===this.mapType)return;const e=Es.convertFromVorbisFloat32(t.readBits(32)),s=Es.convertFromVorbisFloat32(t.readBits(32)),i=t.readBits(4)+1,a=t.readBit();let n=this.entries*this.dimensions;const o=new Float32Array(n);1===this.mapType&&(n=this.lookup1Values());const h=new Uint32Array(n);for(let c=0;c<n;c++)h[c]=t.readBits(i);if(1===this.mapType)for(let c=0;c<this.entries;c++){let d=0,u=1;for(let f=0;f<this.dimensions;f++){const g=h[c/u%n|0]*s+e+d;o[c*this.dimensions+f]=g,a&&(d=g),u*=n}}else for(let c=0;c<this.entries;c++){let d=0,u=c*this.dimensions;for(let f=0;f<this.dimensions;f++){const p=h[u]*s+e+d;o[c*this.dimensions+f]=p,a&&(d=p),++u}}this._lookupTable=o}lookup1Values(){let t=Math.floor(Math.exp(Math.log(this.entries)/this.dimensions));return Math.floor(Math.pow(t+1,this.dimensions))<=this.entries&&++t,t}}class Mh{constructor(){this.value=0,this.length=0,this.bits=0,this.mask=0}}let Rh=(()=>{class r{constructor(){this.tableBits=0,this.prefixTree=[],this.overflowList=null}generateTable(e,s,i){const a=new Array(s.length);let n=0;for(let d=0;d<a.length;d++){const u=new Mh;u.value=e.get(d),u.length=s[d]<=0?99999:s[d],u.bits=i[d],u.mask=(1<<s[d])-1,a[d]=u,s[d]>0&&n<s[d]&&(n=s[d])}a.sort((d,u)=>{const f=d.length-u.length;return 0===f?d.bits-u.bits:f});const o=n>r.MAX_TABLE_BITS?r.MAX_TABLE_BITS:n,h=[];let c=null;for(let d=0;d<a.length&&a[d].length<99999;d++){const u=a[d].length;if(u>o)for(c=[];d<a.length&&a[d].length<99999;d++)c.push(a[d]);else{const f=1<<o-u,p=a[d];for(let g=0;g<f;g++){const b=g<<u|p.bits;for(;h.length<=b;)h.push(null);h[b]=p}}}for(;h.length<1<<o;)h.push(null);this.tableBits=o,this.prefixTree=h,this.overflowList=c}}return r.MAX_TABLE_BITS=10,r})();class Oh{constructor(t){t.readBits(16)}}class Hh{get executeChannel(){return(this.forceEnergy||this.amp>0)&&!this.forceNoEnergy}constructor(t){this.amp=0,this.forceEnergy=!1,this.forceNoEnergy=!1,this.coeff=t}}class Lr{constructor(t,e,s,i){if(this._order=t.readBits(8),this._rate=t.readBits(16),this._bark_map_size=t.readBits(16),this._ampBits=t.readBits(6),this._ampOfs=t.readBits(8),this._books=new Array(t.readBits(4)+1),this._order<1||this._rate<1||this._bark_map_size<1||0===this._books.length)throw new Le(Fe.Format,"Vorbis: Invalid Floor0 Data");this._ampDiv=(1<<this._ampBits)-1;for(let a=0;a<this._books.length;a++){const n=t.readBits(8);if(n<0||n>=i.length)throw new Le(Fe.Format,"Vorbis: Invalid Floor0 Data");const o=i[n];if(0===o.mapType||o.dimensions<1)throw new Le(Fe.Format,"Vorbis: Invalid Floor0 Data");this._books[a]=o}this._bookBits=Es.ilog(this._books.length),this._barkMaps=new Map([[e,this.synthesizeBarkCurve(e/2)],[s,this.synthesizeBarkCurve(s/2)]]),this._wMap=new Map([[e,this.synthesizeWDelMap(e/2)],[s,this.synthesizeWDelMap(s/2)]])}synthesizeBarkCurve(t){const e=this._bark_map_size/Lr.toBARK(this._rate/2),s=new Int32Array(t+1);for(let i=0;i<t-1;i++)s[i]=Math.min(this._bark_map_size-1,Math.floor(Lr.toBARK(this._rate/2/t*i)*e));return s[t]=-1,s}static toBARK(t){return 13.1*Math.atan(74e-5*t)+2.24*Math.atan(1.85e-8*t*t)+1e-4*t}synthesizeWDelMap(t){const e=Math.PI/this._bark_map_size,s=new Float32Array(t);for(let i=0;i<t;i++)s[i]=2*Math.cos(e*i);return s}unpack(t,e,s){const i=new Hh(new Float32Array(this._order+1));if(i.amp=t.readBits(this._ampBits),i.amp>0){i.amp=i.amp/this._ampDiv*this._ampOfs;const a=t.readBits(this._bookBits);if(a>=this._books.length)return i.amp=0,i;const n=this._books[a];for(let h=0;h<this._order;){const c=n.decodeScalar(t);if(-1===c)return i.amp=0,i;for(let d=0;h<this._order&&d<n.dimensions;d++,h++)i.coeff[h]=n.get(c,d)}let o=0;for(let h=0;h<this._order;){for(let c=0;h<this._order&&c<n.dimensions;h++,c++)i.coeff[h]+=o;o=i.coeff[h-1]}}return i}apply(t,e,s){const i=t,a=e/2;if(i.amp>0){const n=this._barkMaps.get(e),o=this._wMap.get(e);let h=0;for(h=0;h<this._order;h++)i.coeff[h]=2*Math.cos(i.coeff[h]);for(h=0;h<a;){let c=0;const d=n[h];let u=.5,f=.5;const p=o[d];for(c=1;c<this._order;c+=2)f*=p-i.coeff[c-1],u*=p-i.coeff[c];for(c===this._order?(f*=p-i.coeff[c-1],u*=u*(4-p*p),f*=f):(u*=u*(2-p),f*=f*(2+p)),f=i.amp/Math.sqrt(u+f)-this._ampOfs,f=Math.exp(.11512925*f),s[h]*=f;n[++h]===d;)s[h]*=f}}else s.fill(0,0,a)}}class Wh{constructor(){this.posts=new Int32Array(64),this.postCount=0,this.forceEnergy=!1,this.forceNoEnergy=!1}get executeChannel(){return(this.forceEnergy||this.postCount>0)&&!this.forceNoEnergy}}class Hs{constructor(t,e){let s=-1;this._partitionClass=new Int32Array(t.readBits(5));for(let n=0;n<this._partitionClass.length;n++)this._partitionClass[n]=t.readBits(4),this._partitionClass[n]>s&&(s=this._partitionClass[n]);++s,this._classDimensions=new Int32Array(s),this._classSubclasses=new Int32Array(s),this._classMasterbooks=new Array(s),this._classMasterBookIndex=new Int32Array(s),this._subclassBooks=new Array(s),this._subclassBookIndex=new Array(s);for(let n=0;n<s;n++){this._classDimensions[n]=t.readBits(3)+1,this._classSubclasses[n]=t.readBits(2),this._classSubclasses[n]>0&&(this._classMasterBookIndex[n]=t.readBits(8),this._classMasterbooks[n]=e[this._classMasterBookIndex[n]]),this._subclassBooks[n]=new Array(1<<this._classSubclasses[n]),this._subclassBookIndex[n]=new Int32Array(this._subclassBooks[n].length);for(let o=0;o<this._subclassBooks[n].length;o++){const h=t.readBits(8)-1;h>=0&&(this._subclassBooks[n][o]=e[h]),this._subclassBookIndex[n][o]=h}}this._multiplier=t.readBits(2),this._range=Hs._rangeLookup[this._multiplier],this._yBits=Hs._yBitsLookup[this._multiplier],++this._multiplier;const i=t.readBits(4),a=[];a.push(0),a.push(1<<i);for(let n=0;n<this._partitionClass.length;n++){const o=this._partitionClass[n];for(let h=0;h<this._classDimensions[o];h++)a.push(t.readBits(i))}this._xList=new Int32Array(a),this._lNeigh=new Int32Array(a.length),this._hNeigh=new Int32Array(a.length),this._sortIdx=new Int32Array(a.length),this._sortIdx[0]=0,this._sortIdx[1]=1;for(let n=2;n<this._lNeigh.length;n++){this._lNeigh[n]=0,this._hNeigh[n]=1,this._sortIdx[n]=n;for(let o=2;o<n;o++){const h=this._xList[o];h<this._xList[n]?h>this._xList[this._lNeigh[n]]&&(this._lNeigh[n]=o):h<this._xList[this._hNeigh[n]]&&(this._hNeigh[n]=o)}}for(let n=0;n<this._sortIdx.length-1;n++)for(let o=n+1;o<this._sortIdx.length;o++){if(this._xList[n]===this._xList[o])throw new Le(Fe.Format,"Vorbis: Invalid Floor1 Data");if(this._xList[this._sortIdx[n]]>this._xList[this._sortIdx[o]]){const h=this._sortIdx[n];this._sortIdx[n]=this._sortIdx[o],this._sortIdx[o]=h}}}unpack(t,e,s){const i=new Wh;if(t.readBit()){let a=2;i.posts[0]=t.readBits(this._yBits),i.posts[1]=t.readBits(this._yBits);for(let n=0;n<this._partitionClass.length;n++){const o=this._partitionClass[n],h=this._classDimensions[o],c=this._classSubclasses[o],d=(1<<c)-1;let u=0;if(c>0&&(u=this._classMasterbooks[o].decodeScalar(t),-1===u)){a=0;break}for(let f=0;f<h;f++){const p=this._subclassBooks[o][u&d];if(u>>=c,null!=p&&(i.posts[a]=p.decodeScalar(t),-1===i.posts[a])){a=0,n=this._partitionClass.length;break}++a}}i.postCount=a}return i}apply(t,e,s){const i=t,a=e/2;if(i.postCount>0){const n=this.unwrapPosts(i);let o=0,h=i.posts[0]*this._multiplier;for(let c=1;c<i.postCount;c++){const d=this._sortIdx[c];if(n[d]){const u=this._xList[d],f=i.posts[d]*this._multiplier;o<a&&this.renderLineMulti(o,h,Math.min(u,a),f,s),o=u,h=f}if(o>=a)break}o<a&&this.renderLineMulti(o,h,a,h,s)}else s.fill(0,0,a)}unwrapPosts(t){const e=new Array(64);e.fill(!1),e[0]=!0,e[1]=!0;const s=new Int32Array(64);s[0]=t.posts[0],s[1]=t.posts[1];for(let i=2;i<t.postCount;i++){const a=this._lNeigh[i],n=this._hNeigh[i],o=this.renderPoint(this._xList[a],s[a],this._xList[n],s[n],this._xList[i]),h=t.posts[i],c=this._range-o,d=o;let u;u=c<d?2*c:2*d,0!==h?(e[a]=!0,e[n]=!0,e[i]=!0,s[i]=h>=u?c>d?h-d+o:o-h+c-1:h%2==1?o-(h+1)/2:o+h/2):(e[i]=!1,s[i]=o)}for(let i=0;i<t.postCount;i++)t.posts[i]=s[i];return e}renderPoint(t,e,s,i,a){const n=i-e,o=s-t,d=Math.abs(n)*(a-t)/o|0;return n<0?e-d:e+d}renderLineMulti(t,e,s,i,a){const n=i-e,o=s-t;let h=Math.abs(n);const c=1-2*(n>>31&1),d=n/o|0;let u=t,f=e,p=-o;for(a[t]*=Hs.inverse_dB_table[e],h-=Math.abs(d)*o;++u<s;)f+=d,p+=h,p>=0&&(p-=o,f+=c),a[u]*=Hs.inverse_dB_table[f]}}Hs._rangeLookup=[256,128,86,64],Hs._yBitsLookup=[8,7,7,6],Hs.inverse_dB_table=new Float32Array([1.0649863e-7,1.1341951e-7,1.2079015e-7,1.2863978e-7,1.3699951e-7,1.4590251e-7,1.5538408e-7,1.6548181e-7,1.7623575e-7,1.8768855e-7,1.9988561e-7,2.128753e-7,2.2670913e-7,2.4144197e-7,2.5713223e-7,2.7384213e-7,2.9163793e-7,3.1059021e-7,3.3077411e-7,3.5226968e-7,3.7516214e-7,3.9954229e-7,4.255068e-7,4.5315863e-7,4.8260743e-7,5.1396998e-7,5.4737065e-7,5.8294187e-7,6.2082472e-7,6.6116941e-7,7.0413592e-7,7.4989464e-7,7.9862701e-7,8.505263e-7,9.0579828e-7,9.6466216e-7,10273513e-13,10941144e-13,11652161e-13,12409384e-13,13215816e-13,14074654e-13,14989305e-13,15963394e-13,17000785e-13,18105592e-13,19282195e-13,20535261e-13,21869758e-13,23290978e-13,24804557e-13,26416497e-13,2813319e-12,29961443e-13,31908506e-13,33982101e-13,36190449e-13,38542308e-13,41047004e-13,4371447e-12,46555282e-13,49580707e-13,5280274e-12,5623416e-12,59888572e-13,63780469e-13,67925283e-13,72339451e-13,77040476e-13,82047e-10,87378876e-13,93057248e-13,99104632e-13,10554501e-12,11240392e-12,11970856e-12,12748789e-12,13577278e-12,14459606e-12,15399272e-12,16400004e-12,17465768e-12,18600792e-12,19809576e-12,21096914e-12,22467911e-12,23928002e-12,25482978e-12,27139006e-12,28902651e-12,30780908e-12,32781225e-12,34911534e-12,37180282e-12,39596466e-12,42169667e-12,4491009e-11,47828601e-12,50936773e-12,54246931e-12,57772202e-12,61526565e-12,65524908e-12,69783085e-12,74317983e-12,79147585e-12,8429104e-11,89768747e-12,95602426e-12,.00010181521,.00010843174,.00011547824,.00012298267,.00013097477,.00013948625,.00014855085,.00015820453,.00016848555,.00017943469,.00019109536,.00020351382,.00021673929,.00023082423,.00024582449,.00026179955,.00027881276,.00029693158,.00031622787,.00033677814,.00035866388,.00038197188,.00040679456,.00043323036,.00046138411,.00049136745,.00052329927,.00055730621,.00059352311,.00063209358,.00067317058,716917e-9,.0007635063,.00081312324,.00086596457,.00092223983,.00098217216,.0010459992,.0011139742,.0011863665,.0012634633,.0013455702,.0014330129,.0015261382,.0016253153,.0017309374,.0018434235,.0019632195,.0020908006,.0022266726,.0023713743,.0025254795,.0026895994,.0028643847,.0030505286,.0032487691,.0034598925,.0036847358,.0039241906,.0041792066,.004450795,.0047400328,.0050480668,.0053761186,.0057254891,.0060975636,.0064938176,.0069158225,.0073652516,.0078438871,.0083536271,.0088964928,.009474637,.010090352,.01074608,.011444421,.012188144,.012980198,.013823725,.014722068,.015678791,.016697687,.017782797,.018938423,.020169149,.021479854,.022875735,.02436233,.025945531,.027631618,.029427276,.031339626,.033376252,.035545228,.037855157,.040315199,.042935108,.045725273,.048696758,.051861348,.055231591,.05882085,.062643361,.066714279,.071049749,.075666962,.080584227,.085821044,.091398179,.097337747,.1036633,.11039993,.11757434,.12521498,.13335215,.14201813,.15124727,.16107617,.1715438,.18269168,.19456402,.20720788,.22067342,.23501402,.25028656,.26655159,.28387361,.30232132,.32196786,.34289114,.36517414,.38890521,.41417847,.44109412,.4697589,.50028648,.53279791,.56742212,.6042964,.64356699,.68538959,.72993007,.77736504,.8278826,.88168307,.9389798,1]);class Vh{constructor(t,e,s,i){const a=t.readBits(16);switch(a){case 0:this.floor=new Lr(t,e,s,i);break;case 1:this.floor=new Hs(t,i);break;default:throw new Le(Fe.Format,`Vorbis: Invalid Floor type: ${a}`)}}apply(t,e,s){this.floor.apply(t,e,s)}unpack(t,e,s){return this.floor.unpack(t,e,s)}}class tr{constructor(t,e,s){this._begin=t.readBits(24),this._end=t.readBits(24),this._partitionSize=t.readBits(24)+1,this._classifications=t.readBits(6)+1,this._classBook=s[t.readBits(8)],this._cascade=new Int32Array(this._classifications);let i=0;for(let u=0;u<this._classifications;u++){const f=t.readBits(3);this._cascade[u]=t.readBit()?t.readBits(5)<<3|f:f,i+=tr.icount(this._cascade[u])}const a=new Int32Array(i);for(let u=0;u<i;u++)if(a[u]=t.readBits(8),0===s[a[u]].mapType)throw new Le(Fe.Format,"Vorbis: Invalid Residue 0");const n=this._classBook.entries;let o=this._classBook.dimensions,h=1;for(;o>0;){if(h*=this._classifications,h>n)throw new Le(Fe.Format,"Vorbis: Invalid Residue 0");--o}this._books=new Array(this._classifications),i=0;let d,c=0;for(let u=0;u<this._classifications;u++)if(d=Es.ilog(this._cascade[u]),this._books[u]=new Array(d),d>0){c=Math.max(c,d);for(let f=0;f<d;f++)(this._cascade[u]&1<<f)>0&&(this._books[u][f]=s[a[i++]])}this._maxStages=c,this._decodeMap=new Array(h);for(let u=0;u<h;u++){let f=u,p=h/this._classifications|0;this._decodeMap[u]=new Int32Array(this._classBook.dimensions);for(let g=0;g<this._classBook.dimensions;g++){const b=f/p|0;f-=b*p,p=p/this._classifications|0,this._decodeMap[u][g]=b}}this._channels=e}static icount(t){let e=0;for(;0!==t;)e+=1&t,t>>=1;return e}decode(t,e,s,i){const n=(this._end<s/2?this._end:s/2)-this._begin;if(n>0&&-1!==e.indexOf(!1)){const o=n/this._partitionSize,h=(o+this._classBook.dimensions-1)/this._classBook.dimensions|0,c=[];for(let d=0;d<this._channels;d++)c.push(new Array(h));for(let d=0;d<this._maxStages;d++)for(let u=0,f=0;u<o;f++){if(0===d)for(let p=0;p<this._channels;p++){const g=this._classBook.decodeScalar(t);if(!(g>=0&&g<this._decodeMap.length)){u=o,d=this._maxStages;break}c[p][f]=this._decodeMap[g]}for(let p=0;u<o&&p<this._classBook.dimensions;p++,u++){const g=this._begin+u*this._partitionSize;for(let b=0;b<this._channels;b++){const w=c[b][f][p];if(this._cascade[w]&1<<d){const S=this._books[w][d];if(S&&this.writeVectors(S,t,i,b,g,this._partitionSize)){u=o,d=this._maxStages;break}}}}}}}writeVectors(t,e,s,i,a,n){const o=s[i],h=n/t.dimensions,c=new Int32Array(h);for(let d=0;d<h;d++)if(c[d]=t.decodeScalar(e),-1===c[d])return!0;for(let d=0;d<t.dimensions;d++)for(let u=0;u<h;u++,a++)o[a]+=t.get(c[u],d);return!1}}class Gh extends tr{writeVectors(t,e,s,i,a,n){const o=s[i];for(let h=0;h<n;){const c=t.decodeScalar(e);if(-1===c)return!0;for(let d=0;d<t.dimensions;h++,d++)o[a+h]+=t.get(c,d)}return!1}}class zh extends tr{constructor(t,e,s){super(t,1,s),this._realChannels=e}decode(t,e,s,i){super.decode(t,e,s*this._realChannels,i)}writeVectors(t,e,s,i,a,n){let o=0;a/=this._realChannels;for(let h=0;h<n;){const c=t.decodeScalar(e);if(-1===c)return!0;for(let d=0;d<t.dimensions;d++,h++)s[o][a]+=t.get(c,d),++o===this._realChannels&&(o=0,a++)}return!1}}class Uh{constructor(t,e,s){const i=t.readBits(16);switch(i){case 0:this.residue=new tr(t,e,s);break;case 1:this.residue=new Gh(t,e,s);break;case 2:this.residue=new zh(t,e,s);break;default:throw new Le(Fe.Format,`Vorbis: Invalid Residue type: ${i}`)}}decode(t,e,s,i){this.residue.decode(t,e,s,i)}}class Yh{constructor(t,e,s,i,a){if(0!==t.readBits(16))throw new Le(Fe.Format,"Vorbis: Invalid mapping type!");let o=1;t.readBit()&&(o+=t.readBits(4));let h=0;t.readBit()&&(h=t.readBits(8)+1);const c=Es.ilog(e-1);this._couplingAngle=new Int32Array(h),this._couplingMangitude=new Int32Array(h);for(let u=0;u<h;u++){const f=t.readBits(c),p=t.readBits(c);if(f===p||f>e-1||p>e-1)throw new Le(Fe.Format,"Vorbis: Invalid magnitude or angle in mapping header!");this._couplingAngle[u]=p,this._couplingMangitude[u]=f}if(0!==t.readBits(2))throw new Le(Fe.Format,"Vorbis: Reserved bits not 0 in mapping header.");const d=new Int32Array(e);if(o>1)for(let u=0;u<e;u++)if(d[u]=t.readBits(4),d[u]>o)throw new Le(Fe.Format,"Vorbis: Invalid channel mux submap index in mapping header!");this._submapFloor=new Array(o),this._submapResidue=new Array(o);for(let u=0;u<o;u++){t.skipBits(8);const f=t.readBits(8);if(f>=s.length)throw new Le(Fe.Format,"Vorbis: Invalid floor number in mapping header!");const p=t.readBits(8);if(p>=i.length)throw new Le(Fe.Format,"Vorbis: Invalid residue number in mapping header!");this._submapFloor[u]=s[f],this._submapResidue[u]=i[p]}this._channelFloor=new Array(e),this._channelResidue=new Array(e);for(let u=0;u<e;u++)this._channelFloor[u]=this._submapFloor[d[u]],this._channelResidue[u]=this._submapResidue[d[u]];this._mdct=a}decodePacket(t,e,s){const i=e>>1,a=new Array(this._channelFloor.length),n=new Array(this._channelFloor.length);n.fill(!1);for(let o=0;o<this._channelFloor.length;o++)a[o]=this._channelFloor[o].unpack(t,e,o),n[o]=!a[o].executeChannel,s[o].fill(0,0,i);for(let o=0;o<this._couplingAngle.length;o++)(a[this._couplingAngle[o]].executeChannel||a[this._couplingMangitude[o]].executeChannel)&&(a[this._couplingAngle[o]].forceEnergy=!0,a[this._couplingMangitude[o]].forceEnergy=!0);for(let o=0;o<this._submapFloor.length;o++){for(let h=0;h<this._channelFloor.length;h++)(this._submapFloor[o]!==this._channelFloor[h]||this._submapResidue[o]!==this._channelResidue[h])&&(a[h].forceNoEnergy=!0);this._submapResidue[o].decode(t,n,e,s)}for(let o=this._couplingAngle.length-1;o>=0;o--)if(a[this._couplingAngle[o]].executeChannel||a[this._couplingMangitude[o]].executeChannel){const h=s[this._couplingMangitude[o]],c=s[this._couplingAngle[o]];for(let d=0;d<i;d++){let u,f;const p=h[d],g=c[d];p>0?g>0?(u=p,f=p-g):(f=p,u=p+g):g>0?(u=p,f=p+g):(f=p,u=p-g),h[d]=u,c[d]=f}}for(let o=0;o<this._channelFloor.length;o++)a[o].executeChannel?(this._channelFloor[o].apply(a[o],e,s[o]),this._mdct.reverse(s[o],e)):s[o].fill(0,i,2*i)}}class Kn{constructor(){this.packetStartIndex=0,this.packetTotalLength=0,this.packetValidLength=0}}class Xh{constructor(){this.overlapInfo=new Kn,this.windowIndex=0}}class Jh{constructor(t=null){this.samplePosition=null,this.samplePosition=t}}let qh=(()=>{class r{constructor(e,s,i,a,n){if(this._overlapInfo=null,this._channels=s,this._blockFlag=e.readBit(),0!==e.readBits(32))throw new Le(Fe.Format,"Vorbis: Mode header had invalid window or transform type!");const o=e.readBits(8);if(o>=n.length)throw new Le(Fe.Format,"Vorbis: Mode header had invalid mapping index!");this._mapping=n[o],this._blockFlag?(this._blockSize=a,this._windows=[r.calcWindow(i,a,i),r.calcWindow(a,a,i),r.calcWindow(i,a,a),r.calcWindow(a,a,a)],this._overlapInfo=[r.calcOverlap(i,a,i),r.calcOverlap(a,a,i),r.calcOverlap(i,a,a),r.calcOverlap(a,a,a)]):(this._blockSize=i,this._windows=[r.calcWindow(i,i,i)])}decode(e,s){const i=this.getPacketInfo(e);this._mapping.decodePacket(e,this._blockSize,s);const a=this._windows[i.windowIndex];for(let n=0;n<this._blockSize;n++)for(let o=0;o<this._channels;o++)s[o][n]*=a[n];return i.overlapInfo}getPacketInfo(e){const s=new Xh;if(this._blockFlag){const i=e.readBit(),a=e.readBit();s.windowIndex=(i?1:0)+(a?2:0);const n=this._overlapInfo[s.windowIndex];s.overlapInfo.packetStartIndex=n.packetStartIndex,s.overlapInfo.packetValidLength=n.packetValidLength,s.overlapInfo.packetTotalLength=n.packetTotalLength}else s.windowIndex=0,s.overlapInfo.packetStartIndex=0,s.overlapInfo.packetValidLength=this._blockSize/2,s.overlapInfo.packetTotalLength=this._blockSize;return s}static calcWindow(e,s,i){const a=new Float32Array(s),n=e/2,h=i/2,c=s/4-n/2,d=s-s/4-h/2;for(let u=0;u<n;u++){let f=Math.sin((u+.5)/n*r.M_PI2);f*=f,a[c+u]=Math.sin(f*r.M_PI2)}for(let u=c+n;u<d;u++)a[u]=1;for(let u=0;u<h;u++){let f=Math.sin((h-u-.5)/h*r.M_PI2);f*=f,a[d+u]=Math.sin(f*r.M_PI2)}return a}static calcOverlap(e,s,i){const n=i/4,o=s/4-e/4,h=s/4*3+n,c=h-2*n,d=new Kn;return d.packetStartIndex=o,d.packetValidLength=c,d.packetTotalLength=h,d}}return r.M_PI2=1.57079632695,r})(),$h=(()=>{class r{constructor(e){this._n=e,this._n2=e>>1,this._n4=this._n2>>1,this._n8=this._n4>>1,this._ld=Es.ilog(e)-1,this._a=new Float32Array(this._n2),this._b=new Float32Array(this._n2),this._c=new Float32Array(this._n4);let s=0,i=0;for(;s<this._n4;++s,i+=2)this._a[i]=Math.cos(4*s*r.M_PI/e),this._a[i+1]=-Math.sin(4*s*r.M_PI/e),this._b[i]=.5*Math.cos((i+1)*r.M_PI/e/2),this._b[i+1]=.5*Math.sin((i+1)*r.M_PI/e/2);for(s=0,i=0;s<this._n8;++s,i+=2)this._c[i]=Math.cos(2*(i+1)*r.M_PI/e),this._c[i+1]=-Math.sin(2*(i+1)*r.M_PI/e);this._bitrev=new Uint16Array(this._n8);for(let a=0;a<this._n8;++a)this._bitrev[a]=oe.int32ToUint16(Es.bitReverse(a,this._ld-3)<<2)}calcReverse(e){let s,i;const a=new Float32Array(this._n2);{let o=this._n2-2,h=0,c=0;const d=this._n2;for(;c!==d;)a[o+1]=e[c]*this._a[h]-e[c+2]*this._a[h+1],a[o]=e[c]*this._a[h+1]+e[c+2]*this._a[h],o-=2,h+=2,c+=4;for(c=this._n2-3;o>=0;)a[o+1]=-e[c+2]*this._a[h]- -e[c]*this._a[h+1],a[o]=-e[c+2]*this._a[h+1]+-e[c]*this._a[h],o-=2,h+=2,c-=4}s=e,i=a;{let o=this._n2-8,h=this._n4,c=0,d=this._n4,u=0;for(;o>=0;){let f,p;p=i[h+1]-i[c+1],f=i[h]-i[c],s[d+1]=i[h+1]+i[c+1],s[d]=i[h]+i[c],s[u+1]=p*this._a[o+4]-f*this._a[o+5],s[u]=f*this._a[o+4]+p*this._a[o+5],p=i[h+3]-i[c+3],f=i[h+2]-i[c+2],s[d+3]=i[h+3]+i[c+3],s[d+2]=i[h+2]+i[c+2],s[u+3]=p*this._a[o]-f*this._a[o+1],s[u+2]=f*this._a[o]+p*this._a[o+1],o-=8,d+=4,u+=4,h+=4,c+=4}}this.step3_iter0_loop(this._n>>4,s,this._n2-1-0*this._n4,-this._n8),this.step3_iter0_loop(this._n>>4,s,this._n2-1-1*this._n4,-this._n8),this.step3_inner_r_loop(this._n>>5,s,this._n2-1-0*this._n8,-(this._n>>4),16),this.step3_inner_r_loop(this._n>>5,s,this._n2-1-1*this._n8,-(this._n>>4),16),this.step3_inner_r_loop(this._n>>5,s,this._n2-1-2*this._n8,-(this._n>>4),16),this.step3_inner_r_loop(this._n>>5,s,this._n2-1-3*this._n8,-(this._n>>4),16);let n=2;for(;n<this._ld-3>>1;++n){const o=this._n>>n+2,h=o>>1,c=1<<n+1;for(let d=0;d<c;++d)this.step3_inner_r_loop(this._n>>n+4,s,this._n2-1-o*d,-h,1<<n+3)}for(;n<this._ld-6;++n){const o=this._n>>n+2,h=1<<n+3,c=o>>1,u=1<<n+1;let f=this._n2-1,p=0;for(let g=this._n>>n+6;g>0;--g)this.step3_inner_s_loop(u,s,f,-c,p,h,o),p+=4*h,f-=8}this.step3_inner_s_loop_ld654(this._n>>5,s,this._n2-1,this._n);{let o=0,h=this._n4-4,c=this._n2-4;for(;h>=0;){let d;d=this._bitrev[o],i[c+3]=s[d],i[c+2]=s[d+1],i[h+3]=s[d+2],i[h+2]=s[d+3],d=this._bitrev[o+1],i[c+1]=s[d],i[c]=s[d+1],i[h+1]=s[d+2],i[h]=s[d+3],h-=4,c-=4,o+=2}}{let o=0,h=0,c=this._n2-4;for(;h<c;){let d,u,f,p,g,b;d=i[h]-i[c+2],u=i[h+1]+i[c+3],f=this._c[o+1]*d+this._c[o]*u,p=this._c[o+1]*u-this._c[o]*d,g=i[h]+i[c+2],b=i[h+1]-i[c+3],i[h]=g+f,i[h+1]=b+p,i[c+2]=g-f,i[c+3]=p-b,d=i[h+2]-i[c],u=i[h+3]+i[c+1],f=this._c[o+3]*d+this._c[o+2]*u,p=this._c[o+3]*u-this._c[o+2]*d,g=i[h+2]+i[c],b=i[h+3]-i[c+1],i[h+2]=g+f,i[h+3]=b+p,i[c]=g-f,i[c+1]=p-b,o+=4,h+=4,c-=4}}{let o=this._n2-8,h=this._n2-8,c=0,d=this._n2-4,u=this._n2,f=this._n-4;for(;h>=0;){let p,g,b,w;w=a[h+6]*this._b[o+7]-a[h+7]*this._b[o+6],b=-a[h+6]*this._b[o+6]-a[h+7]*this._b[o+7],e[c]=w,e[d+3]=-w,e[u]=b,e[f+3]=b,g=a[h+4]*this._b[o+5]-a[h+5]*this._b[o+4],p=-a[h+4]*this._b[o+4]-a[h+5]*this._b[o+5],e[c+1]=g,e[d+2]=-g,e[u+1]=p,e[f+2]=p,w=a[h+2]*this._b[o+3]-a[h+3]*this._b[o+2],b=-a[h+2]*this._b[o+2]-a[h+3]*this._b[o+3],e[c+2]=w,e[d+1]=-w,e[u+2]=b,e[f+1]=b,g=a[h]*this._b[o+1]-a[h+1]*this._b[o],p=-a[h]*this._b[o]-a[h+1]*this._b[o+1],e[c+3]=g,e[d]=-g,e[u+3]=p,e[f]=p,o-=8,h-=8,c+=4,u+=4,d-=4,f-=4}}}step3_inner_r_loop(e,s,i,a,n){let o,h,c=i,d=c+a,u=0;for(let f=e>>2;f>0;--f)o=s[c]-s[d],h=s[c-1]-s[d-1],s[c]+=s[d],s[c-1]+=s[d-1],s[d]=o*this._a[u]-h*this._a[u+1],s[d-1]=h*this._a[u]+o*this._a[u+1],u+=n,o=s[c-2]-s[d-2],h=s[c-3]-s[d-3],s[c-2]+=s[d-2],s[c-3]+=s[d-3],s[d-2]=o*this._a[u]-h*this._a[u+1],s[d-3]=h*this._a[u]+o*this._a[u+1],u+=n,o=s[c-4]-s[d-4],h=s[c-5]-s[d-5],s[c-4]+=s[d-4],s[c-5]+=s[d-5],s[d-4]=o*this._a[u]-h*this._a[u+1],s[d-5]=h*this._a[u]+o*this._a[u+1],u+=n,o=s[c-6]-s[d-6],h=s[c-7]-s[d-7],s[c-6]+=s[d-6],s[c-7]+=s[d-7],s[d-6]=o*this._a[u]-h*this._a[u+1],s[d-7]=h*this._a[u]+o*this._a[u+1],u+=n,c-=8,d-=8}step3_iter0_loop(e,s,i,a){let n=i,o=n+a,h=0;for(let c=e>>2;c>0;--c){let d,u;d=s[n]-s[o],u=s[n-1]-s[o-1],s[n]+=s[o],s[n-1]+=s[o-1],s[o]=d*this._a[h]-u*this._a[h+1],s[o-1]=u*this._a[h]+d*this._a[h+1],h+=8,d=s[n-2]-s[o-2],u=s[n-3]-s[o-3],s[n-2]+=s[o-2],s[n-3]+=s[o-3],s[o-2]=d*this._a[h]-u*this._a[h+1],s[o-3]=u*this._a[h]+d*this._a[h+1],h+=8,d=s[n-4]-s[o-4],u=s[n-5]-s[o-5],s[n-4]+=s[o-4],s[n-5]+=s[o-5],s[o-4]=d*this._a[h]-u*this._a[h+1],s[o-5]=u*this._a[h]+d*this._a[h+1],h+=8,d=s[n-6]-s[o-6],u=s[n-7]-s[o-7],s[n-6]+=s[o-6],s[n-7]+=s[o-7],s[o-6]=d*this._a[h]-u*this._a[h+1],s[o-7]=u*this._a[h]+d*this._a[h+1],h+=8,n-=8,o-=8}}step3_inner_s_loop(e,s,i,a,n,o,h){const c=this._a[n],d=this._a[n+1],u=this._a[n+o],f=this._a[n+o+1],p=this._a[n+2*o],g=this._a[n+2*o+1],b=this._a[n+3*o],w=this._a[n+3*o+1];let S,D,N=i,L=N+a;for(let $=e;$>0;--$)S=s[N]-s[L],D=s[N-1]-s[L-1],s[N]+=s[L],s[N-1]+=s[L-1],s[L]=S*c-D*d,s[L-1]=D*c+S*d,S=s[N-2]-s[L-2],D=s[N-3]-s[L-3],s[N-2]+=s[L-2],s[N-3]+=s[L-3],s[L-2]=S*u-D*f,s[L-3]=D*u+S*f,S=s[N-4]-s[L-4],D=s[N-5]-s[L-5],s[N-4]+=s[L-4],s[N-5]+=s[L-5],s[L-4]=S*p-D*g,s[L-5]=D*p+S*g,S=s[N-6]-s[L-6],D=s[N-7]-s[L-7],s[N-6]+=s[L-6],s[N-7]+=s[L-7],s[L-6]=S*b-D*w,s[L-7]=D*b+S*w,N-=h,L-=h}step3_inner_s_loop_ld654(e,s,i,a){const o=this._a[a>>3];let h=i;const c=h-16*e;for(;h>c;){let d,u;d=s[h]-s[h-8],u=s[h-1]-s[h-9],s[h]+=s[h-8],s[h-1]+=s[h-9],s[h-8]=d,s[h-9]=u,d=s[h-2]-s[h-10],u=s[h-3]-s[h-11],s[h-2]+=s[h-10],s[h-3]+=s[h-11],s[h-10]=(d+u)*o,s[h-11]=(u-d)*o,d=s[h-12]-s[h-4],u=s[h-5]-s[h-13],s[h-4]+=s[h-12],s[h-5]+=s[h-13],s[h-12]=u,s[h-13]=d,d=s[h-14]-s[h-6],u=s[h-7]-s[h-15],s[h-6]+=s[h-14],s[h-7]+=s[h-15],s[h-14]=(d+u)*o,s[h-15]=(d-u)*o,this.iter_54(s,h),this.iter_54(s,h-8),h-=16}}iter_54(e,s){const i=e[s]-e[s-4],a=e[s]+e[s-4],n=e[s-2]+e[s-6],o=e[s-2]-e[s-6];e[s]=a+n,e[s-2]=a-n;const h=e[s-3]-e[s-7];e[s-4]=i+h,e[s-6]=i-h;const c=e[s-1]-e[s-5],d=e[s-1]+e[s-5],u=e[s-3]+e[s-7];e[s-1]=d+u,e[s-3]=d-u,e[s-5]=c-o,e[s-7]=c+o}}return r.M_PI=3.141592653589793,r})();class Qh{constructor(){this._setupCache=new Map}reverse(t,e){let s;this._setupCache.has(e)?s=this._setupCache.get(e):(s=new $h(e),this._setupCache.set(e,s)),s.calcReverse(t)}}class Qa{constructor(t,e,s){this._packetIndex=0,this._stream=t,this._setup=e,this._packets=s,this._currentPosition=0,this._prevPacketBuf=null,this._prevPacketStart=0,this._prevPacketEnd=0,this._prevPacketStop=0,this._nextPacketBuf=null,this._eosFound=!1,this._hasPosition=!1,this._modeFieldBits=Es.ilog(e.modes.length-1)}decode(){let t=new Float32Array(this._packets[this._packets.length-1].granulePosition*this._stream.audioChannels);const e=new Float32Array(.2*this._stream.audioSampleRate*this._stream.audioChannels);let s=0,i=0;for(;s=this.read(e,0,e.length),0!==s;){if(i+s>=t.length){const a=new Float32Array(t.length+e.length);a.set(t,0),t=a}t.set(e.subarray(0,s),i),i+=s}return t.subarray(0,i)}read(t,e,s){if(0===s)return 0;let i=e;const a=e+s;for(;i<a;){if(this._prevPacketStart===this._prevPacketEnd){if(this._eosFound){this._nextPacketBuf=null,this._prevPacketBuf=null;break}const o=this.readNextPacket((i-e)/this._stream.audioChannels);null===o&&(this._prevPacketEnd=this._prevPacketStop),null!==o&&null!==o.samplePosition&&!this._hasPosition&&(this._hasPosition=!0,this._currentPosition=o.samplePosition-(this._prevPacketEnd-this._prevPacketStart)-(i-e)/this._stream.audioChannels)}const n=Math.min((a-i)/this._stream.audioChannels,this._prevPacketEnd-this._prevPacketStart);n>0&&(i+=this.copyBuffer(t,i,n))}return this._currentPosition+=(s=i-e)/this._stream.audioChannels,s}copyBuffer(t,e,s){let i=e;for(;s>0;this._prevPacketStart++,s--)for(let a=0;a<this._stream.audioChannels;a++)t[i++]=this._prevPacketBuf[a][this._prevPacketStart];return i-e}readNextPacket(t){const e=this.decodeNextPacket();if(this._eosFound=this._eosFound||e.isEndOfStream,null==e.curPacket)return null;if(null!==e.samplePosition&&e.isEndOfStream){const i=e.samplePosition-(this._currentPosition+t+e.validLen-e.startIndex);i<0&&(e.validLen+=i,e.validLen<0&&(e.validLen=0))}return this._prevPacketEnd>0?(Qa.overlapBuffers(this._prevPacketBuf,e.curPacket,this._prevPacketStart,this._prevPacketStop,e.startIndex,this._stream.audioChannels),this._prevPacketStart=e.startIndex):null==this._prevPacketBuf&&(this._prevPacketStart=e.validLen),this._nextPacketBuf=this._prevPacketBuf,this._prevPacketEnd=e.validLen,this._prevPacketStop=e.totalLen,this._prevPacketBuf=e.curPacket,new Jh(e.samplePosition)}static overlapBuffers(t,e,s,i,a,n){for(;s<i;s++,a++)for(let o=0;o<n;o++)e[o][a]+=t[o][s]}decodeNextPacket(){const t=new Kh;let e=null;if(this._packetIndex>=this._packets.length)t.isEndOfStream=!0;else{e=this._packets[this._packetIndex++];const s=new Qn(Ke.fromBuffer(e.packetData));if(t.isEndOfStream=e.isEndOfStream,!s.readBit()){const i=this._setup.modes[s.readBits(this._modeFieldBits)];if(null==this._nextPacketBuf){this._nextPacketBuf=new Array(this._stream.audioChannels);for(let n=0;n<this._stream.audioChannels;n++)this._nextPacketBuf[n]=new Float32Array(this._stream.blocksize1)}const a=i.decode(s,this._nextPacketBuf);return t.startIndex=a.packetStartIndex,t.validLen=a.packetValidLength,t.totalLen=a.packetTotalLength,t.samplePosition=e.granulePosition,t.curPacket=this._nextPacketBuf,t}}return t}}class Kh{constructor(){this.curPacket=null,this.startIndex=0,this.validLen=0,this.totalLen=0,this.isEndOfStream=!1,this.samplePosition=null}}var Fr=function(r){return r[r.IdentificationHeader=1]="IdentificationHeader",r[r.Comment=3]="Comment",r[r.SetupHeader=5]="SetupHeader",r}(Fr||{});class Ws{constructor(t){this._packetIndex=-1,this._packets=t}read(){let t;for(;;){if(t=this.nextPacket(),null==t)return null;if(t.isBeginningOfStream){const e=this.readStream(t);if(null!=e)return e}}}nextPacket(){return this._packetIndex++,this._packetIndex<this._packets.length?this._packets[this._packetIndex]:null}readStream(t){const e=new Eh;if(!this.readIdentificationHeader(e,t)||!this.readComments(this.nextPacket()))return null;const s=new vh;if(!this.readSetupHeader(e,s,this.nextPacket()))return null;const i=[];let a;for(;a=this.nextPacket(),null!=a&&(i.push(a),!a.isEndOfStream););const n=new Qa(e,s,i);return e.samples=n.decode(),e}comonHeaderDecode(t,e){const s=new Uint8Array(7);if(e.read(s,0,s.length),s[0]!==t)return!1;for(let i=0;i<Ws.VorbisHeaderMarker.length;i++)if(s[1+i]!==Ws.VorbisHeaderMarker[i])return!1;return!0}comonHeaderDecodeBit(t,e){const s=e.readBytes(7);if(s[0]!==t)return!1;for(let i=0;i<Ws.VorbisHeaderMarker.length;i++)if(s[1+i]!==Ws.VorbisHeaderMarker[i])return!1;return!0}readIdentificationHeader(t,e){const s=Ke.fromBuffer(e.packetData);if(!this.comonHeaderDecode(Fr.IdentificationHeader,s)||0!==k.readUInt32LE(s)||(t.audioChannels=s.readByte(),t.audioSampleRate=k.readUInt32LE(s),t.audioChannels<=0||t.audioSampleRate<=0))return!1;t.bitrateMaximum=k.readInt32LE(s),t.bitrateNominal=k.readInt32LE(s),t.bitrateMinimum=k.readInt32LE(s);const a=s.readByte();return t.blocksize0=1<<(15&a),t.blocksize1=1<<(a>>4),!(t.blocksize0>t.blocksize1||!Ws.isAllowedBlockSize(t.blocksize0)||!Ws.isAllowedBlockSize(t.blocksize0)||0===s.readByte())}static isAllowedBlockSize(t){switch(t){case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:return!0;default:return!1}}readComments(t){if(null==t)return!1;const e=Ke.fromBuffer(t.packetData);if(!this.comonHeaderDecode(Fr.Comment,e))return!1;const s=k.readUInt32LE(e);e.skip(s);const i=k.readUInt32LE(e);for(let n=0;n<i;n++){const o=k.readUInt32LE(e);e.skip(o)}return 0!==e.readByte()}readSetupHeader(t,e,s){if(null==s)return!1;const i=new Qn(Ke.fromBuffer(s.packetData)),a=new Qh,n=new Rh;if(!this.comonHeaderDecodeBit(Fr.SetupHeader,i))return!1;let o=i.readByte()+1;for(let h=0;h<o;h++)e.codebooks.push(new Ah(i,n));o=i.readBits(6)+1;for(let h=0;h<o;h++)e.timeDomainTransforms.push(new Oh(i));o=i.readBits(6)+1;for(let h=0;h<o;h++)e.floors.push(new Vh(i,t.blocksize0,t.blocksize1,e.codebooks));o=i.readBits(6)+1;for(let h=0;h<o;h++)e.residues.push(new Uh(i,t.audioChannels,e.codebooks));o=i.readBits(6)+1;for(let h=0;h<o;h++)e.mappings.push(new Yh(i,t.audioChannels,e.floors,e.residues,a));o=i.readBits(6)+1;for(let h=0;h<o;h++)e.modes.push(new qh(i,t.audioChannels,t.blocksize0,t.blocksize1,e.mappings));return!!i.readBit()}}Ws.VorbisHeaderMarker=new Uint8Array([118,111,114,98,105,115]);class Zh{constructor(t){this.streams=[];const s=new Fh(t).read(),i=new Ws(s);for(;;){const a=i.read();if(null==a)break;this.streams.push(a)}}}class Zn{constructor(){this.phdrs=[],this.pbags=[],this.pmods=[],this.pgens=[],this.insts=[],this.ibags=[],this.imods=[],this.igens=[],this.sHdrs=[],this.sampleData=new Uint8Array(0),this._sampleCache=new Map}decodeSamples(t,e,s){const i=`${t}_${e}_${s}`;if(!this._sampleCache.has(i)){let a;const n=this.sampleData.slice(t,e);if(s)a=new Zh(Ke.fromBuffer(n)).streams[0].samples;else{const o=new DataView(n.buffer,n.byteOffset,n.length);a=new Float32Array(n.length/2);for(let h=0;h<a.length;h++)a[h]=o.getInt16(2*h,!0)/32767}return this._sampleCache.set(i,a),a}return this._sampleCache.get(i)}load(t){const e=new Si,s=new Si;if(!Si.load(null,e,t)||"sfbk"!==e.id)throw new ft("Soundfont is not a valid Soundfont2 file");for(;Si.load(e,s,t);){const i=new Si;if("pdta"===s.id)for(;Si.load(s,i,t);)switch(i.id){case"phdr":for(let a=0,n=i.size/ro.SizeInFile|0;a<n;a++)this.phdrs.push(new ro(t));break;case"pbag":for(let a=0,n=i.size/io.SizeInFile|0;a<n;a++)this.pbags.push(new io(t));break;case"pmod":for(let a=0,n=i.size/ao.SizeInFile|0;a<n;a++)this.pmods.push(new ao(t));break;case"pgen":for(let a=0,n=i.size/Vs.SizeInFile|0;a<n;a++)this.pgens.push(new Vs(t));break;case"inst":for(let a=0,n=i.size/so.SizeInFile|0;a<n;a++)this.insts.push(new so(t));break;case"ibag":for(let a=0,n=i.size/jn.SizeInFile|0;a<n;a++)this.ibags.push(new jn(t));break;case"imod":for(let a=0,n=i.size/eo.SizeInFile|0;a<n;a++)this.imods.push(new eo(t));break;case"igen":for(let a=0,n=i.size/to.SizeInFile|0;a<n;a++)this.igens.push(new to(t));break;case"shdr":for(let a=0,n=i.size/no.SizeInFile|0;a<n;a++)this.sHdrs.push(new no(t));break;default:t.position+=i.size}else if("sdta"===s.id)for(;Si.load(s,i,t);)"smpl"===i.id?(this.sampleData=new Uint8Array(i.size),t.read(this.sampleData,0,i.size)):t.position+=i.size;else t.position+=s.size}}}let jn=(()=>{class r{constructor(e){this.instGenNdx=k.readUInt16LE(e),this.instModNdx=k.readUInt16LE(e)}}return r.SizeInFile=4,r})(),eo=(()=>{class r{constructor(e){this.modSrcOper=k.readUInt16LE(e),this.modDestOper=k.readUInt16LE(e),this.modAmount=k.readInt16LE(e),this.modAmtSrcOper=k.readUInt16LE(e),this.modTransOper=k.readUInt16LE(e)}}return r.SizeInFile=10,r})(),to=(()=>{class r{constructor(e){this.genOper=k.readUInt16LE(e),this.genAmount=new oo(e)}}return r.SizeInFile=4,r})(),so=(()=>{class r{constructor(e){this.instName=k.read8BitStringLength(e,20),this.instBagNdx=k.readUInt16LE(e)}}return r.SizeInFile=22,r})(),io=(()=>{class r{constructor(e){this.genNdx=k.readUInt16LE(e),this.modNdx=k.readUInt16LE(e)}}return r.SizeInFile=4,r})(),Vs=(()=>{class r{constructor(e){this.genOper=k.readUInt16LE(e),this.genAmount=new oo(e)}}return r.SizeInFile=4,r.GenInstrument=41,r.GenKeyRange=43,r.GenVelRange=44,r.GenSampleId=53,r})(),ro=(()=>{class r{constructor(e){this.presetName=k.read8BitStringLength(e,20),this.preset=k.readUInt16LE(e),this.bank=k.readUInt16LE(e),this.presetBagNdx=k.readUInt16LE(e),this.library=k.readUInt32LE(e),this.genre=k.readUInt32LE(e),this.morphology=k.readUInt32LE(e)}}return r.SizeInFile=38,r})(),ao=(()=>{class r{constructor(e){this.modSrcOper=k.readUInt16LE(e),this.modDestOper=k.readUInt16LE(e),this.modAmount=k.readUInt16LE(e),this.modAmtSrcOper=k.readUInt16LE(e),this.modTransOper=k.readUInt16LE(e)}}return r.SizeInFile=10,r})(),no=(()=>{class r{constructor(e){this.sampleName=k.read8BitStringLength(e,20),this.start=k.readUInt32LE(e),this.end=k.readUInt32LE(e),this.startLoop=k.readUInt32LE(e),this.endLoop=k.readUInt32LE(e),this.sampleRate=k.readUInt32LE(e),this.originalPitch=e.readByte(),this.pitchCorrection=k.readSInt8(e),this.sampleLink=k.readUInt16LE(e),this.sampleType=k.readUInt16LE(e)}}return r.SizeInFile=46,r})();class oo{get shortAmount(){return oe.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return 255&this.wordAmount}get highByteAmount(){return(65280&this.wordAmount)>>8&255}constructor(t){this.wordAmount=k.readUInt16LE(t)}}class jh{constructor(){this.presetIndex=0,this.bank=0,this.pitchWheel=0,this.perNotePitchWheel=new Map,this.midiPan=0,this.midiVolume=0,this.midiExpression=0,this.midiRpn=0,this.midiData=0,this.panOffset=0,this.gainDb=0,this.pitchRange=0,this.tuning=0,this.mixVolume=0,this.mute=!1,this.solo=!1}}class el{constructor(){this.activeChannel=0,this.channelList=[]}setupVoice(t,e){const s=this.channelList[this.activeChannel],i=e.region.pan+s.panOffset;e.playingChannel=this.activeChannel,e.mixVolume=s.mixVolume,e.noteGainDb+=s.gainDb,e.updatePitchRatio(s,t.outSampleRate),i<=-.5?(e.panFactorLeft=1,e.panFactorRight=0):i>=.5?(e.panFactorLeft=0,e.panFactorRight=1):(e.panFactorLeft=Math.sqrt(.5-i),e.panFactorRight=Math.sqrt(.5+i))}}var js=function(r){return r[r.None=0]="None",r[r.Continuous=1]="Continuous",r[r.Sustain=2]="Sustain",r}(js||{}),Ai=function(r){return r[r.StereoInterleaved=0]="StereoInterleaved",r[r.StereoUnweaved=1]="StereoUnweaved",r[r.Mono=2]="Mono",r}(Ai||{});class tl{constructor(){this.name="",this.presetNumber=0,this.bank=0,this.regions=null}}class gt{static timecents2Secs(t){return Math.pow(2,t/1200)}static decibelsToGain(t){return t>-100?Math.pow(10,.05*t):0}static gainToDecibels(t){return t<=1e-5?-100:20*Math.log10(t)}static cents2Hertz(t){return 8.176*Math.pow(2,t/1200)}}class sr{constructor(t){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0,t&&(this.delay=t.delay,this.attack=t.attack,this.hold=t.hold,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.keynumToHold=t.keynumToHold,this.keynumToDecay=t.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(t){this.delay=this.delay<-11950?0:gt.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:gt.timecents2Secs(this.attack),this.release=this.release<-11950?0:gt.timecents2Secs(this.release),0===this.keynumToHold&&(this.hold=this.hold<-11950?0:gt.timecents2Secs(this.hold)),0===this.keynumToDecay&&(this.decay=this.decay<-11950?0:gt.timecents2Secs(this.decay)),this.sustain=this.sustain<0?0:t?gt.decibelsToGain(-this.sustain/10):1-this.sustain/1e3}}var Pe=function(r){return r[r.StartAddrsOffset=0]="StartAddrsOffset",r[r.EndAddrsOffset=1]="EndAddrsOffset",r[r.StartloopAddrsOffset=2]="StartloopAddrsOffset",r[r.EndloopAddrsOffset=3]="EndloopAddrsOffset",r[r.StartAddrsCoarseOffset=4]="StartAddrsCoarseOffset",r[r.ModLfoToPitch=5]="ModLfoToPitch",r[r.VibLfoToPitch=6]="VibLfoToPitch",r[r.ModEnvToPitch=7]="ModEnvToPitch",r[r.InitialFilterFc=8]="InitialFilterFc",r[r.InitialFilterQ=9]="InitialFilterQ",r[r.ModLfoToFilterFc=10]="ModLfoToFilterFc",r[r.ModEnvToFilterFc=11]="ModEnvToFilterFc",r[r.EndAddrsCoarseOffset=12]="EndAddrsCoarseOffset",r[r.ModLfoToVolume=13]="ModLfoToVolume",r[r.Unused1=14]="Unused1",r[r.ChorusEffectsSend=15]="ChorusEffectsSend",r[r.ReverbEffectsSend=16]="ReverbEffectsSend",r[r.Pan=17]="Pan",r[r.Unused2=18]="Unused2",r[r.Unused3=19]="Unused3",r[r.Unused4=20]="Unused4",r[r.DelayModLFO=21]="DelayModLFO",r[r.FreqModLFO=22]="FreqModLFO",r[r.DelayVibLFO=23]="DelayVibLFO",r[r.FreqVibLFO=24]="FreqVibLFO",r[r.DelayModEnv=25]="DelayModEnv",r[r.AttackModEnv=26]="AttackModEnv",r[r.HoldModEnv=27]="HoldModEnv",r[r.DecayModEnv=28]="DecayModEnv",r[r.SustainModEnv=29]="SustainModEnv",r[r.ReleaseModEnv=30]="ReleaseModEnv",r[r.KeynumToModEnvHold=31]="KeynumToModEnvHold",r[r.KeynumToModEnvDecay=32]="KeynumToModEnvDecay",r[r.DelayVolEnv=33]="DelayVolEnv",r[r.AttackVolEnv=34]="AttackVolEnv",r[r.HoldVolEnv=35]="HoldVolEnv",r[r.DecayVolEnv=36]="DecayVolEnv",r[r.SustainVolEnv=37]="SustainVolEnv",r[r.ReleaseVolEnv=38]="ReleaseVolEnv",r[r.KeynumToVolEnvHold=39]="KeynumToVolEnvHold",r[r.KeynumToVolEnvDecay=40]="KeynumToVolEnvDecay",r[r.Instrument=41]="Instrument",r[r.Reserved1=42]="Reserved1",r[r.KeyRange=43]="KeyRange",r[r.VelRange=44]="VelRange",r[r.StartloopAddrsCoarseOffset=45]="StartloopAddrsCoarseOffset",r[r.Keynum=46]="Keynum",r[r.Velocity=47]="Velocity",r[r.InitialAttenuation=48]="InitialAttenuation",r[r.Reserved2=49]="Reserved2",r[r.EndloopAddrsCoarseOffset=50]="EndloopAddrsCoarseOffset",r[r.CoarseTune=51]="CoarseTune",r[r.FineTune=52]="FineTune",r[r.SampleID=53]="SampleID",r[r.SampleModes=54]="SampleModes",r[r.Reserved3=55]="Reserved3",r[r.ScaleTuning=56]="ScaleTuning",r[r.ExclusiveClass=57]="ExclusiveClass",r[r.OverridingRootKey=58]="OverridingRootKey",r[r.Unused5=59]="Unused5",r[r.EndOper=60]="EndOper",r}(Pe||{});class vs{constructor(t){this.loopMode=js.None,this.samples=vs.NoSamples,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv=new sr,this.modEnv=new sr,this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,t&&(this.loopMode=t.loopMode,this.samples=t.samples,this.sampleRate=t.sampleRate,this.loKey=t.loKey,this.hiKey=t.hiKey,this.loVel=t.loVel,this.hiVel=t.hiVel,this.group=t.group,this.offset=t.offset,this.end=t.end,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.transpose=t.transpose,this.tune=t.tune,this.pitchKeyCenter=t.pitchKeyCenter,this.pitchKeyTrack=t.pitchKeyTrack,this.attenuation=t.attenuation,this.pan=t.pan,this.ampEnv=new sr(t.ampEnv),this.modEnv=new sr(t.modEnv),this.initialFilterQ=t.initialFilterQ,this.initialFilterFc=t.initialFilterFc,this.modEnvToPitch=t.modEnvToPitch,this.modEnvToFilterFc=t.modEnvToFilterFc,this.modLfoToFilterFc=t.modLfoToFilterFc,this.modLfoToVolume=t.modLfoToVolume,this.delayModLFO=t.delayModLFO,this.freqModLFO=t.freqModLFO,this.modLfoToPitch=t.modLfoToPitch,this.delayVibLFO=t.delayVibLFO,this.freqVibLFO=t.freqVibLFO,this.vibLfoToPitch=t.vibLfoToPitch)}clear(t){this.loopMode=js.None,this.samples=vs.NoSamples,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,!t&&(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(t,e){switch(t){case Pe.StartAddrsOffset:this.offset+=oe.int16ToUint32(e.shortAmount);break;case Pe.EndAddrsOffset:this.end+=oe.int16ToUint32(e.shortAmount);break;case Pe.StartloopAddrsOffset:this.loopStart+=oe.int16ToUint32(e.shortAmount);break;case Pe.EndloopAddrsOffset:this.loopEnd+=oe.int16ToUint32(e.shortAmount);break;case Pe.StartAddrsCoarseOffset:this.offset+=32768*oe.int16ToUint32(e.shortAmount);break;case Pe.ModLfoToPitch:this.modLfoToPitch=e.shortAmount;break;case Pe.VibLfoToPitch:this.vibLfoToPitch=e.shortAmount;break;case Pe.ModEnvToPitch:this.modEnvToPitch=e.shortAmount;break;case Pe.InitialFilterFc:this.initialFilterFc=e.shortAmount;break;case Pe.InitialFilterQ:this.initialFilterQ=e.shortAmount;break;case Pe.ModLfoToFilterFc:this.modLfoToFilterFc=e.shortAmount;break;case Pe.ModEnvToFilterFc:this.modEnvToFilterFc=e.shortAmount;break;case Pe.EndAddrsCoarseOffset:this.end+=32768*oe.int16ToUint32(e.shortAmount);break;case Pe.ModLfoToVolume:this.modLfoToVolume=e.shortAmount;break;case Pe.Pan:this.pan=e.shortAmount/1e3;break;case Pe.DelayModLFO:this.delayModLFO=e.shortAmount;break;case Pe.FreqModLFO:this.freqModLFO=e.shortAmount;break;case Pe.DelayVibLFO:this.delayVibLFO=e.shortAmount;break;case Pe.FreqVibLFO:this.freqVibLFO=e.shortAmount;break;case Pe.DelayModEnv:this.modEnv.delay=e.shortAmount;break;case Pe.AttackModEnv:this.modEnv.attack=e.shortAmount;break;case Pe.HoldModEnv:this.modEnv.hold=e.shortAmount;break;case Pe.DecayModEnv:this.modEnv.decay=e.shortAmount;break;case Pe.SustainModEnv:this.modEnv.sustain=e.shortAmount;break;case Pe.ReleaseModEnv:this.modEnv.release=e.shortAmount;break;case Pe.KeynumToModEnvHold:this.modEnv.keynumToHold=e.shortAmount;break;case Pe.KeynumToModEnvDecay:this.modEnv.keynumToDecay=e.shortAmount;break;case Pe.DelayVolEnv:this.ampEnv.delay=e.shortAmount;break;case Pe.AttackVolEnv:this.ampEnv.attack=e.shortAmount;break;case Pe.HoldVolEnv:this.ampEnv.hold=e.shortAmount;break;case Pe.DecayVolEnv:this.ampEnv.decay=e.shortAmount;break;case Pe.SustainVolEnv:this.ampEnv.sustain=e.shortAmount;break;case Pe.ReleaseVolEnv:this.ampEnv.release=e.shortAmount;break;case Pe.KeynumToVolEnvHold:this.ampEnv.keynumToHold=e.shortAmount;break;case Pe.KeynumToVolEnvDecay:this.ampEnv.keynumToDecay=e.shortAmount;break;case Pe.KeyRange:this.loKey=e.lowByteAmount,this.hiKey=e.highByteAmount;break;case Pe.VelRange:this.loVel=e.lowByteAmount,this.hiVel=e.highByteAmount;break;case Pe.StartloopAddrsCoarseOffset:this.loopStart+=32768*oe.int16ToUint32(e.shortAmount);break;case Pe.InitialAttenuation:this.attenuation+=.1*e.shortAmount;break;case Pe.EndloopAddrsCoarseOffset:this.loopEnd+=32768*oe.int16ToUint32(e.shortAmount);break;case Pe.CoarseTune:this.transpose+=e.shortAmount;break;case Pe.FineTune:this.tune+=e.shortAmount;break;case Pe.SampleModes:this.loopMode=3&~e.wordAmount?1==(3&e.wordAmount)?js.Continuous:js.None:js.Sustain;break;case Pe.ScaleTuning:this.pitchKeyTrack=e.shortAmount;break;case Pe.ExclusiveClass:this.group=e.wordAmount;break;case Pe.OverridingRootKey:this.pitchKeyCenter=e.shortAmount}}}vs.NoSamples=new Float32Array(0);var Ue=function(r){return r[r.None=0]="None",r[r.Delay=1]="Delay",r[r.Attack=2]="Attack",r[r.Hold=3]="Hold",r[r.Decay=4]="Decay",r[r.Sustain=5]="Sustain",r[r.Release=6]="Release",r[r.Done=7]="Done",r}(Ue||{});let ho=(()=>{class r{constructor(){this.level=0,this.slope=0,this.samplesUntilNextSegment=0,this.segment=Ue.None,this.midiVelocity=0,this.parameters=null,this.segmentIsExponential=!1,this.isAmpEnv=!1}nextSegment(e,s){if(this.parameters)for(;;)switch(e){case Ue.None:if(this.samplesUntilNextSegment=this.parameters.delay*s|0,this.samplesUntilNextSegment>0)return this.segment=Ue.Delay,this.segmentIsExponential=!1,this.level=0,void(this.slope=0);e=Ue.Delay;break;case Ue.Delay:if(this.samplesUntilNextSegment=this.parameters.attack*s|0,this.samplesUntilNextSegment>0)return this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*s|0),this.segment=Ue.Attack,this.segmentIsExponential=!1,this.level=0,void(this.slope=1/this.samplesUntilNextSegment);e=Ue.Attack;break;case Ue.Attack:if(this.samplesUntilNextSegment=this.parameters.hold*s|0,this.samplesUntilNextSegment>0)return this.segment=Ue.Hold,this.segmentIsExponential=!1,this.level=1,void(this.slope=0);e=Ue.Hold;break;case Ue.Hold:if(this.samplesUntilNextSegment=this.parameters.decay*s|0,this.samplesUntilNextSegment>0){if(this.segment=Ue.Decay,this.level=1,this.isAmpEnv){const i=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(i),this.segmentIsExponential=!0,this.parameters.sustain>0&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/i|0)}else this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*s|0,this.segmentIsExponential=!1;return}e=Ue.Decay;break;case Ue.Decay:return this.segment=Ue.Sustain,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,void(this.segmentIsExponential=!1);case Ue.Sustain:return this.segment=Ue.Release,this.samplesUntilNextSegment=(this.parameters.release<=0?r.FastReleaseTime:this.parameters.release)*s|0,void(this.isAmpEnv?(this.slope=Math.exp(-9.226/this.samplesUntilNextSegment),this.segmentIsExponential=!0):(this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1));default:return this.segment=Ue.Done,this.segmentIsExponential=!1,this.level=0,this.slope=0,void(this.samplesUntilNextSegment=134217727)}}setup(e,s,i,a,n){this.parameters=new sr(e),this.parameters.keynumToHold>0&&(this.parameters.hold+=this.parameters.keynumToHold*(60-s),this.parameters.hold=this.parameters.hold<-1e4?0:gt.timecents2Secs(this.parameters.hold)),this.parameters.keynumToDecay>0&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-s),this.parameters.decay=this.parameters.decay<-1e4?0:gt.timecents2Secs(this.parameters.decay)),this.midiVelocity=0|i,this.isAmpEnv=a,this.nextSegment(Ue.None,n)}process(e,s){this.slope>0&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,e):this.level+=this.slope*e),this.samplesUntilNextSegment-=e,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,s)}}return r.FastReleaseTime=.01,r})();class lo{constructor(){this.samplesUntil=0,this.level=0,this.delta=0}setup(t,e,s){this.samplesUntil=t*s|0,this.delta=4*gt.cents2Hertz(e)/s,this.level=0}process(t){this.samplesUntil>t?this.samplesUntil-=t:(this.level+=this.delta*t,this.level>1?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level))}}class co{constructor(t){this.qInv=0,this.a0=0,this.a1=0,this.b1=0,this.b2=0,this.z1=0,this.z2=0,this.active=!1,t&&(this.qInv=t.qInv,this.a0=t.a0,this.a1=t.a1,this.b1=t.b1,this.b2=t.b2,this.z1=t.z1,this.z2=t.z2,this.active=t.active)}setup(t){const e=Math.tan(Math.PI*t),s=e*e,i=1/(1+e*this.qInv+s);this.a0=s*i,this.a1=2*this.a0,this.b1=2*(s-1)*i,this.b2=(1-e*this.qInv+s)*i}process(t){const e=t*this.a0+this.z1;return this.z1=t*this.a1+this.z2-this.b1*e,this.z2=t*this.a0-this.b2*e,e}}class ir{constructor(){this.playingPreset=0,this.playingKey=0,this.playingChannel=0,this.region=null,this.pitchInputTimecents=0,this.pitchOutputFactor=0,this.sourceSamplePosition=0,this.noteGainDb=0,this.panFactorLeft=0,this.panFactorRight=0,this.playIndex=0,this.loopStart=0,this.loopEnd=0,this.ampEnv=new ho,this.modEnv=new ho,this.lowPass=new co,this.modLfo=new lo,this.vibLfo=new lo,this.mixVolume=0,this.mute=!1}updatePitchRatio(t,e){let s=t.pitchWheel;t.perNotePitchWheel.has(this.playingKey)&&(s+=t.perNotePitchWheel.get(this.playingKey)-8192),this.calcPitchRatio(8192===s?t.tuning:s/16383*t.pitchRange*2-t.pitchRange+t.tuning,e)}calcPitchRatio(t,e){if(!this.region)return;let i=this.region.pitchKeyCenter+this.region.pitchKeyTrack/100*(this.playingKey+this.region.transpose+this.region.tune/100-this.region.pitchKeyCenter);0!==t&&(i+=t),this.pitchInputTimecents=100*i,this.pitchOutputFactor=this.region.sampleRate/(gt.timecents2Secs(100*this.region.pitchKeyCenter)*e)}end(t){this.region&&(this.ampEnv.nextSegment(Ue.Sustain,t),this.modEnv.nextSegment(Ue.Sustain,t),this.region.loopMode===js.Sustain&&(this.loopEnd=this.loopStart))}endQuick(t){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(Ue.Sustain,t),this.modEnv.parameters.release=0,this.modEnv.nextSegment(Ue.Sustain,t)}render(t,e,s,i,a){if(!this.region)return;const n=this.region,o=n.samples;let h=0,c=t.outputMode===Ai.StereoUnweaved?i:-1;const d=0!==n.modEnvToPitch||0!==n.modEnvToFilterFc,u=this.modLfo.delta>0&&(0!==n.modLfoToPitch||0!==n.modLfoToFilterFc||0!==n.modLfoToVolume),f=this.vibLfo.delta>0&&0!==n.vibLfoToPitch,p=this.loopStart<this.loopEnd,g=this.loopStart,b=this.loopEnd,w=n.end,S=b+1;let D=this.sourceSamplePosition;const N=new co(this.lowPass),L=0!==n.modLfoToFilterFc||0!==n.modEnvToFilterFc;let $=0,E=0,B=0,ie=0;const Re=0!==n.modLfoToPitch||0!==n.modEnvToPitch||0!==n.vibLfoToPitch;let Ne=0,ee=0,Ve=0,At=0;const ss=0!==n.modLfoToVolume;let ls=0,Bt=0;for(L?($=t.outSampleRate,E=n.initialFilterFc,B=n.modLfoToFilterFc,ie=n.modEnvToFilterFc):($=0,E=0,B=0,ie=0),Re?(Ne=0,ee=n.modLfoToPitch,Ve=n.vibLfoToPitch,At=n.modEnvToPitch):(Ne=gt.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,ee=0,Ve=0,At=0),ss?Bt=.1*n.modLfoToVolume:(ls=gt.decibelsToGain(this.noteGainDb),Bt=0);i>0;){let Ht,ci,Qs=0,fs=i>ir.RenderEffectSampleBlock?ir.RenderEffectSampleBlock:i;if(i-=fs,L){const Pt=E+this.modLfo.level*B+this.modEnv.level*ie;N.active=Pt<=13500,N.active&&N.setup(gt.cents2Hertz(Pt)/$)}switch(Re&&(Ne=gt.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*ee+this.vibLfo.level*Ve+this.modEnv.level*At))*this.pitchOutputFactor),ss&&(ls=gt.decibelsToGain(this.noteGainDb+this.modLfo.level*Bt)),Ht=ls*this.ampEnv.level,a?Ht=0:Ht*=this.mixVolume,this.ampEnv.process(fs,t.outSampleRate),d&&this.modEnv.process(fs,t.outSampleRate),u&&this.modLfo.process(fs),f&&this.vibLfo.process(fs),t.outputMode){case Ai.StereoInterleaved:for(ci=Ht*this.panFactorLeft,Qs=Ht*this.panFactorRight;fs-- >0&&D<w;){const Pt=0|D,_s=D-Pt;let mt=o[Pt]*(1-_s)+o[Pt>=b&&p?g:Pt+1]*_s;N.active&&(mt=N.process(mt)),e[s+h]+=mt*ci,h++,e[s+h]+=mt*Qs,h++,D+=Ne,D>=S&&p&&(D-=b-g+1)}break;case Ai.StereoUnweaved:for(ci=Ht*this.panFactorLeft,Qs=Ht*this.panFactorRight;fs-- >0&&D<w;){const Pt=0|D,_s=D-Pt;let mt=o[Pt]*(1-_s)+o[Pt>=b&&p?g:Pt+1]*_s;N.active&&(mt=N.process(mt)),e[s+h]+=mt*ci,h++,e[s+c]+=mt*Qs,c++,D+=Ne,D>=S&&p&&(D-=b-g+1)}break;case Ai.Mono:for(;fs-- >0&&D<w;){const Pt=0|D,_s=D-Pt;let mt=o[Pt]*(1-_s)+o[Pt>=b&&p?g:Pt+1]*_s;N.active&&(mt=N.process(mt)),e[s+h]=mt*Ht,h++,D+=Ne,D>=S&&p&&(D-=b-g+1)}}if(D>=w||this.ampEnv.segment===Ue.Done)return void this.kill()}this.sourceSamplePosition=D,(N.active||L)&&(this.lowPass=N)}kill(){this.playingPreset=-1}}ir.RenderEffectSampleBlock=q.MicroBufferSize;class sl{constructor(t){this.value=t}}class Ka{get isEmpty(){return void 0===this._head}clear(){this._head=void 0,this._tail=void 0}enqueue(t){const e=new sl(t);this._tail?(this._tail.next=e,this._tail=e):(this._head=e,this._tail=e)}peek(){const t=this._head;if(t)return t.value}dequeue(){const t=this._head;if(!t)return;const e=t.next;return this._head=e,e||(this._tail=void 0),t.value}}var He=function(r){return r[r.BankSelectCoarse=0]="BankSelectCoarse",r[r.ModulationCoarse=1]="ModulationCoarse",r[r.DataEntryCoarse=6]="DataEntryCoarse",r[r.VolumeCoarse=7]="VolumeCoarse",r[r.PanCoarse=10]="PanCoarse",r[r.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",r[r.BankSelectFine=32]="BankSelectFine",r[r.ModulationFine=33]="ModulationFine",r[r.DataEntryFine=38]="DataEntryFine",r[r.VolumeFine=39]="VolumeFine",r[r.PanFine=42]="PanFine",r[r.ExpressionControllerFine=43]="ExpressionControllerFine",r[r.HoldPedal=64]="HoldPedal",r[r.LegatoPedal=68]="LegatoPedal",r[r.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",r[r.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",r[r.RegisteredParameterFine=100]="RegisteredParameterFine",r[r.RegisteredParameterCourse=101]="RegisteredParameterCourse",r[r.AllSoundOff=120]="AllSoundOff",r[r.ResetControllers=121]="ResetControllers",r[r.AllNotesOff=123]="AllNotesOff",r}(He||{});class Er{constructor(t){this._midiEventQueue=new Ka,this._mutedChannels=new Map,this._soloChannels=new Map,this._isAnySolo=!1,this._transpositionPitches=new Map,this._liveTranspositionPitches=new Map,this.currentTempo=0,this.timeSignatureNumerator=0,this.timeSignatureDenominator=0,this.presets=null,this._voices=[],this._channels=null,this._voicePlayIndex=0,this.outputMode=Ai.StereoInterleaved,this.outSampleRate=0,this.globalGainDb=0,this.outSampleRate=t}synthesize(t,e,s){return this.fillWorkingBuffer(t,e,s)}synthesizeSilent(t){this.fillWorkingBuffer(null,0,t)}channelGetMixVolume(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].mixVolume:1}channelSetMixVolume(t,e){const s=this.channelInit(t);for(const i of this._voices)i.playingChannel===t&&-1!==i.playingPreset&&(i.mixVolume=e);s.mixVolume=e}channelSetMute(t,e){e?this._mutedChannels.set(t,!0):this._mutedChannels.delete(t)}channelSetSolo(t,e){e?this._soloChannels.set(t,!0):this._soloChannels.delete(t),this._isAnySolo=this._soloChannels.size>0}resetChannelStates(){this._mutedChannels=new Map,this._soloChannels=new Map,this._liveTranspositionPitches=new Map,this.applyTranspositionPitches(new Map),this._isAnySolo=!1}setChannelTranspositionPitch(t,e){let s=0;this._liveTranspositionPitches.has(t)&&(s=this._liveTranspositionPitches.get(t)),0===e?this._liveTranspositionPitches.delete(t):this._liveTranspositionPitches.set(t,e);for(const i of this._voices)if(i.playingChannel===t&&9!==i.playingChannel){let a=0;a-=s,a+=e,i.playingKey+=a,this._channels&&i.updatePitchRatio(this._channels.channelList[i.playingChannel],this.outSampleRate)}}applyTranspositionPitches(t){const e=this._transpositionPitches;for(const s of this._voices)if(s.playingChannel>=0&&9!==s.playingChannel){let i=0;e.has(s.playingChannel)&&(i-=e.get(s.playingChannel)),t.has(s.playingChannel)&&(i+=t.get(s.playingChannel)),s.playingKey+=i,this._channels&&s.updatePitchRatio(this._channels.channelList[s.playingChannel],this.outSampleRate)}this._transpositionPitches=t}dispatchEvent(t){this._midiEventQueue.enqueue(t)}fillWorkingBuffer(t,e,s){const i=this._isAnySolo,a=[];for(;!this._midiEventQueue.isEmpty;){const n=this._midiEventQueue.dequeue();n.isMetronome&&this.metronomeVolume>0?(this.channelNoteOff(q.MetronomeChannel,q.MetronomeKey),this.channelNoteOn(q.MetronomeChannel,q.MetronomeKey,95/127)):n.event&&this.processMidiMessage(n.event),a.push(n)}for(const n of this._voices)if(-1!==n.playingPreset){const o=n.playingChannel,h=this._mutedChannels.has(o)||i&&o!==q.MetronomeChannel&&!this._soloChannels.has(o);t?n.render(this,t,e,s,h):n.kill()}return a}processMidiMessage(t){switch(t.type){case xe.TimeSignature:const s=t;this.timeSignatureNumerator=s.numerator,this.timeSignatureDenominator=Math.pow(2,s.denominatorIndex);break;case xe.NoteOn:this.channelNoteOn(t.channel,t.noteKey,t.noteVelocity/127);break;case xe.NoteOff:this.channelNoteOff(t.channel,t.noteKey);break;case xe.ControlChange:this.channelMidiControl(t.channel,t.controller,t.value);break;case xe.ProgramChange:this.channelSetPresetNumber(t.channel,t.program,9===t.channel);break;case xe.TempoChange:this.currentTempo=t.beatsPerMinute;break;case xe.PitchBend:this.channelSetPitchWheel(t.channel,t.value);break;case xe.PerNotePitchBend:let u=t.value;u=u*q.MaxPitchWheel/q.MaxPitchWheel20,this.channelSetPerNotePitchWheel(t.channel,t.noteKey,u)}}get metronomeVolume(){return this.channelGetMixVolume(q.MetronomeChannel)}set metronomeVolume(t){this.setupMetronomeChannel(t)}setupMetronomeChannel(t){this.channelSetMixVolume(q.MetronomeChannel,t),t>0&&(this.channelSetVolume(q.MetronomeChannel,1),this.channelSetPresetNumber(q.MetronomeChannel,0,!0))}get masterVolume(){return gt.decibelsToGain(this.globalGainDb)}set masterVolume(t){const e=gt.gainToDecibels(t),s=e-this.globalGainDb;if(0!==s){for(const i of this._voices)-1!==i.playingPreset&&(i.noteGainDb+=s);this.globalGainDb=e}}resetSoft(){for(const t of this._voices)-1!==t.playingPreset&&(t.ampEnv.segment<Ue.Release||0!==t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate);if(this._channels)for(const t of this._channels.channelList)t.presetIndex=0,t.bank=0,t.pitchWheel=8192,t.midiPan=8192,t.perNotePitchWheel.clear(),t.midiVolume=16383,t.midiExpression=16383,t.midiRpn=65535,t.midiData=0,t.panOffset=0,t.gainDb=0,t.pitchRange=2,t.tuning=0}get presetCount(){return this.presets?.length??0}reset(){for(const t of this._voices)-1!==t.playingPreset&&(t.ampEnv.segment<Ue.Release||0!==t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate);this._channels=null}setOutput(t,e,s){this.outputMode=t,this.outSampleRate=e>=1?e:44100,this.globalGainDb=s}noteOn(t,e,s){if(!this.presets)return;const i=127*s|0;if(t<0||t>=this.presets.length)return;if(s<=0)return void this.noteOff(t,e);const a=this._voicePlayIndex++;for(const n of this.presets[t].regions){if(e<n.loKey||e>n.hiKey||i<n.loVel||i>n.hiVel)continue;let o=null;if(0!==n.group)for(const d of this._voices)d.playingPreset===t&&d.region.group===n.group?d.endQuick(this.outSampleRate):-1===d.playingPreset&&!o&&(o=d);else for(const d of this._voices)-1===d.playingPreset&&(o=d);if(!o){for(let d=0;d<4;d++){const u=new ir;u.playingPreset=-1,this._voices.push(u)}o=this._voices[this._voices.length-4]}o.region=n,o.playingPreset=t,o.playingKey=e,o.playIndex=a,o.noteGainDb=this.globalGainDb-n.attenuation-gt.gainToDecibels(1/s),this._channels?this._channels.setupVoice(this,o):(o.calcPitchRatio(0,this.outSampleRate),o.panFactorLeft=Math.sqrt(.5-n.pan),o.panFactorRight=Math.sqrt(.5+n.pan)),o.sourceSamplePosition=n.offset;const h=n.loopMode!==js.None&&n.loopStart<n.loopEnd;o.loopStart=h?n.loopStart:0,o.loopEnd=h?n.loopEnd:0,o.ampEnv.setup(n.ampEnv,e,i,!0,this.outSampleRate),o.modEnv.setup(n.modEnv,e,i,!1,this.outSampleRate),o.lowPass.qInv=1/Math.pow(10,n.initialFilterQ/10/20),o.lowPass.z1=0,o.lowPass.z2=0,o.lowPass.active=n.initialFilterFc<=13500,o.lowPass.active&&o.lowPass.setup(gt.cents2Hertz(n.initialFilterFc)/this.outSampleRate),o.modLfo.setup(n.delayModLFO,n.freqModLFO,this.outSampleRate),o.vibLfo.setup(n.delayVibLFO,n.freqVibLFO,this.outSampleRate)}}bankNoteOn(t,e,s,i){const a=this.getPresetIndex(t,e);return-1!==a&&(this.noteOn(a,s,i),!0)}noteOff(t,e){let s=null,i=null;const a=[];for(const n of this._voices)n.playingPreset!==t||n.playingKey!==e||n.ampEnv.segment>=Ue.Release||(!s||n.playIndex<s.playIndex?(s=n,i=n,a.push(n)):n.playIndex===s.playIndex&&(i=n,a.push(n)));if(s)for(const n of a)n!==s&&n!==i&&(n.playIndex!==s.playIndex||n.playingPreset!==t||n.playingKey!==e||n.ampEnv.segment>=Ue.Release)||n.end(this.outSampleRate)}bankNoteOff(t,e,s){const i=this.getPresetIndex(t,e);return-1!==i&&(this.noteOff(i,s),!0)}noteOffAll(t){for(const e of this._voices)-1!==e.playingPreset&&(t?e.endQuick(this.outSampleRate):e.ampEnv.segment<Ue.Release&&e.end(this.outSampleRate))}get activeVoiceCount(){let t=0;for(const e of this._voices)-1!==e.playingPreset&&t++;return t}channelInit(t){if(this._channels&&t<this._channels.channelList.length)return this._channels.channelList[t];this._channels||(this._channels=new el);for(let e=this._channels.channelList.length;e<=t;e++){const s=new jh;s.presetIndex=0,s.bank=0,s.pitchWheel=8192,s.midiPan=8192,s.midiVolume=16383,s.midiExpression=16383,s.midiRpn=65535,s.midiData=0,s.panOffset=0,s.gainDb=0,s.pitchRange=2,s.tuning=0,s.mixVolume=1,this._channels.channelList.push(s)}return this._channels.channelList[t]}getPresetIndex(t,e){if(!this.presets)return-1;for(let s=this.presets.length-1;s>=0;s--){const i=this.presets[s];if(i.presetNumber===e&&i.bank===t)return s}return-1}getPresetName(t){return this.presets?t<0||t>=this.presets.length?null:this.presets[t].name:null}bankGetPresetName(t,e){return this.getPresetName(this.getPresetIndex(t,e))}channelNoteOn(t,e,s){!this._channels||t>this._channels.channelList.length||(this._transpositionPitches.has(t)&&(e+=this._transpositionPitches.get(t)),this._liveTranspositionPitches.has(t)&&(e+=this._liveTranspositionPitches.get(t)),this._channels.activeChannel=t,this.noteOn(this._channels.channelList[t].presetIndex,e,s))}channelNoteOff(t,e){this._transpositionPitches.has(t)&&(e+=this._transpositionPitches.get(t)),this._liveTranspositionPitches.has(t)&&(e+=this._liveTranspositionPitches.get(t));const s=[];let i=null,a=null;for(const o of this._voices)-1===o.playingPreset||o.playingChannel!==t||o.playingKey!==e||o.ampEnv.segment>=Ue.Release||(!i||o.playIndex<i.playIndex?(i=o,a=o,s.push(o)):o.playIndex===i.playIndex&&(a=o,s.push(o)));if(this.channelInit(t).perNotePitchWheel.delete(e),i)for(const o of s)o!==i&&o!==a&&(o.playIndex!==i.playIndex||-1===o.playingPreset||o.playingChannel!==t||o.playingKey!==e||o.ampEnv.segment>=Ue.Release)||o.end(this.outSampleRate)}channelNoteOffAll(t){this.channelInit(t).perNotePitchWheel.clear();for(const s of this._voices)-1!==s.playingPreset&&s.playingChannel===t&&s.ampEnv.segment<Ue.Release&&s.end(this.outSampleRate)}channelSoundsOffAll(t){this.channelInit(t).perNotePitchWheel.clear();for(const s of this._voices)-1!==s.playingPreset&&s.playingChannel===t&&(s.ampEnv.segment<Ue.Release||0===s.ampEnv.parameters.release)&&s.endQuick(this.outSampleRate)}channelSetPresetIndex(t,e){this.channelInit(t).presetIndex=oe.int32ToUint16(e)}channelSetPresetNumber(t,e,s=!1){const i=this.channelInit(t);let a=0;return s?(a=this.getPresetIndex(128|32767&i.bank,e),-1===a&&(a=this.getPresetIndex(128,e)),-1===a&&(a=this.getPresetIndex(128,0)),-1===a&&(a=this.getPresetIndex(2047&i.bank,e))):a=this.getPresetIndex(2047&i.bank,e),i.presetIndex=a,-1!==a}channelSetBank(t,e){this.channelInit(t).bank=oe.int32ToUint16(e)}channelSetBankPreset(t,e,s){const i=this.channelInit(t),a=this.getPresetIndex(e,s);return-1!==a&&(i.presetIndex=oe.int32ToUint16(a),i.bank=oe.int32ToUint16(e),!0)}channelSetPan(t,e){for(const s of this._voices)if(s.playingChannel===t&&-1!==s.playingPreset){const i=s.region.pan+e-.5;i<=-.5?(s.panFactorLeft=1,s.panFactorRight=0):i>=.5?(s.panFactorLeft=0,s.panFactorRight=1):(s.panFactorLeft=Math.sqrt(.5-i),s.panFactorRight=Math.sqrt(.5+i))}this.channelInit(t).panOffset=e-.5}channelSetVolume(t,e){const s=this.channelInit(t),i=gt.gainToDecibels(e),a=i-s.gainDb;if(0!==a){for(const n of this._voices)n.playingChannel===t&&-1!==n.playingPreset&&(n.noteGainDb+=a);s.gainDb=i}}channelSetPitchWheel(t,e){const s=this.channelInit(t);s.pitchWheel!==e&&(s.pitchWheel=oe.int32ToUint16(e),this.channelApplyPitch(t,s))}channelSetPerNotePitchWheel(t,e,s){this._transpositionPitches.has(t)&&(e+=this._transpositionPitches.get(t)),this._liveTranspositionPitches.has(t)&&(e+=this._liveTranspositionPitches.get(t));const i=this.channelInit(t);i.perNotePitchWheel.has(e)&&i.perNotePitchWheel.get(e)===s||(i.perNotePitchWheel.set(e,s),this.channelApplyPitch(t,i,e))}channelApplyPitch(t,e,s=-1){for(const i of this._voices)i.playingChannel===t&&-1!==i.playingPreset&&(-1===s||i.playingKey===s)&&i.updatePitchRatio(e,this.outSampleRate)}channelSetPitchRange(t,e){const s=this.channelInit(t);s.pitchRange!==e&&(s.pitchRange=e,8192!==s.pitchWheel&&this.channelApplyPitch(t,s))}channelSetTuning(t,e){const s=this.channelInit(t);s.tuning!==e&&(s.tuning=e,this.channelApplyPitch(t,s))}channelMidiControl(t,e,s){const i=this.channelInit(t);switch(e){case He.DataEntryFine:return i.midiData=oe.int32ToUint16(16256&i.midiData|s),void(0===i.midiRpn?this.channelSetPitchRange(t,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(t,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&this.channelSetTuning(t,s-64+(i.tuning-(0|i.tuning))));case He.VolumeCoarse:return i.midiVolume=oe.int32ToUint16(127&i.midiVolume|s<<7),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case He.VolumeFine:return i.midiVolume=oe.int32ToUint16(16256&i.midiVolume|s),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case He.ExpressionControllerCoarse:return i.midiExpression=oe.int32ToUint16(127&i.midiExpression|s<<7),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case He.ExpressionControllerFine:return i.midiExpression=oe.int32ToUint16(16256&i.midiExpression|s),void this.channelSetVolume(t,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case He.PanCoarse:return i.midiPan=oe.int32ToUint16(127&i.midiPan|s<<7),void this.channelSetPan(t,i.midiPan/16383);case He.PanFine:return i.midiPan=oe.int32ToUint16(16256&i.midiPan|s),void this.channelSetPan(t,i.midiPan/16383);case He.DataEntryCoarse:return i.midiData=oe.int32ToUint16(127&i.midiData|s<<7),void(0===i.midiRpn?this.channelSetPitchRange(t,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(t,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&e===He.DataEntryCoarse&&this.channelSetTuning(t,s-64+(i.tuning-(0|i.tuning))));case He.BankSelectCoarse:return void(i.bank=oe.int32ToUint16(32768|s));case He.BankSelectFine:return void(i.bank=oe.int32ToUint16((32768&i.bank?(127&i.bank)<<7:0)|s));case He.RegisteredParameterCourse:return void(i.midiRpn=oe.int32ToUint16(127&(65535===i.midiRpn?0:i.midiRpn)|s<<7));case He.RegisteredParameterFine:return void(i.midiRpn=oe.int32ToUint16(16256&(65535===i.midiRpn?0:i.midiRpn)|s));case He.NonRegisteredParameterFine:case He.NonRegisteredParameterCourse:return void(i.midiRpn=65535);case He.AllSoundOff:return void this.channelSoundsOffAll(t);case He.AllNotesOff:return void this.channelNoteOffAll(t);case He.ResetControllers:return i.midiVolume=16383,i.midiExpression=16383,i.midiPan=8192,i.bank=0,this.channelSetVolume(t,1),this.channelSetPan(t,.5),void this.channelSetPitchRange(t,2)}}channelGetPresetIndex(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].presetIndex:0}channelGetPresetBank(t){return this._channels&&t<this._channels.channelList.length?32767&this._channels.channelList[t].bank:0}channelGetPan(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].panOffset-.5:.5}channelGetVolume(t){return this._channels&&t<this._channels.channelList.length?gt.decibelsToGain(this._channels.channelList[t].gainDb):1}channelGetPitchWheel(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].pitchWheel:8192}channelGetPitchRange(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].pitchRange:2}channelGetTuning(t){return this._channels&&t<this._channels.channelList.length?this._channels.channelList[t].tuning:0}resetPresets(){this.presets=[]}loadPresets(t,e,s,i){const a=[];for(let n=0;n<t.phdrs.length-1;n++){const o=t.phdrs[n];let h=0;const c=new tl;a.push(c),c.name=o.presetName,c.bank=o.bank,c.presetNumber=o.preset;let d=0;for(let f=o.presetBagNdx;f<t.phdrs[n+1].presetBagNdx;f++){let g=0,b=127,w=0,S=127;for(let D=t.pbags[f].genNdx;D<t.pbags[f+1].genNdx;D++){const N=t.pgens[D];if(N.genOper!==Vs.GenKeyRange)if(N.genOper!==Vs.GenVelRange){if(!(N.genOper!==Vs.GenInstrument||N.genAmount.wordAmount>=t.insts.length))for(let $=t.insts[N.genAmount.wordAmount].instBagNdx;$<t.insts[N.genAmount.wordAmount+1].instBagNdx;$++){let B=0,ie=127,Re=0,Ne=127;for(let ee=t.ibags[$].instGenNdx;ee<t.ibags[$+1].instGenNdx;ee++){const Ve=t.igens[ee];Ve.genOper!==Vs.GenKeyRange?Ve.genOper!==Vs.GenVelRange?53===Ve.genOper&&ie>=g&&B<=b&&Ne>=w&&Re<=S&&d++:(Re=Ve.genAmount.lowByteAmount,Ne=Ve.genAmount.highByteAmount):(B=Ve.genAmount.lowByteAmount,ie=Ve.genAmount.highByteAmount)}}}else w=N.genAmount.lowByteAmount,S=N.genAmount.highByteAmount;else g=N.genAmount.lowByteAmount,b=N.genAmount.highByteAmount}}c.regions=new Array(d);let u=new vs;u.clear(!0);for(let f=o.presetBagNdx;f<t.phdrs[n+1].presetBagNdx;f++){const p=t.pbags[f],g=new vs(u);let b=!1;for(let w=p.genNdx;w<t.pbags[f+1].genNdx;w++){const S=t.pgens[w];if(S.genOper===Vs.GenInstrument){const D=S.genAmount.wordAmount;if(D>=t.insts.length)continue;let N=new vs;N.clear(!1);const L=t.insts[D];for(let $=L.instBagNdx;$<t.insts[D+1].instBagNdx;$++){const E=t.ibags[$],B=new vs(N);let ie=!1;for(let Re=E.instGenNdx;Re<t.ibags[$+1].instGenNdx;Re++){const Ne=t.igens[Re];if(Ne.genOper===Vs.GenSampleId){if(B.hiKey<g.loKey||B.loKey>g.hiKey||B.hiVel<g.loVel||B.loVel>g.hiVel)continue;g.loKey>B.loKey&&(B.loKey=g.loKey),g.hiKey<B.hiKey&&(B.hiKey=g.hiKey),g.loVel>B.loVel&&(B.loVel=g.loVel),g.hiVel<B.hiVel&&(B.hiVel=g.hiVel),B.offset+=g.offset,B.end+=g.end,B.loopStart+=g.loopStart,B.loopEnd+=g.loopEnd,B.transpose+=g.transpose,B.tune+=g.tune,B.pitchKeyTrack+=g.pitchKeyTrack,B.attenuation+=g.attenuation,B.pan+=g.pan,B.ampEnv.delay+=g.ampEnv.delay,B.ampEnv.attack+=g.ampEnv.attack,B.ampEnv.hold+=g.ampEnv.hold,B.ampEnv.decay+=g.ampEnv.decay,B.ampEnv.sustain+=g.ampEnv.sustain,B.ampEnv.release+=g.ampEnv.release,B.modEnv.delay+=g.modEnv.delay,B.modEnv.attack+=g.modEnv.attack,B.modEnv.hold+=g.modEnv.hold,B.modEnv.decay+=g.modEnv.decay,B.modEnv.sustain+=g.modEnv.sustain,B.modEnv.release+=g.modEnv.release,B.initialFilterQ+=g.initialFilterQ,B.initialFilterFc+=g.initialFilterFc,B.modEnvToPitch+=g.modEnvToPitch,B.modEnvToFilterFc+=g.modEnvToFilterFc,B.delayModLFO+=g.delayModLFO,B.freqModLFO+=g.freqModLFO,B.modLfoToPitch+=g.modLfoToPitch,B.modLfoToFilterFc+=g.modLfoToFilterFc,B.modLfoToVolume+=g.modLfoToVolume,B.delayVibLFO+=g.delayVibLFO,B.freqVibLFO+=g.freqVibLFO,B.vibLfoToPitch+=g.vibLfoToPitch,B.ampEnv.envToSecs(!0),B.modEnv.envToSecs(!1),B.delayModLFO=B.delayModLFO<-11950?0:gt.timecents2Secs(B.delayModLFO),B.delayVibLFO=B.delayVibLFO<-11950?0:gt.timecents2Secs(B.delayVibLFO),B.pan<-.5?B.pan=-.5:B.pan>.5&&(B.pan=.5),(B.initialFilterQ<1500||B.initialFilterQ>13500)&&(B.initialFilterQ=0);const ee=t.sHdrs[Ne.genAmount.wordAmount];B.offset+=ee.start,B.end+=ee.end,B.loopStart+=ee.startLoop,B.loopEnd+=ee.endLoop,ee.endLoop>0&&(B.loopEnd-=1),-1===B.pitchKeyCenter&&(B.pitchKeyCenter=ee.originalPitch),B.tune+=ee.pitchCorrection,B.sampleRate=ee.sampleRate;const Ve=o.bank===q.PercussionBank;Ve&&Er.setContainsRange(s,B.loKey,B.hiKey)||!Ve&&e.has(o.preset)?1&ee.sampleType?(x.debug("AlphaSynth",`Loading of used sample ${ee.sampleName} for preset ${o.presetName} (bank ${c.bank} program ${c.presetNumber})`),16&ee.sampleType?B.samples=t.decodeSamples(ee.start,ee.end,!0):(B.samples=t.decodeSamples(2*B.offset,2*B.end,!1),B.loopStart>0&&(B.loopStart-=B.offset),B.loopEnd>0&&(B.loopEnd-=B.offset)),B.offset=0,B.end=B.samples.length-1):(x.warning("AlphaSynth",`Skipping load of unsupported sample ${ee.sampleName} for preset ${o.presetName}, sample type ${ee.sampleType} is not supported (bank ${c.bank} program ${c.presetNumber})`),B.samples=new Float32Array(0)):(x.debug("AlphaSynth",`Skipping load of unused sample ${ee.sampleName} for preset ${o.presetName} (bank ${c.bank} program ${c.presetNumber})`),B.samples=new Float32Array(0)),c.regions[h]=new vs(B),h++,ie=!0}else B.operator(Ne.genOper,Ne.genAmount)}E===t.ibags[L.instBagNdx]&&!ie&&(N=new vs(B))}b=!0}else g.operator(S.genOper,S.genAmount)}p===t.pbags[o.presetBagNdx]&&!b&&(u=g)}}if(i&&this.presets)for(const n of a)this.presets.push(n);else this.presets=a}static setContainsRange(t,e,s){for(let i=e;i<=s;i++)if(t.has(i))return!0;return!1}hasSamplesForProgram(t){const e=this.presets;if(!e)return!1;for(const s of e)if(s.presetNumber===t)for(const i of s.regions)if(i.samples.length>0)return!0;return!1}hasSamplesForPercussion(t){const e=this.presets;if(!e)return!1;for(const s of e)if(s.bank===q.PercussionBank)for(const i of s.regions)if(i.loKey>=t&&i.hiKey<=t&&i.samples.length>0)return!0;return!1}}class it{constructor(t=void 0){this._listeners=[],this._fireOnRegister=t}on(t){return this._listeners.push(t),this._fireOnRegister?.()&&t(),()=>{this.off(t)}}off(t){this._listeners=this._listeners.filter(e=>e!==t)}trigger(){for(const t of this._listeners)t()}}class pe{constructor(t=void 0){this._listeners=[],this._fireOnRegister=t}on(t){if(this._listeners.push(t),this._fireOnRegister){const e=this._fireOnRegister();null!==e&&t(e)}return()=>{this.off(t)}}off(t){this._listeners=this._listeners.filter(e=>e!==t)}trigger(t){for(const e of this._listeners)e(t)}}class Za{constructor(t){this.events=t}}class rr{constructor(t){this.playbackRange=t}}class uo{constructor(){this.sampleRate=44100,this.useSyncPoints=!1,this.masterVolume=1,this.metronomeVolume=0,this.trackVolume=new Map,this.trackTranspositionPitches=new Map}}class fo{constructor(){this.currentTime=0,this.endTime=0,this.currentTick=0,this.endTick=0}}class ja{get output(){return this._output}get isReadyForPlayback(){return this.isReady&&this.isSoundFontLoaded&&this._isMidiLoaded}get logLevel(){return x.logLevel}set logLevel(t){x.logLevel=t}get masterVolume(){return this.synthesizer.masterVolume}set masterVolume(t){t=Math.max(t,q.MinVolume),this.updateMasterVolume(t)}updateMasterVolume(t){this.synthesizer.masterVolume=t}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(t){t=Math.max(t,q.MinVolume),this._metronomeVolume=t,this.synthesizer.metronomeVolume=t}get countInVolume(){return this._countInVolume}set countInVolume(t){t=Math.max(t,q.MinVolume),this._countInVolume=t}get midiEventsPlayedFilter(){return Array.from(this._midiEventsPlayedFilter)}set midiEventsPlayedFilter(t){this._midiEventsPlayedFilter=new Set(t)}get playbackSpeed(){return this.sequencer.playbackSpeed}set playbackSpeed(t){t=O.clamp(t,q.MinPlaybackSpeed,q.MaxPlaybackSpeed),this.updatePlaybackSpeed(t)}updatePlaybackSpeed(t){const e=this.sequencer.playbackSpeed;this.sequencer.playbackSpeed=t,this.timePosition=this.timePosition*(e/t)}get loadedMidiInfo(){return this._loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._tickPosition}set tickPosition(t){this.timePosition=this.sequencer.mainTickPositionToTimePosition(t)}get timePosition(){return this._timePosition}set timePosition(t){x.debug("AlphaSynth",`Seeking to position ${t}ms (main)`),this.sequencer.mainSeek(t),this.updateTimePosition(t,!0),this.sequencer.isPlayingMain&&(this._notPlayedSamples=0,this.output.resetSamples())}get playbackRange(){return this.sequencer.mainPlaybackRange}set playbackRange(t){this.sequencer.mainPlaybackRange=t,t&&(this.tickPosition=t.startTick),this.playbackRangeChanged.trigger(new rr(t))}get isLooping(){return this.sequencer.isLooping}set isLooping(t){this.sequencer.isLooping=t}destroy(){x.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}constructor(t,e,s){this.isSoundFontLoaded=!1,this._isMidiLoaded=!1,this._tickPosition=0,this._timePosition=0,this._metronomeVolume=0,this._countInVolume=0,this._playedEventsQueue=new Ka,this._midiEventsPlayedFilter=new Set,this._notPlayedSamples=0,this._synthStopping=!1,this._currentPosition=new Fs(0,0,0,0,!1,120,120),this.isReady=!1,this.state=wt.Paused,this._loadedSoundFonts=[],this.readyForPlayback=new it,this.finished=new it,this.soundFontLoaded=new it,this.soundFontLoadFailed=new pe,this.midiLoadFailed=new pe,this.midiEventsPlayed=new pe,x.debug("AlphaSynth","Initializing player"),this.state=wt.Paused,this.ready=new it(()=>this.isReady),this.readyForPlayback=new it(()=>this.isReadyForPlayback),this.midiLoaded=new pe(()=>this._loadedMidiInfo?this._loadedMidiInfo:null),this.stateChanged=new pe(()=>new bi(this.state,!1)),this.positionChanged=new pe(()=>this._currentPosition),this.playbackRangeChanged=new pe(()=>this.playbackRange?new rr(this.playbackRange):null),x.debug("AlphaSynth","Creating output"),this._output=t,x.debug("AlphaSynth","Creating synthesizer"),this.synthesizer=e,this.sequencer=new qn(this.synthesizer),x.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this.checkReadyForPlayback()}),this.output.sampleRequest.on(()=>{this.onSampleRequest()}),this.output.samplesPlayed.on(this.onSamplesPlayed.bind(this)),this.output.open(s)}onSampleRequest(){if(this.state===wt.Playing&&(!this.sequencer.isFinished||this.synthesizer.activeVoiceCount>0)){let t=new Float32Array(q.MicroBufferSize*q.MicroBufferCount*q.AudioChannels),e=0;for(let s=0;s<q.MicroBufferCount;s++){this.sequencer.fillMidiEventQueue();const i=this.synthesizer.synthesize(t,e,q.MicroBufferSize);e+=q.MicroBufferSize*q.AudioChannels;for(const a of i)this._midiEventsPlayedFilter.has(a.event.type)&&this._playedEventsQueue.enqueue(a);if(this.sequencer.isFinished)break}e<t.length&&(t=t.subarray(0,e)),this._notPlayedSamples+=t.length,this.output.addSamples(t)}else{const t=new Float32Array(0);this.output.addSamples(t)}}play(){return!(this.state!==wt.Paused||!this._isMidiLoaded||(this.output.activate(),this.playInternal(),this._countInVolume>0&&(x.debug("AlphaSynth","Starting countin"),this.sequencer.startCountIn(),this.synthesizer.setupMetronomeChannel(this._countInVolume),this.updateTimePosition(0,!0)),this.output.play(),0))}playInternal(){this.sequencer.isPlayingOneTimeMidi&&(x.debug("AlphaSynth","Cancelling one time midi"),this.stopOneTimeMidi()),x.debug("AlphaSynth","Starting playback"),this.synthesizer.setupMetronomeChannel(this.metronomeVolume),this._synthStopping=!1,this.state=wt.Playing,this.stateChanged.trigger(new bi(this.state,!1))}pause(){this.state===wt.Paused||!this._isMidiLoaded||(x.debug("AlphaSynth","Pausing playback"),this.state=wt.Paused,this.stateChanged.trigger(new bi(this.state,!1)),this.output.pause(),this.synthesizer.noteOffAll(!1))}playPause(){this.state===wt.Paused&&this._isMidiLoaded?this.play():this.pause()}stop(){this._isMidiLoaded&&(x.debug("AlphaSynth","Stopping playback"),this.state=wt.Paused,this.output.pause(),this._notPlayedSamples=0,this.sequencer.stop(),this.synthesizer.noteOffAll(!0),this.tickPosition=this.sequencer.mainPlaybackRange?this.sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new bi(this.state,!0)))}playOneTimeMidiFile(t){this.sequencer.isPlayingOneTimeMidi?this.stopOneTimeMidi():this.pause(),this.sequencer.loadOneTimeMidi(t),this.synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this._notPlayedSamples=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this.synthesizer.resetPresets(),this._loadedSoundFonts=[],this.isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}loadSoundFont(t,e){this.pause();const s=Ke.fromBuffer(t);try{x.debug("AlphaSynth","Loading soundfont from bytes");const i=new Zn;i.load(s),e||(this._loadedSoundFonts=[]),this._loadedSoundFonts.push(i),this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),x.debug("AlphaSynth","soundFont successfully loaded"),this.checkReadyForPlayback()}catch(i){x.error("AlphaSynth",`Could not load soundfont from bytes ${i}`),this.soundFontLoadFailed.trigger(i)}}checkReadyForPlayback(){if(this.isReadyForPlayback){this.synthesizer.setupMetronomeChannel(this.metronomeVolume);const t=this.sequencer.instrumentPrograms,e=this.sequencer.percussionKeys;let s=!1;for(const i of this._loadedSoundFonts)this.synthesizer.loadPresets(i,t,e,s),s=!0;this.readyForPlayback.trigger()}}loadMidiFile(t){this.stop();try{x.debug("AlphaSynth","Loading midi from model"),this.sequencer.loadMidi(t),this._isMidiLoaded=!0,this._loadedMidiInfo=new Fs(0,this.sequencer.currentEndTime,0,this.sequencer.currentEndTick,!1,this.sequencer.currentTempo,this.sequencer.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo),x.debug("AlphaSynth","Midi successfully loaded"),this.checkReadyForPlayback(),this.tickPosition=0}catch(e){x.error("AlphaSynth",`Could not load midi from model ${e}`),this.midiLoadFailed.trigger(e)}}applyTranspositionPitches(t){this.synthesizer.applyTranspositionPitches(t)}setChannelTranspositionPitch(t,e){this.synthesizer.setChannelTranspositionPitch(t,e)}setChannelMute(t,e){this.synthesizer.channelSetMute(t,e)}resetChannelStates(){this.synthesizer.resetChannelStates()}setChannelSolo(t,e){this.synthesizer.channelSetSolo(t,e)}setChannelVolume(t,e){e=Math.max(e,q.MinVolume),this.synthesizer.channelSetMixVolume(t,e)}onSamplesPlayed(t){if(0===t)return;const e=t/this.synthesizer.outSampleRate*1e3;this._notPlayedSamples-=t*q.AudioChannels,this.updateTimePosition(this._timePosition+e,!1),this.checkForFinish()}checkForFinish(){let t=0,e=0;this.playbackRange&&this.sequencer.isPlayingMain?(t=this.playbackRange.startTick,e=this.playbackRange.endTick):e=this.sequencer.currentEndTick,this._tickPosition>=e&&(this._notPlayedSamples<=0?(this._notPlayedSamples=0,this.sequencer.isPlayingCountIn?(x.debug("AlphaSynth","Finished playback (count-in)"),this.sequencer.resetCountIn(),this.timePosition=this.sequencer.currentTime,this.playInternal(),this.output.resetSamples()):this.sequencer.isPlayingOneTimeMidi?(x.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=wt.Paused,this.stopOneTimeMidi()):this.isLooping?(x.debug("AlphaSynth","Finished playback (main looping)"),this.finished.trigger(),this.tickPosition=t,this._synthStopping=!1):this.synthesizer.activeVoiceCount>0?this._synthStopping||(x.debug("AlphaSynth","Signaling synth to stop all voices (all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0):(this._synthStopping=!1,x.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.stop())):this._synthStopping||(x.debug("AlphaSynth","Signaling synth to stop all voices (not all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0))}stopOneTimeMidi(){this.output.pause(),this.synthesizer.noteOffAll(!0),this.sequencer.resetOneTimeMidi(),this.timePosition=this.sequencer.currentTime}createPositionChangedEventArgs(t){let e=this._timePosition,s=this.sequencer.currentTimePositionToTickPosition(e);const i=this.sequencer.currentEndTime,a=this.sequencer.currentEndTick;return e>i&&(e=i,s=a),new Fs(e,i,s,a,t,this.sequencer.currentTempo,this.sequencer.modifiedTempo)}updateTimePosition(t,e){this._timePosition=t;const s=this.createPositionChangedEventArgs(e);if(this._tickPosition=s.currentTick,x.debug("AlphaSynth",`Position changed: (time: ${s.currentTime}/${s.endTime}, tick: ${s.currentTick}/${s.endTick}, Active Voices: ${this.synthesizer.activeVoiceCount} (${this.sequencer.isPlayingMain?"main":this.sequencer.isPlayingCountIn?"count-in":"one-time"}), Tempo original: ${this.sequencer.currentTempo}, Tempo modified: ${this.sequencer.modifiedTempo})`),this.sequencer.isPlayingMain&&(this._currentPosition=s,this.positionChanged.trigger(s)),e)this._playedEventsQueue.clear();else{const a=[];for(;!this._playedEventsQueue.isEmpty&&this._playedEventsQueue.peek().time<s.currentTime;){const n=this._playedEventsQueue.dequeue();a.push(n.event)}a.length>0&&(a.reverse(),this.midiEventsPlayed.trigger(new Za(a)))}}hasSamplesForProgram(t){return this.synthesizer.hasSamplesForProgram(t)}hasSamplesForPercussion(t){return this.synthesizer.hasSamplesForPercussion(t)}loadBackingTrack(t){}updateSyncPoints(t){}}class po extends ja{constructor(t,e){super(t,new Er(t.sampleRate),e)}exportAudio(t,e,s,i){const a=new il(t);a.loadMidiFile(e),t.useSyncPoints&&a.updateSyncPoints(s),a.applyTranspositionPitches(i);for(const[n,o]of t.trackTranspositionPitches)a.setChannelTranspositionPitch(n,o);for(const[n,o]of t.trackVolume)a.channelSetMixVolume(n,o);if(t.soundFonts)for(const n of t.soundFonts)a.loadSoundFont(n);else a.loadPresets(this.synthesizer.presets);return t.playbackRange&&a.limitExport(t.playbackRange),a.setup(),a}}class il{constructor(t){this._generatedAudioCurrentTime=0,this._generatedAudioEndTime=0,this._synth=new Er(t.sampleRate),this._sequencer=new qn(this._synth),this._synth.masterVolume=Math.max(t.masterVolume,q.MinVolume),this._synth.metronomeVolume=Math.max(t.metronomeVolume,q.MinVolume)}loadSoundFont(t){const e=Ke.fromBuffer(t),s=new Zn;s.load(e),this._synth.loadPresets(s,this._sequencer.instrumentPrograms,this._sequencer.percussionKeys,!0)}loadPresets(t){this._synth.presets=t}limitExport(t){this._sequencer.mainPlaybackRange=t,this._sequencer.mainSeek(this._sequencer.mainTickPositionToTimePosition(t.startTick))}setChannelTranspositionPitch(t,e){this._synth.setChannelTranspositionPitch(t,e)}applyTranspositionPitches(t){this._synth.applyTranspositionPitches(t)}loadMidiFile(t){this._sequencer.loadMidi(t)}updateSyncPoints(t){this._sequencer.mainUpdateSyncPoints(t)}channelSetMixVolume(t,e){e=Math.max(e,q.MinVolume),this._synth.channelSetMixVolume(t,e)}setup(){this._synth.setupMetronomeChannel(this._synth.metronomeVolume);const t=this._sequencer.currentSyncPoints;if(0===t.length)this._generatedAudioEndTime=this._sequencer.currentEndTime;else{const s=t[t.length-1];let i=s.syncTime;const a=this._sequencer.currentEndTick-s.synthTick;a>0&&(i+=C.ticksToMillis(a,s.syncBpm)),this._generatedAudioEndTime=i}}render(t){if(this._sequencer.isFinished)return;const e=1e3*q.MicroBufferSize/this._synth.outSampleRate,s=Math.ceil(t/e);let i=new Float32Array(q.MicroBufferSize*s*q.AudioChannels);const a=this._sequencer.currentSyncPoints;let n=0,o=this._generatedAudioCurrentTime,h=0;for(let d=0;d<s;d++){if(a.length>0){this._sequencer.currentUpdateSyncPoints(o),this._sequencer.currentUpdateCurrentTempo(this._sequencer.currentTime);const u=this._sequencer.syncPointTempo/this._sequencer.currentTempo;this._sequencer.playbackSpeed!==u&&(this._sequencer.playbackSpeed=u)}if(this._sequencer.fillMidiEventQueue(),this._synth.synthesize(i,n,q.MicroBufferSize),n+=q.MicroBufferSize*q.AudioChannels,o+=e,h+=e*this._sequencer.playbackSpeed,this._sequencer.isFinished)break}n<i.length&&(i=i.subarray(0,n));const c=new fo;return c.currentTime=this._generatedAudioCurrentTime,c.endTime=this._generatedAudioEndTime,c.currentTick=this._sequencer.currentTimePositionToTickPosition(this._sequencer.currentTime),c.endTick=this._sequencer.currentEndTick,this._generatedAudioCurrentTime+=t,c.samples=i,this._sequencer.isFinished&&this._synth.noteOffAll(!0),c}}class T{static parseEnum(t,e){switch(typeof t){case"string":const s=Number.parseInt(t);return Number.isNaN(s)?e[Object.keys(e).find(i=>i.toLowerCase()===t.toLowerCase())]:s;case"number":return t;case"undefined":case"object":return}throw new Le(Fe.Format,`Could not parse enum value '${t}'`)}static forEach(t,e){if(t instanceof Map)t.forEach(e);else if("object"==typeof t)for(const s in t)e(t[s],s)}static getValue(t,e){return t instanceof Map?t.get(e):"object"==typeof t?t[e]:null}}class rl{constructor(t,e,s){this.text=t,this.startPos=e,this.endPos=s}}class Mi{constructor(t){this.style="normal",this.variant="normal",this.weight="normal",this.stretch="normal",this.lineHeight="normal",this.size="1rem",this.families=[],this.parseOnlyFamilies=!1,this._currentTokenIndex=-1,this._input="",this._currentToken=null,this._input=t,this._tokens=this.splitToTokens(t)}splitToTokens(t){const e=[];let s=0;for(;s<t.length;){let i=s;for(;i<t.length&&" "!==t.charAt(i);)i++;i>s&&e.push(new rl(t.substring(s,i),s,i)),s=i+1}return e}parse(){if(this.reset(),1===this._tokens.length)switch(this._currentToken?.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this.fontStyleVariantWeight(),this.fontSizeLineHeight()),this.fontFamily()}static parseFamilies(t){const e=new Mi(t);return e.parseOnlyFamilies=!0,e.parse(),e.families}fontFamily(){if(!this._currentToken){if(this.parseOnlyFamilies)return;throw new Error("Missing font list")}const t=this._input.substr(this._currentToken.startPos).trim();let e=0;for(;e<t.length;){const s=t.charAt(e);if(" "===s||","===s)e++;else if('"'===s||"'"===s){const i=this.findEndOfQuote(t,e+1,s);this.families.push(t.substring(e+1,i).split(`\\${s}`).join(s)),e=i+1}else{const i=this.findEndOfQuote(t,e+1,",");this.families.push(t.substring(e,i).trim()),e=i+1}}}findEndOfQuote(t,e,s){let i=!1;for(;e<t.length;){const a=t.charAt(e);if(!i&&a===s)return e;i=!i&&"\\"===a,e+=1}return t.length}fontSizeLineHeight(){if(!this._currentToken)throw new Error("Missing font size");const t=this._currentToken.text.split("/");if(t.length>=3)throw new Error(`Invalid font size '${this._currentToken}' specified`);if(this.nextToken(),t.length>=2)if("/"===t[1]){if(!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this.nextToken()}else this.size=t[0],this.lineHeight=t[1];else{if(!(t.length>=1))throw new Error("Missing font size");if(this.size=t[0],this._currentToken&&0===this._currentToken.text.indexOf("/"))if("/"===this._currentToken.text){if(this.nextToken(),!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this.nextToken()}else this.lineHeight=this._currentToken.text.substr(1),this.nextToken()}}nextToken(){this._currentTokenIndex++,this._currentToken=this._currentTokenIndex<this._tokens.length?this._tokens[this._currentTokenIndex]:null}fontStyleVariantWeight(){let t=!1,e=!1,s=!1,i=3;const a=[];for(;;){if(!this._currentToken)return;const n=this._currentToken.text;switch(n){case"normal":case"inherit":a.push(n),i--,this.nextToken();break;case"italic":case"oblique":this.style=n,t=!0,i--,this.nextToken();break;case"small-caps":this.variant=n,e=!0,i--,this.nextToken();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=n,s=!0,i--,this.nextToken();break;default:return}if(0===i)break}for(;a.length>0;){const n=a.pop();s?e?t||(this.style=n):this.variant=n:this.weight=n}}reset(){this._currentTokenIndex=-1,this.nextToken()}static quoteFont(t){return-1===t.indexOf(" ")?t:`"${t.replaceAll('"','\\"')}"`}}var Xe=function(r){return r[r.Plain=0]="Plain",r[r.Italic=1]="Italic",r}(Xe||{}),Ut=function(r){return r[r.Regular=0]="Regular",r[r.Bold=1]="Bold",r}(Ut||{});class de{reset(){this._cssScale=0,this._css=this.toCssString()}get family(){return this._families[0]}set family(t){this.families=Mi.parseFamilies(t)}get families(){return this._families}set families(t){this._families=t,this.reset()}get size(){return this._size}set size(t){this._size=t,this.reset()}get style(){return this._style}set style(t){this._style=t,this.reset()}get weight(){return this._weight}set weight(t){this._weight=t,this.reset()}get isBold(){return this.weight===Ut.Bold}get isItalic(){return this.style===Xe.Italic}constructor(t,e,s=Xe.Plain,i=Ut.Regular){this._cssScale=0,this._families=Mi.parseFamilies(t),this._size=e,this._style=s,this._weight=i,this._css=this.toCssString()}withSize(t){return de.withFamilyList(this._families,t,this._style,this._weight)}static withFamilyList(t,e,s=Xe.Plain,i=Ut.Regular){const a=new de("",e,s,i);return a.families=t,a}toCssString(t=1){if(!(this._css&&Math.abs(t-this._cssScale)<.01)){let e="";this.isBold&&(e+="bold "),this.isItalic&&(e+="italic "),e+=this.size*t,e+="px ",e+=this.families.map(s=>Mi.quoteFont(s)).join(", "),this._css=e,this._cssScale=t}return this._css}static fromJson(t){if(t instanceof de)return t;switch(typeof t){case"undefined":default:return;case"object":{const e=t,s=e.get("families"),i=e.get("size"),a=T.parseEnum(e.get("style"),Xe),n=T.parseEnum(e.get("weight"),Ut);return de.withFamilyList(s,i,a,n)}case"string":{const e=new Mi(t);e.parse();const s=e.families,i=e.size.toLowerCase();let a=0;switch(i){case"xx-small":a=7;break;case"x-small":a=10;break;case"small":case"smaller":a=13;break;case"medium":a=16;break;case"large":case"larger":a=18;break;case"x-large":a=24;break;case"xx-large":a=32;break;default:try{a=i.endsWith("em")?16*Number.parseFloat(i.substr(0,i.length-2)):i.endsWith("pt")?16*Number.parseFloat(i.substr(0,i.length-2))/12:i.endsWith("px")?Number.parseFloat(i.substr(0,i.length-2)):12}catch{a=12}}let n=Xe.Plain;"italic"===e.style&&(n=Xe.Italic);let o=Ut.Regular;switch(e.weight.toLowerCase()){case"normal":case"lighter":break;default:o=Ut.Bold}return de.withFamilyList(s,a,n,o)}}}static toJson(t){if(!t)return;const e=new Map;return e.set("families",t.families),e.set("size",t.size),e.set("style",t.style),e.set("weight",t.weight),e}}let al=(()=>{class r{constructor(){this.copyrightFont=new de(r.sansFont,12,Xe.Plain,Ut.Bold),this.titleFont=new de(r.serifFont,32,Xe.Plain),this.subTitleFont=new de(r.serifFont,20,Xe.Plain),this.wordsFont=new de(r.serifFont,15,Xe.Plain),this.effectFont=new de(r.serifFont,12,Xe.Italic),this.timerFont=new de(r.serifFont,12,Xe.Plain),this.directionsFont=new de(r.serifFont,14,Xe.Plain),this.fretboardNumberFont=new de(r.sansFont,11,Xe.Plain),this.numberedNotationFont=new de(r.sansFont,16,Xe.Plain),this.numberedNotationGraceFont=new de(r.sansFont,14,Xe.Plain),this.tablatureFont=new de(r.sansFont,13,Xe.Plain),this.graceFont=new de(r.sansFont,11,Xe.Plain),this.staffLineColor=new Ee(165,165,165,255),this.barSeparatorColor=new Ee(34,34,17,255),this.barNumberFont=new de(r.sansFont,11,Xe.Plain),this.barNumberColor=new Ee(200,0,0,255),this.fingeringFont=new de(r.serifFont,14,Xe.Plain),this.inlineFingeringFont=new de(r.serifFont,12,Xe.Plain),this.markerFont=new de(r.serifFont,14,Xe.Plain,Ut.Bold),this.mainGlyphColor=new Ee(0,0,0,255),this.secondaryGlyphColor=new Ee(0,0,0,100),this.scoreInfoColor=new Ee(0,0,0,255)}getFontForElement(e){switch(e){case H.Title:return this.titleFont;case H.SubTitle:case H.Artist:case H.Album:return this.subTitleFont;case H.Words:case H.Music:case H.WordsAndMusic:case H.Transcriber:return this.wordsFont;case H.Copyright:case H.CopyrightSecondLine:return this.copyrightFont}return this.wordsFont}}return r.sansFont="Arial, sans-serif",r.serifFont="Georgia, serif",r})();var wi=function(r){return r[r.Automatic=0]="Automatic",r[r.UseModelLayout=1]="UseModelLayout",r}(wi||{});class nl{constructor(){this.scale=1,this.stretchForce=1,this.layoutMode=cs.Page,this.staveProfile=ds.Default,this.barsPerRow=-1,this.startBar=1,this.barCount=-1,this.barCountPerPartial=10,this.justifyLastSystem=!1,this.resources=new al,this.padding=[35,35],this.firstSystemPaddingTop=5,this.systemPaddingTop=10,this.systemPaddingBottom=20,this.lastSystemPaddingBottom=0,this.systemLabelPaddingLeft=0,this.systemLabelPaddingRight=3,this.accoladeBarPaddingRight=3,this.notationStaffPaddingTop=5,this.notationStaffPaddingBottom=5,this.effectStaffPaddingTop=0,this.effectStaffPaddingBottom=0,this.firstStaffPaddingLeft=6,this.staffPaddingLeft=2,this.systemsLayoutMode=wi.Automatic}}class ol{constructor(){this.encoding="utf-8",this.mergePartGroupsInMusicXml=!1,this.beatTextAsLyrics=!1}}var ei=function(r){return r[r.Off=0]="Off",r[r.Continuous=1]="Continuous",r[r.OffScreen=2]="OffScreen",r}(ei||{});class hl{constructor(){this.noteWideLength=240,this.noteWideAmplitude=1,this.noteSlightLength=360,this.noteSlightAmplitude=.5,this.beatWideLength=480,this.beatWideAmplitude=2,this.beatSlightLength=480,this.beatSlightAmplitude=2}}class ll{constructor(){this.simpleSlidePitchOffset=6,this.simpleSlideDurationRatio=.25,this.shiftSlideDurationRatio=.5}}var vr=function(r){return r[r.WebAudioAudioWorklets=0]="WebAudioAudioWorklets",r[r.WebAudioScriptProcessor=1]="WebAudioScriptProcessor",r}(vr||{}),Ot=function(r){return r[r.Disabled=0]="Disabled",r[r.EnabledAutomatic=1]="EnabledAutomatic",r[r.EnabledSynthesizer=2]="EnabledSynthesizer",r[r.EnabledBackingTrack=3]="EnabledBackingTrack",r[r.EnabledExternalMedia=4]="EnabledExternalMedia",r}(Ot||{});class cl{constructor(){this.soundFont=null,this.scrollElement="html,body",this.outputMode=vr.WebAudioAudioWorklets,this.enablePlayer=!1,this.playerMode=Ot.Disabled,this.enableCursor=!0,this.enableAnimatedBeatCursor=!0,this.enableElementHighlighting=!0,this.enableUserInteraction=!0,this.scrollOffsetX=0,this.scrollOffsetY=0,this.scrollMode=ei.Continuous,this.scrollSpeed=300,this.nativeBrowserSmoothScroll=!0,this.songBookBendDuration=75,this.songBookDipDuration=150,this.vibrato=new hl,this.slide=new ll,this.playTripletFeel=!0,this.bufferTimeInMilliseconds=500}}class ar{static fromJson(t,e){e&&T.forEach(e,(s,i)=>ar.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("scriptfile",t.scriptFile),e.set("fontdirectory",t.fontDirectory),null!==t.smuflFontSources){const s=new Map;e.set("smuflfontsources",s);for(const[i,a]of t.smuflFontSources)s.set(i.toString(),a)}return e.set("file",t.file),e.set("tex",t.tex),e.set("tracks",t.tracks),e.set("enablelazyloading",t.enableLazyLoading),e.set("engine",t.engine),e.set("loglevel",t.logLevel),e.set("useworkers",t.useWorkers),e.set("includenotebounds",t.includeNoteBounds),e}static setProperty(t,e,s){switch(e){case"scriptfile":return t.scriptFile=s,!0;case"fontdirectory":return t.fontDirectory=s,!0;case"smuflfontsources":return t.smuflFontSources=new Map,T.forEach(s,(i,a)=>{t.smuflFontSources.set(T.parseEnum(a,Bs),i)}),!0;case"file":return t.file=s,!0;case"tex":return t.tex=s,!0;case"tracks":return t.tracks=s,!0;case"enablelazyloading":return t.enableLazyLoading=s,!0;case"engine":return t.engine=s,!0;case"loglevel":return t.logLevel=T.parseEnum(s,Ns),!0;case"useworkers":return t.useWorkers=s,!0;case"includenotebounds":return t.includeNoteBounds=s,!0}return!1}}class nr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>nr.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("smuflfont",de.toJson(t.smuflFont)),e.set("copyrightfont",de.toJson(t.copyrightFont)),e.set("titlefont",de.toJson(t.titleFont)),e.set("subtitlefont",de.toJson(t.subTitleFont)),e.set("wordsfont",de.toJson(t.wordsFont)),e.set("effectfont",de.toJson(t.effectFont)),e.set("timerfont",de.toJson(t.timerFont)),e.set("directionsfont",de.toJson(t.directionsFont)),e.set("fretboardnumberfont",de.toJson(t.fretboardNumberFont)),e.set("numberednotationfont",de.toJson(t.numberedNotationFont)),e.set("numberednotationgracefont",de.toJson(t.numberedNotationGraceFont)),e.set("tablaturefont",de.toJson(t.tablatureFont)),e.set("gracefont",de.toJson(t.graceFont)),e.set("stafflinecolor",Ee.toJson(t.staffLineColor)),e.set("barseparatorcolor",Ee.toJson(t.barSeparatorColor)),e.set("barnumberfont",de.toJson(t.barNumberFont)),e.set("barnumbercolor",Ee.toJson(t.barNumberColor)),e.set("fingeringfont",de.toJson(t.fingeringFont)),e.set("inlinefingeringfont",de.toJson(t.inlineFingeringFont)),e.set("markerfont",de.toJson(t.markerFont)),e.set("mainglyphcolor",Ee.toJson(t.mainGlyphColor)),e.set("secondaryglyphcolor",Ee.toJson(t.secondaryGlyphColor)),e.set("scoreinfocolor",Ee.toJson(t.scoreInfoColor)),e}static setProperty(t,e,s){switch(e){case"smuflfont":return t.smuflFont=de.fromJson(s),!0;case"copyrightfont":return t.copyrightFont=de.fromJson(s),!0;case"titlefont":return t.titleFont=de.fromJson(s),!0;case"subtitlefont":return t.subTitleFont=de.fromJson(s),!0;case"wordsfont":return t.wordsFont=de.fromJson(s),!0;case"effectfont":return t.effectFont=de.fromJson(s),!0;case"timerfont":return t.timerFont=de.fromJson(s),!0;case"directionsfont":return t.directionsFont=de.fromJson(s),!0;case"fretboardnumberfont":return t.fretboardNumberFont=de.fromJson(s),!0;case"numberednotationfont":return t.numberedNotationFont=de.fromJson(s),!0;case"numberednotationgracefont":return t.numberedNotationGraceFont=de.fromJson(s),!0;case"tablaturefont":return t.tablatureFont=de.fromJson(s),!0;case"gracefont":return t.graceFont=de.fromJson(s),!0;case"stafflinecolor":return t.staffLineColor=Ee.fromJson(s),!0;case"barseparatorcolor":return t.barSeparatorColor=Ee.fromJson(s),!0;case"barnumberfont":return t.barNumberFont=de.fromJson(s),!0;case"barnumbercolor":return t.barNumberColor=Ee.fromJson(s),!0;case"fingeringfont":return t.fingeringFont=de.fromJson(s),!0;case"inlinefingeringfont":return t.inlineFingeringFont=de.fromJson(s),!0;case"markerfont":return t.markerFont=de.fromJson(s),!0;case"mainglyphcolor":return t.mainGlyphColor=Ee.fromJson(s),!0;case"secondaryglyphcolor":return t.secondaryGlyphColor=Ee.fromJson(s),!0;case"scoreinfocolor":return t.scoreInfoColor=Ee.fromJson(s),!0}return!1}}class or{static fromJson(t,e){e&&T.forEach(e,(s,i)=>or.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("scale",t.scale),e.set("stretchforce",t.stretchForce),e.set("layoutmode",t.layoutMode),e.set("staveprofile",t.staveProfile),e.set("barsperrow",t.barsPerRow),e.set("startbar",t.startBar),e.set("barcount",t.barCount),e.set("barcountperpartial",t.barCountPerPartial),e.set("justifylastsystem",t.justifyLastSystem),e.set("resources",nr.toJson(t.resources)),e.set("padding",t.padding),e.set("firstsystempaddingtop",t.firstSystemPaddingTop),e.set("systempaddingtop",t.systemPaddingTop),e.set("systempaddingbottom",t.systemPaddingBottom),e.set("lastsystempaddingbottom",t.lastSystemPaddingBottom),e.set("systemlabelpaddingleft",t.systemLabelPaddingLeft),e.set("systemlabelpaddingright",t.systemLabelPaddingRight),e.set("accoladebarpaddingright",t.accoladeBarPaddingRight),e.set("notationstaffpaddingtop",t.notationStaffPaddingTop),e.set("notationstaffpaddingbottom",t.notationStaffPaddingBottom),e.set("effectstaffpaddingtop",t.effectStaffPaddingTop),e.set("effectstaffpaddingbottom",t.effectStaffPaddingBottom),e.set("firststaffpaddingleft",t.firstStaffPaddingLeft),e.set("staffpaddingleft",t.staffPaddingLeft),e.set("systemslayoutmode",t.systemsLayoutMode),e}static setProperty(t,e,s){switch(e){case"scale":return t.scale=s,!0;case"stretchforce":return t.stretchForce=s,!0;case"layoutmode":return t.layoutMode=T.parseEnum(s,cs),!0;case"staveprofile":return t.staveProfile=T.parseEnum(s,ds),!0;case"barsperrow":return t.barsPerRow=s,!0;case"startbar":return t.startBar=s,!0;case"barcount":return t.barCount=s,!0;case"barcountperpartial":return t.barCountPerPartial=s,!0;case"justifylastsystem":return t.justifyLastSystem=s,!0;case"padding":return t.padding=s,!0;case"firstsystempaddingtop":return t.firstSystemPaddingTop=s,!0;case"systempaddingtop":return t.systemPaddingTop=s,!0;case"systempaddingbottom":return t.systemPaddingBottom=s,!0;case"lastsystempaddingbottom":return t.lastSystemPaddingBottom=s,!0;case"systemlabelpaddingleft":return t.systemLabelPaddingLeft=s,!0;case"systemlabelpaddingright":return t.systemLabelPaddingRight=s,!0;case"accoladebarpaddingright":return t.accoladeBarPaddingRight=s,!0;case"notationstaffpaddingtop":return t.notationStaffPaddingTop=s,!0;case"notationstaffpaddingbottom":return t.notationStaffPaddingBottom=s,!0;case"effectstaffpaddingtop":return t.effectStaffPaddingTop=s,!0;case"effectstaffpaddingbottom":return t.effectStaffPaddingBottom=s,!0;case"firststaffpaddingleft":return t.firstStaffPaddingLeft=s,!0;case"staffpaddingleft":return t.staffPaddingLeft=s,!0;case"systemslayoutmode":return t.systemsLayoutMode=T.parseEnum(s,wi),!0}if(["resources"].indexOf(e)>=0)return nr.fromJson(t.resources,s),!0;for(const i of["resources"])if(0===e.indexOf(i)&&nr.setProperty(t.resources,e.substring(i.length),s))return!0;return!1}}class hr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>hr.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;e.set("notationmode",t.notationMode),e.set("fingeringmode",t.fingeringMode);{const s=new Map;e.set("elements",s);for(const[i,a]of t.elements)s.set(i.toString(),a)}return e.set("rhythmmode",t.rhythmMode),e.set("rhythmheight",t.rhythmHeight),e.set("transpositionpitches",t.transpositionPitches),e.set("displaytranspositionpitches",t.displayTranspositionPitches),e.set("smallgracetabnotes",t.smallGraceTabNotes),e.set("extendbendarrowsontiednotes",t.extendBendArrowsOnTiedNotes),e.set("extendlineeffectstobeatend",t.extendLineEffectsToBeatEnd),e.set("slurheight",t.slurHeight),e}static setProperty(t,e,s){switch(e){case"notationmode":return t.notationMode=T.parseEnum(s,_t),!0;case"fingeringmode":return t.fingeringMode=T.parseEnum(s,xs),!0;case"elements":return t.elements=new Map,T.forEach(s,(i,a)=>{t.elements.set(T.parseEnum(a,fe),i)}),!0;case"rhythmmode":return t.rhythmMode=T.parseEnum(s,ps),!0;case"rhythmheight":return t.rhythmHeight=s,!0;case"transpositionpitches":return t.transpositionPitches=s,!0;case"displaytranspositionpitches":return t.displayTranspositionPitches=s,!0;case"smallgracetabnotes":return t.smallGraceTabNotes=s,!0;case"extendbendarrowsontiednotes":return t.extendBendArrowsOnTiedNotes=s,!0;case"extendlineeffectstobeatend":return t.extendLineEffectsToBeatEnd=s,!0;case"slurheight":return t.slurHeight=s,!0}return!1}}class lr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>lr.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("encoding",t.encoding),e.set("mergepartgroupsinmusicxml",t.mergePartGroupsInMusicXml),e.set("beattextaslyrics",t.beatTextAsLyrics),e}static setProperty(t,e,s){switch(e){case"encoding":return t.encoding=s,!0;case"mergepartgroupsinmusicxml":return t.mergePartGroupsInMusicXml=s,!0;case"beattextaslyrics":return t.beatTextAsLyrics=s,!0}return!1}}class cr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>cr.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("notewidelength",t.noteWideLength),e.set("notewideamplitude",t.noteWideAmplitude),e.set("noteslightlength",t.noteSlightLength),e.set("noteslightamplitude",t.noteSlightAmplitude),e.set("beatwidelength",t.beatWideLength),e.set("beatwideamplitude",t.beatWideAmplitude),e.set("beatslightlength",t.beatSlightLength),e.set("beatslightamplitude",t.beatSlightAmplitude),e}static setProperty(t,e,s){switch(e){case"notewidelength":return t.noteWideLength=s,!0;case"notewideamplitude":return t.noteWideAmplitude=s,!0;case"noteslightlength":return t.noteSlightLength=s,!0;case"noteslightamplitude":return t.noteSlightAmplitude=s,!0;case"beatwidelength":return t.beatWideLength=s,!0;case"beatwideamplitude":return t.beatWideAmplitude=s,!0;case"beatslightlength":return t.beatSlightLength=s,!0;case"beatslightamplitude":return t.beatSlightAmplitude=s,!0}return!1}}class dr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>dr.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("simpleslidepitchoffset",t.simpleSlidePitchOffset),e.set("simpleslidedurationratio",t.simpleSlideDurationRatio),e.set("shiftslidedurationratio",t.shiftSlideDurationRatio),e}static setProperty(t,e,s){switch(e){case"simpleslidepitchoffset":return t.simpleSlidePitchOffset=s,!0;case"simpleslidedurationratio":return t.simpleSlideDurationRatio=s,!0;case"shiftslidedurationratio":return t.shiftSlideDurationRatio=s,!0}return!1}}class ur{static fromJson(t,e){e&&T.forEach(e,(s,i)=>ur.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("soundfont",t.soundFont),e.set("outputmode",t.outputMode),e.set("enableplayer",t.enablePlayer),e.set("playermode",t.playerMode),e.set("enablecursor",t.enableCursor),e.set("enableanimatedbeatcursor",t.enableAnimatedBeatCursor),e.set("enableelementhighlighting",t.enableElementHighlighting),e.set("enableuserinteraction",t.enableUserInteraction),e.set("scrolloffsetx",t.scrollOffsetX),e.set("scrolloffsety",t.scrollOffsetY),e.set("scrollmode",t.scrollMode),e.set("scrollspeed",t.scrollSpeed),e.set("nativebrowsersmoothscroll",t.nativeBrowserSmoothScroll),e.set("songbookbendduration",t.songBookBendDuration),e.set("songbookdipduration",t.songBookDipDuration),e.set("vibrato",cr.toJson(t.vibrato)),e.set("slide",dr.toJson(t.slide)),e.set("playtripletfeel",t.playTripletFeel),e.set("buffertimeinmilliseconds",t.bufferTimeInMilliseconds),e}static setProperty(t,e,s){switch(e){case"soundfont":return t.soundFont=s,!0;case"scrollelement":return t.scrollElement=s,!0;case"outputmode":return t.outputMode=T.parseEnum(s,vr),!0;case"enableplayer":return t.enablePlayer=s,!0;case"playermode":return t.playerMode=T.parseEnum(s,Ot),!0;case"enablecursor":return t.enableCursor=s,!0;case"enableanimatedbeatcursor":return t.enableAnimatedBeatCursor=s,!0;case"enableelementhighlighting":return t.enableElementHighlighting=s,!0;case"enableuserinteraction":return t.enableUserInteraction=s,!0;case"scrolloffsetx":return t.scrollOffsetX=s,!0;case"scrolloffsety":return t.scrollOffsetY=s,!0;case"scrollmode":return t.scrollMode=T.parseEnum(s,ei),!0;case"scrollspeed":return t.scrollSpeed=s,!0;case"nativebrowsersmoothscroll":return t.nativeBrowserSmoothScroll=s,!0;case"songbookbendduration":return t.songBookBendDuration=s,!0;case"songbookdipduration":return t.songBookDipDuration=s,!0;case"playtripletfeel":return t.playTripletFeel=s,!0;case"buffertimeinmilliseconds":return t.bufferTimeInMilliseconds=s,!0}if(["vibrato"].indexOf(e)>=0)return cr.fromJson(t.vibrato,s),!0;for(const i of["vibrato"])if(0===e.indexOf(i)&&cr.setProperty(t.vibrato,e.substring(i.length),s))return!0;if(["slide"].indexOf(e)>=0)return dr.fromJson(t.slide,s),!0;for(const i of["slide"])if(0===e.indexOf(i)&&dr.setProperty(t.slide,e.substring(i.length),s))return!0;return!1}}class ti{static fromJson(t,e){e&&T.forEach(e,(s,i)=>ti.setProperty(t,i.toLowerCase(),s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("core",ar.toJson(t.core)),e.set("display",or.toJson(t.display)),e.set("notation",hr.toJson(t.notation)),e.set("importer",lr.toJson(t.importer)),e.set("player",ur.toJson(t.player)),e}static setProperty(t,e,s){if(["core",""].indexOf(e)>=0)return ar.fromJson(t.core,s),!0;for(const i of["core",""])if(0===e.indexOf(i)&&ar.setProperty(t.core,e.substring(i.length),s))return!0;if(["display",""].indexOf(e)>=0)return or.fromJson(t.display,s),!0;for(const i of["display",""])if(0===e.indexOf(i)&&or.setProperty(t.display,e.substring(i.length),s))return!0;if(["notation"].indexOf(e)>=0)return hr.fromJson(t.notation,s),!0;for(const i of["notation"])if(0===e.indexOf(i)&&hr.setProperty(t.notation,e.substring(i.length),s))return!0;if(["importer"].indexOf(e)>=0)return lr.fromJson(t.importer,s),!0;for(const i of["importer"])if(0===e.indexOf(i)&&lr.setProperty(t.importer,e.substring(i.length),s))return!0;if(["player"].indexOf(e)>=0)return ur.fromJson(t.player,s),!0;for(const i of["player"])if(0===e.indexOf(i)&&ur.setProperty(t.player,e.substring(i.length),s))return!0;return!1}}class Gs{constructor(){this.core=new vn,this.display=new nl,this.notation=new Xi,this.importer=new ol,this.player=new cl}setSongBookModeSettings(){this.notation.notationMode=_t.SongBook,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=xs.SingleNoteEffectBand,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(fe.ParenthesisOnTiedBends,!1),this.notation.elements.set(fe.TabNotesOnTiedBends,!1),this.notation.elements.set(fe.ZerosOnDiveWhammys,!0)}static get songBook(){const t=new Gs;return t.setSongBookModeSettings(),t}fillFromJson(t){ti.fromJson(this,t)}handleBackwardsCompatibility(){this.player.playerMode===Ot.Disabled&&this.player.enablePlayer&&(this.player.playerMode=Ot.EnabledAutomatic)}}class Ir{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Ir.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("marker",t.marker),e.set("text",t.text),e}static setProperty(t,e,s){switch(e){case"marker":return t.marker=s,!0;case"text":return t.text=s,!0}return!1}}class Ar{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Ar.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("baroccurence",t.barOccurence),e.set("millisecondoffset",t.millisecondOffset),e}static setProperty(t,e,s){switch(e){case"baroccurence":return t.barOccurence=s,!0;case"millisecondoffset":return t.millisecondOffset=s,!0}return!1}}class si{static fromJson(t,e){e&&T.forEach(e,(s,i)=>si.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("islinear",t.isLinear),e.set("type",t.type),e.set("value",t.value),t.syncPointValue&&e.set("syncpointvalue",Ar.toJson(t.syncPointValue)),e.set("ratioposition",t.ratioPosition),e.set("text",t.text),e}static setProperty(t,e,s){switch(e){case"islinear":return t.isLinear=s,!0;case"type":return t.type=T.parseEnum(s,Ge),!0;case"value":return t.value=s,!0;case"syncpointvalue":return s?(t.syncPointValue=new Yi,Ar.fromJson(t.syncPointValue,s)):t.syncPointValue=void 0,!0;case"ratioposition":return t.ratioPosition=s,!0;case"text":return t.text=s,!0}return!1}}class Mr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Mr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("type",t.type),e.set("length",t.length),e}static setProperty(t,e,s){switch(e){case"type":return t.type=T.parseEnum(s,Ct),!0;case"length":return t.length=s,!0}return!1}}class Rr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Rr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("alternateendings",t.alternateEndings),e.set("isdoublebar",t.isDoubleBar),e.set("isrepeatstart",t.isRepeatStart),e.set("repeatcount",t.repeatCount),e.set("timesignaturenumerator",t.timeSignatureNumerator),e.set("timesignaturedenominator",t.timeSignatureDenominator),e.set("timesignaturecommon",t.timeSignatureCommon),e.set("isfreetime",t.isFreeTime),e.set("tripletfeel",t.tripletFeel),t.section&&e.set("section",Ir.toJson(t.section)),e.set("tempoautomations",t.tempoAutomations.map(s=>si.toJson(s))),void 0!==t.syncPoints&&e.set("syncpoints",t.syncPoints?.map(s=>si.toJson(s))),null!==t.fermata){const s=new Map;e.set("fermata",s);for(const[i,a]of t.fermata)s.set(i.toString(),Mr.toJson(a))}if(e.set("start",t.start),e.set("isanacrusis",t.isAnacrusis),e.set("displayscale",t.displayScale),e.set("displaywidth",t.displayWidth),null!==t.directions){const s=[];e.set("directions",s);for(const i of t.directions)s.push(i)}return e}static setProperty(t,e,s){switch(e){case"alternateendings":return t.alternateEndings=s,!0;case"isdoublebar":return t.isDoubleBar=s,!0;case"isrepeatstart":return t.isRepeatStart=s,!0;case"repeatcount":return t.repeatCount=s,!0;case"timesignaturenumerator":return t.timeSignatureNumerator=s,!0;case"timesignaturedenominator":return t.timeSignatureDenominator=s,!0;case"timesignaturecommon":return t.timeSignatureCommon=s,!0;case"isfreetime":return t.isFreeTime=s,!0;case"tripletfeel":return t.tripletFeel=T.parseEnum(s,ue),!0;case"section":return s?(t.section=new Fi,Ir.fromJson(t.section,s)):t.section=null,!0;case"tempoautomations":t.tempoAutomations=[];for(const i of s){const a=new Qe;si.fromJson(a,i),t.tempoAutomations.push(a)}return!0;case"syncpoints":if(s){t.syncPoints=[];for(const i of s){const a=new Qe;si.fromJson(a,i),t.addSyncPoint(a)}}return!0;case"fermata":return t.fermata=new Map,T.forEach(s,(i,a)=>{const n=new Ei;Mr.fromJson(n,i),t.addFermata(Number.parseInt(a),n)}),!0;case"start":return t.start=s,!0;case"isanacrusis":return t.isAnacrusis=s,!0;case"displayscale":return t.displayScale=s,!0;case"displaywidth":return t.displayWidth=s,!0;case"directions":for(const i of s)t.addDirection(T.parseEnum(i,I));return!0}return!1}}class Ri{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Ri.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("offset",t.offset),e.set("value",t.value),e}static setProperty(t,e,s){switch(e){case"offset":return t.offset=s,!0;case"value":return t.value=s,!0}return!1}}class Or{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Or.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;e.set("notehead",t.noteHead),e.set("noteheadcenteronstem",t.noteHeadCenterOnStem);{const s=new Map;e.set("colors",s);for(const[i,a]of t.colors)s.set(i.toString(),Ee.toJson(a))}return e}static setProperty(t,e,s){switch(e){case"notehead":return t.noteHead=T.parseEnum(s,l),!0;case"noteheadcenteronstem":return t.noteHeadCenterOnStem=s,!0;case"colors":return t.colors=new Map,T.forEach(s,(i,a)=>{t.colors.set(T.parseEnum(a,Et),Ee.fromJson(i))}),!0}return!1}}class Hr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Hr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("accentuated",t.accentuated),e.set("bendtype",t.bendType),e.set("bendstyle",t.bendStyle),e.set("iscontinuedbend",t.isContinuedBend),null!==t.bendPoints&&e.set("bendpoints",t.bendPoints?.map(s=>Ri.toJson(s))),e.set("fret",t.fret),e.set("string",t.string),e.set("showstringnumber",t.showStringNumber),e.set("octave",t.octave),e.set("tone",t.tone),e.set("percussionarticulation",t.percussionArticulation),e.set("isvisible",t.isVisible),e.set("islefthandtapped",t.isLeftHandTapped),e.set("ishammerpullorigin",t.isHammerPullOrigin),e.set("isslurdestination",t.isSlurDestination),e.set("harmonictype",t.harmonicType),e.set("harmonicvalue",t.harmonicValue),e.set("isghost",t.isGhost),e.set("isletring",t.isLetRing),e.set("ispalmmute",t.isPalmMute),e.set("isdead",t.isDead),e.set("isstaccato",t.isStaccato),e.set("slideintype",t.slideInType),e.set("slideouttype",t.slideOutType),e.set("vibrato",t.vibrato),e.set("istiedestination",t.isTieDestination),e.set("lefthandfinger",t.leftHandFinger),e.set("righthandfinger",t.rightHandFinger),e.set("trillvalue",t.trillValue),e.set("trillspeed",t.trillSpeed),e.set("durationpercent",t.durationPercent),e.set("accidentalmode",t.accidentalMode),e.set("dynamics",t.dynamics),e.set("ornament",t.ornament),t.style&&e.set("style",Or.toJson(t.style)),t.toJson(e),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"accentuated":return t.accentuated=T.parseEnum(s,et),!0;case"bendtype":return t.bendType=T.parseEnum(s,z),!0;case"bendstyle":return t.bendStyle=T.parseEnum(s,Ie),!0;case"iscontinuedbend":return t.isContinuedBend=s,!0;case"bendpoints":if(s){t.bendPoints=[];for(const i of s){const a=new R;Ri.fromJson(a,i),t.addBendPoint(a)}}return!0;case"fret":return t.fret=s,!0;case"string":return t.string=s,!0;case"showstringnumber":return t.showStringNumber=s,!0;case"octave":return t.octave=s,!0;case"tone":return t.tone=s,!0;case"percussionarticulation":return t.percussionArticulation=s,!0;case"isvisible":return t.isVisible=s,!0;case"islefthandtapped":return t.isLeftHandTapped=s,!0;case"ishammerpullorigin":return t.isHammerPullOrigin=s,!0;case"isslurdestination":return t.isSlurDestination=s,!0;case"harmonictype":return t.harmonicType=T.parseEnum(s,Z),!0;case"harmonicvalue":return t.harmonicValue=s,!0;case"isghost":return t.isGhost=s,!0;case"isletring":return t.isLetRing=s,!0;case"ispalmmute":return t.isPalmMute=s,!0;case"isdead":return t.isDead=s,!0;case"isstaccato":return t.isStaccato=s,!0;case"slideintype":return t.slideInType=T.parseEnum(s,ut),!0;case"slideouttype":return t.slideOutType=T.parseEnum(s,ce),!0;case"vibrato":return t.vibrato=T.parseEnum(s,ke),!0;case"istiedestination":return t.isTieDestination=s,!0;case"lefthandfinger":return t.leftHandFinger=T.parseEnum(s,Q),!0;case"righthandfinger":return t.rightHandFinger=T.parseEnum(s,Q),!0;case"trillvalue":return t.trillValue=s,!0;case"trillspeed":return t.trillSpeed=T.parseEnum(s,m),!0;case"durationpercent":return t.durationPercent=s,!0;case"accidentalmode":return t.accidentalMode=T.parseEnum(s,ge),!0;case"dynamics":return t.dynamics=T.parseEnum(s,J),!0;case"ornament":return t.ornament=T.parseEnum(s,tt),!0;case"style":return s?(t.style=new Ta,Or.fromJson(t.style,s)):t.style=void 0,!0}return t.setProperty(e,s)}}class Wr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Wr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[i,a]of t.colors)s.set(i.toString(),Ee.toJson(a))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,T.forEach(s,(i,a)=>{t.colors.set(T.parseEnum(a,Ae),Ee.fromJson(i))}),!0)}}class Vr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Vr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("notes",t.notes.map(s=>Hr.toJson(s))),e.set("isempty",t.isEmpty),e.set("whammystyle",t.whammyStyle),e.set("ottava",t.ottava),e.set("islegatoorigin",t.isLegatoOrigin),e.set("duration",t.duration),e.set("automations",t.automations.map(s=>si.toJson(s))),e.set("dots",t.dots),e.set("fade",t.fade),e.set("lyrics",t.lyrics),e.set("pop",t.pop),e.set("slap",t.slap),e.set("tap",t.tap),e.set("text",t.text),e.set("slashed",t.slashed),e.set("deadslapped",t.deadSlapped),e.set("brushtype",t.brushType),e.set("brushduration",t.brushDuration),e.set("tupletdenominator",t.tupletDenominator),e.set("tupletnumerator",t.tupletNumerator),e.set("iscontinuedwhammy",t.isContinuedWhammy),e.set("whammybartype",t.whammyBarType),null!==t.whammyBarPoints&&e.set("whammybarpoints",t.whammyBarPoints?.map(s=>Ri.toJson(s))),e.set("vibrato",t.vibrato),e.set("chordid",t.chordId),e.set("gracetype",t.graceType),e.set("pickstroke",t.pickStroke),e.set("tremolospeed",t.tremoloSpeed),e.set("crescendo",t.crescendo),e.set("displaystart",t.displayStart),e.set("playbackstart",t.playbackStart),e.set("displayduration",t.displayDuration),e.set("playbackduration",t.playbackDuration),e.set("overridedisplayduration",t.overrideDisplayDuration),e.set("golpe",t.golpe),e.set("dynamics",t.dynamics),e.set("invertbeamdirection",t.invertBeamDirection),e.set("preferredbeamdirection",t.preferredBeamDirection),e.set("beamingmode",t.beamingMode),e.set("wahpedal",t.wahPedal),e.set("barrefret",t.barreFret),e.set("barreshape",t.barreShape),e.set("rasgueado",t.rasgueado),e.set("showtimer",t.showTimer),e.set("timer",t.timer),t.style&&e.set("style",Wr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"notes":t.notes=[];for(const i of s){const a=new ts;Hr.fromJson(a,i),t.addNote(a)}return!0;case"isempty":return t.isEmpty=s,!0;case"whammystyle":return t.whammyStyle=T.parseEnum(s,Ie),!0;case"ottava":return t.ottava=T.parseEnum(s,le),!0;case"islegatoorigin":return t.isLegatoOrigin=s,!0;case"duration":return t.duration=T.parseEnum(s,m),!0;case"automations":t.automations=[];for(const i of s){const a=new Qe;si.fromJson(a,i),t.automations.push(a)}return!0;case"dots":return t.dots=s,!0;case"fade":return t.fade=T.parseEnum(s,ct),!0;case"lyrics":return t.lyrics=s,!0;case"pop":return t.pop=s,!0;case"slap":return t.slap=s,!0;case"tap":return t.tap=s,!0;case"text":return t.text=s,!0;case"slashed":return t.slashed=s,!0;case"deadslapped":return t.deadSlapped=s,!0;case"brushtype":return t.brushType=T.parseEnum(s,V),!0;case"brushduration":return t.brushDuration=s,!0;case"tupletdenominator":return t.tupletDenominator=s,!0;case"tupletnumerator":return t.tupletNumerator=s,!0;case"iscontinuedwhammy":return t.isContinuedWhammy=s,!0;case"whammybartype":return t.whammyBarType=T.parseEnum(s,_e),!0;case"whammybarpoints":if(s){t.whammyBarPoints=[];for(const i of s){const a=new R;Ri.fromJson(a,i),t.addWhammyBarPoint(a)}}return!0;case"vibrato":return t.vibrato=T.parseEnum(s,ke),!0;case"chordid":return t.chordId=s,!0;case"gracetype":return t.graceType=T.parseEnum(s,K),!0;case"pickstroke":return t.pickStroke=T.parseEnum(s,yt),!0;case"tremolospeed":return t.tremoloSpeed=T.parseEnum(s,m)??null,!0;case"crescendo":return t.crescendo=T.parseEnum(s,Ft),!0;case"displaystart":return t.displayStart=s,!0;case"playbackstart":return t.playbackStart=s,!0;case"displayduration":return t.displayDuration=s,!0;case"playbackduration":return t.playbackDuration=s,!0;case"overridedisplayduration":return t.overrideDisplayDuration=s,!0;case"golpe":return t.golpe=T.parseEnum(s,Gt),!0;case"dynamics":return t.dynamics=T.parseEnum(s,J),!0;case"invertbeamdirection":return t.invertBeamDirection=s,!0;case"preferredbeamdirection":return t.preferredBeamDirection=T.parseEnum(s,P)??null,!0;case"beamingmode":return t.beamingMode=T.parseEnum(s,ze),!0;case"wahpedal":return t.wahPedal=T.parseEnum(s,Jt),!0;case"barrefret":return t.barreFret=s,!0;case"barreshape":return t.barreShape=T.parseEnum(s,qt),!0;case"rasgueado":return t.rasgueado=T.parseEnum(s,G),!0;case"showtimer":return t.showTimer=s,!0;case"timer":return t.timer=s,!0;case"style":return s?(t.style=new zn,Wr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Gr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Gr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[i,a]of t.colors)s.set(i.toString(),Ee.toJson(a))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,T.forEach(s,(i,a)=>{t.colors.set(T.parseEnum(a,qi),Ee.fromJson(i))}),!0)}}class zr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>zr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("beats",t.beats.map(s=>Vr.toJson(s))),t.style&&e.set("style",Gr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"beats":t.beats=[];for(const i of s){const a=new xt;Vr.fromJson(a,i),t.addBeat(a)}return!0;case"style":return s?(t.style=new Hn,Gr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Ur{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Ur.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("ratioposition",t.ratioPosition),e.set("pedaltype",t.pedalType),e}static setProperty(t,e,s){switch(e){case"ratioposition":return t.ratioPosition=s,!0;case"pedaltype":return t.pedalType=T.parseEnum(s,rt),!0}return!1}}class Yr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Yr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[i,a]of t.colors)s.set(i.toString(),Ee.toJson(a))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,T.forEach(s,(i,a)=>{t.colors.set(T.parseEnum(a,Be),Ee.fromJson(i))}),!0)}}class Xr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Xr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("id",t.id),e.set("clef",t.clef),e.set("clefottava",t.clefOttava),e.set("voices",t.voices.map(s=>zr.toJson(s))),e.set("similemark",t.simileMark),e.set("displayscale",t.displayScale),e.set("displaywidth",t.displayWidth),e.set("sustainpedals",t.sustainPedals.map(s=>Ur.toJson(s))),e.set("barlineleft",t.barLineLeft),e.set("barlineright",t.barLineRight),e.set("keysignature",t.keySignature),e.set("keysignaturetype",t.keySignatureType),t.style&&e.set("style",Yr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"id":return t.id=s,!0;case"clef":return t.clef=T.parseEnum(s,Se),!0;case"clefottava":return t.clefOttava=T.parseEnum(s,le),!0;case"voices":t.voices=[];for(const i of s){const a=new es;zr.fromJson(a,i),t.addVoice(a)}return!0;case"similemark":return t.simileMark=T.parseEnum(s,je),!0;case"displayscale":return t.displayScale=s,!0;case"displaywidth":return t.displayWidth=s,!0;case"sustainpedals":t.sustainPedals=[];for(const i of s){const a=new Ks;Ur.fromJson(a,i),t.sustainPedals.push(a)}return!0;case"barlineleft":return t.barLineLeft=T.parseEnum(s,te),!0;case"barlineright":return t.barLineRight=T.parseEnum(s,te),!0;case"keysignature":return t.keySignature=T.parseEnum(s,ye),!0;case"keysignaturetype":return t.keySignatureType=T.parseEnum(s,It),!0;case"style":return s?(t.style=new On,Yr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class Jr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Jr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("name",t.name),e.set("firstfret",t.firstFret),e.set("strings",t.strings),e.set("barrefrets",t.barreFrets),e.set("showname",t.showName),e.set("showdiagram",t.showDiagram),e.set("showfingering",t.showFingering),e}static setProperty(t,e,s){switch(e){case"name":return t.name=s,!0;case"firstfret":return t.firstFret=s,!0;case"strings":return t.strings=s,!0;case"barrefrets":return t.barreFrets=s,!0;case"showname":return t.showName=s,!0;case"showdiagram":return t.showDiagram=s,!0;case"showfingering":return t.showFingering=s,!0}return!1}}class qr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>qr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("isstandard",t.isStandard),e.set("name",t.name),e.set("tunings",t.tunings),e}static setProperty(t,e,s){switch(e){case"isstandard":return t.isStandard=s,!0;case"name":return t.name=s,!0;case"tunings":return t.tunings=s,!0}return!1}}class $r{static fromJson(t,e){e&&T.forEach(e,(s,i)=>$r.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("bars",t.bars.map(s=>Xr.toJson(s))),null!==t.chords){const s=new Map;e.set("chords",s);for(const[i,a]of t.chords)s.set(i.toString(),Jr.toJson(a))}return e.set("capo",t.capo),e.set("transpositionpitch",t.transpositionPitch),e.set("displaytranspositionpitch",t.displayTranspositionPitch),e.set("stringtuning",qr.toJson(t.stringTuning)),e.set("showslash",t.showSlash),e.set("shownumbered",t.showNumbered),e.set("showtablature",t.showTablature),e.set("showstandardnotation",t.showStandardNotation),e.set("ispercussion",t.isPercussion),e.set("standardnotationlinecount",t.standardNotationLineCount),e}static setProperty(t,e,s){switch(e){case"bars":t.bars=[];for(const i of s){const a=new Ts;Xr.fromJson(a,i),t.addBar(a)}return!0;case"chords":return t.chords=new Map,T.forEach(s,(i,a)=>{const n=new Os;Jr.fromJson(n,i),t.addChord(a,n)}),!0;case"capo":return t.capo=s,!0;case"transpositionpitch":return t.transpositionPitch=s,!0;case"displaytranspositionpitch":return t.displayTranspositionPitch=s,!0;case"stringtuning":return qr.fromJson(t.stringTuning,s),!0;case"showslash":return t.showSlash=s,!0;case"shownumbered":return t.showNumbered=s,!0;case"showtablature":return t.showTablature=s,!0;case"showstandardnotation":return t.showStandardNotation=s,!0;case"ispercussion":return t.isPercussion=s,!0;case"standardnotationlinecount":return t.standardNotationLineCount=s,!0}return!1}}class Qr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Qr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("volume",t.volume),e.set("balance",t.balance),e.set("port",t.port),e.set("program",t.program),e.set("primarychannel",t.primaryChannel),e.set("secondarychannel",t.secondaryChannel),e.set("ismute",t.isMute),e.set("issolo",t.isSolo),e}static setProperty(t,e,s){switch(e){case"volume":return t.volume=s,!0;case"balance":return t.balance=s,!0;case"port":return t.port=s,!0;case"program":return t.program=s,!0;case"primarychannel":return t.primaryChannel=s,!0;case"secondarychannel":return t.secondaryChannel=s,!0;case"ismute":return t.isMute=s,!0;case"issolo":return t.isSolo=s,!0}return!1}}class Kr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Kr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("elementtype",t.elementType),e.set("staffline",t.staffLine),e.set("noteheaddefault",t.noteHeadDefault),e.set("noteheadhalf",t.noteHeadHalf),e.set("noteheadwhole",t.noteHeadWhole),e.set("techniquesymbol",t.techniqueSymbol),e.set("techniquesymbolplacement",t.techniqueSymbolPlacement),e.set("outputmidinumber",t.outputMidiNumber),e}static setProperty(t,e,s){switch(e){case"elementtype":return t.elementType=s,!0;case"staffline":return t.staffLine=s,!0;case"noteheaddefault":return t.noteHeadDefault=T.parseEnum(s,l),!0;case"noteheadhalf":return t.noteHeadHalf=T.parseEnum(s,l),!0;case"noteheadwhole":return t.noteHeadWhole=T.parseEnum(s,l),!0;case"techniquesymbol":return t.techniqueSymbol=T.parseEnum(s,l),!0;case"techniquesymbolplacement":return t.techniqueSymbolPlacement=T.parseEnum(s,re),!0;case"outputmidinumber":return t.outputMidiNumber=s,!0}return!1}}class Zr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>Zr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("colors",s);for(const[i,a]of t.colors)s.set(i.toString(),Ee.toJson(a))}return e}static setProperty(t,e,s){return"colors"===e&&(t.colors=new Map,T.forEach(s,(i,a)=>{t.colors.set(T.parseEnum(a,Ds),Ee.fromJson(i))}),!0)}}class jr{static fromJson(t,e){e&&T.forEach(e,(s,i)=>jr.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("staves",t.staves.map(s=>$r.toJson(s))),e.set("playbackinfo",Qr.toJson(t.playbackInfo)),e.set("color",Ee.toJson(t.color)),e.set("name",t.name),e.set("isvisibleonmultitrack",t.isVisibleOnMultiTrack),e.set("shortname",t.shortName),e.set("defaultsystemslayout",t.defaultSystemsLayout),e.set("systemslayout",t.systemsLayout),void 0!==t.lineBreaks){const s=[];e.set("linebreaks",s);for(const i of t.lineBreaks)s.push(i)}return e.set("percussionarticulations",t.percussionArticulations.map(s=>Kr.toJson(s))),t.style&&e.set("style",Zr.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"staves":t.staves=[];for(const i of s){const a=new xr;$r.fromJson(a,i),t.addStaff(a)}return!0;case"playbackinfo":return Qr.fromJson(t.playbackInfo,s),!0;case"color":return t.color=Ee.fromJson(s),!0;case"name":return t.name=s,!0;case"isvisibleonmultitrack":return t.isVisibleOnMultiTrack=s,!0;case"shortname":return t.shortName=s,!0;case"defaultsystemslayout":return t.defaultSystemsLayout=s,!0;case"systemslayout":return t.systemsLayout=s,!0;case"linebreaks":for(const i of s)t.addLineBreaks(i);return!0;case"percussionarticulations":t.percussionArticulations=[];for(const i of s){const a=new W;Kr.fromJson(a,i),t.percussionArticulations.push(a)}return!0;case"style":return s?(t.style=new Un,Zr.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class ea{static fromJson(t,e){e&&T.forEach(e,(s,i)=>ea.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;if(e.set("hidedynamics",t.hideDynamics),e.set("bracketextendmode",t.bracketExtendMode),e.set("usesystemsignseparator",t.useSystemSignSeparator),e.set("globaldisplaytuning",t.globalDisplayTuning),null!==t.perTrackDisplayTuning){const s=new Map;e.set("pertrackdisplaytuning",s);for(const[i,a]of t.perTrackDisplayTuning)s.set(i.toString(),a)}if(e.set("globaldisplaychorddiagramsontop",t.globalDisplayChordDiagramsOnTop),null!==t.perTrackChordDiagramsOnTop){const s=new Map;e.set("pertrackchorddiagramsontop",s);for(const[i,a]of t.perTrackChordDiagramsOnTop)s.set(i.toString(),a)}if(e.set("singletracktracknamepolicy",t.singleTrackTrackNamePolicy),e.set("multitracktracknamepolicy",t.multiTrackTrackNamePolicy),e.set("firstsystemtracknamemode",t.firstSystemTrackNameMode),e.set("othersystemstracknamemode",t.otherSystemsTrackNameMode),e.set("firstsystemtracknameorientation",t.firstSystemTrackNameOrientation),e.set("othersystemstracknameorientation",t.otherSystemsTrackNameOrientation),e.set("multitrackmultibarrest",t.multiTrackMultiBarRest),null!==t.perTrackMultiBarRest){const s=[];e.set("pertrackmultibarrest",s);for(const i of t.perTrackMultiBarRest)s.push(i)}return e}static setProperty(t,e,s){switch(e){case"hidedynamics":return t.hideDynamics=s,!0;case"bracketextendmode":return t.bracketExtendMode=T.parseEnum(s,Vt),!0;case"usesystemsignseparator":return t.useSystemSignSeparator=s,!0;case"globaldisplaytuning":return t.globalDisplayTuning=s,!0;case"pertrackdisplaytuning":return t.perTrackDisplayTuning=new Map,T.forEach(s,(i,a)=>{t.perTrackDisplayTuning.set(Number.parseInt(a),i)}),!0;case"globaldisplaychorddiagramsontop":return t.globalDisplayChordDiagramsOnTop=s,!0;case"pertrackchorddiagramsontop":return t.perTrackChordDiagramsOnTop=new Map,T.forEach(s,(i,a)=>{t.perTrackChordDiagramsOnTop.set(Number.parseInt(a),i)}),!0;case"singletracktracknamepolicy":return t.singleTrackTrackNamePolicy=T.parseEnum(s,Oe),!0;case"multitracktracknamepolicy":return t.multiTrackTrackNamePolicy=T.parseEnum(s,Oe),!0;case"firstsystemtracknamemode":return t.firstSystemTrackNameMode=T.parseEnum(s,nt),!0;case"othersystemstracknamemode":return t.otherSystemsTrackNameMode=T.parseEnum(s,nt),!0;case"firstsystemtracknameorientation":return t.firstSystemTrackNameOrientation=T.parseEnum(s,ot),!0;case"othersystemstracknameorientation":return t.otherSystemsTrackNameOrientation=T.parseEnum(s,ot),!0;case"multitrackmultibarrest":return t.multiTrackMultiBarRest=s,!0;case"pertrackmultibarrest":return t.perTrackMultiBarRest=new Set(s),!0}return!1}}class ta{static fromJson(t,e){e&&T.forEach(e,(s,i)=>ta.setProperty(t,i,s))}static toJson(t){return t?new Map:null}static setProperty(t,e,s){return!1}}class sa{static fromJson(t,e){e&&T.forEach(e,(s,i)=>sa.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("template",t.template),e.set("isvisible",t.isVisible),e.set("textalign",t.textAlign),e}static setProperty(t,e,s){switch(e){case"template":return t.template=s,!0;case"isvisible":return t.isVisible=s,!0;case"textalign":return t.textAlign=T.parseEnum(s,U),!0}return!1}}class ia{static fromJson(t,e){e&&T.forEach(e,(s,i)=>ia.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;{const s=new Map;e.set("headerandfooter",s);for(const[i,a]of t.headerAndFooter)s.set(i.toString(),sa.toJson(a))}{const s=new Map;e.set("colors",s);for(const[i,a]of t.colors)s.set(i.toString(),Ee.toJson(a))}return e}static setProperty(t,e,s){switch(e){case"headerandfooter":return t.headerAndFooter=new Map,T.forEach(s,(i,a)=>{const n=new is;sa.fromJson(n,i),t.headerAndFooter.set(T.parseEnum(a,H),n)}),!0;case"colors":return t.colors=new Map,T.forEach(s,(i,a)=>{t.colors.set(T.parseEnum(a,H),Ee.fromJson(i))}),!0}return!1}}class ra{static fromJson(t,e){e&&T.forEach(e,(s,i)=>ra.setProperty(t,i,s))}static toJson(t){if(!t)return null;const e=new Map;return e.set("album",t.album),e.set("artist",t.artist),e.set("copyright",t.copyright),e.set("instructions",t.instructions),e.set("music",t.music),e.set("notices",t.notices),e.set("subtitle",t.subTitle),e.set("title",t.title),e.set("words",t.words),e.set("tab",t.tab),e.set("tempo",t.tempo),e.set("tempolabel",t.tempoLabel),e.set("masterbars",t.masterBars.map(s=>Rr.toJson(s))),e.set("tracks",t.tracks.map(s=>jr.toJson(s))),e.set("defaultsystemslayout",t.defaultSystemsLayout),e.set("systemslayout",t.systemsLayout),e.set("stylesheet",ea.toJson(t.stylesheet)),t.backingTrack&&e.set("backingtrack",ta.toJson(t.backingTrack)),t.style&&e.set("style",ia.toJson(t.style)),e}static setProperty(t,e,s){switch(e){case"album":return t.album=s,!0;case"artist":return t.artist=s,!0;case"copyright":return t.copyright=s,!0;case"instructions":return t.instructions=s,!0;case"music":return t.music=s,!0;case"notices":return t.notices=s,!0;case"subtitle":return t.subTitle=s,!0;case"title":return t.title=s,!0;case"words":return t.words=s,!0;case"tab":return t.tab=s,!0;case"tempo":return t.tempo=s,!0;case"tempolabel":return t.tempoLabel=s,!0;case"masterbars":t.masterBars=[];for(const i of s){const a=new Ps;Rr.fromJson(a,i),t.addMasterBar(a)}return!0;case"tracks":t.tracks=[];for(const i of s){const a=new gi;jr.fromJson(a,i),t.addTrack(a)}return!0;case"defaultsystemslayout":return t.defaultSystemsLayout=s,!0;case"systemslayout":return t.systemsLayout=s,!0;case"stylesheet":return ea.fromJson(t.stylesheet,s),!0;case"backingtrack":return s?(t.backingTrack=new Ca,ta.fromJson(t.backingTrack,s)):t.backingTrack=void 0,!0;case"style":return s?(t.style=new fi,ia.fromJson(t.style,s)):t.style=void 0,!0}return!1}}class at{static jsonReplacer(t,e){if(e instanceof Map){if("fromEntries"in Object)return Object.fromEntries(e);const s={};for(const[i,a]of e)s[i]=a;return s}return ArrayBuffer.isView(e)?Array.apply([],[e]):e}static scoreToJson(t){const e=at.scoreToJsObject(t);return JSON.stringify(e,at.jsonReplacer)}static jsonToScore(t,e){return at.jsObjectToScore(JSON.parse(t),e)}static scoreToJsObject(t){return ra.toJson(t)}static jsObjectToScore(t,e){const s=new Cs;return ra.fromJson(s,t),s.finish(e??new Gs),s}static settingsToJson(t){const e=at.settingsToJsObject(t);return JSON.stringify(e,at.jsonReplacer)}static jsonToSettings(t){return at.jsObjectToSettings(JSON.parse(t))}static settingsToJsObject(t){return ti.toJson(t)}static jsObjectToSettings(t){const e=new Gs;return ti.fromJson(e,t),e}static jsObjectToMidiFile(t){const e=new Ls;return T.forEach(t,(s,i)=>{switch(i){case"division":e.division=s;break;case"tracks":for(const a of s){const n=at.jsObjectToMidiTrack(a);e.tracks.push(n)}}}),e}static jsObjectToMidiTrack(t){const e=new Aa;return T.forEach(t,(s,i)=>{if("events"===i)for(const a of s){const n=at.jsObjectToMidiEvent(a);e.events.push(n)}}),e}static jsObjectToMidiEvent(t){const e=T.getValue(t,"track"),s=T.getValue(t,"tick"),i=T.getValue(t,"type");switch(i){case xe.TimeSignature:return new Ma(e,s,T.getValue(t,"numerator"),T.getValue(t,"denominatorIndex"),T.getValue(t,"midiClocksPerMetronomeClick"),T.getValue(t,"thirdySecondNodesInQuarter"));case xe.AlphaTabRest:return new Oa(e,s,T.getValue(t,"channel"));case xe.AlphaTabMetronome:return new Ra(e,s,T.getValue(t,"metronomeNumerator"),T.getValue(t,"metronomeDurationInTicks"),T.getValue(t,"metronomeDurationInMilliseconds"));case xe.NoteOn:return new Wa(e,s,T.getValue(t,"channel"),T.getValue(t,"noteKey"),T.getValue(t,"noteVelocity"));case xe.NoteOff:return new Va(e,s,T.getValue(t,"channel"),T.getValue(t,"noteKey"),T.getValue(t,"noteVelocity"));case xe.ControlChange:return new Ga(e,s,T.getValue(t,"channel"),T.getValue(t,"controller"),T.getValue(t,"value"));case xe.ProgramChange:return new za(e,s,T.getValue(t,"channel"),T.getValue(t,"program"));case xe.TempoChange:const a=new Ua(s,0);return a.beatsPerMinute=T.getValue(t,"beatsPerMinute"),a;case xe.PitchBend:return new Ya(e,s,T.getValue(t,"channel"),T.getValue(t,"value"));case xe.PerNotePitchBend:return new Xa(e,s,T.getValue(t,"channel"),T.getValue(t,"noteKey"),T.getValue(t,"value"));case xe.EndOfTrack:return new Ja(e,s)}throw new Le(Fe.Format,`Unknown Midi Event type: ${i}`)}static midiFileToJsObject(t){const e=new Map;e.set("division",t.division);const s=[];for(const i of t.tracks)s.push(at.midiTrackToJsObject(i));return e.set("tracks",s),e}static midiTrackToJsObject(t){const e=new Map,s=[];for(const i of t.events)s.push(at.midiEventToJsObject(i));return e.set("events",s),e}static midiEventToJsObject(t){const e=new Map;switch(e.set("track",t.track),e.set("tick",t.tick),e.set("type",t.type),t.type){case xe.TimeSignature:e.set("numerator",t.numerator),e.set("denominatorIndex",t.denominatorIndex),e.set("midiClocksPerMetronomeClick",t.midiClocksPerMetronomeClick),e.set("thirdySecondNodesInQuarter",t.thirtySecondNodesInQuarter);break;case xe.AlphaTabRest:e.set("channel",t.channel);break;case xe.AlphaTabMetronome:e.set("metronomeNumerator",t.metronomeNumerator),e.set("metronomeDurationInMilliseconds",t.metronomeDurationInMilliseconds),e.set("metronomeDurationInTicks",t.metronomeDurationInTicks);break;case xe.NoteOn:case xe.NoteOff:e.set("channel",t.channel),e.set("noteKey",t.noteKey),e.set("noteVelocity",t.noteVelocity);break;case xe.ControlChange:e.set("channel",t.channel),e.set("controller",t.controller),e.set("value",t.value);break;case xe.ProgramChange:e.set("channel",t.channel),e.set("program",t.program);break;case xe.TempoChange:e.set("beatsPerMinute",t.beatsPerMinute);break;case xe.PitchBend:e.set("channel",t.channel),e.set("value",t.value);break;case xe.PerNotePitchBend:e.set("channel",t.channel),e.set("noteKey",t.noteKey),e.set("value",t.value)}return e}}class Je{constructor(){this.ready=new it,this.samplesPlayed=new pe,this.sampleRequest=new it}get sampleRate(){return Je.preferredSampleRate}open(){x.debug("AlphaSynth","Initializing synth worker"),this._worker=_.globalThis,this._worker.addEventListener("message",this.handleMessage.bind(this)),this.ready.trigger()}destroy(){this._worker.postMessage({cmd:"alphaSynth.output.destroy"})}handleMessage(t){const e=t.data;switch(e.cmd){case Je.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case Je.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(e.samples)}}addSamples(t){this._worker.postMessage({cmd:"alphaSynth.output.addSamples",samples:_.prepareForPostMessage(t)})}play(){this._worker.postMessage({cmd:"alphaSynth.output.play"})}pause(){this._worker.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this._worker.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}enumerateOutputDevices(){return(0,dt.A)(function*(){return[]})()}setOutputDevice(t){return(0,dt.A)(function*(){})()}getOutputDevice(){return(0,dt.A)(function*(){return null})()}}Je.CmdOutputPrefix="alphaSynth.output.",Je.CmdOutputAddSamples=`${Je.CmdOutputPrefix}addSamples`,Je.CmdOutputPlay=`${Je.CmdOutputPrefix}play`,Je.CmdOutputPause=`${Je.CmdOutputPrefix}pause`,Je.CmdOutputResetSamples=`${Je.CmdOutputPrefix}resetSamples`,Je.CmdOutputStop=`${Je.CmdOutputPrefix}stop`,Je.CmdOutputSampleRequest=`${Je.CmdOutputPrefix}sampleRequest`,Je.CmdOutputSamplesPlayed=`${Je.CmdOutputPrefix}samplesPlayed`,Je.preferredSampleRate=0;class en{constructor(t,e){this._exporter=new Map,this._main=t,this._main.addEventListener("message",this.handleMessage.bind(this)),this._player=new po(new Je,e),this._player.positionChanged.on(this.onPositionChanged.bind(this)),this._player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this._player.finished.on(this.onFinished.bind(this)),this._player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.midiLoaded.on(this.onMidiLoaded.bind(this)),this._player.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this._player.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this._player.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this._player.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this._main.postMessage({cmd:"alphaSynth.ready"})}static init(){const t=_.globalThis;t.addEventListener("message",e=>{const s=e.data;"alphaSynth.initialize"===s.cmd&&(Je.preferredSampleRate=s.sampleRate,x.logLevel=s.logLevel,_.globalThis.alphaSynthWebWorker=new en(t,s.bufferTimeInMilliseconds))})}handleMessage(t){const e=t.data,s=e.cmd;switch(s){case"alphaSynth.setLogLevel":x.logLevel=e.value;break;case"alphaSynth.setMasterVolume":this._player.masterVolume=e.value;break;case"alphaSynth.setMetronomeVolume":this._player.metronomeVolume=e.value;break;case"alphaSynth.setPlaybackSpeed":this._player.playbackSpeed=e.value;break;case"alphaSynth.setTickPosition":this._player.tickPosition=e.value;break;case"alphaSynth.setTimePosition":this._player.timePosition=e.value;break;case"alphaSynth.setPlaybackRange":this._player.playbackRange=e.value;break;case"alphaSynth.setIsLooping":this._player.isLooping=e.value;break;case"alphaSynth.setCountInVolume":this._player.countInVolume=e.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this._player.midiEventsPlayedFilter=e.value;break;case"alphaSynth.play":this._player.play();break;case"alphaSynth.pause":this._player.pause();break;case"alphaSynth.playPause":this._player.playPause();break;case"alphaSynth.stop":this._player.stop();break;case"alphaSynth.playOneTimeMidiFile":this._player.playOneTimeMidiFile(at.jsObjectToMidiFile(e.midi));break;case"alphaSynth.loadSoundFontBytes":this._player.loadSoundFont(e.data,e.append);break;case"alphaSynth.resetSoundFonts":this._player.resetSoundFonts();break;case"alphaSynth.loadMidi":this._player.loadMidiFile(at.jsObjectToMidiFile(e.midi));break;case"alphaSynth.setChannelMute":this._player.setChannelMute(e.channel,e.mute);break;case"alphaSynth.setChannelTranspositionPitch":this._player.setChannelTranspositionPitch(e.channel,e.semitones);break;case"alphaSynth.setChannelSolo":this._player.setChannelSolo(e.channel,e.solo);break;case"alphaSynth.setChannelVolume":this._player.setChannelVolume(e.channel,e.volume);break;case"alphaSynth.resetChannelStates":this._player.resetChannelStates();break;case"alphaSynth.destroy":this._player.destroy(),this._main.postMessage({cmd:"alphaSynth.destroyed"});break;case"alphaSynth.applyTranspositionPitches":this._player.applyTranspositionPitches(new Map(JSON.parse(e.transpositionPitches)))}s.startsWith("alphaSynth.exporter")&&this.handleExporterMessage(t)}handleExporterMessage(t){const e=t.data,s=e.cmd;try{switch(s){case"alphaSynth.exporter.initialize":const i=this._player.exportAudio(e.options,at.jsObjectToMidiFile(e.midi),e.syncPoints,e.transpositionPitches);this._exporter.set(e.exporterId,i),this._main.postMessage({cmd:"alphaSynth.exporter.initialized",exporterId:e.exporterId});break;case"alphaSynth.exporter.render":if(this._exporter.has(e.exporterId)){const n=this._exporter.get(e.exporterId).render(e.milliseconds);this._main.postMessage({cmd:"alphaSynth.exporter.rendered",exporterId:e.exporterId,chunk:n})}else this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:e.exporterId,error:new Error("Unknown exporter ID")});break;case"alphaSynth.exporter.destroy":this._exporter.delete(e.exporterId)}}catch(i){this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:e.exporterId,error:i})}}onPositionChanged(t){this._main.postMessage({cmd:"alphaSynth.positionChanged",currentTime:t.currentTime,endTime:t.endTime,currentTick:t.currentTick,endTick:t.endTick,isSeek:t.isSeek,originalTempo:t.originalTempo,modifiedTempo:t.modifiedTempo})}onPlayerStateChanged(t){this._main.postMessage({cmd:"alphaSynth.playerStateChanged",state:t.state,stopped:t.stopped})}onFinished(){this._main.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this._main.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(t){this._main.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this.serializeException(_.prepareForPostMessage(t))})}serializeException(t){const e=JSON.parse(JSON.stringify(t));return t.message&&(e.message=t.message),t.stack&&(e.stack=t.stack),t.constructor&&t.constructor.name&&(e.type=t.constructor.name),e}onMidiLoaded(t){this._main.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:t.currentTime,endTime:t.endTime,currentTick:t.currentTick,endTick:t.endTick,isSeek:t.isSeek,originalTempo:t.originalTempo,modifiedTempo:t.modifiedTempo})}onMidiLoadFailed(t){this._main.postMessage({cmd:"alphaSynth.midiLoaded",error:this.serializeException(_.prepareForPostMessage(t))})}onReadyForPlayback(){this._main.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(t){this._main.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:t.events.map(at.midiEventToJsObject)})}onPlaybackRangeChanged(t){this._main.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:t.playbackRange})}}var ys=function(r){return r[r.Browser=0]="Browser",r[r.NodeJs=1]="NodeJs",r[r.BrowserModule=2]="BrowserModule",r}(ys||{});class tn{constructor(t,e){this.characterWidths=t,this.fontSizeToHeight=e}}class vt{static generateFontLookup(t){if(!vt.FontSizeLookupTables.has(t))if(_.isRunningInWorker||_.webPlatform===ys.NodeJs){const e=new tn(new Uint8Array([8]),1.2);vt.FontSizeLookupTables.set(t,e)}else{const s=document.createElement("canvas").getContext("2d"),i=11;s.font=`${i}px ${t}`;const a=[];let n="";for(let f=vt.ControlChars;f<255;f++){const p=String.fromCharCode(f);n+=p;const g=s.measureText(p);a.push(g.width)}const o=s.measureText(`${n}\xc4\xd6\xdc\xc1\xc8`),h=0-Math.abs(o.fontBoundingBoxAscent),d=0+Math.abs(o.fontBoundingBoxDescent)-h,u=new tn(new Uint8Array(a),d/i);vt.FontSizeLookupTables.set(t,u)}}static measureString(t,e,s,i,a){let n,h=e[0];for(let u=0;u<e.length;u++)if(vt.FontSizeLookupTables.has(e[u])){h=e[u];break}vt.FontSizeLookupTables.has(h)||vt.generateFontLookup(h),n=vt.FontSizeLookupTables.get(h);let c=1;i===Xe.Italic&&(c*=1.1),a===Ut.Bold&&(c*=1.1);let d=0;for(let u=0;u<t.length;u++){const f=Math.min(n.characterWidths.length-1,t.charCodeAt(u)-vt.ControlChars);f>=0&&(d+=n.characterWidths[f]*s/11)}return c*=1.07,new $i(d*c,s*n.fontSizeToHeight)}}vt.FontSizeLookupTables=new Map,vt.ControlChars=32;class zs{constructor(){this.id=O.newGuid(),this.x=0,this.y=0,this.width=0,this.height=0,this.totalWidth=0,this.totalHeight=0,this.firstMasterBarIndex=-1,this.lastMasterBarIndex=-1,this.renderResult=null}}class sn{constructor(){this.beats=[]}addBeat(t){t.barBounds=this,this.beats.push(t),this.masterBarBounds.addBeat(t)}findBeatAtPos(t){let e=null;for(const s of this.beats)if(!e||s.realBounds.x<t)e=s;else if(s.realBounds.x>t)break;return e}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.beats.sort((e,s)=>e.realBounds.x-s.realBounds.x);for(const e of this.beats)e.finish(t)}}class rn{constructor(){this.onNotesX=0,this.notes=null}addNote(t){this.notes||(this.notes=[]),t.beatBounds=this,this.notes.push(t)}findNoteAtPos(t,e){const s=this.notes;if(!s)return null;for(const i of s)if(i.noteHeadBounds.x<=t&&i.noteHeadBounds.y<=e&&t<=i.noteHeadBounds.x+i.noteHeadBounds.w&&e<=i.noteHeadBounds.y+i.noteHeadBounds.h)return i.note;return null}finish(t=1){if(this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.onNotesX*=t,this.notes)for(const e of this.notes)e.finish(t)}}class an{constructor(){this.index=0,this.isFirstOfLine=!1,this.bars=[],this.staffSystemBounds=null}get staveGroupBounds(){return this.staffSystemBounds}addBar(t){t.masterBarBounds=this,this.bars.push(t)}findBeatAtPos(t,e){let s=null;for(const a of this.bars){const n=a.findBeatAtPos(t);if(n&&(!s||s.realBounds.x<n.realBounds.x)){const o=Math.abs(n.realBounds.x-t);(!s||o<1e7)&&(s=n)}}return s?s.beat:null}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t),this.lineAlignedBounds.scaleWith(t),this.bars.sort((e,s)=>e.realBounds.y<s.realBounds.y?-1:e.realBounds.y>s.realBounds.y?1:e.realBounds.x<s.realBounds.x?-1:e.realBounds.x>s.realBounds.x?1:0);for(const e of this.bars)e.finish(t)}addBeat(t){this.staffSystemBounds.boundsLookup.addBeat(t)}}class Oi{finish(t=1){this.noteHeadBounds.scaleWith(t)}}class nn{constructor(){this.index=0,this.bars=[]}finish(t=1){this.realBounds.scaleWith(t),this.visualBounds.scaleWith(t);for(const e of this.bars)e.finish(t)}addBar(t){this.boundsLookup.addMasterBar(t),t.staffSystemBounds=this,this.bars.push(t)}findBarAtPos(t){let e=null;for(const s of this.bars)if(!e||s.realBounds.x<t)e=s;else if(t>s.realBounds.x+s.realBounds.w)break;return e}}class Yt{constructor(){this._beatLookup=new Map,this._masterBarLookup=new Map,this._currentStaffSystem=null,this.staffSystems=[],this.isFinished=!1}toJson(){const t={},e=[];t.staffSystems=e;for(const s of this.staffSystems){const i={};i.visualBounds=this.boundsToJson(s.visualBounds),i.realBounds=this.boundsToJson(s.realBounds),i.bars=[];for(const a of s.bars){const n={};n.lineAlignedBounds=this.boundsToJson(a.lineAlignedBounds),n.visualBounds=this.boundsToJson(a.visualBounds),n.realBounds=this.boundsToJson(a.realBounds),n.index=a.index,n.bars=[];for(const o of a.bars){const h={};h.visualBounds=this.boundsToJson(o.visualBounds),h.realBounds=this.boundsToJson(o.realBounds),h.beats=[];for(const c of o.beats){const d={};d.visualBounds=this.boundsToJson(c.visualBounds),d.realBounds=this.boundsToJson(c.realBounds),d.onNotesX=c.onNotesX;const u=d;if(u.beatIndex=c.beat.index,u.voiceIndex=c.beat.voice.index,u.barIndex=c.beat.voice.bar.index,u.staffIndex=c.beat.voice.bar.staff.index,u.trackIndex=c.beat.voice.bar.staff.track.index,c.notes){const f=[];d.notes=f;for(const p of c.notes){const g={};g.index=p.note.index,g.noteHeadBounds=this.boundsToJson(p.noteHeadBounds),f.push(g)}}h.beats.push(d)}n.bars.push(h)}i.bars.push(n)}e.push(i)}return t}static fromJson(t,e){const s=new Yt,i=t.staffSystems;for(const a of i){const n=new nn;n.visualBounds=Yt.boundsFromJson(a.visualBounds),n.realBounds=Yt.boundsFromJson(a.realBounds),s.addStaffSystem(n);for(const o of a.bars){const h=new an;h.index=o.index,h.isFirstOfLine=o.isFirstOfLine,h.lineAlignedBounds=Yt.boundsFromJson(o.lineAlignedBounds),h.visualBounds=Yt.boundsFromJson(o.visualBounds),h.realBounds=Yt.boundsFromJson(o.realBounds),n.addBar(h);for(const c of o.bars){const d=new sn;d.visualBounds=Yt.boundsFromJson(c.visualBounds),d.realBounds=Yt.boundsFromJson(c.realBounds),h.addBar(d);for(const u of c.beats){const f=new rn;if(f.visualBounds=Yt.boundsFromJson(u.visualBounds),f.realBounds=Yt.boundsFromJson(u.realBounds),f.onNotesX=u.onNotesX,f.beat=e.tracks[u.trackIndex].staves[u.staffIndex].bars[u.barIndex].voices[u.voiceIndex].beats[u.beatIndex],u.notes){f.notes=[];for(const g of u.notes){const b=new Oi;b.note=f.beat.notes[g.index],b.noteHeadBounds=Yt.boundsFromJson(g.noteHeadBounds),f.addNote(b)}}d.addBeat(f)}}}}return s}static boundsFromJson(t){const e=new St;return e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e}boundsToJson(t){const e={};return e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e}finish(t=1){for(const e of this.staffSystems)e.finish(t);this.isFinished=!0}addStaffSystem(t){t.index=this.staffSystems.length,t.boundsLookup=this,this.staffSystems.push(t),this._currentStaffSystem=t}addMasterBar(t){t.staffSystemBounds?this._masterBarLookup.set(t.index,t):(t.staffSystemBounds=this._currentStaffSystem,this._masterBarLookup.set(t.index,t),this._currentStaffSystem.addBar(t))}addBeat(t){this._beatLookup.has(t.beat.id)||this._beatLookup.set(t.beat.id,[]),this._beatLookup.get(t.beat.id)?.push(t)}findMasterBarByIndex(t){return this._masterBarLookup.has(t)?this._masterBarLookup.get(t):null}findMasterBar(t){const e=t.index;return this._masterBarLookup.has(e)?this._masterBarLookup.get(e):null}findBeat(t){const e=this.findBeats(t);return e?e[0]:null}findBeats(t){const e=t.id;return this._beatLookup.has(e)?this._beatLookup.get(e):null}getBeatAtPos(t,e){let s=0,i=this.staffSystems.length-1,a=-1;for(;s<=i;){const h=(i+s)/2|0,c=this.staffSystems[h];if(e>=c.realBounds.y&&e<=c.realBounds.y+c.realBounds.h){a=h;break}e<c.realBounds.y?i=h-1:s=h+1}if(-1===a)return null;const o=this.staffSystems[a].findBarAtPos(t);return o?o.findBeatAtPos(t,e):null}getNoteAtPos(t,e,s){const i=this.findBeats(t);if(i)for(const a of i){const n=a.findNoteAtPos(e,s);if(n)return n}return null}}class Hi{constructor(t){this._currentLayoutMode=cs.Page,this._currentRenderEngine=null,this._renderedTracks=null,this.canvas=null,this.score=null,this.tracks=null,this.layout=null,this.boundsLookup=null,this.width=0,this.preRender=new pe,this.renderFinished=new pe,this.partialRenderFinished=new pe,this.partialLayoutFinished=new pe,this.postRenderFinished=new it,this.error=new pe,this.settings=t,this.recreateCanvas(),this.recreateLayout()}destroy(){this.score=null,this.canvas?.destroy(),this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}recreateCanvas(){return this._currentRenderEngine!==this.settings.core.engine&&(this.canvas?.destroy(),this.canvas=_.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this._currentRenderEngine=this.settings.core.engine,!0)}recreateLayout(){return!(this.layout&&this._currentLayoutMode===this.settings.display.layoutMode||(this.layout=_.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this._currentLayoutMode=this.settings.display.layoutMode,0))}renderScore(t,e){try{this.score=t;let s=null;if(null!=t&&null!=e){if(e){s=[];for(const i of e)i>=0&&i<t.tracks.length&&s.push(t.tracks[i])}else s=t.tracks.slice(0);0===s.length&&t.tracks.length>0&&s.push(t.tracks[0])}this.tracks=s,this.render()}catch(s){this.error.trigger(s)}}renderTracks(t){this.score=0===t.length?null:t[0].score,this.tracks=t,this.render()}updateSettings(t){this.settings=t}renderResult(t){try{const e=this.layout;e?(x.debug("Rendering",`Request render of lazy partial ${t}`),e.renderLazyPartial(t)):x.warning("Rendering",`Request render of lazy partial ${t} ignored, no layout exists`)}catch(e){this.error.trigger(e)}}render(){if(0!==this.width)if(this.boundsLookup=new Yt,this.recreateCanvas(),this.canvas.lineWidth=1,this.canvas.settings=this.settings,this.tracks&&0!==this.tracks.length&&this.score){x.debug("Rendering",`Rendering ${this.tracks.length} tracks`);for(let t=0;t<this.tracks.length;t++)x.debug("Rendering",`Track ${t}: ${this.tracks[t].name}`);this.preRender.trigger(!1),this.recreateLayout(),this.layoutAndRender(),x.debug("Rendering","Rendering finished")}else x.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this._renderedTracks=null,this.onRenderFinished(),this.postRenderFinished.trigger(),x.debug("Rendering","Clearing finished");else x.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null)}resizeRender(){this.recreateLayout()||this.recreateCanvas()||this._renderedTracks!==this.tracks||!this.tracks?(x.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(x.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new Yt,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this.onRenderFinished(),this.postRenderFinished.trigger()):x.debug("Rendering","Current layout does not support dynamic resizing, nothing was done",null),x.debug("Rendering","Resize finished")}layoutAndRender(){x.debug("Rendering",`Rendering at scale ${this.settings.display.scale} with layout ${this.layout.name}`,null),this.layout.layoutAndRender(),this._renderedTracks=this.tracks,this.onRenderFinished(),this.postRenderFinished.trigger()}onRenderFinished(){this.boundsLookup?.finish(this.settings.display.scale);const t=new zs;t.totalHeight=this.layout.height,t.totalWidth=this.layout.width,t.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(t)}}class on{constructor(t){this._main=t,this._main.addEventListener("message",this.handleMessage.bind(this),!1)}static init(){_.globalThis.alphaTabWebWorker=new on(_.globalThis)}handleMessage(t){const e=t.data;switch(e?e.cmd:""){case"alphaTab.initialize":const i=at.jsObjectToSettings(e.settings);x.logLevel=i.core.logLevel,this._renderer=new Hi(i),this._renderer.partialRenderFinished.on(n=>{this._main.postMessage({cmd:"alphaTab.partialRenderFinished",result:n})}),this._renderer.partialLayoutFinished.on(n=>{this._main.postMessage({cmd:"alphaTab.partialLayoutFinished",result:n})}),this._renderer.renderFinished.on(n=>{this._main.postMessage({cmd:"alphaTab.renderFinished",result:n})}),this._renderer.postRenderFinished.on(()=>{this._main.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:this._renderer.boundsLookup?.toJson()??null})}),this._renderer.preRender.on(n=>{this._main.postMessage({cmd:"alphaTab.preRender",resize:n})}),this._renderer.error.on(this.error.bind(this));break;case"alphaTab.invalidate":this._renderer.render();break;case"alphaTab.resizeRender":this._renderer.resizeRender();break;case"alphaTab.renderResult":this._renderer.renderResult(e.resultId);break;case"alphaTab.setWidth":this._renderer.width=e.width;break;case"alphaTab.renderScore":this.updateFontSizes(e.fontSizes);const a=null==e.score?null:at.jsObjectToScore(e.score,this._renderer.settings);this.renderMultiple(a,e.trackIndexes);break;case"alphaTab.updateSettings":this.updateSettings(e.settings)}}updateFontSizes(t){if(!(t instanceof Map)){const e=t;t=new Map;for(const s in e)t.set(s,e[s])}if(t){vt.FontSizeLookupTables||(vt.FontSizeLookupTables=new Map);for(const[e,s]of t)vt.FontSizeLookupTables.set(e,s)}}updateSettings(t){ti.fromJson(this._renderer.settings,t)}renderMultiple(t,e){try{this._renderer.renderScore(t,e)}catch(s){this.error(s)}}error(t){x.error("Worker","An unexpected error occurred in worker",t),this._main.postMessage({cmd:"alphaTab.error",error:t})}}class dl{constructor(){this._canvas=null,this._color=new Ee(0,0,0,255),this._font=new de("Arial",10,Xe.Plain),this._lineWidth=0,this._measureCanvas=document.createElement("canvas"),this._measureCanvas.width=10,this._measureCanvas.height=10,this._measureCanvas.style.width="10px",this._measureCanvas.style.height="10px",this._measureContext=this._measureCanvas.getContext("2d"),this._measureContext.textBaseline="hanging"}destroy(){}onRenderFinished(){return null}beginRender(t,e){this._musicFont=this.settings.display.resources.smuflFont;const s=this.settings.display.scale;this._canvas=document.createElement("canvas"),this._canvas.width=t*_.HighDpiFactor|0,this._canvas.height=e*_.HighDpiFactor|0,this._canvas.style.width=`${t}px`,this._canvas.style.height=`${e}px`,this._context=this._canvas.getContext("2d"),this._context.textBaseline="hanging",this._context.scale(_.HighDpiFactor*s,_.HighDpiFactor*s),this._context.lineWidth=this._lineWidth}endRender(){const t=this._canvas;return this._canvas=null,t}get color(){return this._color}set color(t){this._color.rgba!==t.rgba&&(this._color=t,this._context.strokeStyle=t.rgba,this._context.fillStyle=t.rgba)}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this._context&&(this._context.lineWidth=t)}fillRect(t,e,s,i){s>0&&this._context.fillRect(0|t,0|e,s,i)}strokeRect(t,e,s,i){const a=this.lineWidth%2==0?0:.5;this._context.strokeRect((0|t)+a,(0|e)+a,s,i)}beginPath(){this._context.beginPath()}closePath(){this._context.closePath()}moveTo(t,e){this._context.moveTo(t,e)}lineTo(t,e){this._context.lineTo(t,e)}quadraticCurveTo(t,e,s,i){this._context.quadraticCurveTo(t,e,s,i)}bezierCurveTo(t,e,s,i,a,n){this._context.bezierCurveTo(t,e,s,i,a,n)}fillCircle(t,e,s){this._context.beginPath(),this._context.arc(t,e,s,0,2*Math.PI,!0),this.fill()}strokeCircle(t,e,s){this._context.beginPath(),this._context.arc(t,e,s,0,2*Math.PI,!0),this.stroke()}fill(){this._context.fill(),this._context.beginPath()}stroke(){this._context.stroke(),this._context.beginPath()}get font(){return this._font}set font(t){this._font=t,this._context&&(this._context.font=t.toCssString(1)),this._measureContext.font=t.toCssString(1)}get textAlign(){switch(this._context.textAlign){case"left":default:return U.Left;case"center":return U.Center;case"right":return U.Right}}set textAlign(t){switch(t){case U.Left:this._context.textAlign="left";break;case U.Center:this._context.textAlign="center";break;case U.Right:this._context.textAlign="right"}}get textBaseline(){switch(this._context.textBaseline){case"hanging":default:return re.Top;case"middle":return re.Middle;case"bottom":return re.Bottom}}set textBaseline(t){switch(t){case re.Top:this._context.textBaseline="hanging";break;case re.Middle:this._context.textBaseline="middle";break;case re.Bottom:this._context.textBaseline="bottom"}}beginGroup(t){}endGroup(){}fillText(t,e,s){this._context.fillText(t,e,s)}measureText(t){const e=this._measureContext.measureText(t);return new $i(e.width,e.actualBoundingBoxDescent+e.actualBoundingBoxAscent)}fillMusicFontSymbol(t,e,s,i,a=!1){i!==l.None&&this.fillMusicFontSymbolText(t,e,s,String.fromCharCode(i),a)}fillMusicFontSymbols(t,e,s,i,a=!1){let n="";for(const o of i)o!==l.None&&(n+=String.fromCharCode(o));this.fillMusicFontSymbolText(t,e,s,n,a)}fillMusicFontSymbolText(t,e,s,i,a){const n=this._context.textAlign,o=this._context.textBaseline,h=this._context.font;this._context.font=this._musicFont.toCssString(s),this._context.textBaseline="middle",this._context.textAlign=a?"center":"left",this._context.fillText(i,t,e),this._context.textBaseline=o,this._context.font=h,this._context.textAlign=n}beginRotate(t,e,s){this._context.save(),this._context.translate(t,e),this._context.rotate(s*Math.PI/180)}endRotate(){this._context.restore()}}class us{constructor(t,e=!1){this._midiFile=t,this._smf1Mode=e}addTimeSignature(t,e,s){let i=0,a=s;for(;a>>=1,a>0;)i++;this._midiFile.addEvent(new Ma(0,t,e,i,48,8))}addRest(t,e,s){this._smf1Mode||this._midiFile.addEvent(new Oa(t,e,s))}addNote(t,e,s,i,a,n){this._midiFile.addEvent(new Wa(t,e,n,us.fixValue(i),us.fixValue(a))),this._midiFile.addEvent(new Va(t,e+s,n,us.fixValue(i),us.fixValue(a)))}static fixValue(t){return t>127?127:t<0?0:t}addControlChange(t,e,s,i,a){this._midiFile.addEvent(new Ga(t,e,s,i,us.fixValue(a)))}addProgramChange(t,e,s,i){this._midiFile.addEvent(new za(t,e,s,i))}addTempo(t,e){const s=new Ua(t,0);s.beatsPerMinute=e,this._midiFile.addEvent(s)}addBend(t,e,s,i){i=i>=q.MaxPitchWheel?q.MaxPitchWheel:Math.floor(i),this._midiFile.addEvent(new Ya(t,e,s,i))}addNoteBend(t,e,s,i,a){this._smf1Mode?this.addBend(t,e,s,a):this._midiFile.addEvent(new Xa(t,e,s,i,a=a*q.MaxPitchWheel20/q.MaxPitchWheel))}finishTrack(t,e){(this._midiFile.format===vi.MultiTrack||0===t)&&this._midiFile.addEvent(new Ja(t,e))}}class ul{constructor(t,e){this.closingIndex=0,this.group=t,this.opening=e,t.closings=t.closings.sort((s,i)=>s.index-i.index),this.iterations=t.closings.map(s=>0)}}var kt=function(r){return r[r.PlayingNormally=0]="PlayingNormally",r[r.DirectionJumped=1]="DirectionJumped",r[r.DirectionJumpedAlCoda=2]="DirectionJumpedAlCoda",r[r.DirectionJumpedAlDoubleCoda=3]="DirectionJumpedAlDoubleCoda",r[r.DirectionJumpedAlFine=4]="DirectionJumpedAlFine",r}(kt||{});class fl{get finished(){return this.index>=this._score.masterBars.length}constructor(t){this._repeatStack=[],this._groupsOnStack=new Set,this._previousAlternateEndings=0,this._state=kt.PlayingNormally,this.shouldPlay=!0,this.index=0,this.currentTick=0,this._score=t}processCurrent(){const t=this._score.masterBars[this.index];if(this._state===kt.PlayingNormally){let e=t.alternateEndings;if(0===e&&(e=this._previousAlternateEndings),t===t.repeatGroup.opening&&t.repeatGroup.isClosed&&!this._groupsOnStack.has(t.repeatGroup)){const s=new ul(t.repeatGroup,t);this._repeatStack.push(s),this._groupsOnStack.add(t.repeatGroup),this._previousAlternateEndings=0,e=t.alternateEndings}if(0===this._repeatStack.length||0===e)this.shouldPlay=!0;else{const s=this._repeatStack[this._repeatStack.length-1],i=s.iterations[s.closingIndex];this._previousAlternateEndings=e,this.shouldPlay=!!(e&1<<i)}}else this.shouldPlay=!0;this.shouldPlay&&(this.currentTick+=t.calculateDuration())}moveNext(){this.moveNextWithDirections()||this.moveNextWithNormalRepeats()}resetRepeats(){this._groupsOnStack.clear(),this._previousAlternateEndings=0,this._repeatStack=[]}handleDaCapo(t,e,s){return!!t.has(e)&&(this.index=0,this._state=s,this.resetRepeats(),!0)}handleDalSegno(t,e,s,i){if(t.has(e)){const a=this.findJumpTarget(i,this.index,!0);return-1!==a&&(this.index=a,this._state=s,this.resetRepeats(),!0)}return!1}handleDaCoda(t,e,s){if(t.has(e)){const i=this.findJumpTarget(s,this.index,!1);return-1===i?(this.index++,!0):(this.index=i,this._state=kt.PlayingNormally,!0)}return!1}moveNextWithDirections(){const t=this._score.masterBars[this.index],e=null!==t.directions&&t.directions.size>0;if(this._state===kt.PlayingNormally&&!e)return!1;if(!e)return this.index++,!0;switch(this._state){case kt.PlayingNormally:return!!(this.handleDaCapo(t.directions,I.JumpDaCapo,kt.DirectionJumped)||this.handleDaCapo(t.directions,I.JumpDaCapoAlCoda,kt.DirectionJumpedAlCoda)||this.handleDaCapo(t.directions,I.JumpDaCapoAlDoubleCoda,kt.DirectionJumpedAlDoubleCoda)||this.handleDaCapo(t.directions,I.JumpDaCapoAlFine,kt.DirectionJumpedAlFine)||this.handleDalSegno(t.directions,I.JumpDalSegno,kt.DirectionJumped,I.TargetSegno)||this.handleDalSegno(t.directions,I.JumpDalSegnoAlCoda,kt.DirectionJumpedAlCoda,I.TargetSegno)||this.handleDalSegno(t.directions,I.JumpDalSegnoAlDoubleCoda,kt.DirectionJumpedAlDoubleCoda,I.TargetSegno)||this.handleDalSegno(t.directions,I.JumpDalSegnoAlFine,kt.DirectionJumpedAlFine,I.TargetSegno)||this.handleDalSegno(t.directions,I.JumpDalSegnoSegno,kt.DirectionJumped,I.TargetSegnoSegno)||this.handleDalSegno(t.directions,I.JumpDalSegnoSegnoAlCoda,kt.DirectionJumpedAlCoda,I.TargetSegnoSegno)||this.handleDalSegno(t.directions,I.JumpDalSegnoSegnoAlDoubleCoda,kt.DirectionJumpedAlDoubleCoda,I.TargetSegnoSegno)||this.handleDalSegno(t.directions,I.JumpDalSegnoSegnoAlFine,kt.DirectionJumpedAlFine,I.TargetSegnoSegno));case kt.DirectionJumped:return this.index++,!0;case kt.DirectionJumpedAlCoda:return this.handleDaCoda(t.directions,I.JumpDaCoda,I.TargetCoda)||this.index++,!0;case kt.DirectionJumpedAlDoubleCoda:return this.handleDaCoda(t.directions,I.JumpDaDoubleCoda,I.TargetDoubleCoda)||this.index++,!0;case kt.DirectionJumpedAlFine:return t.directions.has(I.TargetFine)?(this.index=this._score.masterBars.length,!0):(this.index++,!0)}return!0}findJumpTarget(t,e,s){let i;return s?(i=this.findJumpTargetBackwards(t,e),-1===i&&(i=this.findJumpTargetForwards(t,e)),i):(i=this.findJumpTargetForwards(t,e),-1===i&&(i=this.findJumpTargetBackwards(t,e)),i)}findJumpTargetForwards(t,e){let s=e;for(;s<this._score.masterBars.length;){const i=this._score.masterBars[s].directions;if(i&&i.has(t))return s;s++}return-1}findJumpTargetBackwards(t,e){let s=e;for(;s>=0;){const i=this._score.masterBars[s].directions;if(i&&i.has(t))return s;s--}return-1}moveNextWithNormalRepeats(){const e=this._score.masterBars[this.index].repeatCount-1;if(this._repeatStack.length>0&&e>0){const s=this._repeatStack[this._repeatStack.length-1];if(s.iterations[s.closingIndex]<e){this.index=s.opening.index,s.iterations[s.closingIndex]++;for(let a=0;a<s.closingIndex;a++)s.iterations[a]=0;s.closingIndex=0,this._previousAlternateEndings=0}else s.closingIndex<s.group.closings.length-1?(s.closingIndex++,this.index++):(this._repeatStack.pop(),this._groupsOnStack.delete(s.group),this.index++)}else this.index++}}class go{constructor(t,e){this.beat=t,this.playbackStart=e}}class as{get duration(){return this.end-this.start}constructor(t,e){this._highlightedBeats=new Map,this.highlightedBeats=[],this.nextBeat=null,this.previousBeat=null,this.start=t,this.end=e}highlightBeat(t,e){t.isEmpty&&!t.voice.isEmpty||this._highlightedBeats.has(t.id)||(this._highlightedBeats.set(t.id,!0),this.highlightedBeats.push(new go(t,e)))}getVisibleBeatAtStart(t){for(const e of this.highlightedBeats)if(e.playbackStart===this.start&&t.has(e.beat.voice.bar.staff.track.index))return e.beat;return null}}class fr{constructor(t,e){this.tick=t,this.tempo=e}}class hn{constructor(){this.start=0,this.end=0,this.tempoChanges=[],this.firstBeat=null,this.lastBeat=null,this.nextMasterBar=null,this.previousMasterBar=null}get tempo(){return this.tempoChanges[0].tempo}insertAfter(t,e){null==this.firstBeat||null==t||null==this.lastBeat?(this.firstBeat=e,this.lastBeat=e):(e.nextBeat=t.nextBeat,e.previousBeat=t,t.nextBeat&&(t.nextBeat.previousBeat=e),t.nextBeat=e,t===this.lastBeat&&(this.lastBeat=e))}insertBefore(t,e){null==this.firstBeat||null==t||null==this.lastBeat?(this.firstBeat=e,this.lastBeat=e):(e.previousBeat=t.previousBeat,e.nextBeat=t,t.previousBeat&&(t.previousBeat.nextBeat=e),t.previousBeat=e,t===this.firstBeat&&(this.firstBeat=e))}addBeat(t,e,s,i){const a=s+i;if(null==this.firstBeat){const n=new as(s,a);n.highlightBeat(t,e),this.insertAfter(this.firstBeat,n)}else if(s>=this.lastBeat.end){const n=new as(this.lastBeat.end,a);n.highlightBeat(t,e),this.insertAfter(this.lastBeat,n)}else{let n=null;if(s<this.firstBeat.start)n=this.firstBeat;else{let o=this.firstBeat;for(;null!=o;){if(s>=o.start&&s<o.end){n=o;break}o=o.nextBeat}if(null===n)throw new Le(Fe.General,"Error on building lookup, unknown variant")}if(s<n.start)if(a===n.start){const o=new as(s,n.start);o.highlightBeat(t,e),this.insertBefore(this.firstBeat,o)}else if(a<n.end){const o=new as(s,n.start);o.highlightBeat(t,e),this.insertBefore(n,o);const h=new as(n.start,a);for(const c of n.highlightedBeats)h.highlightBeat(c.beat,c.playbackStart);h.highlightBeat(t,e),this.insertBefore(n,h),n.start=a}else if(a===n.end){const o=new as(s,n.start);o.highlightBeat(t,e),n.highlightBeat(t,e),this.insertBefore(n,o)}else{const o=new as(s,n.start);o.highlightBeat(t,e),n.highlightBeat(t,e),this.insertBefore(n,o),this.addBeat(t,e,n.end,a-n.end)}else if(s>n.start)if(a===n.end){const o=new as(n.start,s);for(const h of n.highlightedBeats)o.highlightBeat(h.beat,h.playbackStart);n.start=s,n.highlightBeat(t,e),this.insertBefore(n,o)}else if(a<n.end){const o=new as(n.start,s);this.insertBefore(n,o);const h=new as(s,a);this.insertBefore(n,h);for(const c of n.highlightedBeats)o.highlightBeat(c.beat,c.playbackStart),h.highlightBeat(c.beat,c.playbackStart);h.highlightBeat(t,e),n.start=a}else{const o=new as(n.start,s);for(const h of n.highlightedBeats)o.highlightBeat(h.beat,h.playbackStart);n.start=s,n.highlightBeat(t,e),this.insertBefore(n,o),this.addBeat(t,e,n.end,a-n.end)}else if(a===n.end)n.highlightBeat(t,e);else if(a<n.end){const o=new as(n.start,a);for(const h of n.highlightedBeats)o.highlightBeat(h.beat,h.playbackStart);o.highlightBeat(t,e),n.start=a,this.insertBefore(n,o)}else n.highlightBeat(t,e),this.addBeat(t,e,n.end,a-n.end)}}}var ns=function(r){return r[r.Unknown=0]="Unknown",r[r.ToNextBext=1]="ToNextBext",r[r.ToEndOfBar=2]="ToEndOfBar",r}(ns||{});class mo{get start(){return this.masterBar.start+this.beatLookup.start}get end(){return this.start+this.tickDuration}constructor(t){this.nextBeat=null,this.tickDuration=0,this.duration=0,this.cursorMode=ns.Unknown,this.masterBar=t}calculateDuration(){if(1===this.masterBar.tempoChanges.length)this.duration=C.ticksToMillis(this.tickDuration,this.masterBar.tempoChanges[0].tempo);else{let t=0,e=this.start,s=this.masterBar.tempoChanges[0].tempo;const i=this.end;for(const a of this.masterBar.tempoChanges)if(a.tick<e)s=a.tempo;else{if(a.tick>i)break;t+=C.ticksToMillis(a.tick-e,s),s=a.tempo,e=a.tick}i>e&&(t+=C.ticksToMillis(i-e,s)),this.duration=t}}}class yo{constructor(){this._currentMasterBar=null,this.masterBarLookup=new Map,this.masterBars=[],this.multiBarRestInfo=null}findBeat(t,e,s=null){let i=null;return s&&(i=this.findBeatFast(t,s,e)),i||(i=this.findBeatSlow(t,s,e,!1)),i}findBeatFast(t,e,s){if(s>=e.start&&s<e.end)return e;if(e.nextBeat&&s>=e.nextBeat.start&&s<e.nextBeat.end){const i=e.nextBeat;return this.fillNextBeat(i,t),i}return null}fillNextBeatMultiBarRest(t,e){const s=this.multiBarRestInfo.get(t.masterBar.masterBar.index);let i=t.masterBar;for(let a=0;a<s.length&&i;a++)i=i.nextMasterBar;i?i.nextMasterBar?(t.nextBeat=this.firstBeatInMasterBar(e,i.nextMasterBar,i.nextMasterBar.start,!0),t.nextBeat?(t.tickDuration=t.nextBeat.start-t.start,t.cursorMode=ns.ToNextBext,t.nextBeat.masterBar.masterBar.index!==i.masterBar.index+1&&(t.nextBeat.masterBar.masterBar.index!==i.masterBar.index||t.nextBeat.beat.playbackStart<=t.beat.playbackStart)&&(t.cursorMode=ns.ToEndOfBar)):(t.tickDuration=i.nextMasterBar.end-t.start,t.cursorMode=ns.ToEndOfBar)):(t.tickDuration=i.end-t.start,t.cursorMode=ns.ToEndOfBar):(x.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain fill-next)"),t.tickDuration=(t.masterBar.end-t.masterBar.start)*(s.length+1),t.cursorMode=ns.ToEndOfBar),t.calculateDuration()}fillNextBeat(t,e){this.isMultiBarRestResult(t)?this.fillNextBeatMultiBarRest(t,e):this.fillNextBeatDefault(t,e)}fillNextBeatDefault(t,e){t.nextBeat=this.findBeatInMasterBar(t.masterBar,t.beatLookup.nextBeat,t.end,e,!0),null==t.nextBeat&&(t.nextBeat=this.findBeatSlow(e,t,t.end,!0)),t.nextBeat?(t.tickDuration=t.nextBeat.start-t.start,t.cursorMode=ns.ToNextBext,t.calculateDuration()):(t.tickDuration=t.masterBar.end-t.start,t.cursorMode=ns.ToEndOfBar,t.calculateDuration()),t.nextBeat&&t.nextBeat.masterBar.masterBar.index!==t.masterBar.masterBar.index+1&&(t.nextBeat.masterBar.masterBar.index!==t.masterBar.masterBar.index||t.nextBeat.beat.playbackStart<=t.beat.playbackStart)&&(t.cursorMode=ns.ToEndOfBar)}isMultiBarRestResult(t){return this.internalIsMultiBarRestResult(t.masterBar.masterBar.index,t.beat)}internalIsMultiBarRestResult(t,e){return this.multiBarRestInfo&&this.multiBarRestInfo.has(t)&&e.isRest&&e.voice.bar.isRestOnly}findBeatSlow(t,e,s,i){let a=null;return null!=e&&(e.masterBar.start<=s&&e.masterBar.end>s?a=e.masterBar:e.masterBar.nextMasterBar&&e.masterBar.nextMasterBar.start<=s&&e.masterBar.nextMasterBar.end>s&&(a=e.masterBar.nextMasterBar)),a||(a=this.findMasterBar(s)),a?this.firstBeatInMasterBar(t,a,s,i):null}firstBeatInMasterBar(t,e,s,i){let a=e;for(;a;){if(a.firstBeat){const n=this.findBeatInMasterBar(a,a.firstBeat,s,t,i);if(n)return n}a=a.nextMasterBar}return null}findBeatInMasterBar(t,e,s,i,a){if(!e)return null;let n=null,o=null;const h=s-t.start;for(;null!=e&&null==o;){if((e.start<=h||a&&h<0)&&h<e.end){if(n=e,o=e.getVisibleBeatAtStart(i),!o)if(a){let d=t;for(;null!=d&&null==o;){for(;null!=e;){if(o=e.getVisibleBeatAtStart(i),o){n=e,t=d;break}e=e.nextBeat}(!o||!n)&&(d=d.nextMasterBar,e=d?.firstBeat??null)}}else{let d=t;for(;null!=d&&null==o;){for(;null!=e;){if(o=e.getVisibleBeatAtStart(i),o){n=e,t=d;break}e=e.previousBeat}(!o||!n)&&(d=d.previousMasterBar,e=d?.firstBeat??null)}}}else if(e.end>h)break;e=e?.nextBeat??null}return null==o?null:this.createResult(t,n,o,a,i)}createResult(t,e,s,i,a){const n=new mo(t);if(n.beat=s,n.beatLookup=e,n.tickDuration=e.end-e.start,i){if(this.isMultiBarRestResult(n)){const o=this.multiBarRestInfo.get(t.masterBar.index);let h=t;for(let c=0;c<o.length&&h;c++)h=h.nextMasterBar;h?n.tickDuration=h.nextMasterBar?h.nextMasterBar.start-e.start:h.end-e.start:x.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain stretch-result)")}}else this.fillNextBeat(n,a);return n.calculateDuration(),n}findMasterBar(t){const e=this.masterBars;let s=0,i=e.length-1;for(;s<=i;){const a=(i+s)/2|0,n=e[a];if(t>=n.start&&t<n.end)return n;t<n.start?i=a-1:s=a+1}return null}getMasterBar(t){if(!this.masterBarLookup.has(t.index)){const e=new hn;return e.masterBar=t,e}return this.masterBarLookup.get(t.index)}getMasterBarStart(t){return this.masterBarLookup.has(t.index)?this.masterBarLookup.get(t.index).start:0}getBeatStart(t){return this.masterBarLookup.has(t.voice.bar.index)?this.masterBarLookup.get(t.voice.bar.index).start+t.playbackStart:0}addMasterBar(t){this.masterBars.push(t),this._currentMasterBar&&(t.previousMasterBar=this._currentMasterBar,this._currentMasterBar.nextMasterBar=t),this._currentMasterBar=t,this.masterBarLookup.has(t.masterBar.index)||this.masterBarLookup.set(t.masterBar.index,t)}addBeat(t,e,s){const i=this._currentMasterBar;if(i)if(e<0&&i.previousMasterBar){const a=i.previousMasterBar.end-i.previousMasterBar.start,n=a+e,o=n+s;i.previousMasterBar.addBeat(t,n,n,s),o>a&&i.addBeat(t,e,0,s+e)}else i.addBeat(t,e,e,s)}}class pl{constructor(){this.noteOnly=0,this.untilTieOrSlideEnd=0,this.letRingEnd=0}}class gl{constructor(){this.firstBeatDuration=0,this.secondBeatStartOffset=0,this.secondBeatDuration=0}}class ml{constructor(){this.durations=[],this.brushInfos=[]}}class yl{constructor(){this.synthTick=0,this.synthTime=0,this.currentTempo=0,this.automationToSyncPoint=new Map,this.createNewSyncPoints=!1}}class ne{constructor(t,e,s){this._programsPerChannel=new Map,this._currentTime=0,this._calculatedBeatTimers=new Set,this.tickLookup=new yo,this.applyTranspositionPitches=!0,this.syncPoints=[],this.transpositionPitches=new Map,this._currentTripletFeel=null,this.vibratoResolution=16,this._score=t,this._settings=e||new Gs,this._handler=s}generate(){this.transpositionPitches.clear(),this._calculatedBeatTimers.clear(),this._currentTime=0;for(const t of this._score.tracks)this.generateTrack(t);x.debug("Midi","Begin midi generation"),this.syncPoints=[],ne.playThroughSong(this._score,this.syncPoints,!1,(t,e,s,i,a)=>{this.generateMasterBar(t,e,s,i,a)},(t,e,s)=>{for(const i of this._score.tracks)for(const a of i.staves)t<a.bars.length&&this.generateBar(a.bars[t],e,s)},t=>{for(const e of this._score.tracks)this._handler.finishTrack(e.index,t)}),x.debug("Midi","Midi generation done")}generateTrack(t){this.generateChannel(t,t.playbackInfo.primaryChannel,t.playbackInfo),t.playbackInfo.primaryChannel!==t.playbackInfo.secondaryChannel&&this.generateChannel(t,t.playbackInfo.secondaryChannel,t.playbackInfo)}addProgramChange(t,e,s,i){(!this._programsPerChannel.has(s)||this._programsPerChannel.get(s)!==i)&&(this._handler.addProgramChange(t.index,e,s,i),this._programsPerChannel.set(s,i))}static buildTranspositionPitches(t,e){const s=new Map;for(const i of t.tracks){const a=i.index<e.notation.transpositionPitches.length?e.notation.transpositionPitches[i.index]:-i.staves[0].transpositionPitch;s.set(i.playbackInfo.primaryChannel,a),s.set(i.playbackInfo.secondaryChannel,a)}return s}generateChannel(t,e,s){this.transpositionPitches.set(e,t.index<this._settings.notation.transpositionPitches.length?this._settings.notation.transpositionPitches[t.index]:-t.staves[0].transpositionPitch);const a=ne.toChannelShort(s.volume),n=ne.toChannelShort(s.balance);this._handler.addControlChange(t.index,0,e,He.VolumeCoarse,a),this._handler.addControlChange(t.index,0,e,He.PanCoarse,n),this._handler.addControlChange(t.index,0,e,He.ExpressionControllerCoarse,127),this._handler.addControlChange(t.index,0,e,He.RegisteredParameterFine,0),this._handler.addControlChange(t.index,0,e,He.RegisteredParameterCourse,0),this._handler.addControlChange(t.index,0,e,He.DataEntryFine,0),this._handler.addControlChange(t.index,0,e,He.DataEntryCoarse,ne.PitchBendRangeInSemitones),this.addProgramChange(t,0,e,s.program)}static generateSyncPoints(t,e=!1){const s=[];return ne.playThroughSong(t,s,e,(i,a,n,o,h)=>{},(i,a,n)=>{},i=>{}),s}static buildModifiedTempoLookup(t){return ne.playThroughSong(t,[],!1,(i,a,n,o,h)=>{},(i,a,n)=>{},i=>{}).automationToSyncPoint}static playThroughSong(t,e,s,i,a,n){const o=new fl(t),h=new yl;h.currentTempo=t.tempo,h.syncPoints=e,h.createNewSyncPoints=s;let c=null;const d=new Map;for(;!o.finished;){const u=o.index,f=t.masterBars[u],p=o.currentTick;if(o.processCurrent(),o.shouldPlay){let g=d.has(u)?d.get(u):-1;g++,d.set(u,g),i(f,c,p,h.currentTempo,g),a(u,p,f.tempoAutomations.length>0?f.tempoAutomations[0].value:h.currentTempo),h.synthTick=p,ne.processBarTime(f,g,h)}o.moveNext(),c=f}if(e.length>0){const u=e[e.length-1],f=o.currentTick-u.synthTick;if(f>0){const p=new Ii;p.masterBarIndex=c.index,p.masterBarOccurence=d.get(c.index)-1,p.synthTick=o.currentTick,p.synthBpm=h.currentTempo,h.createNewSyncPoints?(p.syncBpm=u.synthBpm,p.synthBpm=u.synthBpm):p.syncBpm=1===e.length?u.synthBpm:e[e.length-2].syncBpm,p.synthTime=u.synthTime+C.ticksToMillis(f,u.synthBpm),p.syncTime=u.syncTime+C.ticksToMillis(f,p.syncBpm),h.createNewSyncPoints||u.updateSyncBpm(p.synthTime,p.syncTime),e.push(p)}}return n(o.currentTick),h}static processBarTime(t,e,s){const i=t.calculateDuration(),a=t.syncPoints,n=s.synthTick;s.createNewSyncPoints?ne.processBarTimeWithNewSyncPoints(t,e,s):a?ne.processBarTimeWithSyncPoints(t,e,s):ne.processBarTimeNoSyncPoints(t,s);const o=n+i,h=o-s.synthTick;h>0&&(s.synthTime+=C.ticksToMillis(h,s.currentTempo),s.synthTick=o)}static processBarTimeWithNewSyncPoints(t,e,s){const i=s.synthTick;if(0===t.index&&0===e){s.currentTempo=t.score.tempo;const n=new Ii;n.masterBarIndex=t.index,n.masterBarOccurence=e,n.synthTick=i,n.synthBpm=s.currentTempo,n.synthTime=s.synthTime,n.syncBpm=s.currentTempo,n.syncTime=s.synthTime,s.syncPoints.push(n)}const a=t.calculateDuration();for(const n of t.tempoAutomations){const o=i+n.ratioPosition*a,h=o-s.synthTick;if(h>0&&(s.synthTick=o,s.synthTime+=C.ticksToMillis(h,s.currentTempo)),n.value!==s.currentTempo){s.currentTempo=n.value;const c=new Ii;c.masterBarIndex=t.index,c.masterBarOccurence=e,c.synthTick=o,c.synthBpm=s.currentTempo,c.synthTime=s.synthTime,c.syncBpm=s.currentTempo,c.syncTime=s.synthTime,s.syncPoints.push(c)}}}static processBarTimeWithSyncPoints(t,e,s){const i=s.synthTick,a=t.calculateDuration();let o,n=0;for(const h of t.syncPoints){if(h.syncPointValue.barOccurence!==e)continue;const c=i+h.ratioPosition*a;for(;n<t.tempoAutomations.length&&t.tempoAutomations[n].ratioPosition<=h.ratioPosition;){const u=t.tempoAutomations[n],f=i+u.ratioPosition*a;o=f-s.synthTick,o>0&&(s.synthTick=f,s.synthTime+=C.ticksToMillis(o,s.currentTempo)),s.currentTempo=u.value,n++}o=c-s.synthTick,o>0&&(s.synthTick=c,s.synthTime+=C.ticksToMillis(o,s.currentTempo)),s.syncPoints.length>0&&s.syncPoints[s.syncPoints.length-1].updateSyncBpm(s.synthTime,h.syncPointValue.millisecondOffset);const d=new Ii;d.masterBarIndex=t.index,d.masterBarOccurence=e,d.synthTick=c,d.synthBpm=s.currentTempo,d.synthTime=s.synthTime,d.syncTime=h.syncPointValue.millisecondOffset,d.syncBpm=0,s.syncPoints.push(d),s.automationToSyncPoint.set(h,d)}for(;n<t.tempoAutomations.length;){const h=t.tempoAutomations[n],c=i+h.ratioPosition*a;o=c-s.synthTick,o>0&&(s.synthTick=c,s.synthTime+=C.ticksToMillis(o,s.currentTempo)),s.currentTempo=h.value,n++}}static processBarTimeNoSyncPoints(t,e){const s=e.synthTick,i=t.calculateDuration();for(const a of t.tempoAutomations){const n=s+a.ratioPosition*i,o=n-e.synthTick;o>0&&(e.synthTick=n,e.synthTime+=C.ticksToMillis(o,e.currentTempo)),e.currentTempo=a.value}}static toChannelShort(t){const e=Math.max(-32768,Math.min(32767,8*t-1));return Math.max(e,-1)+1}generateMasterBar(t,e,s,i,a){(!e||e.timeSignatureDenominator!==t.timeSignatureDenominator||e.timeSignatureNumerator!==t.timeSignatureNumerator)&&this._handler.addTimeSignature(s,t.timeSignatureNumerator,t.timeSignatureDenominator);const n=t.calculateDuration(),o=new hn;if(t.tempoAutomations.length>0){t.tempoAutomations[0].ratioPosition>0&&o.tempoChanges.push(new fr(s,i));for(const h of t.tempoAutomations){const c=s+n*h.ratioPosition;this._handler.addTempo(c,h.value),o.tempoChanges.push(new fr(c,h.value))}}else e?o.tempoChanges.push(new fr(s,i)):(this._handler.addTempo(s,t.score.tempo),o.tempoChanges.push(new fr(s,t.score.tempo)));o.masterBar=t,o.start=s,o.end=o.start+n,this.tickLookup.addMasterBar(o)}generateBar(t,e,s){const i=this.getPlaybackBar(t),a=this._currentTime;for(const c of i.voices)this._currentTime=a,this.generateVoice(c,e,t,s);const n=i.masterBar,o=n.calculateDuration(),h=n.tempoAutomations.slice();if(0===h.length)this._currentTime=a+C.ticksToMillis(o,s);else{this._currentTime=a;let c=e,d=s;const u=e+o;for(const p of h){const b=o*p.ratioPosition-c;b>0&&(this._currentTime+=C.ticksToMillis(b,d)),d=p.value,c+=b}const f=u-c;f>0&&(this._currentTime+=C.ticksToMillis(f,d))}i.id!==t.id&&this.tickLookup.addBeat(t.voices[0].beats[0],0,o)}getPlaybackBar(t){switch(t.simileMark){case je.Simple:t.previousBar&&(t=this.getPlaybackBar(t.previousBar));break;case je.FirstOfDouble:case je.SecondOfDouble:t.previousBar&&t.previousBar.previousBar&&(t=this.getPlaybackBar(t.previousBar.previousBar))}return t}generateVoice(t,e,s,i){if(t.isEmpty&&(!t.bar.isEmpty||0!==t.index))return;const a=s.masterBar.tempoAutomations.slice();let n=i;const o=s.masterBar.calculateDuration();for(const h of t.beats){const c=h.playbackStart/o;for(;a.length>0&&a[0].ratioPosition<=c;)n=a.shift().value;this.generateBeat(h,e,s,n)}}generateBeat(t,e,s,i){let a=t.playbackStart,n=t.playbackDuration;const o=t.voice.bar.masterBar.calculateDuration();t.voice.bar.isEmpty?n=o:t.voice.bar.masterBar.tripletFeel!==ue.NoTripletFeel&&this._settings.player.playTripletFeel&&(this._currentTripletFeel?(a-=this._currentTripletFeel.secondBeatStartOffset,n=this._currentTripletFeel.secondBeatDuration,this._currentTripletFeel=null):(this._currentTripletFeel=ne.calculateTripletFeelInfo(a,n,t),this._currentTripletFeel&&(n=this._currentTripletFeel.firstBeatDuration))),t.showTimer&&!this._calculatedBeatTimers.has(t.id)&&(t.timer=this._currentTime,this._calculatedBeatTimers.add(t.id)),this._currentTime+=C.ticksToMillis(n,i),s===t.voice.bar&&this.tickLookup.addBeat(t,a,n);const h=t.voice.bar.staff.track;for(const c of t.automations)this.generateNonTempoAutomation(t,c,e);if(t.isRest)this._handler.addRest(h.index,e+a,h.playbackInfo.primaryChannel);else if(t.deadSlapped)this.generateDeadSlap(t,e+a);else{const c=this.getBrushInfo(t),d=this.getRasgueadoInfo(t,n);for(const u of t.notes)this.generateNote(u,e+a,n,i,c,d)}if(t.fade!==ct.None&&this.generateFade(t,e+a,n),t.vibrato!==ke.None){let c=240,d=3;switch(t.vibrato){case ke.Slight:c=this._settings.player.vibrato.beatSlightLength,d=this._settings.player.vibrato.beatSlightAmplitude;break;case ke.Wide:c=this._settings.player.vibrato.beatWideLength,d=this._settings.player.vibrato.beatWideAmplitude}this.generateVibratorWithParams(e+a,t.playbackDuration,c,0,d,(u,f)=>{this._handler.addBend(t.voice.bar.staff.track.index,u,h.playbackInfo.secondaryChannel,f)})}}static calculateTripletFeelInfo(t,e,s){let i;switch(s.voice.bar.masterBar.tripletFeel){case ue.Triplet8th:case ue.Dotted8th:case ue.Scottish8th:i=m.Eighth;break;case ue.Triplet16th:case ue.Dotted16th:case ue.Scottish16th:i=m.Sixteenth;break;default:return null}const a=C.toTicks(i);if(e!==a||t%a!==0||!s.nextBeat||s.nextBeat.voice!==s.voice||s.playbackDuration!==a)return null;const n=new gl;switch(s.voice.bar.masterBar.tripletFeel){case ue.Triplet8th:n.firstBeatDuration=C.applyTuplet(C.toTicks(m.Quarter),3,2),n.secondBeatDuration=C.applyTuplet(C.toTicks(m.Eighth),3,2);break;case ue.Dotted8th:n.firstBeatDuration=C.applyDot(C.toTicks(m.Eighth),!1),n.secondBeatDuration=C.toTicks(m.Sixteenth);break;case ue.Scottish8th:n.firstBeatDuration=C.toTicks(m.Sixteenth),n.secondBeatDuration=C.applyDot(C.toTicks(m.Eighth),!1);break;case ue.Triplet16th:n.firstBeatDuration=C.applyTuplet(C.toTicks(m.Eighth),3,2),n.secondBeatDuration=C.applyTuplet(C.toTicks(m.Sixteenth),3,2);break;case ue.Dotted16th:n.firstBeatDuration=C.applyDot(C.toTicks(m.Sixteenth),!1),n.secondBeatDuration=C.toTicks(m.ThirtySecond);break;case ue.Scottish16th:n.firstBeatDuration=C.toTicks(m.ThirtySecond),n.secondBeatDuration=C.applyDot(C.toTicks(m.Sixteenth),!1)}return n.secondBeatStartOffset=e-n.firstBeatDuration,n}generateDeadSlap(t,e){const s=C.toTicks(m.SixtyFourth),i=t.voice.bar.staff;if(i.tuning.length>0)for(const a of i.tuning)this._handler.addNote(i.track.index,e,s,a,C.dynamicToVelocity(J.F),i.track.playbackInfo.primaryChannel)}needsSecondaryChannel(t){return t.hasBend||t.beat.hasWhammyBar||t.beat.vibrato!==ke.None}determineChannel(t,e){if(this.needsSecondaryChannel(e))return t.playbackInfo.secondaryChannel;let s=e;for(;s.isTieDestination;)if(s=s.tieOrigin,this.needsSecondaryChannel(s))return t.playbackInfo.secondaryChannel;for(s=e;s.isTieOrigin;)if(s=s.tieDestination,this.needsSecondaryChannel(s))return t.playbackInfo.secondaryChannel;return t.playbackInfo.primaryChannel}generateNote(t,e,s,i,a,n){const o=t.beat.voice.bar.staff.track,h=t.beat.voice.bar.staff;let c=t.calculateRealValue(this.applyTranspositionPitches,!0);if(t.isPercussion){const S=ht.getArticulation(t);S&&(c=S.outputMidiNumber)}const d=null==n&&t.isStringed&&t.string<=a.length?a[t.string-1]:0,u=e+d,f=this.getNoteDuration(t,s,i);f.untilTieOrSlideEnd-=d,f.noteOnly-=d,f.letRingEnd-=d;const p=ne.getNoteVelocity(t),g=this.determineChannel(o,t);let b=0;const w=Math.max(f.untilTieOrSlideEnd,f.letRingEnd);b=t.hasBend?ne.getPitchWheel(t.bendPoints[0].value):t.beat.hasWhammyBar?ne.getPitchWheel(t.beat.whammyBarPoints[0].value):t.isTieDestination||t.slideOrigin&&t.slideOrigin.slideOutType===ce.Legato?-1:ne.getPitchWheel(0),b>=0&&this._handler.addNoteBend(o.index,u,g,c,b),t.beat.hasRasgueado?this.generateRasgueado(o,t,u,c,p,g,n):t.ornament===tt.None?!t.isTrill||h.isPercussion?t.beat.isTremolo?this.generateTremoloPicking(t,u,f,c,p,g):(t.hasBend?this.generateBend(t,u,f,c,g,i):t.beat.hasWhammyBar&&0===t.index?this.generateWhammy(t.beat,u,f,g,i):t.slideInType!==ut.None||t.slideOutType!==ce.None?this.generateSlide(t,u,f,c,g,i):(t.vibrato!==ke.None||t.isTieDestination&&t.tieOrigin.vibrato!==ke.None)&&this.generateVibrato(t,u,f,c,g),!t.isTieDestination&&(!t.slideOrigin||t.slideOrigin.slideOutType!==ce.Legato)&&this._handler.addNote(o.index,u,w,c,p,g)):this.generateTrill(t,u,f,c,p,g):this.generateOrnament(o,t,u,w,c,p,g)}generateOrnament(t,e,s,i,a,n,o){let h,c;const d=a%12,u=1/3;switch(e.ornament){case tt.Turn:h=[a+ne.OrnamentKeysUp[d],a,a+ne.OrnamentKeysDown[d]],c=[C.toTicks(m.Sixteenth)*u,C.toTicks(m.Sixteenth)*u,C.toTicks(m.Sixteenth)*u];break;case tt.InvertedTurn:h=[a+ne.OrnamentKeysDown[d],a,a+ne.OrnamentKeysUp[d]],c=[C.toTicks(m.Sixteenth)*u,C.toTicks(m.Sixteenth)*u,C.toTicks(m.Sixteenth)*u];break;case tt.UpperMordent:h=[a,a+ne.OrnamentKeysUp[d]],c=[C.toTicks(m.ThirtySecond),C.toTicks(m.ThirtySecond)];break;case tt.LowerMordent:h=[a,a+ne.OrnamentKeysDown[d]],c=[C.toTicks(m.ThirtySecond),C.toTicks(m.ThirtySecond)];break;default:return}let f=1;i<C.QuarterTime&&(f=i/C.QuarterTime),n-=C.VelocityIncrement;let p=0;for(let b=0;b<h.length;b++){const w=c[b]*f;this._handler.addNote(t.index,s,w,h[b],n,o),s+=w,p+=w}this._handler.addNote(t.index,s,i-p,a,n,o)}getNoteDuration(t,e,s){const i=new pl;if(i.noteOnly=e,i.untilTieOrSlideEnd=e,i.letRingEnd=e,t.isDead)return i.noteOnly=this.applyStaticDuration(ne.DefaultDurationDead,e,s),i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isPalmMute)return i.noteOnly=this.applyStaticDuration(ne.DefaultDurationPalmMute,e,s),i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isStaccato)return i.noteOnly=e/2|0,i.untilTieOrSlideEnd=i.noteOnly,i.letRingEnd=i.noteOnly,i;if(t.isTieOrigin){const a=t.tieDestination;if(a)if(t.isTieDestination){const n=this.getNoteDuration(a,a.beat.playbackDuration,s);i.untilTieOrSlideEnd=e+n.untilTieOrSlideEnd}else{const n=t.beat.absolutePlaybackStart,o=this.getNoteDuration(a,a.beat.playbackDuration,s);i.untilTieOrSlideEnd=a.beat.absolutePlaybackStart+o.untilTieOrSlideEnd-n}}else if(t.slideOutType===ce.Legato){const a=t.slideTarget;if(a){const n=t.beat.absolutePlaybackStart,o=this.getNoteDuration(a,a.beat.playbackDuration,s);i.untilTieOrSlideEnd=a.beat.absolutePlaybackStart+o.untilTieOrSlideEnd-n}}if(t.isLetRing&&this._settings.notation.notationMode===_t.GuitarPro){let a=t.beat,n=0;const o=t.beat.voice.bar.masterBar.calculateDuration();for(;a.nextBeat;){const h=a.nextBeat;if(h.isRest||t.isStringed&&h.hasNoteOnString(t.string))break;if(a=a.nextBeat,n=a.absolutePlaybackStart-t.beat.absolutePlaybackStart+a.playbackDuration,n>o){n=o;break}}i.letRingEnd=a===t.beat?e:n}else i.letRingEnd=i.untilTieOrSlideEnd;return i}applyStaticDuration(t,e,s){return Math.min(s*t/R.MaxPosition|0,e)}static getNoteVelocity(t){let e=0;switch(!t.beat.voice.bar.staff.isPercussion&&t.hammerPullOrigin&&e--,t.isGhost&&e--,t.accentuated){case et.Normal:e++;break;case et.Heavy:e+=2}return C.dynamicToVelocity(t.dynamics,e)}generateFade(t,e,s){const i=t.voice.bar.staff.track;switch(t.fade){case ct.FadeIn:this.generateFadeSteps(i,e,s,0,ne.toChannelShort(i.playbackInfo.volume));break;case ct.FadeOut:this.generateFadeSteps(i,e,s,ne.toChannelShort(i.playbackInfo.volume),0);break;case ct.VolumeSwell:const a=s/2|0;this.generateFadeSteps(i,e,a,0,ne.toChannelShort(i.playbackInfo.volume)),this.generateFadeSteps(i,e+a,a,ne.toChannelShort(i.playbackInfo.volume),0)}}generateFadeSteps(t,e,s,i,a){const o=(a-i)/(s=.8*s|0),h=s/120+1|0,c=e+s;for(let d=0;d<h;d++){const u=d===h-1,f=u?c:e+120*d,p=u?a:Math.round(i+(f-e)*o);this._handler.addControlChange(t.index,f,t.playbackInfo.primaryChannel,He.VolumeCoarse,p),this._handler.addControlChange(t.index,f,t.playbackInfo.secondaryChannel,He.VolumeCoarse,p)}}generateVibrato(t,e,s,i,a){let n=0,o=0;switch(t.vibrato!==ke.None?t.vibrato:t.isTieDestination?t.tieOrigin.vibrato:ke.Slight){case ke.Slight:n=this._settings.player.vibrato.noteSlightLength,o=this._settings.player.vibrato.noteSlightAmplitude;break;case ke.Wide:n=this._settings.player.vibrato.noteWideLength,o=this._settings.player.vibrato.noteWideAmplitude;break;default:return}const c=t.beat.voice.bar.staff.track;let d=0;if(t.isTieDestination&&t.tieOrigin.hasBend){const u=t.tieOrigin.bendPoints;d=u[u.length-1].value}this.generateVibratorWithParams(e,s.noteOnly,n,d,o,(u,f)=>{this._handler.addNoteBend(c.index,u,a,i,f)})}generateVibratorWithParams(t,e,s,i,a,n){const o=this.vibratoResolution,h=s/2|0,c=t+e;for(;t<c;){let d=0;const u=t+s<c?s:c-t;for(;d<u;){const f=i+a*Math.sin(d*Math.PI/h);n(t+d|0,ne.getPitchWheel(f)),d+=o}t+=s}n(0|c,ne.getPitchWheel(i))}static getPitchWheel(t){return q.DefaultPitchWheel+t/2*ne.PitchValuePerSemitone}generateSlide(t,e,s,i,a,n){const o=t.slideOutType===ce.Legato?s.noteOnly:s.untilTieOrSlideEnd,h=[],c=t.beat.voice.bar.staff.track,d=this._settings.player.slide.simpleSlidePitchOffset,u=Math.floor(R.MaxPosition*this._settings.player.slide.simpleSlideDurationRatio),f=Math.floor(R.MaxPosition*this._settings.player.slide.shiftSlideDurationRatio);switch(t.slideInType){case ut.IntoFromAbove:h.push(new R(0,d)),h.push(new R(u,0));break;case ut.IntoFromBelow:h.push(new R(0,-d)),h.push(new R(u,0))}switch(t.slideOutType){case ce.Legato:case ce.Shift:h.push(new R(f,0));const p=2*(t.slideTarget.calculateRealValue(this.applyTranspositionPitches,!0)-t.calculateRealValue(this.applyTranspositionPitches,!0));h.push(new R(R.MaxPosition,p));break;case ce.OutDown:h.push(new R(R.MaxPosition-u,0)),h.push(new R(R.MaxPosition,-d));break;case ce.OutUp:h.push(new R(R.MaxPosition-u,0)),h.push(new R(R.MaxPosition,d))}this.generateWhammyOrBend(e,o,h,n,(p,g)=>{this._handler.addNoteBend(c.index,p,a,i,g)})}generateBend(t,e,s,i,a,n){const o=t.bendPoints,h=t.beat.voice.bar.staff.track,c=(g,b)=>{this._handler.addNoteBend(h.index,g,a,i,b)};let u,d=null;if(t.isTieOrigin&&this._settings.notation.extendBendArrowsOnTiedNotes){let g=t;for(;g.isTieOrigin&&!g.tieDestination.hasBend&&g.tieDestination.vibrato===ke.None;)g=g.tieDestination;u=g.beat.absolutePlaybackStart-t.beat.absolutePlaybackStart+this.getNoteDuration(g,g.beat.playbackDuration,n).noteOnly}else if(t.isTieOrigin&&t.beat.graceType!==K.None){switch(t.tieDestination.bendType){case z.Bend:case z.BendRelease:case z.PrebendBend:d=t.tieDestination.bendPoints[1].value;break;case z.Prebend:case z.PrebendRelease:d=t.tieDestination.bendPoints[0].value}u=Math.max(s.noteOnly,C.millisToTicks(this._settings.player.songBookBendDuration,n))}else u=s.noteOnly;o[0].value>0&&!t.isContinuedBend&&e>0&&e--;const f=Math.min(u,C.millisToTicks(this._settings.player.songBookBendDuration,n));let p=[];switch(t.bendType){case z.Custom:p=o;break;case z.Bend:case z.Release:switch(t.bendStyle){case Ie.Default:p=o;break;case Ie.Gradual:p.push(new R(0,t.bendPoints[0].value)),(!d||d<t.bendPoints[1].value)&&(d=t.bendPoints[1].value),p.push(new R(R.MaxPosition,d));break;case Ie.Fast:return(!d||d<t.bendPoints[1].value)&&(d=t.bendPoints[1].value),void this.generateSongBookWhammyOrBend(e,u,t.beat.graceType===K.BendGrace,[t.bendPoints[0].value,d],f,n,c)}break;case z.BendRelease:switch(t.bendStyle){case Ie.Default:p=o;break;case Ie.Gradual:p.push(new R(0,t.bendPoints[0].value)),p.push(new R(R.MaxPosition/2|0,t.bendPoints[1].value)),p.push(new R(R.MaxPosition,t.bendPoints[2].value));break;case Ie.Fast:return void this.generateSongBookWhammyOrBend(e,u,!1,[t.bendPoints[0].value,t.bendPoints[1].value,t.bendPoints[2].value],f,n,c)}break;case z.Hold:case z.Prebend:p=o;break;case z.PrebendBend:switch(t.bendStyle){case Ie.Default:p=o;break;case Ie.Gradual:p.push(new R(0,t.bendPoints[0].value)),p.push(new R(R.MaxPosition,t.bendPoints[1].value));break;case Ie.Fast:return c(e,0|ne.getPitchWheel(t.bendPoints[0].value)),(!d||d<t.bendPoints[1].value)&&(d=t.bendPoints[1].value),void this.generateSongBookWhammyOrBend(e,u,!1,[t.bendPoints[0].value,d],f,n,c)}break;case z.PrebendRelease:switch(t.bendStyle){case Ie.Default:p=o;break;case Ie.Gradual:p.push(new R(0,t.bendPoints[0].value)),p.push(new R(R.MaxPosition,t.bendPoints[1].value));break;case Ie.Fast:return c(e,0|ne.getPitchWheel(t.bendPoints[0].value)),void this.generateSongBookWhammyOrBend(e,u,!1,[t.bendPoints[0].value,t.bendPoints[1].value],f,n,c)}}this.generateWhammyOrBend(e,u,p,n,c)}generateSongBookWhammyOrBend(t,e,s,i,a,n,o){const h=s?t:t+e-a,c=a/(i.length-1);for(let d=0;d<i.length-1;d++){const u=ne.getPitchWheel(i[d]),f=ne.getPitchWheel(i[d+1]);this.generateBendValues(h+c*d,c,u,f,n,o)}}generateWhammy(t,e,s,i,a){const n=t.whammyBarPoints,o=t.voice.bar.staff.track,h=s.noteOnly;n[0].value>0&&!t.isContinuedWhammy&&e--;const c=(u,f)=>{this._handler.addBend(o.index,u,i,f)};let d=[];switch(t.whammyBarType){case _e.Custom:d=n;break;case _e.Dive:switch(t.whammyStyle){case Ie.Default:d=n;break;case Ie.Gradual:d.push(new R(0,n[0].value)),d.push(new R(R.MaxPosition,n[1].value));break;case Ie.Fast:const u=Math.min(h,C.millisToTicks(this._settings.player.songBookBendDuration,a));return void this.generateSongBookWhammyOrBend(e,h,!1,[n[0].value,n[1].value],u,a,c)}break;case _e.Dip:switch(t.whammyStyle){case Ie.Default:d=n;break;case Ie.Gradual:d.push(new R(0,n[0].value)),d.push(new R(R.MaxPosition/2|0,n[1].value)),d.push(new R(R.MaxPosition,n[2].value));break;case Ie.Fast:const u=Math.min(h,C.millisToTicks(this._settings.player.songBookDipDuration,a));return void this.generateSongBookWhammyOrBend(e,h,!0,[n[0].value,n[1].value,n[2].value],u,a,c)}break;case _e.Hold:case _e.Predive:d=n;break;case _e.PrediveDive:switch(t.whammyStyle){case Ie.Default:d=n;break;case Ie.Gradual:d.push(new R(0,n[0].value)),d.push(new R(R.MaxPosition/2|0,n[0].value)),d.push(new R(R.MaxPosition,n[1].value));break;case Ie.Fast:const u=ne.getPitchWheel(n[0].value);this._handler.addBend(o.index,e,i,0|u);const f=Math.min(h,C.millisToTicks(this._settings.player.songBookBendDuration,a));return void this.generateSongBookWhammyOrBend(e,h,!1,[n[0].value,n[1].value],f,a,c)}}this.generateWhammyOrBend(e,h,d,a,c)}generateWhammyOrBend(t,e,s,i,a){const n=e/R.MaxPosition;for(let o=0;o<s.length-1;o++){const h=s[o],c=s[o+1],d=ne.getPitchWheel(h.value),u=ne.getPitchWheel(c.value);this.generateBendValues(t+n*h.offset,n*(c.offset-h.offset),d,u,i,a)}}generateBendValues(t,e,s,i,a,n){const o=C.ticksToMillis(e,a),h=Math.abs(i-s)/ne.PitchValuePerSemitone,c=Math.max(ne.MinBreakpointsPerSemitone*h,o/ne.MillisecondsPerBreakpoint),d=e/c,u=(i-s)/c,f=t+e;for(let p=0;p<c;p++)n(0|t,Math.round(s)),s+=u,t+=d;n(0|f,i)}generateRasgueado(t,e,s,i,a,n,o){let h=s;for(let c=0;c<o.durations.length;c++){const d=o.brushInfos[c],u=e.isStringed&&e.string<=d.length?d[e.string-1]:0,f=o.durations[c];this._handler.addNote(t.index,h+u,f-u,i,a,n),h+=f}}generateTrill(t,e,s,i,a,n){const o=t.beat.voice.bar.staff.track,h=t.stringTuning+t.trillFret;let c=C.toTicks(t.trillSpeed),d=!0,u=e;const f=e+s.untilTieOrSlideEnd;for(;u+10<f;)u+c>=f&&(c=f-u),this._handler.addNote(o.index,u,c,d?h:i,a,n),d=!d,u+=c}generateTremoloPicking(t,e,s,i,a,n){const o=t.beat.voice.bar.staff.track;let h=C.toTicks(t.beat.tremoloSpeed),c=e;const d=e+s.untilTieOrSlideEnd;for(;c+10<d;)c+h>=d&&(h=d-c),this._handler.addNote(o.index,c,h,i,a,n),c+=h}getRasgueadoInfo(t,e){if(!t.hasRasgueado)return null;const s=new ml,a=ne.RasgueadoDurations.get(t.rasgueado).reduce((d,u)=>d+u,0);s.durations=ne.RasgueadoDurations.get(t.rasgueado).map(d=>e*d/a),s.brushInfos=new Array(s.durations.length);const n=C.toTicks(m.Sixteenth);let o=0,h=0;for(const d of t.notes)d.isTieDestination||(o|=1<<d.string-1,h++);const c=ne.RasgueadoDirections.get(t.rasgueado);for(let d=0;d<s.durations.length;d++){const u=s.durations[d]*n/C.QuarterTime,f=new Int32Array(t.voice.bar.staff.tuning.length);s.brushInfos[d]=f;const p=c[d];p!==V.None&&this.fillBrushInfo(t,f,p===V.ArpeggioDown||p===V.BrushDown,o,h,u)}return s}getBrushInfo(t){const e=new Int32Array(t.voice.bar.staff.tuning.length);if(t.brushType){let s=0,i=0;for(const a of t.notes)a.isTieDestination||(s|=1<<a.string-1,i++);this.fillBrushInfo(t,e,t.brushType===V.ArpeggioDown||t.brushType===V.BrushDown,s,i,t.brushDuration)}return e}fillBrushInfo(t,e,s,i,a,n){if(t.notes.length>0){let o=0;const h=n/(a-1)|0;for(let c=0;c<t.voice.bar.staff.tuning.length;c++){const d=s?c:e.length-1-c;i&1<<d&&(e[d]=o,o+=h)}}return e}generateNonTempoAutomation(t,e,s){switch(e.type){case Ge.Instrument:this.addProgramChange(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,255&e.value),this.addProgramChange(t.voice.bar.staff.track,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,255&e.value);break;case Ge.Balance:const i=ne.toChannelShort(e.value);this._handler.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,He.PanCoarse,i),this._handler.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,He.PanCoarse,i);break;case Ge.Volume:const a=ne.toChannelShort(e.value);this._handler.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.primaryChannel,He.VolumeCoarse,a),this._handler.addControlChange(t.voice.bar.staff.track.index,t.playbackStart+s,t.voice.bar.staff.track.playbackInfo.secondaryChannel,He.VolumeCoarse,a)}}prepareSingleBeat(t){let e=-1,s=-1,i=t;for(;i&&(-1===e||-1===s);){for(const d of t.automations)switch(d.type){case Ge.Instrument:s=d.value;break;case Ge.Tempo:e=d.value}i=i.previousBeat}const a=t.voice.bar.staff.track,n=t.voice.bar.masterBar;-1===e&&(e=n.score.tempo);const o=t.playbackStart/n.calculateDuration();for(const d of n.tempoAutomations){if(!(d.ratioPosition<=o))break;e=d.value}-1===s&&(s=a.playbackInfo.program);const h=a.playbackInfo.volume;this.generateTrack(a),this._handler.addTimeSignature(0,n.timeSignatureNumerator,n.timeSignatureDenominator),this._handler.addTempo(0,e);const c=ne.toChannelShort(h);return this._handler.addControlChange(0,0,a.playbackInfo.primaryChannel,He.VolumeCoarse,c),this._handler.addControlChange(0,0,a.playbackInfo.secondaryChannel,He.VolumeCoarse,c),e}generateSingleBeat(t){const e=this.prepareSingleBeat(t);this.generateBeat(t,-t.playbackStart,t.voice.bar,e)}generateSingleNote(t){const e=this.prepareSingleBeat(t.beat);this.generateNote(t,0,t.beat.playbackDuration,e,new Int32Array(t.beat.voice.bar.staff.tuning.length),null)}}ne.DefaultDurationDead=30,ne.DefaultDurationPalmMute=80,ne.OrnamentKeysUp=[2,2,2,1,1,2,2,2,2,2,1,1],ne.OrnamentKeysDown=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],ne.PitchBendRangeInSemitones=16,ne.PitchValuePerSemitone=q.DefaultPitchWheel/ne.PitchBendRangeInSemitones,ne.MinBreakpointsPerSemitone=6,ne.MillisecondsPerBreakpoint=150,ne.RasgueadoDirections=new Map([[G.Ii,[V.BrushDown,V.BrushUp]],[G.Mi,[V.BrushDown,V.BrushDown]],[G.MiiTriplet,[V.BrushDown,V.BrushDown,V.BrushUp]],[G.MiiAnapaest,[V.BrushDown,V.BrushDown,V.BrushUp]],[G.PmpTriplet,[V.BrushUp,V.BrushDown,V.BrushDown]],[G.PmpAnapaest,[V.BrushUp,V.BrushDown,V.BrushDown]],[G.PeiTriplet,[V.BrushUp,V.BrushDown,V.BrushDown]],[G.PeiAnapaest,[V.BrushUp,V.BrushDown,V.BrushDown]],[G.PaiTriplet,[V.BrushUp,V.BrushDown,V.BrushDown]],[G.PaiAnapaest,[V.BrushUp,V.BrushDown,V.BrushDown]],[G.AmiTriplet,[V.BrushDown,V.BrushDown,V.BrushDown]],[G.AmiAnapaest,[V.BrushDown,V.BrushDown,V.BrushDown]],[G.Ppp,[V.None,V.BrushDown,V.BrushUp]],[G.Amii,[V.BrushDown,V.BrushDown,V.BrushDown,V.BrushUp]],[G.Amip,[V.BrushDown,V.BrushDown,V.BrushDown,V.BrushUp]],[G.Eami,[V.BrushDown,V.BrushDown,V.BrushDown,V.BrushDown]],[G.Eamii,[V.BrushDown,V.BrushDown,V.BrushDown,V.BrushDown,V.BrushUp]],[G.Peami,[V.BrushDown,V.BrushDown,V.BrushDown,V.BrushDown,V.BrushUp]]]),ne.RasgueadoDurations=new Map([[G.Ii,[C.toTicks(m.Eighth),C.toTicks(m.Eighth)]],[G.Mi,[C.toTicks(m.Eighth),C.toTicks(m.Eighth)]],[G.MiiTriplet,[C.toTicks(m.Eighth)/3,C.toTicks(m.Eighth)/3,C.toTicks(m.Eighth)/3]],[G.MiiAnapaest,[C.toTicks(m.Sixteenth),C.toTicks(m.Sixteenth),C.toTicks(m.Eighth)]],[G.PmpTriplet,[C.toTicks(m.Eighth)/3,C.toTicks(m.Eighth)/3,C.toTicks(m.Eighth)/3]],[G.PmpAnapaest,[C.toTicks(m.Sixteenth)/3,C.toTicks(m.Sixteenth)/3,C.toTicks(m.Eighth)/3]],[G.PeiTriplet,[C.toTicks(m.Eighth)/3,C.toTicks(m.Eighth)/3,C.toTicks(m.Eighth)/3]],[G.PeiAnapaest,[C.toTicks(m.Sixteenth),C.toTicks(m.Sixteenth),C.toTicks(m.Eighth)]],[G.PaiTriplet,[C.toTicks(m.Eighth)/3,C.toTicks(m.Eighth)/3,C.toTicks(m.Eighth)/3]],[G.PaiAnapaest,[C.toTicks(m.Sixteenth),C.toTicks(m.Sixteenth),C.toTicks(m.Eighth)]],[G.AmiTriplet,[C.toTicks(m.Eighth)/3,C.toTicks(m.Eighth)/3,C.toTicks(m.Eighth)/3]],[G.AmiAnapaest,[C.toTicks(m.Sixteenth)/3,C.toTicks(m.Sixteenth)/3,C.toTicks(m.Eighth)/3]],[G.Ppp,[C.toTicks(m.Sixteenth)/3,C.toTicks(m.Sixteenth)/3,C.toTicks(m.Eighth)/3]],[G.Amii,[C.toTicks(m.Sixteenth)/3,C.toTicks(m.Sixteenth)/3,C.toTicks(m.Sixteenth)/3,C.toTicks(m.Eighth)]],[G.Amip,[C.toTicks(m.Sixteenth)/3,C.toTicks(m.Sixteenth)/3,C.toTicks(m.Sixteenth)/3,C.toTicks(m.Eighth)]],[G.Eami,[C.toTicks(m.Sixteenth),C.toTicks(m.Sixteenth),C.toTicks(m.Sixteenth),C.toTicks(m.Sixteenth)]],[G.Eamii,[C.toTicks(m.Sixteenth)/5,C.toTicks(m.Sixteenth)/5,C.toTicks(m.Sixteenth)/5,C.toTicks(m.Sixteenth)/5,C.toTicks(m.Sixteenth)/5]],[G.Peami,[C.toTicks(m.Sixteenth)/5,C.toTicks(m.Sixteenth)/5,C.toTicks(m.Sixteenth)/5,C.toTicks(m.Sixteenth)/5,C.toTicks(m.Sixteenth)/5]]]);class bo{constructor(){this.startTick=0,this.endTick=0}}class $e{constructor(t,e){this.width=0,this.height=0,this.x=t,this.y=e}doLayout(){}paint(t,e,s){}}class Kt extends $e{constructor(t=0,e=0){super(t,e),this.beat=null,this.nextGlyph=null,this.previousGlyph=null}}class Ce{}Ce.Widths=new Map([[l.Brace,3],[l.BracketTop,0],[l.BracketBottom,0],[l.SystemDivider,0],[l.GClef,28],[l.CClef,28],[l.FClef,28],[l.UnpitchedPercussionClef1,15],[l.SixStringTabClef,28],[l.FourStringTabClef,28],[l.TimeSig0,14],[l.TimeSig1,10],[l.TimeSig2,14],[l.TimeSig3,14],[l.TimeSig4,14],[l.TimeSig5,14],[l.TimeSig6,14],[l.TimeSig7,14],[l.TimeSig8,14],[l.TimeSig9,14],[l.TimeSigCommon,14],[l.TimeSigCutCommon,14],[l.NoteheadDoubleWholeSquare,14],[l.NoteheadDoubleWhole,14],[l.NoteheadWhole,14],[l.NoteheadHalf,9],[l.NoteheadBlack,9],[l.NoteheadNull,9],[l.NoteheadXOrnate,9],[l.NoteheadPlusDoubleWhole,16],[l.NoteheadPlusWhole,10],[l.NoteheadPlusHalf,10],[l.NoteheadPlusBlack,10],[l.NoteheadSquareWhite,11],[l.NoteheadSquareBlack,11],[l.NoteheadTriangleUpDoubleWhole,16],[l.NoteheadTriangleUpWhole,11],[l.NoteheadTriangleUpHalf,11],[l.NoteheadTriangleUpBlack,11],[l.NoteheadTriangleRightWhite,11],[l.NoteheadTriangleRightBlack,11],[l.NoteheadTriangleDownDoubleWhole,16],[l.NoteheadTriangleDownWhole,11],[l.NoteheadTriangleDownHalf,11],[l.NoteheadTriangleDownBlack,11],[l.NoteheadDiamondDoubleWhole,16],[l.NoteheadDiamondWhole,9],[l.NoteheadDiamondHalf,9],[l.NoteheadDiamondBlack,9],[l.NoteheadDiamondBlackWide,10],[l.NoteheadDiamondWhite,9],[l.NoteheadDiamondWhiteWide,9],[l.NoteheadCircleXDoubleWhole,16],[l.NoteheadCircleXWhole,9],[l.NoteheadCircleXHalf,9],[l.NoteheadCircleX,9],[l.NoteheadXDoubleWhole,16],[l.NoteheadXWhole,9],[l.NoteheadXHalf,9],[l.NoteheadXBlack,9],[l.NoteheadParenthesis,9],[l.NoteheadSlashedBlack1,9],[l.NoteheadSlashedBlack2,9],[l.NoteheadSlashedHalf1,9],[l.NoteheadSlashedHalf2,9],[l.NoteheadSlashedWhole1,9],[l.NoteheadSlashedWhole2,9],[l.NoteheadSlashedDoubleWhole1,16],[l.NoteheadSlashedDoubleWhole2,16],[l.NoteheadCircledBlack,9],[l.NoteheadCircledHalf,9],[l.NoteheadCircledWhole,9],[l.NoteheadCircledDoubleWhole,16],[l.NoteheadCircleSlash,9],[l.NoteheadHeavyX,13],[l.NoteheadHeavyXHat,13],[l.NoteheadSlashVerticalEnds,12],[l.NoteheadSlashWhiteWhole,32],[l.NoteheadSlashWhiteHalf,25],[l.NoteheadRoundWhiteWithDot,9],[l.NoteheadSquareBlackLarge,9],[l.NoteheadSquareBlackWhite,9],[l.NoteheadClusterDoubleWhole3rd,16],[l.NoteheadClusterWhole3rd,12],[l.NoteheadClusterHalf3rd,12],[l.NoteheadClusterQuarter3rd,12],[l.NoteShapeRoundWhite,9],[l.NoteShapeRoundBlack,9],[l.NoteShapeSquareWhite,12],[l.NoteShapeSquareBlack,12],[l.NoteShapeTriangleRightWhite,12],[l.NoteShapeTriangleRightBlack,12],[l.NoteShapeTriangleLeftWhite,12],[l.NoteShapeTriangleLeftBlack,12],[l.NoteShapeDiamondWhite,9],[l.NoteShapeDiamondBlack,9],[l.NoteShapeTriangleUpWhite,12],[l.NoteShapeTriangleUpBlack,12],[l.NoteShapeMoonWhite,12],[l.NoteShapeMoonBlack,12],[l.NoteShapeTriangleRoundWhite,12],[l.NoteShapeTriangleRoundBlack,12],[l.NoteQuarterUp,10],[l.NoteEighthUp,10],[l.TextBlackNoteLongStem,0],[l.TextBlackNoteFrac8thLongStem,0],[l.TextBlackNoteFrac16thLongStem,0],[l.TextBlackNoteFrac32ndLongStem,0],[l.TextCont8thBeamLongStem,0],[l.TextCont16thBeamLongStem,0],[l.TextCont32ndBeamLongStem,0],[l.TextAugmentationDot,0],[l.TextTupletBracketStartLongStem,0],[l.TextTuplet3LongStem,0],[l.TextTupletBracketEndLongStem,0],[l.Tremolo3,12],[l.Tremolo2,12],[l.Tremolo1,12],[l.FlagEighthUp,0],[l.FlagEighthDown,0],[l.FlagSixteenthUp,0],[l.FlagSixteenthDown,0],[l.FlagThirtySecondUp,0],[l.FlagThirtySecondDown,0],[l.FlagSixtyFourthUp,0],[l.FlagSixtyFourthDown,0],[l.FlagOneHundredTwentyEighthUp,0],[l.FlagOneHundredTwentyEighthDown,0],[l.FlagTwoHundredFiftySixthUp,0],[l.FlagTwoHundredFiftySixthDown,0],[l.AccidentalFlat,8],[l.AccidentalNatural,8],[l.AccidentalSharp,8],[l.AccidentalDoubleSharp,8],[l.AccidentalDoubleFlat,18],[l.AccidentalQuarterToneFlatArrowUp,8],[l.AccidentalQuarterToneSharpArrowUp,8],[l.AccidentalQuarterToneNaturalArrowUp,8],[l.Segno,0],[l.Coda,0],[l.ArticAccentAbove,9],[l.ArticAccentBelow,9],[l.ArticStaccatoAbove,9],[l.ArticStaccatoBelow,9],[l.ArticTenutoAbove,9],[l.ArticTenutoBelow,9],[l.ArticMarcatoAbove,9],[l.ArticMarcatoBelow,9],[l.FermataAbove,23],[l.FermataShortAbove,23],[l.FermataLongAbove,23],[l.RestLonga,9],[l.RestDoubleWhole,9],[l.RestWhole,9],[l.RestHalf,9],[l.RestQuarter,9],[l.RestEighth,9],[l.RestSixteenth,9],[l.RestThirtySecond,12],[l.RestSixtyFourth,14],[l.RestOneHundredTwentyEighth,14],[l.RestTwoHundredFiftySixth,14],[l.RestHBarLeft,0],[l.RestHBarMiddle,0],[l.RestHBarRight,0],[l.Repeat1Bar,0],[l.Repeat2Bars,0],[l.Ottava,0],[l.OttavaAlta,32],[l.OttavaBassaVb,29],[l.Quindicesima,23],[l.QuindicesimaAlta,46],[l.DynamicPPPPPP,0],[l.DynamicPPPPP,0],[l.DynamicPPPP,0],[l.DynamicPPP,0],[l.DynamicPP,0],[l.DynamicPiano,0],[l.DynamicMP,0],[l.DynamicMF,0],[l.DynamicPF,0],[l.DynamicForte,0],[l.DynamicFF,0],[l.DynamicFFF,0],[l.DynamicFFFF,0],[l.DynamicFFFFF,0],[l.DynamicFFFFFF,0],[l.DynamicFortePiano,0],[l.DynamicNiente,0],[l.DynamicSforzando1,0],[l.DynamicSforzandoPiano,0],[l.DynamicSforzandoPianissimo,0],[l.DynamicSforzato,0],[l.DynamicSforzatoPiano,0],[l.DynamicSforzatoFF,0],[l.DynamicRinforzando1,0],[l.DynamicRinforzando2,0],[l.DynamicForzando,0],[l.OrnamentTrill,20],[l.OrnamentTurn,26],[l.OrnamentTurnInverted,26],[l.OrnamentShortTrill,0],[l.OrnamentMordent,26],[l.StringsDownBow,9],[l.StringsUpBow,9],[l.KeyboardPedalPed,35],[l.KeyboardPedalUp,16],[l.PictEdgeOfCymbal,44],[l.GuitarString0,20],[l.GuitarString1,20],[l.GuitarString2,20],[l.GuitarString3,20],[l.GuitarString4,20],[l.GuitarString5,20],[l.GuitarString6,20],[l.GuitarString7,20],[l.GuitarString8,20],[l.GuitarString9,20],[l.GuitarOpenPedal,11],[l.GuitarClosePedal,11],[l.GuitarGolpe,13.4],[l.GuitarFadeIn,13],[l.GuitarFadeOut,13],[l.GuitarVolumeSwell,26],[l.FretboardX,0],[l.FretboardO,0],[l.WiggleTrill,9],[l.WiggleVibratoMediumFast,10],[l.OctaveBaselineM,13],[l.OctaveBaselineB,9]]),Ce.Heights=new Map([[l.Brace,34],[l.BracketTop,0],[l.BracketBottom,0],[l.SystemDivider,0],[l.GClef,0],[l.CClef,0],[l.FClef,0],[l.UnpitchedPercussionClef1,0],[l.SixStringTabClef,0],[l.FourStringTabClef,0],[l.TimeSig0,0],[l.TimeSig1,0],[l.TimeSig2,0],[l.TimeSig3,0],[l.TimeSig4,0],[l.TimeSig5,0],[l.TimeSig6,0],[l.TimeSig7,0],[l.TimeSig8,0],[l.TimeSig9,0],[l.TimeSigCommon,0],[l.TimeSigCutCommon,0],[l.NoteheadDoubleWholeSquare,8],[l.NoteheadDoubleWhole,8],[l.NoteheadWhole,8],[l.NoteheadHalf,8],[l.NoteheadBlack,8],[l.NoteheadNull,8],[l.NoteheadXOrnate,8],[l.NoteheadPlusDoubleWhole,8],[l.NoteheadPlusWhole,8],[l.NoteheadPlusHalf,8],[l.NoteheadPlusBlack,8],[l.NoteheadSquareWhite,8],[l.NoteheadSquareBlack,8],[l.NoteheadTriangleUpDoubleWhole,8],[l.NoteheadTriangleUpWhole,8],[l.NoteheadTriangleUpHalf,8],[l.NoteheadTriangleUpBlack,8],[l.NoteheadTriangleRightWhite,8],[l.NoteheadTriangleRightBlack,8],[l.NoteheadTriangleDownDoubleWhole,8],[l.NoteheadTriangleDownWhole,8],[l.NoteheadTriangleDownHalf,8],[l.NoteheadTriangleDownBlack,8],[l.NoteheadDiamondDoubleWhole,8],[l.NoteheadDiamondWhole,8],[l.NoteheadDiamondHalf,8],[l.NoteheadDiamondBlack,8],[l.NoteheadDiamondBlackWide,9],[l.NoteheadDiamondWhite,9],[l.NoteheadDiamondWhiteWide,9],[l.NoteheadCircleXDoubleWhole,8],[l.NoteheadCircleXWhole,8],[l.NoteheadCircleXHalf,8],[l.NoteheadCircleX,8],[l.NoteheadXDoubleWhole,8],[l.NoteheadXWhole,8],[l.NoteheadXHalf,8],[l.NoteheadXBlack,8],[l.NoteheadParenthesis,8],[l.NoteheadSlashedBlack1,8],[l.NoteheadSlashedBlack2,8],[l.NoteheadSlashedHalf1,8],[l.NoteheadSlashedHalf2,8],[l.NoteheadSlashedWhole1,8],[l.NoteheadSlashedWhole2,8],[l.NoteheadSlashedDoubleWhole1,8],[l.NoteheadSlashedDoubleWhole2,8],[l.NoteheadCircledBlack,8],[l.NoteheadCircledHalf,8],[l.NoteheadCircledWhole,8],[l.NoteheadCircledDoubleWhole,8],[l.NoteheadCircleSlash,8],[l.NoteheadHeavyX,8],[l.NoteheadHeavyXHat,8],[l.NoteheadSlashVerticalEnds,17],[l.NoteheadSlashWhiteWhole,17],[l.NoteheadSlashWhiteHalf,17],[l.NoteheadRoundWhiteWithDot,8],[l.NoteheadSquareBlackLarge,8],[l.NoteheadSquareBlackWhite,8],[l.NoteheadClusterDoubleWhole3rd,8],[l.NoteheadClusterWhole3rd,8],[l.NoteheadClusterHalf3rd,8],[l.NoteheadClusterQuarter3rd,8],[l.NoteShapeRoundWhite,8],[l.NoteShapeRoundBlack,8],[l.NoteShapeSquareWhite,8],[l.NoteShapeSquareBlack,8],[l.NoteShapeTriangleRightWhite,8],[l.NoteShapeTriangleRightBlack,8],[l.NoteShapeTriangleLeftWhite,8],[l.NoteShapeTriangleLeftBlack,8],[l.NoteShapeDiamondWhite,8],[l.NoteShapeDiamondBlack,8],[l.NoteShapeTriangleUpWhite,8],[l.NoteShapeTriangleUpBlack,8],[l.NoteShapeMoonWhite,8],[l.NoteShapeMoonBlack,8],[l.NoteShapeTriangleRoundWhite,8],[l.NoteShapeTriangleRoundBlack,8],[l.NoteQuarterUp,8],[l.NoteEighthUp,8],[l.TextBlackNoteLongStem,0],[l.TextBlackNoteFrac8thLongStem,0],[l.TextBlackNoteFrac16thLongStem,0],[l.TextBlackNoteFrac32ndLongStem,0],[l.TextCont8thBeamLongStem,0],[l.TextCont16thBeamLongStem,0],[l.TextCont32ndBeamLongStem,0],[l.TextAugmentationDot,0],[l.TextTupletBracketStartLongStem,0],[l.TextTuplet3LongStem,0],[l.TextTupletBracketEndLongStem,0],[l.Tremolo3,0],[l.Tremolo2,0],[l.Tremolo1,0],[l.FlagEighthUp,0],[l.FlagEighthDown,0],[l.FlagSixteenthUp,0],[l.FlagSixteenthDown,0],[l.FlagThirtySecondUp,0],[l.FlagThirtySecondDown,0],[l.FlagSixtyFourthUp,0],[l.FlagSixtyFourthDown,0],[l.FlagOneHundredTwentyEighthUp,0],[l.FlagOneHundredTwentyEighthDown,0],[l.FlagTwoHundredFiftySixthUp,0],[l.FlagTwoHundredFiftySixthDown,0],[l.AccidentalFlat,0],[l.AccidentalNatural,0],[l.AccidentalSharp,0],[l.AccidentalDoubleSharp,0],[l.AccidentalDoubleFlat,0],[l.AccidentalQuarterToneFlatArrowUp,0],[l.AccidentalQuarterToneSharpArrowUp,0],[l.AccidentalQuarterToneNaturalArrowUp,0],[l.Segno,0],[l.Coda,0],[l.ArticAccentAbove,9],[l.ArticAccentBelow,9],[l.ArticStaccatoAbove,9],[l.ArticStaccatoBelow,9],[l.ArticTenutoAbove,9],[l.ArticTenutoBelow,9],[l.ArticMarcatoAbove,9],[l.ArticMarcatoBelow,9],[l.FermataAbove,12],[l.FermataShortAbove,12],[l.FermataLongAbove,12],[l.RestLonga,0],[l.RestDoubleWhole,0],[l.RestWhole,0],[l.RestHalf,0],[l.RestQuarter,0],[l.RestEighth,0],[l.RestSixteenth,0],[l.RestThirtySecond,0],[l.RestSixtyFourth,0],[l.RestOneHundredTwentyEighth,0],[l.RestTwoHundredFiftySixth,0],[l.RestHBarLeft,0],[l.RestHBarMiddle,0],[l.RestHBarRight,0],[l.Repeat1Bar,0],[l.Repeat2Bars,0],[l.Ottava,13],[l.OttavaAlta,13],[l.OttavaBassaVb,13],[l.Quindicesima,13],[l.QuindicesimaAlta,13],[l.DynamicPPPPPP,28.4],[l.DynamicPPPPP,28.4],[l.DynamicPPPP,28.4],[l.DynamicPPP,28.4],[l.DynamicPP,28.4],[l.DynamicPiano,28.4],[l.DynamicMP,28.4],[l.DynamicMF,28.4],[l.DynamicPF,28.4],[l.DynamicForte,28.4],[l.DynamicFF,28.4],[l.DynamicFFF,28.4],[l.DynamicFFFF,28.4],[l.DynamicFFFFF,28.4],[l.DynamicFFFFFF,28.4],[l.DynamicFortePiano,28.4],[l.DynamicNiente,28.4],[l.DynamicSforzando1,28.4],[l.DynamicSforzandoPiano,28.4],[l.DynamicSforzandoPianissimo,28.4],[l.DynamicSforzato,28.4],[l.DynamicSforzatoPiano,28.4],[l.DynamicSforzatoFF,28.4],[l.DynamicRinforzando1,28.4],[l.DynamicRinforzando2,28.4],[l.DynamicForzando,28.4],[l.OrnamentTrill,24],[l.OrnamentTurn,18],[l.OrnamentTurnInverted,18],[l.OrnamentShortTrill,18],[l.OrnamentMordent,18],[l.StringsDownBow,13/.75],[l.StringsUpBow,13/.75],[l.KeyboardPedalPed,19],[l.KeyboardPedalUp,16],[l.PictEdgeOfCymbal,30],[l.GuitarString0,20],[l.GuitarString1,20],[l.GuitarString2,20],[l.GuitarString3,20],[l.GuitarString4,20],[l.GuitarString5,20],[l.GuitarString6,20],[l.GuitarString7,20],[l.GuitarString8,20],[l.GuitarString9,20],[l.GuitarOpenPedal,11],[l.GuitarClosePedal,11],[l.GuitarGolpe,13.4],[l.GuitarFadeIn,13],[l.GuitarFadeOut,13],[l.GuitarVolumeSwell,13],[l.FretboardX,0],[l.FretboardO,0],[l.WiggleTrill,6],[l.WiggleVibratoMediumFast,10],[l.OctaveBaselineM,0],[l.OctaveBaselineB,0]]);class lt extends Kt{constructor(t,e,s,i){super(t,e),this.glyphScale=0,this.center=!1,this.glyphScale=s,this.symbol=i}doLayout(){this.width=Ce.Widths.has(this.symbol)?Ce.Widths.get(this.symbol)*this.glyphScale:0,this.height=Ce.Heights.has(this.symbol)?Ce.Heights.get(this.symbol)*this.glyphScale:0}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbol(t+this.x,e+this.y,this.glyphScale,this.symbol,this.center),s.color=i}}let Me=(()=>{class r extends lt{constructor(e,s,i,a){super(e,s,a?r.GraceScale:1,r.getSymbol(i)),this.centerOnStem=!1,this._isGrace=a}paint(e,s,i){const a=this._isGrace?1:0;this.centerOnStem&&(this.center=!0),super.paint(e,s+a,i)}static getSymbol(e){switch(e){case m.QuadrupleWhole:return l.NoteheadDoubleWholeSquare;case m.DoubleWhole:return l.NoteheadDoubleWhole;case m.Whole:return l.NoteheadWhole;case m.Half:return l.NoteheadHalf;default:return l.NoteheadBlack}}}return r.GraceScale=.75,r})(),aa=(()=>{class r extends lt{constructor(e,s,i,a,n){super(e,s,n?Me.GraceScale:1,r.getSymbol(i,a,n))}static getSymbol(e,s,i){if(i&&(e=m.Eighth),s===P.Up)switch(e){case m.Eighth:return l.FlagEighthUp;case m.Sixteenth:return l.FlagSixteenthUp;case m.ThirtySecond:return l.FlagThirtySecondUp;case m.SixtyFourth:return l.FlagSixtyFourthUp;case m.OneHundredTwentyEighth:return l.FlagOneHundredTwentyEighthUp;case m.TwoHundredFiftySixth:return l.FlagTwoHundredFiftySixthUp;default:return l.FlagEighthUp}switch(e){case m.Eighth:return l.FlagEighthDown;case m.Sixteenth:return l.FlagSixteenthDown;case m.ThirtySecond:return l.FlagThirtySecondDown;case m.SixtyFourth:return l.FlagSixtyFourthDown;case m.OneHundredTwentyEighth:case m.TwoHundredFiftySixth:return l.FlagOneHundredTwentyEighthDown;default:return l.FlagEighthDown}}}return r.FlagWidth=11,r})(),bs=(()=>{class r extends $e{get onTimeX(){return this.onNotes.x+this.onNotes.centerX}constructor(e,s){super(0,0),this.ties=[],this.minWidth=0,this.beat=e,this.ties=[],this.voiceContainer=s}addTie(e){e.renderer=this.renderer,this.ties.push(e)}drawBeamHelperAsFlags(e){return e.hasFlag(!1,void 0)}registerLayoutingInfo(e){const s=this.preNotes.computedWidth+this.onNotes.centerX;let i=this.onNotes.computedWidth-this.onNotes.centerX;const a=this.renderer.helpers.getBeamingHelperForBeat(this.beat);this.beat.graceType!==K.None?i+=1===this.beat.graceGroup.beats.length?aa.FlagWidth*Me.GraceScale:this.beat.graceIndex<this.beat.graceGroup.beats.length-1?7:r.GraceBeatPadding:a&&this.drawBeamHelperAsFlags(a)&&(i+=aa.FlagWidth);for(const n of this.ties)i+=n.width;e.addBeatSpring(this.beat,s,i)}applyLayoutingInfo(e){this.onNotes.updateBeamingHelper(),this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,this.preNotes.container=this,this.preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,this.onNotes.container=this,this.onNotes.doLayout();let e=this.beat.notes.length-1;for(;e>=0;)this.createTies(this.beat.notes[e--]);this.renderer.registerTies(this.ties),this.updateWidth()}updateWidth(){if(this.minWidth=this.preNotes.width+this.onNotes.width,!this.beat.isRest)if(1===this.onNotes.beamingHelper.beats.length)this.beat.duration>=m.Eighth&&(this.minWidth+=20);else switch(this.beat.duration){case m.OneHundredTwentyEighth:case m.TwoHundredFiftySixth:this.minWidth+=10}let e=0;for(const s of this.ties)s.width>e&&(e=s.width);this.minWidth+=e,this.width=this.minWidth}scaleToWidth(e){this.onNotes.updateBeamingHelper(),this.width=e}createTies(e){}static getGroupId(e){return`b${e.id}`}paint(e,s,i){if(this.preNotes.isEmpty&&this.onNotes.isEmpty&&0===this.ties.length)return;i.beginGroup(r.getGroupId(this.beat)),this.preNotes.paint(e+this.x,s+this.y,i),this.onNotes.paint(e+this.x,s+this.y,i);const n=e-this.voiceContainer.x-this.renderer.x,o=s-this.voiceContainer.y-this.renderer.y;for(let h=0,c=this.ties.length;h<c;h++){const d=this.ties[h];d.renderer=this.renderer,d.paint(n,o,i)}i.endGroup()}buildBoundingsLookup(e,s,i,a){const n=new rn;if(n.beat=this.beat,this.beat.isEmpty)n.visualBounds=new St,n.visualBounds.x=s+this.x,n.visualBounds.y=e.visualBounds.y,n.visualBounds.w=this.width,n.visualBounds.h=e.visualBounds.h,n.realBounds=new St,n.realBounds.x=s+this.x,n.realBounds.y=e.realBounds.y,n.realBounds.w=this.width,n.realBounds.h=e.realBounds.h,n.onNotesX=s+this.x+this.onNotes.centerX;else{n.visualBounds=new St,n.visualBounds.x=s+this.x,n.visualBounds.x=this.preNotes.isEmpty?this.onNotes.isEmpty?s+this.x:s+this.x+this.onNotes.x:s+this.x+this.preNotes.x;let o=0;o=this.onNotes.isEmpty?this.preNotes.isEmpty?s+this.x+this.width:s+this.x+this.preNotes.x+this.preNotes.width:s+this.x+this.onNotes.x+this.onNotes.width,n.visualBounds.w=o-n.visualBounds.x;const h=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(h&&this.drawBeamHelperAsFlags(h)||this.beat.graceType!==K.None)&&(n.visualBounds.w+=aa.FlagWidth*(this.beat.graceType!==K.None?Me.GraceScale:1)),n.visualBounds.y=e.visualBounds.y,n.visualBounds.h=e.visualBounds.h,n.realBounds=new St,n.realBounds.x=s+this.x,n.realBounds.y=e.realBounds.y,n.realBounds.w=this.width,n.realBounds.h=e.realBounds.h,n.onNotesX=s+this.x+this.onNotes.x+this.onNotes.centerX}e.addBeat(n),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(n,s+this.x,i+this.y)}}return r.GraceBeatPadding=3,r})();class So{constructor(){this.oldWidth=0,this.newWidth=0,this.settings=null}core(){return this.settings&&this.causeIssue()?this.settings.core:new vn}causeIssue(){return this.settings=null,!0}}class ln{constructor(t){this.activeBeats=t}}class bl{constructor(){this._midiEventQueue=new Ka,this.masterVolume=1,this.metronomeVolume=0,this.outSampleRate=44100,this.currentTempo=120,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.activeVoiceCount=0}noteOffAll(t){}resetSoft(){}resetPresets(){}loadPresets(t,e,s,i){}setupMetronomeChannel(t){}synthesizeSilent(t){this.fakeSynthesize()}processMidiMessage(t){}dispatchEvent(t){this._midiEventQueue.enqueue(t)}synthesize(t,e,s){return this.fakeSynthesize()}fakeSynthesize(){const t=[];for(;!this._midiEventQueue.isEmpty;){const e=this._midiEventQueue.dequeue();e.isMetronome&&this.metronomeVolume>0||e.event&&this.processMidiMessage(e.event),t.push(e)}return t}applyTranspositionPitches(t){}setChannelTranspositionPitch(t,e){}channelSetMute(t,e){}channelSetSolo(t,e){}resetChannelStates(){}channelSetMixVolume(t,e){}hasSamplesForProgram(t){return!0}hasSamplesForPercussion(t){return!0}}class wo extends ja{constructor(t,e){super(t,new bl,e),this.synthesizer.output=t,this._backingTrackOutput=t,t.timeUpdate.on(s=>{const i=this.sequencer.mainTimePositionFromBackingTrack(s,t.backingTrackDuration);this.sequencer.fillMidiEventQueueToEndTime(i),this.synthesizer.fakeSynthesize(),this.updateTimePosition(i,!1),this.checkForFinish()})}updateMasterVolume(t){super.updateMasterVolume(t),this._backingTrackOutput.masterVolume=t}updatePlaybackSpeed(t){super.updatePlaybackSpeed(t),this._backingTrackOutput.playbackRate=t}onSampleRequest(){}loadMidiFile(t){this.isSoundFontLoaded||(this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger()),super.loadMidiFile(t)}updateTimePosition(t,e){super.updateTimePosition(t,e),e&&this._backingTrackOutput.seekTo(this.sequencer.mainTimePositionToBackingTrack(t,this._backingTrackOutput.backingTrackDuration))}loadBackingTrack(t){const e=t.backingTrack;e&&(this._backingTrackOutput.loadBackingTrack(e),this.timePosition=0)}updateSyncPoints(t){this.sequencer.mainUpdateSyncPoints(t),this.tickPosition=this.tickPosition}}class Sl{constructor(){this.sampleRate=44100,this._seekPosition=0,this.ready=new it,this.samplesPlayed=new pe,this.timeUpdate=new pe,this.sampleRequest=new it}get handler(){return this._handler}set handler(t){t&&0!==this._seekPosition&&(t.seekTo(this._seekPosition),this._seekPosition=0),this._handler=t}get backingTrackDuration(){return this.handler?.backingTrackDuration??0}get playbackRate(){return this.handler?.playbackRate??1}set playbackRate(t){const e=this.handler;e&&(e.playbackRate=t)}get masterVolume(){return this.handler?.masterVolume??1}set masterVolume(t){const e=this.handler;e&&(e.masterVolume=t)}seekTo(t){const e=this.handler;e?e.seekTo(t):this._seekPosition=t}loadBackingTrack(t){}open(t){this.ready.trigger()}updatePosition(t){this.timeUpdate.trigger(t)}play(){this.handler?.play()}destroy(){}pause(){this.handler?.pause()}addSamples(t){}resetSamples(){}activate(){}enumerateOutputDevices(){return(0,dt.A)(function*(){return[]})()}setOutputDevice(t){return(0,dt.A)(function*(){})()}getOutputDevice(){return(0,dt.A)(function*(){return null})()}}class wl extends wo{get handler(){return this.output.handler}set handler(t){this.output.handler=t}constructor(t){super(new Sl,t)}}class kl{constructor(){this._masterVolume=1,this._metronomeVolume=0,this._countInVolume=0,this._playbackSpeed=1,this._isLooping=!1,this._midiEventsPlayedFilter=[],this.finished=new it,this.soundFontLoaded=new it,this.soundFontLoadFailed=new pe,this.midiLoadFailed=new pe,this.midiEventsPlayed=new pe,this.ready=new it(()=>this.isReady),this.readyForPlayback=new it(()=>this.isReadyForPlayback),this.midiLoaded=new pe(()=>this._instance?.loadedMidiInfo??null),this.stateChanged=new pe(()=>new bi(this.state,!1)),this.positionChanged=new pe(()=>this.currentPosition),this.playbackRangeChanged=new pe(()=>{const t=this.playbackRange;return t?new rr(t):null})}get instance(){return this._instance}set instance(t){this._instance=t;const e=this._instanceEventUnregister;if(e)for(const s of e)s();if(t){const s=[];s.push(t.ready.on(()=>this.ready.trigger())),s.push(t.readyForPlayback.on(()=>this.readyForPlayback.trigger())),s.push(t.finished.on(()=>this.finished.trigger())),s.push(t.soundFontLoaded.on(()=>this.soundFontLoaded.trigger())),s.push(t.soundFontLoadFailed.on(i=>this.soundFontLoadFailed.trigger(i))),s.push(t.midiLoaded.on(i=>{this.midiLoaded.trigger(i)})),s.push(t.midiLoadFailed.on(i=>this.midiLoadFailed.trigger(i))),s.push(t.stateChanged.on(i=>this.stateChanged.trigger(i))),s.push(t.positionChanged.on(i=>{this.positionChanged.trigger(i)})),s.push(t.midiEventsPlayed.on(i=>this.midiEventsPlayed.trigger(i))),s.push(t.playbackRangeChanged.on(i=>this.playbackRangeChanged.trigger(i))),this._instanceEventUnregister=s,this.isReady?(t.masterVolume=this._masterVolume,t.metronomeVolume=this._metronomeVolume,t.countInVolume=this._countInVolume,t.playbackSpeed=this._playbackSpeed,t.isLooping=this._isLooping,t.midiEventsPlayedFilter=this._midiEventsPlayedFilter,this.ready.trigger()):s.push(t.ready.on(()=>{t.masterVolume=this._masterVolume,t.metronomeVolume=this._metronomeVolume,t.countInVolume=this._countInVolume,t.playbackSpeed=this._playbackSpeed,t.isLooping=this._isLooping,t.midiEventsPlayedFilter=this._midiEventsPlayedFilter}))}else this._instanceEventUnregister=void 0}get output(){return this._instance.output}get isReady(){return!!this._instance&&this._instance.isReady}get isReadyForPlayback(){return!!this._instance&&this._instance.isReadyForPlayback}get state(){return this._instance?this._instance.state:wt.Paused}get logLevel(){return x.logLevel}set logLevel(t){x.logLevel=t,this._instance&&(this._instance.logLevel=t)}get masterVolume(){return this._masterVolume}set masterVolume(t){t=Math.max(t,q.MinVolume),this._masterVolume=t,this._instance&&(this._instance.masterVolume=t)}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(t){t=Math.max(t,q.MinVolume),this._metronomeVolume=t,this._instance&&(this._instance.metronomeVolume=t)}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(t){this._playbackSpeed=t,this._instance&&(this._instance.playbackSpeed=t)}get loadedMidiInfo(){return this._instance?this._instance.loadedMidiInfo:void 0}get currentPosition(){return this._instance?this._instance.currentPosition:new Fs(0,0,0,0,!1,120,120)}get tickPosition(){return this._instance?this._instance.tickPosition:0}set tickPosition(t){this._instance&&(this._instance.tickPosition=t)}get timePosition(){return this._instance?this._instance.timePosition:0}set timePosition(t){this._instance&&(this._instance.timePosition=t)}get playbackRange(){return this._instance?this._instance.playbackRange:null}set playbackRange(t){this._instance&&(this._instance.playbackRange=t)}get isLooping(){return this._isLooping}set isLooping(t){this._isLooping=t,this._instance&&(this._instance.isLooping=t)}get countInVolume(){return this._countInVolume}set countInVolume(t){this._countInVolume=t,this._instance&&(this._instance.countInVolume=t)}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(t){this._midiEventsPlayedFilter=t,this._instance&&(this._instance.midiEventsPlayedFilter=t)}destroy(){this._instance&&(this._instance.destroy(),this._instance=void 0)}play(){return!!this._instance&&this._instance.play()}pause(){this._instance&&this._instance.pause()}playPause(){this._instance&&this._instance.playPause()}stop(){this._instance&&this._instance.stop()}playOneTimeMidiFile(t){this._instance&&this._instance.playOneTimeMidiFile(t)}loadSoundFont(t,e){this._instance&&this._instance.loadSoundFont(t,e)}resetSoundFonts(){this._instance&&this._instance.resetSoundFonts()}loadMidiFile(t){this._instance&&this._instance.loadMidiFile(t)}loadBackingTrack(t){this._instance&&this._instance.loadBackingTrack(t)}updateSyncPoints(t){this._instance&&this._instance.updateSyncPoints(t)}applyTranspositionPitches(t){this._instance&&this._instance.applyTranspositionPitches(t)}setChannelTranspositionPitch(t,e){this._instance&&this._instance.setChannelTranspositionPitch(t,e)}setChannelMute(t,e){this._instance&&this._instance.setChannelMute(t,e)}resetChannelStates(){this._instance&&this._instance.resetChannelStates()}setChannelSolo(t,e){this._instance&&this._instance.setChannelSolo(t,e)}setChannelVolume(t,e){this._instance&&this._instance.setChannelVolume(t,e)}}class Bl{constructor(){this._width=0,this._score=null,this._trackIndexes=null,this.preRender=new pe,this.renderFinished=new pe,this.partialRenderFinished=new pe,this.partialLayoutFinished=new pe,this.postRenderFinished=new it,this.error=new pe}get instance(){return this._instance}set instance(t){this._instance=t;const e=this._instanceEventUnregister;if(e)for(const s of e)s();if(t){const s=[];s.push(t.preRender.on(i=>this.preRender.trigger(i))),s.push(t.renderFinished.on(i=>this.renderFinished.trigger(i))),s.push(t.partialRenderFinished.on(i=>this.partialRenderFinished.trigger(i))),s.push(t.partialLayoutFinished.on(i=>this.partialLayoutFinished.trigger(i))),s.push(t.postRenderFinished.on(()=>this.postRenderFinished.trigger())),s.push(t.error.on(i=>this.error.trigger(i))),this._instanceEventUnregister=s,this._settings&&t.updateSettings(this._settings),t.width=this._width,null!==this._score&&t.renderScore(this._score,this._trackIndexes)}else this._instanceEventUnregister=void 0}get boundsLookup(){return this._instance?this._instance.boundsLookup:null}get width(){return this._instance?this._instance.width:0}set width(t){this._width=t,this._instance&&(this._instance.width=t)}render(){this._instance?.render()}resizeRender(){this._instance?.resizeRender()}renderScore(t,e){this._score=t,this._trackIndexes=e,this._instance?.renderScore(t,e)}renderResult(t){this._instance?.renderResult(t)}updateSettings(t){this._settings=t,this._instance?.updateSettings(t)}destroy(){this._instance?.destroy(),this._instance=void 0}}class na{constructor(t){this.bounds=null,this.beat=t}}class _l{get actualPlayerMode(){return this._actualPlayerMode}get renderer(){return this._renderer}get score(){return this._score}get tracks(){return this._tracks}constructor(t,e){this._startTime=0,this._trackIndexes=null,this._trackIndexLookup=null,this._isDestroyed=!1,this._score=null,this._tracks=[],this._actualPlayerMode=Ot.Disabled,this._tickCache=null,this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null,this._previousTick=0,this._currentBeat=null,this._currentBeatBounds=null,this._isInitialBeatCursorUpdate=!0,this._previousStateForCursor=wt.Paused,this._previousCursorCache=null,this._lastScroll=0,this._beatMouseDown=!1,this._noteMouseDown=!1,this._selectionStart=null,this._selectionEnd=null,this.beatMouseDown=new pe,this.beatMouseMove=new pe,this.beatMouseUp=new pe,this.noteMouseDown=new pe,this.noteMouseMove=new pe,this.noteMouseUp=new pe,this.resize=new pe,this.renderStarted=new pe,this.renderFinished=new pe,this.postRenderFinished=new it,this.error=new pe,this.midiLoad=new pe,this.settingsUpdated=new it,this.uiFacade=t,this.container=t.rootContainer,this.activeBeatsChanged=new pe(()=>this._player.state===wt.Playing&&this._currentBeat?new ln(this._currentBeat.beatLookup.highlightedBeats.map(i=>i.beat)):null),this.playedBeatChanged=new pe(()=>this._player.state===wt.Playing&&this._currentBeat?this._currentBeat.beat:null),this.scoreLoaded=new pe(()=>this._score?this._score:null),this.midiLoaded=new pe(()=>this._player.loadedMidiInfo??null),t.initialize(this,e),x.logLevel=this.settings.core.logLevel,this.settings.handleBackwardsCompatibility(),_.printEnvironmentInfo(!1),this.canvasElement=t.createCanvasElement(),this.container.appendChild(this.canvasElement),this._renderer=new Bl,this._renderer.instance=this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&_.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this.uiFacade.createWorkerRenderer():new Hi(this.settings),this.container.resize.on(_.throttle(()=>{this._isDestroyed||this.container.width!==this._renderer.width&&this.triggerResize()},t.resizeThrottle));const s=new So;s.oldWidth=this._renderer.width,s.newWidth=0|this.container.width,s.settings=this.settings,this.onResize(s),this._renderer.preRender.on(this.onRenderStarted.bind(this)),this._renderer.renderFinished.on(i=>{this.onRenderFinished(i)}),this._renderer.postRenderFinished.on(()=>{const i=Date.now()-this._startTime;x.debug("rendering",`Rendering completed in ${i}ms`),this.onPostRenderFinished()}),this._renderer.preRender.on(i=>{this._startTime=Date.now()}),this._renderer.partialLayoutFinished.on(i=>this.appendRenderResult(i,!1)),this._renderer.partialRenderFinished.on(this.updateRenderResult.bind(this)),this._renderer.renderFinished.on(i=>{this.appendRenderResult(i,!0)}),this._renderer.error.on(this.onError.bind(this)),this.setupPlayerWrapper(),this.settings.player.playerMode!==Ot.Disabled&&this.setupOrDestroyPlayer(),this.setupClickHandling(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}setupPlayerWrapper(){const t=new kl;this._player=t,t.ready.on(()=>{this.loadMidiForScore()}),t.readyForPlayback.on(()=>{if(this.onPlayerReady(),this.tracks)for(const e of this.tracks){const s=e.playbackInfo.volume/16;t.setChannelVolume(e.playbackInfo.primaryChannel,s),t.setChannelVolume(e.playbackInfo.secondaryChannel,s)}}),t.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),t.soundFontLoadFailed.on(e=>{this.onError(e)}),t.midiLoaded.on(this.onMidiLoaded.bind(this)),t.midiLoadFailed.on(e=>{this.onError(e)}),t.stateChanged.on(this.onPlayerStateChanged.bind(this)),t.positionChanged.on(this.onPlayerPositionChanged.bind(this)),t.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),t.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),t.finished.on(this.onPlayerFinished.bind(this))}destroy(){this._isDestroyed=!0,this._player.destroy(),this.uiFacade.destroy(),this._renderer.destroy()}updateSettings(){this.settings.handleBackwardsCompatibility();const t=this.score;t&&O.applyPitchOffsets(this.settings,t),this.updateRenderer(),this._renderer.updateSettings(this.settings),this.setupOrDestroyPlayer(),this.onSettingsUpdated()}updateRenderer(){const t=this._renderer;this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&_.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?t.instance instanceof Hi&&(t.destroy(),t.instance=this.uiFacade.createWorkerRenderer()):t.instance instanceof Hi||(t.destroy(),t.instance=new Hi(this.settings))}load(t,e){try{return this.uiFacade.load(t,s=>{this.renderScore(s,e)},s=>{this.onError(s)})}catch(s){return this.onError(s),!1}}renderScore(t,e){const s=[];if(e)if(0===e.length)t.tracks.length>0&&s.push(t.tracks[0]);else if(1===e.length&&-1===e[0])for(const i of t.tracks)s.push(i);else for(const i of e)i>=0&&i<=t.tracks.length&&s.push(t.tracks[i]);else t.tracks.length>0&&s.push(t.tracks[0]);this.internalRenderTracks(t,s)}renderTracks(t){if(t.length>0){const e=t[0].score;for(const s of t)if(s.score!==e)return void this.onError(new Le(Fe.General,"All rendered tracks must belong to the same score."));this.internalRenderTracks(e,t)}}internalRenderTracks(t,e){if(O.applyPitchOffsets(this.settings,t),t!==this.score){this._score=t,this._tracks=e,this._tickCache=null,this._trackIndexes=[];for(const s of e)this._trackIndexes.push(s.index);this._trackIndexLookup=new Set(this._trackIndexes),this.onScoreLoaded(t),this.loadMidiForScore(),this.render()}else{this._tracks=e;const s=O.computeFirstDisplayedBarIndex(t,this.settings),i=O.computeLastDisplayedBarIndex(t,this.settings,s);this._tickCache&&(this._tickCache.multiBarRestInfo=O.buildMultiBarRestInfo(this.tracks,s,i)),this._trackIndexes=[];for(const a of e)this._trackIndexes.push(a.index);this._trackIndexLookup=new Set(this._trackIndexes),this.render()}}triggerResize(){if(this.container.isVisible){const t=new So;t.oldWidth=this._renderer.width,t.newWidth=this.container.width,t.settings=this.settings,this.onResize(t),this._renderer.updateSettings(this.settings),this._renderer.width=this.container.width,this._renderer.resizeRender()}else x.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{x.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()})}appendRenderResult(t,e){e&&(this.canvasElement.width=t.totalWidth,this.canvasElement.height=t.totalHeight,this._cursorWrapper&&(this._cursorWrapper.width=t.totalWidth,this._cursorWrapper.height=t.totalHeight)),(t.width>0||t.height>0)&&this.uiFacade.beginAppendRenderResults(t),e&&this.uiFacade.beginAppendRenderResults(null)}updateRenderResult(t){t&&t.renderResult&&this.uiFacade.beginUpdateRenderResults(t)}tex(t,e){try{const s=new Nr;s.logErrors=!0,s.initFromString(t,this.settings);const i=s.readScore();this.renderScore(i,e)}catch(s){this.onError(s)}}loadSoundFont(t,e=!1){return this.uiFacade.loadSoundFont(t,e)}resetSoundFonts(){this._player.resetSoundFonts()}render(){this.uiFacade.canRender?(this._renderer.width=this.container.width,this._renderer.renderScore(this.score,this._trackIndexes)):this.uiFacade.canRenderChanged.on(()=>this.render())}get tickCache(){return this._tickCache}get boundsLookup(){return this._renderer.boundsLookup}get player(){return this._player.instance?this._player:null}get isReadyForPlayback(){return this._player.isReadyForPlayback}get playerState(){return this._player.state}get masterVolume(){return this._player.masterVolume}set masterVolume(t){this._player.masterVolume=t}get metronomeVolume(){return this._player.metronomeVolume}set metronomeVolume(t){this._player.metronomeVolume=t}get countInVolume(){return this._player.countInVolume}set countInVolume(t){this._player.countInVolume=t}get midiEventsPlayedFilter(){return this._player.midiEventsPlayedFilter}set midiEventsPlayedFilter(t){this._player.midiEventsPlayedFilter=t}get tickPosition(){return this._player.tickPosition}set tickPosition(t){this._player.tickPosition=t}get timePosition(){return this._player.timePosition}set timePosition(t){this._player.timePosition=t}get endTick(){return this._player.currentPosition.endTick}get endTime(){return this._player.currentPosition.endTime}get playbackRange(){return this._player.playbackRange}set playbackRange(t){this._player.playbackRange=t,this.updateSelectionCursor(t)}get playbackSpeed(){return this._player.playbackSpeed}set playbackSpeed(t){this._player.playbackSpeed=t}get isLooping(){return this._player.isLooping}set isLooping(t){this._player.isLooping=t}destroyPlayer(){this._player.destroy(),this._previousTick=0,this.destroyCursors()}setupOrDestroyPlayer(){let t=this.settings.player.playerMode;if(t===Ot.EnabledAutomatic){const s=this.score;if(!s)return!1;t=s?.backingTrack?.rawAudioFile?Ot.EnabledBackingTrack:Ot.EnabledSynthesizer}let e=null;if(t===this._actualPlayerMode)return this.updateCursors(),!1;switch(this.destroyPlayer(),this.updateCursors(),t){case Ot.Disabled:e=null;break;case Ot.EnabledSynthesizer:e=this.uiFacade.createWorkerPlayer();break;case Ot.EnabledBackingTrack:e=this.uiFacade.createBackingTrackPlayer();break;case Ot.EnabledExternalMedia:e=new wl(this.settings.player.bufferTimeInMilliseconds)}return this._actualPlayerMode=t,e&&(this._player.instance=e),!1}loadMidiForScore(){if(!this.score)return;const t=this.score;x.debug("AlphaTab","Generating Midi");const e=new Ls,s=new us(e),i=new ne(t,this.settings,s),a=O.computeFirstDisplayedBarIndex(t,this.settings),n=O.computeLastDisplayedBarIndex(t,this.settings,a);i.tickLookup.multiBarRestInfo=O.buildMultiBarRestInfo(this.tracks,a,n),i.applyTranspositionPitches=!1,i.generate(),this._tickCache=i.tickLookup,this.onMidiLoad(e);const o=this._player;o.loadMidiFile(e),o.loadBackingTrack(t),o.updateSyncPoints(i.syncPoints),o.applyTranspositionPitches(i.transpositionPitches)}updateSyncPoints(){this.score&&this._player.updateSyncPoints(ne.generateSyncPoints(this.score))}changeTrackVolume(t,e){for(const s of t)this._player.setChannelVolume(s.playbackInfo.primaryChannel,e),this._player.setChannelVolume(s.playbackInfo.secondaryChannel,e)}changeTrackSolo(t,e){for(const s of t)this._player.setChannelSolo(s.playbackInfo.primaryChannel,e),this._player.setChannelSolo(s.playbackInfo.secondaryChannel,e)}changeTrackMute(t,e){for(const s of t)this._player.setChannelMute(s.playbackInfo.primaryChannel,e),this._player.setChannelMute(s.playbackInfo.secondaryChannel,e)}changeTrackTranspositionPitch(t,e){for(const s of t)this._player.setChannelTranspositionPitch(s.playbackInfo.primaryChannel,e),this._player.setChannelTranspositionPitch(s.playbackInfo.secondaryChannel,e)}play(){return this._player.play()}pause(){this._player.pause()}playPause(){this._player.playPause()}stop(){this._player.stop()}playBeat(t){const e=new Ls,s=new us(e);new ne(t.voice.bar.staff.track.score,this.settings,s).generateSingleBeat(t),this._player.playOneTimeMidiFile(e)}playNote(t){const e=new Ls,s=new us(e);new ne(t.beat.voice.bar.staff.track.score,this.settings,s).generateSingleNote(t),this._player.playOneTimeMidiFile(e)}destroyCursors(){this._cursorWrapper&&(this.uiFacade.destroyCursors(),this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null)}updateCursors(){const t=this.hasCursor;if(t&&!this._cursorWrapper){const e=this.uiFacade.createCursors();e&&(this._cursorWrapper=e.cursorWrapper,this._barCursor=e.barCursor,this._beatCursor=e.beatCursor,this._selectionWrapper=e.selectionWrapper,this._isInitialBeatCursorUpdate=!0),null!==this._currentBeat&&this.cursorUpdateBeat(this._currentBeat,!1,this._previousTick>10,1,!0)}else!t&&this._cursorWrapper&&this.destroyCursors()}cursorUpdateTick(t,e,s,i=!1,a=!1){this._previousTick=t;const n=this._tickCache;if(n){const o=this._trackIndexLookup;if(null!=o&&o.size>0){const h=n.findBeat(o,t,this._currentBeat);h&&this.cursorUpdateBeat(h,e,i,s,a||this.playerState===wt.Paused)}}}cursorUpdateBeat(t,e,s,i,a=!1){const n=t.beat,o=t.nextBeat?.beat??null,h=t.duration,c=t.beatLookup.highlightedBeats;if(!n)return;const d=this._renderer.boundsLookup;if(!d)return;const u=this._currentBeat,f=this._previousCursorCache,p=this._previousStateForCursor;if(!a&&n===u?.beat&&d===f&&p===this._player.state&&u?.start===t.start)return;const g=d.findBeat(n);g&&(this._currentBeat=t,this._previousCursorCache=d,this._previousStateForCursor=this._player.state,this.uiFacade.beginInvoke(()=>{this.internalCursorUpdateBeat(n,o,h,e,c,d,g,s,t.cursorMode,i)}))}scrollToCursor(){const t=this._currentBeatBounds;t&&this.internalScrollToCursor(t.barBounds.masterBarBounds)}internalScrollToCursor(t){const e=this.uiFacade.getScrollContainer(),s=_.getLayoutEngineFactory(this.settings.display.layoutMode).vertical,i=this.settings.player.scrollMode;if(s){const a=t.realBounds.y+this.settings.player.scrollOffsetY;if(a!==this._lastScroll)switch(this._lastScroll=a,i){case ei.Continuous:const n=this.uiFacade.getOffset(e,this.container);this.uiFacade.scrollToY(e,n.y+a,this.settings.player.scrollSpeed);break;case ei.OffScreen:const o=e.scrollTop+this.uiFacade.getOffset(null,e).h;(t.visualBounds.y+t.visualBounds.h>=o||t.visualBounds.y<e.scrollTop)&&this.uiFacade.scrollToY(e,t.realBounds.y+this.settings.player.scrollOffsetY,this.settings.player.scrollSpeed)}}else{const a=t.visualBounds.x;if(a!==this._lastScroll)switch(this._lastScroll=a,i){case ei.Continuous:const n=t.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=t.visualBounds.x,this.uiFacade.scrollToX(e,n,this.settings.player.scrollSpeed);break;case ei.OffScreen:const o=e.scrollLeft+this.uiFacade.getOffset(null,e).w;if(t.visualBounds.x+t.visualBounds.w>=o||t.visualBounds.x<e.scrollLeft){const h=t.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=t.visualBounds.x,this.uiFacade.scrollToX(e,h,this.settings.player.scrollSpeed)}}}}internalCursorUpdateBeat(t,e,s,i,a,n,o,h,c,d){const u=this._barCursor,f=this._beatCursor,p=o.barBounds.masterBarBounds,g=p.visualBounds,b=this._currentBeatBounds;this._currentBeatBounds=o,u&&u.setBounds(g.x,g.y,g.w,g.h);const w=this._player.state===wt.Playing&&!i;let S=p.visualBounds.x+p.visualBounds.w;if(e&&c===ns.ToNextBext){const L=n.findBeat(e);L&&L.barBounds.masterBarBounds.staffSystemBounds===p.staffSystemBounds&&(S=L.onNotesX)}let D=o.onNotesX;if(f){if(this.settings.player.enableAnimatedBeatCursor){const E=this._currentBeat.tickDuration>0?(this._previousTick-this._currentBeat.start)/this._currentBeat.tickDuration:0;D=o.onNotesX+(S-o.onNotesX)*E,s-=s*E,w?((!b||this._isInitialBeatCursorUpdate||g.y!==b.barBounds.masterBarBounds.visualBounds.y||D<b.onNotesX||p.index>b.barBounds.masterBarBounds.index+1)&&(f.transitionToX(0,D),f.setBounds(D,g.y,1,g.h)),this.uiFacade.beginInvoke(()=>{const ie=c===ns.ToNextBext?2:1;f.transitionToX(s/d*ie,D+(S-D)*ie)})):(f.transitionToX(0,D),f.setBounds(D,g.y,1,g.h))}else f.transitionToX(0,D),f.setBounds(D,g.y,1,g.h);this._isInitialBeatCursorUpdate=!1}else this._isInitialBeatCursorUpdate=!0;this.uiFacade.removeHighlights();let N=!1;if(w){if(this.settings.player.enableElementHighlighting)for(const L of a){const $=bs.getGroupId(L.beat);this.uiFacade.highlightElements($,t.voice.bar.index)}h=!i,N=!0}h&&!this._beatMouseDown&&this.settings.player.scrollMode!==ei.Off&&this.internalScrollToCursor(p),N&&(this.onPlayedBeatChanged(t),this.onActiveBeatsChanged(new ln(a.map(L=>L.beat))))}onPlayedBeatChanged(t){this._isDestroyed||(this.playedBeatChanged.trigger(t),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",t))}onActiveBeatsChanged(t){this._isDestroyed||(this.activeBeatsChanged.trigger(t),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",t))}get hasCursor(){return this.settings.player.playerMode!==Ot.Disabled&&this.settings.player.enableCursor}onBeatMouseDown(t,e){this._isDestroyed||(this.hasCursor&&this.settings.player.enableUserInteraction&&(this._selectionStart=new na(e),this._selectionEnd=null),this._beatMouseDown=!0,this.beatMouseDown.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseDown",e,t))}onNoteMouseDown(t,e){this._isDestroyed||(this._noteMouseDown=!0,this.noteMouseDown.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseDown",e,t))}onBeatMouseMove(t,e){this._isDestroyed||(this.settings.player.enableUserInteraction&&(!this._selectionEnd||this._selectionEnd.beat!==e)&&(this._selectionEnd=new na(e),this.cursorSelectRange(this._selectionStart,this._selectionEnd)),this.beatMouseMove.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseMove",e,t))}onNoteMouseMove(t,e){this._isDestroyed||(this.noteMouseMove.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseMove",e,t))}onBeatMouseUp(t,e){if(!this._isDestroyed){if(this.hasCursor&&this.settings.player.enableUserInteraction){if(this._selectionEnd){const s=this._tickCache?.getBeatStart(this._selectionStart.beat)??this._selectionStart.beat.absolutePlaybackStart;if((this._tickCache?.getBeatStart(this._selectionEnd.beat)??this._selectionEnd.beat.absolutePlaybackStart)<s){const a=this._selectionStart;this._selectionStart=this._selectionEnd,this._selectionEnd=a}}if(this._selectionStart&&this._tickCache){const s=this._tickCache,i=s.getMasterBarStart(this._selectionStart.beat.voice.bar.masterBar);if(this._currentBeat=null,this._player.state===wt.Paused&&this.cursorUpdateTick(this._tickCache.getBeatStart(this._selectionStart.beat),!1,1),this.tickPosition=i+this._selectionStart.beat.playbackStart,this._selectionEnd&&this._selectionStart.beat!==this._selectionEnd.beat){const a=s.getMasterBarStart(this._selectionEnd.beat.voice.bar.masterBar),n=new bo;n.startTick=i+this._selectionStart.beat.playbackStart,n.endTick=a+this._selectionEnd.beat.playbackStart+this._selectionEnd.beat.playbackDuration-50,this.playbackRange=n}else this._selectionStart=null,this.playbackRange=null,this.cursorSelectRange(this._selectionStart,this._selectionEnd)}}this.beatMouseUp.trigger(e),this.uiFacade.triggerEvent(this.container,"beatMouseUp",e,t),this._beatMouseDown=!1}}onNoteMouseUp(t,e){this._isDestroyed||(this.noteMouseUp.trigger(e),this.uiFacade.triggerEvent(this.container,"noteMouseUp",e,t),this._noteMouseDown=!1)}updateSelectionCursor(t){if(this._tickCache)if(t){const e=this._tickCache.findBeat(this._trackIndexLookup,t.startTick),s=this._tickCache.findBeat(this._trackIndexLookup,t.endTick);if(e&&s){const i=new na(e.beat),a=new na(s.beat);this.cursorSelectRange(i,a)}}else this.cursorSelectRange(null,null)}setupClickHandling(){this.canvasElement.mouseDown.on(t=>{if(!t.isLeftMouseButton)return;this.settings.player.enableUserInteraction&&t.preventDefault();const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(e,s)??null;if(i&&(this.onBeatMouseDown(t,i),this.settings.core.includeNoteBounds)){const a=this._renderer.boundsLookup?.getNoteAtPos(i,e,s);a&&this.onNoteMouseDown(t,a)}}),this.canvasElement.mouseMove.on(t=>{if(!this._beatMouseDown)return;const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(e,s)??null;if(i&&(this.onBeatMouseMove(t,i),this._noteMouseDown)){const a=this._renderer.boundsLookup?.getNoteAtPos(i,e,s);a&&this.onNoteMouseMove(t,a)}}),this.canvasElement.mouseUp.on(t=>{if(!this._beatMouseDown)return;this.settings.player.enableUserInteraction&&t.preventDefault();const e=t.getX(this.canvasElement),s=t.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(e,s)??null;if(this.onBeatMouseUp(t,i),this._noteMouseDown)if(i){const a=this._renderer.boundsLookup?.getNoteAtPos(i,e,s)??null;this.onNoteMouseUp(t,a)}else this.onNoteMouseUp(t,null)}),this._renderer.postRenderFinished.on(()=>{!this._selectionStart||!this.hasCursor||!this.settings.player.enableUserInteraction||this.cursorSelectRange(this._selectionStart,this._selectionEnd)})}cursorSelectRange(t,e){const s=this._renderer.boundsLookup;if(!s)return;const i=this._selectionWrapper;if(!i||(i.clear(),!t||!e||t.beat===e.beat))return;t.bounds||(t.bounds=s.findBeat(t.beat)),e.bounds||(e.bounds=s.findBeat(e.beat));const a=this._tickCache?.getBeatStart(t.beat)??t.beat.absolutePlaybackStart;if((this._tickCache?.getBeatStart(e.beat)??e.beat.absolutePlaybackStart)<a){const c=t;t=e,e=c}const o=t.bounds.realBounds.x;let h=e.bounds.realBounds.x+e.bounds.realBounds.w;if(e.beat.index===e.beat.voice.beats.length-1&&(h=e.bounds.barBounds.masterBarBounds.realBounds.x+e.bounds.barBounds.masterBarBounds.realBounds.w),t.bounds.barBounds.masterBarBounds.staffSystemBounds!==e.bounds.barBounds.masterBarBounds.staffSystemBounds){const c=t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x,d=t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x+t.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.w,u=this.uiFacade.createSelectionElement();u.setBounds(o,t.bounds.barBounds.masterBarBounds.visualBounds.y,d-o,t.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(u);const p=e.bounds.barBounds.masterBarBounds.staffSystemBounds.index;for(let b=t.bounds.barBounds.masterBarBounds.staffSystemBounds.index+1;b<p;b++){const w=s.staffSystems[b],S=this.uiFacade.createSelectionElement();S.setBounds(c,w.visualBounds.y,d-c,w.visualBounds.h),i.appendChild(S)}const g=this.uiFacade.createSelectionElement();g.setBounds(c,e.bounds.barBounds.masterBarBounds.visualBounds.y,h-c,e.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(g)}else{const c=this.uiFacade.createSelectionElement();c.setBounds(o,t.bounds.barBounds.masterBarBounds.visualBounds.y,h-o,t.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(c)}}onScoreLoaded(t){this._isDestroyed||(this.scoreLoaded.trigger(t),this.uiFacade.triggerEvent(this.container,"scoreLoaded",t),this.setupOrDestroyPlayer()||this.loadMidiForScore())}onResize(t){this._isDestroyed||(this.resize.trigger(t),this.uiFacade.triggerEvent(this.container,"resize",t))}onRenderStarted(t){this._isDestroyed||(this.renderStarted.trigger(t),this.uiFacade.triggerEvent(this.container,"renderStarted",t))}onRenderFinished(t){this._isDestroyed||(this.renderFinished.trigger(t),this.uiFacade.triggerEvent(this.container,"renderFinished",t))}onPostRenderFinished(){this._isDestroyed||(this._currentBeat=null,this.cursorUpdateTick(this._previousTick,!1,1,!0,!0),this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}onError(t){this._isDestroyed||(x.error("API","An unexpected error occurred",t),this.error.trigger(t),this.uiFacade.triggerEvent(this.container,"error",t))}get playerReady(){return this._player.readyForPlayback}onPlayerReady(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerReady",null)}get playerFinished(){return this._player.finished}onPlayerFinished(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerFinished",null)}get soundFontLoaded(){return this._player.soundFontLoaded}onSoundFontLoaded(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null)}onMidiLoad(t){this._isDestroyed||(this.midiLoad.trigger(t),this.uiFacade.triggerEvent(this.container,"midiLoad",t))}onMidiLoaded(t){this._isDestroyed||(this.midiLoaded.trigger(t),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",t))}get playerStateChanged(){return this._player.stateChanged}onPlayerStateChanged(t){if(!this._isDestroyed){if(!t.stopped&&t.state===wt.Paused){const e=this._currentBeat,s=this._tickCache;e&&s&&(this._player.tickPosition=s.getBeatStart(e.beat))}this.uiFacade.triggerEvent(this.container,"playerStateChanged",t)}}get playerPositionChanged(){return this._player.positionChanged}onPlayerPositionChanged(t){this._isDestroyed||(this._previousTick=t.currentTick,this.uiFacade.beginInvoke(()=>{this.cursorUpdateTick(t.currentTick,!1,t.modifiedTempo/t.originalTempo,!1,t.isSeek)}),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",t))}get midiEventsPlayed(){return this._player.midiEventsPlayed}onMidiEventsPlayed(t){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",t)}get playbackRangeChanged(){return this._player.playbackRangeChanged}onPlaybackRangeChanged(t){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",t)}onSettingsUpdated(){this._isDestroyed||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}enumerateOutputDevices(){var t=this;return(0,dt.A)(function*(){return yield t._player.output.enumerateOutputDevices()})()}setOutputDevice(t){var e=this;return(0,dt.A)(function*(){yield e._player.output.setOutputDevice(t)})()}getOutputDevice(){var t=this;return(0,dt.A)(function*(){return yield t._player.output.getOutputDevice()})()}exportAudio(t){var e=this;return(0,dt.A)(function*(){if(!e.score)throw new Le(Fe.General,"No song loaded");let s;s=e.uiFacade.createWorkerAudioExporter(e._actualPlayerMode===Ot.EnabledSynthesizer?e._player.instance:null);const i=e.score,a=new Ls,n=new us(a),o=new ne(i,e.settings,n);o.applyTranspositionPitches=!1,o.generate();const h=new uo;h.soundFonts=t.soundFonts,h.sampleRate=t.sampleRate,h.useSyncPoints=t.useSyncPoints,h.masterVolume=t.masterVolume,h.metronomeVolume=t.metronomeVolume,h.playbackRange=t.playbackRange;for(const[c,d]of t.trackVolume)if(c<e.score.tracks.length){const u=e.score.tracks[c];h.trackVolume.set(u.playbackInfo.primaryChannel,d),h.trackVolume.set(u.playbackInfo.secondaryChannel,d)}for(const[c,d]of t.trackTranspositionPitches)if(c<e.score.tracks.length){const u=e.score.tracks[c];h.trackTranspositionPitches.set(u.playbackInfo.primaryChannel,d),h.trackTranspositionPitches.set(u.playbackInfo.secondaryChannel,d)}return yield s.initialize(h,a,o.syncPoints,o.transpositionPitches),s})()}}class Us extends Le{constructor(t,e){super(Fe.General,t),this.xhr=e,Object.setPrototypeOf(this,Us.prototype)}}class ki{static loadAlphaTex(t,e){const s=new Nr;return s.logErrors=!0,s.initFromString(t,e??new Gs),s.readScore()}static loadScoreAsync(t,e,s,i){const a=new XMLHttpRequest;a.open("GET",t,!0,null,null),a.responseType="arraybuffer",a.onreadystatechange=()=>{if(a.readyState===XMLHttpRequest.DONE)if(200===a.status||0===a.status&&a.response)try{const h=new Uint8Array(a.response),c=ki.loadScoreFromBytes(h,i);e(c)}catch(o){s(o)}else s(new Us(0===a.status?"You are offline!!\n Please Check Your Network.":404===a.status?"Requested URL not found.":500===a.status?"Internel Server Error.":"parsererror"===a.statusText?"Error.\nParsing JSON Request failed.":"timeout"===a.statusText?"Request Time out.":`Unknow Error: ${a.responseText}`,a))},a.send()}static loadScoreFromBytes(t,e){e||(e=new Gs);const s=_.buildImporters();x.debug("ScoreLoader",`Loading score from ${t.length} bytes using ${s.length} importers`);let i=null;const a=Ke.fromBuffer(t);for(const n of s){a.reset();try{x.debug("ScoreLoader",`Importing using importer ${n.name}`),n.init(a,e),i=n.readScore(),x.debug("ScoreLoader",`Score imported using ${n.name}`);break}catch(o){if(!(o instanceof st))throw x.error("ScoreLoader","Score import failed due to unexpected error: ",o),o;x.debug("ScoreLoader",`${n.name} does not support the file`)}}if(i)return i;throw new st("No compatible importer found for file")}}class cn{get isLeftMouseButton(){return 0===this.mouseEvent.button}getX(t){const e=t.element,i=e.getBoundingClientRect().left+e.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-i}getY(t){const e=t.element,i=e.getBoundingClientRect().top+e.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-i}preventDefault(){this.mouseEvent.preventDefault()}constructor(t){this.mouseEvent=t}}class Is{get width(){return this.element.offsetWidth}set width(t){this.element.style.width=`${t}px`}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(t){this.element.scrollLeft=t}get scrollTop(){return this.element.scrollTop}set scrollTop(t){this.element.scrollTop=t}get height(){return this.element.offsetHeight}set height(t){this.element.style.height=t>=0?`${t}px`:"100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}constructor(t){this._resizeListeners=0,this.lastBounds=new St,this.element=t,this.mouseDown={on:s=>{const i=a=>{s(new cn(a))};return this.element.addEventListener("mousedown",i,!0),()=>{this.element.removeEventListener("mousedown",i,!0)}},off:s=>{}},this.mouseUp={on:s=>{const i=a=>{s(new cn(a))};return this.element.addEventListener("mouseup",i,!0),()=>{this.element.removeEventListener("mouseup",i,!0)}},off:s=>{}},this.mouseMove={on:s=>{const i=a=>{s(new cn(a))};return this.element.addEventListener("mousemove",i,!0),()=>{this.element.removeEventListener("mousemove",i,!0)}},off:s=>{}};const e=this;this.resize={on:function(s){return 0===e._resizeListeners&&Is.resizeObserver.value.observe(e.element),e.element.addEventListener("resize",s,!0),e._resizeListeners++,()=>this.off(s)},off:s=>{this.element.removeEventListener("resize",s,!0),this._resizeListeners--,this._resizeListeners<=0&&(this._resizeListeners=0,Is.resizeObserver.value.unobserve(this.element))}}}stopAnimation(){this.element.style.transition="none"}transitionToX(t,e){this.element.style.transition=`transform ${t}ms linear`,this.setBounds(e,Number.NaN,Number.NaN,Number.NaN)}setBounds(t,e,s,i){Number.isNaN(t)&&(t=this.lastBounds.x),Number.isNaN(e)&&(e=this.lastBounds.y),Number.isNaN(s)&&(s=this.lastBounds.w),Number.isNaN(i)&&(i=this.lastBounds.h),this.element.style.transform=`translate(${t}px, ${e}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=t,this.lastBounds.y=e,this.lastBounds.w=s,this.lastBounds.h=i}appendChild(t){this.element.appendChild(t.element)}clear(){this.element.innerHTML=""}}Is.resizeObserver=new Ji(()=>new ResizeObserver(r=>{for(const t of r){const e=new CustomEvent("resize",{detail:t});t.target.dispatchEvent(e)}}));class ko{constructor(t){this._isStarted=!1,this.isFontLoaded=!1,this.fontLoaded=new pe,this._originalFamilies=t,this._families=t}checkForFontAvailability(){var t=this;if(_.isRunningInWorker)return void(this.isFontLoaded=!1);if(this._isStarted)return;this._isStarted=!0;let e=0;const s=window.setInterval(()=>{x.warning("Rendering",`Could not load font '${this._families[0]}' within ${5*(e+1)} seconds`,null),this._families.length>1?(this._families.shift(),e=0):e++},5e3);x.debug("Font",`Start checking for font availablility: ${this._families.join(", ")}`);const i=o=>{this._families.length>1?(x.debug("Font",`[${this._families[0]}] Loading Failed, switching to ${this._families[1]}`,o),this._families.shift(),window.setTimeout(()=>{n()},0)):(x.error("Font",`[${this._originalFamilies.join(",")}] Loading Failed, rendering cannot start`,o),window.clearInterval(s))},a=o=>{x.debug("Font",`[${o}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(s),this.fontLoaded.trigger(this._families[0])},n=function(){var o=(0,dt.A)(function*(){for(const h of t._families)if(yield t.isFontAvailable(h,!1))return void a(h);try{yield document.fonts.load(`1em ${t._families[0]}`)}catch(h){i(h)}return x.debug("Font",`[${t._families[0]}] Font API signaled loaded`),(yield t.isFontAvailable(t._families[0],!0))?a(t._families[0]):i("Font not available"),!0});return function(){return o.apply(this,arguments)}}();document.fonts.ready.then(()=>{n()})}isFontAvailable(t,e){return new Promise(s=>{const i=`1em ${t}`;if(document.fonts.check(i))s(!0);else if(e){x.debug("Font",`Font ${t} not available, creating test element to trigger load`);const a=document.createElement("div");a.style.font=i,a.style.opacity="0",a.style.position="absolute",a.style.top="0",a.style.left="0",a.innerText=`Trigger ${t} load`,document.body.appendChild(a),setTimeout(()=>{document.body.removeChild(a),document.fonts.check(i)?s(!0):s(!1)},200)}else s(!1)})}}class dn{constructor(t){this._writePosition=0,this._readPosition=0,this.count=0,this._buffer=new Float32Array(t)}clear(){this._readPosition=0,this._writePosition=0,this.count=0,this._buffer=new Float32Array(this._buffer.length)}write(t,e,s){let i=0;s>this._buffer.length-this.count&&(s=this._buffer.length-this.count);const a=Math.min(this._buffer.length-this._writePosition,s);return this._buffer.set(t.subarray(e,e+a),this._writePosition),this._writePosition+=a,this._writePosition%=this._buffer.length,i+=a,i<s&&(this._buffer.set(t.subarray(e+i,e+i+s-i),this._writePosition),this._writePosition+=s-i,i=s),this.count+=i,i}read(t,e,s){s>this.count&&(s=this.count);let i=0;const a=Math.min(this._buffer.length-this._readPosition,s);return t.set(this._buffer.subarray(this._readPosition,this._readPosition+a),e),i+=a,this._readPosition+=a,this._readPosition%=this._buffer.length,i<s&&(t.set(this._buffer.subarray(this._readPosition,this._readPosition+s-i),e+i),this._readPosition+=s-i,i=s),this.count-=i,i}}class Tl{constructor(t){this.isDefault=!1,this.device=t}get deviceId(){return this.device.deviceId}get label(){return this.device.label}}let Ss=(()=>{class r{static findKnownDevice(e){return r._knownDevices.find(s=>s.deviceId===e)}static createAudioContext(){if("AudioContext"in _.globalThis)return new AudioContext;if("webkitAudioContext"in _.globalThis)return new webkitAudioContext;throw new Le(Fe.General,"AudioContext not found")}static checkSinkIdSupport(){return(0,dt.A)(function*(){return"setSinkId"in r.createAudioContext()||(x.warning("WebAudio","Browser does not support changing the output device"),!1)})()}static enumerateOutputDevices(){return(0,dt.A)(function*(){try{if(!(yield r.checkSinkIdSupport()))return[];try{yield navigator.mediaDevices.getUserMedia({audio:!0})}catch(h){x.warning("WebAudio","Output device permission rejected",h)}const e=yield navigator.mediaDevices.enumerateDevices();let s="",i="";const a=new Map;for(const h of e)"audiooutput"===h.kind&&(a.set(h.groupId,new Tl(h)),("default"===h.deviceId||""===h.deviceId)&&(s=h.groupId,i=h.deviceId));const n=Array.from(a.values());let o=n.find(h=>h.deviceId===i);return o||(o=n.find(h=>h.device.groupId===s)),!o&&n.length>0&&(o=n[0]),o&&(o.isDefault=!0),r._knownDevices=n,n}catch(e){return x.error("WebAudio","Failed to enumerate output devices",e),[]}})()}}return r._knownDevices=[],r})(),Bi=(()=>{class r{constructor(){this._context=null,this._buffer=null,this._source=null,this.ready=new it,this.samplesPlayed=new pe,this.sampleRequest=new it}get sampleRate(){return this._context?this._context.sampleRate:r.PreferredSampleRate}activate(e){this._context||(this._context=Ss.createAudioContext()),("suspended"===this._context.state||"interrupted"===this._context.state)&&(x.debug("WebAudio","Audio Context is suspended, trying resume"),this._context.resume().then(()=>{x.debug("WebAudio",`Audio Context resume success: state=${this._context?.state}, sampleRate:${this._context?.sampleRate}`),e&&e()},s=>{x.warning("WebAudio",`Audio Context resume failed: state=${this._context?.state}, sampleRate:${this._context?.sampleRate}, reason=${s}`)}))}patchIosSampleRate(){const e=navigator.userAgent;if(-1!==e.indexOf("iPhone")||-1!==e.indexOf("iPad")){const s=Ss.createAudioContext(),i=s.createBuffer(1,1,r.PreferredSampleRate),a=s.createBufferSource();a.buffer=i,a.connect(s.destination),a.start(0),a.disconnect(0),s.close()}}open(e){this.patchIosSampleRate(),this._context=Ss.createAudioContext(),"suspended"===this._context.state&&this.registerResumeHandler()}registerResumeHandler(){this._resumeHandler=(()=>{this.activate(()=>{this.unregisterResumeHandler()})}).bind(this),document.body.addEventListener("touchend",this._resumeHandler,!1),document.body.addEventListener("click",this._resumeHandler,!1)}unregisterResumeHandler(){const e=this._resumeHandler;e&&(document.body.removeEventListener("touchend",e,!1),document.body.removeEventListener("click",e,!1))}play(){const e=this._context;this.activate(),this._buffer=e.createBuffer(2,r.BufferSize,e.sampleRate),this._source=e.createBufferSource(),this._source.buffer=this._buffer,this._source.loop=!0}pause(){this._source&&(this._source.stop(0),this._source.disconnect()),this._source=null}destroy(){this.pause(),this._context?.close(),this._context=null,this.unregisterResumeHandler()}onSamplesPlayed(e){this.samplesPlayed.trigger(e)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}enumerateOutputDevices(){return Ss.enumerateOutputDevices()}setOutputDevice(e){var s=this;return(0,dt.A)(function*(){(yield Ss.checkSinkIdSupport())&&(e?yield s._context.setSinkId(e.deviceId):yield s._context.setSinkId(""))})()}getOutputDevice(){var e=this;return(0,dt.A)(function*(){if(!(yield Ss.checkSinkIdSupport()))return null;const s=e._context.sinkId;if("string"!=typeof s||""===s||"default"===s)return null;let i=Ss.findKnownDevice(s);if(i)return i;const a=yield e.enumerateOutputDevices();return i=a.find(n=>n.deviceId===s),i||(x.warning("WebAudio","Could not find output device in device list",s,a),null)})()}}return r.BufferSize=4096,r.PreferredSampleRate=44100,r})();class Bo extends Bi{constructor(){super(...arguments),this._audioNode=null,this._bufferCount=0,this._requestedBufferCount=0,this._outputBuffer=new Float32Array(0)}open(t){super.open(t),this._bufferCount=Math.floor(t*this.sampleRate/1e3/Bi.BufferSize),this._circularBuffer=new dn(Bi.BufferSize*this._bufferCount),this.onReady()}play(){super.play();const t=this._context;this._audioNode=t.createScriptProcessor(4096,0,2),this._audioNode.onaudioprocess=this.generateSound.bind(this),this._circularBuffer.clear(),this.requestBuffers(),this._source=t.createBufferSource(),this._source.buffer=this._buffer,this._source.loop=!0,this._source.connect(this._audioNode,0,0),this._source.start(0),this._audioNode.connect(t.destination,0,0)}pause(){super.pause(),this._audioNode&&this._audioNode.disconnect(0),this._audioNode=null}addSamples(t){this._circularBuffer.write(t,0,t.length),this._requestedBufferCount--}resetSamples(){this._circularBuffer.clear()}requestBuffers(){const t=this._bufferCount/2|0;if(this._circularBuffer.count+this._requestedBufferCount*Bi.BufferSize<t*Bi.BufferSize){for(let i=0;i<t;i++)this.onSampleRequest();this._requestedBufferCount+=t}}generateSound(t){const e=t.outputBuffer.getChannelData(0),s=t.outputBuffer.getChannelData(1),i=e.length+s.length;let a=this._outputBuffer;a.length!==i&&(a=new Float32Array(i),this._outputBuffer=a);const n=this._circularBuffer.read(a,0,Math.min(a.length,this._circularBuffer.count));let o=0;const h=Math.min(e.length,n);for(let c=0;c<h;c++)e[c]=a[o++],s[c]=a[o++];if(n<e.length)for(let c=n;c<e.length;c++)e[c]=0,s[c]=0;this.onSamplesPlayed(n/q.AudioChannels),this.requestBuffers()}}class oa{get output(){return this._output}get isReady(){return this._workerIsReady&&this._outputIsReady}get isReadyForPlayback(){return this._workerIsReadyForPlayback}get state(){return this._state}get logLevel(){return x.logLevel}get worker(){return this._synth}set logLevel(t){x.logLevel=t,this._synth.postMessage({cmd:"alphaSynth.setLogLevel",value:t})}get masterVolume(){return this._masterVolume}set masterVolume(t){t=Math.max(t,q.MinVolume),this._masterVolume=t,this._synth.postMessage({cmd:"alphaSynth.setMasterVolume",value:t})}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(t){t=Math.max(t,q.MinVolume),this._metronomeVolume=t,this._synth.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:t})}get countInVolume(){return this._countInVolume}set countInVolume(t){t=Math.max(t,q.MinVolume),this._countInVolume=t,this._synth.postMessage({cmd:"alphaSynth.setCountInVolume",value:t})}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(t){this._midiEventsPlayedFilter=t,this._synth.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:_.prepareForPostMessage(t)})}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(t){t=O.clamp(t,q.MinPlaybackSpeed,q.MaxPlaybackSpeed),this._playbackSpeed=t,this._synth.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:t})}get loadedMidiInfo(){return this.loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._currentPosition.currentTick}set tickPosition(t){t<0&&(t=0),this._currentPosition=new Fs(this._currentPosition.currentTime,this._currentPosition.endTime,t,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTickPosition",value:t})}get timePosition(){return this._currentPosition.currentTime}set timePosition(t){t<0&&(t=0),this._currentPosition=new Fs(t,this._currentPosition.endTime,this._currentPosition.currentTick,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTimePosition",value:t})}get isLooping(){return this._isLooping}set isLooping(t){this._isLooping=t,this._synth.postMessage({cmd:"alphaSynth.setIsLooping",value:t})}get playbackRange(){return this._playbackRange}set playbackRange(t){t&&(t.startTick<0&&(t.startTick=0),t.endTick<0&&(t.endTick=0)),this._playbackRange=t,this._synth.postMessage({cmd:"alphaSynth.setPlaybackRange",value:_.prepareForPostMessage(t)})}constructor(t,e){this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=wt.Paused,this._masterVolume=0,this._metronomeVolume=0,this._countInVolume=0,this._playbackSpeed=0,this._isLooping=!1,this._playbackRange=null,this._midiEventsPlayedFilter=[],this._currentPosition=new Fs(0,0,0,0,!1,120,120),this.ready=new it,this.readyForPlayback=new it,this.finished=new it,this.soundFontLoaded=new it,this.soundFontLoadFailed=new pe,this.midiLoaded=new pe,this.midiLoadFailed=new pe,this.stateChanged=new pe,this.positionChanged=new pe,this.midiEventsPlayed=new pe,this.playbackRangeChanged=new pe,this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=wt.Paused,this._masterVolume=0,this._metronomeVolume=0,this._playbackSpeed=0,this._isLooping=!1,this._playbackRange=null,this._output=t,this._output.ready.on(this.onOutputReady.bind(this)),this._output.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this._output.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this._output.open(e.player.bufferTimeInMilliseconds);try{this._synth=_.createWebWorker(e)}catch(s){x.error("AlphaSynth",`Failed to create WebWorker: ${s}`)}this._synth.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this._synth.postMessage({cmd:"alphaSynth.initialize",sampleRate:this._output.sampleRate,logLevel:e.core.logLevel,bufferTimeInMilliseconds:e.player.bufferTimeInMilliseconds}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}destroy(){this._synth.postMessage({cmd:"alphaSynth.destroy"})}play(){return this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this._synth.postMessage({cmd:"alphaSynth.pause"})}playPause(){this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.playPause"})}stop(){this._synth.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(t){this._synth.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:at.midiFileToJsObject(_.prepareForPostMessage(t))})}loadSoundFont(t,e){this._synth.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:_.prepareForPostMessage(t),append:e})}resetSoundFonts(){this._synth.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(t){this._synth.postMessage({cmd:"alphaSynth.loadMidi",midi:at.midiFileToJsObject(_.prepareForPostMessage(t))})}applyTranspositionPitches(t){this._synth.postMessage({cmd:"alphaSynth.applyTranspositionPitches",transpositionPitches:JSON.stringify(Array.from(_.prepareForPostMessage(t).entries()))})}setChannelTranspositionPitch(t,e){this._synth.postMessage({cmd:"alphaSynth.setChannelTranspositionPitch",channel:t,semitones:e})}setChannelMute(t,e){this._synth.postMessage({cmd:"alphaSynth.setChannelMute",channel:t,mute:e})}resetChannelStates(){this._synth.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(t,e){this._synth.postMessage({cmd:"alphaSynth.setChannelSolo",channel:t,solo:e})}setChannelVolume(t,e){e=Math.max(e,q.MinVolume),this._synth.postMessage({cmd:"alphaSynth.setChannelVolume",channel:t,volume:e})}handleWorkerMessage(t){const e=t.data;switch(e.cmd){case"alphaSynth.ready":this._workerIsReady=!0,this.checkReady();break;case"alphaSynth.destroyed":this._synth.terminate();break;case"alphaSynth.readyForPlayback":this._workerIsReadyForPlayback=!0,this.checkReadyForPlayback();break;case"alphaSynth.positionChanged":this._currentPosition=new Fs(e.currentTime,e.endTime,e.currentTick,e.endTick,e.isSeek,e.originalTempo,e.modifiedTempo),this.positionChanged.trigger(this._currentPosition);break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new Za(e.events.map(at.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this._state=e.state,this.stateChanged.trigger(new bi(e.state,e.stopped));break;case"alphaSynth.playbackRangeChanged":this._playbackRange=e.playbackRange,this.playbackRangeChanged.trigger(new rr(this._playbackRange));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(e.error);break;case"alphaSynth.midiLoaded":this.checkReadyForPlayback(),this._loadedMidiInfo=new Fs(e.currentTime,e.endTime,e.currentTick,e.endTick,e.isSeek,e.originalTempo,e.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo);break;case"alphaSynth.midiLoadFailed":this.checkReadyForPlayback(),this.midiLoadFailed.trigger(e.error);break;case"alphaSynth.output.addSamples":this._output.addSamples(e.samples);break;case"alphaSynth.output.play":this._output.play();break;case"alphaSynth.output.pause":this._output.pause();break;case"alphaSynth.output.destroy":this._output.destroy();break;case"alphaSynth.output.resetSamples":this._output.resetSamples()}}checkReady(){this.isReady&&this.ready.trigger()}checkReadyForPlayback(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}onOutputSampleRequest(){this._synth.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(t){this._synth.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:t})}onOutputReady(){this._outputIsReady=!0,this.checkReady()}loadBackingTrack(t){}updateSyncPoints(t){}}class xl{constructor(t,e){this._width=0,this.boundsLookup=null,this.preRender=new pe,this.partialRenderFinished=new pe,this.partialLayoutFinished=new pe,this.renderFinished=new pe,this.postRenderFinished=new it,this.error=new pe,this._api=t;try{this._worker=_.createWebWorker(e)}catch(s){return void x.error("Rendering",`Failed to create WebWorker: ${s}`)}this._worker.postMessage({cmd:"alphaTab.initialize",settings:this.serializeSettingsForWorker(e)}),this._worker.addEventListener("message",this.handleWorkerMessage.bind(this))}destroy(){this._worker.terminate()}updateSettings(t){this._worker.postMessage({cmd:"alphaTab.updateSettings",settings:this.serializeSettingsForWorker(t)})}serializeSettingsForWorker(t){const e=at.settingsToJsObject(_.prepareForPostMessage(t));return e.delete("player"),e}render(){this._worker.postMessage({cmd:"alphaTab.render"})}resizeRender(){this._worker.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(t){this._worker.postMessage({cmd:"alphaTab.renderResult",resultId:t})}get width(){return this._width}set width(t){this._width=t,this._worker.postMessage({cmd:"alphaTab.setWidth",width:t})}handleWorkerMessage(t){const e=t.data;switch(e.cmd){case"alphaTab.preRender":this.preRender.trigger(e.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(e.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(e.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(e.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=Yt.fromJson(e.boundsLookup,this._api.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(e.error)}}renderScore(t,e){const s=null==t?null:at.scoreToJsObject(_.prepareForPostMessage(t));this._worker.postMessage({cmd:"alphaTab.renderScore",score:s,trackIndexes:_.prepareForPostMessage(e),fontSizes:vt.FontSizeLookupTables})}}class _o{constructor(t,e,s,i){this.cursorWrapper=t,this.barCursor=e,this.beatCursor=s,this.selectionWrapper=i}}let Nl=(()=>{class r{static init(){var e;r._isRegistered||(r._isRegistered=!0,registerProcessor("alphatab",((e=class extends AudioWorkletProcessor{constructor(i){super(i),this._outputBuffer=new Float32Array(0),this._bufferCount=0,this._requestedBufferCount=0,this._isStopped=!1,x.debug("WebAudio","creating processor"),this._bufferCount=Math.floor(i.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/e.BufferSize),this._circularBuffer=new dn(e.BufferSize*this._bufferCount),this.port.onmessage=this.handleMessage.bind(this)}handleMessage(i){const a=i.data;switch(a.cmd){case Je.CmdOutputAddSamples:const o=a.samples;this._circularBuffer.write(o,0,o.length),this._requestedBufferCount--;break;case Je.CmdOutputResetSamples:this._circularBuffer.clear();break;case Je.CmdOutputStop:this._isStopped=!0}}process(i,a,n){if(1!==a.length&&2!==a[0].length)return!1;const o=a[0][0],h=a[0][1];if(!o||!h)return!0;const c=o.length+h.length;let d=this._outputBuffer;d.length!==c&&(d=new Float32Array(c),this._outputBuffer=d);const u=this._circularBuffer.read(d,0,Math.min(d.length,this._circularBuffer.count));let f=0;const p=Math.min(o.length,u);for(let g=0;g<p;g++)o[g]=d[f++],h[g]=d[f++];if(u<o.length)for(let g=u;g<o.length;g++)o[g]=0,h[g]=0;return this.port.postMessage({cmd:Je.CmdOutputSamplesPlayed,samples:u/q.AudioChannels}),this.requestBuffers(),this._circularBuffer.count>0||!this._isStopped}requestBuffers(){const i=this._bufferCount/2|0;if(this._circularBuffer.count+this._requestedBufferCount*e.BufferSize<i*e.BufferSize){for(let o=0;o<i;o++)this.port.postMessage({cmd:Je.CmdOutputSampleRequest});this._requestedBufferCount+=i}}}).BufferSize=4096,e)))}}return r._isRegistered=!1,r})();class To extends Bi{constructor(t){super(),this._worklet=null,this._bufferTimeInMilliseconds=0,this._settings=t}open(t){super.open(t),this._bufferTimeInMilliseconds=t,this.onReady()}play(){super.play();const t=this._context;_.createAudioWorklet(t,this._settings).then(()=>{this._worklet=new AudioWorkletNode(t,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this._bufferTimeInMilliseconds}}),this._worklet.port.onmessage=this.handleMessage.bind(this),this._source.connect(this._worklet),this._source.start(0),this._worklet.connect(t.destination)},e=>{x.error("WebAudio",`Audio Worklet creation failed: reason=${e}`)})}handleMessage(t){const e=t.data;switch(e.cmd){case Je.CmdOutputSamplesPlayed:this.onSamplesPlayed(e.samples);break;case Je.CmdOutputSampleRequest:this.onSampleRequest()}}pause(){super.pause(),this._worklet&&(this._worklet.port.postMessage({cmd:Je.CmdOutputStop}),this._worklet.port.onmessage=null,this._worklet.disconnect()),this._worklet=null}addSamples(t){this._worklet?.port.postMessage({cmd:Je.CmdOutputAddSamples,samples:_.prepareForPostMessage(t)})}resetSamples(){this._worklet?.port.postMessage({cmd:Je.CmdOutputResetSamples})}}class Pl extends Is{constructor(t,e,s){super(t),this._xscale=e,this._yscale=s}get width(){return this.element.offsetWidth/this._xscale}set width(t){this.element.style.width=t*this._xscale+"px"}get height(){return this.element.offsetHeight/this._yscale}set height(t){this.element.style.height=t>=0?t*this._yscale+"px":"100%"}setBounds(t,e,s,i){Number.isNaN(t)&&(t=this.lastBounds.x),Number.isNaN(e)&&(e=this.lastBounds.y),Number.isNaN(s)?s=this.lastBounds.w:s/=this._xscale,Number.isNaN(i)?i=this.lastBounds.h:i/=this._yscale,this.element.style.transform=`translate(${t}px, ${e}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=t,this.lastBounds.y=e,this.lastBounds.w=s,this.lastBounds.h=i}}class Cl{constructor(){this.sampleRate=44100,this._updateInterval=0,this.ready=new it,this.samplesPlayed=new pe,this.timeUpdate=new pe,this.sampleRequest=new it}get backingTrackDuration(){const t=this.audioElement.duration??0;return Number.isFinite(t)?1e3*t:0}get playbackRate(){return this.audioElement.playbackRate}set playbackRate(t){this.audioElement.playbackRate=t}get masterVolume(){return this.audioElement.volume}set masterVolume(t){this.audioElement.volume=t}seekTo(t){this.audioElement.currentTime=t/1e3}loadBackingTrack(t){this.audioElement?.src&&URL.revokeObjectURL(this.audioElement.src);const e=new Blob([t.rawAudioFile]),s=this.audioElement.playbackRate;this.audioElement.src=URL.createObjectURL(e),this.audioElement.playbackRate=s}open(t){const e=document.createElement("audio");e.style.display="none",document.body.appendChild(e),e.addEventListener("seeked",()=>{this.updatePosition()}),e.addEventListener("timeupdate",()=>{this.updatePosition()}),this.audioElement=e,this.ready.trigger()}updatePosition(){this.timeUpdate.trigger(1e3*this.audioElement.currentTime)}play(){this.audioElement.play(),this._updateInterval=window.setInterval(()=>{this.updatePosition()},50)}destroy(){const t=this.audioElement;t&&document.body.removeChild(t)}pause(){this.audioElement.pause(),window.clearInterval(this._updateInterval)}addSamples(t){}resetSamples(){}activate(){}enumerateOutputDevices(){return(0,dt.A)(function*(){return Ss.enumerateOutputDevices()})()}setOutputDevice(t){var e=this;return(0,dt.A)(function*(){(yield Ss.checkSinkIdSupport())&&(t?yield e.audioElement.setSinkId(t.deviceId):yield e.audioElement.setSinkId(""))})()}getOutputDevice(){var t=this;return(0,dt.A)(function*(){if(!(yield Ss.checkSinkIdSupport()))return null;const e=t.audioElement.sinkId;if("string"!=typeof e||""===e||"default"===e)return null;let s=Ss.findKnownDevice(e);if(s)return s;const i=yield t.enumerateOutputDevices();return s=i.find(a=>a.deviceId===e),s||(x.warning("WebAudio","Could not find output device in device list",e,i),null)})()}}let Dl=(()=>{class r{constructor(e,s){this._promise=null,this._exporterId=r._nextExporterId++,this._worker=e,this._ownsWorker=s}initialize(e,s,i,a){var n=this;return(0,dt.A)(function*(){const o=n.handleWorkerMessage.bind(n);n._worker.worker.addEventListener("message",o,!1),n._unsubscribe=()=>{n._worker.worker.removeEventListener("message",o,!1)},n._promise=Promise.withResolvers(),n._worker.worker.postMessage({cmd:"alphaSynth.exporter.initialize",exporterId:n._exporterId,options:_.prepareForPostMessage(e),midi:at.midiFileToJsObject(_.prepareForPostMessage(s)),syncPoints:_.prepareForPostMessage(i),transpositionPitches:_.prepareForPostMessage(a)}),yield n._promise.promise})()}handleWorkerMessage(e){const s=e.data;if(s.exporterId===this._exporterId)switch(s.cmd){case"alphaSynth.exporter.initialized":this._promise?.resolve(null),this._promise=null;break;case"alphaSynth.exporter.error":this._promise?.reject(s.error),this._promise=null;break;case"alphaSynth.exporter.rendered":this._promise?.resolve(s.chunk),this._promise=null;break;case"alphaSynth.destroyed":this._promise?.reject(new Le(Fe.General,"Worker was destroyed")),this._promise=null}}render(e){var s=this;return(0,dt.A)(function*(){if(s._promise)throw new Le(Fe.General,"There is already an ongoing operation, wait for initialize to complete before requesting render");return s._promise=Promise.withResolvers(),s._worker.worker.postMessage({cmd:"alphaSynth.exporter.render",exporterId:s._exporterId,milliseconds:e}),yield s._promise.promise})()}destroy(){this._worker.worker.postMessage({cmd:"alphaSynth.exporter.destroy",exporterId:this._exporterId}),this._unsubscribe(),this._ownsWorker&&this._worker.destroy()}[Symbol.dispose](){this.destroy()}}return r._nextExporterId=1,r})();var Ys=function(r){return r[r.LayoutDone=0]="LayoutDone",r[r.RenderRequested=1]="RenderRequested",r[r.RenderDone=2]="RenderDone",r[r.Detached=3]="Detached",r}(Ys||{});class ii{get resizeThrottle(){return 10}get canRender(){return this.areAllFontsLoaded()}areAllFontsLoaded(){let t=!1;for(const e of this._fontCheckers.values())e.isFontLoaded||(t=!0);return!t&&(x.debug("Font",`All fonts loaded: ${this._fontCheckers.size}`),!0)}onFontLoaded(t){vt.generateFontLookup(t),this.areAllFontsLoaded()&&this.canRenderChanged.trigger()}constructor(t){if(this._fontCheckers=new Map,this._contents=null,this._file=null,this._totalResultCount=0,this._initialTrackIndexes=null,this._barToElementLookup=new Map,this._resultIdToElementLookup=new Map,this.rootContainerBecameVisible=new it,this.canRenderChanged=new it,this._highlightedElements=[],this._scrollContainer=null,_.webPlatform!==ys.Browser&&_.webPlatform!==ys.BrowserModule)throw new Le(Fe.General,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");t.classList.add("alphaTab"),this.rootContainer=new Is(t),this.areWorkersSupported="Worker"in window,this._intersectionObserver=new IntersectionObserver(this.onElementVisibilityChanged.bind(this),{threshold:[0,.01,1]}),this._intersectionObserver.observe(t)}onElementVisibilityChanged(t){for(const e of t){const s=e.target;if(s===this.rootContainer.element)e.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this._intersectionObserver.unobserve(this.rootContainer.element));else if("layoutResultId"in s&&this._api.settings.core.enableLazyLoading){const i=s;e.isIntersecting?i.renderedResultId!==i.layoutResultId?this._resultIdToElementLookup.has(i.layoutResultId)?i.resultState!==Ys.RenderRequested&&(i.resultState=Ys.RenderRequested,this._api.renderer.renderResult(i.layoutResultId)):s.replaceChildren():i.resultState===Ys.Detached&&(s.replaceChildren(...i.renderedResult),i.resultState=Ys.RenderDone):i.resultState===Ys.RenderDone&&(i.resultState=Ys.Detached,i.replaceChildren())}}}createWorkerRenderer(){return new xl(this._api,this._api.settings)}initialize(t,e){let s;this._api=t,s=e instanceof Gs?e:at.jsObjectToSettings(e);const i=this.getDataAttributes();ti.fromJson(s,i),s.notation.notationMode===_t.SongBook&&s.setSongBookModeSettings(),t.settings=s,this.setupFontCheckers(s),this._initialTrackIndexes=this.parseTracks(s.core.tracks),this._contents="";const a=t.container;s.core.tex&&(this._contents=a.element.innerHTML,a.element.innerHTML=""),this.createStyleElements(s),this._file=s.core.file}setupFontCheckers(t){this.registerFontChecker(t.display.resources.copyrightFont),this.registerFontChecker(t.display.resources.effectFont),this.registerFontChecker(t.display.resources.fingeringFont),this.registerFontChecker(t.display.resources.graceFont),this.registerFontChecker(t.display.resources.markerFont),this.registerFontChecker(t.display.resources.tablatureFont),this.registerFontChecker(t.display.resources.titleFont),this.registerFontChecker(t.display.resources.wordsFont),this.registerFontChecker(t.display.resources.barNumberFont),this.registerFontChecker(t.display.resources.fretboardNumberFont),this.registerFontChecker(t.display.resources.subTitleFont)}registerFontChecker(t){if(!this._fontCheckers.has(t.families.join(", "))){const e=new ko(t.families);this._fontCheckers.set(t.families.join(", "),e),e.fontLoaded.on(this.onFontLoaded.bind(this)),e.checkForFontAvailability()}}destroy(){this.rootContainer.element.innerHTML="";const t=this._webFont;t.usages--,t.usages<=0&&(t.element.remove(),ii._registeredWebFonts.delete(t.hash))}createCanvasElement(){const t=document.createElement("div");return t.classList.add("at-surface",`at${this._webFont.fontSuffix}`),t.style.fontSize="0",t.style.overflow="hidden",t.style.lineHeight="0",t.style.position="relative",new Is(t)}triggerEvent(t,e,s=null,i){const a=t.element;e=`alphaTab.${e}`;const n=document.createEvent("CustomEvent"),o=i?i.mouseEvent:null;if(n.initCustomEvent(e,!1,!1,s),o&&(n.originalEvent=o),a.dispatchEvent(n),window&&"jQuery"in window){const h=window.jQuery,c=[];c.push(s),o&&c.push(o),h(a).trigger(e,c)}}load(t,e,s){if(t instanceof Cs)return e(t),!0;if(t instanceof ArrayBuffer){const i=new Uint8Array(t);return e(ki.loadScoreFromBytes(i,this._api.settings)),!0}return t instanceof Uint8Array?(e(ki.loadScoreFromBytes(t,this._api.settings)),!0):"string"==typeof t&&(ki.loadScoreAsync(t,e,s,this._api.settings),!0)}loadSoundFont(t,e){return!(!this._api.player||(t instanceof ArrayBuffer?(this._api.player.loadSoundFont(new Uint8Array(t),e),0):t instanceof Uint8Array?(this._api.player.loadSoundFont(t,e),0):"string"!=typeof t||(this._api.loadSoundFontFromUrl(t,e),0)))}initialRender(){this._api.renderer.preRender.on(e=>{this._totalResultCount=0,this._resultIdToElementLookup.clear(),this._barToElementLookup.clear()});const t=()=>{this._api.renderer.width=0|this.rootContainer.width,this._api.renderer.updateSettings(this._api.settings),this._contents?(this._api.tex(this._contents,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null):this._file&&ki.loadScoreAsync(this._file,e=>{this._api.renderScore(e,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null},e=>{this._api.onError(e)},this._api.settings)};this.rootContainer.isVisible?t():this.rootContainerBecameVisible.on(t)}createStyleElements(t){const e=this._api.container.element.ownerDocument;ii.createSharedStyleElement(e);const s=t.core.smuflFontSources??vn.buildDefaultSmuflFontSources(t.core.fontDirectory),i=ii.cyrb53(s.values()),a=ii._registeredWebFonts;if(a.has(i)){const p=a.get(i);return p.usages++,p.checker.fontLoaded.on(this.onFontLoaded.bind(this)),void(this._webFont=p)}const n=0===a.size?"":String(a.size),o=`alphaTab${n}`,c=`\n            @font-face {\n                font-display: block;\n                font-family: '${o}';\n                src: ${Array.from(s.entries()).map(p=>`url(${JSON.stringify(p[1])}) format('${ii.cssFormat(p[0])}')`).join(",")};\n                font-weight: normal;\n                font-style: normal;\n            }\n            .at-surface.at${n} .at {\n                font-family: '${o}';\n                speak: none;\n                font-style: normal;\n                font-weight: normal;\n                font-variant: normal;\n                text-transform: none;\n                line-height: 1;\n                line-height: 1;\n                -webkit-font-smoothing: antialiased;\n                -moz-osx-font-smoothing: grayscale;\n                font-size: ${_.MusicFontSize}px;\n                overflow: visible !important;\n            }`,d=e.createElement("style");d.id=`alphaTabStyle${n}`,d.innerHTML=c,e.getElementsByTagName("head").item(0).appendChild(d);const u=new ko([o]);u.fontLoaded.on(this.onFontLoaded.bind(this)),this._fontCheckers.set(o,u),u.checkForFontAvailability(),t.display.resources.smuflFont=new de(o,_.MusicFontSize,Xe.Plain,Ut.Regular);const f={hash:i,element:d,fontSuffix:n,usages:1,checker:u};a.set(i,f),this._webFont=f}static cssFormat(t){switch(t){case Bs.EmbeddedOpenType:return"embedded-opentype";case Bs.Woff:return"woff";case Bs.Woff2:return"woff2";case Bs.OpenType:return"opentype";case Bs.TrueType:return"truetype";case Bs.Svg:return"svg"}}static cyrb53(t,e=0){let s=3735928559^e,i=1103547991^e;for(const a of t)for(let n=0;n<a.length;n++){const o=a.charCodeAt(n);s=Math.imul(s^o,2654435761),i=Math.imul(i^o,1597334677)}return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(s^s>>>13,3266489909),4294967296*(2097151&i)+(s>>>0)}static createSharedStyleElement(t){let e=t.getElementById("alphaTabStyle");e||(e=document.createElement("style"),e.id="alphaTabStyleShared",e.innerHTML="\n                .at-surface * {\n                    cursor: default;\n                    vertical-align: top;\n                    overflow: visible;\n                }\n                .at-surface-svg text {\n                    dominant-baseline: central;\n                    white-space:pre;\n                }",document.getElementsByTagName("head").item(0).appendChild(e))}parseTracks(t){if(!t)return[];const e=[];if("string"==typeof t)try{if("all"===t)return[-1];t=JSON.parse(t)}catch{t=[0]}if("number"==typeof t)e.push(t);else if("length"in t){const s=t.length,i=t;for(let a=0;a<s;a++){const n=i[a];let o=0;o="number"==typeof n?n:"index"in n?n.index:Number.parseInt(n.toString()),(o>=0||-1===o)&&e.push(o)}}else"index"in t&&e.push(t.index);return e}getDataAttributes(){const t=new Map,e=this._api.container.element;if(e.dataset)for(const s of Object.keys(e.dataset)){let i=e.dataset[s];try{i=JSON.parse(i)}catch{""===i&&(i=null)}t.set(s,i)}else for(let s=0;s<e.attributes.length;s++){const i=e.attributes.item(s),a=i.nodeName;if(a.startsWith("data-")){const n=a.substr(5).split("-");let o=n[0];for(let c=1;c<n.length;c++)o+=n[c].substr(0,1).toUpperCase()+n[c].substr(1);let h=i.nodeValue;try{h=JSON.parse(h)}catch{""===h&&(h=null)}t.set(o,h)}}return t}beginUpdateRenderResults(t){if(!this._resultIdToElementLookup.has(t.id))return;const e=this._resultIdToElementLookup.get(t.id),s=t.renderResult;"string"==typeof s?e.innerHTML=s:"nodeType"in s&&e.replaceChildren(s),e.resultState=Ys.RenderDone,e.renderedResultId=t.id,e.renderedResult=Array.from(e.children)}beginAppendRenderResults(t){const e=this._api.canvasElement.element;if(t){let s;this._totalResultCount<e.childElementCount?s=e.childNodes.item(this._totalResultCount):(s=document.createElement("div"),e.appendChild(s)),s.style.zIndex="1",s.style.position="absolute",s.style.left=`${t.x}px`,s.style.top=`${t.y}px`,s.style.width=`${t.width}px`,s.style.height=`${t.height}px`,s.style.display="inline-block",s.layoutResultId=t.id,s.resultState=Ys.LayoutDone,s.renderedResultId=void 0,s.renderedResult=void 0,this._resultIdToElementLookup.set(t.id,s);for(let i=t.firstMasterBarIndex;i<=t.lastMasterBarIndex;i++)i>=0&&this._barToElementLookup.set(i,s);this._api.settings.core.enableLazyLoading&&(this._intersectionObserver.unobserve(s),this._intersectionObserver.observe(s)),this._totalResultCount++}else for(;e.childElementCount>this._totalResultCount;)this._api.settings.core.enableLazyLoading&&this._intersectionObserver.unobserve(e.lastChild),e.removeChild(e.lastElementChild)}createWorkerPlayer(){let t=null;const e="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&this._api.settings.player.outputMode===vr.WebAudioAudioWorklets?(x.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),t=new oa(new To(this._api.settings),this._api.settings)):e&&(x.debug("Player","Will use webworkers for synthesizing and web audio api with ScriptProcessor for playback"),t=new oa(new Bo,this._api.settings)),t?t.ready.on(()=>{this._api.settings.player.soundFont&&this._api.loadSoundFontFromUrl(this._api.settings.player.soundFont,!1)}):x.error("Player","Player requires webworkers and web audio api, browser unsupported",null),t}createWorkerAudioExporter(t){const e=null===t||!(t instanceof oa);return e&&(t=this.createWorkerPlayer()),new Dl(t,e)}beginInvoke(t){window.requestAnimationFrame(()=>{t()})}highlightElements(t,e){const s=this._barToElementLookup.get(e);if(s){const i=s.getElementsByClassName(t);for(let a=0;a<i.length;a++)i.item(a).classList.add("at-highlight"),this._highlightedElements.push(i.item(a))}}removeHighlights(){const t=this._highlightedElements;if(t){for(const e of t)e.classList.remove("at-highlight");this._highlightedElements=[]}}destroyCursors(){const t=this._api.container.element,e=t.querySelector(".at-cursors");t.removeChild(e)}createCursors(){const t=this._api.container.element,e=document.createElement("div");e.classList.add("at-cursors");const s=document.createElement("div");s.classList.add("at-selection");const i=this.createScalingElement(),a=this.createScalingElement(),n=i.element;n.classList.add("at-cursor-bar");const o=a.element;return o.classList.add("at-cursor-beat"),t.style.position="relative",t.style.textAlign="left",e.style.position="absolute",e.style.zIndex="1000",e.style.display="inline",e.style.pointerEvents="none",s.style.position="absolute",n.style.position="absolute",n.style.left="0",n.style.top="0",n.style.willChange="transform",i.width=1,i.height=1,i.setBounds(0,0,1,1),o.style.position="absolute",o.style.transition="all 0s linear",o.style.left="0",o.style.top="0",o.style.willChange="transform",a.width=3,a.height=1,a.setBounds(0,0,1,1),t.insertBefore(e,t.firstChild),e.appendChild(s),e.appendChild(n),e.appendChild(o),new _o(new Is(e),i,a,new Is(s))}getOffset(t,e){const s=e.element,i=s.getBoundingClientRect();let a=i.top+s.ownerDocument.defaultView.pageYOffset,n=i.left+s.ownerDocument.defaultView.pageXOffset;if(t){const h=t.element,c=h.nodeName.toLowerCase();if("html"!==c&&"body"!==c){const d=this.getOffset(null,t);a=a+h.scrollTop-d.y,n=n+h.scrollLeft-d.x}}const o=new St;return o.x=n,o.y=a,o.w=i.width,o.h=i.height,o}getScrollContainer(){if(this._scrollContainer)return this._scrollContainer;let t="string"==typeof this._api.settings.player.scrollElement?document.querySelector(this._api.settings.player.scrollElement):this._api.settings.player.scrollElement;const e=t.nodeName.toLowerCase();return("html"===e||"body"===e)&&(t="scrollingElement"in document?document.scrollingElement:-1!==navigator.userAgent.indexOf("WebKit")?document.body:document.documentElement),this._scrollContainer=new Is(t),this._scrollContainer}createSelectionElement(){return this.createScalingElement()}createScalingElement(){const t=document.createElement("div");t.style.position="absolute";const e=new Pl(t,100,100);return e.width=1,e.height=1,e.setBounds(0,0,1,1),e}scrollToY(t,e,s){this.internalScrollToY(t.element,e,s)}scrollToX(t,e,s){this.internalScrollToX(t.element,e,s)}internalScrollToY(t,e,s){if(this._api.settings.player.nativeBrowserSmoothScroll)t.scrollTo({top:e,behavior:"smooth"});else{const i=t.scrollTop,a=e-i;let n=0;const o=h=>{0===n&&(n=h);const c=h-n,d=Math.min(c/s,1);t.scrollTop=i+a*d|0,c<s&&window.requestAnimationFrame(o)};window.requestAnimationFrame(o)}}internalScrollToX(t,e,s){if(this._api.settings.player.nativeBrowserSmoothScroll)t.scrollTo({left:e,behavior:"smooth"});else{const i=t.scrollLeft,a=e-i;let n=0;const o=h=>{0===n&&(n=h);const c=h-n,d=Math.min(c/s,1);t.scrollLeft=i+a*d|0,c<s&&window.requestAnimationFrame(o)};window.requestAnimationFrame(o)}}createBackingTrackPlayer(){return new wo(new Cl,this._api.settings.player.bufferTimeInMilliseconds)}}ii._registeredWebFonts=new Map;class Ll{constructor(t,e){this.loaded=t,this.total=e}}class un extends _l{constructor(t,e){super(new ii(t),e),this.soundFontLoad=new pe}tex(t,e){super.tex(t,this.uiFacade.parseTracks(e))}print(t,e=null){const s=window.open("","","width=0,height=0"),i=s.document.createElement("div");i.style.width=t||(this.settings.display.layoutMode===cs.Horizontal?"297mm":"210mm"),s.document.write("\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <style>\n            .at-surface {\n                width: auto !important;\n                height: auto !important;\n            }\n            .at-surface > div {\n                position: relative!important;\n                left: auto !important;\n                top: auto !important;\n                break-inside: avoid;\n            }\n            </style>\n          </head>\n          <body></body>\n        </html>\n        ");const a=this.score;a&&(a.artist&&a.title?s.document.title=`${a.title} - ${a.artist}`:a.title&&(s.document.title=`${a.title}`)),s.document.body.appendChild(i);const n=typeof window.screenLeft<"u"?window.screenLeft:window.left,o=typeof window.screenTop<"u"?window.screenTop:window.top,h="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,c="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,d=i.offsetWidth+50,u=window.innerHeight,f=(h/2|0)-(d/2|0)+n,p=(c/2|0)-(u/2|0)+o;s.resizeTo(d,u),s.moveTo(f,p),s.focus();const g=at.jsObjectToSettings(at.settingsToJsObject(this.settings));g.core.enableLazyLoading=!1,g.core.useWorkers=!0,g.core.file=null,g.core.tracks=null,g.player.enableCursor=!1,g.player.playerMode=Ot.Disabled,g.player.enableElementHighlighting=!1,g.player.enableUserInteraction=!1,g.player.soundFont=null,g.display.scale=.8,g.display.stretchForce=.8,ti.fromJson(g,e);const b=new un(i,g);s.onunload=()=>{b.destroy()},b.renderer.postRenderFinished.on(()=>{s.print()}),b.renderTracks(this.tracks)}downloadMidi(t=vi.SingleTrackMultiChannel){if(!this.score)return;const e=new Ls;e.format=t;const s=new us(e,!0);new ne(this.score,this.settings,s).generate();const a=e.toBinary(),n=this.score.title?`${this.score.title}.mid`:"File.mid",o=document.createElement("a");o.download=n;const h=new Blob([a],{type:"audio/midi"}),c=URL.createObjectURL(h);o.href=c,o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o)}changeTrackMute(t,e){const s=this.trackIndexesToTracks(this.uiFacade.parseTracks(t));super.changeTrackMute(s,e)}changeTrackSolo(t,e){const s=this.trackIndexesToTracks(this.uiFacade.parseTracks(t));super.changeTrackSolo(s,e)}changeTrackVolume(t,e){const s=this.trackIndexesToTracks(this.uiFacade.parseTracks(t));super.changeTrackVolume(s,e)}trackIndexesToTracks(t){if(!this.score)return[];const e=[];if(1===t.length&&-1===t[0])for(const s of this.score.tracks)e.push(s);else for(const s of t)s>=0&&s<this.score.tracks.length&&e.push(this.score.tracks[s]);return e}loadSoundFontFromUrl(t,e){const s=this.player;if(!s)return;x.debug("AlphaSynth",`Start loading Soundfont from url ${t}`);const i=new XMLHttpRequest;i.open("GET",t,!0,null,null),i.responseType="arraybuffer",i.onload=a=>{const n=new Uint8Array(i.response);this.loadSoundFont(n,e)},i.onerror=a=>{x.error("AlphaSynth",`Loading failed: ${a.message}`),s.soundFontLoadFailed.trigger(new Us(a.message,i))},i.onprogress=a=>{x.debug("AlphaSynth",`Soundfont downloading: ${a.loaded}/${a.total} bytes`);const n=new Ll(a.loaded,a.total);this.soundFontLoad.trigger(n),this.uiFacade.triggerEvent(this.container,"soundFontLoad",n)},i.send()}}class xo{constructor(){this._initListeners=[]}exec(t,e,s){if("string"!=typeof e&&(s=[e],e="init"),95===e.charCodeAt(0)||"exec"===e)return null;const i=new jQuery(t),a=i.data("alphaTab");if("destroy"===e&&!a)return null;if("init"!==e&&!a)throw new Error("alphaTab not initialized");const n=this[e];if(n){const o=[i,a].concat(s);return n.apply(this,o)}return x.error("Api",`Method '${e}' does not exist on jQuery.alphaTab`),null}init(t,e,s){if(!e){e=new un(t[0],s),t.data("alphaTab",e);for(const i of this._initListeners)i(t,e,s)}}destroy(t,e){t.removeData("alphaTab"),e.destroy()}print(t,e,s,i){e.print(s,i)}load(t,e,s,i){return e.load(s,i)}render(t,e){e.render()}renderScore(t,e,s,i){e.renderScore(s,i)}renderTracks(t,e,s){e.renderTracks(s)}invalidate(t,e){e.render()}tex(t,e,s,i){e.tex(s,i)}muteTrack(t,e,s,i){e.changeTrackMute(s,i)}soloTrack(t,e,s,i){e.changeTrackSolo(s,i)}trackVolume(t,e,s,i){e.changeTrackVolume(s,i)}loadSoundFont(t,e,s,i){e.loadSoundFont(s,i)}resetSoundFonts(t,e){e.resetSoundFonts()}pause(t,e){e.pause()}play(t,e){return e.play()}playPause(t,e){e.playPause()}stop(t,e){e.stop()}api(t,e){return e}player(t,e){return e.player}isReadyForPlayback(t,e){return e.isReadyForPlayback}playerState(t,e){return e.playerState}masterVolume(t,e,s){return"number"==typeof s&&(e.masterVolume=s),e.masterVolume}metronomeVolume(t,e,s){return"number"==typeof s&&(e.metronomeVolume=s),e.metronomeVolume}countInVolume(t,e,s){return"number"==typeof s&&(e.countInVolume=s),e.countInVolume}midiEventsPlayedFilter(t,e,s){return Array.isArray(s)&&(e.midiEventsPlayedFilter=s),e.midiEventsPlayedFilter}playbackSpeed(t,e,s){return"number"==typeof s&&(e.playbackSpeed=s),e.playbackSpeed}tickPosition(t,e,s){return"number"==typeof s&&(e.tickPosition=s),e.tickPosition}timePosition(t,e,s){return"number"==typeof s&&(e.timePosition=s),e.timePosition}loop(t,e,s){return"boolean"==typeof s&&(e.isLooping=s),e.isLooping}renderer(t,e){return e.renderer}score(t,e){return e.score}settings(t,e){return e.settings}tracks(t,e){return e.tracks}_oninit(t){this._initListeners.push(t)}static restore(t){new jQuery(t).empty().removeData("alphaTab")}}class ha{constructor(){this.buffer="",this._currentPath="",this._currentPathIsEmpty=!0,this.scale=1,this.color=new Ee(255,255,255,255),this.lineWidth=1,this.font=new de("Arial",10,Xe.Plain),this.textAlign=U.Left,this.textBaseline=re.Top}destroy(){}beginRender(t,e){this.scale=this.settings.display.scale,this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${0|t}px" height="${0|e}px" class="at-surface-svg">\n`,this._currentPath="",this._currentPathIsEmpty=!0,this.textBaseline=re.Top}beginGroup(t){this.buffer+=`<g class="${t}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(t,e,s,i){s>0&&(this.buffer+=`<rect x="${t*this.scale|0}" y="${e*this.scale|0}" width="${s*this.scale}" height="${i*this.scale}" fill="${this.color.rgba}" />\n`)}strokeRect(t,e,s,i){const a=this.lineWidth*this.scale%2==0?0:.5;this.buffer+=`<rect x="${(t*this.scale|0)+a}" y="${(e*this.scale|0)+a}" width="${s*this.scale}" height="${i*this.scale}" stroke="${this.color.rgba}"`,1!==this.lineWidth&&(this.buffer+=` stroke-width="${this.lineWidth*this.scale}"`),this.buffer+=' fill="transparent" />\n'}beginPath(){}closePath(){this._currentPath+=" z"}moveTo(t,e){this._currentPath+=` M${t*this.scale},${e*this.scale}`}lineTo(t,e){this._currentPathIsEmpty=!1,this._currentPath+=` L${t*this.scale},${e*this.scale}`}quadraticCurveTo(t,e,s,i){this._currentPathIsEmpty=!1,this._currentPath+=` Q${t*this.scale},${e*this.scale},${s*this.scale},${i*this.scale}`}bezierCurveTo(t,e,s,i,a,n){this._currentPathIsEmpty=!1,this._currentPath+=` C${t*this.scale},${e*this.scale},${s*this.scale},${i*this.scale},${a*this.scale},${n*this.scale}`}fillCircle(t,e,s){this._currentPathIsEmpty=!1,this._currentPath+=` M${(t*=this.scale)-(s*=this.scale)},${e*=this.scale} A1,1 0 0,0 ${t+s},${e} A1,1 0 0,0 ${t-s},${e} z`,this.fill()}strokeCircle(t,e,s){this._currentPathIsEmpty=!1,this._currentPath+=` M${(t*=this.scale)-(s*=this.scale)},${e*=this.scale} A1,1 0 0,0 ${t+s},${e} A1,1 0 0,0 ${t-s},${e} z`,this.stroke()}fill(){this._currentPathIsEmpty||(this.buffer+=`<path d="${this._currentPath}"`,"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this._currentPath="",this._currentPathIsEmpty=!0}stroke(){if(!this._currentPathIsEmpty){let t=`<path d="${this._currentPath}" stroke="${this.color.rgba}"`;(1!==this.lineWidth||1!==this.scale)&&(t+=` stroke-width="${this.lineWidth*this.scale}"`),t+=' style="fill: none" />',this.buffer+=t}this._currentPath="",this._currentPathIsEmpty=!0}fillText(t,e,s){if(""===t)return;let i=`<text x="${e*this.scale|0}" y="${s*this.scale|0}" style='stroke: none; font:${this.font.toCssString(this.settings.display.scale)}; ${this.getSvgBaseLine()}'`;"#000000"!==this.color.rgba&&(i+=` fill="${this.color.rgba}"`),this.textAlign!==U.Left&&(i+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),i+=`>${ha.escapeText(t)}</text>`,this.buffer+=i}static escapeText(t){return t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(t){switch(t){case U.Left:return"start";case U.Center:return"middle";case U.Right:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case re.Top:return"dominant-baseline: hanging";case re.Bottom:return"dominant-baseline: ideographic";default:return""}}measureText(t){return t?vt.measureString(t,this.font.families,this.font.size*this.scale,this.font.style,this.font.weight):new $i(0,0)}onRenderFinished(){return null}beginRotate(t,e,s){this.buffer+=`<g transform="translate(${t*this.scale} ,${e*this.scale}) rotate( ${s})">`}endRotate(){this.buffer+="</g>"}}class No extends ha{fillMusicFontSymbol(t,e,s,i,a){i!==l.None&&this.fillMusicFontSymbolText(t,e,s,`&#${i};`,a)}fillMusicFontSymbols(t,e,s,i,a){let n="";for(const o of i)o!==l.None&&(n+=`&#${o};`);this.fillMusicFontSymbolText(t,e,s,n,a)}fillMusicFontSymbolText(t,e,s,i,a){this.buffer+=`<g transform="translate(${t*=this.scale} ${e*=this.scale})" class="at" ><text`;const n=this.scale*s;this.buffer+=1!==n?` style="font-size: ${100*n}%; stroke:none"`:' style="stroke:none"',"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),a&&(this.buffer+=` text-anchor="${this.getSvgTextAlignment(U.Center)}"`),this.buffer+=`>${i}</text></g>`}}class pr{constructor(){this.isInsideBracket=!0,this.isRelevantForBoundsLookup=!0,this.hideOnMultiTrack=!1,this.hideOnPercussionTrack=!1}canCreate(t,e){return!this.hideOnPercussionTrack||!e.isPercussion}}var be=function(r){return r[r.PreNotes=0]="PreNotes",r[r.OnNotes=1]="OnNotes",r[r.MiddleNotes=2]="MiddleNotes",r[r.Stem=3]="Stem",r[r.PostNotes=4]="PostNotes",r[r.EndBeat=5]="EndBeat",r}(be||{});class ws extends $e{constructor(){super(...arguments),this.glyphs=null}get isEmpty(){return!this.glyphs||0===this.glyphs.length}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);let t=0;for(let e=0,s=this.glyphs.length;e<s;e++){const i=this.glyphs[e];i.renderer=this.renderer,i.doLayout(),t=Math.max(t,i.width)}this.width=t}addGlyph(t){this.glyphs||(this.glyphs=[]),this.renderer&&(t.renderer=this.renderer),this.glyphs.push(t)}paint(t,e,s){const i=this.glyphs;if(i&&0!==i.length)for(const a of i)a.paint(t+this.x,e+this.y,s)}}class _i extends ws{constructor(){super(0,0),this.glyphs=[]}doLayout(){}addGlyph(t){t.x=this.width,t.renderer=this.renderer,t.doLayout(),this.width=t.x+t.width,super.addGlyph(t)}}class me{static score(t,e,s,i=!1){if(!s.style&&!i)return;const a=me.scoreDefaultColor(t.settings.display.resources,e);return new Wi(t,e,s.style,a)}static scoreColor(t,e,s){const i=me.scoreDefaultColor(t,e);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static scoreDefaultColor(t,e){return t.mainGlyphColor}static bar(t,e,s,i=!1){if(!s.style&&!i)return;let a=t.settings.display.resources.mainGlyphColor;switch(e){case Be.StandardNotationRepeats:case Be.GuitarTabsRepeats:case Be.SlashRepeats:case Be.NumberedRepeats:case Be.StandardNotationClef:case Be.GuitarTabsClef:case Be.StandardNotationKeySignature:case Be.NumberedKeySignature:case Be.StandardNotationTimeSignature:case Be.GuitarTabsTimeSignature:case Be.SlashTimeSignature:case Be.NumberedTimeSignature:break;case Be.StandardNotationBarLines:case Be.GuitarTabsBarLines:case Be.SlashBarLines:case Be.NumberedBarLines:a=t.settings.display.resources.barSeparatorColor;break;case Be.StandardNotationBarNumber:case Be.SlashBarNumber:case Be.NumberedBarNumber:case Be.GuitarTabsBarNumber:a=t.settings.display.resources.barNumberColor;break;case Be.StandardNotationStaffLine:case Be.GuitarTabsStaffLine:case Be.SlashStaffLine:case Be.NumberedStaffLine:a=t.settings.display.resources.staffLineColor}return new Wi(t,e,s.style,a)}static voice(t,e,s,i=!1){if(s.style||i)return new Wi(t,e,s.style,0===s.index?t.settings.display.resources.mainGlyphColor:t.settings.display.resources.secondaryGlyphColor)}static trackColor(t,e,s){const i=me.trackDefaultColor(t,e);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static trackDefaultColor(t,e){let s=t.mainGlyphColor;switch(e){case Ds.TrackName:case Ds.SystemSeparator:case Ds.StringTuning:break;case Ds.BracesAndBrackets:s=t.barSeparatorColor}return s}static track(t,e,s,i=!1){if(!s.style&&!i)return;const a=me.trackDefaultColor(t.settings.display.resources,e);return new Wi(t,e,s.style,a)}static beatColor(t,e,s){const i=me.beatDefaultColor(t,e,s);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static beatDefaultColor(t,e,s){return 0===s.voice.index?t.mainGlyphColor:t.secondaryGlyphColor}static beat(t,e,s,i=!1){if(!s.style&&!i)return;const a=me.beatDefaultColor(t.settings.display.resources,e,s);return new Wi(t,e,s.style,a)}static noteColor(t,e,s){const i=me.noteDefaultColor(t,e,s);if(s.style&&s.style.colors.has(e))return s.style.colors.get(e)??i}static noteDefaultColor(t,e,s){return 0===s.beat.voice.index?t.mainGlyphColor:t.secondaryGlyphColor}static note(t,e,s,i=!1){if(s.style||i)return new Wi(t,e,s.style,0===s.beat.voice.index?t.settings.display.resources.mainGlyphColor:t.settings.display.resources.secondaryGlyphColor)}}class Wi{constructor(t,e,s,i){this._canvas=t,s&&s.colors.has(e)?(this._previousColor=t.color,t.color=s.colors.get(e)??i):s||(this._previousColor=t.color,t.color=i)}[Symbol.dispose](){this._previousColor&&(this._canvas.color=this._previousColor)}}let Fl=(()=>{class r extends ws{constructor(e,s,i){super(e,s),this.voice=i,this.beatGlyphs=[],this.tupletGroups=[]}scaleToWidth(e){const s=this.renderer.layoutingInfo.spaceToForce(e);this.scaleToForce(s)}scaleToForce(e){this.width=this.renderer.layoutingInfo.calculateVoiceWidth(e);const s=this.renderer.layoutingInfo.buildOnTimePositions(e),i=this.beatGlyphs;for(let a=0,n=i.length;a<n;a++){const o=i[a];if(o.beat.graceType===K.None)o.x=s.get(o.beat.absoluteDisplayStart)-o.onTimeX;else{const h=o.beat.graceGroup.beats[0].absoluteDisplayStart,c=o.beat.graceGroup.id;if(o.beat.graceGroup.isComplete&&s.has(h)){o.x=s.get(h)-o.onTimeX;const d=this.renderer.layoutingInfo.allGraceRods.get(c),u=o.beat.graceGroup.beats[o.beat.graceGroup.beats.length-1].nextBeat,f=u?this.renderer.layoutingInfo.getPreBeatSize(u)+bs.GraceBeatPadding:0;o.x-=f,o.x-=d[o.beat.graceIndex].postSpringWidth,o.x+=d[o.beat.graceIndex].graceBeatWidth,o.x-=d[o.beat.graceGroup.beats.length-1].graceBeatWidth}else{const d=this.renderer.layoutingInfo.incompleteGraceRods.get(c),u=d[o.beat.graceIndex].postSpringWidth-d[o.beat.graceIndex].preSpringWidth;o.x=a>0?0===o.beat.graceIndex?i[a-1].x+i[a-1].width:i[a-1].x+d[o.beat.graceIndex-1].postSpringWidth-d[o.beat.graceIndex-1].preSpringWidth-u:-u}}a>0&&i[a-1].scaleToWidth(o.x-i[a-1].x),a===n-1&&o.scaleToWidth(this.width-i[i.length-1].x)}}registerLayoutingInfo(e){const s=this.beatGlyphs;for(const i of s)i.registerLayoutingInfo(e)}applyLayoutingInfo(e){const s=this.beatGlyphs;for(const i of s)i.applyLayoutingInfo(e);this.scaleToForce(Math.max(this.renderer.settings.display.stretchForce,e.minStretchForce))}addGlyph(e){const s=e;e.x=0===this.beatGlyphs.length?0:this.beatGlyphs[this.beatGlyphs.length-1].x+this.beatGlyphs[this.beatGlyphs.length-1].width,e.renderer=this.renderer,e.doLayout(),this.beatGlyphs.push(s),this.width=e.x+e.width,s.beat.hasTuplet&&s.beat.tupletGroup.beats[0].id===s.beat.id&&this.tupletGroups.push(s.beat.tupletGroup)}doLayout(){}paint(e,s,i){const a=me.voice(i,qi.Glyphs,this.voice,!0);try{for(let n=0,o=this.beatGlyphs.length;n<o;n++)this.beatGlyphs[n].paint(e+this.x,s+this.y,i)}finally{a?.[Symbol.dispose]?.()}}}return r.KeySizeBeat="Beat",r})();class El{constructor(){this.staffId="",this.up=0,this.down=0}}class vl{constructor(){this.startBeat=null,this.startX=0,this.startY=0,this.endBeat=null,this.endX=0,this.endY=0}calcY(t){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(t-this.startX)+this.startY}}class ks{get isRestBeamHelper(){return 1===this.beats.length&&this.beats[0].isRest}hasLine(t,e){return t&&this.beatHasLine(e)||!t&&1===this.beats.length&&this.beatHasLine(e)}beatHasLine(t){return t.duration>m.Whole}hasFlag(t,e){return t&&this.beatHasFlag(e)||!t&&1===this.beats.length&&this.beatHasFlag(this.beats[0])}beatHasFlag(t){return!t.deadSlapped&&!t.isRest&&(t.duration>m.Quarter||t.graceType!==K.None)}constructor(t,e){this._beatLineXPositions=new Map,this._firstNonRestBeat=null,this._lastNonRestBeat=null,this.voice=null,this.beats=[],this.shortestDuration=m.QuadrupleWhole,this.hasTuplet=!1,this.slashBeats=[],this._firstBeatLowestNoteCompareValue=-1,this._firstBeatHighestNoteCompareValue=-1,this._lastBeatLowestNoteCompareValue=-1,this._lastBeatHighestNoteCompareValue=-1,this.lowestNoteInHelper=null,this._lowestNoteCompareValueInHelper=-1,this.highestNoteInHelper=null,this._highestNoteCompareValueInHelper=-1,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.isGrace=!1,this.minRestLine=null,this.beatOfMinRestLine=null,this.maxRestLine=null,this.beatOfMaxRestLine=null,this.direction=P.Up,this.drawingInfos=new Map,this._staff=t,this._renderer=e,this.beats=[]}getBeatLineX(t,e){return e=e??this.direction,this.hasBeatLineX(t)?e===P.Up?this._beatLineXPositions.get(t.index).up:this._beatLineXPositions.get(t.index).down:0}hasBeatLineX(t){return this._beatLineXPositions.has(t.index)}registerBeatLineX(t,e,s,i){const a=this.getOrCreateBeatPositions(e);a.staffId=t,a.up=s,a.down=i;for(const n of this.drawingInfos.values())n.startBeat===e?n.startX=this.getBeatLineX(e):n.endBeat===e&&(n.endX=this.getBeatLineX(e))}getOrCreateBeatPositions(t){return this._beatLineXPositions.has(t.index)||this._beatLineXPositions.set(t.index,new El),this._beatLineXPositions.get(t.index)}finish(){this.direction=this.calculateDirection()}calculateDirection(){let t=null;if(this.voice?null!==this.preferredBeamDirection?t=this.preferredBeamDirection:this.voice.index>0?t=this.invert(P.Down):(this.voice.bar.isMultiVoice||this.beats[0].graceType!==K.None)&&(t=this.invert(P.Up)):t=P.Up,this.highestNoteInHelper&&this.lowestNoteInHelper){const e=this._renderer.getNoteY(this.highestNoteInHelper,Y.Center),s=this._renderer.getNoteY(this.lowestNoteInHelper,Y.Center);null===t&&(t=this.invert(this._renderer.middleYPosition<(e+s)/2?P.Up:P.Down)),this._renderer.completeBeamingHelper(this)}else t=this.invert(P.Up),this._renderer.completeBeamingHelper(this);return t}static computeLineHeightsForRest(t){switch(t){case m.QuadrupleWhole:case m.DoubleWhole:return[2,2];case m.Whole:return[0,1];case m.Half:return[1,0];case m.Quarter:return[3,3];case m.Eighth:return[2,2];case m.Sixteenth:return[2,4];case m.ThirtySecond:return[4,4];case m.SixtyFourth:return[4,6];case m.OneHundredTwentyEighth:return[6,6];case m.TwoHundredFiftySixth:return[6,8]}return[0,0]}applyRest(t,e){if(this._lastNonRestBeat&&t.index>=this._lastNonRestBeat.index||this._firstNonRestBeat&&t.index<=this._firstNonRestBeat.index)return;let s=e,i=e;const a=ks.computeLineHeightsForRest(t.duration);s-=a[0],i+=a[1];const n=this.minRestLine,o=this.maxRestLine;(null===n||n>s)&&(this.minRestLine=s,this.beatOfMinRestLine=t),(null===o||o<i)&&(this.maxRestLine=i,this.beatOfMaxRestLine=t)}invert(t){return this.invertBeamDirection?t===P.Down?P.Up:P.Down:t}checkBeat(t){t.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=t.voice);let e=!1;if(0===this.beats.length)e=!0;else switch(this.beats[this.beats.length-1].beamingMode){case ze.Auto:case ze.ForceSplitOnSecondaryToNext:e=ks.canJoin(this.beats[this.beats.length-1],t);break;case ze.ForceSplitToNext:e=!1;break;case ze.ForceMergeWithNext:e=!0}return e&&(null==this.preferredBeamDirection&&null!==t.preferredBeamDirection&&(this.preferredBeamDirection=t.preferredBeamDirection),t.hasTuplet&&(this.hasTuplet=!0),t.graceType!==K.None&&(this.isGrace=!0),t.isRest?0===this.beats.length&&this.beats.push(t):(this.isRestBeamHelper&&(this.beats=[]),this.beats.push(t),this.checkNote(t.minNote),this.checkNote(t.maxNote),this.shortestDuration<t.duration&&(this.shortestDuration=t.duration),this._firstNonRestBeat||(this._firstNonRestBeat=t),this._lastNonRestBeat=t),t.slashed&&this.slashBeats.push(t)),e}checkNote(t){if(!t)return;let e,s;this.voice&&t.isPercussion?(e=-gs.getPercussionLine(this.voice.bar,gs.getNoteValue(t)),s=e):(e=gs.getNoteValue(t),s=e,t.harmonicType!==Z.None&&t.harmonicType!==Z.Natural&&(s=t.realValue-this._staff.displayTranspositionPitch)),1===this.beats.length&&this.beats[0]===t.beat&&((-1===this._firstBeatLowestNoteCompareValue||e<this._firstBeatLowestNoteCompareValue)&&(this._firstBeatLowestNoteCompareValue=e),(-1===this._firstBeatHighestNoteCompareValue||s>this._firstBeatHighestNoteCompareValue)&&(this._firstBeatHighestNoteCompareValue=s)),(-1===this._lastBeatLowestNoteCompareValue||e<this._lastBeatLowestNoteCompareValue)&&(this._lastBeatLowestNoteCompareValue=e),(-1===this._lastBeatHighestNoteCompareValue||s>this._lastBeatHighestNoteCompareValue)&&(this._lastBeatHighestNoteCompareValue=s),(!this.lowestNoteInHelper||e<this._lowestNoteCompareValueInHelper)&&(this.lowestNoteInHelper=t,this._lowestNoteCompareValueInHelper=e),(!this.highestNoteInHelper||s>this._highestNoteCompareValueInHelper)&&(this.highestNoteInHelper=t,this._highestNoteCompareValueInHelper=s)}static canJoin(t,e){if(!t||!e||t.graceType!==e.graceType||t.graceType===K.BendGrace||e.graceType===K.BendGrace||t.deadSlapped||e.deadSlapped)return!1;if(t.graceType!==K.None&&e.graceType!==K.None)return!0;const s=t.voice.bar;if(s!==e.voice.bar)return!1;const a=t.playbackStart,n=e.playbackStart;if(!ks.canJoinDuration(t.duration)||!ks.canJoinDuration(e.duration))return a===n;if(t.tupletGroup!==e.tupletGroup)return!1;if(t.hasTuplet&&e.hasTuplet&&t.tupletGroup===e.tupletGroup&&t.tupletGroup.isFull)return!0;let o=C.QuarterTime;return 8===s.masterBar.timeSignatureDenominator&&s.masterBar.timeSignatureNumerator%3==0&&(o+=C.QuarterTime/2|0),((o+a)/o|0)==((o+n)/o|0)}static canJoinDuration(t){switch(t){case m.Whole:case m.Half:case m.Quarter:return!1;default:return!0}}static isFullBarJoin(t,e,s){return O.getIndex(t.duration)-2-s>0&&O.getIndex(e.duration)-2-s>0}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}isPositionFrom(t,e){return!this._beatLineXPositions.has(e.index)||this._beatLineXPositions.get(e.index).staffId===t||!this._beatLineXPositions.get(e.index).staffId}}class Il{constructor(t,e){this.topY=0,this.bottomY=0,this.topY=t,this.bottomY=e}}class Al{constructor(t){this.topY=-1e3,this.bottomY=-1e3,this.slots=[],this.beat=t}addSlot(t,e){if(this.slots.push(new Il(t,e)),-1e3===this.topY)this.topY=t,this.bottomY=e;else{const s=Math.min(t,e),i=Math.max(t,e);s<this.topY&&(this.topY=s),i>this.bottomY&&(this.bottomY=i)}}}class Ml{constructor(){this.reservedLayoutAreasByDisplayTime=new Map,this.restDurationsByDisplayTime=new Map}getBeatMinMaxY(){let t=-1e3,e=-1e3;for(const s of this.reservedLayoutAreasByDisplayTime.values())-1e3===t?(t=s.topY,e=s.bottomY):(t>s.topY&&(t=s.topY),e<s.bottomY&&(e=s.bottomY));return-1e3===t?[0,0]:[t,e]}reserveBeatSlot(t,e,s){e!==s&&(this.reservedLayoutAreasByDisplayTime.has(t.displayStart)||this.reservedLayoutAreasByDisplayTime.set(t.displayStart,new Al(t)),this.reservedLayoutAreasByDisplayTime.get(t.displayStart).addSlot(e,s),t.isRest&&this.registerRest(t))}registerRest(t){this.restDurationsByDisplayTime.has(t.displayStart)||this.restDurationsByDisplayTime.set(t.displayStart,new Map),this.restDurationsByDisplayTime.get(t.displayStart).has(t.playbackDuration)||this.restDurationsByDisplayTime.get(t.displayStart).set(t.playbackDuration,t.id)}applyRestCollisionOffset(t,e,s){if(t.voice.index>0&&this.reservedLayoutAreasByDisplayTime.has(t.playbackStart)){const i=ks.computeLineHeightsForRest(t.duration).map(d=>d*s),a=e-i[0],n=e+i[1];let o=a;const h=this.reservedLayoutAreasByDisplayTime.get(t.playbackStart);let c=!1;for(const d of h.slots)if(a>=d.topY&&a<=d.bottomY||n>=d.topY&&n<=d.bottomY){c=!0;break}if(c){o=1===t.voice.index?h.topY-i[1]-i[0]:h.bottomY;const d=o+i[0]+i[1],u=2*s,f=Math.ceil(Math.abs(o-a)/u);return h.addSlot(o,d),o<a?f*-u:f*u}}return 0}}class Rl{constructor(t){this.beamHelpers=[],this.beamHelperLookup=[],this.preferredBeamDirection=null,this._renderer=t,this.collisionHelper=new Ml}initialize(){const t=this._renderer,e=this._renderer.bar;let s=null,i=null;for(let a=0,n=e.voices.length;a<n;a++){const o=e.voices[a];this.beamHelpers.push([]),this.beamHelperLookup.push(new Map);for(let h=0,c=o.beats.length;h<c;h++){const d=o.beats[h];let u;d.graceType!==K.None?u=i:(u=s,i=null),(!u||!u.checkBeat(d))&&(u&&u.finish(),u=new ks(e.staff,t),u.preferredBeamDirection=this.preferredBeamDirection,u.checkBeat(d),d.graceType!==K.None?i=u:s=u,this.beamHelpers[o.index].push(u)),this.beamHelperLookup[o.index].set(d.index,u)}s&&s.finish(),i&&i.finish(),s=null,i=null}}getBeamingHelperForBeat(t){return this.beamHelperLookup[t.voice.index].get(t.index)}}let Ol=(()=>{class r extends Kt{constructor(e,s,i){super(e,s),this._textRow=0,this._fretRow=0,this._firstFretSpacing=0,this._chord=i}doLayout(){super.doLayout();const e=this.renderer.resources;this._textRow=1.5*e.effectFont.size,this._fretRow=1.5*e.effectFont.size,this._firstFretSpacing=this._chord.firstFret>1?r.FretSpacing:0,this.height=this._textRow+this._fretRow+r.Frets*r.FretSpacing+2*r.Padding[1],this.width=this._firstFretSpacing+(this._chord.strings.length-1)*r.StringSpacing+2*r.Padding[0]}paint(e,s,i){e+=this.x+r.Padding[0]+this._firstFretSpacing,s+=this.y;const a=r.StringSpacing,n=r.FretSpacing,o=this.renderer.resources,h=r.CircleRadius,c=this.width-2*r.Padding[0]-this._firstFretSpacing,d=i.textAlign,u=i.textBaseline;i.font=o.effectFont,i.textAlign=U.Center,i.textBaseline=re.Top,this._chord.showName&&i.fillText(this._chord.name,e+c/2,s+o.effectFont.size/2),s+=this._textRow,i.font=o.fretboardNumberFont,i.textBaseline=re.Middle;for(let p=0;p<this._chord.strings.length;p++){const g=e+p*a,b=s+this._fretRow/2;let w=this._chord.strings[this._chord.strings.length-p-1];w<0?i.fillMusicFontSymbol(g,b,1,l.FretboardX,!0):0===w?i.fillMusicFontSymbol(g,b,1,l.FretboardO,!0):(w-=this._chord.firstFret-1,i.fillText(w.toString(),g,b))}s+=this._fretRow;for(let p=0;p<this._chord.strings.length;p++)i.fillRect(e+p*a,s,1,n*r.Frets+1);this._chord.firstFret>1&&(i.textAlign=U.Left,i.fillText(this._chord.firstFret.toString(),e-this._firstFretSpacing,s+n/2)),i.fillRect(e,s-1,c,2);for(let p=0;p<=r.Frets;p++)i.fillRect(e,s+p*n,c,1);const f=new Map;for(const p of this._chord.barreFrets)f.set(p-this._chord.firstFret,[-1,-1]);for(let p=0;p<this._chord.strings.length;p++){let g=this._chord.strings[p];if(g>0){if(g-=this._chord.firstFret,f.has(g)){const S=f.get(g);(-1===S[0]||p<S[0])&&(S[0]=p),(-1===S[1]||p>S[1])&&(S[1]=p)}i.fillCircle(e+(this._chord.strings.length-p-1)*a,s+g*n+n/2+.5,h)}}for(const[p,g]of f){const w=e+(this._chord.strings.length-g[1]-1)*a;i.fillRect(w,s+p*n+n/2+.5-h,e+(this._chord.strings.length-g[0]-1)*a-w,2*h)}i.textAlign=d,i.textBaseline=u}}return r.Padding=[5,2],r.Frets=5,r.CircleRadius=2.5,r.StringSpacing=10,r.FretSpacing=12,r})();class Po extends ws{constructor(t,e,s=U.Center){super(t,e),this._glyphWidth=0,this.glyphs=[],this._align=s}doLayout(){let t=0;switch(this._align){case U.Left:t=0;break;case U.Center:t=(this.width-this._glyphWidth)/2;break;case U.Right:t=this.width-this._glyphWidth}for(const e of this.glyphs)e.x=t,t+=e.width}addGlyphToRow(t){this.glyphs.push(t),this._glyphWidth+=t.width,t.height>this.height&&(this.height=t.height)}}let Co=(()=>{class r extends ws{constructor(e,s,i=U.Center){super(e,s),this._rows=[],this.height=0,this.glyphs=[],this._align=i}doLayout(){let e=0,s=0;const i=r.Padding;this._rows=[];let a=new Po(e,s,this._align);a.width=this.width;for(const n of this.glyphs)e+n.width<this.width?(a.addGlyphToRow(n),e+=n.width):(a.isEmpty||(a.doLayout(),this._rows.push(a),s+=a.height+i),e=0,a=new Po(e,s,this._align),a.width=this.width,a.addGlyphToRow(n),e+=n.width);a.isEmpty||(a.doLayout(),this._rows.push(a),s+=a.height+i),this.height=s}paint(e,s,i){for(const a of this._rows)a.paint(e+this.x,s+this.y,i)}}return r.Padding=3,r})();class Hl extends Co{addChord(t){if(t.strings.length>0){const e=new Ol(0,0,t);e.renderer=this.renderer,e.doLayout(),this.glyphs.push(e)}}paint(t,e,s){if(this.glyphs.length>0){const i=me.score(s,H.ChordDiagramList,this.renderer.scoreRenderer.score);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}}class Zt extends Kt{constructor(t,e,s,i,a=U.Left,n=null,o){super(t,e),this._lineHeights=null,this._lines=s.split("\n"),this.font=i,this.textAlign=a,this.textBaseline=n,this.colorOverride=o}doLayout(){super.doLayout(),this._lineHeights=[];const t=this.renderer.scoreRenderer.canvas;for(const e of this._lines){t.font=this.font;const s=t.measureText(e),i=s.height;this._lineHeights.push(i),this.height+=i,this.width=Math.max(this.width,s.width)}}paint(t,e,s){const i=s.color;s.color=this.colorOverride??i,s.font=this.font;const a=s.textAlign,n=s.textBaseline;s.textAlign=this.textAlign,null!==this.textBaseline&&(s.textBaseline=this.textBaseline);let o=e+this.y;for(let h=0;h<this._lines.length;h++)s.fillText(this._lines[h],t+this.x,o),o+=this._lineHeights[h];s.textAlign=a,s.textBaseline=n,s.color=i}}class Wl{get staffId(){return this._factory.staffId}get contentTop(){return this.y+this.staveTop+this.topSpacing+this.topOverflow}get contentBottom(){return this.y+this.topSpacing+this.topOverflow+this.staveBottom}constructor(t,e,s){this._sharedLayoutData=new Map,this.barRenderers=[],this.x=0,this.y=0,this.height=0,this.index=0,this.staffIndex=0,this.isFirstInSystem=!1,this.trackIndex=0,this.staveTop=0,this.topSpacing=0,this.bottomSpacing=0,this.staveBottom=0,this._factory=s,this.trackIndex=t,this.modelStaff=e}getSharedLayoutData(t,e){return this._sharedLayoutData.has(t)?this._sharedLayoutData.get(t):e}setSharedLayoutData(t,e){this._sharedLayoutData.set(t,e)}get isInsideBracket(){return this._factory.isInsideBracket}get isRelevantForBoundsLookup(){return this._factory.isRelevantForBoundsLookup}registerStaffTop(t){this.staveTop=t}registerStaffBottom(t){this.staveBottom=t}addBarRenderer(t){t.staff=this,t.index=this.barRenderers.length,t.reLayout(),this.barRenderers.push(t),this.system.layout.registerBarRenderer(this.staffId,t)}addBar(t,e,s){const i=this._factory.create(this.system.layout.renderer,t);i.additionalMultiRestBars=s,i.staff=this,i.index=this.barRenderers.length,i.layoutingInfo=e,i.doLayout(),i.registerLayoutingInfo();const a=i.barDisplayWidth;a>0&&this.system.layout.systemsLayoutMode===os.FromModelWithWidths&&(i.width=a),this.barRenderers.push(i),t&&this.system.layout.registerBarRenderer(this.staffId,i)}revertLastBar(){const t=this.barRenderers[this.barRenderers.length-1];this.barRenderers.splice(this.barRenderers.length-1,1),this.system.layout.unregisterBarRenderer(this.staffId,t);for(const e of this.barRenderers)e.applyLayoutingInfo();return t}scaleToWidth(t){this._sharedLayoutData=new Map;const e=this.topOverflow;let s=0;switch(this.system.layout.systemsLayoutMode){case os.Automatic:const a=(t-this.system.computedWidth)/this.barRenderers.length;for(const o of this.barRenderers)o.x=s,o.y=this.topSpacing+e,o.scaleToWidth(o.computedWidth+a),s+=o.width;break;case os.FromModelWithScale:t-=this.system.accoladeWidth;const n=this.system.totalBarDisplayScale;for(const o of this.barRenderers)o.x=s,o.y=this.topSpacing+e,o.scaleToWidth(o.barDisplayScale*t/n),s+=o.width;break;case os.FromModelWithWidths:for(const o of this.barRenderers){o.x=s,o.y=this.topSpacing+e;const h=o.barDisplayWidth;o.scaleToWidth(h>0?h:o.computedWidth),s+=o.width}}}get topOverflow(){let t=0;for(let e=0,s=this.barRenderers.length;e<s;e++){const i=this.barRenderers[e];i.topOverflow>t&&(t=i.topOverflow)}return t}get bottomOverflow(){let t=0;for(let e=0,s=this.barRenderers.length;e<s;e++){const i=this.barRenderers[e];i.bottomOverflow>t&&(t=i.bottomOverflow)}return t}calculateHeightForAccolade(){this.topSpacing=this._factory.getStaffPaddingTop(this),this.bottomSpacing=this._factory.getStaffPaddingBottom(this),this.height=this.barRenderers.length>0?this.barRenderers[0].height:0,this.height>0&&(this.height+=this.topSpacing+this.topOverflow+this.bottomOverflow+this.bottomSpacing)}finalizeStaff(){this.topSpacing=this._factory.getStaffPaddingTop(this),this.bottomSpacing=this._factory.getStaffPaddingBottom(this),this.height=0;let t=!1,e=this.topOverflow;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].y=this.topSpacing+e,this.height=Math.max(this.height,this.barRenderers[s].height),this.barRenderers[s].finalizeRenderer()&&(t=!0);if(t){e=this.topOverflow;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].y=this.topSpacing+e;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].finalizeRenderer()}this.height>0&&(this.height+=this.topSpacing+e+this.bottomOverflow+this.bottomSpacing)}paint(t,e,s,i,a){if(0!==this.height&&0!==a)for(let n=i,o=Math.min(i+a,this.barRenderers.length);n<o;n++)this.barRenderers[n].paint(t+this.x,e+this.y,s)}}class Do{constructor(){this.timePosition=0,this.longestDuration=0,this.smallestDuration=0,this.force=0,this.springConstant=0,this.preBeatWidth=0,this.graceBeatWidth=0,this.postSpringWidth=0,this.allDurations=new Set}get springWidth(){return this.preSpringWidth+this.postSpringWidth}get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}}let Vl=(()=>{class r{constructor(){this._timeSortedSprings=[],this._minTime=-1,this._onTimePositionsForce=0,this._onTimePositions=new Map,this._incompleteGraceRodsWidth=0,this._minDuration=r.MinDuration,this.version=0,this.preBeatSize=0,this.postBeatSize=0,this.minStretchForce=0,this.totalSpringConstant=0,this.incompleteGraceRods=new Map,this.allGraceRods=new Map,this.springs=new Map,this.height=0}updateMinStretchForce(e){this.minStretchForce<e&&(this.minStretchForce=e)}getPreBeatSize(e){if(e.graceType!==K.None)return this.allGraceRods.get(e.graceGroup.id)[e.graceIndex].preBeatWidth;const s=e.absoluteDisplayStart;return this.springs.has(s)?this.springs.get(s).preBeatWidth:0}getPostBeatSize(e){if(e.graceType!==K.None)return this.allGraceRods.get(e.graceGroup.id)[e.graceIndex].postSpringWidth;const s=e.absoluteDisplayStart;return this.springs.has(s)?this.springs.get(s).postSpringWidth:0}addSpring(e,s,i,a,n){let o;if(this.version++,this.springs.has(e))o=this.springs.get(e),o.postSpringWidth<n&&(o.postSpringWidth=n),o.graceBeatWidth<i&&(o.graceBeatWidth=i),o.preBeatWidth<a&&(o.preBeatWidth=a),s<o.smallestDuration&&(o.smallestDuration=s),s>o.longestDuration&&(o.longestDuration=s),o.allDurations.add(s);else{if(o=new Do,o.timePosition=e,o.allDurations.add(s),this._timeSortedSprings.length>0){const d=this._timeSortedSprings[this._timeSortedSprings.length-1];for(const u of d.allDurations);s<this._minDuration&&(this._minDuration=s)}o.longestDuration=s,o.postSpringWidth=n,o.graceBeatWidth=i,o.preBeatWidth=a,this.springs.set(e,o);const h=this._timeSortedSprings;let c=h.length-1;for(;c>0&&h[c].timePosition>e;)c--;this._timeSortedSprings.splice(c+1,0,o)}return(-1===this._minTime||this._minTime>e)&&(this._minTime=e),o}addBeatSpring(e,s,i){const a=e.absoluteDisplayStart;if(e.graceType!==K.None){const n=e.graceGroup.id;this.allGraceRods.has(n)||this.allGraceRods.set(n,new Array(e.graceGroup.beats.length)),!e.graceGroup.isComplete&&!this.incompleteGraceRods.has(n)&&this.incompleteGraceRods.set(n,new Array(e.graceGroup.beats.length));const o=this.allGraceRods.get(n)[e.graceIndex];if(o)o.postSpringWidth<i&&(o.postSpringWidth=i),o.preBeatWidth<s&&(o.preBeatWidth=s);else{const h=new Do;h.timePosition=a,h.postSpringWidth=i,h.preBeatWidth=s,e.graceGroup.isComplete||(this.incompleteGraceRods.get(n)[e.graceIndex]=h),this.allGraceRods.get(n)[e.graceIndex]=h}}else{let n=0;if(e.graceGroup&&this.allGraceRods.has(e.graceGroup.id))for(const o of this.allGraceRods.get(e.graceGroup.id))n+=o.springWidth;this.addSpring(a,e.displayDuration,n,s,i)}}finish(){for(const[e,s]of this.allGraceRods){let i=0;for(const a of s)i+=a.preBeatWidth,a.graceBeatWidth=i,i+=a.postSpringWidth}this._incompleteGraceRodsWidth=0;for(const e of this.incompleteGraceRods.values())for(const s of e)this._incompleteGraceRodsWidth+=s.preBeatWidth+s.postSpringWidth;this.calculateSpringConstants(),this.version++}calculateSpringConstants(){let e=0;const s=this._timeSortedSprings;if(0===s.length)return this.totalSpringConstant=-1,void(this.minStretchForce=-1);for(let i=0;i<s.length;i++){const a=s[i];let n=0;n=i===s.length-1?a.longestDuration:Math.abs(s[i+1].timePosition-a.timePosition),a.springConstant=this.calculateSpringConstant(a,n),e+=1/a.springConstant}this.totalSpringConstant=1/e,this.minStretchForce=0;for(let i=0;i<s.length;i++){const a=s[i];let n=0;n=i===s.length-1?a.postSpringWidth:a.postSpringWidth+s[i+1].preSpringWidth,0===i&&(n+=a.preSpringWidth),this.updateMinStretchForce(n*a.springConstant)}}paint(e,s,i){}calculateSpringConstant(e,s){s<=0&&(s=C.toTicks(m.TwoHundredFiftySixth)),0===e.smallestDuration&&(e.smallestDuration=s);const n=r.MinDurationWidth;return e.smallestDuration/s*(1/((1+.85*Math.log2(s/this._minDuration))*n))}spaceToForce(e){return-1!==this.totalSpringConstant?(this._timeSortedSprings.length>0&&(e-=this._timeSortedSprings[0].preSpringWidth),e-=this._incompleteGraceRodsWidth,Math.max(e,0)*this.totalSpringConstant):-1}calculateVoiceWidth(e){let s=0;return-1!==this.totalSpringConstant&&(s=this.calculateWidth(e,this.totalSpringConstant)),this._timeSortedSprings.length>0&&(s+=this._timeSortedSprings[0].preSpringWidth),s+=this._incompleteGraceRodsWidth,s}calculateWidth(e,s){return e/s}buildOnTimePositions(e){if(-1===this.totalSpringConstant)return new Map;if(O.isAlmostEqualTo(this._onTimePositionsForce,e)&&this._onTimePositions)return this._onTimePositions;this._onTimePositionsForce=e;const s=new Map;this._onTimePositions=s;const i=this._timeSortedSprings;if(0===i.length)return s;let a=i[0].preSpringWidth;for(let n=0;n<i.length;n++)s.set(i[n].timePosition,a),a+=this.calculateWidth(e,i[n].springConstant);return s}}return r.MinDuration=30,r.MinDurationWidth=7,r})();class Gl{constructor(){this.width=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.additionalMultiBarRestIndexes=null,this.renderers=[]}get lastMasterBarIndex(){return this.additionalMultiBarRestIndexes?this.additionalMultiBarRestIndexes[this.additionalMultiBarRestIndexes.length-1]:this.masterBar.index}}class zl{constructor(t,e){this.staves=[],this.stavesRelevantForBoundsLookup=[],this.firstStaffInBracket=null,this.lastStaffInBracket=null,this.bracket=null,this.staffSystem=t,this.track=e}addStaff(t){this.staves.push(t),t.isRelevantForBoundsLookup&&this.stavesRelevantForBoundsLookup.push(t)}}class Ul{constructor(){this.firstStaffInBracket=null,this.lastStaffInBracket=null,this.drawAsBrace=!1,this.braceScale=1,this.width=0,this.index=0}finalizeBracket(){if(this.firstStaffInBracket===this.lastStaffInBracket)return void(this.width=0);const t=Ce.Heights.get(l.Brace),e=Ce.Widths.get(l.Brace);this.width=e,this.drawAsBrace&&this.firstStaffInBracket&&this.lastStaffInBracket&&(this.braceScale=(this.lastStaffInBracket.contentBottom-this.firstStaffInBracket.contentTop)/t,this.width=e*this.braceScale)}}class la extends Ul{constructor(t){super(),this.track=t,this.drawAsBrace=la.isTrackDrawAsBrace(t)}includesStaff(t){return t.modelStaff.track===this.track}static isTrackDrawAsBrace(t){return t.staves.filter(e=>e.showStandardNotation).length>1}}class Yl extends la{includesStaff(t){return t.modelStaff.track===this.track||!this.drawAsBrace&&this.track.playbackInfo.program===t.modelStaff.track.playbackInfo.program}}let Xl=(()=>{class r{constructor(e){this._allStaves=[],this._firstStaffInBrackets=null,this._lastStaffInBrackets=null,this._accoladeSpacingCalculated=!1,this._brackets=[],this._hasSystemSeparator=!1,this.x=0,this.y=0,this.index=0,this.accoladeWidth=0,this.isFull=!1,this.width=0,this.computedWidth=0,this.totalBarDisplayScale=0,this.isLast=!1,this.masterBarsRenderers=[],this.staves=[],this.layout=e,this.topPadding=e.renderer.settings.display.systemPaddingTop,this.bottomPadding=e.renderer.settings.display.systemPaddingBottom}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].lastMasterBarIndex}addMasterBarRenderers(e,s){if(0===e.length)return null;this.masterBarsRenderers.push(s),s.layoutingInfo.preBeatSize=0;let i=0;for(let a=0,n=this.staves.length;a<n;a++){const o=this.staves[a];for(let h=0,c=o.staves.length;h<c;h++){const u=s.renderers[i++];o.staves[h].addBarRenderer(u)}}return this.calculateAccoladeSpacing(e),this.updateWidthFromLastBar(),s}addBars(e,s,i){const a=new Gl;a.additionalMultiBarRestIndexes=i,a.layoutingInfo=new Vl,a.masterBar=e[0].score.masterBars[s],this.masterBarsRenderers.push(a);const n=a.layoutingInfo;for(const o of this.staves)for(const h of o.staves){const c=o.track.staves[h.modelStaff.index].bars[s],d=null==i?null:i.map(f=>o.track.staves[h.modelStaff.index].bars[f]);h.addBar(c,n,d);const u=h.barRenderers[h.barRenderers.length-1];a.renderers.push(u),u.isLinkedToPrevious&&(a.isLinkedToPrevious=!0),u.canWrap||(a.canWrap=!1)}return this.calculateAccoladeSpacing(e),n.finish(),a.width=this.updateWidthFromLastBar(),a}revertLastBar(){if(this.masterBarsRenderers.length>1){const e=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let s=0,i=0;for(let a=0,n=this._allStaves.length;a<n;a++){const h=this._allStaves[a].revertLastBar(),c=h.computedWidth;c>s&&(s=c);const d=h.barDisplayScale;d>i&&(i=d)}return this.width-=s,this.computedWidth-=s,this.totalBarDisplayScale-=i,e}return null}updateWidthFromLastBar(){let e=0,s=0;for(let i=0,a=this._allStaves.length;i<a;i++){const n=this._allStaves[i],o=n.barRenderers[n.barRenderers.length-1];o.applyLayoutingInfo(),o.computedWidth>e&&(e=o.computedWidth);const h=o.barDisplayScale;h>s&&(s=h)}return this.width+=e,this.computedWidth+=e,this.totalBarDisplayScale+=s,e}calculateAccoladeSpacing(e){const s=this.layout.renderer.settings;if(!this._accoladeSpacingCalculated){this._accoladeSpacingCalculated=!0,this.accoladeWidth=0;const i=this.layout.renderer.score.stylesheet;if(this.layout.renderer.settings.notation.isNotationElementVisible(fe.TrackNames)){const c=0===this.index?i.firstSystemTrackNameMode:i.otherSystemsTrackNameMode,d=0===this.index?i.firstSystemTrackNameOrientation:i.otherSystemsTrackNameOrientation;let u=!1;switch(1===this.layout.renderer.tracks.length?i.singleTrackTrackNamePolicy:i.multiTrackTrackNamePolicy){case Oe.Hidden:break;case Oe.FirstSystem:u=0===this.index;break;case Oe.AllSystems:u=!0}let f=!1;if(u){const p=this.layout.renderer.canvas;p.font=s.display.resources.effectFont;for(const b of e){let w="";switch(c){case nt.FullName:w=b.name;break;case nt.ShortName:w=b.shortName}if(w.length>0){f=!0;const S=p.measureText(w);switch(d){case ot.Horizontal:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,S.width));break;case ot.Vertical:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,S.height))}}}f&&(this.accoladeWidth+=s.display.systemLabelPaddingLeft,this.accoladeWidth+=s.display.systemLabelPaddingRight)}}let n=0;for(const h of this._allStaves)h.y=n,h.calculateHeightForAccolade(),n+=h.height;let o=0;for(const h of this._brackets)h.finalizeBracket(),o=Math.max(o,h.width);this.accoladeWidth+=o,this.width+=this.accoladeWidth,this.computedWidth+=this.accoladeWidth}}getStaffTrackGroup(e){for(let s=0,i=this.staves.length;s<i;s++){const a=this.staves[s];if(a.track===e)return a}return null}addStaff(e,s){let i=this.getStaffTrackGroup(e);if(i||(i=new zl(this,e),this.staves.push(i)),s.staffTrackGroup=i,s.system=this,s.index=this._allStaves.length,this._allStaves.push(s),i.addStaff(s),s.isInsideBracket){this._firstStaffInBrackets||(this._firstStaffInBrackets=s,s.isFirstInSystem=!0),i.firstStaffInBracket||(i.firstStaffInBracket=s),this._lastStaffInBrackets=s,i.lastStaffInBracket=s;let a=this._brackets.find(n=>n.includesStaff(s));if(!a)switch(e.score.stylesheet.bracketExtendMode){case Vt.NoBrackets:break;case Vt.GroupStaves:a=new la(e),a.index=this._brackets.length,this._brackets.push(a);break;case Vt.GroupSimilarInstruments:a=new Yl(e),a.index=this._brackets.length,this._brackets.push(a)}a&&(a.firstStaffInBracket||(a.firstStaffInBracket=s),a.lastStaffInBracket=s,i.bracket=a)}}get height(){return 0===this._allStaves.length?0:this._allStaves[this._allStaves.length-1].y+this._allStaves[this._allStaves.length-1].height+this.topPadding+this.bottomPadding}scaleToWidth(e){for(let s=0,i=this._allStaves.length;s<i;s++)this._allStaves[s].scaleToWidth(e);this.width=e}paint(e,s,i){if(this.paintPartial(e+this.x,(s+=this.topPadding)+this.y,i,0,this.masterBarsRenderers.length),this._hasSystemSeparator){const a=me.track(i,Ds.SystemSeparator,this._allStaves[0].modelStaff.track);try{i.fillMusicFontSymbol(e+this.x,s+this.y+this.height-10,1,l.SystemDivider,!1),i.fillMusicFontSymbol(e+this.x+this.width-r.SystemSignSeparatorWidth,s+this.y+this.height-r.SystemSignSeparatorPadding,1,l.SystemDivider,!1)}finally{a?.[Symbol.dispose]?.()}}}paintPartial(e,s,i,a,n){for(let h=0,c=this._allStaves.length;h<c;h++)this._allStaves[h].paint(e,s,i,a,n);const o=this.layout.renderer.settings.display.resources;if(this.staves.length>0&&0===a){i.color=o.barSeparatorColor;const h=this.layout.renderer.settings,c=this.layout.renderer.settings.notation.isNotationElementVisible(fe.TrackNames);if(i.font=o.effectFont,c){const d=this.layout.renderer.score.stylesheet,f=0===this.index?d.firstSystemTrackNameMode:d.otherSystemsTrackNameMode,p=0===this.index?d.firstSystemTrackNameOrientation:d.otherSystemsTrackNameOrientation;let g=!1;switch(1===this.layout.renderer.tracks.length?d.singleTrackTrackNamePolicy:d.multiTrackTrackNamePolicy){case Oe.Hidden:break;case Oe.FirstSystem:g=0===this.index;break;case Oe.AllSystems:g=!0}if(g){const b=i.textBaseline,w=i.textAlign;for(const S of this.staves)if(S.firstStaffInBracket&&S.lastStaffInBracket){const D=s+S.firstStaffInBracket.contentTop,N=s+S.lastStaffInBracket.contentBottom;let L="";switch(f){case nt.FullName:L=S.track.name;break;case nt.ShortName:L=S.track.shortName}const $=me.track(i,Ds.TrackName,S.track);try{if(L.length>0){const E=e+S.firstStaffInBracket.x-h.display.accoladeBarPaddingRight-(S.bracket?.width??0)-h.display.systemLabelPaddingRight;switch(p){case ot.Horizontal:i.textBaseline=re.Middle,i.textAlign=U.Right,i.fillText(L,E,(D+N)/2);break;case ot.Vertical:i.textBaseline=re.Bottom,i.textAlign=U.Center,i.beginRotate(E,(D+N)/2,-90.1),i.fillText(L,0,0),i.endRotate()}}}finally{$?.[Symbol.dispose]?.()}}i.textBaseline=b,i.textAlign=w}}if(this._allStaves.length>0){let d=null;for(const u of this._allStaves)if(u.isInsideBracket){if(null!==d){const f=d.contentBottom,p=u.contentTop,g=e+d.x,b=d.barRenderers[0],w=me.bar(i,b.staffLineBarSubElement,b.bar);try{const S=Math.ceil(p-f);i.fillRect(g,s+f,1,S)}finally{w?.[Symbol.dispose]?.()}}d=u}}for(const d of this._brackets)if(d.firstStaffInBracket&&d.lastStaffInBracket){const u=e+d.firstStaffInBracket.x,f=d.width,p=h.display.accoladeBarPaddingRight;let w=s+d.firstStaffInBracket.contentTop,S=s+d.lastStaffInBracket.contentBottom;if(d.drawAsBrace)i.fillMusicFontSymbol(u-p-f,S,d.braceScale,l.Brace);else if(d.firstStaffInBracket!==d.lastStaffInBracket){const D=f/2;w-=D,S+=2*D,i.fillRect(u-p-f,w,f,Math.ceil(S-w));const N=u-p-f-.5;i.fillMusicFontSymbol(N,w,1,l.BracketTop),i.fillMusicFontSymbol(N,Math.floor(S),1,l.BracketBottom)}}}}finalizeSystem(){const e=this.layout.renderer.settings;0===this.index&&(this.topPadding=e.display.firstSystemPaddingTop),this.isLast?this.bottomPadding=e.display.lastSystemPaddingBottom:this.layout.renderer.score.stylesheet.useSystemSignSeparator&&this.layout.renderer.tracks.length>1&&(this.bottomPadding+=r.SystemSignSeparatorHeight,this._hasSystemSeparator=!0);let s=0;for(const i of this._allStaves)i.x=this.accoladeWidth,i.y=s,i.finalizeStaff(),s+=i.height;for(const i of this._brackets)i.finalizeBracket()}buildBoundingsLookup(e,s){if(this.layout.renderer.boundsLookup.isFinished)return;const i=this._firstStaffInBrackets,a=this._lastStaffInBrackets;if(!i||!a)return;const n=this._allStaves[this._allStaves.length-1],o=(s+=this.topPadding)+this.y+i.y,c=s+this.y+this._allStaves[0].y,u=s+this.y+i.y+i.topSpacing+i.topOverflow+(i.barRenderers.length>0?i.barRenderers[0].topPadding:0),p=s+this.y+a.y+a.height-o,g=s+this.y+n.y+n.height-n.bottomSpacing-n.bottomOverflow-(n.barRenderers.length>0?n.barRenderers[0].bottomPadding:0)-u,b=s+this.y+n.y+n.height-c,w=this.x+i.x,S=new nn;S.visualBounds=new St,S.visualBounds.x=e+this.x,S.visualBounds.y=s+this.y,S.visualBounds.w=this.width,S.visualBounds.h=this.height-this.topPadding-this.bottomPadding,S.realBounds=new St,S.realBounds.x=e+this.x,S.realBounds.y=s+this.y,S.realBounds.w=this.width,S.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaffSystem(S);const D=new Map;for(let N=0;N<this.staves.length;N++)for(const L of this.staves[N].stavesRelevantForBoundsLookup)for(const $ of L.barRenderers){let E;D.has($.bar.masterBar.index)?E=D.get($.bar.masterBar.index):(E=new an,E.index=$.bar.masterBar.index,E.isFirstOfLine=$.isFirstOfLine,E.realBounds=new St,E.realBounds.x=w+$.x,E.realBounds.y=c,E.realBounds.w=$.width,E.realBounds.h=b,E.visualBounds=new St,E.visualBounds.x=w+$.x,E.visualBounds.y=o,E.visualBounds.w=$.width,E.visualBounds.h=p,E.lineAlignedBounds=new St,E.lineAlignedBounds.x=w+$.x,E.lineAlignedBounds.y=u,E.lineAlignedBounds.w=$.width,E.lineAlignedBounds.h=g,this.layout.renderer.boundsLookup.addMasterBar(E),D.set(E.index,E)),$.buildBoundingsLookup(E,w,s+this.y+L.y)}}getBarX(e){return this._firstStaffInBrackets&&0!==this.layout.renderer.tracks.length?this.layout.getRendererForBar(this._firstStaffInBrackets.staffId,this.layout.renderer.tracks[0].staves[0].bars[e]).x:0}}return r.SystemSignSeparatorHeight=40,r.SystemSignSeparatorPadding=10,r.SystemSignSeparatorWidth=36,r})();class Jl extends Co{constructor(t,e){super(t,e,U.Left)}}let ca=(()=>{class r extends ws{constructor(e,s,i,a){super(e,s),this._tuning=i,this._trackLabel=a,this.glyphs=[]}doLayout(){if(!(this.glyphs.length>0)){this.createGlyphs(this._tuning);for(const e of this.glyphs)e.renderer=this.renderer,e.doLayout()}}paint(e,s,i){i.textBaseline=re.Middle;const a=i.color;this.colorOverride&&(i.color=this.colorOverride),super.paint(e,s,i),i.color=a}createGlyphs(e){const s=this.renderer.resources;if(this.height=0,this._trackLabel.length>0){this.height+=1;const h=new Zt(0,this.height,this._trackLabel,s.effectFont,U.Left);h.renderer=this.renderer,h.doLayout(),this.height+=h.height+1,h.y+=h.height/2,this.addGlyph(h)}const n=new Zt(0,this.height,e.name,s.effectFont,U.Left);if(n.renderer=this.renderer,n.doLayout(),this.height+=n.height,n.y+=n.height/2,this.addGlyph(n),this.renderer.scoreRenderer.canvas.font=s.effectFont,this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this._trackLabel).width,Math.max(this.renderer.scoreRenderer.canvas.measureText(e.name).width,128)),!e.isStandard){this.height+=15;const h=r.CircleNumberScale,c=Ce.Heights.get(l.GuitarString0)*h,d=0|Math.ceil(e.tunings.length/2);let u=0,f=this.height;for(let p=0,g=e.tunings.length;p<g;p++){this.addGlyph(new lt(u,f+c/2.5,h,l.GuitarString0+(p+1)));const w=`= ${F.getTextForTuning(e.tunings[p],!1)}`;this.addGlyph(new Zt(u+c+1,f,w,s.effectFont,U.Left)),f+=15,p===d-1&&(f=this.height,u+=64)}this.height+=15*d}this.width+=15}}return r.CircleNumberScale=.7,r})();class ql{constructor(t,e){this.args=t,this.renderCallback=e}}var os=function(r){return r[r.Automatic=0]="Automatic",r[r.FromModelWithScale=1]="FromModelWithScale",r[r.FromModelWithWidths=2]="FromModelWithWidths",r}(os||{});class Xs{get scaledWidth(){return Math.round(this.width/this.renderer.settings.display.scale)}constructor(t){this._barRendererLookup=new Map,this.pagePadding=null,this.width=0,this.height=0,this.multiBarRestInfo=null,this.headerGlyphs=new Map,this.footerGlyphs=new Map,this.chordDiagrams=null,this.tuningGlyph=null,this.systemsLayoutMode=os.Automatic,this._lazyPartials=new Map,this.firstBarIndex=0,this.lastBarIndex=0,this.renderer=t}resize(){this._lazyPartials.clear(),this.doResize()}layoutAndRender(){this._lazyPartials.clear();const t=this.renderer.score;this.firstBarIndex=O.computeFirstDisplayedBarIndex(t,this.renderer.settings),this.lastBarIndex=O.computeLastDisplayedBarIndex(t,this.renderer.settings,this.firstBarIndex),this.multiBarRestInfo=O.buildMultiBarRestInfo(this.renderer.tracks,this.firstBarIndex,this.lastBarIndex),this.pagePadding=this.renderer.settings.display.padding.map(e=>e/this.renderer.settings.display.scale),this.pagePadding||(this.pagePadding=[0,0,0,0]),1===this.pagePadding.length?this.pagePadding=[this.pagePadding[0],this.pagePadding[0],this.pagePadding[0],this.pagePadding[0]]:2===this.pagePadding.length&&(this.pagePadding=[this.pagePadding[0],this.pagePadding[1],this.pagePadding[0],this.pagePadding[1]]),this.createScoreInfoGlyphs(),this.doLayoutAndRender()}registerPartial(t,e){if(0===t.height)return;const s=this.renderer.settings.display.scale;t.x*=s,t.y*=s,t.width*=s,t.height*=s,t.totalWidth*=s,t.totalHeight*=s,this.renderer.settings.core.enableLazyLoading?(this._lazyPartials.set(t.id,new ql(t,e)),this.renderer.partialLayoutFinished.trigger(t)):(this.renderer.partialLayoutFinished.trigger(t),this.internalRenderLazyPartial(t,e))}internalRenderLazyPartial(t,e){const s=this.renderer.canvas;s.beginRender(t.width,t.height),e(s),t.renderResult=s.endRender(),this.renderer.partialRenderFinished.trigger(t)}renderLazyPartial(t){if(this._lazyPartials.has(t)){const e=this._lazyPartials.get(t);this.internalRenderLazyPartial(e.args,e.renderCallback)}}createHeaderFooterGlyph(t,e,s,i){switch(s){case H.WordsAndMusic:if(e.words!==e.music)return;break;case H.Words:case H.Music:if(e.words===e.music)return;break;case H.CopyrightSecondLine:if(!this.headerGlyphs.has(H.Copyright))return}const a=t.display.resources,n=t.notation,h=e.style&&e.style.headerAndFooter.has(s)?e.style.headerAndFooter.get(s):fi.defaultHeaderAndFooter.get(s);let c=void 0===h.isVisible||h.isVisible;if(void 0!==i&&(c=n.isNotationElementVisible(i)),!c)return;const d=h.buildText(e);return d?new Zt(0,0,d,a.getFontForElement(s),h.textAlign,void 0,me.scoreColor(a,s,e)):void 0}createScoreInfoGlyphs(){x.debug("ScoreLayout","Creating score info glyphs");const t=this.renderer.settings,e=this.renderer.score;this.headerGlyphs=new Map,this.footerGlyphs=new Map;const s=new qe(this.renderer,this.renderer.tracks[0].staves[0].bars[0]);for(const[n,o]of Xs.HeaderElements.value){const h=this.createHeaderFooterGlyph(t,e,n,o);h&&(h.renderer=s,h.doLayout(),this.headerGlyphs.set(n,h))}for(const[n,o]of Xs.FooterElements.value){const h=this.createHeaderFooterGlyph(t,e,n,o);h&&(h.renderer=s,h.doLayout(),this.footerGlyphs.set(n,h))}const i=t.notation,a=t.display.resources;if(i.isNotationElementVisible(fe.GuitarTuning)){const n=[];for(const o of this.renderer.tracks)for(const h of o.staves){let c=!h.isPercussion&&h.isStringed&&h.tuning.length>0&&h.showTablature;if(e.stylesheet.perTrackDisplayTuning&&e.stylesheet.perTrackDisplayTuning.has(o.index)&&!1===e.stylesheet.perTrackDisplayTuning.get(o.index)&&(c=!1),c){n.push(h);break}}if(n.length>0&&e.stylesheet.globalDisplayTuning){this.tuningGlyph=new Jl(0,0),this.tuningGlyph.renderer=s;for(const o of n)if(o.stringTuning.tunings.length>0){const c=new ca(0,0,o.stringTuning,n.length>1?o.track.name:"");c.colorOverride=me.trackColor(a,Ds.StringTuning,o.track),c.renderer=s,c.doLayout(),this.tuningGlyph.addGlyph(c)}}else this.tuningGlyph=null}if(i.isNotationElementVisible(fe.ChordDiagrams)){this.chordDiagrams=new Hl(0,0),this.chordDiagrams.renderer=s;const n=new Set;for(const o of this.renderer.tracks)if(e.stylesheet.globalDisplayChordDiagramsOnTop&&(null==e.stylesheet.perTrackChordDiagramsOnTop||!e.stylesheet.perTrackChordDiagramsOnTop.has(o.index)||e.stylesheet.perTrackChordDiagramsOnTop.get(o.index)))for(const c of o.staves){const d=c.chords;if(d)for(const[,u]of d)n.has(u.uniqueId)||u.showDiagram&&(n.add(u.uniqueId),this.chordDiagrams.addChord(u))}this.chordDiagrams.isEmpty&&(this.chordDiagrams=null)}else this.chordDiagrams=null}createEmptyStaffSystem(){const t=new Xl(this);for(let e=0;e<this.renderer.tracks.length;e++){const s=this.renderer.tracks[e];for(let i=0;i<s.staves.length;i++){const a=s.staves[i],n=_.staveProfiles.get(this.renderer.settings.display.staveProfile);for(const o of n)o.canCreate(s,a)&&t.addStaff(s,new Wl(e,a,o))}}return t}registerBarRenderer(t,e){if(this._barRendererLookup.has(t)||this._barRendererLookup.set(t,new Map),this._barRendererLookup.get(t).set(e.bar.id,e),e.additionalMultiRestBars)for(const s of e.additionalMultiRestBars)this._barRendererLookup.get(t).set(s.id,e)}unregisterBarRenderer(t,e){if(this._barRendererLookup.has(t)){const s=this._barRendererLookup.get(t);if(s.delete(e.bar.id),e.additionalMultiRestBars)for(const i of e.additionalMultiRestBars)s.delete(i.id)}}getRendererForBar(t,e){const s=e.id;return this._barRendererLookup.has(t)&&this._barRendererLookup.get(t).has(s)?this._barRendererLookup.get(t).get(s):null}layoutAndRenderBottomScoreInfo(t){t=Math.round(t);const e=new zs;e.x=0,e.y=t;let s=0;const i=this.renderer.settings.display.resources,a=[];let n=0;for(const[o,h]of Xs.FooterElements.value)if(this.footerGlyphs.has(o)){const c=this.footerGlyphs.get(o);c.y=s,this.alignScoreInfoGlyph(c),s+=1.2*c.font.size,a.push(c),n=Math.max(n,Math.round(c.x+c.width))}return s=Math.round(s),a.length>0&&(e.width=n,e.height=s,e.totalWidth=this.scaledWidth,e.totalHeight=t+e.height,this.registerPartial(e,o=>{o.color=i.scoreInfoColor,o.textAlign=U.Left,o.textBaseline=re.Top;for(const h of a)h.paint(0,0,o)})),t+s}alignScoreInfoGlyph(t){if(_.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical)switch(t.textAlign){case U.Left:t.x=this.pagePadding[0];break;case U.Center:t.x=this.scaledWidth/2;break;case U.Right:t.x=this.scaledWidth-this.pagePadding[2]}else t.x=this.firstBarX,t.textAlign=U.Left}layoutAndRenderAnnotation(t){const s=this.renderer.settings.display.resources,a=de.withFamilyList(s.copyrightFont.families,12,Xe.Plain,Ut.Bold),n=new qe(this.renderer,this.renderer.tracks[0].staves[0].bars[0]),o=new Zt(0,0,"rendered by alphaTab",a,U.Center,void 0,s.mainGlyphColor);o.renderer=n,o.doLayout(),this.alignScoreInfoGlyph(o);const h=new zs;return h.width=o.x+o.width,h.x=0,h.height=12,h.y=t,h.totalWidth=this.scaledWidth,h.totalHeight=t+12,h.firstMasterBarIndex=-1,h.lastMasterBarIndex=-1,this.registerPartial(h,c=>{c.color=s.mainGlyphColor,c.font=a,c.textAlign=U.Left,c.textBaseline=re.Top,o.paint(0,0,c)}),t+12}}Xs.HeaderElements=new Ji(()=>new Map([[H.Title,fe.ScoreTitle],[H.SubTitle,fe.ScoreSubTitle],[H.Artist,fe.ScoreArtist],[H.Album,fe.ScoreAlbum],[H.Words,fe.ScoreWords],[H.Music,fe.ScoreMusic],[H.WordsAndMusic,fe.ScoreWordsAndMusic],[H.Transcriber,void 0]])),Xs.FooterElements=new Ji(()=>new Map([[H.Copyright,fe.ScoreCopyright],[H.CopyrightSecondLine,void 0]]));class ri extends ws{constructor(){super(0,0),this._effectGlyphs=[],this._normalGlyphs=[],this.computedWidth=0}doLayout(){let t=0;if(this.glyphs)for(let e=0,s=this.glyphs.length;e<s;e++){const i=this.glyphs[e];i.x=t,i.renderer=this.renderer,i.doLayout(),t+=i.width}this.width=t,this.computedWidth=t}noteLoop(t){for(let e=this.container.beat.notes.length-1;e>=0;e--)t(this.container.beat.notes[e])}addEffect(t){super.addGlyph(t),this._effectGlyphs.push(t)}addNormal(t){super.addGlyph(t),this._normalGlyphs.push(t)}get effectElement(){}paint(t,e,s){this.paintEffects(t,e,s),this.paintNormal(t,e,s)}paintNormal(t,e,s){for(const i of this._normalGlyphs)i.paint(t+this.x,e+this.y,s)}paintEffects(t,e,s){const i=this.effectElement?me.beat(s,this.effectElement,this.container.beat):void 0;try{for(const a of this._effectGlyphs)a.paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}class ai extends ri{constructor(){super(...arguments),this.centerX=0}updateBeamingHelper(){}buildBoundingsLookup(t,e,s){}getNoteX(t,e){return 0}getNoteY(t,e){return 0}}let da=(()=>{class r extends $e{constructor(e,s,i,a=1){super(e,s),this._scale=0,this._symbols=[],this._symbols=r.getSymbols(i),this._scale=a}static getSymbols(e){const s=[];for(;e>0;)s.unshift(r.getSymbol(e%10)),e=e/10|0;return s}static getSymbol(e){switch(e){case 0:return l.TimeSig0;case 1:return l.TimeSig1;case 2:return l.TimeSig2;case 3:return l.TimeSig3;case 4:return l.TimeSig4;case 5:return l.TimeSig5;case 6:return l.TimeSig6;case 7:return l.TimeSig7;case 8:return l.TimeSig8;case 9:return l.TimeSig9;default:return l.None}}doLayout(){let e=0;for(const s of this._symbols)e+=Ce.Widths.get(s);this.width=e}paint(e,s,i){i.fillMusicFontSymbols(e+this.x,s+this.y,this._scale,this._symbols)}}return r.numberHeight=18,r})(),$l=(()=>{class r extends $e{constructor(){super(0,0),this._numberGlyph=[]}doLayout(){this.width=70,this.renderer.registerOverflowTop(this.renderer.getLineHeight(1)),this._numberGlyph=da.getSymbols(this.renderer.additionalMultiRestBars.length+1)}paint(e,s,i){i.fillMusicFontSymbols(e+this.x,s+this.y+this.renderer.height/2,1,[l.RestHBarLeft,l.RestHBarMiddle,l.RestHBarMiddle,l.RestHBarMiddle,l.RestHBarRight]);const a=this.renderer.getLineY(-1.5);i.fillMusicFontSymbols(e+this.x+r.BarWidth/2,s+this.y+a|0,1,this._numberGlyph,!0)}}return r.BarWidth=60,r})();class ua extends bs{constructor(t){super(ua.getOrCreatePlaceholderBeat(t),t),this.preNotes=new ri,this.onNotes=new ai}doLayout(){this.renderer.showMultiBarRest&&this.onNotes.addNormal(new $l),super.doLayout()}static getOrCreatePlaceholderBeat(t){if(t.voice.beats.length>1)return t.voice.beats[0];const e=new xt;return e.voice=t.voice,e}}var Y=function(r){return r[r.TopWithStem=0]="TopWithStem",r[r.Top=1]="Top",r[r.Center=2]="Center",r[r.Bottom=3]="Bottom",r[r.BottomWithStem=4]="BottomWithStem",r}(Y||{}),We=function(r){return r[r.Left=0]="Left",r[r.Center=1]="Center",r[r.Right=2]="Right",r}(We||{});class qe{get nextRenderer(){return this.bar&&this.bar.nextBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.nextBar):null}get previousRenderer(){return this.bar&&this.bar.previousBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.previousBar):null}get lastBar(){return this.additionalMultiRestBars?this.additionalMultiRestBars[this.additionalMultiRestBars.length-1]:this.bar}get showMultiBarRest(){return!1}constructor(t,e){this._preBeatGlyphs=new _i,this._voiceContainers=new Map,this._postBeatGlyphs=new _i,this._ties=[],this.additionalMultiRestBars=null,this.x=0,this.y=0,this.width=0,this.computedWidth=0,this.height=0,this.index=0,this.topOverflow=0,this.bottomOverflow=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.wasFirstOfLine=!1,this._appliedLayoutingInfo=0,this.isFinalized=!1,this.topPadding=0,this.bottomPadding=0,this.scoreRenderer=t,this.bar=e,e&&(this.helpers=new Rl(this))}registerTies(t){this._ties.push(...t)}get middleYPosition(){return 0}registerOverflowTop(t){return t>this.topOverflow&&(this.topOverflow=t,!0)}registerOverflowBottom(t){return t>this.bottomOverflow&&(this.bottomOverflow=t,!0)}scaleToWidth(t){const e=t-this._preBeatGlyphs.width-this._postBeatGlyphs.width;for(const s of this._voiceContainers.values())s.scaleToWidth(e);this._postBeatGlyphs.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width+e,this.width=t}get resources(){return this.settings.display.resources}get settings(){return this.scoreRenderer.settings}get barDisplayScale(){return this.staff.system.staves.length>1?this.bar.masterBar.displayScale:this.bar.displayScale}get barDisplayWidth(){return this.staff.system.staves.length>1?this.bar.masterBar.displayWidth:this.bar.displayWidth}get isFirstOfLine(){return 0===this.index}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}registerLayoutingInfo(){const t=this.layoutingInfo,e=this._preBeatGlyphs.width;t.preBeatSize<e&&(t.preBeatSize=e);for(const i of this._voiceContainers.values())i.registerLayoutingInfo(t);const s=this._postBeatGlyphs.width;t.postBeatSize<s&&(t.postBeatSize=s)}applyLayoutingInfo(){if(this._appliedLayoutingInfo>=this.layoutingInfo.version)return!1;this._appliedLayoutingInfo=this.layoutingInfo.version,this._preBeatGlyphs.width=this.layoutingInfo.preBeatSize;let t=this._preBeatGlyphs.x+this._preBeatGlyphs.width;for(const s of this._voiceContainers.values()){s.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width,s.applyLayoutingInfo(this.layoutingInfo);const i=s.x+s.width;t<i&&(t=i)}this._postBeatGlyphs.x=Math.floor(t),this._postBeatGlyphs.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.computedWidth=this.width;const e=this.barDisplayWidth;return e>0&&this.scoreRenderer.layout.systemsLayoutMode===os.FromModelWithWidths&&(this.width=e,this.computedWidth=e),!0}finalizeRenderer(){this.isFinalized=!0;let t=!1;const e=this.y-this.staff.topSpacing,s=this.y+this.height+this.staff.bottomSpacing;for(const i of this._ties)if(i.doLayout(),i.height>0){const a=i.y+i.height-s;a>0&&this.registerOverflowBottom(a)&&(t=!0);const n=i.y-e;n<0&&this.registerOverflowTop(-1*n)&&(t=!0)}return t}doLayout(){if(this.bar){this.helpers.initialize(),this._ties=[],this._preBeatGlyphs=new _i,this._preBeatGlyphs.renderer=this,this._voiceContainers.clear(),this._postBeatGlyphs=new _i,this._postBeatGlyphs.renderer=this;for(let t=0;t<this.bar.voices.length;t++){const e=this.bar.voices[t];if(this.hasVoiceContainer(e)){const s=new Fl(0,0,e);s.renderer=this,this._voiceContainers.set(this.bar.voices[t].index,s)}}if(this.bar.simileMark===je.SecondOfDouble&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.additionalMultiRestBars){const t=new ua(this.getVoiceContainer(this.bar.voices[0]));this.addBeatGlyph(t)}else this.createBeatGlyphs();this.createPostBeatGlyphs(),this.updateSizes();for(const t of this.helpers.beamHelpers)for(const e of t)e.finish();this.computedWidth=this.width}}hasVoiceContainer(t){return!(!this.additionalMultiRestBars&&0!==t.index&&t.isEmpty)}updateSizes(){this.staff.registerStaffTop(this.topPadding),this.staff.registerStaffBottom(this.height-this.bottomPadding);const t=this._voiceContainers,e=this.beatGlyphsStart;let s=e;for(const i of t.values()){i.x=e,i.doLayout();const a=i.x+i.width;s<a&&(s=a)}this._postBeatGlyphs.x=Math.floor(s),this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.height+=this.layoutingInfo.height}addPreBeatGlyph(t){t.renderer=this,this._preBeatGlyphs.addGlyph(t)}addBeatGlyph(t){t.renderer=this,t.preNotes.renderer=this,t.onNotes.renderer=this,t.onNotes.beamingHelper=this.helpers.beamHelperLookup[t.beat.voice.index].get(t.beat.index),this.getVoiceContainer(t.beat.voice).addGlyph(t)}getVoiceContainer(t){return this._voiceContainers.has(t.index)?this._voiceContainers.get(t.index):void 0}getBeatContainer(t){return this.getVoiceContainer(t.voice)?.beatGlyphs?.[t.index]}getPreNotesGlyphForBeat(t){return this.getBeatContainer(t)?.preNotes}getOnNotesGlyphForBeat(t){return this.getBeatContainer(t)?.onNotes}paint(t,e,s){this.paintBackground(t,e,s),s.color=this.resources.mainGlyphColor,this._preBeatGlyphs.paint(t+this.x,e+this.y,s);for(const i of this._voiceContainers.values())i.paint(t+this.x,e+this.y,s);s.color=this.resources.mainGlyphColor,this._postBeatGlyphs.paint(t+this.x,e+this.y,s)}paintBackground(t,e,s){this.layoutingInfo.paint(t+this.x+this._preBeatGlyphs.x+this._preBeatGlyphs.width,e+this.y+this.height,s)}buildBoundingsLookup(t,e,s){const i=new sn;i.bar=this.bar,i.visualBounds=new St,i.visualBounds.x=e+this.x,i.visualBounds.y=s+this.y+this.topPadding,i.visualBounds.w=this.width,i.visualBounds.h=this.height-this.topPadding-this.bottomPadding,i.realBounds=new St,i.realBounds.x=e+this.x,i.realBounds.y=s+this.y,i.realBounds.w=this.width,i.realBounds.h=this.height,t.addBar(i);for(const[a,n]of this._voiceContainers){const o=this.bar.isEmpty&&0===a;if(!n.voice.isEmpty||o)for(let h=0,c=n.beatGlyphs.length;h<c;h++)n.beatGlyphs[h].buildBoundingsLookup(i,e+this.x+n.x,s+this.y+n.y,o)}}addPostBeatGlyph(t){this._postBeatGlyphs.addGlyph(t)}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine}createBeatGlyphs(){for(const t of this.bar.voices)this.hasVoiceContainer(t)&&this.createVoiceGlyphs(t)}createVoiceGlyphs(t){}createPostBeatGlyphs(){}get beatGlyphsStart(){return this._preBeatGlyphs.x+this._preBeatGlyphs.width}get postBeatGlyphsStart(){return this._postBeatGlyphs.x}getBeatX(t,e=be.PreNotes){const s=this.getBeatContainer(t);if(s)switch(e){case be.PreNotes:return s.voiceContainer.x+s.x;case be.OnNotes:return s.voiceContainer.x+s.x+s.onNotes.x;case be.MiddleNotes:return s.voiceContainer.x+s.x+s.onTimeX;case be.Stem:const i=s.onNotes.beamingHelper?s.onNotes.beamingHelper.getBeatLineX(t):s.onNotes.x+s.onNotes.width/2;return s.voiceContainer.x+i;case be.PostNotes:return s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.width;case be.EndBeat:return s.voiceContainer.x+s.x+s.width}return 0}getRatioPositionX(t){const e=this.bar.isEmpty?this.beatGlyphsStart:this.getBeatX(this.bar.voices[0].beats[0],be.OnNotes);return e+(this.postBeatGlyphsStart-e)*t}getNoteX(t,e){const s=this.getBeatContainer(t.beat);return s?s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.getNoteX(t,e):0}getNoteY(t,e){const s=this.getOnNotesGlyphForBeat(t.beat);return s?s.getNoteY(t,e):Number.NaN}reLayout(){(this.wasFirstOfLine&&!this.isFirstOfLine||!this.wasFirstOfLine&&this.isFirstOfLine)&&this.recreatePreBeatGlyphs(),this.updateSizes(),this.registerLayoutingInfo()}recreatePreBeatGlyphs(){this._preBeatGlyphs=new _i,this._preBeatGlyphs.renderer=this,this.createPreBeatGlyphs()}paintSimileMark(t,e,s){const i=me.voice(s,qi.Glyphs,this.bar.voices[0],!0);try{switch(this.bar.simileMark){case je.Simple:s.beginGroup(bs.getGroupId(this.bar.voices[0].beats[0])),s.fillMusicFontSymbol(t+this.x+(this.width-20)/2,e+this.y+this.height/2,1,l.Repeat1Bar,!1),s.endGroup();break;case je.SecondOfDouble:s.beginGroup(bs.getGroupId(this.bar.voices[0].beats[0])),s.beginGroup(bs.getGroupId(this.bar.previousBar.voices[0].beats[0])),s.fillMusicFontSymbol(t+this.x-14,e+this.y+this.height/2,1,l.Repeat2Bars,!1),s.endGroup(),s.endGroup()}}finally{i?.[Symbol.dispose]?.()}}completeBeamingHelper(t){}getBeatDirection(t){return this.helpers.getBeamingHelperForBeat(t).direction}}qe.RawLineSpacing=8,qe.StemWidth=.12*qe.RawLineSpacing,qe.StaffLineThickness=.13*qe.RawLineSpacing,qe.BeamThickness=.5*qe.RawLineSpacing,qe.BeamSpacing=.25*qe.RawLineSpacing;var we=function(r){return r[r.SinglePreBeat=0]="SinglePreBeat",r[r.SingleOnBeat=1]="SingleOnBeat",r[r.SingleOnBeatToEnd=2]="SingleOnBeatToEnd",r[r.GroupedOnBeat=3]="GroupedOnBeat",r[r.GroupedOnBeatToEnd=4]="GroupedOnBeatToEnd",r[r.FullBar=5]="FullBar",r}(we||{});class Ql extends $e{constructor(t,e){super(0,0),this._uniqueEffectGlyphs=[],this._effectGlyphs=[],this.isEmpty=!0,this.previousBand=null,this.isLinkedToPrevious=!1,this.firstBeat=null,this.lastBeat=null,this.height=0,this.originalHeight=0,this.slot=null,this.voice=t,this.info=e}doLayout(){super.doLayout();for(let t=0;t<this.renderer.bar.voices.length;t++)this._effectGlyphs.push(new Map),this._uniqueEffectGlyphs.push([])}createGlyph(t){if(t.voice===this.voice&&this.info.shouldCreateGlyph(this.renderer.settings,t)&&(!this.info.hideOnMultiTrack||0===this.renderer.staff.trackIndex)){if(this.isEmpty=!1,(!this.firstBeat||t.isBefore(this.firstBeat))&&(this.firstBeat=t),!this.lastBeat||t.isAfter(this.lastBeat))switch(this.lastBeat=t,this.info.sizingMode){case we.SingleOnBeatToEnd:case we.GroupedOnBeatToEnd:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat)}const e=this.createOrResizeGlyph(this.info.sizingMode,t);e.height>this.height&&(this.height=e.height,this.originalHeight=e.height)}}resetHeight(){this.height=this.originalHeight}createOrResizeGlyph(t,e){let s;switch(t){case we.FullBar:case we.SinglePreBeat:case we.SingleOnBeat:case we.SingleOnBeatToEnd:return s=this.info.createNewGlyph(this.renderer,e),s.renderer=this.renderer,s.beat=e,s.doLayout(),this._effectGlyphs[e.voice.index].set(e.index,s),this._uniqueEffectGlyphs[e.voice.index].push(s),s;case we.GroupedOnBeat:case we.GroupedOnBeatToEnd:const i=t===we.GroupedOnBeat?we.SingleOnBeat:we.SingleOnBeatToEnd;if(e.index>0||this.renderer.index>0){const a=e.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,a)){let n=null;if(e.index>0&&this._effectGlyphs[e.voice.index].has(a.index))n=this._effectGlyphs[e.voice.index].get(a.index);else if(this.renderer.index>0){const c=this.renderer.previousRenderer.getBand(a.voice,this.info.effectId);if(c){const d=c._effectGlyphs[a.voice.index];d.has(a.index)&&(n=d.get(a.index))}}const o=this.createOrResizeGlyph(i,e);return n&&this.info.canExpand(a,e)&&(n.nextGlyph=o,o.previousGlyph=n,this.isLinkedToPrevious=!0),o}return this.createOrResizeGlyph(i,e)}return this.createOrResizeGlyph(i,e);default:return this.createOrResizeGlyph(we.SingleOnBeat,e)}}paint(t,e,s){super.paint(t,e,s);for(let i=0,a=this._uniqueEffectGlyphs.length;i<a;i++){const n=this._uniqueEffectGlyphs[i];for(let o=0,h=n.length;o<h;o++){const c=n[o],d=me.beat(s,Ae.Effects,c.beat,!1);try{c.paint(t+this.x,e+this.y,s)}finally{d?.[Symbol.dispose]?.()}}}}alignGlyphs(){for(let t=0;t<this._effectGlyphs.length;t++)for(const e of this._effectGlyphs[t].keys())this.alignGlyph(this.info.sizingMode,this.renderer.bar.voices[t].beats[e])}alignGlyph(t,e){const s=this._effectGlyphs[e.voice.index].get(e.index),i=this.renderer.getBeatContainer(e);switch(t){case we.SinglePreBeat:const a=this.renderer.layoutingInfo.getPreBeatSize(e);s.x=this.renderer.beatGlyphsStart+i.x-a;break;case we.SingleOnBeat:case we.GroupedOnBeat:s.x=this.renderer.beatGlyphsStart+i.x;break;case we.SingleOnBeatToEnd:case we.GroupedOnBeatToEnd:if(s.x=this.renderer.beatGlyphsStart+i.x,i.beat.isLastOfVoice)s.width=this.renderer.width-s.x;else{const n=this.renderer.layoutingInfo.getPostBeatSize(e);s.width=n}break;case we.FullBar:s.width=this.renderer.width}}}class Kl{constructor(){this.uniqueEffectId=null,this.y=0,this.height=0,this.firstBeat=null,this.lastBeat=null}}class Zl{constructor(){this.bands=[],this.shared=new Kl}update(t){t.info.canShareBand||(this.shared.uniqueEffectId=t.info.effectId),t.slot=this,this.bands.push(t),t.height>this.shared.height&&(this.shared.height=t.height),(!this.shared.firstBeat||t.firstBeat.isBefore(this.shared.firstBeat))&&(this.shared.firstBeat=t.firstBeat),(!this.shared.lastBeat||t.lastBeat.isAfter(this.shared.lastBeat))&&(this.shared.lastBeat=t.lastBeat)}canBeUsed(t){return(!this.shared.uniqueEffectId&&t.info.canShareBand||t.info.effectId===this.shared.uniqueEffectId)&&(!this.shared.firstBeat||this.shared.lastBeat.isBefore(t.firstBeat)||this.shared.lastBeat.isBefore(this.shared.firstBeat))}}class jl{constructor(){this.slots=[],this._effectSlot=new Map}getOrCreateSlot(t){if(this._effectSlot.has(t.info.effectId)){const s=this._effectSlot.get(t.info.effectId);if(s.canBeUsed(t))return s}for(const s of this.slots)if(s.canBeUsed(t))return s;const e=new Zl;return this.slots.push(e),e}register(t){const e=this.getOrCreateSlot(t);e.update(t),this._effectSlot.set(t.info.effectId,e)}}class ec extends qe{constructor(t,e,s){super(t,e),this._bands=[],this._bandLookup=new Map,this.sizingInfo=null,this._infos=s}updateSizes(){this.topOverflow=0,this.bottomOverflow=0,this.topPadding=0,this.bottomPadding=0,this.updateHeight(),super.updateSizes()}finalizeRenderer(){let t=super.finalizeRenderer();return this.updateHeight()&&(t=!0),t}updateHeight(){if(!this.sizingInfo)return!1;let t=0;for(const e of this.sizingInfo.slots){e.shared.y=t;for(const s of e.bands)s.y=t,s.height=e.shared.height;t+=e.shared.height}return t!==this.height&&(this.height=t,!0)}applyLayoutingInfo(){const t=!super.applyLayoutingInfo();this.sizingInfo=this.index>0?this.previousRenderer.sizingInfo:new jl;for(const e of this._bands)e.resetHeight(),e.alignGlyphs(),e.isEmpty||this.sizingInfo.register(e);return this.updateHeight(),t}scaleToWidth(t){super.scaleToWidth(t);for(const e of this._bands)e.alignGlyphs()}createBeatGlyphs(){this._bands=[],this._bandLookup=new Map;for(const t of this.bar.voices)if(this.hasVoiceContainer(t))for(const e of this._infos){const s=new Ql(t,e);s.renderer=this,s.doLayout(),this._bands.push(s),this._bandLookup.set(`${t.index}.${e.effectId}`,s)}super.createBeatGlyphs();for(const t of this._bands)t.isLinkedToPrevious&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(t){for(const e of t.beats){const s=new bs(e,this.getVoiceContainer(t));s.preNotes=new ri,s.onNotes=new ai,this.addBeatGlyph(s);for(const i of this._bands)i.createGlyph(e)}}paint(t,e,s){this.paintBackground(t,e,s);for(const i of this._bands)s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isEmpty||i.paint(t+this.x,e+this.y,s)}getBand(t,e){const s=`${t.index}.${e}`;return this._bandLookup.has(s)?this._bandLookup.get(s):null}}class Ti extends pr{get staffId(){return this._staffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.effectStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.effectStaffPaddingBottom}constructor(t,e,s=null){super(),this.infos=e,this._staffId=t,this.isInsideBracket=!1,this.isRelevantForBoundsLookup=!1,this.shouldShow=s}canCreate(t,e){const s=this.shouldShow;return super.canCreate(t,e)&&(!s||s(t,e))}create(t,e){return new ec(t,e,this.infos.filter(s=>t.settings.notation.isNotationElementVisible(s.notationElement)))}}let tc=(()=>{class r extends Kt{constructor(e,s,i,a,n){super(e,s),this._endingsString="",this._endings=O.getAlternateEndingsList(i),this._openLine=a,this._closeLine=n}doLayout(){super.doLayout(),this.height=this.renderer.resources.wordsFont.size+(r.Padding+2);let e="";for(let s=0,i=this._endings.length;s<i;s++)e+=this._endings[s]+1,e+=". ";this._endingsString=e}paint(e,s,i){const a=this._closeLine?this.width-4:this.width;if(e=.5+(0|e),s=.5+(0|s),this._openLine?(i.moveTo(e+this.x,s+this.y+this.height),i.lineTo(e+this.x,s+this.y)):i.moveTo(e+this.x,s+this.y),i.lineTo(e+this.x+a,s+this.y),this._closeLine&&i.lineTo(e+this.x+a,s+this.y+this.height),i.stroke(),this._openLine){const n=i.textBaseline;i.textBaseline=re.Top,i.font=this.renderer.resources.wordsFont,i.fillText(this._endingsString,e+this.x+r.Padding,s+this.y),i.textBaseline=n}}}return r.Padding=3,r})();class Ze{get effectId(){return this.notationElement.toString()}}class sc extends Ze{get notationElement(){return fe.EffectAlternateEndings}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return we.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&0!==e.voice.bar.masterBar.alternateEndings}createNewGlyph(t,e){const s=e.voice.bar.masterBar,i=null===s.previousMasterBar||s.alternateEndings!==s.previousMasterBar.alternateEndings;let a=s.isRepeatEnd||null===s.nextMasterBar||s.alternateEndings!==s.nextMasterBar.alternateEndings;return s.repeatGroup.closings.some(n=>n.index>=s.index)||(a=!1),new tc(0,0,s.alternateEndings,i,a)}canExpand(t,e){return!0}}class ic extends Ze{get notationElement(){return fe.EffectCapo}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return 0===e.index&&0===e.voice.bar.index&&0!==e.voice.bar.staff.capo}createNewGlyph(t,e){return new Zt(0,0,`Capo. fret ${e.voice.bar.staff.capo}`,t.resources.effectFont,U.Left)}canExpand(t,e){return!1}}class rc extends Ze{get notationElement(){return fe.EffectChordNames}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return e.hasChord}createNewGlyph(t,e){return new Zt(0,0,e.chord.name,t.resources.effectFont,U.Center)}canExpand(t,e){return!1}}class Vi extends Kt{constructor(t){super(),this.forceGroupedRendering=!1,this.endOnBarLine=!1,this.endPosition=t}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff.system===this.renderer.staff.system}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff.system===this.renderer.staff.system}paint(t,e,s){if(this.isLinkedWithPrevious)return;if(!this.isLinkedWithNext&&!this.forceGroupedRendering)return void this.paintNonGrouped(t,e,s);let i;if(!this.isLinkedWithNext&&this.forceGroupedRendering)i=this;else for(i=this.nextGlyph;i.isLinkedWithNext;)i=i.nextGlyph;const c=this.calculateEndX(i.renderer,i.beat,t-this.renderer.x,this.endPosition);this.paintGrouped(t,e,c,s)}calculateEndX(t,e,s,i){return e?s+t.x+t.getBeatX(e,i):s+t.x+this.x+this.width}paintNonGrouped(t,e,s){const a=this.calculateEndX(this.renderer,this.beat,t-this.renderer.x,this.endPosition);this.paintGrouped(t,e,a,s)}}class ac extends Vi{constructor(t,e,s){super(be.EndBeat),this._crescendo=Ft.None,this._crescendo=s,this.x=t,this.y=e}doLayout(){super.doLayout(),this.height=17}paintGrouped(t,e,s,i){const a=t+this.x,n=this.height,o=Ce.Widths.get(l.NoteheadBlack)/2;i.beginPath(),this._crescendo===Ft.Crescendo?(i.moveTo(s-=o,e+this.y),i.lineTo(a,e+this.y+n/2),i.lineTo(s,e+this.y+n)):(s-=o,i.moveTo(a,e+this.y),i.lineTo(s,e+this.y+n/2),i.lineTo(a,e+this.y+n)),i.stroke()}}class nc extends Ze{get notationElement(){return fe.EffectCrescendo}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.crescendo!==Ft.None}createNewGlyph(t,e){return new ac(0,0,e.crescendo)}canExpand(t,e){return t.crescendo===e.crescendo}}class fn extends lt{constructor(t,e,s){super(t,e,.6,fn.getSymbol(s)),this.center=!0}doLayout(){super.doLayout(),this.y+=this.height/2}static getSymbol(t){switch(t){case J.PPP:return l.DynamicPPP;case J.PP:return l.DynamicPP;case J.P:return l.DynamicPiano;case J.MP:return l.DynamicMP;case J.MF:return l.DynamicMF;case J.F:return l.DynamicForte;case J.FF:return l.DynamicFF;case J.FFF:return l.DynamicFFF;case J.PPPP:return l.DynamicPPPP;case J.PPPPP:case J.PPPPPP:return l.DynamicPPPPP;case J.FFFF:return l.DynamicFFFF;case J.FFFFF:return l.DynamicFFFFF;case J.FFFFFF:return l.DynamicFFFFFF;case J.SF:return l.DynamicSforzando1;case J.SFP:return l.DynamicSforzandoPiano;case J.SFPP:return l.DynamicSforzandoPianissimo;case J.FP:return l.DynamicFortePiano;case J.RF:return l.DynamicRinforzando1;case J.RFZ:return l.DynamicRinforzando2;case J.SFZ:return l.DynamicSforzato;case J.SFFZ:return l.DynamicSforzatoFF;case J.FZ:return l.DynamicForzando;case J.N:return l.DynamicNiente;case J.PF:return l.DynamicPF;case J.SFZP:return l.DynamicSforzatoPiano;default:return l.None}}}class oc extends Ze{get notationElement(){return fe.EffectDynamics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return this.internalShouldCreateGlyph(e)}internalShouldCreateGlyph(t){if(t.voice.bar.staff.track.score.stylesheet.hideDynamics||t.isEmpty||t.voice.isEmpty||t.isRest)return!1;const e=this.getPreviousDynamicsBeat(t);let s=0===t.voice.index&&!e||t.dynamics!==e?.dynamics;if(s&&t.voice.index>0)for(const i of t.voice.bar.voices)if(i.index<t.voice.index){const a=i.getBeatAtPlaybackStart(t.playbackStart);a&&t.dynamics===a.dynamics&&this.internalShouldCreateGlyph(a)&&(s=!1)}return s}getPreviousDynamicsBeat(t){let e=t.previousBeat;for(;null!=e;){if(!e.isRest)return e;e=e.previousBeat}return null}createNewGlyph(t,e){return new fn(0,0,e.dynamics)}canExpand(t,e){return!0}}class pn extends lt{constructor(t){super(0,0,1,pn.getSymbol(t)),this.center=!0}static getSymbol(t){switch(t){case ct.FadeIn:return l.GuitarFadeIn;case ct.FadeOut:return l.GuitarFadeOut;case ct.VolumeSwell:return l.GuitarVolumeSwell}return l.None}paint(t,e,s){super.paint(t,e+this.height,s)}}class hc extends Ze{get notationElement(){return fe.EffectFadeIn}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return e.fade!==ct.None}createNewGlyph(t,e){return new pn(e.fade)}canExpand(t,e){return!0}}class gn extends lt{constructor(t,e,s){super(t,e,1,gn.getSymbol(s))}static getSymbol(t){switch(t){case Ct.Short:return l.FermataShortAbove;case Ct.Medium:return l.FermataAbove;case Ct.Long:return l.FermataLongAbove;default:return l.None}}paint(t,e,s){super.paint(t-this.width/2,e+this.height,s)}}class lc extends Ze{get notationElement(){return fe.EffectFermata}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return 0===e.voice.index&&!!e.fermata}createNewGlyph(t,e){return new gn(0,0,e.fermata.type)}canExpand(t,e){return!0}}class cc extends Ze{get notationElement(){return fe.EffectFingering}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return!(0!==e.voice.index||e.isRest||t.notation.fingeringMode!==xs.SingleNoteEffectBand&&t.notation.fingeringMode!==xs.SingleNoteEffectBandForcePiano||1!==e.notes.length)&&e.notes[0].isFingering}createNewGlyph(t,e){let s=Q.Unknown,i=!1;const a=e.notes[0];a.leftHandFinger!==Q.Unknown?(s=a.leftHandFinger,i=!0):a.rightHandFinger!==Q.Unknown&&(s=a.rightHandFinger);const n=O.fingerToString(t.settings,e,s,i)??"";return new Zt(0,0,n,t.resources.fingeringFont,U.Left)}canExpand(t,e){return!0}}class xi extends Ze{constructor(){super(...arguments),this.lastCreateInfo=null}shouldCreateGlyph(t,e){this.lastCreateInfo=[];for(let s=0,i=e.notes.length;s<i;s++){const a=e.notes[s];this.shouldCreateGlyphForNote(a)&&this.lastCreateInfo.push(a)}return this.lastCreateInfo.length>0}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(t,e){return!0}}let Ni=(()=>{class r extends Vi{constructor(e,s=!0){super(be.OnNotes),this._label=e,this._dashed=s}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=be.EndBeat,this.forceGroupedRendering=!0),super.doLayout(),this.height=this.renderer.resources.effectFont.size}paintNonGrouped(e,s,i){i.font=this.renderer.resources.effectFont;const n=i.textAlign;i.textAlign=U.Center,i.fillText(this._label,e+this.x,s+this.y),i.textAlign=n}paintGrouped(e,s,i,a){this.paintNonGrouped(e,s,a);const o=a.measureText(this._label).width,h=e+this.x+o/2+3,c=s+this.y+4;if(this._dashed){if(i>h){let u=h;for(;u<i;)a.beginPath(),a.moveTo(u,0|c),a.lineTo(Math.min(u+8,i),0|c),u+=11,a.stroke();a.beginPath(),a.moveTo(i,c-5|0),a.lineTo(i,c+5|0),a.stroke()}}else a.beginPath(),a.moveTo(h,0|c),a.lineTo(i,0|c),a.lineTo(i,c+5|0),a.stroke()}}return r.LineSpacing=3,r.LineTopPadding=4,r.LineTopOffset=5,r.LineSize=8,r})();class ni extends xi{get effectId(){return this._effectId}get notationElement(){return fe.EffectHarmonics}constructor(t){switch(super(),this._beat=null,this._harmonicType=t,t){case Z.None:this._effectId="harmonics-none";break;case Z.Natural:this._effectId="harmonics-natural";break;case Z.Artificial:this._effectId="harmonics-artificial";break;case Z.Pinch:this._effectId="harmonics-pinch";break;case Z.Tap:this._effectId="harmonics-tap";break;case Z.Semi:this._effectId="harmonics-semi";break;case Z.Feedback:this._effectId="harmonics-feedback";break;default:this._effectId=""}}shouldCreateGlyphForNote(t){return!(!t.isHarmonic||t.harmonicType!==this._harmonicType||(t.beat!==this._beat&&(this._beat=t.beat),0))}get sizingMode(){return we.GroupedOnBeat}createNewGlyph(t,e){return new Ni(ni.harmonicToString(this._harmonicType))}static harmonicToString(t){switch(t){case Z.Natural:return"N.H.";case Z.Artificial:return"A.H.";case Z.Pinch:return"P.H.";case Z.Tap:return"T.H.";case Z.Semi:return"S.H.";case Z.Feedback:return"Fdbk."}return""}}class dc extends Ze{get notationElement(){return fe.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.isLetRing}get sizingMode(){return we.GroupedOnBeat}createNewGlyph(t,e){return new Ni("LetRing")}canExpand(t,e){return!0}}class uc extends Kt{constructor(t,e,s,i,a=U.Center){super(t,e),this._lines=s,this.font=i,this.textAlign=a}doLayout(){super.doLayout(),this.height=this.font.size*this._lines.length}paint(t,e,s){s.font=this.font;const i=s.textAlign;s.textAlign=this.textAlign;for(let a=0;a<this._lines.length;a++)this._lines[a]&&s.fillText(this._lines[a],t+this.x,e+this.y+a*this.font.size);s.textAlign=i}}class fc extends Ze{get notationElement(){return fe.EffectLyrics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return!!e.lyrics}createNewGlyph(t,e){return new uc(0,0,e.lyrics,t.resources.effectFont,U.Center)}canExpand(t,e){return!0}}class pc extends Ze{get notationElement(){return fe.EffectMarker}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return we.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&e.voice.bar.masterBar.isSectionStart}createNewGlyph(t,e){return new Zt(0,0,e.voice.bar.masterBar.section.marker?`[${e.voice.bar.masterBar.section.marker}] ${e.voice.bar.masterBar.section.text}`:e.voice.bar.masterBar.section.text,t.resources.markerFont,U.Left)}canExpand(t,e){return!0}}class gc extends Vi{constructor(t,e){super(be.PostNotes),this._ottava=t,this._aboveStaff=e}doLayout(){super.doLayout(),this.height=Ce.Heights.get(l.QuindicesimaAlta)}paintNonGrouped(t,e,s){this.paintOttava(t,e,s)}paintOttava(t,e,s){let i=0;switch(this._ottava){case le._15ma:i=.8*Ce.Widths.get(l.QuindicesimaAlta),s.fillMusicFontSymbol(t+this.x-i/2,e+this.y+this.height,.8,l.QuindicesimaAlta,!1);break;case le._8va:i=.8*Ce.Widths.get(l.OttavaAlta),s.fillMusicFontSymbol(t+this.x-i/2,e+this.y+this.height,.8,l.OttavaAlta,!1);break;case le._8vb:i=.8*Ce.Widths.get(l.OttavaBassaVb),s.fillMusicFontSymbol(t+this.x-i/2,e+this.y+this.height,.8,l.OttavaBassaVb,!1);break;case le._15mb:i=.8*(Ce.Widths.get(l.Quindicesima)+Ce.Widths.get(l.OctaveBaselineM)+Ce.Widths.get(l.OctaveBaselineB)),s.fillMusicFontSymbols(t+this.x-i/2,e+this.y+this.height,.8,[l.Quindicesima,l.OctaveBaselineM,l.OctaveBaselineB],!1)}return i/2}paintGrouped(t,e,s,i){const a=this.paintOttava(t,e,i),o=t+this.x+a+3;let h=e+this.y;if(h+=this._aboveStaff?2:this.height-2,s>o){let d=o;for(;d<s;)i.beginPath(),i.moveTo(d,0|h),i.lineTo(Math.min(d+8,s),0|h),d+=11,i.stroke();i.beginPath(),this._aboveStaff?(i.moveTo(s,h),i.lineTo(s,e+this.y+this.height)):(i.moveTo(s,h),i.lineTo(s,e+this.y)),i.stroke()}}}class Lo extends Ze{get effectId(){return"ottavia-"+(this._aboveStaff?"above":"below")}get notationElement(){return fe.EffectOttavia}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.GroupedOnBeat}constructor(t){super(),this._aboveStaff=t}shouldCreateGlyph(t,e){switch(e.ottava){case le._15ma:case le._8va:return this._aboveStaff;case le._8vb:case le._15mb:return!this._aboveStaff}return!1}createNewGlyph(t,e){return new gc(e.ottava,this._aboveStaff)}canExpand(t,e){return t.ottava===e.ottava}}class mc extends xi{get notationElement(){return fe.EffectPalmMute}shouldCreateGlyphForNote(t){return t.isPalmMute}get sizingMode(){return we.GroupedOnBeat}createNewGlyph(t,e){return new Ni("P.M.")}}class yc extends xi{get notationElement(){return fe.EffectPickSlide}shouldCreateGlyphForNote(t){return t.slideOutType===ce.PickSlideDown||t.slideOutType===ce.PickSlideUp}get sizingMode(){return we.GroupedOnBeat}createNewGlyph(t,e){return new Ni("P.S.")}}class gr extends lt{constructor(t,e,s){super(t,e,Me.GraceScale,gr.getSymbol(s))}paint(t,e,s){super.paint(t,e+this.height,s)}static getSymbol(t){switch(t){case yt.Up:return l.StringsUpBow;case yt.Down:return l.StringsDownBow;default:return l.None}}}class bc extends Ze{get notationElement(){return fe.EffectPickStroke}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return e.pickStroke!==yt.None}createNewGlyph(t,e){return new gr(0,0,e.pickStroke)}canExpand(t,e){return!0}}class Fo extends Vi{constructor(t){super(be.EndBeat),this._stepSize=0,this._type=t}doLayout(){switch(super.doLayout(),this._type){case ke.Slight:this._stepSize=12;break;case ke.Wide:this._stepSize=23}this.height=18}paintGrouped(t,e,s,i){let a=t+this.x;const o=Math.max(1,(s-a)/this._stepSize);i.beginPath(),i.moveTo(a,e+this.y);for(let h=0;h<o;h++)i.lineTo(a+this._stepSize/2,e+this.y+this.height),i.lineTo(a+this._stepSize,e+this.y),a+=this._stepSize;i.stroke()}}class Eo extends Ze{get notationElement(){return fe.EffectSlightBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.vibrato===ke.Slight}createNewGlyph(t,e){return new Fo(ke.Slight)}canExpand(t,e){return!0}}class oi extends Vi{constructor(t,e,s,i=1.2,a=!1){super(be.EndBeat),this._scale=0,this._symbol=l.None,this._symbolSize=0,this._type=s,this._scale=i,this.x=t,this.y=e,this._partialWaves=a}doLayout(){switch(super.doLayout(),this._type){case ke.Slight:this._symbol=l.WiggleTrill;break;case ke.Wide:this._symbol=l.WiggleVibratoMediumFast}this._symbolSize=Ce.Widths.get(this._symbol)*this._scale,this.height=Ce.Heights.get(this._symbol)*this._scale}paintGrouped(t,e,s,i){const o=this._symbolSize;let h=(s-(t+this.x))/o;this._partialWaves||(h=Math.floor(h)),h<1&&(h=1);let c=0;for(let d=0;d<h;d++)i.fillMusicFontSymbol(t+this.x+c,e+this.y+2*this.height,this._scale,this._symbol,!1),c+=o}}class vo extends xi{get notationElement(){return fe.EffectSlightNoteVibrato}shouldCreateGlyphForNote(t){let e=t.vibrato===ke.Slight||t.isTieDestination&&t.tieOrigin.vibrato===ke.Slight;return this._hideOnTiedBend&&e&&t.isTieDestination&&t.tieOrigin.hasBend&&(e=!1),e}get sizingMode(){return we.GroupedOnBeatToEnd}createNewGlyph(t,e){return new oi(0,0,ke.Slight,1.2)}constructor(t){super(),this._hideOnTiedBend=t}}class Sc extends Ze{get notationElement(){return fe.EffectTap}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return e.slap||e.pop||e.tap}createNewGlyph(t,e){return new Zt(0,0,e.slap?"S":e.pop?"P":"T",t.resources.effectFont,U.Left)}canExpand(t,e){return!0}}class wc extends Kt{constructor(t){super(0,0),this.tempoAutomations=t}doLayout(){super.doLayout(),this.height=25}paint(t,e,s){for(const i of this.tempoAutomations){let a=t+this.renderer.getRatioPositionX(i.ratioPosition);if(s.font=this.renderer.resources.markerFont,s.textBaseline=re.Top,i.text){const o=s.measureText(i.text);s.fillText(i.text,a,e+this.y+s.font.size/2),a+=o.width+.7*s.font.size}s.fillMusicFontSymbol(a,e+this.y+.8*this.height,.5,l.NoteQuarterUp,!0),s.fillText(`= ${i.value.toString()}`,a+.5*Ce.Widths.get(l.NoteQuarterUp)+3,e+this.y+s.font.size/2)}}}class kc extends Ze{get notationElement(){return fe.EffectTempo}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return we.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&e.voice.bar.masterBar.tempoAutomations.length>0}createNewGlyph(t,e){return new wc(e.voice.bar.masterBar.tempoAutomations)}canExpand(t,e){return!0}}class Bc extends Ze{get notationElement(){return fe.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return!!e.text}createNewGlyph(t,e){return new Zt(0,0,e.text,t.resources.effectFont,U.Left)}canExpand(t,e){return!0}}class _c extends Vi{constructor(t,e){super(be.EndBeat),this.x=t,this.y=e}doLayout(){super.doLayout(),this.height=Ce.Heights.get(l.OrnamentTrill)/2}paintGrouped(t,e,s,i){let a=t+this.x;i.fillMusicFontSymbol(a,e+this.y+this.height,1,l.OrnamentTrill,!0),a+=Ce.Widths.get(l.OrnamentTrill)/2;const o=1.2*Ce.Widths.get(l.WiggleTrill),h=Math.floor((s-a)/o),c=e+this.y+1.37*this.height;let d=a;for(let u=0;u<h;u++)i.fillMusicFontSymbol(d,c,1.2,l.WiggleTrill,!1),d+=o}}class Io extends xi{get notationElement(){return fe.EffectTrill}shouldCreateGlyphForNote(t){return t.isTrill}get sizingMode(){return we.GroupedOnBeatToEnd}createNewGlyph(t,e){return new _c(0,0)}}let xc=(()=>{class r extends Kt{constructor(e){super(0,0),this._tripletFeel=e}doLayout(){super.doLayout(),this.height=25}paint(e,s,i){e+=this.x;const a=(s+=this.y)+this.height*Me.GraceScale,n=a+8;i.font=this.renderer.resources.effectFont,i.fillText("(",e,s+.3*this.height);const o=e+10,h=e+40;let c=[],d=[],u=[],f=[];switch(this._tripletFeel){case ue.NoTripletFeel:c=[l.TextBlackNoteLongStem,l.TextCont8thBeamLongStem,l.TextBlackNoteFrac8thLongStem],u=[l.TextBlackNoteLongStem,l.TextCont8thBeamLongStem,l.TextBlackNoteFrac8thLongStem];break;case ue.Triplet8th:c=[l.TextBlackNoteLongStem,l.TextCont8thBeamLongStem,l.TextBlackNoteFrac8thLongStem],u=[l.TextBlackNoteLongStem,l.Space,l.NoteEighthUp],f=[l.TextTupletBracketStartLongStem,l.TextTuplet3LongStem,l.TextTupletBracketEndLongStem];break;case ue.Triplet16th:c=[l.TextBlackNoteLongStem,l.TextCont8thBeamLongStem,l.TextBlackNoteFrac8thLongStem],u=[l.TextBlackNoteLongStem,l.TextCont8thBeamLongStem,l.TextBlackNoteFrac16thLongStem],f=[l.TextTupletBracketStartLongStem,l.TextTuplet3LongStem,l.TextTupletBracketEndLongStem];break;case ue.Dotted8th:c=[l.TextBlackNoteLongStem,l.TextCont8thBeamLongStem,l.TextBlackNoteFrac8thLongStem],d=[l.TextAugmentationDot],u=[l.TextBlackNoteLongStem,l.TextCont8thBeamLongStem,l.TextBlackNoteFrac16thLongStem];break;case ue.Dotted16th:c=[l.TextBlackNoteLongStem,l.TextCont16thBeamLongStem,l.TextBlackNoteFrac16thLongStem],d=[l.TextAugmentationDot],u=[l.TextBlackNoteLongStem,l.TextCont16thBeamLongStem,l.TextBlackNoteFrac32ndLongStem],i.fillCircle(h+9,a,1);break;case ue.Scottish8th:c=[l.TextBlackNoteLongStem,l.TextCont8thBeamLongStem,l.TextBlackNoteFrac8thLongStem],u=[l.TextBlackNoteLongStem,l.TextCont16thBeamLongStem,l.TextBlackNoteFrac8thLongStem,l.TextAugmentationDot];break;case ue.Scottish16th:c=[l.TextBlackNoteLongStem,l.TextCont16thBeamLongStem,l.TextBlackNoteFrac16thLongStem],u=[l.TextBlackNoteLongStem,l.TextCont32ndBeamLongStem,l.TextBlackNoteFrac16thLongStem,l.TextAugmentationDot]}i.fillMusicFontSymbols(o,a,r.NoteScale,c,!1),i.fillText("=",e+32,s+5),i.fillMusicFontSymbols(h,a,r.NoteScale,u,!1),d.length>0&&i.fillMusicFontSymbols(h+7,a,r.NoteScale,d,!1),f.length>0&&i.fillMusicFontSymbols(h,n,r.TupletScale,f,!1),i.fillText(")",e+65,s+.3*this.height)}}return r.NoteScale=.5,r.TupletScale=.7,r})();class Nc extends Ze{get notationElement(){return fe.EffectTripletFeel}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return we.SinglePreBeat}shouldCreateGlyph(t,e){return 0===e.index&&(0===e.voice.bar.masterBar.index&&e.voice.bar.masterBar.tripletFeel!==ue.NoTripletFeel||e.voice.bar.masterBar.index>0&&e.voice.bar.masterBar.tripletFeel!==e.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(t,e){return new xc(e.voice.bar.masterBar.tripletFeel)}canExpand(t,e){return!0}}class Pc extends Ze{get notationElement(){return fe.EffectWhammyBar}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return we.GroupedOnBeat}shouldCreateGlyph(t,e){return e.hasWhammyBar}createNewGlyph(t,e){return new Ni("w/bar")}canExpand(t,e){return!0}}class Ao extends Ze{get notationElement(){return fe.EffectWideBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.GroupedOnBeatToEnd}shouldCreateGlyph(t,e){return e.vibrato===ke.Wide}createNewGlyph(t,e){return new Fo(ke.Wide)}canExpand(t,e){return!0}}class Mo extends xi{get notationElement(){return fe.EffectWideNoteVibrato}shouldCreateGlyphForNote(t){return t.vibrato===ke.Wide||t.isTieDestination&&t.tieOrigin.vibrato===ke.Wide}get sizingMode(){return we.GroupedOnBeatToEnd}createNewGlyph(t,e){return new oi(0,0,ke.Wide,1.2)}}class Ro{constructor(){this.x=0,this.width=0,this.masterBars=[]}}class Cc extends Xs{constructor(){super(...arguments),this._system=null}get name(){return"HorizontalScreen"}get supportsResize(){return!1}get firstBarX(){let t=this.pagePadding[0];return this._system&&(t+=this._system.accoladeWidth),t}doResize(){}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case wi.Automatic:this.systemsLayoutMode=os.Automatic;break;case wi.UseModelLayout:this.systemsLayoutMode=os.FromModelWithWidths}const t=this.renderer.score;let e=this.renderer.settings.display.startBar;e--,e=Math.min(t.masterBars.length-1,Math.max(0,e));let s=e,i=this.renderer.settings.display.barCount;i<=0&&(i=t.masterBars.length),i=e+i-1,i=Math.min(t.masterBars.length-1,Math.max(0,i)),this._system=this.createEmptyStaffSystem(),this._system.isLast=!0,this._system.x=this.pagePadding[0],this._system.y=this.pagePadding[1];const a=this.renderer.settings.display.barCountPerPartial,n=[];let o=new Ro,h=0;for(;s<=i;){const u=this.multiBarRestInfo,f=null!==u&&u.has(s)?u.get(s):null,p=this._system.addBars(this.renderer.tracks,s,f);if(0===o.masterBars.length&&p.isLinkedToPrevious&&n.length>0){const g=n[n.length-1];g.masterBars.push(t.masterBars[s]),g.width+=p.width,h+=p.width,o.x+=h}else o.masterBars.push(t.masterBars[s]),o.width+=p.width,o.masterBars.length>=a&&(0===n.length&&(o.width+=this._system.accoladeWidth+this.pagePadding[0]),h+=o.width,n.push(o),x.debug(this.name,`Finished partial from bar ${o.masterBars[0].index} to ${o.masterBars[o.masterBars.length-1].index}`,null),o=new Ro,o.x=h);s++}o.masterBars.length>0&&(0===n.length&&(o.width+=this._system.accoladeWidth+this.pagePadding[0]),n.push(o),x.debug(this.name,`Finished partial from bar ${o.masterBars[0].index} to ${o.masterBars[o.masterBars.length-1].index}`,null)),this.finalizeStaffSystem();const c=this.renderer.settings.display.scale;this.height=Math.floor(this._system.y+this._system.height)*c,this.width=(this._system.x+this._system.width+this.pagePadding[2])*c,s=0;let d=0;for(let u=0;u<n.length;u++){const f=n[u],p=new zs;p.x=d,p.y=0,p.totalWidth=this.width/c,p.totalHeight=this.height/c,p.width=f.width,p.height=this.height/c,p.firstMasterBarIndex=f.masterBars[0].index,p.lastMasterBarIndex=f.masterBars[f.masterBars.length-1].index,d+=f.width;const g=s,b=u;this._system.buildBoundingsLookup(0,0),this.registerPartial(p,w=>{let S=this._system.getBarX(f.masterBars[0].index)+this._system.accoladeWidth;0===b&&(S-=this._system.x+this._system.accoladeWidth),w.color=this.renderer.settings.display.resources.mainGlyphColor,w.textAlign=U.Left,x.debug(this.name,`Rendering partial from bar ${f.masterBars[0].index} to ${f.masterBars[f.masterBars.length-1].index}`,null),this._system.paintPartial(-S,this._system.y,w,g,f.masterBars.length)}),s+=f.masterBars.length}this.height=this.layoutAndRenderBottomScoreInfo(this.height),this.height=this.layoutAndRenderAnnotation(this.height),this.height+=this.pagePadding[3]}finalizeStaffSystem(){this._system.scaleToWidth(this._system.width),this._system.finalizeSystem()}}class Dc extends Xs{constructor(){super(...arguments),this._systems=[],this._allMasterBarRenderers=[],this._barsFromPreviousSystem=[]}get name(){return"PageView"}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case wi.Automatic:this.systemsLayoutMode=os.Automatic;break;case wi.UseModelLayout:this.systemsLayoutMode=os.FromModelWithScale}let t=this.pagePadding[1];this.width=this.renderer.width,this._allMasterBarRenderers=[],t=this.layoutAndRenderScoreInfo(t,-1),t=this.layoutAndRenderTunings(t,-1),t=this.layoutAndRenderChordDiagrams(t,-1),t=this.layoutAndRenderScore(t),t=this.layoutAndRenderBottomScoreInfo(t),t=this.layoutAndRenderAnnotation(t),this.height=(t+this.pagePadding[3])*this.renderer.settings.display.scale}get supportsResize(){return!0}get firstBarX(){let t=this.pagePadding[0];return this._systems.length>0&&(t+=this._systems[0].accoladeWidth),t}doResize(){let t=this.pagePadding[1];this.width=this.renderer.width;const e=this.height;t=this.layoutAndRenderScoreInfo(t,e),t=this.layoutAndRenderTunings(t,e),t=this.layoutAndRenderChordDiagrams(t,e),t=this.resizeAndRenderScore(t,e),t=this.layoutAndRenderBottomScoreInfo(t),t=this.layoutAndRenderAnnotation(t),this.height=(t+this.pagePadding[3])*this.renderer.settings.display.scale}layoutAndRenderTunings(t,e=-1){if(!this.tuningGlyph)return t;const s=this.renderer.settings.display.resources;this.tuningGlyph.x=this.pagePadding[0],this.tuningGlyph.width=this.scaledWidth,this.tuningGlyph.doLayout();const i=Math.round(this.tuningGlyph.height),a=new zs;return a.x=0,a.y=t,a.width=this.scaledWidth,a.height=i,a.totalWidth=this.scaledWidth,a.totalHeight=e<0?t+a.height:e,this.registerPartial(a,n=>{n.color=s.scoreInfoColor,n.textAlign=U.Center,this.tuningGlyph.paint(0,0,n)}),t+i}layoutAndRenderChordDiagrams(t,e=-1){if(!this.chordDiagrams)return t;const s=this.renderer.settings.display.resources;this.chordDiagrams.width=this.scaledWidth,this.chordDiagrams.doLayout();const i=Math.round(this.chordDiagrams.height),a=new zs;return a.x=0,a.y=t,a.width=this.scaledWidth,a.height=i,a.totalWidth=this.scaledWidth,a.totalHeight=e<0?t+i:e,this.registerPartial(a,n=>{n.color=s.scoreInfoColor,n.textAlign=U.Center,this.chordDiagrams.paint(0,0,n)}),t+i}layoutAndRenderScoreInfo(t,e=-1){x.debug(this.name,"Layouting score info");const s=new zs;s.x=0,s.y=t;let i=0;const a=this.renderer.settings.display.resources,n=[];for(const[o,h]of Xs.HeaderElements.value)if(this.headerGlyphs.has(o)){const c=this.headerGlyphs.get(o);c.y=i,this.alignScoreInfoGlyph(c);let d=c.font.size;o===H.Words&&this.headerGlyphs.has(H.Music)&&this.headerGlyphs.get(H.Music).textAlign!==c.textAlign&&(d=0),i+=d,n.push(c)}return n.length>0&&(i=Math.floor(i+17),s.width=this.scaledWidth,s.height=i,s.totalWidth=this.scaledWidth,s.totalHeight=e<0?t+s.height:e,this.registerPartial(s,o=>{o.color=a.scoreInfoColor,o.textAlign=U.Center;for(const h of n)h.paint(0,0,o)})),t+i}resizeAndRenderScore(t,e){if(this.renderer.settings.display.barsPerRow>0||this.systemsLayoutMode===os.FromModelWithScale)for(let i=0;i<this._systems.length;i++){const a=this._systems[i];this.fitSystem(a),t+=this.paintSystem(a,e)}else{this._systems=[];let i=0;const a=this.maxWidth;let n=this.createEmptyStaffSystem();for(n.index=this._systems.length,n.x=this.pagePadding[0],n.y=t;i<this._allMasterBarRenderers.length;){let o=this._allMasterBarRenderers[i];if(n.width+o.width<=a||0===n.masterBarsRenderers.length)n.addMasterBarRenderers(this.renderer.tracks,o),i++;else{for(;o&&!o.canWrap&&n.masterBarsRenderers.length>1;)o=n.revertLastBar(),i--;n.isFull=!0,n.isLast=this.lastBarIndex===n.lastBarIndex,this._systems.push(n),this.fitSystem(n),t+=this.paintSystem(n,e),n=this.createEmptyStaffSystem(),n.index=this._systems.length,n.x=this.pagePadding[0],n.y=t}}n.isLast=this.lastBarIndex===n.lastBarIndex,this.fitSystem(n),t+=this.paintSystem(n,e)}return t}layoutAndRenderScore(t){let s=this.firstBarIndex;const i=this.lastBarIndex;for(this._systems=[];s<=i;){const a=this.createStaffSystem(s,i);this._systems.push(a),a.x=this.pagePadding[0],a.y=t,s=a.lastBarIndex+1,this.fitSystem(a),x.debug(this.name,`Rendering partial from bar ${a.firstBarIndex} to ${a.lastBarIndex}`,null),t+=this.paintSystem(a,t)}return t}paintSystem(t,e){const s=Math.floor(t.height),i=new zs;return i.x=0,i.y=t.y,i.totalWidth=this.scaledWidth,i.totalHeight=e,i.width=this.scaledWidth,i.height=s,i.firstMasterBarIndex=t.firstBarIndex,i.lastMasterBarIndex=t.lastBarIndex,t.buildBoundingsLookup(0,0),this.registerPartial(i,a=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=U.Left,t.paint(0,-i.y/this.renderer.settings.display.scale,a)}),s}fitSystem(t){t.scaleToWidth(t.isFull||t.width>this.maxWidth||this.renderer.settings.display.justifyLastSystem?this.maxWidth:t.width),t.finalizeSystem()}getBarsPerSystem(t){let e=this.renderer.settings.display.barsPerRow;if(this.systemsLayoutMode===os.FromModelWithScale){let s,i;this.renderer.tracks.length>1?(s=this.renderer.score.defaultSystemsLayout,i=this.renderer.score.systemsLayout):(s=this.renderer.tracks[0].defaultSystemsLayout,i=this.renderer.tracks[0].systemsLayout),e=t<i.length?i[t]:s}return e}createStaffSystem(t,e){const s=this.createEmptyStaffSystem();s.index=this._systems.length;const i=this.getBarsPerSystem(s.index),a=this.maxWidth,n=e+1;let o=t;for(;o<n;){if(this._barsFromPreviousSystem.length>0)for(const u of this._barsFromPreviousSystem)s.addMasterBarRenderers(this.renderer.tracks,u),o=u.lastMasterBarIndex;else{const u=this.multiBarRestInfo,f=null!==u&&u.has(o)?u.get(o):null,p=s.addBars(this.renderer.tracks,o,f);this._allMasterBarRenderers.push(p),o=p.lastMasterBarIndex}this._barsFromPreviousSystem=[];let h=!1;if((-1===i&&s.width>=a&&0!==s.masterBarsRenderers.length||s.masterBarsRenderers.length===i+1)&&(h=!0),h){let u=s.revertLastBar();if(u)for(this._barsFromPreviousSystem.push(u);u&&!u.canWrap&&s.masterBarsRenderers.length>1;)u=s.revertLastBar(),u&&this._barsFromPreviousSystem.push(u);return s.isFull=!0,s.isLast=!1,this._barsFromPreviousSystem.reverse(),s}let c=!1,d=!0;for(const u of this.renderer.tracks)u.lineBreaks&&u.lineBreaks.has(o+1)?c=!0:d=!1;if(c&&d)return s.isFull=!0,s.isLast=!1,s;s.x=0,o++}return s.isLast=e===s.lastBarIndex,s}get maxWidth(){return this.scaledWidth-this.pagePadding[0]-this.pagePadding[2]}}class As extends lt{constructor(t,e,s,i){super(t,e,i,As.getMusicSymbol(s))}static getMusicSymbol(t){switch(t){case j.Natural:return l.AccidentalNatural;case j.Sharp:return l.AccidentalSharp;case j.Flat:return l.AccidentalFlat;case j.NaturalQuarterNoteUp:return l.AccidentalQuarterToneNaturalArrowUp;case j.SharpQuarterNoteUp:return l.AccidentalQuarterToneSharpArrowUp;case j.FlatQuarterNoteUp:return l.AccidentalQuarterToneFlatArrowUp;case j.DoubleSharp:return l.AccidentalDoubleSharp;case j.DoubleFlat:return l.AccidentalDoubleFlat}return l.None}}class mn extends lt{constructor(t,e,s,i){super(t,e,1,mn.getSymbol(s)),this._clef=s,this._clefOttava=i}static getSymbol(t){switch(t){case Se.Neutral:return l.UnpitchedPercussionClef1;case Se.C3:case Se.C4:return l.CClef;case Se.F4:return l.FClef;case Se.G2:return l.GClef;default:return l.None}}paint(t,e,s){const i=me.bar(s,Be.StandardNotationClef,this.renderer.bar);try{super.paint(t,e,s);let a,n=!1;switch(this._clefOttava){case le._15ma:a=new lt(-4,0,.5,l.Quindicesima),n=!0;break;case le._8va:a=new lt(-2,0,.5,l.Ottava),n=!0;break;case le._8vb:a=new lt(-6,0,.5,l.Ottava);break;case le._15mb:a=new lt(-8,0,.5,l.Quindicesima);break;default:return}let o=0,h=0;switch(this._clef){case Se.Neutral:o=n?-12:15,h=0;break;case Se.C3:case Se.C4:o=n?-19:27,h=0;break;case Se.F4:o=n?-9:27,h=-4;break;case Se.G2:o=n?-37:30,h=0;break;default:return}a.renderer=this.renderer,a.doLayout(),a.paint(t+this.x+this.width/2+h,e+this.y+o,s)}finally{i?.[Symbol.dispose]?.()}}}class mr extends Kt{constructor(t,e,s){super(t,e),this._note=s}static getSymbol(t,e){switch(t){case et.None:return l.None;case et.Normal:return e?l.ArticAccentAbove:l.ArticAccentBelow;case et.Heavy:return e?l.ArticMarcatoAbove:l.ArticMarcatoBelow;case et.Tenuto:return e?l.ArticTenutoAbove:l.ArticTenutoBelow;default:return l.None}}doLayout(){this.width=Ce.Widths.get(l.ArticAccentAbove),this.height=Ce.Heights.get(l.ArticAccentAbove)}paint(t,e,s){const i=this.renderer.getBeatDirection(this._note.beat),a=mr.getSymbol(this._note.accentuated,i===P.Down);s.fillMusicFontSymbol(t+this.x-2,i===P.Up?e+this.y:e+this.y+this.height-2,1,a,!1)}}class yr extends $e{constructor(t,e,s){super(t,e),this._size=0,this._size=s}doLayout(){this.width=this._size+3}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillCircle(t+this.x,e+this.y,this._size),s.color=i}}class Lc extends lt{constructor(t,e,s){super(t,e,s?Me.GraceScale:1,l.NoteheadXOrnate)}}class fa extends lt{constructor(t,e,s,i){super(t,e,i?Me.GraceScale:1,fa.getSymbol(s))}static getSymbol(t){switch(t){case m.QuadrupleWhole:case m.DoubleWhole:case m.Whole:case m.Half:return l.NoteheadDiamondWhiteWide;default:return l.NoteheadDiamondBlackWide}}}let hs=(()=>{class r extends $e{constructor(e,s,i){super(0,0),this.yOffset=0,this.startNoteRenderer=null,this.endNoteRenderer=null,this.tieDirection=P.Up,this._startX=0,this._startY=0,this._endX=0,this._endY=0,this._tieHeight=0,this._shouldDraw=!1,this.startBeat=e,this.endBeat=s,this.forEnd=i}doLayout(){if(this.width=0,!this.endBeat)return void(this._shouldDraw=!1);const e=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar);this.startNoteRenderer=e;const s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endBeat.voice.bar);if(this.endNoteRenderer=s,this._startX=0,this._endX=0,this._startY=0,this._endY=0,this.height=0,this._shouldDraw=!1,this.tieDirection=e?this.getBeamDirection(this.startBeat,e):this.getBeamDirection(this.endBeat,s),!this.forEnd&&e?(e!==s?(this._startX=e.x+this.getStartX(),this._startY=e.y+this.getStartY()+this.yOffset,s&&e.staff===s.staff?(this._endX=s.x+this.getEndX(),this._endY=s.y+this.getEndY()+this.yOffset):(this._endX=e.x+e.width,this._endY=this._startY)):(this._startX=e.x+this.getStartX(),this._endX=s.x+this.getEndX(),this._startY=e.y+this.getStartY()+this.yOffset,this._endY=s.y+this.getEndY()+this.yOffset),this._shouldDraw=!0):(!e||e.staff!==s.staff)&&(this._startX=s.x,this._endX=s.x+this.getEndX(),this._startY=s.y+this.getEndY()+this.yOffset,this._endY=this._startY,this._shouldDraw=!0),this._shouldDraw)if(this.y=Math.min(this._startY,this._endY),this.shouldDrawBendSlur())this._tieHeight=0;else{this._tieHeight=this.getTieHeight(this._startX,this._startY,this._endX,this._endY);const i=r.calculateActualTieHeight(1,this._startX,this._startY,this._endX,this._endY,this.tieDirection===P.Down,this._tieHeight,4);if(this.height=i.h,this.tieDirection===P.Up){const a=this.y-i.y;a>0&&(this.y-=a)}}}paint(e,s,i){this._shouldDraw&&(this.shouldDrawBendSlur()?r.drawBendSlur(i,e+this._startX,s+this._startY,e+this._endX,s+this._endY,this.tieDirection===P.Down,1):r.paintTie(i,1,e+this._startX,s+this._startY,e+this._endX,s+this._endY,this.tieDirection===P.Down,this._tieHeight,4))}shouldDrawBendSlur(){return!1}getTieHeight(e,s,i,a){return 22}getBeamDirection(e,s){return P.Down}getStartY(){return 0}getEndY(){return 0}getStartX(){return 0}getEndX(){return 0}static calculateActualTieHeight(e,s,i,a,n,o,h,c){const d=r.computeBezierControlPoints(e,s,i,a,n,o,h,c),u=d[2],f=d[3],g=r.calculateExtrema(s=d[0],i=d[1],u,f,a=d[6],n=d[7],(s-u)/(s-2*u+a)),b=g.length>0?Math.min(s,a,g[0]):Math.min(s,a),w=g.length>0?Math.max(s,a,g[0]):Math.max(s,a),D=r.calculateExtrema(s,i,u,f,a,n,(i-f)/(i-2*f+n)),N=D.length>0?Math.min(i,n,D[1]):Math.min(i,n),L=D.length>0?Math.max(i,n,D[1]):Math.max(i,n),$=new St;return $.x=b,$.y=N,$.w=w-b,$.h=L-N,$}static calculateExtrema(e,s,i,a,n,o,h){if(h<=0||1<=h)return[];const c=e+(i-e)*h,d=s+(a-s)*h;return[c+(i+(n-i)*h-c)*h,d+(a+(o-a)*h-d)*h]}static computeBezierControlPoints(e,s,i,a,n,o,h,c){if(s===a&&i===n)return[];if(a<s){let N=s;s=a,a=N,N=i,i=n,n=N}h*=e,c*=e;let d=n-i,u=a-s;const f=Math.sqrt(d*d+u*u);o?d*=-1:u*=-1,d/=f,u/=f;const p=(a+s)/2,g=(n+i)/2;return[s,i,p+h*d,g+h*u,p+(h-c)*d,g+(h-c)*u,a,n]}static paintTie(e,s,i,a,n,o,h=!1,c=22,d=4){const u=r.computeBezierControlPoints(s,i,a,n,o,h,c,d);e.beginPath(),e.moveTo(u[0],u[1]),e.quadraticCurveTo(u[2],u[3],u[6],u[7]),e.quadraticCurveTo(u[4],u[5],u[0],u[1]),e.closePath(),e.fill()}static drawBendSlur(e,s,i,a,n,o,h,c){let d=n-i,u=a-s;const f=Math.sqrt(d*d+u*u);o?d*=-1:u*=-1,d/=f,u/=f;let b=r.BendSlurHeight*h;a-s<20&&(b/=2);const w=(a+s)/2+b*d,S=(n+i)/2+b*u;if(e.beginPath(),e.moveTo(s,i),e.lineTo(w,S),e.lineTo(a,n),e.stroke(),c){const D=e.measureText(c).width;e.fillText(c,w-D/2,S+(o?0:-e.font.size))}}}return r.BendSlurHeight=11,r})(),yn=(()=>{class r extends $e{constructor(e){super(0,0),this._isOpen=e}doLayout(){super.doLayout(),this.width=r.Size}paint(e,s,i){const a=i.color;this.colorOverride&&(i.color=this.colorOverride),this._isOpen?hs.paintTie(i,1,e+this.x+this.width,s+this.y+this.height,e+this.x+this.width,s+this.y,!1,6,3):hs.paintTie(i,1,e+this.x,s+this.y,e+this.x,s+this.y+this.height,!1,6,3),i.color=a}}return r.Size=6,r})();class Oo{constructor(t,e,s){this.line=0,this.line=t,this.isGhost=e,this.color=s}}class pa extends $e{constructor(t){super(0,0),this._infos=[],this._glyphs=[],this.isEmpty=!0,this._isOpen=t}addParenthesis(t){const e=this.renderer,s=e.getNoteLine(t),i=t.isGhost||this.isTiedBend(t)&&e.settings.notation.isNotationElementVisible(fe.ParenthesisOnTiedBends),a=me.noteColor(e.resources,Et.Effects,t);this.add(new Oo(s,i,a))}addParenthesisOnLine(t,e){const s=new Oo(t,e,void 0);this.add(s)}add(t){this._infos.push(t),t.isGhost&&(this.isEmpty=!1)}isTiedBend(t){return!!t.isTieDestination&&(!!t.tieOrigin.hasBend||this.isTiedBend(t.tieOrigin))}doLayout(){const t=this.renderer;this._infos.sort((i,a)=>i.line-a.line);let e=null;const s=t.getScoreHeight(1);for(let i=0,a=this._infos.length;i<a;i++){let n;if(this._infos[i].isGhost)if(e){const o=t.getScoreY(this._infos[i].line)+s;e.height=o-e.y}else n=new yn(this._isOpen),n.colorOverride=this._infos[i].color,n.renderer=this.renderer,n.y=t.getScoreY(this._infos[i].line)-s,n.height=2*s,n.doLayout(),this._glyphs.push(n),e=n;else e=null}this.width=this._glyphs.length>0?this._glyphs[0].width:0}paint(t,e,s){super.paint(t,e,s);for(const i of this._glyphs)i.paint(t+this.x,e+this.y,s)}}class Fc{constructor(t,e){this.steps=0,this.glyph=t,this.steps=e}}class Ho extends $e{constructor(){super(0,0),this._infos=[],this._noteHeadPadding=0,this.minNote=null,this.maxNote=null,this.spacingChanged=new it,this.upLineX=0,this.downLineX=0,this.displacedX=0,this.noteStartX=0}add(t,e){const s=new Fc(t,e);this._infos.push(s),(!this.minNote||this.minNote.steps>s.steps)&&(this.minNote=s),(!this.maxNote||this.maxNote.steps<s.steps)&&(this.maxNote=s)}doLayout(){this._infos.sort((o,h)=>h.steps-o.steps);let t=0,e=!1,s=0,i=!1;const a=this.direction;let n=0;for(let o=0,h=this._infos.length;o<h;o++){const c=this._infos[o].glyph;c.renderer=this.renderer,c.doLayout();let d=!1;0===o?t=c.width:Math.abs(s-this._infos[o].steps)<=1?e?e=!1:(d=!0,c.x=t,i=!0,e=!0):e=!1,c.x=a===P.Down?d?0:t:d?t:0,c.x+=this.noteStartX,s=this._infos[o].steps,n=Math.max(n,c.x+c.width),c instanceof Me&&c.centerOnStem&&(c.x=t)}i?(this._noteHeadPadding=0,this.upLineX=t,this.downLineX=t):(this._noteHeadPadding=a===P.Down?-t:0,n+=this._noteHeadPadding,this.upLineX=n,this.downLineX=0),this.displacedX=t,this.width=n}paint(t,e,s){this.paintLedgerLines(t+=this.x,e+=this.y,s);const i=this._infos,a=t+this._noteHeadPadding;for(const n of i)n.glyph.renderer=this.renderer,n.glyph.paint(a,e,s)}paintLedgerLines(t,e,s){if(!this.minNote)return;const i=this.renderer,a=me.bar(s,Be.StandardNotationStaffLine,i.bar,!0);try{const o=this.width-this.noteStartX+6,h=i.getLineHeight(1),c=i.getLineY(-1),d=i.getLineY(i.drawnLineCount),u=i.getLineY(this.minNote.steps/2),f=i.getLineY(this.maxNote.steps/2);let p=c;for(;p>=u;)s.fillRect(t-3+this.noteStartX,e+p|0,o,qe.StaffLineThickness),p-=h;for(p=d;p<=f;)s.fillRect(t-3+this.noteStartX,e+p|0,o,qe.StaffLineThickness),p+=h}finally{a?.[Symbol.dispose]?.()}}}class ga extends lt{constructor(t,e,s){super(t,e,1,ga.getSymbol(s))}static getSymbol(t){switch(t){case m.ThirtySecond:return l.Tremolo3;case m.Sixteenth:return l.Tremolo2;case m.Eighth:return l.Tremolo1;default:return l.None}}}class ma extends $e{constructor(){super(0,0)}doLayout(){this.width=26}paint(t,e,s){const i=this.renderer,a=i.getLineHeight(i.heightLineCount-1),h=i.getLineY(0)+i.getLineHeight(i.drawnLineCount-1)/2-a/2,c=s.lineWidth;s.lineWidth=2,s.moveTo(t+this.x,e+h),s.lineTo(t+this.x+this.width,e+h+a),s.moveTo(t+this.x,e+h+a),s.lineTo(t+this.x+this.width,e+h),s.stroke(),s.lineWidth=c}}class Ec extends Ho{constructor(){super(...arguments),this._noteGlyphLookup=new Map,this._notes=[],this._deadSlapped=null,this._tremoloPicking=null,this.aboveBeatEffects=new Map,this.belowBeatEffects=new Map}get direction(){return this.beamingHelper.direction}getNoteX(t,e){if(this._noteGlyphLookup.has(t.id)){const s=this._noteGlyphLookup.get(t.id);let i=this.x+s.x+this._noteHeadPadding;switch(e){case We.Left:break;case We.Center:i+=s.width/2;break;case We.Right:i+=s.width}return i}return 0}getNoteY(t,e){if(this._noteGlyphLookup.has(t.id)){const s=this._noteGlyphLookup.get(t.id);let i=this.y+s.y;switch(e){case Y.TopWithStem:i-=this.renderer.getStemSize(this.beamingHelper);break;case Y.Top:i-=s.height/2;break;case Y.Center:break;case Y.Bottom:i+=s.height/2;break;case Y.BottomWithStem:i+=this.renderer.getStemSize(this.beamingHelper)}return i}return 0}addNoteGlyph(t,e,s){super.add(t,s),this._noteGlyphLookup.set(e.id,t),this._notes.push(e)}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,t+this.x+this.upLineX,t+this.x+this.downLineX)}doLayout(){super.doLayout();const t=this.renderer;this.beat.deadSlapped&&(this._deadSlapped=new ma,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),this.width=this._deadSlapped.width);const e=this.direction;let s=0,i=0,a=1,n=-a,o=!1,h=!1;this.beat.deadSlapped?(i=t.getScoreY(0),s=t.getScoreY(t.heightLineCount)):this.direction===P.Up?(o=!1,h=!0,i=t.getScoreY(this.maxNote.steps+2),s=t.getScoreY(this.minNote.steps)-t.getStemSize(this.beamingHelper,!0)):(o=!0,h=!1,i=t.getScoreY(this.minNote.steps-1),a*=-1,n*=-1,s=t.getScoreY(this.maxNote.steps)+t.getStemSize(this.beamingHelper,!0));let c=null,d=null;for(const u of this.aboveBeatEffects.values())u.renderer=this.renderer,u.doLayout(),h&&(s+=n*u.height),u.y=s,(null===c||c>s)&&(c=s),(null===d||d<s)&&(d=s),h||(s+=n*u.height);for(const u of this.belowBeatEffects.values())u.renderer=this.renderer,u.doLayout(),o&&(i+=a*u.height),u.y=i,(null===c||c>i)&&(c=i),(null===d||d<i)&&(d=i),o||(i+=a*u.height);if(null!==c&&t.registerBeatEffectOverflows(c,d??0),this.beat.isTremolo&&!this.beat.deadSlapped){let u=0;const f=e===P.Up?this.minNote:this.maxNote;let p=e===P.Up?this.upLineX:this.downLineX;const g=this.beat.tremoloSpeed;switch(g){case m.ThirtySecond:u=e===P.Up?-15:15;break;case m.Sixteenth:u=e===P.Up?-12:15;break;case m.Eighth:u=e===P.Up?-10:10;break;default:u=e===P.Up?-10:15}this.beat.duration<m.Half&&(p=this.width/2),this._tremoloPicking=new ga(p,f.glyph.y+u,g),this._tremoloPicking.renderer=this.renderer,this._tremoloPicking.doLayout()}}buildBoundingsLookup(t,e,s){for(const i of this._notes)if(this._noteGlyphLookup.has(i.id)){const a=this._noteGlyphLookup.get(i.id),n=new Oi;n.note=i,n.noteHeadBounds=new St,n.noteHeadBounds.x=e+this.x+this._noteHeadPadding+a.x,n.noteHeadBounds.y=s+this.y+a.y-a.height/2,n.noteHeadBounds.w=a.width,n.noteHeadBounds.h=a.height,t.addNote(n)}}paint(t,e,s){this.paintEffects(t,e,s),super.paint(t,e,s)}paintEffects(t,e,s){const i=me.beat(s,Ae.StandardNotationEffects,this.beat);try{for(const a of this.aboveBeatEffects.values())a.paint(t+this.x+2,e+this.y,s);for(const a of this.belowBeatEffects.values())a.paint(t+this.x+2,e+this.y,s);this._tremoloPicking&&this._tremoloPicking.paint(t,e,s),this._deadSlapped&&this._deadSlapped.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}class br extends lt{constructor(t,e,s){super(t,e,1,br.getSymbol(s))}static getSymbol(t){switch(t){case m.QuadrupleWhole:return l.RestLonga;case m.DoubleWhole:return l.RestDoubleWhole;case m.Whole:return l.RestWhole;case m.Half:return l.RestHalf;case m.Quarter:return l.RestQuarter;case m.Eighth:return l.RestEighth;case m.Sixteenth:return l.RestSixteenth;case m.ThirtySecond:return l.RestThirtySecond;case m.SixtyFourth:return l.RestSixtyFourth;case m.OneHundredTwentyEighth:return l.RestOneHundredTwentyEighth;case m.TwoHundredFiftySixth:return l.RestTwoHundredFiftySixth;default:return l.None}}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,t+this.x+this.width/2,t+this.x+this.width/2)}paint(t,e,s){this.internalPaint(t,e,s,Ae.StandardNotationRests)}internalPaint(t,e,s,i){const a=me.beat(s,i,this.beat);try{super.paint(t,e,s)}finally{a?.[Symbol.dispose]?.()}}}class Wo{constructor(){this.x=0,this.y=-3e3,this.width=0}}class bn extends ws{constructor(){super(0,0)}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);this.glyphs.sort((s,i)=>s.y<i.y?-1:s.y>i.y?1:0);const t=[];t.push(new Wo);for(let s=0,i=this.glyphs.length;s<i;s++){const a=this.glyphs[s];a.renderer=this.renderer,a.doLayout();let n=0;for(;t[n].y>a.y;)n++,n===t.length&&t.push(new Wo);a.x=n,t[n].y=a.y+21,t[n].width<a.width&&(t[n].width=a.width)}this.width=0;for(const s of t)this.width+=s.width,s.x=this.width;for(let s=0,i=this.glyphs.length;s<i;s++){const a=this.glyphs[s];a.x=this.width-t[a.x].x}}}let hi=(()=>{class r extends Ho{get direction(){return P.Up}constructor(e,s=!1){super(),this._showParenthesis=!1,this._noteValueLookup=new Map,this._accidentals=new bn,this._preNoteParenthesis=null,this._postNoteParenthesis=null,this.isEmpty=!0,this.noteHeadOffset=0,this._beat=e,this._showParenthesis=s,s&&(this._preNoteParenthesis=new pa(!0),this._postNoteParenthesis=new pa(!1))}containsNoteValue(e){return this._noteValueLookup.has(e)}getNoteValueY(e){return this._noteValueLookup.has(e)?this.y+this._noteValueLookup.get(e).y:0}addGlyph(e,s,i){const a=this.renderer,n=new Me(0,0,m.Quarter,!0),o=a.accidentalHelper.applyAccidentalForValue(this._beat,e,s,!0),h=a.accidentalHelper.getNoteLineForValue(e,!1);if(n.y=a.getScoreY(h),this._showParenthesis&&(this._preNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.addParenthesisOnLine(h,!0),this._postNoteParenthesis.addParenthesisOnLine(h,!0)),o!==j.None){const c=new As(0,n.y,o,Me.GraceScale);c.renderer=this.renderer,this._accidentals.renderer=this.renderer,this._accidentals.addGlyph(c)}this._noteValueLookup.set(e,n),this.add(n,h),this.isEmpty=!1}doLayout(){let e=0;this._showParenthesis&&(this._preNoteParenthesis.x=e,this._preNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.doLayout(),e+=this._preNoteParenthesis.width+r.ElementPadding),this._accidentals.isEmpty||(e+=this._accidentals.width+r.ElementPadding,this._accidentals.x=e,this._accidentals.renderer=this.renderer,this._accidentals.doLayout(),e+=this._accidentals.width+r.ElementPadding),this.noteStartX=e,super.doLayout(),this.noteHeadOffset=this.noteStartX+(this.width-this.noteStartX)/2,this._showParenthesis&&(this._postNoteParenthesis.x=this.width+r.ElementPadding,this._postNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.doLayout(),this.width+=this._postNoteParenthesis.width+r.ElementPadding)}paint(e,s,i){this._accidentals.isEmpty||this._accidentals.paint(e+this.x,s+this.y,i),this._showParenthesis&&(this._preNoteParenthesis.paint(e+this.x,s+this.y,i),this._postNoteParenthesis.paint(e+this.x,s+this.y,i)),super.paint(e,s,i)}}return r.ElementPadding=2,r})(),Vo=(()=>{class r extends $e{constructor(){super(...arguments),this.BendNoteHeads=[]}drawBendSlur(e,s,i,a,n,o,h,c){hs.drawBendSlur(e,s,i,a,n,o,h,c)}doLayout(){super.doLayout(),this.width=0;for(const e of this.BendNoteHeads)e.doLayout(),this.width+=e.width+10}getTieDirection(e,s){return s.getBeatDirection(e)===P.Up?P.Down:P.Up}}return r.EndPadding=8,r})();class li extends R{constructor(t=0,e=0){super(t,e),this.lineValue=0,this.lineValue=e}}let Go=(()=>{class r extends $e{constructor(){super(0,0),this._notes=[],this._renderPoints=new Map,this._preBendMinValue=-1,this._bendMiddleMinValue=-1,this._bendEndMinValue=-1,this._bendEndContinuedMinValue=-1,this._releaseMinValue=-1,this._releaseContinuedMinValue=-1,this._maxBendValue=-1}addBends(e){this._notes.push(e);const s=this.createRenderingPoints(e);this._renderPoints.set(e.id,s),(-1===this._maxBendValue||this._maxBendValue<e.maxBendPoint.value)&&(this._maxBendValue=e.maxBendPoint.value);let i=0;switch(e.bendType){case z.Bend:i=s[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||i<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=i):(-1===this._bendEndMinValue||i<this._bendEndMinValue)&&(this._bendEndMinValue=i);break;case z.Release:i=s[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):i>0&&(-1===this._releaseMinValue||i<this._releaseMinValue)&&(this._releaseMinValue=i);break;case z.BendRelease:i=s[1].value,(-1===this._bendMiddleMinValue||i<this._bendMiddleMinValue)&&(this._bendMiddleMinValue=i),i=s[2].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):i>0&&(-1===this._releaseMinValue||i<this._releaseMinValue)&&(this._releaseMinValue=i);break;case z.Prebend:i=s[0].value,(-1===this._preBendMinValue||i<this._preBendMinValue)&&(this._preBendMinValue=i);break;case z.PrebendBend:i=s[0].value,(-1===this._preBendMinValue||i<this._preBendMinValue)&&(this._preBendMinValue=i),i=s[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||i<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=i):(-1===this._bendEndMinValue||i<this._bendEndMinValue)&&(this._bendEndMinValue=i);break;case z.PrebendRelease:i=s[0].value,(-1===this._preBendMinValue||i<this._preBendMinValue)&&(this._preBendMinValue=i),i=s[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):i>0&&(-1===this._releaseMinValue||i<this._releaseMinValue)&&(this._releaseMinValue=i)}}doLayout(){super.doLayout(),this.renderer.registerOverflowTop(this._maxBendValue*r.BendValueHeight);let s=0;for(const i of this._notes){const a=this._renderPoints.get(i.id);switch(i.bendType){case z.Bend:a[1].lineValue=i.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case z.Release:s=i.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,s>=0&&(a[1].lineValue=s);break;case z.BendRelease:a[1].lineValue=this._bendMiddleMinValue,s=i.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,s>=0&&(a[2].lineValue=s);break;case z.Prebend:a[0].lineValue=this._preBendMinValue;break;case z.PrebendBend:a[0].lineValue=this._preBendMinValue,a[1].lineValue=i.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case z.PrebendRelease:a[0].lineValue=this._preBendMinValue,s=i.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,s>=0&&(a[1].lineValue=s)}}this.width=0,this._notes.sort((i,a)=>i.isStringed?i.string-a.string:i.realValue-a.realValue)}createRenderingPoints(e){const s=[];switch(e.bendType){case z.Custom:for(const i of e.bendPoints)s.push(new li(i.offset,i.value));break;case z.BendRelease:s.push(new li(0,e.bendPoints[0].value)),s.push(new li(R.MaxPosition/2|0,e.bendPoints[1].value)),s.push(new li(R.MaxPosition,e.bendPoints[3].value));break;case z.Bend:case z.Hold:case z.Prebend:case z.PrebendBend:case z.PrebendRelease:case z.Release:s.push(new li(0,e.bendPoints[0].value)),s.push(new li(R.MaxPosition,e.bendPoints[1].value))}return s}paint(e,s,i){const a=i.color;this._notes.length>1&&(i.color=this.renderer.resources.secondaryGlyphColor);for(const n of this._notes){const o=this._renderPoints.get(n.id),h=this.renderer;let c=n,d=!1,u=null,f=!1;const p=n.bendStyle===Ie.Gradual?"grad.":"";let g=null;for(;c.isTieOrigin;){const L=c.tieDestination;if(u=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,L.beat.voice.bar),!u||h.staff!==u.staff)break;if(c=L,d=!0,c.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes||c.vibrato!==ke.None){f=!0;break}}g=c.beat,u=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,g.voice.bar),g.isLastOfVoice&&!c.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(g=null);let b=0,w=0;const S=s+h.y;b=e+h.x,b+=o[0].value>0||n.isContinuedBend?h.getBeatX(n.beat,be.MiddleNotes):h.getNoteX(n,We.Right),w=!g||g.isLastOfVoice&&!f?e+u.x+u.postBeatGlyphsStart:f||!g.nextBeat?e+u.x+u.getBeatX(g,be.MiddleNotes):n.bendType===z.Hold?e+u.x+u.getBeatX(g.nextBeat,be.OnNotes):e+u.x+u.getBeatX(g.nextBeat,be.PreNotes),d||(w-=r.ArrowSize);const N=(w-b)/R.MaxPosition;i.beginPath();for(let L=0,$=o.length-1;L<$;L++){const E=o[L];let B=o[L+1];0===L&&0!==E.value&&!n.isTieDestination&&this.paintBend(n,new li(0,0),E,b,S,N,p,i),n.bendType!==z.Prebend?(0===L&&(b+=2),this.paintBend(n,E,B,b,S,N,p,i)):n.isTieOrigin&&n.tieDestination.hasBend&&(B=new li(R.MaxPosition,E.value),B.lineValue=E.lineValue,this.paintBend(n,E,B,b,S,N,p,i))}if(c.vibrato!==ke.None){const E=new oi(w-e+r.ArrowSize-u.x,S-s-r.BendValueHeight*o[o.length-1].lineValue,c.vibrato,1.2);E.beat=c.beat,E.renderer=u,E.doLayout(),E.paint(e+u.x,s,i)}i.color=a}}paintBend(e,s,i,a,n,o,h,c){const d=this.renderer,u=this.renderer.resources,f=d.lineOffset/2,p=a+o*s.offset,g=r.BendValueHeight;let b=n-g*s.lineValue;b+=0===s.value?i.offset===s.offset?d.getNoteY(e.beat.maxStringNote,Y.Top):d.getNoteY(e,Y.Center):f;const w=a+o*i.offset;let S=n-g*i.lineValue;S+=0===i.lineValue?d.getNoteY(e,Y.Center):f;let D=0;const N=r.ArrowSize;if(i.value>s.value?(S+N>b&&(S=b-N),c.beginPath(),c.moveTo(w,S),c.lineTo(w-.5*N,S+N),c.lineTo(w+.5*N,S+N),c.closePath(),c.fill(),D=N):i.value!==s.value&&(S<b&&(S=b+N),c.beginPath(),c.moveTo(w,S),c.lineTo(w-.5*N,S-N),c.lineTo(w+.5*N,S-N),c.closePath(),c.fill(),D=-N),c.beginPath(),s.value===i.value){if(s.lineValue>0){let L=w;const $=r.DashSize,E=p+$;if((L-p)/(2*$)<1)c.moveTo(L,b),c.lineTo(p,b);else for(;L>E;)c.moveTo(L,b),c.lineTo(L-$,b),L-=2*$;c.stroke()}}else w>p?(c.moveTo(p,b),c.bezierCurveTo((p+w)/2,b,w,b,w,S+D),c.stroke()):(c.moveTo(p,b),c.lineTo(w,S),c.stroke());if(h&&s.offset<i.offset){c.font=u.graceFont;const L=c.measureText(h).width;let $=0,E=0;if(b>S){const B=Math.abs(b-S);$=B>1.3*c.font.size?b-B/2:b,E=(p+w-L)/2}else $=b,E=w-L;c.fillText(h,E,$)}if(0!==i.value&&s.value!==i.value){let L=i.value;const $=i.value>s.value;L=Math.abs(L);let E="";if(4===L)E="full",L-=4;else if(L>=4||L<=-4){const B=L/4|0;E+=B,L-=4*B}if(L>0&&(E+=r.getFractionSign(L)),""!==E){S=n-g*i.value;let B=S;$||(B=b+1*Math.abs(S-b)/3),c.font=u.tablatureFont;const ie=c.measureText(E).width;c.fillText(E,w-ie/2,B-.5*u.tablatureFont.size-2)}}}static getFractionSign(e){switch(e){case 1:return"\xbc";case 2:return"\xbd";case 3:return"\xbe";default:return`${e}/ 4`}}}return r.ArrowSize=6,r.DashSize=3,r.BendValueHeight=6,r})(),zo=(()=>{class r extends $e{constructor(e){super(0,0),this._isSimpleDip=!1,this._beat=e,this._renderPoints=this.createRenderingPoints(e)}createRenderingPoints(e){if(e.whammyBarType===_e.Custom)return e.whammyBarPoints;const s=[];switch(e.whammyBarType){case _e.Dive:case _e.Hold:case _e.PrediveDive:case _e.Predive:s.push(new R(0,e.whammyBarPoints[0].value)),s.push(new R(R.MaxPosition,e.whammyBarPoints[1].value));break;case _e.Dip:s.push(new R(0,e.whammyBarPoints[0].value)),s.push(new R(R.MaxPosition/2|0,e.whammyBarPoints[1].value)),s.push(new R(R.MaxPosition,e.whammyBarPoints[e.whammyBarPoints.length-1].value))}return s}doLayout(){super.doLayout(),this._isSimpleDip=this.renderer.settings.notation.notationMode===_t.SongBook&&this._beat.whammyBarType===_e.Dip;let e=null,s=null,i=this._beat;for(;i&&i.hasWhammyBar;)(!e||e.value>i.minWhammyPoint.value)&&(e=i.minWhammyPoint),(!s||s.value<i.maxWhammyPoint.value)&&(s=i.maxWhammyPoint),i=i.nextBeat;let a=s.value>0?Math.abs(this.getOffset(s.value)):0;(a>0||0!==this._beat.whammyBarPoints[0].value||this.renderer.settings.notation.isNotationElementVisible(fe.ZerosOnDiveWhammys))&&(a+=2*this.renderer.resources.tablatureFont.size);const n=e.value<0?Math.abs(this.getOffset(e.value)):0;this.renderer.registerOverflowTop(a+n),a>this.renderer.staff.getSharedLayoutData(r.TopOffsetSharedDataKey,-1)&&this.renderer.staff.setSharedLayoutData(r.TopOffsetSharedDataKey,a)}getOffset(e){if(0===e)return 0;let s=r.PerHalfSize+Math.log2(Math.abs(e)/2)*r.PerHalfSize;return e<0&&(s=-s),s}paint(e,s,i){const a=me.beat(i,Ae.StandardNotationEffects,this._beat);try{const n=this.renderer;let o=this._beat.nextBeat,h=null,c=be.PreNotes;o&&(h=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,o.voice.bar),!h||h.staff!==n.staff||h!==n&&!o.hasWhammyBar?(o=null,h=null):c=!o.hasWhammyBar||n.settings.notation.notationMode===_t.SongBook&&o.whammyBarType===_e.Dip?be.PreNotes:be.MiddleNotes);let d=0,u=0;this._isSimpleDip?(d=e+n.x+n.getBeatX(this._beat,be.OnNotes)-2,u=e+n.x+n.getBeatX(this._beat,be.PostNotes)+2):(d=e+n.x+n.getBeatX(this._beat,be.MiddleNotes),u=h?e+h.x+h.getBeatX(o,c):e+n.x+n.width-2);const f=i.textAlign;if(i.textAlign=U.Center,this._renderPoints.length>=2){const p=(u-d)/R.MaxPosition;i.beginPath();const g=s+this.renderer.staff.getSharedLayoutData(r.TopOffsetSharedDataKey,0);let b=this._beat.whammyStyle===Ie.Gradual?"grad.":"";for(let w=0,S=this._renderPoints.length-1;w<S;w++){const D=this._renderPoints[w],N=this._renderPoints[w+1],L=w<S-2?this._renderPoints[w+2]:null;let $=0===w;0===w&&0!==D.value&&!this._beat.isContinuedWhammy&&(this.paintWhammy(!1,new R(0,0),D,N,d,g,p,i),$=!1),this.paintWhammy($,D,N,L,d,g,p,i,b),b=""}i.stroke()}i.textAlign=f}finally{a?.[Symbol.dispose]?.()}}paintWhammy(e,s,i,a,n,o,h,c,d){const u=n+h*s.offset,f=n+h*i.offset,p=o-this.getOffset(s.value),g=o-this.getOffset(i.value);if(s.offset===i.offset){const S=r.DashSize;if(Math.abs(g-p)/(2*S)<1)c.moveTo(u,p),c.lineTo(f,g);else{const N=Math.max(p,g);let L=Math.min(p,g);for(;N>L;)c.moveTo(u,L),c.lineTo(u,L+S),L+=2*S}c.stroke()}else if(s.value===i.value){const S=r.DashSize;if(Math.abs(f-u)/(2*S)<1)c.moveTo(u,p),c.lineTo(f,g);else{let N=Math.max(u,f);const L=Math.min(u,f);for(;N>L;)c.moveTo(N,p),c.lineTo(N-S,p),N-=2*S}c.stroke()}else c.moveTo(u,p),c.lineTo(f,g);const b=this.renderer.resources;if(e&&!this._beat.isContinuedWhammy&&!this._isSimpleDip){let S=p;S-=b.tablatureFont.size+2,this.renderer.settings.notation.isNotationElementVisible(fe.ZerosOnDiveWhammys)&&c.fillText("0",u,S),d&&(S-=b.tablatureFont.size+2,c.fillText(d,u,S))}let w=Math.abs(i.value);if((0!==w||this.renderer.settings.notation.isNotationElementVisible(fe.ZerosOnDiveWhammys)&&!this._isSimpleDip)&&s.value!==i.value){let S="";if(i.value<0&&(S+="-"),w>=4){const L=w/4|0;S+=L,w-=4*L}else 0===w&&(S+="0");w>0&&(S+=Go.getFractionSign(w));let D=0;this._isSimpleDip?D=Math.min(p,g)-b.tablatureFont.size-2:(D=s.offset===i.offset?Math.min(p,g):g,D-=b.tablatureFont.size+2,a&&a.value>i.value&&(D-=2)),c.fillText(S,f,D)}}}return r.TopOffsetSharedDataKey="tab.whammy.topoffset",r.PerHalfSize=6,r.DashSize=3,r})();class Pi extends Vo{constructor(t){super(0,0),this._beat=t}doLayout(){const t=this.renderer.settings.notation.notationMode;switch(this._beat.whammyBarType){case _e.None:case _e.Custom:case _e.Hold:return;case _e.Dive:case _e.PrediveDive:{const e=new hi(this._beat,!1);e.renderer=this.renderer;const s=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(const i of this._beat.notes)i.isTieOrigin||e.addGlyph(this.getBendNoteValue(i,s),s.value%2!=0,void 0);e.doLayout(),this.BendNoteHeads.push(e)}break;case _e.Dip:if(t===_t.SongBook)this.renderer.simpleWhammyOverflow=1.5*this.renderer.resources.tablatureFont.size+Pi.SimpleDipHeight+Pi.SimpleDipPadding;else{const e=new hi(this._beat,!1);if(e.renderer=this.renderer,this.renderer.settings.notation.notationMode===_t.GuitarPro){const i=this._beat.whammyBarPoints[1];for(const a of this._beat.notes)e.addGlyph(this.getBendNoteValue(a,this._beat.whammyBarPoints[1]),i.value%2!=0,void 0)}e.doLayout(),this.BendNoteHeads.push(e);const s=new hi(this._beat,!1);if(s.renderer=this.renderer,this.renderer.settings.notation.notationMode===_t.GuitarPro){const i=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(const a of this._beat.notes)s.addGlyph(this.getBendNoteValue(a,i),i.value%2!=0,void 0)}s.doLayout(),this.BendNoteHeads.push(s)}}super.doLayout()}paint(t,e,s){const i=this._beat;switch(i.whammyBarType){case _e.None:case _e.Custom:return}const a=this.renderer.settings.notation.notationMode,n=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,i.voice.bar),o=me.beat(s,Ae.StandardNotationEffects,i);try{const h=t+n.x+n.getBeatX(i,be.MiddleNotes),c=this.getTieDirection(i,n);let d=1===this._beat.notes.length?c:P.Up;const u=s.textAlign,f=Ce.Heights.get(l.NoteheadBlack);for(let p=0;p<i.notes.length;p++){const g=i.notes[p],b=me.note(s,Et.StandardNotationEffects,g);try{let w=e+n.y;p>0&&p>=(this._beat.notes.length/2|0)&&(d=P.Down),w+=n.getNoteY(g,d===P.Down?Y.Bottom:Y.Top);let S=t+n.x;S+=i.isLastOfVoice?n.width:n.getBeatX(i,be.EndBeat),S-=8;const D=i.whammyStyle===Ie.Gradual&&0===p?"grad.":"";let N=null;g.isTieOrigin&&(N=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,g.tieDestination.beat.voice.bar),N&&N.staff===n.staff?S=t+N.x+N.getBeatX(g.tieDestination.beat,be.MiddleNotes):N=null);let L=f*Me.GraceScale*.5;d===P.Up&&(L=-L);const $=i.whammyBarPoints.length>0?this.getBendNoteValue(g,i.whammyBarPoints[i.whammyBarPoints.length-1]):0;let E=0,B=!1;switch(this.BendNoteHeads.length>0&&this.BendNoteHeads[0].containsNoteValue($)?(E=this.BendNoteHeads[0].getNoteValueY($)+L,B=!0):N&&(g.isTieOrigin&&g.tieDestination.beat.hasWhammyBar||g.beat.isContinuedWhammy)?(E=e+N.y+N.getNoteY(g.tieDestination,Y.Top),B=!0,d===P.Down&&(E+=f)):g.isTieOrigin&&(E=N?e+N.y+N.getNoteY(g.tieDestination,Y.Top):w,d===P.Down&&(E+=f)),i.whammyBarType){case _e.Hold:g.isTieOrigin&&hs.paintTie(s,1,h,w,S,E,c===P.Down,22,4);break;case _e.Dive:if(0===p){this.BendNoteHeads[0].x=S-this.BendNoteHeads[0].noteHeadOffset;const Ne=this.BendNoteHeads[0].y;this.BendNoteHeads[0].y=e+n.y,this.BendNoteHeads[0].paint(0,0,s),this.BendNoteHeads[0].containsNoteValue($)&&(E-=Ne,E+=this.BendNoteHeads[0].y)}B?this.drawBendSlur(s,h,w,S,E,d===P.Down,1,D):g.isTieOrigin&&hs.paintTie(s,1,h,w,S,E,c===P.Down,22,4);break;case _e.Dip:if(a===_t.SongBook){if(0===p){const Ne=t+n.x+n.getBeatX(this._beat,be.OnNotes)-2,ee=t+n.x+n.getBeatX(this._beat,be.PostNotes)+2,Ve=(Ne+ee)/2,At=((this._beat.whammyBarPoints[1].value-this._beat.whammyBarPoints[0].value)/4|0).toString();s.font=this.renderer.resources.tablatureFont,s.fillText(At,Ve,e+this.y);const ss=e+this.y+s.font.size+2,ls=ss+Pi.SimpleDipHeight;this._beat.whammyBarPoints[1].value>this._beat.whammyBarPoints[0].value?(s.moveTo(Ne,ls),s.lineTo(Ve,ss),s.lineTo(ee,ls)):(s.moveTo(Ne,ss),s.lineTo(Ve,ls),s.lineTo(ee,ss)),s.stroke()}g.isTieOrigin&&hs.paintTie(s,1,h,w,S,E,c===P.Down,22,4)}else{const Ne=(h+S)/2;this.BendNoteHeads[0].x=Ne-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=e+n.y,this.BendNoteHeads[0].paint(0,0,s);const ee=this.getBendNoteValue(g,i.whammyBarPoints[1]),Ve=this.BendNoteHeads[0].getNoteValueY(ee)+L;this.drawBendSlur(s,h,w,Ne,Ve,d===P.Down,1,D),this.BendNoteHeads[1].x=S-this.BendNoteHeads[1].noteHeadOffset,this.BendNoteHeads[1].y=e+n.y,this.BendNoteHeads[1].paint(0,0,s),E=this.BendNoteHeads[1].getNoteValueY($)+L,this.drawBendSlur(s,Ne,Ve,S,E,d===P.Down,1,D)}break;case _e.PrediveDive:case _e.Predive:let ie=t+n.x+n.getBeatX(g.beat,be.PreNotes);ie+=n.getPreNotesGlyphForBeat(g.beat).prebendNoteHeadOffset;const Re=e+n.y+n.getScoreY(n.accidentalHelper.getNoteLineForValue(g.displayValue-(g.beat.whammyBarPoints[0].value/2|0),!1))+L;this.drawBendSlur(s,ie,Re,h,w,d===P.Down,1,D),this.BendNoteHeads.length>0&&(this.BendNoteHeads[0].x=S-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=e+n.y,this.BendNoteHeads[0].paint(0,0,s),this.drawBendSlur(s,h,w,S,E,d===P.Down,1,D))}}finally{b?.[Symbol.dispose]?.()}}s.textAlign=u}finally{o?.[Symbol.dispose]?.()}}getBendNoteValue(t,e){return t.displayValueWithoutBend+(e.value/2|0)}}Pi.SimpleDipHeight=2*zo.PerHalfSize,Pi.SimpleDipPadding=2;class Nt extends $e{constructor(t,e,s){super(t,e),this.width=s}}class vc extends lt{constructor(t,e,s,i,a){super(t,e,a?Me.GraceScale:1,s.getSymbol(i)),this._isGrace=a,this._articulation=s}paint(t,e,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride);const a=this._isGrace?1:0;s.fillMusicFontSymbol(t+this.x,e+this.y+a,this.glyphScale,this.symbol,!1),this._articulation.techniqueSymbol!==l.None&&this._articulation.techniqueSymbolPlacement===re.Middle&&s.fillMusicFontSymbol(t+this.x,e+this.y+a,this.glyphScale,this._articulation.techniqueSymbol,!1),s.color=i}doLayout(){super.doLayout(),0===this.width&&(this.height=Ce.Widths.get(l.NoteheadBlack)),0===this.height&&(this.height=Ce.Heights.get(l.NoteheadBlack))}}class Uo extends lt{constructor(t,e){super(t,e,Me.GraceScale,l.ArticStaccatoAbove)}paint(t,e,s){super.paint(t+3,e+5,s)}}class Ic extends lt{constructor(t,e){super(t,e,.5,l.PictEdgeOfCymbal)}paint(t,e,s){super.paint(t-3,e+this.height,s)}}class Yo extends lt{constructor(t,e,s=!1){super(t,e,Me.GraceScale,l.GuitarGolpe),this.center=s}paint(t,e,s){super.paint(t,e+this.height,s)}}class Ac extends Kt{constructor(){super(...arguments),this._strings=new Set}addString(t){this._strings.add(t)}doLayout(){const t=Ce.Widths.get(l.GuitarString0)*ca.CircleNumberScale;this.height=(t+3)*this._strings.size,this.width=t}paint(t,e,s){const i=this.renderer.bar.staff.tuning.length;let a=0;const n=Ce.Widths.get(l.GuitarString0)*ca.CircleNumberScale,o=Ce.Heights.get(l.NoteheadBlack);for(const h of this._strings)s.fillMusicFontSymbol(t+this.x+o/2,e+this.y+n+a,ca.CircleNumberScale,l.GuitarString1+(i-h),!0),a+=n+3}}class Sr extends Kt{constructor(t,e,s,i,a){super(t,e),this.beatEffects=new Map,this.noteHeadElement=Et.SlashNoteHead,this.effectElement=Ae.SlashEffects,this._isGrace=i,this._symbol=Sr.getSymbol(s),this.beat=a}paint(t,e,s){const i=0===this.beat.notes.length?void 0:me.note(s,this.noteHeadElement,this.beat.notes[0]);try{s.fillMusicFontSymbol(t+this.x,e+this.y+(this._isGrace?1:0),this._isGrace?Me.GraceScale:1,this._symbol,!1),this.paintEffects(t,e,s)}finally{i?.[Symbol.dispose]?.()}}paintEffects(t,e,s){const i=me.beat(s,this.effectElement,this.beat);try{for(const a of this.beatEffects.values())a.paint(t+this.x,e+this.y,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){const t=this._isGrace?Me.GraceScale:1;this.width=Ce.Widths.get(this._symbol)*t,this.height=Ce.Heights.get(this._symbol)*t;let s=Ce.Heights.get(this._symbol);for(const i of this.beatEffects.values())i.y+=s,i.x+=this.width/2,i.renderer=this.renderer,s+=7,i.doLayout()}static getSymbol(t){switch(t){case m.QuadrupleWhole:case m.DoubleWhole:case m.Whole:return l.NoteheadSlashWhiteWhole;case m.Half:return l.NoteheadSlashWhiteHalf;default:return l.NoteheadSlashVerticalEnds}}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.beat,t+this.x+this.width,t+this.x)}}class Mc extends ai{constructor(){super(...arguments),this._collisionOffset=-1e3,this._skipPaint=!1,this.slash=null,this.noteHeads=null,this.restGlyph=null}get effectElement(){return Ae.StandardNotationEffects}getNoteX(t,e){return this.noteHeads?this.noteHeads.getNoteX(t,e):0}buildBoundingsLookup(t,e,s){this.noteHeads&&this.noteHeads.buildBoundingsLookup(t,e+this.x,s+this.y)}getNoteY(t,e){return this.noteHeads?this.noteHeads.getNoteY(t,e):0}updateBeamingHelper(){if(this.noteHeads)this.noteHeads.updateBeamingHelper(this.container.x+this.x);else if(this.restGlyph){if(this.restGlyph.updateBeamingHelper(this.container.x+this.x),this.renderer.bar.isMultiVoice&&-1e3===this._collisionOffset){this._collisionOffset=this.renderer.helpers.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this._collisionOffset;const t=this.renderer.helpers.collisionHelper.restDurationsByDisplayTime;t.has(this.container.beat.playbackStart)&&t.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&t.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this._skipPaint=!0)}}else this.slash&&this.slash.updateBeamingHelper(this.container.x+this.x)}paint(t,e,s){this._skipPaint||super.paint(t,e,s)}doLayout(){const t=this.renderer;if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let e=2*Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2);this.container.beat.duration===m.Whole&&1!==this.renderer.bar.staff.standardNotationLineCount&&3!==this.renderer.bar.staff.standardNotationLineCount&&(e-=2);const s=new br(0,t.getScoreY(e),this.container.beat.duration);if(this.restGlyph=s,s.beat=this.container.beat,s.beamingHelper=this.beamingHelper,this.addNormal(s),this.renderer.bar.isMultiVoice)if(0===this.container.beat.voice.index){const i=ks.computeLineHeightsForRest(this.container.beat.duration),a=s.y-t.getScoreHeight(i[0]),n=s.y+t.getScoreHeight(i[1]);this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,a,n)}else this.renderer.helpers.collisionHelper.registerRest(this.container.beat);if(this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,e),this.container.beat.dots>0){this.addNormal(new Nt(0,0,5));for(let i=0;i<this.container.beat.dots;i++){const a=new ws(0,0);a.renderer=this.renderer,this.createBeatDot(e,a),this.addEffect(a)}}}else{if(this.container.beat.slashed){const e=this.container.beat.graceType!==K.None,i=t.getLineY((t.heightLineCount-1)/2),a=new Sr(0,i,this.container.beat.duration,e,this.container.beat);a.noteHeadElement=Et.StandardNotationNoteHead,a.effectElement=Ae.StandardNotationEffects,this.slash=a,a.beat=this.container.beat,a.beamingHelper=this.beamingHelper,this.addNormal(a)}else{const e=new Ec;this.noteHeads=e,e.beat=this.container.beat,e.beamingHelper=this.beamingHelper;const s=new pa(!1);s.renderer=this.renderer;for(const i of this.container.beat.notes)i.isVisible&&(this.createNoteGlyph(i),s.addParenthesis(i));this.addNormal(e),s.isEmpty||(this.addNormal(new Nt(0,0,4*(this.container.beat.graceType!==K.None?Me.GraceScale:1))),this.addEffect(s))}if(this.container.beat.hasWhammyBar){const e=new Pi(this.container.beat);e.renderer=this.renderer,e.doLayout(),this.container.ties.push(e)}if(this.container.beat.dots>0){this.addNormal(new Nt(0,0,5));for(let e=0;e<this.container.beat.dots;e++){const s=new ws(0,0);s.renderer=this.renderer;for(const i of this.container.beat.notes)this.createBeatDot(t.getNoteLine(i),s).colorOverride=me.noteColor(t.resources,Et.StandardNotationEffects,i);this.addEffect(s)}}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.slash&&(this.centerX=this.slash.x+this.slash.width/2)}createBeatDot(t,e){const i=new yr(0,this.renderer.getScoreY(t),1.5);return e.addGlyph(i),i}createNoteHeadGlyph(t){const e=this.container.beat.graceType!==K.None,s=t.style;if(void 0!==s?.noteHead){const i=new Me(0,0,t.beat.duration,e);return i.symbol=s.noteHead,s.noteHeadCenterOnStem&&(i.centerOnStem=!0),i}if(t.beat.voice.bar.staff.isPercussion){const i=ht.getArticulation(t);if(i)return new vc(0,0,i,t.beat.duration,e);x.warning("Rendering",`No articulation found for percussion instrument ${t.percussionArticulation}`)}return t.isDead?new Lc(0,0,e):t.beat.graceType===K.BendGrace?new Me(0,0,m.Quarter,!0):t.harmonicType===Z.Natural?new fa(0,0,t.beat.duration,e):new Me(0,0,t.beat.duration,e)}createNoteGlyph(t){if(t.beat.graceType===K.BendGrace&&!t.hasBend)return;const e=this.renderer,s=this.createNoteHeadGlyph(t);s.colorOverride=me.noteColor(e.resources,Et.StandardNotationNoteHead,t);let i=e.getNoteLine(t);if(s.y=e.getScoreY(i),this.noteHeads.addNoteGlyph(s,t,i),t.harmonicType!==Z.None&&t.harmonicType!==Z.Natural){const o=t.displayValue+t.harmonicPitch,h=new fa(0,0,t.beat.duration,this.container.beat.graceType!==K.None);h.colorOverride=s.colorOverride,i=e.accidentalHelper.getNoteLineForValue(o,!1),h.y=e.getScoreY(i),this.noteHeads.addNoteGlyph(h,t,i)}const a=this.noteHeads.belowBeatEffects,n=this.noteHeads.aboveBeatEffects;if(t.isStaccato&&!a.has("Staccato")&&a.set("Staccato",new Uo(0,0)),t.accentuated===et.Normal&&!a.has("Accent")&&a.set("Accent",new mr(0,0,t)),t.accentuated===et.Heavy&&!a.has("HAccent")&&a.set("HAccent",new mr(0,0,t)),t.accentuated===et.Tenuto&&!a.has("Tenuto")&&a.set("Tenuto",new mr(0,0,t)),t.showStringNumber&&t.isStringed){let o;n.has("StringNumber")?o=n.get("StringNumber"):(o=new Ac(0,0),n.set("StringNumber",o)),o.addString(t.string)}if(t.isPercussion){const o=ht.getArticulation(t);if(o&&o.techniqueSymbolPlacement!==re.Middle){const h=o.techniqueSymbolPlacement===re.Top?this.noteHeads.aboveBeatEffects:this.noteHeads.belowBeatEffects;switch(o.techniqueSymbol){case l.PictEdgeOfCymbal:h.set("PictEdgeOfCymbal",new Ic(0,0));break;case l.ArticStaccatoAbove:h.set("ArticStaccatoAbove",new Uo(0,0));break;case l.StringsUpBow:h.set("StringsUpBow",new gr(0,0,yt.Up));break;case l.StringsDownBow:h.set("StringsDownBow",new gr(0,0,yt.Down));break;case l.GuitarGolpe:h.set("GuitarGolpe",new Yo(0,0))}}}}}class Rc extends $e{constructor(t){super(0,0),this._beat=t}doLayout(){this.width=this._beat.brushType===V.ArpeggioUp||this._beat.brushType===V.ArpeggioDown?10:0}paint(t,e,s){if(this._beat.brushType===V.ArpeggioUp||this._beat.brushType===V.ArpeggioDown){const i=this.renderer,a=i.lineOffset,n=e+this.y+(i.getNoteY(this._beat.maxNote,Y.Bottom)-a),o=e+this.y+i.getNoteY(this._beat.minNote,Y.Top)+a,h=t+this.x+this.width/2,c=8,d=new oi(0,0,ke.Slight,1.2,!0);d.renderer=this.renderer,d.doLayout();const u=-d.height/2;if(this._beat.brushType===V.ArpeggioUp){const p=o-c;d.width=Math.abs(p-(n+c)),s.beginRotate(t+this.x+5,p,-90),d.paint(0,u,s),s.endRotate(),s.beginPath(),s.moveTo(h,o),s.lineTo(h+c/2,o-c),s.lineTo(h-c/2,o-c),s.closePath(),s.fill()}else if(this._beat.brushType===V.ArpeggioDown){const f=n+c;d.width=Math.abs(o-f),s.beginRotate(t+this.x+5,f,90),d.paint(0,u,s),s.endRotate(),s.beginPath(),s.moveTo(h,n),s.lineTo(h+c/2,n+c),s.lineTo(h-c/2,n+c),s.closePath(),s.fill()}}}}class Oc{constructor(t,e){this.line=0,this.line=t,this.text=e}}class Hc extends ws{constructor(){super(0,0),this._infos=new Map}get isEmpty(){return 0===this._infos.size}addFingers(t){const e=this.renderer.settings;if(e.notation.fingeringMode!==xs.ScoreDefault&&e.notation.fingeringMode!==xs.ScoreForcePiano)return;const s=O.fingerToString(this.renderer.settings,t.beat,t.leftHandFinger,!0);s&&this.addFinger(t,s);const i=O.fingerToString(this.renderer.settings,t.beat,t.rightHandFinger,!1);i&&this.addFinger(t,i)}addFinger(t,e){const s=this.renderer,i=s.getNoteLine(t);if(this._infos.has(i))this._infos.get(i).text+=e;else{const a=new Oc(i,e);a.color=me.noteColor(s.resources,Et.StandardNotationEffects,t),this._infos.set(i,a)}}doLayout(){const t=this.renderer;for(const[e,s]of this._infos){const i=new Zt(0,0,s.text,t.resources.inlineFingeringFont,U.Left,re.Middle);i.colorOverride=s.color,i.renderer=t,i.y=t.getScoreY(s.line),i.doLayout(),this.addGlyph(i),this.width=Math.max(this.width,i.width)}}}class Wc extends ri{constructor(){super(...arguments),this._prebends=null,this.accidentals=null}get prebendNoteHeadOffset(){return this._prebends?this._prebends.x+this._prebends.noteHeadOffset:0}get effectElement(){return Ae.StandardNotationEffects}doLayout(){if(!this.container.beat.isRest){const t=new bn;t.renderer=this.renderer;const e=new Hc;e.renderer=this.renderer;const s=new pa(!0);s.renderer=this.renderer;const i=new hi(this.container.beat,!0);this._prebends=i,i.renderer=this.renderer;for(const a of this.container.beat.notes){const n=me.noteColor(this.renderer.resources,Et.StandardNotationEffects,a);if(a.isVisible){if(a.hasBend)switch(a.bendType){case z.PrebendBend:case z.Prebend:case z.PrebendRelease:i.addGlyph(a.displayValue-(a.bendPoints[0].value/2|0),!1,n)}else if(a.beat.hasWhammyBar)switch(a.beat.whammyBarType){case _e.PrediveDive:case _e.Predive:this._prebends.addGlyph(a.displayValue-(a.beat.whammyBarPoints[0].value/2|0),!1,n)}this.createAccidentalGlyph(a,t),s.addParenthesis(a),e.addFingers(a)}}i.isEmpty||(this.addEffect(i),this.addNormal(new Nt(0,0,4*(this.container.beat.graceType!==K.None?Me.GraceScale:1)))),this.container.beat.brushType!==V.None&&(this.addEffect(new Rc(this.container.beat)),this.addNormal(new Nt(0,0,4))),e.isEmpty||(this.isEmpty||this.addNormal(new Nt(0,0,2*(this.container.beat.graceType!==K.None?Me.GraceScale:1))),this.addEffect(e),this.addNormal(new Nt(0,0,2*(this.container.beat.graceType!==K.None?Me.GraceScale:1)))),s.isEmpty||(this.addEffect(s),this.addNormal(new Nt(0,0,4*(this.container.beat.graceType!==K.None?Me.GraceScale:1)))),t.isEmpty||(this.accidentals=t,this.isEmpty||this.addNormal(new Nt(0,0,2*(this.container.beat.graceType!==K.None?Me.GraceScale:1))),this.addNormal(t),this.addNormal(new Nt(0,0,2*(this.container.beat.graceType!==K.None?Me.GraceScale:1))))}super.doLayout()}createAccidentalGlyph(t,e){const s=this.renderer;let i=s.accidentalHelper.applyAccidental(t),a=s.getNoteLine(t);const n=this.container.beat.graceType!==K.None,o=me.noteColor(s.resources,Et.StandardNotationAccidentals,t),h=n?Me.GraceScale:1;if(i!==j.None){const c=new As(0,s.getScoreY(a),i,h);c.colorOverride=o,c.renderer=this.renderer,e.addGlyph(c)}if(t.harmonicType!==Z.None&&t.harmonicType!==Z.Natural){const c=t.displayValue+t.harmonicPitch;i=s.accidentalHelper.applyAccidentalForValue(t.beat,c,n,!1),a=s.accidentalHelper.getNoteLineForValue(c,!1);const d=new As(0,s.getScoreY(a),i,h);d.colorOverride=o,d.renderer=this.renderer,e.addGlyph(d)}}}class Xo extends ws{constructor(t,e,s,i,a,n){super(t,e),this._numerator=0,this._denominator=0,this.barSubElement=Be.StandardNotationTimeSignature,this._numerator=s,this._denominator=i,this._isCommon=a,this._isFreeTime=n}paint(t,e,s){const i=me.bar(s,this.barSubElement,this.renderer.bar);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){let t=0;const e=da.numberHeight;if(this._isFreeTime){const s=new yn(!0);s.renderer=this.renderer,s.y=-e,s.height=2*e,s.doLayout(),this.addGlyph(s),t+=s.width+10}if(this._isCommon&&2===this._numerator&&2===this._denominator){const s=new lt(t,0,this.commonScale,l.TimeSigCutCommon);this.addGlyph(s),super.doLayout()}else if(this._isCommon&&4===this._numerator&&4===this._denominator){const s=new lt(t,0,this.commonScale,l.TimeSigCommon);this.addGlyph(s),super.doLayout()}else{const s=new da(t,-e/2,this._numerator,this.numberScale),i=new da(t,e/2,this._denominator,this.numberScale);this.addGlyph(s),this.addGlyph(i),super.doLayout();const a=this.width-t;s.x=t+(a-s.width)/2,i.x=t+(a-i.width)/2}if(this._isFreeTime){const s=new yn(!1);s.renderer=this.renderer,s.x=this.width+13,s.y=-e,s.height=2*e,s.doLayout(),this.addGlyph(s),this.width=s.x+s.width}}}class Sn extends Xo{get commonScale(){return 1}get numberScale(){return 1}}class Vc extends Vo{constructor(t){super(0,0),this._notes=[],this._endNoteGlyph=null,this._middleNoteGlyph=null,this._beat=t}addBends(t){if(this._notes.push(t),t.isTieOrigin)return;const e=me.noteColor(this.renderer.resources,Et.StandardNotationEffects,t);switch(t.bendType){case z.Bend:case z.PrebendRelease:case z.PrebendBend:{let s=this._endNoteGlyph;s||(s=new hi(t.beat,!1),s.renderer=this.renderer,this._endNoteGlyph=s,this.BendNoteHeads.push(s));const i=t.bendPoints[t.bendPoints.length-1];s.addGlyph(this.getBendNoteValue(t,i),i.value%2!=0,e)}break;case z.Release:if(!t.isTieOrigin){let s=this._endNoteGlyph;s||(s=new hi(t.beat,!1),s.renderer=this.renderer,this._endNoteGlyph=s,this.BendNoteHeads.push(s));const i=t.bendPoints[t.bendPoints.length-1];s.addGlyph(this.getBendNoteValue(t,i),i.value%2!=0,e)}break;case z.BendRelease:{let s=this._middleNoteGlyph;s||(s=new hi(t.beat,!1),this._middleNoteGlyph=s,s.renderer=this.renderer,this.BendNoteHeads.push(s));const i=t.bendPoints[1];s.addGlyph(this.getBendNoteValue(t,t.bendPoints[1]),i.value%2!=0,e);let a=this._endNoteGlyph;a||(a=new hi(t.beat,!1),a.renderer=this.renderer,this._endNoteGlyph=a,this.BendNoteHeads.push(a));const n=t.bendPoints[t.bendPoints.length-1];a.addGlyph(this.getBendNoteValue(t,n),n.value%2!=0,e)}}}paint(t,e,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._beat.voice.bar),a=t+i.x+i.getBeatX(this._beat,be.MiddleNotes);let n=t+i.x;n+=this._beat.isLastOfVoice?i.postBeatGlyphsStart:i.getBeatX(this._beat.nextBeat,be.PreNotes),n-=8;const o=(a+n)/2;this._middleNoteGlyph&&(this._middleNoteGlyph.x=o-this._middleNoteGlyph.noteHeadOffset,this._middleNoteGlyph.y=e+i.y,this._middleNoteGlyph.paint(0,0,s)),this._endNoteGlyph&&(this._endNoteGlyph.x=n-this._endNoteGlyph.noteHeadOffset,this._endNoteGlyph.y=e+i.y,this._endNoteGlyph.paint(0,0,s)),this._notes.sort((u,f)=>f.displayValue-u.displayValue);let c=1===this._notes.length?this.getTieDirection(this._beat.graceType===K.BendGrace?this._beat.nextBeat:this._beat,i):P.Up;const d=Ce.Heights.get(l.NoteheadBlack);for(let u=0;u<this._notes.length;u++){const f=this._notes[u],p=me.note(s,Et.StandardNotationEffects,f);try{u>0&&u>=(this._notes.length/2|0)&&(c=P.Down);let g=e+i.y+i.getNoteY(f,Y.Top),b=d*Me.GraceScale*.5;c===P.Down&&(g+=d);const w=f.bendStyle===Ie.Gradual?"grad.":"";if(f.isTieOrigin){const S=f.tieDestination,D=S?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,S.beat.voice.bar):null;if(D&&D.staff===i.staff){const N=t+D.x+D.getBeatX(S.beat,be.MiddleNotes);let L=e+D.y+D.getNoteY(S,Y.Top);c===P.Down&&(L+=d),f.bendType===z.Hold||f.bendType===z.Prebend?hs.paintTie(s,1,a,g,N,L,c===P.Down,22,4):this.drawBendSlur(s,a,g,N,L,c===P.Down,1,w)}else{const N=t+i.x+i.width,L=f.tieDestination.realValue;i.accidentalHelper.applyAccidentalForValue(f.beat,L,!1,!0);const $=e+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(L,!1));f.bendType===z.Hold||f.bendType===z.Prebend?hs.paintTie(s,1,a,g,N,$,c===P.Down,22,4):this.drawBendSlur(s,a,g,N,$,c===P.Down,1,w)}switch(f.bendType){case z.Prebend:case z.PrebendBend:case z.PrebendRelease:let N=t+i.x+i.getBeatX(f.beat,be.PreNotes);N+=i.getPreNotesGlyphForBeat(f.beat).prebendNoteHeadOffset;const L=e+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(f.displayValue-(f.bendPoints[0].value/2|0),!1))+b;this.drawBendSlur(s,N,L,a,g,c===P.Down,1)}}else{c===P.Up&&(b=-b);let S=0,D=0;switch(f.bendType){case z.Bend:S=this.getBendNoteValue(f,f.bendPoints[f.bendPoints.length-1]),D=this._endNoteGlyph.getNoteValueY(S)+b,this.drawBendSlur(s,a,g,n,D,c===P.Down,1,w);break;case z.BendRelease:const N=this.getBendNoteValue(f,f.bendPoints[1]),L=this._middleNoteGlyph.getNoteValueY(N)+b;this.drawBendSlur(s,a,g,o,L,c===P.Down,1,w),S=this.getBendNoteValue(f,f.bendPoints[f.bendPoints.length-1]),D=this._endNoteGlyph.getNoteValueY(S)+b,this.drawBendSlur(s,o,L,n,D,c===P.Down,1,w);break;case z.Release:this.BendNoteHeads.length>0&&(S=this.getBendNoteValue(f,f.bendPoints[f.bendPoints.length-1]),D=this.BendNoteHeads[0].getNoteValueY(S)+b,this.drawBendSlur(s,a,g,n,D,c===P.Down,1,w));break;case z.Prebend:case z.PrebendBend:case z.PrebendRelease:let $=t+i.x+i.getBeatX(f.beat,be.PreNotes);$+=i.getPreNotesGlyphForBeat(f.beat).prebendNoteHeadOffset;const E=e+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(f.displayValue-(f.bendPoints[0].value/2|0),!1))+b;this.drawBendSlur(s,$,E,a,g,c===P.Down,1),this.BendNoteHeads.length>0&&(S=this.getBendNoteValue(f,f.bendPoints[f.bendPoints.length-1]),D=this.BendNoteHeads[0].getNoteValueY(S)+b,this.drawBendSlur(s,a,g,n,D,c===P.Down,1,w))}}}finally{p?.[Symbol.dispose]?.()}}}getBendNoteValue(t,e){return t.displayValueWithoutBend+(e.value/2|0)}}class wn extends hs{constructor(t,e,s=!1){super(t,e,s)}doLayout(){super.doLayout()}getBeamDirection(t,e){return t.isRest?P.Up:e.getBeatDirection(t)===P.Up?P.Down:P.Up}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):this.tieDirection===P.Up?this.startNoteRenderer.getNoteY(this.startBeat.maxNote,Y.Top):this.startNoteRenderer.getNoteY(this.startBeat.minNote,Y.Bottom)}getEndY(){const t=this.endNoteRenderer;if(this.endBeat.isRest)return t.getScoreY(this.tieDirection===P.Up?9:0);const e=this.startNoteRenderer.getBeatDirection(this.startBeat),s=t.getBeatDirection(this.endBeat);return e!==s&&this.startBeat.graceType===K.None?s===this.tieDirection?this.tieDirection===P.Up?t.getNoteY(this.endBeat.maxNote,Y.TopWithStem):t.getNoteY(this.endBeat.minNote,Y.BottomWithStem):this.tieDirection===P.Up?t.getNoteY(this.endBeat.maxNote,Y.BottomWithStem):t.getNoteY(this.endBeat.minNote,Y.TopWithStem):this.tieDirection===P.Up?t.getNoteY(this.endBeat.maxNote,Y.Top):t.getNoteY(this.endBeat.minNote,Y.Bottom)}getStartX(){return this.startNoteRenderer.getBeatX(this.startBeat,be.MiddleNotes)}getEndX(){const t=this.endNoteRenderer.getBeatDirection(this.endBeat);return this.endNoteRenderer.getBeatX(this.endBeat,this.endBeat.duration>m.Whole&&t===this.tieDirection?be.Stem:be.MiddleNotes)}}class Gc extends $e{constructor(t,e,s,i){super(0,0),this._outType=e,this._inType=t,this._startNote=s,this._parent=i}doLayout(){this.width=0}paint(t,e,s){this.paintSlideIn(t,e,s),this.drawSlideOut(t,e,s)}paintSlideIn(t,e,s){const i=this.renderer;let n=t+i.x+i.getNoteX(this._startNote,We.Left)-2;const o=e+i.y+i.getNoteY(this._startNote,Y.Center);let h=n-12,c=e+i.y;switch(this._inType){case ut.IntoFromBelow:c+=i.getNoteY(this._startNote,Y.Bottom);break;case ut.IntoFromAbove:c+=i.getNoteY(this._startNote,Y.Top);break;default:return}const d=this.getAccidentalsWidth(i,this._startNote.beat);h-=d,n-=d,this.paintSlideLine(s,!1,h,n,c,o)}getAccidentalsWidth(t,e){const s=t.getPreNotesGlyphForBeat(e);return s&&s.accidentals?s.accidentals.width:0}drawSlideOut(t,e,s){const i=this.renderer;let h=0,c=0,d=0,u=0,f=!1;switch(this._outType){case ce.Shift:case ce.Legato:if(h=t+i.x+i.getBeatX(this._startNote.beat,be.PostNotes)+2,c=e+i.y+i.getNoteY(this._startNote,Y.Center),this._startNote.slideTarget){const p=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar);p&&p.staff===i.staff?(d=t+p.x+p.getBeatX(this._startNote.slideTarget.beat,be.PreNotes)-2,u=e+p.y+p.getNoteY(this._startNote.slideTarget,Y.Center)):(d=t+i.x+i.width,u=c),this._startNote.slideTarget.realValue>this._startNote.realValue?(c+=2,u-=2):(c-=2,u+=2)}else d=t+i.x+this._parent.x,u=c;break;case ce.OutUp:h=t+i.x+i.getNoteX(this._startNote,We.Right)+2,c=e+i.y+i.getNoteY(this._startNote,Y.Center),d=h+12,u=e+i.y+i.getNoteY(this._startNote,Y.Top);break;case ce.OutDown:h=t+i.x+i.getNoteX(this._startNote,We.Right)+2,c=e+i.y+i.getNoteY(this._startNote,Y.Center),d=h+12,u=e+i.y+i.getNoteY(this._startNote,Y.Bottom);break;case ce.PickSlideUp:h=t+i.x+i.getNoteX(this._startNote,We.Right)+4,c=e+i.y+i.getNoteY(this._startNote,Y.Center),u=e+i.y+i.getNoteY(this._startNote,Y.Top),d=t+i.x+i.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(d=t+i.x+i.getBeatX(this._startNote.beat.nextBeat,be.PreNotes)),f=!0;break;case ce.PickSlideDown:h=t+i.x+i.getNoteX(this._startNote,We.Right)+4,c=e+i.y+i.getNoteY(this._startNote,Y.Center),u=e+i.y+i.getNoteY(this._startNote,Y.Bottom),d=t+i.x+i.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(d=t+i.x+i.getBeatX(this._startNote.beat.nextBeat,be.PreNotes)),f=!0;break;default:return}this.paintSlideLine(s,f,h,d,c,u)}paintSlideLine(t,e,s,i,a,n){if(e){const o=new oi(0,0,ke.Slight,1.2);o.renderer=this.renderer,o.doLayout();const h=i-s,c=(n-=o.height/2)-(a-=o.height/2),d=Math.sqrt(Math.pow(c,2)+Math.pow(h,2));o.width=h;const u=Math.asin(c/d)*(180/Math.PI);t.beginRotate(s,a,u),o.paint(0,0,t),t.endRotate()}else t.beginPath(),t.moveTo(s,a),t.lineTo(i,n),t.stroke()}}class ya extends wn{constructor(t,e,s=!1){super(t.beat,e.beat,s),this._startNote=t,this._endNote=e}getTieHeight(t,e,s,i){return Math.log2(s-t+1)*this.renderer.settings.notation.slurHeight}getStartY(){return this.isStartCentered()?this.startNoteRenderer.getNoteY(this._startNote,this.tieDirection===P.Up?Y.Top:Y.Bottom):this.startNoteRenderer.getNoteY(this._startNote,Y.Center)}getEndY(){return this.isEndCentered()?this.isEndOnStem()?this.endNoteRenderer.getNoteY(this._endNote,this.tieDirection===P.Up?Y.TopWithStem:Y.BottomWithStem):this.endNoteRenderer.getNoteY(this._endNote,this.tieDirection===P.Up?Y.Top:Y.Bottom):this.endNoteRenderer.getNoteY(this._endNote,Y.Center)}isStartCentered(){return this._startNote===this._startNote.beat.maxNote&&this.tieDirection===P.Up||this._startNote===this._startNote.beat.minNote&&this.tieDirection===P.Down}isEndCentered(){return this._startNote.beat.graceType===K.None&&(this._endNote===this._endNote.beat.maxNote&&this.tieDirection===P.Up||this._endNote===this._endNote.beat.minNote&&this.tieDirection===P.Down)}isEndOnStem(){const t=this.endNoteRenderer;return this.startNoteRenderer.getBeatDirection(this.startBeat)!==t.getBeatDirection(this.endBeat)&&this.startBeat.graceType===K.None}getStartX(){return this.isStartCentered()?this.startNoteRenderer.getBeatX(this._startNote.beat,be.MiddleNotes):this.startNoteRenderer.getNoteX(this._startNote,We.Right)}getEndX(){return this.isEndCentered()?this.isEndOnStem()?this.endNoteRenderer.getBeatX(this._endNote.beat,be.Stem):this.endNoteRenderer.getNoteX(this._endNote,We.Center):this.endNoteRenderer.getBeatX(this._endNote.beat,be.PreNotes)}}class Jo extends hs{constructor(t,e,s=!1){super(t?t.beat:null,e?e.beat:null,s),this.startNote=t,this.endNote=e}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(t,e){return e.getBeatDirection(t)===P.Up?P.Down:P.Up}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):this.startNoteRenderer.getNoteY(this.startNote,this.tieDirection===P.Up?Y.Top:Y.Bottom)}getEndY(){const t=this.endNoteRenderer;return this.endBeat.isRest?t.getScoreY(this.tieDirection===P.Up?9:0):t.getNoteY(this.endNote,this.tieDirection===P.Up?Y.Top:Y.Bottom)}getStartX(){return this.startNoteRenderer.getBeatX(this.startNote.beat,be.PostNotes)}getEndX(){return this.endNoteRenderer.getBeatX(this.endNote.beat,be.PreNotes)}}class zc extends bs{constructor(){super(...arguments),this._bend=null,this._effectSlur=null,this._effectEndSlur=null}doLayout(){this._effectSlur=null,this._effectEndSlur=null,super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(t){if(t.isVisible){if(t.isTieOrigin&&!t.hasBend&&!t.beat.hasWhammyBar&&t.beat.graceType!==K.BendGrace&&t.tieDestination&&t.tieDestination.isVisible){const e=new Jo(t,t.tieDestination,!1);this.addTie(e)}if(t.isTieDestination&&!t.tieOrigin.hasBend&&!t.beat.hasWhammyBar){const e=new Jo(t.tieOrigin,t,!0);this.addTie(e)}if(t.slideInType!==ut.None||t.slideOutType!==ce.None){const e=new Gc(t.slideInType,t.slideOutType,t,this);this.addTie(e)}if(t.isSlurOrigin&&t.slurDestination&&t.slurDestination.isVisible){const e=new ya(t,t.slurDestination,!1);this.addTie(e)}if(t.isSlurDestination){const e=new ya(t.slurOrigin,t,!0);this.addTie(e)}if(!this._effectSlur&&t.isEffectSlurOrigin&&t.effectSlurDestination){const e=new ya(t,t.effectSlurDestination,!1);this._effectSlur=e,this.addTie(e)}if(!this._effectEndSlur&&t.beat.isEffectSlurDestination&&t.beat.effectSlurOrigin){const e=this.onNotes.beamingHelper.direction,a=new ya(e===P.Up?t.beat.effectSlurOrigin.minNote:t.beat.effectSlurOrigin.maxNote,e===P.Up?t.beat.minNote:t.beat.maxNote,!0);this._effectEndSlur=a,this.addTie(a)}if(t.hasBend){if(!this._bend){const e=new Vc(t.beat);this._bend=e,e.renderer=this.renderer,this.addTie(e)}this._bend.addBends(t)}if(this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let e=this.beat.nextBeat;for(;e.nextBeat&&e.nextBeat.isLegatoDestination;)e=e.nextBeat;this.addTie(new wn(this.beat,e,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let e=this.beat.previousBeat;for(;e.previousBeat&&e.previousBeat.isLegatoOrigin;)e=e.previousBeat;this.addTie(new wn(e,this.beat,!0))}}}}class Ci extends $e{doLayout(){this.width=1}paint(t,e,s){const a=e+this.y+this.renderer.topPadding;this.paintInternal(t+this.x,a,e+this.y+this.renderer.height-this.renderer.bottomPadding-a,s)}}class wr extends Ci{paintInternal(t,e,s,i){i.fillRect(t,e,1,s)}}class Uc extends Ci{paintInternal(t,e,s,i){const n=t,o=this.renderer.getLineHeight(1);let h=e+.5*o+1;const c=e+s;for(;h<c;)i.fillCircle(n,h,1),h+=o}}let Yc=(()=>{class r extends Ci{paintInternal(e,s,i,a){const n=r.DashSize,o=e+.5,h=Math.ceil(i/2/n),c=s+i;if(a.beginPath(),h<1)a.moveTo(o,s),a.lineTo(o,c);else{let d=s;const f=(i-h*n)/(h-1);for(;d<c;)a.moveTo(o,d),a.lineTo(o,d+n),d+=n+f}a.stroke()}}return r.DashSize=4,r})();class kr extends Ci{doLayout(){this.width=4}paintInternal(t,e,s,i){i.fillRect(t,e,this.width,s)}}class qo extends Ci{paintInternal(t,e,s,i){const o=(e+(e+s))/2;i.fillCircle(t,o-4.5,1.5),i.fillCircle(t,o+4.5,1.5)}}class Xc extends Ci{paintInternal(t,e,s,i){const a=this.renderer,o=a.drawnLineCount-1;if(o<=2)return;const h=a.getLineHeight(1),c=2*h;i.fillRect(t,e+(o/2*h-c/2),1,c)}}class Jc extends Ci{paintInternal(t,e,s,i){const n=this.renderer.getLineHeight(1);i.fillRect(t,e+(-n/2+1),1,n)}}class kn extends _i{constructor(t){super(),this._isRight=t}doLayout(){const t=this.renderer.bar,e=t.masterBar,s=this._isRight?t.getActualBarLineRight():t.getActualBarLineLeft(0===this.renderer.index);let i=te.Automatic;if(!this._isRight){const n=this.renderer.previousRenderer;if(n&&n.staff===this.renderer.staff&&(i=n.bar.getActualBarLineRight(),s===i))return}switch(this._isRight&&e.isRepeatEnd&&(this.addGlyph(new qo(0,0)),this.width+=3),s){case te.Dashed:this.addGlyph(new Yc(0,0));break;case te.Dotted:this.addGlyph(new Uc(0,0));break;case te.Heavy:i!==te.LightHeavy&&i!==te.HeavyHeavy&&this.addGlyph(new kr(0,0));break;case te.HeavyHeavy:i!==te.LightHeavy&&i!==te.Heavy&&this.addGlyph(new kr(0,0)),this.width+=3,this.addGlyph(new kr(0,0));break;case te.HeavyLight:i!==te.LightHeavy&&i!==te.Heavy&&i!==te.HeavyHeavy&&this.addGlyph(new kr(0,0)),this.width+=3,this.addGlyph(new wr(0,0));break;case te.LightHeavy:i!==te.HeavyLight&&i!==te.Regular&&i!==te.LightLight&&this.addGlyph(new wr(0,0)),this.width+=3,this.addGlyph(new kr(0,0));break;case te.LightLight:i!==te.HeavyLight&&i!==te.Regular&&this.addGlyph(new wr(0,0)),this.width+=3,this.addGlyph(new wr(0,0));break;case te.None:break;case te.Regular:i!==te.HeavyLight&&i!==te.LightLight&&this.addGlyph(new wr(0,0));break;case te.Short:this.addGlyph(new Xc(0,0));break;case te.Tick:this.addGlyph(new Jc(0,0))}this._isRight||e.isRepeatStart&&(this.width+=3,this.addGlyph(new qo(0,0)))}paint(t,e,s){const a=me.bar(s,this.renderer.barLineBarSubElement,this.renderer.bar,!0);try{super.paint(t,e,s)}finally{a?.[Symbol.dispose]?.()}}}class qc extends $e{constructor(t,e,s){super(t,e),this._count=0,this._count=0,this._count=s}doLayout(){this.width=0}paint(t,e,s){const i=me.bar(s,this.renderer.repeatsBarSubElement,this.renderer.bar);try{const n=s.textAlign;s.font=this.renderer.resources.barNumberFont,s.textAlign=U.Right;const o=`x${this._count}`,h=s.measureText(o).width/1.5;s.fillText(o,t+this.x-h,e+this.y),s.textAlign=n}finally{i?.[Symbol.dispose]?.()}}}class $o extends $e{constructor(t,e,s){super(t,e),this._number=0,this._number=s}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.barNumberFont,this.width=this.renderer.scoreRenderer.canvas.measureText(this._number.toString()).width+5}paint(t,e,s){if(!this.renderer.staff.isFirstInSystem)return;const i=me.bar(s,this.renderer.barNumberBarSubElement,this.renderer.bar,!0);try{const a=this.renderer.resources,n=s.textBaseline;s.textBaseline=re.Top,s.font=a.barNumberFont,s.fillText(this._number.toString(),t+this.x,e+this.y),s.textBaseline=n}finally{i?.[Symbol.dispose]?.()}}}class Ms extends qe{constructor(){super(...arguments),this.firstLineY=0,this._startSpacing=!1,this.tupletSize=0}get lineOffset(){return this.lineSpacing+1}get tupletOffset(){return 10}get topGlyphOverflow(){const t=this.resources;return t.tablatureFont.size/2+.2*t.tablatureFont.size}get bottomGlyphOverflow(){const t=this.resources;return t.tablatureFont.size/2+.2*t.tablatureFont.size}initLineBasedSizes(){this.topPadding=this.topGlyphOverflow,this.bottomPadding=this.bottomGlyphOverflow,this.height=this.lineOffset*(this.heightLineCount-1)+this.topPadding+this.bottomPadding}updateSizes(){this.initLineBasedSizes(),this.adjustSizes(),this.updateFirstLineY(),super.updateSizes()}adjustSizes(){}updateFirstLineY(){this.firstLineY=this.topPadding+(this.lineOffset*(this.heightLineCount-1)-(this.drawnLineCount-1)*this.lineOffset)/2}doLayout(){this.initLineBasedSizes(),this.updateFirstLineY(),this.tupletSize=15+.3*this.resources.effectFont.size,super.doLayout()}getLineY(t){return this.firstLineY+this.getLineHeight(t)}getLineHeight(t){return this.lineOffset*t}paintBackground(t,e,s){super.paintBackground(t,e,s),this.paintStaffLines(t,e,s),this.paintSimileMark(t,e,s)}paintStaffLines(t,e,s){const i=me.bar(s,this.staffLineBarSubElement,this.bar,!0);try{const a=[];for(let o=0,h=this.drawnLineCount;o<h;o++)a.push([]);this.additionalMultiRestBars||this.collectSpaces(a);for(const o of a)o.sort((h,c)=>h[0]>c[0]?1:h[0]<c[0]?-1:0);const n=Math.ceil(this.width);for(let o=0;o<this.drawnLineCount;o++){const h=this.getLineY(o);let c=0;for(const d of a[o])s.fillRect(t+this.x+c,e+this.y+h|0,d[0]-c,qe.StaffLineThickness),c=d[0]+d[1];s.fillRect(t+this.x+c,e+this.y+h|0,n-c,qe.StaffLineThickness)}}finally{i?.[Symbol.dispose]?.()}}collectSpaces(t){}createStartSpacing(){this._startSpacing||(this.addPreBeatGlyph(new Nt(0,0,0===this.index?this.settings.display.firstStaffPaddingLeft:this.settings.display.staffPaddingLeft)),this._startSpacing=!0)}paintTuplets(t,e,s,i,a=!1){for(const n of this.bar.voices)if(this.hasVoiceContainer(n)){const o=this.getVoiceContainer(n);for(const h of o.tupletGroups)this.paintTupletHelper(t+this.beatGlyphsStart,e,s,h,i,a)}}getTupletBeamDirection(t){return this.getBeamDirection(t)}paintTupletHelper(t,e,s,i,a,n){const o=this.resources,h=s.textAlign,c=s.textBaseline;let d;s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.textAlign=U.Center,s.textBaseline=re.Middle;const u=i.beats[0].tupletNumerator,f=i.beats[0].tupletDenominator;d=2===u&&3===f?"2":3===u&&2===f?"3":4===u&&6===f?"4":5===u&&4===f?"5":6===u&&4===f?"6":7===u&&4===f?"7":9===u&&8===f?"9":10===u&&8===f?"10":11===u&&8===f?"11":12===u&&8===f?"12":13===u&&8===f?"13":`${u}:${f}`;let p=this.tupletOffset,g=5;const b=me.beat(s,a,i.beats[0]);try{if(1!==i.beats.length&&i.isFull){const w=i.beats[0],S=i.beats[i.beats.length-1];let D=null,N=null;for(let mt=0;mt<i.beats.length;mt++)if(!i.beats[mt].isRest){D=i.beats[mt];break}for(let mt=i.beats.length-1;mt>=0;mt--)if(!i.beats[mt].isRest){N=i.beats[mt];break}let L=!1;D||(D=w,L=!0),N||(N=S);const $=this.helpers.beamHelperLookup[i.voice.index].get(w.index),E=this.helpers.beamHelperLookup[i.voice.index].get(S.index),B=$.getBeatLineX(w),ie=E.getBeatLineX(S),Re=this.helpers.beamHelperLookup[i.voice.index].get(D.index),Ne=this.helpers.beamHelperLookup[i.voice.index].get(N.index),ee=this.getTupletBeamDirection($);let Ve=this.calculateBeamYWithDirection(Re,B,ee),At=this.calculateBeamYWithDirection(Ne,ie,ee);L&&(Ve=Math.max(Ve,At),At=Ve),s.font=o.effectFont;const ss=s.measureText(d).width,ls=3,Bt=(B+ie)/2,Ht=Bt-ss/2-ls,ci=Bt+ss/2+ls,Qs=(At-Ve)/(ie-B),fs=Ve-Qs*B,Pt=Qs*Ht+fs,Di=Qs*Bt+fs,_s=Qs*ci+fs;ee===P.Down&&(p*=-1,g*=-1),s.beginPath(),s.moveTo(t+this.x+B,e+this.y+Ve-p|0),n?s.quadraticCurveTo(t+this.x+(Ht+B)/2,e+this.y+Pt-p-g|0,t+this.x+Ht,e+this.y+Pt-p-g|0):(s.lineTo(t+this.x+B,e+this.y+Ve-p-g|0),s.lineTo(t+this.x+Ht,e+this.y+Pt-p-g|0)),s.stroke(),s.beginPath(),s.moveTo(t+this.x+ci,e+this.y+_s-p-g|0),n?s.quadraticCurveTo(t+this.x+(ie+ci)/2,e+this.y+_s-p-g|0,t+this.x+ie,e+this.y+At-p|0):(s.lineTo(t+this.x+ie,e+this.y+At-p-g|0),s.lineTo(t+this.x+ie,e+this.y+At-p|0)),s.stroke(),s.fillText(d,t+this.x+Bt,e+this.y+Di-p-g)}else for(const w of i.beats){const S=this.helpers.beamHelperLookup[i.voice.index].get(w.index);if(!S)continue;const D=this.getTupletBeamDirection(S),N=S.getBeatLineX(w);let L=this.calculateBeamYWithDirection(S,N,D);D===P.Down?L+=p+g:L-=p+g,s.font=o.effectFont,s.fillText(d,t+this.x+N,e+this.y+L)}s.textAlign=h,s.textBaseline=c}finally{b?.[Symbol.dispose]?.()}}paintBeams(t,e,s,i,a){for(const n of this.helpers.beamHelpers)for(const o of n)this.paintBeamHelper(t+this.beatGlyphsStart,e,s,o,i,a)}drawBeamHelperAsFlags(t){return 1===t.beats.length}paintBeamHelper(t,e,s,i,a,n){s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isRestBeamHelper||(this.drawBeamHelperAsFlags(i)?this.paintFlag(t,e,s,i,a):this.paintBar(t,e,s,i,n))}shouldPaintFlag(t,e){return!(t.graceType===K.BendGrace||t.deadSlapped||!e.hasBeatLineX(t)||t.graceType!==K.None&&this.settings.notation.notationMode===_t.SongBook||t.duration===m.Whole||t.duration===m.DoubleWhole||t.duration===m.QuadrupleWhole)}paintFlag(t,e,s,i,a){for(const n of i.beats){if(!this.shouldPaintFlag(n,i))continue;const o=n.graceType!==K.None,h=o?Me.GraceScale:1,c=this.getFlagStemSize(i.shortestDuration),d=i.getBeatLineX(n),u=this.getBeamDirection(i);let f=this.getFlagTopY(n,u),p=this.getFlagBottomY(n,u),g=0;if(u===P.Down?(p+=c*h,g=p):(f-=c*h,g=f),!i.hasLine(!0,n))continue;this.paintBeamingStem(n,e+this.y,t+this.x+d,e+this.y+f,e+this.y+p,s);const b=me.beat(s,a,n);try{if(n.graceType===K.BeforeBeat&&(s.beginPath(),u===P.Down?(s.moveTo(t+this.x+d-6,e+this.y+p-15),s.lineTo(t+this.x+d+6,e+this.y+p)):(s.moveTo(t+this.x+d-6,e+this.y+f+15),s.lineTo(t+this.x+d+6,e+this.y+f)),s.stroke()),i.hasFlag(!0,n)){const w=new aa(d-.5,g,n.duration,u,o);w.renderer=this,w.doLayout(),w.paint(t+this.x,e+this.y,s)}}finally{b?.[Symbol.dispose]?.()}}}getFlagStemSize(t,e=!1){let s=0;switch(t){case m.QuadrupleWhole:case m.Half:case m.Quarter:case m.Eighth:case m.Sixteenth:case m.ThirtySecond:case m.SixtyFourth:case m.OneHundredTwentyEighth:case m.TwoHundredFiftySixth:s=3;break;default:s=e?3:0}return this.getLineHeight(s)}recreatePreBeatGlyphs(){this._startSpacing=!1,super.recreatePreBeatGlyphs()}calculateBeamY(t,e){return this.calculateBeamYWithDirection(t,e,this.getBeamDirection(t))}createPreBeatGlyphs(){super.createPreBeatGlyphs(),this.addPreBeatGlyph(new kn(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new $o(0,this.getLineHeight(-.25),this.bar.index+1))}createPostBeatGlyphs(){super.createPostBeatGlyphs();const t=this.lastBar;this.addPostBeatGlyph(new kn(!0)),t.masterBar.isRepeatEnd&&t.masterBar.repeatCount>2&&this.addPostBeatGlyph(new qc(0,this.getLineHeight(-.25),this.bar.masterBar.repeatCount))}paintBar(t,e,s,i,a){for(let n=0,o=i.beats.length;n<o;n++){const h=i.beats[n];if(!i.hasBeatLineX(h)||h.deadSlapped)continue;const d=h.graceType!==K.None?Me.GraceScale:1,u=i.getBeatLineX(h),f=this.getBeamDirection(i),p=e+this.y+this.getBarLineStart(h,f),g=e+this.y+this.calculateBeamY(i,u);this.paintBeamingStem(h,e+this.y,t+this.x+u,p,g,s);const b=me.beat(s,a,h);try{let w=g;f===P.Down?w+=2*s.font.size:0!==n&&(w-=1.5*s.font.size);const S=6*d;let D=(qe.BeamSpacing+qe.BeamThickness)*d,N=qe.BeamThickness*d;const L=O.getIndex(h.duration)-2,$=e+this.y;f===P.Down&&(D=-D,N=-N);for(let E=0;E<L;E++){let B=0,ie=0,Re=0,Ne=0;const ee=$+E*D;if(n<i.beats.length-1){const Ve=ks.isFullBarJoin(h,i.beats[n+1],E);if(E===L-1&&Ve&&h.beamingMode===ze.ForceSplitOnSecondaryToNext)B=u,ie=B+S,Re=ee+this.calculateBeamY(i,B),Ne=ee+this.calculateBeamY(i,ie),Ms.paintSingleBar(s,t+this.x+B,Re,t+this.x+ie,Ne,N),ie=i.getBeatLineX(i.beats[n+1]),B=ie-S,Re=ee+this.calculateBeamY(i,B),Ne=ee+this.calculateBeamY(i,ie),Ms.paintSingleBar(s,t+this.x+B,Re,t+this.x+ie,Ne,N);else{if(Ve)B=u,ie=i.getBeatLineX(i.beats[n+1]);else{if(0!==n&&ks.isFullBarJoin(i.beats[n-1],h,E))continue;B=u,ie=B+S}Re=ee+this.calculateBeamY(i,B),Ne=ee+this.calculateBeamY(i,ie),Ms.paintSingleBar(s,t+this.x+B,Re,t+this.x+ie,Ne,N)}}else n>0&&!ks.isFullBarJoin(h,i.beats[n-1],E)&&(B=u-S,ie=u,Re=ee+this.calculateBeamY(i,B),Ne=ee+this.calculateBeamY(i,ie),Ms.paintSingleBar(s,t+this.x+B,Re,t+this.x+ie,Ne,N))}}finally{b?.[Symbol.dispose]?.()}}}static paintSingleBar(t,e,s,i,a,n){t.beginPath(),t.moveTo(e,s),t.lineTo(i,a),t.lineTo(i,a+n),t.lineTo(e,s+n),t.closePath(),t.fill()}}class $c extends _i{paint(t,e,s){const i=me.bar(s,Be.StandardNotationKeySignature,this.renderer.bar);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}let Bn=(()=>{class r extends Ms{constructor(e,s){super(e,s),this.simpleWhammyOverflow=0,this.beatEffectsMinY=null,this.beatEffectsMaxY=null,this.accidentalHelper=new gs(this)}get repeatsBarSubElement(){return Be.StandardNotationRepeats}get barNumberBarSubElement(){return Be.StandardNotationBarNumber}get barLineBarSubElement(){return Be.StandardNotationBarLines}get staffLineBarSubElement(){return Be.StandardNotationStaffLine}get showMultiBarRest(){return!0}get lineSpacing(){return qe.RawLineSpacing}get heightLineCount(){return 5}get drawnLineCount(){return this.bar.staff.standardNotationLineCount}registerBeatEffectOverflows(e,s){const i=this.beatEffectsMinY;(null==i||e<i)&&(this.beatEffectsMinY=e);const a=this.beatEffectsMaxY;(null==a||s>a)&&(this.beatEffectsMaxY=s)}getScoreY(e){return super.getLineY(e/2)}getScoreHeight(e){return super.getLineHeight(e/2)}doLayout(){if(super.doLayout(),!this.bar.isEmpty&&this.accidentalHelper.maxLineBeat){const e=this.getScoreY(-2),s=this.getScoreY(10),i=this.simpleWhammyOverflow,a=this.beatEffectsMinY;if(null!==a){const u=e-a;u>0&&this.registerOverflowTop(u)}const n=this.beatEffectsMaxY;if(null!==n){const u=n-s;u>0&&this.registerOverflowBottom(u)}this.registerOverflowTop(i);let o=this.getScoreY(this.accidentalHelper.maxLine);const h=this.helpers.getBeamingHelperForBeat(this.accidentalHelper.maxLineBeat);h.direction===P.Up&&(o-=this.getStemSize(h),h.hasTuplet&&(o-=this.tupletSize)),o<e&&this.registerOverflowTop(Math.abs(o)+i);let c=this.getScoreY(this.accidentalHelper.minLine);const d=this.helpers.getBeamingHelperForBeat(this.accidentalHelper.minLineBeat);d.direction===P.Down&&(c+=this.getStemSize(d),d.hasTuplet&&(c+=this.tupletSize)),c>s&&this.registerOverflowBottom(Math.abs(c)-s)}}paint(e,s,i){super.paint(e,s,i),this.paintBeams(e,s,i,Ae.StandardNotationFlags,Ae.StandardNotationBeams),this.paintTuplets(e,s,i,Ae.StandardNotationTuplet)}getSlashFlagY(e,s){let i=(this.heightLineCount-1)/2,a=0;switch(e){case m.QuadrupleWhole:case m.DoubleWhole:case m.Whole:a+=2;break;default:a+=1}return s===P.Down?i+=a:i-=a,this.getLineY(i)}getFlagTopY(e,s){return e.slashed?this.getSlashFlagY(e.duration,s):this.getScoreY(this.accidentalHelper.getMinLine(e))}getFlagBottomY(e,s){return e.slashed?this.getSlashFlagY(e.duration,s):this.getScoreY(this.accidentalHelper.getMaxLine(e))}getBeamDirection(e){return e.direction}getStemSize(e,s=!1){let i=1===e.beats.length?this.getFlagStemSize(e.shortestDuration,s):this.getBarStemSize(e.shortestDuration);return e.isGrace&&(i*=Me.GraceScale),i}getBarStemSize(e){let s=0;switch(e){case m.QuadrupleWhole:case m.Half:case m.Quarter:case m.Eighth:case m.Sixteenth:s=6;break;case m.ThirtySecond:s=8;break;case m.SixtyFourth:case m.OneHundredTwentyEighth:s=9;break;case m.TwoHundredFiftySixth:s=10;break;default:s=0}return this.getScoreHeight(s)}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}getNoteY(e,s){if(e.beat.slashed)return this.getLineY((this.heightLineCount-1)/2);let i=super.getNoteY(e,s);if(Number.isNaN(i)){const a=gs.computeLineWithoutAccidentals(this.bar,e);i=this.getScoreY(a)}return i}applyLayoutingInfo(){const e=super.applyLayoutingInfo();if(e&&this.bar.isMultiVoice){const s=this.getScoreY(-2),i=this.getScoreY(10),a=this.helpers.collisionHelper.getBeatMinMaxY();a[0]<s&&this.registerOverflowTop(Math.abs(a[0])),a[1]>i&&this.registerOverflowBottom(Math.abs(a[1])-i)}return e}calculateBeamYWithDirection(e,s,i){const a=this.getStemSize(e);if(!e.drawingInfos.has(i)){const n=new vl;e.drawingInfos.set(i,n);const o=e.beats[0],h=e.beats[e.beats.length-1],c=e.isRestBeamHelper;n.startBeat=o,n.startX=e.getBeatLineX(o),n.startY=c?this.getScoreY(i===P.Up?e.minRestLine:e.maxRestLine):i===P.Up?this.getFlagTopY(o,i)-a:this.getFlagBottomY(o,i)+a,n.endBeat=h,n.endX=e.getBeatLineX(h),n.endY=c?this.getScoreY(i===P.Up?e.minRestLine:e.maxRestLine):i===P.Up?this.getFlagTopY(h,i)-a:this.getFlagBottomY(h,i)+a;const d=10;if(i===P.Down&&n.startY>n.endY&&n.startY-n.endY>d&&(n.endY=n.startY-d),i===P.Down&&n.endY>n.startY&&n.endY-n.startY>d&&(n.startY=n.endY-d),i===P.Up&&n.startY<n.endY&&n.endY-n.startY>d&&(n.endY=n.startY+d),i===P.Up&&n.endY<n.startY&&n.startY-n.endY>d&&(n.startY=n.endY+d),e.beats.length>1){if(i===P.Up){const u=this.getScoreY(this.accidentalHelper.getMinLine(e.beatOfHighestNote))-a,p=n.calcY(e.getBeatLineX(e.beatOfHighestNote))-u;p>0&&(n.startY-=p,n.endY-=p)}else{const p=this.getScoreY(this.accidentalHelper.getMaxLine(e.beatOfLowestNote))+a-n.calcY(e.getBeatLineX(e.beatOfLowestNote));p>0&&(n.startY+=p,n.endY+=p)}if(null!==e.minRestLine||null!==e.maxRestLine){let p=(O.getIndex(e.shortestDuration)-2)*(qe.BeamSpacing+qe.BeamThickness)*(e.isGrace?Me.GraceScale:1);if(p+=qe.BeamSpacing,i===P.Up&&null!==e.minRestLine){const g=this.getScoreY(e.minRestLine)-p,w=n.calcY(e.getBeatLineX(e.beatOfMinRestLine))-g;w>0&&(n.startY-=w,n.endY-=w)}else if(i===P.Down&&null!==e.maxRestLine){const w=this.getScoreY(e.maxRestLine)+p-n.calcY(e.getBeatLineX(e.beatOfMaxRestLine));w>0&&(n.startY+=w,n.endY+=w)}}if(e.slashBeats.length>0)for(const u of e.slashBeats){const f=n.calcY(e.getBeatLineX(u));let p=this.getSlashFlagY(u.duration,i);i===P.Up?p-=a:i===P.Down&&(p+=a);const g=p-f;g>0&&(n.startY+=g,n.endY+=g)}}}return e.drawingInfos.get(i).calcY(s)}getBarLineStart(e,s){return e.slashed?this.getSlashFlagY(e.duration,s):this.getScoreY(s===P.Up?this.accidentalHelper.getMaxLine(e):this.accidentalHelper.getMinLine(e))}createLinePreBeatGlyphs(){let e=!1;if(this.isFirstOfLine||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let s=0;switch(this.bar.clef){case Se.Neutral:s=this.bar.staff.standardNotationLineCount-1;break;case Se.F4:s=2;break;case Se.C3:s=4;break;case Se.C4:s=2;break;case Se.G2:s=6}this.createStartSpacing(),this.addPreBeatGlyph(new mn(0,this.getScoreY(s)+.5*qe.StaffLineThickness,this.bar.clef,this.bar.clefOttava)),e=!0}(e||0===this.index&&this.bar.keySignature!==ye.C||this.bar.previousBar&&this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this.createKeySignatureGlyphs()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createKeySignatureGlyphs(){let e=0;const s=this.bar.keySignature,i=this.bar.previousBar?this.bar.previousBar.keySignature:0;switch(this.bar.clef){case Se.Neutral:e=0;break;case Se.G2:e=1;break;case Se.F4:e=3;break;case Se.C3:e=2;break;case Se.C4:e=0}const a=new $c;a.renderer=this;const n=new Map,o=[];if(O.keySignatureIsSharp(s))for(let h=0;h<Math.abs(s);h++){const c=r.SharpKsSteps[h]+e;o.push(new As(0,this.getScoreY(c),j.Sharp,1)),n.set(c,!0)}else for(let h=0;h<Math.abs(s);h++){const c=r.FlatKsSteps[h]+e;o.push(new As(0,this.getScoreY(c),j.Flat,1)),n.set(c,!0)}if(this.bar.keySignature===ye.C){const h=Math.abs(i),c=O.keySignatureIsSharp(i)?r.SharpKsSteps:r.FlatKsSteps;for(let d=0;d<h;d++)n.has(c[d]+e)||a.addGlyph(new As(0,this.getScoreY(c[d]+e),j.Natural,1))}for(const h of o)a.addGlyph(h);this.addPreBeatGlyph(a)}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new Nt(0,0,5)),this.addPreBeatGlyph(new Sn(0,this.getScoreY(this.bar.staff.standardNotationLineCount-1),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(e){for(const s of e.beats){const i=new zc(s,this.getVoiceContainer(e));i.preNotes=new Wc,i.onNotes=new Mc,this.addBeatGlyph(i)}}getNoteLine(e){return this.accidentalHelper.getNoteLine(e)}completeBeamingHelper(e){if(this.bar.isMultiVoice&&e.highestNoteInHelper&&e.lowestNoteInHelper){let s=this.getNoteY(e.highestNoteInHelper,Y.Center),i=this.getNoteY(e.lowestNoteInHelper,Y.Center),a=this.getStemSize(e);e.hasTuplet&&(a+=2*this.resources.effectFont.size),e.direction===P.Up?s-=a:i+=a;for(const n of e.beats)this.helpers.collisionHelper.reserveBeatSlot(n,s,i)}}paintBeamingStem(e,s,i,a,n,o){const h=me.beat(o,Ae.StandardNotationStem,e);try{o.lineWidth=qe.StemWidth,o.beginPath(),o.moveTo(i,a),o.lineTo(i,n),o.stroke(),o.lineWidth=1}finally{h?.[Symbol.dispose]?.()}}}return r.StaffId="score",r.SharpKsSteps=[-1,2,-2,1,4,0,3],r.FlatKsSteps=[3,0,4,1,5,2,6],r})();class Qc extends pr{get staffId(){return Bn.StaffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(t,e){return new Bn(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showStandardNotation}}class Kc extends $e{constructor(t,e,s,i){super(0,0),this._inType=t,this._outType=e,this._startNote=s,this._parent=i}doLayout(){this.width=0}paint(t,e,s){this.paintSlideIn(t,e,s),this.paintSlideOut(t,e,s)}paintSlideIn(t,e,s){const i=this.renderer;let o=0,h=0,c=0,d=0;switch(this._inType){case ut.IntoFromBelow:c=t+i.x+i.getNoteX(this._startNote,We.Left)-2,d=e+i.y+i.getNoteY(this._startNote,Y.Center),o=c-12,h=e+i.y+i.getNoteY(this._startNote,Y.Center)+3;break;case ut.IntoFromAbove:c=t+i.x+i.getNoteX(this._startNote,We.Left)-2,d=e+i.y+i.getNoteY(this._startNote,Y.Center),o=c-12,h=e+i.y+i.getNoteY(this._startNote,Y.Center)-3;break;default:return}this.paintSlideLine(s,!1,o,c,h,d)}paintSlideOut(t,e,s){const i=this.renderer;let o=0,h=0,c=0,d=0,u=!1;switch(this._outType){case ce.Shift:case ce.Legato:if(o=t+i.x+i.getBeatX(this._startNote.beat,be.PostNotes)+2,h=e+i.y+i.getNoteY(this._startNote,Y.Center),this._startNote.slideTarget){const p=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar);p&&p.staff===i.staff?(c=t+p.x+p.getBeatX(this._startNote.slideTarget.beat,be.OnNotes)-2,d=e+p.y+p.getNoteY(this._startNote.slideTarget,Y.Center)):(c=t+i.x+i.width,d=h),this._startNote.slideTarget.fret>this._startNote.fret?(h+=3,d-=3):(h-=3,d+=3)}else c=t+i.x+this._parent.x,d=h;break;case ce.OutUp:o=t+i.x+i.getNoteX(this._startNote,We.Right)+2,h=e+i.y+i.getNoteY(this._startNote,Y.Center),c=o+12,d=e+i.y+i.getNoteY(this._startNote,Y.Center)-3;break;case ce.OutDown:o=t+i.x+i.getNoteX(this._startNote,We.Right)+2,h=e+i.y+i.getNoteY(this._startNote,Y.Center),c=o+12,d=e+i.y+i.getNoteY(this._startNote,Y.Center)+3;break;case ce.PickSlideDown:o=t+i.x+i.getNoteX(this._startNote,We.Right)+4,h=e+i.y+i.getNoteY(this._startNote,Y.Center),c=t+i.x+i.width,d=h+9,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(c=t+i.x+i.getBeatX(this._startNote.beat.nextBeat,be.PreNotes)),u=!0;break;case ce.PickSlideUp:o=t+i.x+i.getNoteX(this._startNote,We.Right)+4,h=e+i.y+i.getNoteY(this._startNote,Y.Center),c=t+i.x+i.width,d=h-9,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(c=t+i.x+i.getBeatX(this._startNote.beat.nextBeat,be.PreNotes)),u=!0;break;default:return}this.paintSlideLine(s,u,o,c,h,d)}paintSlideLine(t,e,s,i,a,n){if(e){const o=new oi(0,0,ke.Slight,1.2);o.renderer=this.renderer,o.doLayout();const h=i-s,c=(n-=o.height/2)-(a-=o.height/2),d=Math.sqrt(Math.pow(c,2)+Math.pow(h,2));o.width=h;const u=Math.asin(c/d)*(180/Math.PI);t.beginRotate(s,a,u),o.paint(0,0,t),t.endRotate()}else t.beginPath(),t.moveTo(s,a),t.lineTo(i,n),t.stroke()}}class Js extends hs{constructor(t,e,s=!1){super(t.beat,e.beat,s),this.startNote=t,this.endNote=e}getTieHeight(t,e,s,i){return this.startNote===this.endNote?15:super.getTieHeight(t,e,s,i)}getBeamDirection(t,e){return this.startNote===this.endNote?P.Up:Js.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(t){return t.string>3?P.Up:P.Down}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,this.startNote===this.endNote?Y.Center:this.tieDirection===P.Up?Y.Top:Y.Bottom)}getEndY(){return this.getStartY()}getStartX(){return this.startNote===this.endNote?this.getEndX()-20:this.startNoteRenderer.getNoteX(this.startNote,We.Center)}getEndX(){return this.endNoteRenderer.getNoteX(this.endNote,this.startNote===this.endNote?We.Left:We.Center)}}class Qo extends Js{constructor(t,e,s,i=!1){super(t,e,i),this._direction=Js.getBeamDirectionForNote(t),this._forSlide=s}getTieHeight(t,e,s,i){return Math.log(s-t+1)*this.renderer.settings.notation.slurHeight}tryExpand(t,e,s,i){if(this._forSlide!==s||this.forEnd!==i||this.startNote.beat.id!==t.beat.id||this.endNote.beat.id!==e.beat.id||this._direction!==Js.getBeamDirectionForNote(t))return!1;switch(this._direction){case P.Up:t.realValue>this.startNote.realValue&&(this.startNote=t,this.startBeat=t.beat),e.realValue>this.endNote.realValue&&(this.endNote=e,this.endBeat=e.beat);break;case P.Down:t.realValue<this.startNote.realValue&&(this.startNote=t,this.startBeat=t.beat),e.realValue<this.endNote.realValue&&(this.endNote=e,this.endBeat=e.beat)}return!0}paint(t,e,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),a=this.getBeamDirection(this.startBeat,i),n=`tab.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${a}`,o=this.renderer;o.staff.getSharedLayoutData(n,!1)||(o.staff.setSharedLayoutData(n,!0),super.paint(t,e,s))}}class Zc extends bs{constructor(){super(...arguments),this._bend=null,this._effectSlurs=[]}drawBeamHelperAsFlags(t){return t.hasFlag(this.renderer.drawBeamHelperAsFlags(t),this.beat)}doLayout(){this._effectSlurs=[],super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(t){if(!t.isVisible)return;const e=this.renderer;if(t.isTieOrigin&&e.showTiedNotes&&t.tieDestination.isVisible){const s=new Js(t,t.tieDestination,!1);this.addTie(s)}if(t.isTieDestination&&e.showTiedNotes){const s=new Js(t.tieOrigin,t,!0);this.addTie(s)}if(t.isLeftHandTapped&&!t.isHammerPullDestination){const s=new Js(t,t,!1);this.addTie(s)}if(t.isEffectSlurOrigin&&t.effectSlurDestination){let s=!1;for(const i of this._effectSlurs)if(i.tryExpand(t,t.effectSlurDestination,!1,!1)){s=!0;break}if(!s){const i=new Qo(t,t.effectSlurDestination,!1,!1);this._effectSlurs.push(i),this.addTie(i)}}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let s=!1;for(const i of this._effectSlurs)if(i.tryExpand(t.effectSlurOrigin,t,!1,!0)){s=!0;break}if(!s){const i=new Qo(t.effectSlurOrigin,t,!1,!0);this._effectSlurs.push(i),this.addTie(i)}}if(t.slideInType!==ut.None||t.slideOutType!==ce.None){const s=new Kc(t.slideInType,t.slideOutType,t,this);this.addTie(s)}if(t.hasBend){if(!this._bend){const s=new Go;this._bend=s,s.renderer=this.renderer,this.addTie(s)}this._bend.addBends(t)}}}class jc extends $e{constructor(t,e,s){super(t,e),this._noteString=null,this._trillNoteString=null,this._trillNoteStringWidth=0,this.isEmpty=!1,this.noteStringWidth=0,this._note=s}doLayout(){const t=this._note;let e=t.fret-t.beat.voice.bar.staff.transpositionPitch;if(t.harmonicType===Z.Natural&&0!==t.harmonicValue&&(e=t.harmonicValue-t.beat.voice.bar.staff.transpositionPitch),t.isTieDestination)this._noteString=0===t.beat.index&&this.renderer.settings.notation.notationMode===_t.GuitarPro||(t.bendType===z.Bend||t.bendType===z.BendRelease)&&this.renderer.settings.notation.isNotationElementVisible(fe.TabNotesOnTiedBends)?`(${(t.tieOrigin.fret-t.beat.voice.bar.staff.transpositionPitch).toString()})`:"";else if(this._noteString=t.isDead?"x":e.toString(),t.isGhost)this._noteString=`(${this._noteString})`;else if(t.harmonicType===Z.Natural){const s=this._noteString.indexOf(".");s>=0&&(this._noteString=this._noteString.substr(0,s+2)),this._noteString=`<${this._noteString}>`}if(t.isTrill)this._trillNoteString=`(${(t.trillFret-t.beat.voice.bar.staff.transpositionPitch).toString()})`;else if(O.isAlmostEqualTo(t.harmonicValue,0))this._trillNoteString="";else switch(t.harmonicType){case Z.Artificial:case Z.Pinch:case Z.Tap:case Z.Semi:case Z.Feedback:let s=(e+t.harmonicValue).toString();const i=s.indexOf(".");i>=0&&(s=s.substr(0,i+2)),this._trillNoteString=`<${s}>`;break;default:this._trillNoteString=""}this.isEmpty=!this._noteString,this.isEmpty||(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont,this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this._noteString).width,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,this._trillNoteString&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this._trillNoteStringWidth=3+this.renderer.scoreRenderer.canvas.measureText(this._trillNoteString).width,this.width+=this._trillNoteStringWidth))}paint(t,e,s){if(this.isEmpty)return;const a=t+this.x+(this.width-(this.noteStringWidth+this._trillNoteStringWidth))/2;this.paintTrill(a,e,s);const n=me.note(s,Et.GuitarTabFretNumber,this._note);try{s.fillText(this._noteString,a,e+this.y)}finally{n?.[Symbol.dispose]?.()}}paintTrill(t,e,s){const i=me.note(s,Et.GuitarTabFretNumber,this._note);try{const a=this.renderer.scoreRenderer.canvas.font;this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,s.fillText(this._trillNoteString,t+this.noteStringWidth+3,e+this.y),this.renderer.scoreRenderer.canvas.font=a}finally{i?.[Symbol.dispose]?.()}}buildBoundingsLookup(t,e,s){const i=new Oi;i.note=this._note,i.noteHeadBounds=new St,i.noteHeadBounds.x=e+this.x,i.noteHeadBounds.y=s+this.y-this.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}class ed extends $e{constructor(t,e,s){super(t,e),this._notes=[],this._deadSlapped=null,this.minStringNote=null,this.beatEffects=new Map,this.notesPerString=new Map,this.noteStringWidth=0,this._isGrace=s}buildBoundingsLookup(t,e,s){for(const i of this._notes)i.buildBoundingsLookup(t,e+this.x,s+this.y)}getNoteX(t,e){if(this.notesPerString.has(t.string)){const s=this.notesPerString.get(t.string);let i=this.x+s.x;switch(e){case We.Left:break;case We.Center:i+=s.noteStringWidth/2;break;case We.Right:i+=s.width}return i}return 0}getNoteY(t,e){if(this.notesPerString.has(t.string)){const s=this.notesPerString.get(t.string);let i=this.y+s.y;switch(e){case Y.Top:case Y.TopWithStem:i-=s.height/2+2;break;case Y.Center:break;case Y.Bottom:case Y.BottomWithStem:i+=s.height/2}return i}return 0}doLayout(){let t=0;if(this.beat.deadSlapped)this._deadSlapped=new ma,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),t=this._deadSlapped.width,this.noteStringWidth=t;else{let e=0;for(let n=0,o=this._notes.length;n<o;n++){const h=this._notes[n];h.renderer=this.renderer,h.doLayout(),h.width>t&&(t=h.width),h.noteStringWidth>e&&(e=h.noteStringWidth)}this.noteStringWidth=e;const s=this.renderer.resources.tablatureFont.size;let i=this.getNoteY(this.minStringNote,Y.Center)+s/2;const a=7;for(const n of this.beatEffects.values())n.y+=i,n.x+=this.width/2,n.renderer=this.renderer,i+=a,n.doLayout()}this.width=t}addNoteGlyph(t,e){this._notes.push(t),this.notesPerString.set(e.string,t),(!this.minStringNote||e.string<this.minStringNote.string)&&(this.minStringNote=e)}paint(t,e,s){if(t+=this.x,e+=this.y,this.beat.deadSlapped)this._deadSlapped?.paint(t,e,s);else{const i=this.renderer.resources,a=s.textBaseline;s.textBaseline=re.Middle,s.font=this._isGrace?i.graceFont:i.tablatureFont;const n=this._notes,o=this.width;for(const c of n)c.renderer=this.renderer,c.width=o,c.paint(t,e,s);s.textBaseline=a;const h=me.beat(s,Ae.GuitarTabEffects,this.beat);try{for(const c of this.beatEffects.values())c.paint(t,e,s)}finally{h?.[Symbol.dispose]?.()}}}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,t+this.x+this.width/2,t+this.x+this.width/2)}}class td extends lt{constructor(t,e,s,i){super(t,e,1,br.getSymbol(i)),this._isVisibleRest=s}doLayout(){super.doLayout(),this._isVisibleRest||(this.width=10)}updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,t+this.x+this.width/2,t+this.x+this.width/2)}paint(t,e,s){if(this._isVisibleRest){const i=me.beat(s,Ae.GuitarTabRests,this.beat);try{super.paint(t,e,s)}finally{i?.[Symbol.dispose]?.()}}}}class sd extends ai{constructor(){super(...arguments),this.slash=null,this.noteNumbers=null,this.restGlyph=null}get effectElement(){return Ae.GuitarTabEffects}getNoteX(t,e){return this.noteNumbers?this.noteNumbers.getNoteX(t,e):0}getNoteY(t,e){return this.noteNumbers?this.noteNumbers.getNoteY(t,e):0}buildBoundingsLookup(t,e,s){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(t,e+this.x,s+this.y)}doLayout(){const t=this.renderer;if(this.container.beat.isRest){const s=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),i=t.getTabY(s),a=new td(0,i,t.showRests,this.container.beat.duration);if(this.restGlyph=a,a.beat=this.container.beat,a.beamingHelper=this.beamingHelper,this.addNormal(a),this.container.beat.dots>0&&t.showRests){this.addNormal(new Nt(0,0,5));for(let n=0;n<this.container.beat.dots;n++)this.addEffect(new yr(0,i,1.5))}}else{const s=this.renderer.settings.notation.smallGraceTabNotes&&this.container.beat.graceType!==K.None;let i;if(this.container.beat.slashed&&!this.container.beat.notes.some(a=>a.isTieDestination)){const a=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),n=t.getLineY(a),o=new Sr(0,n,this.container.beat.duration,s,this.container.beat);o.noteHeadElement=Et.GuitarTabFretNumber,o.effectElement=Ae.GuitarTabEffects,this.slash=o,o.beat=this.container.beat,o.beamingHelper=this.beamingHelper,this.addNormal(o),i=o.beatEffects}else{const a=new ed(0,0,s);this.noteNumbers=a,a.beat=this.container.beat,a.beamingHelper=this.beamingHelper;for(const n of this.container.beat.notes)n.isVisible&&this.createNoteGlyph(n);this.addNormal(a),i=a.beatEffects}if(this.container.beat.hasWhammyBar){const a=new zo(this.container.beat);a.renderer=this.renderer,a.doLayout(),this.container.ties.push(a)}if(this.container.beat.isTremolo&&!i.has("tremolo")){let a=0;const n=this.container.beat.tremoloSpeed;let o=5;switch(n){case m.ThirtySecond:a=10;break;case m.Sixteenth:a=5;break;case m.Eighth:a=0}this.container.beat.duration<m.Half&&(o=0),i.set("tremolo",new ga(o,a,n))}if(this.container.beat.dots>0&&t.rhythmMode!==ps.Hidden){this.addNormal(new Nt(0,0,5));for(let a=0;a<this.container.beat.dots;a++)this.addEffect(new yr(0,t.lineOffset*t.bar.staff.tuning.length+t.settings.notation.rhythmHeight,1.5))}}if(this.isEmpty)return;let e=0;for(let s=0,i=this.glyphs.length;s<i;s++){const a=this.glyphs[s];a.x=e,a.renderer=this.renderer,a.doLayout(),e+=a.width}this.width=e,this.computedWidth=e,this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteNumbers?this.centerX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2:this.slash&&(this.centerX=this.slash.x+this.slash.width/2)}updateBeamingHelper(){this.noteNumbers?this.noteNumbers.updateBeamingHelper(this.container.x+this.x):this.restGlyph?this.restGlyph.updateBeamingHelper(this.container.x+this.x):this.slash&&this.slash.updateBeamingHelper(this.container.x+this.x)}createNoteGlyph(t){const e=this.renderer,s=new jc(0,0,t);s.y=e.getTabY(t.beat.voice.bar.staff.tuning.length-t.string),s.renderer=this.renderer,s.doLayout(),this.noteNumbers.addNoteGlyph(s,t);const a=s.y-s.height/2;this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,a,a+s.height)}}class id extends $e{constructor(t){super(0,0),this._beat=t}doLayout(){this.width=10}paint(t,e,s){const i=this.renderer,a=e+this.x+i.getNoteY(this._beat.maxStringNote,Y.Top),n=e+this.y+i.getNoteY(this._beat.minStringNote,Y.Bottom),o=t+this.x+this.width/2|0;if(this._beat.brushType!==V.None){if(this._beat.brushType===V.BrushUp||this._beat.brushType===V.BrushDown)s.beginPath(),s.moveTo(o,a),s.lineTo(o,n),s.stroke();else if(this._beat.brushType===V.ArpeggioUp){const c=new oi(0,0,ke.Slight,1.2,!0);c.renderer=this.renderer,c.doLayout();const u=n-8;c.width=Math.abs(u-a),s.beginRotate(t+this.x+4,u,-90),c.paint(0,-c.height/2,s),s.endRotate()}else if(this._beat.brushType===V.ArpeggioDown){const c=new oi(0,0,ke.Slight,1.2,!0);c.renderer=this.renderer,c.doLayout();const d=a+8;c.width=Math.abs(n-d),s.beginRotate(t+this.x+4,d,90),c.paint(0,-c.height/2,s),s.endRotate()}this._beat.brushType===V.BrushUp||this._beat.brushType===V.ArpeggioUp?(s.beginPath(),s.moveTo(o,n),s.lineTo(o+4,n-8),s.lineTo(o-4,n-8),s.closePath(),s.fill()):(s.beginPath(),s.moveTo(o,a),s.lineTo(o+4,a+8),s.lineTo(o-4,a+8),s.closePath(),s.fill())}}}class rd extends ri{doLayout(){this.container.beat.brushType!==V.None&&!this.container.beat.isRest&&(this.addEffect(new id(this.container.beat)),this.addNormal(new Nt(0,0,4))),super.doLayout()}get effectElement(){return Ae.GuitarTabEffects}}class ad extends $e{doLayout(){this.width=Ce.Widths.get(l.SixStringTabClef)}paint(t,e,s){const i=me.bar(s,Be.GuitarTabsClef,this.renderer.bar);try{const a=this.renderer.bar.staff.tuning.length;s.fillMusicFontSymbol(t+this.x+5,e+this.y,a<=4?a/4.5:a/6.5,a<=4?l.FourStringTabClef:l.SixStringTabClef,!1)}finally{i?.[Symbol.dispose]?.()}}}class nd extends Xo{doLayout(){this.barSubElement=Be.GuitarTabsTimeSignature,super.doLayout()}get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?Me.GraceScale:1}}let _n=(()=>{class r extends Ms{get showMultiBarRest(){return this._showMultiBarRest}get repeatsBarSubElement(){return Be.GuitarTabsRepeats}get barNumberBarSubElement(){return Be.GuitarTabsBarNumber}get barLineBarSubElement(){return Be.GuitarTabsBarLines}get staffLineBarSubElement(){return Be.GuitarTabsStaffLine}constructor(e,s){super(e,s),this._hasTuplets=!1,this.showTimeSignature=!1,this.showRests=!1,this.showTiedNotes=!1,this._showMultiBarRest=!1,s.staff.showStandardNotation||(this.showTimeSignature=!0,this.showRests=!0,this.showTiedNotes=!0,this._showMultiBarRest=!0)}get lineSpacing(){return r.TabLineSpacing}get heightLineCount(){return this.bar.staff.tuning.length}get drawnLineCount(){return this.bar.staff.tuning.length}get rhythmMode(){let e=this.settings.notation.rhythmMode;return e===ps.Automatic&&(e=this.bar.staff.showStandardNotation?ps.Hidden:ps.ShowWithBars),e}getTabY(e){return super.getLineY(e)}getTabHeight(e){return super.getLineHeight(e)}collectSpaces(e){for(const i of this.bar.voices)if(this.hasVoiceContainer(i)){const a=this.getVoiceContainer(i);for(const n of a.beatGlyphs){const o=n.onNotes,h=o.noteNumbers;if(h)for(const[c,d]of h.notesPerString)d.isEmpty||e[this.bar.staff.tuning.length-c].push(new Float32Array([a.x+n.x+o.x+h.x,h.width+1]))}}}adjustSizes(){this.rhythmMode!==ps.Hidden&&(this.height+=this.settings.notation.rhythmHeight,this.bottomPadding+=this.settings.notation.rhythmHeight)}doLayout(){if(super.doLayout(),this.rhythmMode!==ps.Hidden){this._hasTuplets=!1;for(const e of this.bar.voices)if(this.hasVoiceContainer(e)&&this.getVoiceContainer(e).tupletGroups.length>0){this._hasTuplets=!0;break}this._hasTuplets&&this.registerOverflowBottom(this.tupletSize)}}createLinePreBeatGlyphs(){this.isFirstOfLine&&this.addPreBeatGlyph(new ad(5,this.getTabY((this.bar.staff.tuning.length-1)/2))),this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new Nt(0,0,5)),this.addPreBeatGlyph(new nd(0,this.getTabY((this.bar.staff.tuning.length+1)/2-1),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(e){if(this.additionalMultiRestBars){const s=new ua(this.getVoiceContainer(e));this.addBeatGlyph(s)}else for(const s of e.beats){const i=new Zc(s,this.getVoiceContainer(e));i.preNotes=new rd,i.onNotes=new sd,this.addBeatGlyph(i)}}paint(e,s,i){super.paint(e,s,i),this.rhythmMode!==ps.Hidden&&(this.paintBeams(e,s,i,Ae.GuitarTabFlags,Ae.GuitarTabBeams),this.paintTuplets(e,s,i,Ae.GuitarTabTuplet))}drawBeamHelperAsFlags(e){return super.drawBeamHelperAsFlags(e)||this.rhythmMode===ps.ShowWithBeams}getFlagTopY(e,s){const i=this.getOnNotesGlyphForBeat(e);return i.noteNumbers&&e.duration!==m.Half?i.noteNumbers.getNoteY(i.noteNumbers.minStringNote,Y.Bottom):this.height-this.settings.notation.rhythmHeight-this.tupletSize}getFlagBottomY(e,s){return this.getFlagAndBarPos()}getFlagStemSize(e,s=!1){return 0}getBarLineStart(e,s){const i=this.getOnNotesGlyphForBeat(e);return i.noteNumbers&&e.duration!==m.Half?i.noteNumbers.getNoteY(i.noteNumbers.minStringNote,Y.Bottom)+this.lineOffset/2:this.height-this.settings.notation.rhythmHeight-this.tupletSize}getBeamDirection(e){return P.Down}getFlagAndBarPos(){return this.height-(this._hasTuplets?this.tupletSize/2:0)}calculateBeamYWithDirection(e,s,i){return this.getFlagAndBarPos()}shouldPaintFlag(e,s){return!(!super.shouldPaintFlag(e,s)||e.graceType!==K.None)&&this.drawBeamHelperAsFlags(s)}paintBeamingStem(e,s,i,a,n,o){if(n<a){const c=n;n=a,a=c}const h=me.beat(o,Ae.GuitarTabStem,e);try{o.lineWidth=qe.StemWidth,o.beginPath();let c=[];this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(e.displayStart)&&(c=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(e.displayStart).slots.slice(),c.sort((u,f)=>u.topY-f.topY));let d=n;for(;d>a;){o.moveTo(i,d);let u=a;if(!(c.length>0&&c[c.length-1].bottomY>u)){o.lineTo(i,u);break}{const f=c.pop();u=s+f.bottomY,o.lineTo(i,u),d=s+f.topY}}o.stroke(),o.lineWidth=1}finally{h?.[Symbol.dispose]?.()}}}return r.StaffId="tab",r.TabLineSpacing=10,r})();class Tn extends pr{get staffId(){return _n.StaffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.notationStaffPaddingBottom}constructor(){super(),this.showTimeSignature=null,this.showRests=null,this.showTiedNotes=null,this.hideOnPercussionTrack=!0}canCreate(t,e){return e.showTablature&&e.tuning.length>0&&super.canCreate(t,e)}create(t,e){const s=new _n(t,e);return null!==this.showRests&&(s.showRests=this.showRests),null!==this.showTimeSignature&&(s.showTimeSignature=this.showTimeSignature),null!==this.showTiedNotes&&(s.showTiedNotes=this.showTiedNotes),s}}let od=(()=>{class r extends Kt{constructor(){super(0,0)}doLayout(){super.doLayout(),this.height=this.renderer.resources.effectFont.size+r.Padding}paint(e,s,i){i.font=this.renderer.resources.effectFont;const n=i.textAlign;i.textAlign=U.Center,i.fillText("T",e+this.x,s+this.y+i.font.size/2),i.textAlign=n,i.strokeCircle(e+this.x,s+this.y+i.font.size/2+(r.Padding-1),i.font.size/1.6)}}return r.Padding=4,r})();class Ko extends xi{get notationElement(){return fe.EffectTap}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyphForNote(t){return t.isLeftHandTapped}createNewGlyph(t,e){return new od}}class qs{constructor(){this.noteRange=1,this.x=0,this.y=0}}var Gi=function(r){return r[r.None=0]="None",r[r.Rectangle=1]="Rectangle",r[r.Ellipse=2]="Ellipse",r[r.Circle=3]="Circle",r}(Gi||{});class xn extends qs{constructor(){super(...arguments),this.align=U.Left,this.frame=Gi.None,this.text="",this.fontFace="",this.weight=0,this.height=0}}class Zo extends qs{constructor(){super(...arguments),this.chord=new Os}}class jo extends qs{}class eh extends qs{}class hd extends qs{constructor(){super(...arguments),this.number=0}}class th extends qs{constructor(){super(...arguments),this.decrescendo=!1}}class Nn extends qs{constructor(){super(...arguments),this.allNumbers=!1,this.firstNumber=0,this.lastNumber=0}}class ld extends qs{constructor(){super(...arguments),this.octave=1}}class cd extends qs{}class dd{constructor(){this.defaultClef=Se.G2,this.description="",this.percussion=!1,this.instrument=0,this.volume=0,this.transpose=0,this.index=0}}class ud{constructor(){this.from=0,this.to=0,this.curly=!1}}class fd{constructor(){this.currentBarIndex=-1,this.currentBarComplete=!0,this.currentBarDuration=0,this.currentPosition=0,this.voiceStemDir=null,this.repeatCount=0,this.repeatEnd=null}}class ba{constructor(){this._trackChannel=0,this._beamingMode=ze.Auto,this._isFirstSystem=!0,this._staffLookup=new Map,this._brackets=[],this._staffLayoutLookup=new Map,this._staffLayouts=[],this._timeSignature=new Ps,this._voiceStates=new Map}parseXml(t,e){this._galleryObjects=new Map,this._tieStarts=[],this._tieStartIds=new Map,this._voiceCounts=new Map,this._slurs=new Map,this._crescendo=new Map,this._isFirstSystem=!0;const s=new Ki;try{s.parse(t)}catch(i){throw new st("Could not parse XML",i)}this.parseDom(s),this.consolidate(),this.score.finish(e)}consolidate(){O.consolidate(this.score),ba.applyEffectRange(this._slurs,(t,e)=>{e.isLegatoOrigin=!0}),ba.applyEffectRange(this._crescendo,(t,e)=>{e.crescendo=t.decrescendo?Ft.Decrescendo:Ft.Crescendo})}static applyEffectRange(t,e){for(const[s,i]of t){const a=i.noteRange;let n=s;for(let o=0;o<a;o++)if(e(i,n),n.index+1<n.voice.beats.length)n=n.voice.beats[n.index+1];else{if(!(n.voice.bar.index+1<n.voice.bar.staff.bars.length))break;n=n.voice.bar.staff.bars[n.voice.bar.index+1].voices[n.voice.index].beats[0]}}}parseDom(t){const e=t.firstElement;if(!e)throw new st("No valid XML");if("score"!==e.localName)throw new st('Root node of XML was not "score"');this.score=new Cs,this.score.tempo=120;for(const s of e.childElements())switch(s.localName){case"info":this.parseInfo(s);break;case"layout":this.parseLayout(s);break;case"gallery":this.parseGallery(s);break;case"pageObjects":this.parsePageObjects(s);break;case"systems":this.parseSystems(s)}}parseLayout(t){for(const a of t.childElements())switch(a.localName){case"staves":this.parseLayoutStaves(a);break;case"brackets":this.parseBrackets(a)}const e=this._brackets.filter(a=>!!a.curly);e.sort((a,n)=>a.from-n.from);let s=0,i=null;for(let a=0;a<this._staffLayouts.length;a++){const n=this._staffLayouts[a];for(;s<e.length&&a>e[s].to;)s++;i&&s<e.length&&a>e[s].from&&a<=e[s].to?i.ensureStaveCount(i.staves.length+1):(i=new gi,i.ensureStaveCount(1),i.name=n.description,i.playbackInfo.volume=Math.floor(n.volume/128*16),i.playbackInfo.program=n.instrument,n.percussion?(i.playbackInfo.primaryChannel=9,i.playbackInfo.secondaryChannel=9):(i.playbackInfo.primaryChannel=this._trackChannel++,i.playbackInfo.secondaryChannel=this._trackChannel++),this.score.addTrack(i));const o=i.staves[i.staves.length-1];o.isPercussion=n.percussion,o.transpositionPitch=n.transpose,o.displayTranspositionPitch=0,o.showTablature=!1,this._staffLookup.set(n.index,o)}}parseBrackets(t){for(const e of t.childElements())"bracket"===e.localName&&this.parseBracket(e)}parseBracket(t){const e=new ud;e.from=Number.parseInt(t.getAttribute("from")),e.to=Number.parseInt(t.getAttribute("to")),t.attributes.has("curly")&&(e.curly="true"===t.attributes.get("curly")),this._brackets.push(e)}parseLayoutStaves(t){for(const e of t.childElements())"staffLayout"===e.localName&&this.parseStaffLayout(e)}parseStaffLayout(t){const e=new dd;e.description=t.getAttribute("description");for(const s of t.childElements())switch(s.localName){case"notation":s.attributes.has("defaultClef")&&(e.defaultClef=this.parseClef(s.attributes.get("defaultClef")));break;case"sound":s.attributes.has("percussion")&&(e.percussion="true"===s.attributes.get("percussion")),s.attributes.has("instr")&&(e.instrument=Number.parseInt(s.attributes.get("instr"))),s.attributes.has("volume")&&(e.volume=Number.parseInt(s.attributes.get("volume"))),s.attributes.has("transpose")&&(e.transpose=Number.parseInt(s.attributes.get("transpose")))}this._staffLayoutLookup.set(e.description,e),e.index=this._staffLayouts.length,this._staffLayouts.push(e)}parseClef(t){switch(t){case"treble":return Se.G2;case"bass":return Se.F4;case"alto":case"tenor":return Se.C4}return Se.G2}parseClefOttava(t){return t.endsWith("-")?le._8vb:t.endsWith("+")?le._8va:le.Regular}parseSystems(t){for(const e of t.childElements())"system"===e.localName&&this.parseSystem(e)}parseSystem(t){t.attributes.has("tempo")&&0===this.score.masterBars.length&&(this.score.tempo=Number.parseInt(t.attributes.get("tempo"))),"0"===t.getAttribute("beamGrouping")&&(this._beamingMode=ze.ForceSplitToNext);for(const e of t.childElements())"staves"===e.localName&&this.parseStaves(t,e);this._isFirstSystem=!1}parseStaves(t,e){const s=this.score.masterBars.length;for(const i of e.childElements())"staff"===i.localName&&this.parseStaff(t,s,i)}parseStaff(t,e,s){const i=s.getAttribute("layout");this._currentStaffLayout=this._staffLayoutLookup.get(i),this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!1,this.parseTime(s.getAttribute("defaultTime"));const a=this._staffLookup.get(this._currentStaffLayout.index);for(;a.bars.length<e;)this.addNewBar(a);for(const n of s.childElements())"voices"===n.localName&&this.parseVoices(i,a,t,e,n)}parseTime(t){switch(t){case"allaBreve":case"C":this._timeSignature.timeSignatureNumerator=2,this._timeSignature.timeSignatureDenominator=2,this._timeSignature.timeSignatureCommon=!0;break;case"longAllaBreve":this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!0;break;default:if(t.indexOf("/")>0){const e=t.split("/");this._timeSignature.timeSignatureNumerator=Number.parseInt(e[0]),this._timeSignature.timeSignatureDenominator=Number.parseInt(e[1]),this._timeSignature.timeSignatureCommon=!1}}}parseVoices(t,e,s,i,a){let n=0;for(const o of a.childElements())"voice"===o.localName&&(this.parseVoice(t,e,s,n,i,o),n++)}getOrCreateBar(t,e){return e<t.bars.length?t.bars[e]:this.addNewBar(t)}addNewBar(t){const e=new Ts;if(t.bars.length>0?(e.clef=t.bars[t.bars.length-1].clef,e.clefOttava=t.bars[t.bars.length-1].clefOttava,e.keySignature=t.bars[t.bars.length-1].keySignature,e.keySignatureType=t.bars[t.bars.length-1].keySignatureType):e.clef=this._currentStaffLayout.defaultClef,t.addBar(e),t.bars.length>this.score.masterBars.length){const s=new Ps;this.score.addMasterBar(s),s.index>0&&(s.tripletFeel=s.previousMasterBar.tripletFeel),s.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,s.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,s.timeSignatureCommon=this._timeSignature.timeSignatureCommon}return e}newBar(t,e){this._currentVoiceState.currentBarIndex++,this._currentBar=this.getOrCreateBar(t,this._currentVoiceState.currentBarIndex),this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1),this._currentVoiceState.currentBarComplete=!1,this._currentVoiceState.currentPosition=0,this.ensureVoice(t,e)}parseVoice(t,e,s,i,a,n){const o=`${t}_${i}`;if(this._currentVoiceState&&!this._currentVoiceState.currentBarComplete&&(this._currentBar.masterBar.isAnacrusis=!0),this._voiceStates.has(o)?(this._currentVoiceState=this._voiceStates.get(o),this._currentBar=this.getOrCreateBar(e,this._currentVoiceState.currentBarIndex),this.ensureVoice(e,i)):(this._currentVoiceState=new fd,this._currentVoiceState.currentBarIndex=a-1,this._voiceStates.set(o,this._currentVoiceState),this.newBar(e,i)),n.attributes.has("stemDir"))switch(n.attributes.get("stemDir")){case"up":this._currentVoiceState.voiceStemDir=P.Up;break;case"down":this._currentVoiceState.voiceStemDir=P.Down;break;default:this._currentVoiceState.voiceStemDir=null}else this._currentVoiceState.voiceStemDir=null;const h=n.findChildElement("noteObjects");if(s.attributes.has("tempo")){const c=new Qe;c.isLinear=!0,c.type=Ge.Tempo,c.value=Number.parseInt(s.attributes.get("tempo")),c.ratioPosition=this._currentVoiceState.currentPosition/this._currentVoiceState.currentBarDuration,this._currentBar.masterBar.tempoAutomations.push(c)}if(h)for(const c of h.childElements())switch(this._currentVoiceState.currentBarComplete&&"barline"!==c.localName&&this.newBar(e,i),c.localName){case"clefSign":this._currentBar.clef=this.parseClef(c.getAttribute("clef")),this._currentBar.clefOttava=this.parseClefOttava(c.getAttribute("clef"));break;case"keySign":this._currentBar.keySignature=Number.parseInt(c.getAttribute("fifths"));break;case"timeSign":this.parseTime(c.getAttribute("time")),this._currentBar.masterBar.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,this._currentBar.masterBar.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,this._currentBar.masterBar.timeSignatureCommon=this._timeSignature.timeSignatureCommon,this._currentVoiceState.currentPosition=0,this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1);break;case"barline":switch(c.getAttribute("type")){case"double":this._currentBar.barLineRight=te.LightLight,this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"end":this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0);break;case"repEnd":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this.parseBarDrawObject(c),this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"repBegin":this.newBar(e,i),this._currentBar.masterBar.isRepeatStart=!0,this._currentVoiceState.repeatEnd=null,this._currentVoiceState.repeatCount=0;break;case"repEndBegin":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this.parseBarDrawObject(c),this.newBar(e,i),this._currentBar.masterBar.isRepeatStart=!0;break;default:this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0}break;case"chord":const d=new xt;this.initFromPreviousBeat(d,this._currentVoice),d.beamingMode=this._beamingMode,this._currentVoiceState.voiceStemDir&&(d.preferredBeamDirection=this._currentVoiceState.voiceStemDir),this.parseDuration(this._currentBar,d,c.findChildElement("duration")),d.updateDurations(),this._currentVoiceState.currentPosition+=d.playbackDuration,this._currentVoice.addBeat(d),this.parseChord(d,c),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0);break;case"rest":const u=this.parseRestDurations(this._currentBar,c.findChildElement("duration"));u&&(this.initFromPreviousBeat(u,this._currentVoice),u.updateDurations(),this._currentVoiceState.currentPosition+=u.playbackDuration,this._currentVoice.addBeat(u),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0))}}initFromPreviousBeat(t,e){const s=this.getLastBeat(e);s&&(t.dynamics=s.dynamics)}getLastBeat(t){if(t.beats.length>0)return t.beats[t.beats.length-1];if(t.bar.index>0){const e=t.bar.staff.bars[t.bar.index-1];if(t.index<e.voices.length)return this.getLastBeat(e.voices[t.index])}return null}ensureVoice(t,e){for(;this._currentBar.voices.length<e+1;)this._currentBar.addVoice(new es);(!this._voiceCounts.has(t.track.index)||this._voiceCounts.get(t.track.index)<this._currentBar.voices.length)&&this._voiceCounts.set(t.track.index,this._currentBar.voices.length),this._currentVoice=this._currentBar.voices[e]}parseChord(t,e){const s=new ts;for(const i of e.childElements())switch(i.localName){case"stem":switch(i.getAttribute("dir")){case"up":t.preferredBeamDirection=P.Up;break;case"down":t.preferredBeamDirection=P.Down}break;case"articulation":switch(i.getAttribute("type")){case"staccato":s.isStaccato=!0;break;case"normalAccent":s.accentuated=et.Normal;break;case"strongAccent":s.accentuated=et.Heavy}break;case"lyric":this.parseLyric(t,i);break;case"drawObjects":this.parseBeatDrawObject(t,i);break;case"heads":this.parseHeads(t,s,i);break;case"beam":switch(i.getAttribute("group")){case"force":t.beamingMode=ze.ForceMergeWithNext;break;case"divide":t.beamingMode=ze.ForceSplitToNext}}}parseHeads(t,e,s){for(const i of s.childElements())"head"===i.localName&&this.parseHead(t,e,i)}parseHead(t,e,s){const i=new ts,a=O.parseTuning(s.getAttribute("pitch"));i.octave=a.octave-1,i.tone=a.tone.noteValue,i.isStaccato=e.isStaccato,i.accentuated=e.accentuated,t.addNote(i);for(const n of s.childElements())switch(n.localName){case"alter":n.attributes.has("step")&&(i.tone+=Number.parseInt(n.attributes.get("step")));break;case"tie":n.attributes.has("begin")?this._tieStartIds.has(i.id)||(this._tieStartIds.set(i.id,!0),this._tieStarts.push(i)):n.attributes.has("end")&&this._tieStarts.length>0&&!i.isTieDestination&&(i.isTieDestination=!0,i.tieOrigin=this._tieStarts[0],this._tieStarts.splice(0,1),this._tieStartIds.delete(i.id))}}parseBeatDrawObject(t,e){for(const s of e.childElements())if("drawObj"===s.localName){const i=this.parseDrawObj(s);i&&(i instanceof xn?i.fontFace.startsWith("capella")?"u"===i.text?(t.fermata=new Ei,t.fermata.type=Ct.Medium):"f"===i.text?t.dynamics=J.F:"j"===i.text&&(t.dynamics=J.MF):this._isFirstSystem&&""===this.score.title&&i.align===U.Center&&i.height>16&&i.weight>400?this.score.title=i.text:this._isFirstSystem&&""===this.score.artist&&i.align===U.Center&&i.y<0?this.score.artist=i.text:this._isFirstSystem&&""===this.score.music&&i.align===U.Right&&i.y<0?this.score.music=i.text:i.text.startsWith("by capella")||(t.text=i.text):i instanceof Zo||(i instanceof eh?t.vibrato=ke.Slight:i instanceof th?(t.crescendo=i.decrescendo?Ft.Decrescendo:Ft.Crescendo,i.noteRange++,this._crescendo.set(t,i)):i instanceof jo?this._slurs.set(t,i):i instanceof Nn&&this.applyVolta(i)))}}parseBarDrawObject(t){for(const e of t.childElements())if("drawObj"===e.localName){const s=this.parseDrawObj(e);s&&s instanceof Nn&&this.applyVolta(s)}}applyVolta(t){if(t.lastNumber>0?(this._currentVoiceState.repeatCount=t.lastNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)):t.firstNumber>0&&(this._currentVoiceState.repeatCount=t.firstNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)),t.lastNumber>0&&t.firstNumber>0){let e=0;for(let s=t.firstNumber;s<=t.lastNumber;s++)e|=1<<s-1;this._currentBar.masterBar.alternateEndings=e}else t.lastNumber>0?this._currentBar.masterBar.alternateEndings=1<<t.lastNumber-1:t.firstNumber>0&&(this._currentBar.masterBar.alternateEndings=1<<t.firstNumber-1)}parseLyric(t,e){for(const s of e.childElements())if("verse"===s.localName){t.lyrics||(t.lyrics=[]);let i=s.innerText;"true"===s.getAttribute("hyphen")&&(i+="-"),t.lyrics.push(i)}}parseRestDurations(t,e){const s=e.getAttribute("base");if(-1!==s.indexOf("/")){const a=new xt;return a.beamingMode=this._beamingMode,this.parseDuration(t,a,e),a}if(1===Number.parseInt(s)){const a=new xt;return a.beamingMode=this._beamingMode,a.duration=m.Whole,a}return x.warning("Importer","Multi-Bar rests are not supported"),null}parseDurationValue(t){switch(t){case"2/1":return m.DoubleWhole;case"1/1":return m.Whole;case"1/2":return m.Half;case"1/4":return m.Quarter;case"1/8":return m.Eighth;case"1/16":return m.Sixteenth;case"1/32":return m.ThirtySecond;case"1/64":return m.SixtyFourth;case"1/128":return m.OneHundredTwentyEighth;default:return x.warning("Importer","Unsupported duration"),m.Quarter}}parseDuration(t,e,s){const i=s.getAttribute("base");e.duration=this.parseDurationValue(i),s.attributes.has("dots")&&(e.dots=Number.parseInt(s.attributes.get("dots")));const a=s.findChildElement("tuplet");if(a){e.tupletNumerator=Number.parseInt(a.getAttribute("count"));const n="true"===a.getAttribute("tripartite")?3:1,o="true"===a.getAttribute("prolong")?0:1;let h=0;for(;n*Math.pow(2,h+o)<e.tupletNumerator;)h++;e.tupletDenominator=n*Math.pow(2,h)}}parsePageObjects(t){for(const e of t.childElements())if("drawObj"===e.localName){const s=this.parseDrawObj(e);if(s&&s instanceof xn)switch(s.align){case U.Center:this.score.title?this.score.subTitle||(this.score.subTitle=e.innerText):this.score.title=e.innerText;break;case U.Right:this.score.artist||(this.score.artist=e.innerText)}}}parseGallery(t){for(const e of t.childElements())if("drawObj"===e.localName){const s=this.parseDrawObj(e);s&&this._galleryObjects.set(e.getAttribute("name"),s)}}parseDrawObj(t){let e=null,s=1;for(const i of t.childElements())switch(i.localName){case"text":e=this.parseText(i);break;case"guitar":e=this.parseGuitar(i);break;case"slur":e=this.parseSlur(i);break;case"wavyLine":e=this.parseWavyLine(i);break;case"bracket":e=this.parseTupletBracket(i);break;case"wedge":e=this.parseWedge(i);break;case"volta":e=this.parseVolta(i);break;case"octaveClef":e=this.parseOctaveClef(i);break;case"trill":e=this.parseTrill(i);break;case"basic":i.attributes.has("noteRange")&&(s=Number.parseInt(i.attributes.get("noteRange")))}return e&&(e.noteRange=s),e}parseTrill(t){return new cd}parseOctaveClef(t){const e=new ld;return t.attributes.has("octave")&&(e.octave=Number.parseInt(t.attributes.get("octave"))),e}parseVolta(t){const e=new Nn;return e.allNumbers="true"===t.attributes.get("allNumbers"),t.attributes.has("firstNumber")&&(e.firstNumber=Number.parseInt(t.attributes.get("firstNumber"))),t.attributes.has("lastNumber")&&(e.lastNumber=Number.parseInt(t.attributes.get("lastNumber"))),e}parseWedge(t){const e=new th;return e.decrescendo="true"===t.attributes.get("decrescendo"),e}parseTupletBracket(t){const e=new hd;return t.attributes.has("number")&&(e.number=Number.parseInt(t.attributes.get("number"))),e}parseWavyLine(t){return new eh}parseSlur(t){return new jo}parseGuitar(t){const e=new Zo,s=t.innerText.trim();for(let i=0;i<s.length;i++)"/"===s.charAt(i)?e.chord.strings.push(0):e.chord.strings.push(Number.parseInt(s.charAt(i)));return e}parseText(t){const e=new xn;switch(t.attributes.has("x")&&(e.x=Number.parseFloat(t.attributes.get("x"))),t.attributes.has("x")&&(e.y=Number.parseFloat(t.attributes.get("y"))),t.getAttribute("align")){case"left":e.align=U.Left;break;case"center":e.align=U.Center;break;case"right":e.align=U.Right}switch(t.getAttribute("frame")){case"rectangle":e.frame=Gi.Rectangle;break;case"ellipse":e.frame=Gi.Ellipse;break;case"circle":e.frame=Gi.Circle;break;case"none":e.frame=Gi.None}if(t.firstElement)for(const s of t.childElements())switch(s.localName){case"font":e.fontFace=s.getAttribute("face"),s.attributes.has("weight")&&(e.weight=Number.parseInt(s.attributes.get("weight"))),s.attributes.has("height")&&(e.height=Number.parseInt(s.attributes.get("height")));break;case"content":e.text=s.innerText}else e.text=t.innerText;return e}parseInfo(t){for(const e of t.childElements())switch(e.localName){case"author":this.score.tab=e.firstChild.innerText;break;case"comment":this.score.notices=e.firstChild.innerText}}}class pd extends pi{get name(){return"Capella"}readScore(){x.debug(this.name,"Loading ZIP entries");let e,s=null;if(e=new va(this.data).read(),x.debug(this.name,"Zip entries loaded"),e.length>0)for(const i of e)"score.xml"===i.fileName&&(s=k.toString(i.data,this.settings.importer.encoding));else this.data.reset(),s=k.toString(this.data.readAll(),this.settings.importer.encoding);if(!s)throw new st("No valid capella file");x.debug(this.name,"Start Parsing score.xml");try{const i=new ba;return i.parseXml(s,this.settings),x.debug(this.name,"score.xml parsed"),i.score}catch(i){throw new st("Failed to parse CapXML",i)}}}var md="function"==typeof SuppressedError?SuppressedError:function(r,t,e){var s=new Error(e);return s.name="SuppressedError",s.error=r,s.suppressed=t,s};let Pn=(()=>{class r{static enable(e,s){r.alphaSkia=s,r.initializeMusicFont(r.alphaSkia.AlphaSkiaTypeface.register(e))}static initializeMusicFont(e){r.musicTextStyle=new r.alphaSkia.AlphaSkiaTextStyle([e.familyName],e.weight,e.isItalic)}static registerFont(e,s){const i=r.alphaSkia.AlphaSkiaTypeface.register(e.buffer);return s||(s=de.withFamilyList([i.familyName],12,i.isItalic?Xe.Italic:Xe.Plain,i.weight>400?Ut.Bold:Ut.Regular)),s}get font(){return this._font}set font(e){if(this._font===e)return;this._font=e;const s=this.textStyleKey(e);if(this._textStyles.has(s))this._textStyle=this._textStyles.get(s);else{const i=new r.alphaSkia.AlphaSkiaTextStyle(e.families,e.weight===Ut.Bold?700:400,e.isItalic);this._textStyles.set(s,i),this._textStyle=i}}textStyleKey(e){return[...e.families,e.weight.toString(),e.isItalic?"italic":"upright"].join("_")}constructor(){this._color=new Ee(0,0,0,0),this._lineWidth=0,this._textStyle=null,this._scale=1,this._textStyles=new Map,this._font=new de("Arial",10,Xe.Plain),this.textAlign=U.Left,this.textBaseline=re.Top,this._canvas=new r.alphaSkia.AlphaSkiaCanvas,this.color=new Ee(0,0,0,255)}destroy(){this._canvas[Symbol.dispose]();for(const e of this._textStyles.values())e[Symbol.dispose]()}onRenderFinished(){return null}beginRender(e,s){this._scale=this.settings.display.scale,this._canvas.beginRender(e,s,_.HighDpiFactor)}endRender(){return this._canvas.endRender()}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._canvas.color=r.alphaSkia.AlphaSkiaCanvas.rgbaToColor(e.r,e.g,e.b,e.a))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._canvas.lineWidth=e}fillRect(e,s,i,a){i>0&&this._canvas.fillRect(e*this._scale|0,s*this._scale|0,i*this._scale,a*this._scale)}strokeRect(e,s,i,a){const n=this.lineWidth%2==0?0:.5;this._canvas.strokeRect((e*this._scale|0)+n,(s*this._scale|0)+n,i*this._scale,a*this._scale)}beginPath(){this._canvas.beginPath()}closePath(){this._canvas.closePath()}moveTo(e,s){this._canvas.moveTo(e*this._scale,s*this._scale)}lineTo(e,s){this._canvas.lineTo(e*this._scale,s*this._scale)}quadraticCurveTo(e,s,i,a){this._canvas.quadraticCurveTo(e*this._scale,s*this._scale,i*this._scale,a*this._scale)}bezierCurveTo(e,s,i,a,n,o){this._canvas.bezierCurveTo(e*this._scale,s*this._scale,i*this._scale,a*this._scale,n*this._scale,o*this._scale)}fillCircle(e,s,i){this._canvas.fillCircle(e*this._scale,s*this._scale,i*this._scale)}strokeCircle(e,s,i){this._canvas.strokeCircle(e*this._scale,s*this._scale,i*this._scale)}fill(){this._canvas.fill()}stroke(){this._canvas.stroke()}beginGroup(e){}endGroup(){}fillText(e,s,i){if(0===e.length)return;let a=r.alphaSkia.AlphaSkiaTextAlign.Left;switch(this.textAlign){case U.Left:a=r.alphaSkia.AlphaSkiaTextAlign.Left;break;case U.Center:a=r.alphaSkia.AlphaSkiaTextAlign.Center;break;case U.Right:a=r.alphaSkia.AlphaSkiaTextAlign.Right}let n=r.alphaSkia.AlphaSkiaTextBaseline.Top;switch(this.textBaseline){case re.Top:n=r.alphaSkia.AlphaSkiaTextBaseline.Top;break;case re.Middle:n=r.alphaSkia.AlphaSkiaTextBaseline.Middle;break;case re.Bottom:n=r.alphaSkia.AlphaSkiaTextBaseline.Bottom}this._canvas.fillText(e,this._textStyle,this._font.size*this._scale,s*this._scale|0,i*this._scale|0,a,n)}measureText(e){const s={stack:[],error:void 0,hasError:!1};try{const i=function gd(r,t,e){if(null!=t){if("object"!=typeof t&&"function"!=typeof t)throw new TypeError("Object expected.");var s,i;if(e){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");s=t[Symbol.asyncDispose]}if(void 0===s){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");s=t[Symbol.dispose],e&&(i=s)}if("function"!=typeof s)throw new TypeError("Object not disposable.");i&&(s=function(){try{i.call(this)}catch(a){return Promise.reject(a)}}),r.stack.push({value:t,dispose:s,async:e})}else e&&r.stack.push({async:!0});return t}(s,this._canvas.measureText(e,this._textStyle,this._font.size,r.alphaSkia.AlphaSkiaTextAlign.Left,r.alphaSkia.AlphaSkiaTextBaseline.Alphabetic),!1);return new $i(i.width,i.actualBoundingBoxAscent+i.actualBoundingBoxDescent)}catch(i){s.error=i,s.hasError=!0}finally{!function yd(r){function t(a){r.error=r.hasError?new md(a,r.error,"An error was suppressed during disposal."):a,r.hasError=!0}var e,s=0;(function i(){for(;e=r.stack.pop();)try{if(!e.async&&1===s)return s=0,r.stack.push(e),Promise.resolve().then(i);if(e.dispose){var a=e.dispose.call(e.value);if(e.async)return s|=2,Promise.resolve(a).then(i,function(n){return t(n),i()})}else s|=1}catch(n){t(n)}if(1===s)return r.hasError?Promise.reject(r.error):Promise.resolve();if(r.hasError)throw r.error})()}(s)}}fillMusicFontSymbol(e,s,i,a,n){a!==l.None&&this.fillMusicFontSymbolText(e,s,i,String.fromCharCode(a),n)}fillMusicFontSymbols(e,s,i,a,n){let o="";for(const h of a)h!==l.None&&(o+=String.fromCharCode(h));this.fillMusicFontSymbolText(e,s,i,o,n)}fillMusicFontSymbolText(e,s,i,a,n){this._canvas.fillText(a,r.musicTextStyle,_.MusicFontSize*this._scale*i,e*this._scale,s*this._scale,n?r.alphaSkia.AlphaSkiaTextAlign.Center:r.alphaSkia.AlphaSkiaTextAlign.Left,r.alphaSkia.AlphaSkiaTextBaseline.Alphabetic)}beginRotate(e,s,i){this._canvas.beginRotate(e*this._scale,s*this._scale,i)}endRotate(){this._canvas.endRotate()}}return r.musicTextStyle=null,r})();class sh extends hs{constructor(t,e,s=!1){super(t.beat,e.beat,s),this.startNote=t,this.endNote=e}getTieHeight(t,e,s,i){return this.startNote===this.endNote?15:super.getTieHeight(t,e,s,i)}getBeamDirection(t,e){return P.Down}static getBeamDirectionForNote(t){return P.Down}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,Y.Center)}getEndY(){return this.getStartY()}getStartX(){return this.startNote===this.endNote?this.getEndX()-20:this.startNoteRenderer.getNoteX(this.startNote,We.Right)}getEndX(){return this.endNoteRenderer.getNoteX(this.endNote,We.Left)}}class bd extends bs{constructor(){super(...arguments),this._tiedNoteTie=null}createTies(t){if(t.isVisible){if(!this._tiedNoteTie&&t.isTieOrigin&&t.tieDestination.isVisible){const e=new sh(t,t.tieDestination,!1);this._tiedNoteTie=e,this.addTie(e)}if(!this._tiedNoteTie&&t.isTieDestination){const e=new sh(t.tieOrigin,t,!0);this._tiedNoteTie=e,this.addTie(e)}}}}class Sd extends br{updateBeamingHelper(t){this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.beat,t+this.x+this.width/2,t+this.x+this.width/2)}paint(t,e,s){super.internalPaint(t,e,s,Ae.SlashRests)}}class wd extends ai{constructor(){super(...arguments),this.noteHeads=null,this.deadSlapped=null,this.restGlyph=null}get effectElement(){return Ae.SlashEffects}getNoteX(t,e){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let i=s.x;switch(e){case We.Left:break;case We.Center:i+=s.width/2;break;case We.Right:i+=s.width}return i}return 0}buildBoundingsLookup(t,e,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new Oi;i.note=this.container.beat.notes[0],i.noteHeadBounds=new St,i.noteHeadBounds.x=e+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,t.addNote(i)}}getNoteY(t,e){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let i=this.y+s.y;switch(e){case Y.Top:case Y.TopWithStem:i-=s.height/2+2;break;case Y.Center:break;case Y.Bottom:case Y.BottomWithStem:i+=s.height/2}return i}return 0}updateBeamingHelper(){this.noteHeads?this.noteHeads.updateBeamingHelper(this.container.x+this.x):this.deadSlapped?this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.container.beat,this.container.x+this.x+this.deadSlapped.x+this.width,this.container.x+this.x+this.deadSlapped.x):this.restGlyph&&this.restGlyph.updateBeamingHelper(this.container.x+this.x)}doLayout(){const t=this.renderer,e=t.getNoteLine(),s=t.getLineY(e);if(this.container.beat.deadSlapped){const i=new ma;i.renderer=this.renderer,i.doLayout(),this.deadSlapped=i,this.addEffect(i)}else if(!this.container.beat.isEmpty)if(this.container.beat.isRest){const i=new Sd(0,s,this.container.beat.duration);this.restGlyph=i,i.beat=this.container.beat,i.beamingHelper=this.beamingHelper,this.addNormal(i),this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,0)}else{const a=new Sr(0,s,this.container.beat.duration,this.container.beat.graceType!==K.None,this.container.beat);this.noteHeads=a,a.beat=this.container.beat,a.beamingHelper=this.beamingHelper,this.addNormal(a)}if(this.container.beat.dots>0){this.addNormal(new Nt(0,0,5));for(let i=0;i<this.container.beat.dots;i++)this.addEffect(new yr(0,t.getLineY(t.getNoteLine())-t.getLineHeight(.5),1.5))}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}}let ih=(()=>{class r extends Ms{constructor(e,s){super(e,s),this.simpleWhammyOverflow=0,this._isOnlySlash=!s.staff.showTablature&&!s.staff.showStandardNotation,this.helpers.preferredBeamDirection=P.Up}get repeatsBarSubElement(){return Be.SlashRepeats}get barNumberBarSubElement(){return Be.SlashBarNumber}get barLineBarSubElement(){return Be.SlashBarLines}get staffLineBarSubElement(){return Be.SlashStaffLine}get lineSpacing(){return qe.RawLineSpacing}get heightLineCount(){return 5}get drawnLineCount(){return 1}get bottomGlyphOverflow(){return 0}paint(e,s,i){super.paint(e,s,i),this.paintBeams(e,s,i,Ae.SlashFlags,Ae.SlashBeams),this.paintTuplets(e,s,i,Ae.SlashTuplet)}doLayout(){super.doLayout();let e=!1;for(const s of this.bar.voices)if(this.hasVoiceContainer(s)&&this.getVoiceContainer(s).tupletGroups.length>0){e=!0;break}e&&this.registerOverflowTop(this.tupletSize)}getNoteLine(){return 0}getFlagTopY(e,s){const i=Ce.Heights.get(l.NoteheadSlashWhiteHalf);return this.getLineY(0)-i/2}getFlagBottomY(e,s){const i=Ce.Heights.get(l.NoteheadSlashWhiteHalf);return this.getLineY(0)-i/2}getBeamDirection(e){return P.Up}getNoteY(e,s){let i=super.getNoteY(e,s);return Number.isNaN(i)&&(i=this.getLineY(0)),i}calculateBeamYWithDirection(e,s,i){return this.getLineY(0)-this.getFlagStemSize(e.shortestDuration)}getBarLineStart(e,s){const i=Ce.Heights.get(l.NoteheadSlashWhiteHalf);return this.getLineY(0)-i/2}createLinePreBeatGlyphs(){this._isOnlySlash&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new Nt(0,0,5));const e=this.bar.masterBar,s=new Sn(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(null==e.previousMasterBar||e.isFreeTime!==e.previousMasterBar.isFreeTime));s.barSubElement=Be.SlashTimeSignature,this.addPreBeatGlyph(s)}createVoiceGlyphs(e){for(const s of e.beats){const i=new bd(s,this.getVoiceContainer(e));i.preNotes=new ri,i.onNotes=0===e.index?new wd:new ai,this.addBeatGlyph(i)}}paintBeamingStem(e,s,i,a,n,o){const h=me.beat(o,Ae.SlashStem,e);try{o.lineWidth=qe.StemWidth,o.beginPath(),o.moveTo(i,a),o.lineTo(i,n),o.stroke(),o.lineWidth=1}finally{h?.[Symbol.dispose]?.()}}}return r.StaffId="slash",r})();class kd extends pr{get staffId(){return ih.StaffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(t,e){return new ih(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showSlash}}class Cn extends hs{constructor(t,e,s=!1){super(t?t.beat:null,e?e.beat:null,s),this.startNote=t,this.endNote=e}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(t,e){return P.Up}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,Y.Top)}getEndY(){return this.getStartY()}getStartX(){return this.startNote===this.endNote?this.getEndX()-20:this.startNoteRenderer.getNoteX(this.startNote,We.Center)}getEndX(){return this.endNoteRenderer.getNoteX(this.endNote,this.startNote===this.endNote?We.Left:We.Center)}}class rh extends Js{constructor(t,e,s,i=!1){super(t,e,i),this._direction=P.Up,this._forSlide=s}getTieHeight(t,e,s,i){return Math.log(s-t+1)*this.renderer.settings.notation.slurHeight}tryExpand(t,e,s,i){if(this._forSlide!==s||this.forEnd!==i||this.startNote.beat.id!==t.beat.id||this.endNote.beat.id!==e.beat.id)return!1;switch(this._direction){case P.Up:t.realValue>this.startNote.realValue&&(this.startNote=t,this.startBeat=t.beat),e.realValue>this.endNote.realValue&&(this.endNote=e,this.endBeat=e.beat);break;case P.Down:t.realValue<this.startNote.realValue&&(this.startNote=t,this.startBeat=t.beat),e.realValue<this.endNote.realValue&&(this.endNote=e,this.endBeat=e.beat)}return!0}paint(t,e,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),a=this.getBeamDirection(this.startBeat,i),n=`numbered.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${a}`,o=this.renderer;o.staff.getSharedLayoutData(n,!1)||(o.staff.setSharedLayoutData(n,!0),super.paint(t,e,s))}}class Bd extends bs{constructor(){super(...arguments),this._effectSlurs=[]}createTies(t){if(t.isVisible){if(t.isTieOrigin&&t.tieDestination.isVisible){const e=new Cn(t,t.tieDestination,!1);this.addTie(e)}if(t.isTieDestination){const e=new Cn(t.tieOrigin,t,!0);this.addTie(e)}if(t.isLeftHandTapped&&!t.isHammerPullDestination){const e=new Cn(t,t,!1);this.addTie(e)}if(t.isEffectSlurOrigin&&t.effectSlurDestination){let e=!1;for(const s of this._effectSlurs)if(s.tryExpand(t,t.effectSlurDestination,!1,!1)){e=!0;break}if(!e){const s=new rh(t,t.effectSlurDestination,!1,!1);this._effectSlurs.push(s),this.addTie(s)}}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let e=!1;for(const s of this._effectSlurs)if(s.tryExpand(t.effectSlurOrigin,t,!1,!0)){e=!0;break}if(!e){const s=new rh(t.effectSlurOrigin,t,!1,!0);this._effectSlurs.push(s),this.addTie(s)}}}}}let _d=(()=>{class r extends $e{constructor(e,s,i,a,n){super(e,s),this._isGrace=a,this._number=i,this._beat=n}paint(e,s,i){const a=this._beat.isRest?me.beat(i,Ae.NumberedRests,this._beat):this._beat.notes.length>0?me.note(i,Et.NumberedNumber,this._beat.notes[0]):void 0;try{const n=this.renderer.resources;i.font=this._isGrace?n.numberedNotationGraceFont:n.numberedNotationFont,i.textBaseline=re.Middle,i.textAlign=U.Left,i.fillText(this._number.toString(),e+this.x,s+this.y)}finally{a?.[Symbol.dispose]?.()}}doLayout(){const e=this._isGrace?Me.GraceScale:1;this.width=r.NoteHeadWidth*e,this.height=r.NoteHeadHeight*e}}return r.NoteHeadHeight=17,r.NoteHeadWidth=12,r})(),Td=(()=>{class r extends $e{constructor(e,s,i){super(e,s),this._beat=i}doLayout(){this.width=14+r.Padding,this.height=Lt.BarSize}paint(e,s,i){const a=me.beat(i,Ae.NumberedDuration,this._beat);try{i.fillRect(e+this.x,s+this.y,this.width-r.Padding,this.height)}finally{a?.[Symbol.dispose]?.()}}}return r.Padding=3,r})();class xd extends ri{constructor(){super(...arguments),this.isNaturalizeAccidental=!1,this.accidental=j.None}get effectElement(){return Ae.NumberedEffects}doLayout(){if(!this.container.beat.isRest&&!this.container.beat.isEmpty){const t=new bn;if(t.renderer=this.renderer,this.container.beat.notes.length>0){const e=this.container.beat.notes[0],s=e?e.accidentalMode:ge.Default,i=gs.getNoteValue(e);let a=gs.computeAccidental(this.renderer.bar.keySignature,s,i,e.hasQuarterToneOffset);if(a===j.Natural&&(a=this.renderer.bar.keySignature+7<7?j.Sharp:j.Flat,this.isNaturalizeAccidental=!0),a!==j.None){this.accidental=a;const n=this.renderer,o=me.noteColor(n.resources,Et.NumberedAccidentals,e),h=new As(0,n.getLineY(0),a,e.beat.graceType!==K.None?Me.GraceScale*Me.GraceScale:Me.GraceScale);h.colorOverride=o,h.renderer=this.renderer,t.addGlyph(h),this.addNormal(t),this.addNormal(new Nt(0,0,4))}}}super.doLayout()}}let ah=(()=>{class r extends ai{constructor(){super(...arguments),this.noteHeads=null,this.deadSlapped=null,this.octaveDots=0}get effectElement(){return Ae.NumberedEffects}getNoteX(e,s){let i=null;if(this.noteHeads?i=this.noteHeads:this.deadSlapped&&(i=this.deadSlapped),i){let a=i.x;switch(s){case We.Left:break;case We.Center:a+=i.width/2;break;case We.Right:a+=i.width}return a}return 0}buildBoundingsLookup(e,s,i){if(this.noteHeads&&this.container.beat.notes.length>0){const a=new Oi;a.note=this.container.beat.notes[0],a.noteHeadBounds=new St,a.noteHeadBounds.x=s+this.x+this.noteHeads.x,a.noteHeadBounds.y=i+this.y+this.noteHeads.y-this.noteHeads.height/2,a.noteHeadBounds.w=this.width,a.noteHeadBounds.h=this.height,e.addNote(a)}}getNoteY(e,s){let i=null;if(this.noteHeads?i=this.noteHeads:this.deadSlapped&&(i=this.deadSlapped),i){let a=this.y+i.y;switch(s){case Y.Top:case Y.TopWithStem:a-=i.height/2+2;break;case Y.Center:break;case Y.Bottom:case Y.BottomWithStem:a+=i.height/2}return a}return 0}updateBeamingHelper(){if(this.beamingHelper){let e=null;this.noteHeads?e=this.noteHeads:this.deadSlapped&&(e=this.deadSlapped),e&&this.beamingHelper.registerBeatLineX("numbered",this.container.beat,this.container.x+this.x+e.x,this.container.x+this.x+e.x+e.width)}}doLayout(){const e=this.renderer;e.shortestDuration<this.container.beat.duration&&(e.shortestDuration=this.container.beat.duration);const s=e.getLineY(e.getNoteLine());if(!this.container.beat.isEmpty){let i="0";if(this.container.beat.notes.length>0){const h=this.renderer.bar.keySignature,c=h+7,f=this.container.beat.notes[0];if(f.isDead)i="X";else{const p=f.displayValue-(this.renderer.bar.keySignatureType===It.Minor?r.MinorKeySignatureOneValues:r.MajorKeySignatureOneValues)[c],g=p<0?(p%12+12)%12:p%12;let b=p<0?(Math.abs(p)+12)/12|0:p/12|0;p<0&&(b*=-1),this.octaveDots=b,e.registerOctave(b);let S=(O.keySignatureIsSharp(h)||O.keySignatureIsNatural(h)?gs.FlatNoteSteps:gs.SharpNoteSteps)[g]+1;gs.AccidentalNotes[g]&&!this.container.preNotes.isNaturalizeAccidental&&(c<7?S++:S--),i=S.toString()}}if(this.container.beat.deadSlapped){const o=new ma;o.renderer=this.renderer,o.doLayout(),this.deadSlapped=o,this.addEffect(o)}else{const h=new _d(0,s,i,this.container.beat.graceType!==K.None,this.container.beat);this.noteHeads=h,this.addNormal(h)}if(this.container.beat.dots>0&&this.container.beat.duration>=m.Quarter){this.addNormal(new Nt(0,0,5));for(let o=0;o<this.container.beat.dots;o++){const h=new yr(0,e.getLineY(0),1.5);h.renderer=this.renderer,this.addEffect(h)}}let a=0;switch(this.container.beat.duration){case m.QuadrupleWhole:a=16;break;case m.DoubleWhole:a=8;break;case m.Whole:a=4;break;case m.Half:a=2}let n=a;for(let o=0;o<this.container.beat.dots;o++)n=n/2|0,a+=n;for(let o=0;o<a-1;o++){const h=new Td(0,e.getLineY(0),this.container.beat);h.renderer=this.renderer,this.addNormal(h)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}}return r.MajorKeySignatureOneValues=[59,66,61,68,63,58,65,60,67,62,69,64,71,66,61],r.MinorKeySignatureOneValues=[71,66,73,68,63,70,65,72,67,74,69,64,71,66,73],r})();class Nd extends $e{constructor(t,e,s,i){super(t,e),this._text="",this._accidental=j.None,this._accidentalOffset=0,this._keySignature=s,this._keySignatureType=i}doLayout(){super.doLayout();const t="1 = ";let e="",s=j.None;switch(this._keySignatureType){case It.Major:switch(this._keySignature){case ye.Cb:e="  C",s=j.Flat;break;case ye.Gb:e="  G",s=j.Flat;break;case ye.Db:e="  D",s=j.Flat;break;case ye.Ab:e="  A",s=j.Flat;break;case ye.Eb:e="  E",s=j.Flat;break;case ye.Bb:e="  B",s=j.Flat;break;case ye.F:e="F";break;case ye.C:e="C",s=j.None;break;case ye.G:e="G",s=j.None;break;case ye.D:e="D",s=j.None;break;case ye.A:e="A",s=j.None;break;case ye.E:e="E",s=j.None;break;case ye.B:e="B",s=j.None;break;case ye.FSharp:e="  F",s=j.Sharp;break;case ye.CSharp:e="  C",s=j.Sharp}break;case It.Minor:switch(this._keySignature){case ye.Cb:e="  a",s=j.Flat;break;case ye.Gb:e="  e",s=j.Flat;break;case ye.Db:e="  b",s=j.Flat;break;case ye.Ab:e="f",s=j.None;break;case ye.Eb:e="c",s=j.None;break;case ye.Bb:e="g",s=j.None;break;case ye.F:e="d";break;case ye.C:e="a",s=j.None;break;case ye.G:e="e",s=j.None;break;case ye.D:e="b",s=j.None;break;case ye.A:e="  f",s=j.Sharp;break;case ye.E:e="  c",s=j.Sharp;break;case ye.B:e="  g",s=j.Sharp;break;case ye.FSharp:e="  d",s=j.Sharp;break;case ye.CSharp:e="  a",s=j.Sharp}}this._text=t+e,this._accidental=s;const i=this.renderer.scoreRenderer.canvas;i.font=this.renderer.resources.numberedNotationFont,this._accidentalOffset=i.measureText(t).width,this.width=i.measureText(t+e).width}paint(t,e,s){const i=me.bar(s,Be.NumberedKeySignature,this.renderer.bar);try{s.font=this.renderer.resources.numberedNotationFont,s.textBaseline=re.Middle,s.fillText(this._text,t+this.x,e+this.y),this._accidental!==j.None&&s.fillMusicFontSymbol(t+this.x+this._accidentalOffset,e+this.y,.7,As.getMusicSymbol(this._accidental),!1)}finally{i?.[Symbol.dispose]?.()}}}class Lt extends Ms{registerOctave(t){null===this.lowestOctave?(this.lowestOctave=t,this.highestOctave=t):(t<this.lowestOctave&&(this.lowestOctave=t),t>this.highestOctave&&(this.highestOctave=t))}get repeatsBarSubElement(){return Be.NumberedRepeats}get barNumberBarSubElement(){return Be.NumberedBarNumber}get barLineBarSubElement(){return Be.NumberedBarLines}get staffLineBarSubElement(){return Be.NumberedStaffLine}constructor(t,e){super(t,e),this.simpleWhammyOverflow=0,this.shortestDuration=m.QuadrupleWhole,this.lowestOctave=null,this.highestOctave=null,this._isOnlyNumbered=!e.staff.showSlash&&!e.staff.showTablature&&!e.staff.showStandardNotation}get lineSpacing(){return qe.RawLineSpacing}get heightLineCount(){return 5}get drawnLineCount(){return 0}get bottomGlyphOverflow(){return 0}paint(t,e,s){super.paint(t,e,s),this.paintBeams(t,e,s,Ae.NumberedDuration,Ae.NumberedDuration),this.paintTuplets(t,e,s,Ae.NumberedTuplet,!0)}doLayout(){super.doLayout();let t=!1;for(const e of this.bar.voices)if(this.hasVoiceContainer(e)&&this.getVoiceContainer(e).tupletGroups.length>0){t=!0;break}if(t&&this.registerOverflowTop(this.tupletSize),!this.bar.isEmpty){const e=O.getIndex(this.shortestDuration)-2;if(e>0){const n=(e-1)*Lt.BarSpacing+Lt.BarSize;let o=0;const h=this.lowestOctave;null!==h&&(o=Math.abs(h)*Lt.DotSpacing+Lt.DotSize),this.registerOverflowBottom(n+o)}const s=this.highestOctave;if(null!==s){const i=Math.abs(s)*Lt.DotSpacing+Lt.DotSize;this.registerOverflowTop(i)}}}paintFlag(t,e,s,i,a){this.paintBar(t,e,s,i,a)}paintBar(t,e,s,i,a){if(0===i.beats.length)return;const n=this.resources;for(let o=0,h=i.beats.length;o<h;o++){const c=i.beats[o],d=me.beat(s,a,c);try{const u=Lt.BarSpacing,f=Lt.BarSize,p=O.getIndex(c.duration)-2,g=e+this.y,b=this.getBeatX(c,be.PreNotes)-this.beatGlyphsStart,w=this.calculateBeamY(i,b);for(let E=0;E<p;E++){let B=0,ie=0,Re=0;const Ne=g+E*u;o===i.beats.length-1?(B=b,ie=this.getBeatX(c,be.PostNotes)-this.beatGlyphsStart):(B=b,ie=this.getBeatX(i.beats[o+1],be.PreNotes)-this.beatGlyphsStart),Re=Ne+w|0,Ms.paintSingleBar(s,t+this.x+B,Re,t+this.x+ie,Re,f)}const S=this.getBeatContainer(c).onNotes;let D=S instanceof ah?S.octaveDots:0,N=0,L=0;D>0?(N=g+this.getLineY(0)-n.numberedNotationFont.size/1.5,L=-1*Lt.DotSpacing):D<0&&(N=g+w+p*u,L=Lt.DotSpacing);const $=this.getBeatX(c,be.OnNotes)+4-this.beatGlyphsStart;D=Math.abs(D);for(let E=0;E<D;E++)s.fillCircle(t+this.x+$,N,Lt.DotSize),N+=L}finally{d?.[Symbol.dispose]?.()}}}getNoteLine(){return 0}get tupletOffset(){return super.tupletOffset+this.resources.numberedNotationFont.size}getFlagTopY(t,e){const s=Ce.Heights.get(l.NoteheadBlack);return this.getLineY(0)-s/2}getFlagBottomY(t,e){const s=Ce.Heights.get(l.NoteheadBlack);return this.getLineY(0)-s/2}getBeamDirection(t){return P.Down}getTupletBeamDirection(t){return P.Up}getNoteY(t,e){let s=super.getNoteY(t,e);return Number.isNaN(s)&&(s=this.getLineY(0)),s}calculateBeamYWithDirection(t,e,s){const i=this.resources.numberedNotationFont;return this.getLineY(0)+i.size}getBarLineStart(t,e){const s=Ce.Heights.get(l.NoteheadBlack);return this.getLineY(0)-s/2}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine,(0===this.index||this.bar.masterBar.isRepeatStart&&this._isOnlyNumbered)&&this.addPreBeatGlyph(new kn(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new $o(0,this.getLineHeight(-.25),this.bar.index+1))}createLinePreBeatGlyphs(){(!this.bar.previousBar||this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this.createKeySignatureGlyphs()),this._isOnlyNumbered&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createKeySignatureGlyphs(){this.addPreBeatGlyph(new Nd(0,this.getLineY(0),this.bar.keySignature,this.bar.keySignatureType))}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new Nt(0,0,5));const t=this.bar.masterBar,e=new Sn(0,this.getLineY(0),t.timeSignatureNumerator,t.timeSignatureDenominator,t.timeSignatureCommon,t.isFreeTime&&(null==t.previousMasterBar||t.isFreeTime!==t.previousMasterBar.isFreeTime));e.barSubElement=Be.NumberedTimeSignature,this.addPreBeatGlyph(e)}createPostBeatGlyphs(){this._isOnlyNumbered&&super.createPostBeatGlyphs()}createVoiceGlyphs(t){for(const e of t.beats){const s=new Bd(e,this.getVoiceContainer(t));s.preNotes=0===t.index?new xd:new ri,s.onNotes=0===t.index?new ah:new ai,this.addBeatGlyph(s)}}paintBeamingStem(t,e,s,i,a,n){}}Lt.StaffId="numbered",Lt.BarSpacing=qe.BeamSpacing+qe.BeamThickness,Lt.BarSize=2,Lt.DotSpacing=5,Lt.DotSize=2;class Pd extends pr{get staffId(){return Lt.StaffId}getStaffPaddingTop(t){return t.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(t){return t.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(t,e){return new Lt(t,e)}canCreate(t,e){return super.canCreate(t,e)&&e.showNumbered}}class Cd extends Ze{get notationElement(){return fe.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.SinglePreBeat}shouldCreateGlyph(t,e){const s=e.voice.bar.masterBar;return 0===e.voice.bar.staff.index&&0===e.voice.index&&0===e.index&&s.isFreeTime&&(0===s.index||s.isFreeTime!==s.previousMasterBar.isFreeTime)}createNewGlyph(t,e){return new Zt(0,0,"Free time",t.resources.effectFont,U.Left)}canExpand(t,e){return!0}}let Dd=(()=>{class r extends Kt{constructor(){super(0,0)}doLayout(){super.doLayout(),this.height=Ce.Heights.get(l.KeyboardPedalPed)}paint(e,s,i){const n=s+this.y,o=this.height,h=this.renderer.bar.sustainPedals,c=Ce.Widths.get(l.KeyboardPedalPed),d=Ce.Widths.get(l.KeyboardPedalUp);let u=0;for(;u<h.length;){let f=h[u];for(;null!=f;){const p=e+this.renderer.getRatioPositionX(f.ratioPosition);let g=0;if(f.pedalType===rt.Down?(i.fillMusicFontSymbol(p,n+o,1,l.KeyboardPedalPed,!0),g=c/2+r.TextLinePadding):f.pedalType===rt.Up&&(i.fillMusicFontSymbol(p,n+o,1,l.KeyboardPedalUp,!0),g=d/2+r.StarLinePadding),f.nextPedalMarker)if(f.nextPedalMarker.bar===f.bar){let b=e+this.renderer.getRatioPositionX(f.nextPedalMarker.ratioPosition);switch(f.nextPedalMarker.pedalType){case rt.Down:b-=c/2;break;case rt.Hold:break;case rt.Up:b-=d/2}const w=p+g;b>w&&i.fillRect(w,n+o-1,b-w,1)}else{const w=p+g;i.fillRect(w,n+o-1,e+this.x+this.width-w,1)}if(0===u&&f.previousPedalMarker){const b=e+this.x;i.fillRect(b,n+o-1,p-g-b,1)}u++,null!=f.nextPedalMarker&&f.nextPedalMarker.bar!==f.bar?(f=null,u=h.length):f=f.nextPedalMarker}}}}return r.TextLinePadding=3,r.StarLinePadding=3,r})();class Ld extends Ze{get notationElement(){return fe.EffectSustainPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return we.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&e.voice.bar.sustainPedals.length>0}createNewGlyph(t,e){return new Dd}canExpand(t,e){return!0}}class Sa extends Ze{constructor(t,e){super(),this._type=t,this._shouldCreate=e}get notationElement(){return fe.EffectGolpe}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){const s=this._shouldCreate;return e.golpe===this._type&&(!s||s(t,e))}createNewGlyph(t,e){return new Yo(0,0,!0)}canExpand(t,e){return!1}}class Dn extends lt{constructor(t){super(0,0,1,Dn.getSymbol(t)),this.center=!0}static getSymbol(t){switch(t){case Jt.Open:return l.GuitarOpenPedal;case Jt.Closed:return l.GuitarClosePedal}return l.None}paint(t,e,s){super.paint(t,e+this.height,s)}}class Fd extends Ze{get notationElement(){return fe.EffectWahPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return e.wahPedal!==Jt.None}createNewGlyph(t,e){return new Dn(e.wahPedal)}canExpand(t,e){return!1}}class Br extends Ze{get notationElement(){return fe.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.isBarre}get sizingMode(){return we.GroupedOnBeat}createNewGlyph(t,e){let s="";switch(e.barreShape){case qt.None:case qt.Full:break;case qt.Half:s+="1/2"}return s+=`B ${Br.toRoman(e.barreFret)}`,new Ni(s,!1)}static toRoman(t){let e="";if(t>0)for(const[s,i]of Br.RomanLetters){const a=Math.floor(t/i);t-=a*i,e+=s.repeat(a)}return e}canExpand(t,e){return t.barreFret===e.barreFret&&t.barreShape===e.barreShape}}Br.RomanLetters=new Map([["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]]);class Ln extends lt{constructor(t){super(0,0,1,Ln.getSymbol(t)),this.center=!0}static getSymbol(t){switch(t){case tt.InvertedTurn:return l.OrnamentTurnInverted;case tt.Turn:return l.OrnamentTurn;case tt.UpperMordent:return l.OrnamentShortTrill;case tt.LowerMordent:return l.OrnamentMordent}return l.None}paint(t,e,s){super.paint(t,e+this.height-4,s)}}class Ed extends Ze{get notationElement(){return fe.EffectNoteOrnament}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return e.notes.some(s=>s.ornament!==tt.None)}createNewGlyph(t,e){return new Ln(e.notes.find(s=>s.ornament!==tt.None).ornament)}canExpand(t,e){return!1}}class vd extends Ze{get notationElement(){return fe.EffectRasgueado}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(t,e){return e.hasRasgueado}get sizingMode(){return we.GroupedOnBeat}createNewGlyph(t,e){return new Ni("rasg.")}canExpand(t,e){return!0}}class wa extends $e{constructor(t){super(0,0),this._symbols=t}doLayout(){this.height=27}paint(t,e,s){s.fillMusicFontSymbols(t+this.x,e+this.y+this.height,.8,this._symbols,!0)}}class jt extends $e{constructor(t){super(0,0),this._text=t}doLayout(){this.height=1.5*this.renderer.resources.directionsFont.size}paint(t,e,s){const i=s.font,a=s.textBaseline,n=s.textAlign;s.font=this.renderer.resources.directionsFont,s.textBaseline=re.Middle,s.textAlign=U.Right,s.fillText(this._text,t+this.x,e+this.y+this.height/2),s.font=i,s.textBaseline=a,s.textAlign=n}}class Id extends Kt{constructor(t,e,s){super(t,e),this._barBeginGlyphs=[],this._barEndGlyphs=[],this._directions=s}doLayout(){const t=this._directions;t.has(I.TargetSegnoSegno)&&this._barBeginGlyphs.push(new wa([l.Segno,l.Segno])),t.has(I.TargetSegno)&&this._barBeginGlyphs.push(new wa([l.Segno])),t.has(I.TargetDoubleCoda)&&this._barBeginGlyphs.push(new wa([l.Coda,l.Coda])),t.has(I.TargetCoda)&&this._barBeginGlyphs.push(new wa([l.Coda])),t.has(I.TargetFine)&&this._barEndGlyphs.push(new jt("Fine")),t.has(I.JumpDaDoubleCoda)&&this._barEndGlyphs.push(new jt("To Double Coda")),t.has(I.JumpDaCoda)&&this._barEndGlyphs.push(new jt("To Coda")),t.has(I.JumpDalSegnoSegno)&&this._barEndGlyphs.push(new jt("D.S.S.")),t.has(I.JumpDalSegnoSegnoAlCoda)&&this._barEndGlyphs.push(new jt("D.S.S. al Coda")),t.has(I.JumpDalSegnoSegnoAlDoubleCoda)&&this._barEndGlyphs.push(new jt("D.S.S. al Double Coda")),t.has(I.JumpDalSegnoSegnoAlFine)&&this._barEndGlyphs.push(new jt("D.S.S. al Fine")),t.has(I.JumpDalSegno)&&this._barEndGlyphs.push(new jt("D.S.")),t.has(I.JumpDalSegnoAlCoda)&&this._barEndGlyphs.push(new jt("D.S. al Coda")),t.has(I.JumpDalSegnoAlDoubleCoda)&&this._barEndGlyphs.push(new jt("D.S. al Double Coda")),t.has(I.JumpDalSegnoAlFine)&&this._barEndGlyphs.push(new jt("D.S. al Fine")),t.has(I.JumpDaCapo)&&this._barEndGlyphs.push(new jt("D.C.")),t.has(I.JumpDaCapoAlCoda)&&this._barEndGlyphs.push(new jt("D.C. al Coda")),t.has(I.JumpDaCapoAlDoubleCoda)&&this._barEndGlyphs.push(new jt("D.C. al Double Coda")),t.has(I.JumpDaCapoAlFine)&&this._barEndGlyphs.push(new jt("D.C. al Fine"));const e=this.doSideLayout(this._barBeginGlyphs),s=this.doSideLayout(this._barEndGlyphs);this.height=Math.max(e,s)}doSideLayout(t){let e=0;for(const i of t)i.y=e,i.renderer=this.renderer,i.doLayout(),e+=i.height+3;return e}paint(t,e,s){for(const i of this._barBeginGlyphs)i.paint(t+this.x,e+this.y,s);for(const i of this._barEndGlyphs)i.paint(t+this.x+this.width,e+this.y,s)}}class Ad extends Ze{get notationElement(){return fe.EffectDirections}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return we.FullBar}shouldCreateGlyph(t,e){return 0===e.voice.index&&0===e.index&&null!==e.voice.bar.masterBar.directions&&e.voice.bar.masterBar.directions.size>0}createNewGlyph(t,e){return new Id(0,0,e.voice.bar.masterBar.directions)}canExpand(t,e){return!0}}let Md=(()=>{class r extends Kt{constructor(e){super(0,0),this._text="",this._textWidth=0,this._textHeight=0,this._timer=e}doLayout(){const e=this._timer/6e4|0;this._text=`${e}:${((this._timer-6e4*e)/1e3|0).toString().padStart(2,"0")}`;const i=this.renderer.scoreRenderer.canvas;i.font=this.renderer.resources.timerFont;const a=i.measureText(this._text);this._textHeight=i.font.size+2*r.PaddingY,this._textWidth=a.width+2*r.PaddingX,this.height=this._textHeight+2*r.MarginY}paint(e,s,i){i.strokeRect(e+this.x-(this._textWidth/2|0),s+this.y+r.MarginY,this._textWidth,this._textHeight);const n=i.font,o=i.textBaseline,h=i.textAlign;i.font=this.renderer.resources.timerFont,i.textBaseline=re.Middle,i.textAlign=U.Center,i.fillText(this._text,e+this.x,s+this.y+this.height/2),i.font=n,i.textBaseline=o,i.textAlign=h}}return r.PaddingX=2,r.PaddingY=2,r.MarginY=2,r})();class Rd extends Ze{get notationElement(){return fe.EffectBeatTimer}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return we.SingleOnBeat}shouldCreateGlyph(t,e){return e.showTimer}createNewGlyph(t,e){return new Md(e.timer??0)}canExpand(t,e){return!0}}let Fn=(()=>{class r{static print(e){e(`alphaTab ${r.version}`),e(`commit: ${r.commit}`),e(`build date: ${r.date}`)}}return r.version="1.6.3",r.date="2025-08-30T14:34:56.310Z",r.commit="bf30fbbbf85e7c31fe99ed4c5a8f71814bb007e3",r})();class nh{constructor(t,e){this.vertical=t,this.createLayout=e}}class En{constructor(t,e){this.supportsWorkers=t,this.createCanvas=e}}class _{static get globalThis(){if(void 0===_._globalThis){try{_._globalThis=globalThis}catch{}typeof _._globalThis>"u"&&(_._globalThis=self),typeof _._globalThis>"u"&&(_._globalThis=global),typeof _._globalThis>"u"&&(_._globalThis=window),typeof _._globalThis>"u"&&(_._globalThis=Function("return this")())}return _._globalThis}static get isRunningInWorker(){return"WorkerGlobalScope"in _.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in _.globalThis}static throttle(t,e){let s=0;return()=>{_.globalThis.clearTimeout(s),s=_.globalThis.setTimeout(t,e)}}static detectScriptFile(){if(!_.isRunningInWorker&&_.globalThis.ALPHATAB_ROOT){let t=_.globalThis.ALPHATAB_ROOT;return t=_.ensureFullUrl(t),t=_.appendScriptName(t),t}try{const t="file:///C:/Users/elkaf/workspaces/fretboard/node_modules/@coderline/alphatab/dist/alphaTab.core.mjs";if(t&&-1===t.indexOf("file://"))return t}catch{}return"document"in _.globalThis&&document.currentScript&&document.currentScript instanceof HTMLScriptElement?document.currentScript.src:null}static ensureFullUrl(t){if(!t)return"";if(!t.startsWith("http")&&!t.startsWith("https")&&!t.startsWith("file")){let e="";const s=_.globalThis.location;if(e+=s.protocol?.toString(),e+="//",s.hostname&&(e+=s.hostname?.toString()),s.port&&(e+=":",e+=s.port?.toString()),!t.startsWith("/")){const i=s.pathname.split("/").slice(0,-1).join("/");i.length>0&&(i.startsWith("/")||(e+="/"),e+=i?.toString())}return t.startsWith("/")||(e+="/"),e+=t?.toString(),e}return t}static appendScriptName(t){return t&&!t.endsWith(".js")&&(t.endsWith("/")||(t+="/"),t+="alphaTab.js"),t}static detectFontDirectory(){if(!_.isRunningInWorker&&_.globalThis.ALPHATAB_FONT)return _.ensureFullUrl(_.globalThis.ALPHATAB_FONT);const t=_.scriptFile;if(t){const e=t.lastIndexOf("/");if(e>=0)return`${t.substr(0,e)}/font/`}return null}static registerJQueryPlugin(){if(!_.isRunningInWorker&&_.globalThis&&"jQuery"in _.globalThis){const t=_.globalThis.jQuery,e=new xo;t.fn.alphaTab=function(s){const i=Array.prototype.slice.call(arguments,1);return 1===this.length?e.exec(this[0],s,i):this.each((a,n)=>{e.exec(n,s,i)})},t.alphaTab={restore:xo.restore},t.fn.alphaTab.fn=e}}static getRenderEngineFactory(t){return t&&_.renderEngines.has(t)?_.renderEngines.get(t):_.renderEngines.get("default")}static getLayoutEngineFactory(t){return t&&_.layoutEngines.has(t)?_.layoutEngines.get(t):_.layoutEngines.get(cs.Page)}static buildImporters(){return[new gh,new Nh,new Bh,new ve,new pd,new Nr]}static createDefaultRenderEngines(){const t=new Map;return t.set("svg",new En(!0,()=>new No)),t.set("default",t.get("svg")),t.set("skia",new En(!1,()=>new Pn)),_.createPlatformSpecificRenderEngines(t),t}static enableAlphaSkia(t,e){Pn.enable(t,e)}static registerAlphaSkiaCustomFont(t){return Pn.registerFont(t)}static createPlatformSpecificRenderEngines(t){t.set("html5",new En(!1,()=>new dl))}static createDefaultRenderers(){return[new Ti(_.StaffIdBeforeSlashAlways,[new kc,new Nc,new pc,new Ad,new sc,new Cd,new Bc,new Rd,new rc]),new kd,new Ti(_.StaffIdBeforeScoreAlways,[new lc,new Br,new Ed,new vd,new Fd]),new Ti(_.StaffIdBeforeScoreHideable,[new Pc,new Io,new Lo(!0),new Ao,new Eo,new Mo,new vo(!1),new Ko,new Sa(Gt.Finger)],(t,e)=>e.showStandardNotation),new Qc,new Ti(_.StaffIdBeforeNumberedAlways,[new nc,new Lo(!1),new oc,new Sa(Gt.Thumb,(t,e)=>e.voice.bar.staff.showStandardNotation),new Ld]),new Pd,new Ti(_.StaffIdBeforeTabAlways,[new fc]),new Ti(_.StaffIdBeforeTabHideable,[new Io,new Ao,new Eo,new Mo,new vo(!0),new Sc,new hc,new ni(Z.Natural),new ni(Z.Artificial),new ni(Z.Pinch),new ni(Z.Tap),new ni(Z.Semi),new ni(Z.Feedback),new dc,new ic,new cc,new mc,new bc,new yc,new Ko,new Sa(Gt.Finger,(t,e)=>!e.voice.bar.staff.showStandardNotation)],(t,e)=>e.showTablature),new Tn,new Ti(_.StaffIdBeforeEndAlways,[new Sa(Gt.Thumb,(t,e)=>!e.voice.bar.staff.showStandardNotation)])]}static createDefaultStaveProfiles(){const t=new Map,e=_.createDefaultRenderers();t.set(ds.Default,e),t.set(ds.ScoreTab,e);const s=new Set([_.StaffIdBeforeSlashAlways,_.StaffIdBeforeScoreAlways,_.StaffIdBeforeNumberedAlways,_.StaffIdBeforeTabAlways,Bn.StaffId,_.StaffIdBeforeEndAlways]);t.set(ds.Score,e.filter(a=>s.has(a.staffId)));const i=new Set([_.StaffIdBeforeSlashAlways,_.StaffIdBeforeScoreAlways,_.StaffIdBeforeNumberedAlways,_.StaffIdBeforeTabAlways,_n.StaffId,_.StaffIdBeforeEndAlways]);return t.set(ds.Tab,_.createDefaultRenderers().filter(a=>{if(a instanceof Tn){const n=a;n.showTimeSignature=!0,n.showRests=!0,n.showTiedNotes=!0}return i.has(a.staffId)})),t.set(ds.TabMixed,_.createDefaultRenderers().filter(a=>{if(a instanceof Tn){const n=a;n.showTimeSignature=!1,n.showRests=!1,n.showTiedNotes=!1}return i.has(a.staffId)})),t}static createDefaultLayoutEngines(){const t=new Map;return t.set(cs.Page,new nh(!0,e=>new Dc(e))),t.set(cs.Horizontal,new nh(!1,e=>new Cc(e))),t}static initializeMain(t,e){_.isRunningInWorker||_.isRunningInAudioWorklet||((_.webPlatform===ys.Browser||_.webPlatform===ys.BrowserModule)&&(_.registerJQueryPlugin(),_.HighDpiFactor=window.devicePixelRatio),_.createWebWorker=t,_.createAudioWorklet=e)}static get alphaTabWorker(){return _.globalThis.Worker}static get alphaTabUrl(){return _.globalThis.URL}static initializeWorker(){if(!_.isRunningInWorker)throw new Le(Fe.General,"Not running in worker, cannot run worker initialization");on.init(),en.init(),_.createWebWorker=t=>{throw new Le(Fe.General,"Nested workers are not supported")}}static initializeAudioWorklet(){if(!_.isRunningInAudioWorklet)throw new Le(Fe.General,"Not running in audio worklet, cannot run worklet initialization");Nl.init()}static detectWebPack(){try{return!0}catch{}return!1}static detectVite(){try{if("string"==typeof __BASE__)return!0}catch{}return!1}static detectWebPlatform(){if(!(typeof _.globalThis.Window<"u"&&_.globalThis instanceof _.globalThis.Window))try{if("[object process]"===Object.prototype.toString.call(typeof process<"u"?process:0))return ys.NodeJs}catch{}try{const e="file:///C:/Users/elkaf/workspaces/fretboard/node_modules/@coderline/alphatab/dist/alphaTab.core.mjs";if(e&&"string"==typeof e&&!e.startsWith("file://"))return ys.BrowserModule}catch{}return ys.Browser}static printEnvironmentInfo(t=!0){const e=t?s=>{x.log.debug("VersionInfo",s)}:s=>{x.debug("VersionInfo",s)};Fn.print(e),e(`High DPI: ${_.HighDpiFactor}`),_.printPlatformInfo(e)}static printPlatformInfo(t){t(`Browser: ${navigator.userAgent}`),t(`Platform: ${ys[_.webPlatform]}`),t(`WebPack: ${_.isWebPackBundled}`),t(`Vite: ${_.isViteBundled}`),_.webPlatform!==ys.NodeJs&&(t(`Window Size: ${window.outerWidth}x${window.outerHeight}`),t(`Screen Size: ${window.screen.width}x${window.screen.height}`))}static prepareForPostMessage(t){if(!t)return t;if("object"==typeof t){const e=t.__v_raw;if(e)return _.prepareForPostMessage(e)}return t}}_.StaffIdBeforeSlashAlways="before-slash-always",_.StaffIdBeforeScoreAlways="before-score-always",_.StaffIdBeforeScoreHideable="before-score-hideable",_.StaffIdBeforeNumberedAlways="before-numbered-always",_.StaffIdBeforeTabAlways="before-tab-always",_.StaffIdBeforeTabHideable="before-tab-hideable",_.StaffIdBeforeEndAlways="before-end-always",_.MusicFontSize=34,_.HighDpiFactor=1,_._globalThis=void 0,_.webPlatform=_.detectWebPlatform(),_.isWebPackBundled=_.detectWebPack(),_.isViteBundled=_.detectVite(),_.scriptFile=_.detectScriptFile(),_.fontDirectory=_.detectFontDirectory(),_.renderEngines=_.createDefaultRenderEngines(),_.layoutEngines=_.createDefaultLayoutEngines(),_.staveProfiles=_.createDefaultStaveProfiles();var Bs=function(r){return r[r.EmbeddedOpenType=0]="EmbeddedOpenType",r[r.Woff=1]="Woff",r[r.Woff2=2]="Woff2",r[r.OpenType=3]="OpenType",r[r.TrueType=4]="TrueType",r[r.Svg=5]="Svg",r}(Bs||{});class vn{static buildDefaultSmuflFontSources(t){const e=new Map,s=t??"";return e.set(Bs.Woff2,`${s}Bravura.woff2`),e.set(Bs.Woff,`${s}Bravura.woff`),e.set(Bs.OpenType,`${s}Bravura.otf`),e}constructor(){this.scriptFile=null,this.fontDirectory=null,this.smuflFontSources=null,this.file=null,this.tex=!1,this.tracks=null,this.enableLazyLoading=!0,this.engine="default",this.logLevel=Ns.Info,this.useWorkers=!0,this.includeNoteBounds=!1,this.scriptFile=_.scriptFile,this.fontDirectory=_.fontDirectory}}Symbol,Symbol;var v=function(r){return r[r.SteelGuitar=1]="SteelGuitar",r[r.AcousticGuitar=2]="AcousticGuitar",r[r.TwelveStringGuitar=3]="TwelveStringGuitar",r[r.ElectricGuitar=4]="ElectricGuitar",r[r.Bass=5]="Bass",r[r.ClassicalGuitar=23]="ClassicalGuitar",r[r.UprightBass=6]="UprightBass",r[r.Ukulele=7]="Ukulele",r[r.Banjo=8]="Banjo",r[r.Mandolin=9]="Mandolin",r[r.Piano=10]="Piano",r[r.Synth=12]="Synth",r[r.Strings=11]="Strings",r[r.Brass=13]="Brass",r[r.Reed=14]="Reed",r[r.Woodwind=15]="Woodwind",r[r.Vocal=16]="Vocal",r[r.PitchedIdiophone=17]="PitchedIdiophone",r[r.Fx=21]="Fx",r[r.PercussionKit=18]="PercussionKit",r[r.Idiophone=19]="Idiophone",r[r.Membraphone=20]="Membraphone",r}(v||{});class A{constructor(t,e,s=null){if(this.icon=v.Piano,this.icon=t,this.instrumentSetName=e,s)this.instrumentSetType=s;else{const i=e.split(" ");i[0]=i[0].substr(0,1).toLowerCase()+i[0].substr(1),this.instrumentSetType=i.join("")}}}class Xt{constructor(){this._rhythmIdLookup=new Map}writeXml(t){const e=new Ki;return this._rhythmIdLookup=new Map,this.writeDom(e,t),e.toFormattedString("",!0)}writeDom(t,e){const s=t.addElement("GPIF");s.addElement("GPVersion").innerText="8.1.3";const i=s.addElement("GPRevision");i.attributes.set("required","12024"),i.attributes.set("recommended","13000"),i.innerText="13007";const a=s.addElement("Encoding");a.addElement("EncodingDescription").innerText="GP8";const n=new rs;n.nodeType=Ye.Comment,n.value=`Written by alphaTab ${Fn.version} (${Fn.commit})`,a.addChild(n),this.writeScoreNode(s,e),this.writeMasterTrackNode(s,e),this.writeBackingTrackNode(s,e),this.writeAudioTracksNode(s,e),this.writeTracksNode(s,e),this.writeMasterBarsNode(s,e),this.writeAssets(s,e);const o=s.addElement("Bars"),h=s.addElement("Voices"),c=s.addElement("Beats"),d=s.addElement("Notes"),u=s.addElement("Rhythms");for(const f of e.tracks)for(const p of f.staves)for(const g of p.bars){this.writeBarNode(o,g);for(const b of g.voices){this.writeVoiceNode(h,b);for(const w of b.beats){this.writeBeatNode(c,w,u);for(const S of w.notes)this.writeNoteNode(d,S)}}}}writeAssets(t,e){if(!e.backingTrack?.rawAudioFile)return;const i=t.addElement("Assets").addElement("Asset");i.attributes.set("id",this.backingTrackAssetId),this.backingTrackAssetFileName="Content/Assets/backing-track",i.addElement("EmbeddedFilePath").setCData(this.backingTrackAssetFileName)}writeBackingTrackNode(t,e){if(!e.backingTrack?.rawAudioFile)return;const s=t.addElement("BackingTrack");this.backingTrackAssetId="0",s.addElement("IconId").innerText="21",s.addElement("Color").innerText="0 0 0",s.addElement("Name").setCData("Audio Track"),s.addElement("ShortName").setCData("a.track"),s.addElement("PlaybackState").innerText="Default",s.addElement("Enabled").innerText="true",s.addElement("Source").innerText="Local",s.addElement("AssetId").innerText="0";const a=s.addElement("ChannelStrip");a.addElement("Parameters").innerText="0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.000000 0.500000 0.500000 0.800000 0.500000 0.500000 0.500000",a.addElement("YouTubeVideoUrl").innerText="",a.addElement("Filter").innerText="6",a.addElement("FramesPerPixel").innerText="400";const n=void 0!==this.backingTrackFramePadding?this.backingTrackFramePadding:0;s.addElement("FramePadding").innerText=`${n}`,s.addElement("Semitones").innerText="0",s.addElement("Cents").innerText="0"}writeNoteNode(t,e){const s=t.addElement("Note");s.attributes.set("id",e.id.toString()),this.writeNoteProperties(s,e),e.isGhost&&(s.addElement("AntiAccent").innerText="normal"),e.isLetRing&&s.addElement("LetRing"),e.isTrill&&(s.addElement("Trill").innerText=e.trillValue.toString());let i=0;switch(e.isStaccato&&(i|=1),e.accentuated){case et.Normal:i|=8;break;case et.Heavy:i|=4;break;case et.Tenuto:i|=16}if(i>0&&(s.addElement("Accent").innerText=i.toString()),e.isTieOrigin||e.isTieDestination){const a=s.addElement("Tie");a.attributes.set("origin",e.isTieOrigin?"true":"false"),a.attributes.set("destination",e.isTieDestination?"true":"false")}switch(e.vibrato){case ke.Slight:s.addElement("Vibrato").innerText="Slight";break;case ke.Wide:s.addElement("Vibrato").innerText="Wide"}if(e.isFingering){switch(e.leftHandFinger){case Q.Thumb:s.addElement("LeftFingering").innerText="P";break;case Q.IndexFinger:s.addElement("LeftFingering").innerText="I";break;case Q.MiddleFinger:s.addElement("LeftFingering").innerText="M";break;case Q.AnnularFinger:s.addElement("LeftFingering").innerText="A";break;case Q.LittleFinger:s.addElement("LeftFingering").innerText="C"}switch(e.rightHandFinger){case Q.Thumb:s.addElement("RightFingering").innerText="P";break;case Q.IndexFinger:s.addElement("RightFingering").innerText="I";break;case Q.MiddleFinger:s.addElement("RightFingering").innerText="M";break;case Q.AnnularFinger:s.addElement("RightFingering").innerText="A";break;case Q.LittleFinger:s.addElement("RightFingering").innerText="C"}}s.addElement("InstrumentArticulation").innerText=e.percussionArticulation>=0?e.percussionArticulation.toString():"0",e.ornament!==tt.None&&(s.addElement("Ornament").innerText=tt[e.ornament])}writeNoteProperties(t,e){const s=t.addElement("Properties");if(this.writeConcertPitch(s,e),this.writeTransposedPitch(s,e),e.isStringed&&(this.writeSimplePropertyNode(s,"String","String",(e.string-1).toString()),this.writeSimplePropertyNode(s,"Fret","Fret",e.fret.toString()),this.writeSimplePropertyNode(s,"Midi","Number",e.realValue.toString()),e.showStringNumber&&this.writeSimplePropertyNode(s,"ShowStringNumber","Enable",null)),e.isPiano&&(this.writeSimplePropertyNode(s,"Octave","Number",e.octave.toString()),this.writeSimplePropertyNode(s,"Tone","Step",e.tone.toString()),this.writeSimplePropertyNode(s,"Midi","Number",e.realValue.toString())),e.beat.tap&&this.writeSimplePropertyNode(s,"Tapped","Enable",null),e.harmonicType!==Z.None){switch(e.harmonicType){case Z.Natural:this.writeSimplePropertyNode(s,"HarmonicType","HType","Natural");break;case Z.Artificial:this.writeSimplePropertyNode(s,"HarmonicType","HType","Artificial");break;case Z.Pinch:this.writeSimplePropertyNode(s,"HarmonicType","HType","Pinch");break;case Z.Tap:this.writeSimplePropertyNode(s,"HarmonicType","HType","Tap");break;case Z.Semi:this.writeSimplePropertyNode(s,"HarmonicType","HType","Semi");break;case Z.Feedback:this.writeSimplePropertyNode(s,"HarmonicType","HType","Feedback")}0!==e.harmonicValue&&this.writeSimplePropertyNode(s,"HarmonicFret","HFret",e.harmonicValue.toString())}e.isDead&&this.writeSimplePropertyNode(s,"Muted","Enable",null),e.isPalmMute&&this.writeSimplePropertyNode(s,"PalmMuted","Enable",null),e.hasBend&&this.writeBend(s,e),e.isHammerPullOrigin&&this.writeSimplePropertyNode(s,"HopoOrigin","Enable",null),e.isHammerPullDestination&&this.writeSimplePropertyNode(s,"HopoDestination","Enable",null),e.isLeftHandTapped&&this.writeSimplePropertyNode(s,"LeftHandTapped","Enable",null);let i=0;switch(e.slideInType){case ut.IntoFromAbove:i|=32;break;case ut.IntoFromBelow:i|=16}switch(e.slideOutType){case ce.Shift:i|=1;break;case ce.Legato:i|=2;break;case ce.OutDown:i|=4;break;case ce.OutUp:i|=8;break;case ce.PickSlideDown:i|=64;break;case ce.PickSlideUp:i|=128}i>0&&this.writeSimplePropertyNode(s,"Slide","Flags",i.toString())}writeTransposedPitch(t,e){e.isPercussion?this.writePitch(t,"ConcertPitch","C","-1",""):this.writePitchForValue(t,"TransposedPitch",e.displayValueWithoutBend,e.accidentalMode)}writeConcertPitch(t,e){e.isPercussion?this.writePitch(t,"ConcertPitch","C","-1",""):this.writePitchForValue(t,"ConcertPitch",e.realValueWithoutHarmonic,e.accidentalMode)}writePitchForValue(t,e,s,i){let a=0,n=0,o="",h="";const c=()=>{a=s%12,n=s/12|0,o=F.defaultSteps[a],h=F.defaultAccidentals[a]};switch(c(),i){case ge.Default:break;case ge.ForceNone:case ge.ForceNatural:h="";break;case ge.ForceSharp:h="#";break;case ge.ForceDoubleSharp:"#"===h&&(s-=2,c()),h="x";break;case ge.ForceFlat:"#"===h&&(s+=1,c()),h="b";break;case ge.ForceDoubleFlat:"#"===h&&(s+=2,c()),h="bb"}this.writePitch(t,e,o,n.toString(),h)}writePitch(t,e,s,i,a){const n=t.addElement("Property");n.attributes.set("name",e);const o=n.addElement("Pitch");o.addElement("Step").innerText=s,o.addElement("Accidental").innerText=a,o.addElement("Octave").innerText=i}writeBend(t,e){e.hasBend&&e.bendPoints.length<=4&&this.writeStandardBend(t,e.bendPoints)}writeStandardBend(t,e){this.writeSimplePropertyNode(t,"Bended","Enable",null);const s=e[0],i=e[e.length-1];let a,n;switch(e.length){case 4:a=e[1],n=e[2];break;case 3:a=e[1],n=e[1];break;default:a=new R((s.offset+i.offset)/2,(s.value+i.value)/2),n=a}this.writeSimplePropertyNode(t,"BendDestinationOffset","Float",this.toBendOffset(i.offset).toString()),this.writeSimplePropertyNode(t,"BendDestinationValue","Float",this.toBendValue(i.value).toString()),this.writeSimplePropertyNode(t,"BendMiddleOffset1","Float",this.toBendOffset(a.offset).toString()),this.writeSimplePropertyNode(t,"BendMiddleOffset2","Float",this.toBendOffset(n.offset).toString()),this.writeSimplePropertyNode(t,"BendMiddleValue","Float",this.toBendValue(a.value).toString()),this.writeSimplePropertyNode(t,"BendOriginOffset","Float",this.toBendOffset(s.offset).toString()),this.writeSimplePropertyNode(t,"BendOriginValue","Float",this.toBendValue(s.value).toString())}toBendValue(t){return 25*t}toBendOffset(t){return t/R.MaxPosition*100}writeBeatNode(t,e,s){const i=t.addElement("Beat");if(i.attributes.set("id",e.id.toString()),i.addElement("Dynamic").innerText=J[e.dynamics],e.fade!==ct.None&&(i.addElement("Fadding").innerText=ct[e.fade]),e.isTremolo)switch(e.tremoloSpeed){case m.Eighth:i.addElement("Tremolo").innerText="1/2";break;case m.Sixteenth:i.addElement("Tremolo").innerText="1/4";break;case m.ThirtySecond:i.addElement("Tremolo").innerText="1/8"}switch(e.hasChord&&i.addElement("Chord").setCData(e.chordId),e.crescendo!==Ft.None&&(i.addElement("Hairpin").innerText=Ft[e.crescendo]),e.brushType){case V.ArpeggioUp:i.addElement("Arpeggio").innerText="Up";break;case V.ArpeggioDown:i.addElement("Arpeggio").innerText="Down"}switch(e.text&&i.addElement("FreeText").setCData(e.text),e.graceType){case K.OnBeat:case K.BeforeBeat:i.addElement("GraceNotes").innerText=K[e.graceType]}if(e.ottava!==le.Regular&&(i.addElement("Ottavia").innerText=le[e.ottava].substr(1)),e.hasWhammyBar&&this.writeWhammyNode(i,e),e.isLegatoOrigin||e.isLegatoDestination){const a=i.addElement("Legato");a.attributes.set("origin",e.isLegatoOrigin?"true":"false"),a.attributes.set("destination",e.isLegatoDestination?"true":"false")}if(this.writeRhythm(i,e,s),null!==e.preferredBeamDirection)switch(e.preferredBeamDirection){case P.Up:i.addElement("TransposedPitchStemOrientation").innerText="Upward",i.addElement("UserTransposedPitchStemOrientation").innerText="Upward";break;case P.Down:i.addElement("TransposedPitchStemOrientation").innerText="Downward",i.addElement("UserTransposedPitchStemOrientation").innerText="Downward"}i.addElement("ConcertPitchStemOrientation").innerText="Undefined",e.slashed&&i.addElement("Slashed"),e.deadSlapped&&i.addElement("DeadSlapped"),e.notes.length>0&&(i.addElement("Notes").innerText=e.notes.map(a=>a.id).join(" ")),e.golpe!==Gt.None&&(i.addElement("Golpe").innerText=Gt[e.golpe]),e.wahPedal!==Jt.None&&(i.addElement("Wah").innerText=Jt[e.wahPedal]),e.showTimer&&(i.addElement("Timer").innerText=(e.timer??0).toString()),this.writeBeatProperties(i,e),this.writeBeatXProperties(i,e),e.lyrics&&e.lyrics.length>0&&this.writeBeatLyrics(i,e.lyrics)}writeBeatLyrics(t,e){const s=t.addElement("Lyrics");for(const i of e)s.addElement("Line").setCData(i)}writeBeatXProperties(t,e){const s=t.addElement("XProperties");switch(e.brushDuration>0&&this.writeSimpleXPropertyNode(s,"687935489","Int",e.brushDuration.toString()),e.beamingMode){case ze.ForceSplitToNext:this.writeSimpleXPropertyNode(s,"1124204546","Int","2");break;case ze.ForceMergeWithNext:this.writeSimpleXPropertyNode(s,"1124204546","Int","1");break;case ze.ForceSplitOnSecondaryToNext:this.writeSimpleXPropertyNode(s,"1124204552","Int","1")}}writeBeatProperties(t,e){const s=t.addElement("Properties");switch(e.brushType){case V.BrushUp:this.writeSimplePropertyNode(s,"Brush","Direction","Up");break;case V.BrushDown:this.writeSimplePropertyNode(s,"Brush","Direction","Down")}switch(e.pickStroke){case yt.Up:this.writeSimplePropertyNode(s,"PickStroke","Direction","Up");break;case yt.Down:this.writeSimplePropertyNode(s,"PickStroke","Direction","Down")}switch(e.slap&&this.writeSimplePropertyNode(s,"Slapped","Enable",null),e.pop&&this.writeSimplePropertyNode(s,"Popped","Enable",null),e.vibrato){case ke.Wide:this.writeSimplePropertyNode(s,"VibratoWTremBar","Strength","Wide");break;case ke.Slight:this.writeSimplePropertyNode(s,"VibratoWTremBar","Strength","Slight")}if(e.isBarre)switch(this.writeSimplePropertyNode(s,"BarreFret","Fret",e.barreFret.toString()),e.barreShape){case qt.Full:this.writeSimplePropertyNode(s,"BarreString","String","0");break;case qt.Half:this.writeSimplePropertyNode(s,"BarreString","String","1")}if(e.rasgueado!==G.None){let i="";switch(e.rasgueado){case G.Ii:i="ii_1";break;case G.Mi:i="mi_1";break;case G.MiiTriplet:i="mii_1";break;case G.MiiAnapaest:i="mii_2";break;case G.PmpTriplet:i="pmp_1";break;case G.PmpAnapaest:i="pmp_2";break;case G.PeiTriplet:i="pei_1";break;case G.PeiAnapaest:i="pei_2";break;case G.PaiTriplet:i="pai_1";break;case G.PaiAnapaest:i="pai_2";break;case G.AmiTriplet:i="ami_1";break;case G.AmiAnapaest:i="ami_2";break;case G.Ppp:i="ppp_1";break;case G.Amii:i="amii_1";break;case G.Amip:i="amip_1";break;case G.Eami:i="eami_1";break;case G.Eamii:i="eamii_1";break;case G.Peami:i="peami_1"}this.writeSimplePropertyNode(s,"Rasgueado","Rasgueado",i)}}writeRhythm(t,e,s){const i=`${e.duration}_${e.dots}_${e.tupletNumerator}_${e.tupletDenominator}';`;let a;if(this._rhythmIdLookup.has(i))a=this._rhythmIdLookup.get(i);else{a=this._rhythmIdLookup.size.toString(),this._rhythmIdLookup.set(i,a);const n=s.addElement("Rhythm");if(n.attributes.set("id",a),e.hasTuplet){const h=n.addElement("PrimaryTuplet");h.attributes.set("num",e.tupletNumerator.toString()),h.attributes.set("den",e.tupletDenominator.toString())}e.dots>0&&n.addElement("AugmentationDot").attributes.set("count",e.dots.toString());let o="Quarter";switch(e.duration){case m.QuadrupleWhole:o="Long";break;case m.DoubleWhole:o="DoubleWhole";break;case m.Whole:o="Whole";break;case m.Half:o="Half";break;case m.Quarter:o="Quarter";break;case m.Eighth:o="Eighth";break;case m.Sixteenth:o="16th";break;case m.ThirtySecond:o="32nd";break;case m.SixtyFourth:o="64th";break;case m.OneHundredTwentyEighth:o="128th";break;case m.TwoHundredFiftySixth:o="256th"}n.addElement("NoteValue").innerText=o}t.addElement("Rhythm").attributes.set("ref",a)}writeWhammyNode(t,e){e.hasWhammyBar&&e.whammyBarPoints.length<=4&&this.writeStandardWhammy(t,e.whammyBarPoints)}writeStandardWhammy(t,e){const s=t.addElement("Whammy"),i=e[0],a=e[e.length-1];let n,o;switch(e.length){case 4:n=e[1],o=e[2];break;case 3:n=e[1],o=e[1];break;default:n=new R((i.offset+a.offset)/2,(i.value+a.value)/2),o=n}s.attributes.set("destinationOffset",this.toBendOffset(a.offset).toString()),s.attributes.set("destinationValue",this.toBendValue(a.value).toString()),s.attributes.set("middleOffset1",this.toBendOffset(n.offset).toString()),s.attributes.set("middleOffset2",this.toBendOffset(o.offset).toString()),s.attributes.set("middleValue",this.toBendValue(n.value).toString()),s.attributes.set("originOffset",this.toBendOffset(i.offset).toString()),s.attributes.set("originValue",this.toBendValue(i.value).toString())}writeScoreNode(t,e){const s=t.addElement("Score");s.addElement("Title").setCData(e.title),s.addElement("SubTitle").setCData(e.subTitle),s.addElement("Artist").setCData(e.artist),s.addElement("Album").setCData(e.album),s.addElement("Words").setCData(e.words),s.addElement("Music").setCData(e.music),s.addElement("WordsAndMusic").setCData(e.words===e.music?e.words:""),s.addElement("Copyright").setCData(e.copyright),s.addElement("Tabber").setCData(e.tab),s.addElement("Instructions").setCData(e.instructions),s.addElement("Notices").setCData(e.notices),s.addElement("FirstPageHeader").setCData(""),s.addElement("FirstPageFooter").setCData(""),s.addElement("PageHeader").setCData(""),s.addElement("PageFooter").setCData(""),s.addElement("ScoreSystemsDefaultLayout").setCData(e.defaultSystemsLayout.toString()),s.addElement("ScoreSystemsLayout").setCData(e.systemsLayout.join(" ")),s.addElement("ScoreZoomPolicy").innerText="Value",s.addElement("ScoreZoom").innerText="1",s.addElement("MultiVoice").innerText="1>"}writeMasterTrackNode(t,e){const s=t.addElement("MasterTrack");s.addElement("Tracks").innerText=e.tracks.map(h=>h.index).join(" ");const i=s.addElement("Automations");if(e.masterBars.length>0&&e.masterBars[0].isAnacrusis&&s.addElement("Anacrusis"),0===e.masterBars[0].tempoAutomations.length){const h=i.addElement("Automation");h.addElement("Type").innerText="Tempo",h.addElement("Linear").innerText="false",h.addElement("Bar").innerText="0",h.addElement("Position").innerText="0",h.addElement("Visible").innerText="true",h.addElement("Value").innerText=`${e.tempo} 2`,e.tempoLabel&&(h.addElement("Text").innerText=e.tempoLabel)}const a=e.masterBars[0].syncPoints?e.masterBars[0].syncPoints.find(h=>0===h.ratioPosition&&0===h.syncPointValue.barOccurence):void 0,n=a?a.syncPointValue.millisecondOffset:0;this.backingTrackFramePadding=n/1e3*Xt.SampleRate*-1|0;const o=new Ji(()=>ne.buildModifiedTempoLookup(e));for(const h of e.masterBars){for(const c of h.tempoAutomations){const d=i.addElement("Automation");d.addElement("Type").innerText="Tempo",d.addElement("Linear").innerText=c.isLinear?"true":"false",d.addElement("Bar").innerText=h.index.toString(),d.addElement("Position").innerText=c.ratioPosition.toString(),d.addElement("Visible").innerText="true",d.addElement("Value").innerText=`${c.value} 2`,c.text&&(d.addElement("Text").innerText=c.text)}if(h.syncPoints)for(const c of h.syncPoints){const d=i.addElement("Automation");d.addElement("Type").innerText="SyncPoint",d.addElement("Linear").innerText="false",d.addElement("Bar").innerText=h.index.toString(),d.addElement("Position").innerText=c.ratioPosition.toString(),d.addElement("Visible").innerText="true";const u=d.addElement("Value");u.addElement("BarIndex").innerText=h.index.toString(),u.addElement("BarOccurrence").innerText=c.syncPointValue.barOccurence.toString(),u.addElement("ModifiedTempo").innerText=o.value.get(c).syncBpm.toString(),u.addElement("OriginalTempo").innerText=e.tempo.toString();let f=(c.syncPointValue.millisecondOffset-n)/1e3*Xt.SampleRate;f=Math.floor(f+.5),u.addElement("FrameOffset").innerText=f.toString()}}}writeAudioTracksNode(t,e){t.addElement("AudioTracks")}writeTracksNode(t,e){const s=t.addElement("Tracks");for(const i of e.tracks)this.writeTrackNode(s,i)}writeTrackNode(t,e){const s=t.addElement("Track");s.attributes.set("id",e.index.toString()),s.addElement("Name").setCData(e.name),s.addElement("ShortName").setCData(e.shortName),s.addElement("Color").innerText=`${e.color.r} ${e.color.g} ${e.color.b}`,s.addElement("SystemsDefautLayout").innerText=e.defaultSystemsLayout.toString(),s.addElement("SystemsLayout").innerText=e.systemsLayout.join(" "),s.addElement("AutoBrush"),s.addElement("PalmMute").innerText="0",s.addElement("PlayingStyle").innerText=Wt.isGuitar(e.playbackInfo.program)?"StringedPick":"Default",s.addElement("UseOneChannelPerString"),s.addElement("IconId").innerText=Xt.getIconId(e.playbackInfo).toString(),this.writeInstrumentSetNode(s,e),this.writeTransposeNode(s,e),this.writeRseNode(s,e),s.addElement("ForcedSound").innerText="-1",this.writeMidiConnectionNode(s,e),s.addElement("PlaybackState").innerText=e.playbackInfo.isSolo?"Solo":e.playbackInfo.isMute?"Mute":"Default",s.addElement("AudioEngineState").innerText="MIDI",this.writeLyricsNode(s,e),this.writeStavesNode(s,e),this.writeSoundsAndAutomations(s,e)}static getIconId(t){return 9===t.primaryChannel?Xt.DrumKitProgramInfo.icon:Xt.MidiProgramInfoLookup.has(t.program)?Xt.MidiProgramInfoLookup.get(t.program).icon:v.SteelGuitar}writeSoundAndAutomation(t,e,s,i,a,n,o,h=0){const c=t.addElement("Sound");c.addElement("Name").setCData(s),c.addElement("Label").setCData(s),c.addElement("Path").setCData(i),c.addElement("Role").setCData(a);const d=c.addElement("MIDI");d.addElement("LSB").innerText="0",d.addElement("MSB").innerText="0",d.addElement("Program").innerText=o.toString();const u=e.addElement("Automation");u.addElement("Type").innerText="Sound",u.addElement("Linear").innerText="false",u.addElement("Bar").innerText=n.toString(),u.addElement("Position").innerText=h.toString(),u.addElement("Visible").innerText="true",u.addElement("Value").setCData(`${i};${s};${a}`)}writeSoundsAndAutomations(t,e){const s=t.addElement("Sounds"),i=t.addElement("Automations");if(e.staves.length>0&&e.staves[0].bars.length>0){const a=`Track_${e.index}_Initial`,n=`Midi/${e.playbackInfo.program}`,o="Factory";let h=!1;for(const c of e.staves)for(const d of c.bars)for(const u of d.voices)for(const f of u.beats){const p=f.getAutomation(Ge.Instrument),g=0===d.index&&0===f.index;if(p){const b=g?a:`ProgramChange_${f.id}`,w=g?n:`Midi/${p.value}`,S=g?o:"User";!g&&!h&&(this.writeSoundAndAutomation(s,i,a,n,o,e.staves[0].bars[0].index,e.playbackInfo.program),h=!0),this.writeSoundAndAutomation(s,i,b,w,S,d.index,p.value,p.ratioPosition),g&&(h=!0)}}}for(const a of e.staves)for(const n of a.bars)for(const o of n.sustainPedals)if(o.pedalType!==rt.Hold){const h=i.addElement("Automation");switch(h.addElement("Type").innerText="SustainPedal",h.addElement("Linear").innerText="false",h.addElement("Bar").innerText=n.index.toString(),h.addElement("Position").innerText=o.ratioPosition.toString(),h.addElement("Visible").innerText="true",o.pedalType){case rt.Down:h.addElement("Value").innerText="0 1";break;case rt.Up:h.addElement("Value").innerText="0 3"}}}writeMidiConnectionNode(t,e){const s=t.addElement("MidiConnection");s.addElement("Port").innerText=e.playbackInfo.port.toString(),s.addElement("PrimaryChannel").innerText=e.playbackInfo.primaryChannel.toString(),s.addElement("SecondaryChannel").innerText=e.playbackInfo.secondaryChannel.toString(),s.addElement("ForeOneChannelPerString").innerText="false"}writeRseNode(t,e){const i=t.addElement("RSE").addElement("ChannelStrip");i.attributes.set("version","E56"),i.addElement("Parameters").innerText=`0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 1 0.5 ${e.playbackInfo.balance/16} ${e.playbackInfo.volume/16} 0.5 0.5 0.5`}writeStavesNode(t,e){const s=t.addElement("Staves");for(const i of e.staves)this.writeStaffNode(s,i)}writeStaffNode(t,e){const i=t.addElement("Staff").addElement("Properties");if(this.writeSimplePropertyNode(i,"CapoFret","Fret",e.capo.toString()),this.writeSimplePropertyNode(i,"FretCount","Fret","24"),e.tuning.length>0){const a=i.addElement("Property");switch(a.attributes.set("name","Tuning"),a.addElement("Pitches").innerText=e.tuning.slice().reverse().join(" "),a.addElement("Label").setCData(e.tuningName),a.addElement("LabelVisible").innerText=e.tuningName?"true":"false",a.addElement("Flat"),e.tuning.length){case 3:a.addElement("Instrument").innerText="Shamisen";break;case 4:a.addElement("Instrument").innerText=105===e.track.playbackInfo.program?"Banjo":42===e.track.playbackInfo.program?"Cello":43===e.track.playbackInfo.program?"Contrabass":40===e.track.playbackInfo.program?"Violin":41===e.track.playbackInfo.program?"Viola":"Bass";break;case 5:a.addElement("Instrument").innerText=105===e.track.playbackInfo.program?"Banjo":"Bass";break;case 6:a.addElement("Instrument").innerText=105===e.track.playbackInfo.program?"Banjo":e.track.playbackInfo.program<=39?"Bass":"Guitar";break;case 7:a.addElement("Instrument").innerText=e.track.playbackInfo.program<=39?"Bass":"Guitar";break;default:a.addElement("Instrument").innerText="Guitar"}}this.writeSimplePropertyNode(i,"PartialCapoFret","Fret","0"),this.writeSimplePropertyNode(i,"PartialCapoStringFlags","Bitset",e.tuning.map(a=>"0").join("")),this.writeSimplePropertyNode(i,"TuningFlat","Enable",null),this.writeDiagramCollection(i,e,"DiagramCollection"),this.writeDiagramCollection(i,e,"DiagramWorkingSet")}writeDiagramCollection(t,e,s){const i=t.addElement("Property");i.attributes.set("name",s);const a=i.addElement("Items"),n=e.chords;if(n)for(const[o,h]of n){const c=a.addElement("Item");c.attributes.set("id",o),c.attributes.set("name",h.name);const d=c.addElement("Diagram");d.attributes.set("stringCount",h.strings.length.toString()),d.attributes.set("fretCount","5"),d.attributes.set("baseFret",(h.firstFret-1).toString()),d.attributes.set("barStates",h.strings.map(E=>"1").join(" "));const u=[],f=new Map;for(let E=0;E<h.strings.length;E++){const B=h.strings[E];if(-1!==B){const ie=d.addElement("Fret"),Re=h.strings.length-1-E;ie.attributes.set("string",Re.toString()),ie.attributes.set("fret",(B-h.firstFret+1).toString()),f.has(B)||(f.set(B,[]),u.push(B)),f.get(B).push(Re)}}u.sort();const p=d.addElement("Fingering");if(h.barreFrets.length>0){const E=[Q.LittleFinger,Q.AnnularFinger,Q.MiddleFinger,Q.IndexFinger];for(const B of u){const ie=f.get(B);if(ie.length>1&&h.barreFrets.indexOf(B)>=0){const Re=E.length>0?E.pop():Q.IndexFinger;for(const Ne of ie){const ee=p.addElement("Position");switch(Re){case Q.LittleFinger:ee.attributes.set("finger","Pinky");break;case Q.AnnularFinger:ee.attributes.set("finger","Ring");break;case Q.MiddleFinger:ee.attributes.set("finger","Middle");break;case Q.IndexFinger:ee.attributes.set("finger","Index")}ee.attributes.set("fret",(B-h.firstFret+1).toString()),ee.attributes.set("string",Ne.toString())}}}}const g=d.addElement("Property");g.attributes.set("name","ShowName"),g.attributes.set("type","bool"),g.attributes.set("value",h.showName?"true":"false");const b=d.addElement("Property");b.attributes.set("name","ShowDiagram"),b.attributes.set("type","bool"),b.attributes.set("value",h.showDiagram?"true":"false");const w=d.addElement("Property");w.attributes.set("name","ShowFingering"),w.attributes.set("type","bool"),w.attributes.set("value",h.showFingering?"true":"false");const S=d.addElement("Chord"),D=S.addElement("KeyNote");D.attributes.set("step","C"),D.attributes.set("accidental","Natural");const N=S.addElement("BassNote");N.attributes.set("step","C"),N.attributes.set("accidental","Natural");const L=S.addElement("Degree");L.attributes.set("interval","Third"),L.attributes.set("alteration","Major"),L.attributes.set("omitted","false");const $=S.addElement("Degree");$.attributes.set("interval","Fifth"),$.attributes.set("alteration","Perfect"),$.attributes.set("omitted","false")}}writeSimplePropertyNode(t,e,s,i){const a=t.addElement("Property");a.attributes.set("name",e);const n=a.addElement(s);return null!==i&&(n.innerText=i),a}writeSimpleXPropertyNode(t,e,s,i){const a=t.addElement("XProperty");a.attributes.set("id",e);const n=a.addElement(s);return null!==i&&(n.innerText=i),a}writeLyricsNode(t,e){const s=t.addElement("Lyrics");s.attributes.set("dispatched","true");const i=[];for(const a of e.staves[0].bars)for(const n of a.voices)if(!n.isEmpty)for(const o of n.beats)if(o.lyrics)for(let h=0;h<o.lyrics.length;h++){for(;h>=i.length;){const d=new Li;d.startBar=a.index,d.text="[Empty]",i.push(d)}const c=i[h];c.text="[Empty]"===c.text?o.lyrics[h]:`${c.text} ${o.lyrics[h].split(" ").join("+")}`}for(let a=0;a<i.length;a++){const n=s.addElement("Line");n.addElement("Text").setCData(i[a].text),n.addElement("Offset").innerText=i[a].startBar.toString()}}writeTransposeNode(t,e){const s=t.addElement("Transpose"),i=Math.floor(e.staves[0].displayTranspositionPitch/12),a=e.staves[0].displayTranspositionPitch-12*i;s.addElement("Chromatic").innerText=a.toString(),s.addElement("Octave").innerText=i.toString()}writeInstrumentSetNode(t,e){const s=t.addElement("InstrumentSet"),i=e.staves[0];if(s.addElement("LineCount").innerText=i.standardNotationLineCount.toString(),e.percussionArticulations.length>0||i.isPercussion){const a=e.percussionArticulations.length>0?e.percussionArticulations:Array.from(ht.instrumentArticulations.values());s.addElement("Name").innerText=Xt.DrumKitProgramInfo.instrumentSetName,s.addElement("Type").innerText=Xt.DrumKitProgramInfo.instrumentSetType;let n="",o=new rs;const h=new Map,c=s.addElement("Elements");for(const d of a){{const f=c.addElement("Element");let p=d.elementType;if(h.has(p)){const g=h.get(p);p+=` ${g}`,h.set(p,g+1)}else h.set(p,1);n=p,f.addElement("Name").innerText=p,f.addElement("Type").innerText=d.elementType,o=f.addElement("Articulations")}const u=o.addElement("Articulation");switch(u.addElement("Name").innerText=`${n} ${o.childNodes.length}`,u.addElement("StaffLine").innerText=d.staffLine.toString(),u.addElement("Noteheads").innerText=[this.mapMusicSymbol(d.noteHeadDefault),this.mapMusicSymbol(d.noteHeadHalf),this.mapMusicSymbol(d.noteHeadWhole)].join(" "),d.techniqueSymbolPlacement){case re.Top:u.addElement("TechniquePlacement").innerText="below";break;case re.Middle:u.addElement("TechniquePlacement").innerText="inside";break;case re.Bottom:u.addElement("TechniquePlacement").innerText="above"}u.addElement("TechniqueSymbol").innerText=this.mapMusicSymbol(d.techniqueSymbol),u.addElement("InputMidiNumbers").innerText="",u.addElement("OutputMidiNumber").innerText=d.outputMidiNumber.toString()}}else{const a=Xt.MidiProgramInfoLookup.has(e.playbackInfo.program)?Xt.MidiProgramInfoLookup.get(e.playbackInfo.program):Xt.MidiProgramInfoLookup.get(0);s.addElement("Name").innerText=a.instrumentSetName,s.addElement("Type").innerText=a.instrumentSetType;const o=s.addElement("Elements").addElement("Element");o.addElement("Pitched").innerText="Pitched",o.addElement("Type").innerText="pitched",o.addElement("SoundbankName").innerText="";const c=o.addElement("Articulations").addElement("Articulation");c.addElement("Name").innerText="",c.addElement("StaffLine").innerText="0",c.addElement("Noteheads").innerText="noteheadBlack noteheadHalf noteheadWhole",c.addElement("TechniquePlacement").innerText="outside",c.addElement("TechniqueSymbol").innerText="",c.addElement("InputMidiNumbers").innerText="",c.addElement("OutputRSESound").innerText="",c.addElement("OutputMidiNumber").innerText="0"}}mapMusicSymbol(t){if(t===l.None)return"";const e=l[t];return e.substring(0,1).toLowerCase()+e.substring(1)}writeMasterBarsNode(t,e){const s=t.addElement("MasterBars");for(const i of e.masterBars)this.writeMasterBarNode(s,i)}writeMasterBarNode(t,e){const s=t.addElement("MasterBar"),i=s.addElement("Key");i.addElement("AccidentalCount").innerText=e.keySignature.toString(),i.addElement("Mode").innerText=It[e.keySignatureType],i.addElement("Sharps").innerText="Sharps",s.addElement("Time").innerText=`${e.timeSignatureNumerator}/${e.timeSignatureDenominator}`,e.isFreeTime&&s.addElement("FreeTime");const a=[];for(const n of e.score.tracks)for(const o of n.staves)a.push(o.bars[e.index].id.toString());if(s.addElement("Bars").innerText=a.join(" "),e.isDoubleBar&&s.addElement("DoubleBar"),e.isSectionStart){const n=s.addElement("Section");n.addElement("Letter").setCData(e.section.marker),n.addElement("Text").setCData(e.section.text)}if(e.isRepeatStart||e.isRepeatEnd){const n=s.addElement("Repeat");n.attributes.set("start",e.isRepeatStart?"true":"false"),n.attributes.set("end",e.isRepeatEnd?"true":"false"),e.isRepeatEnd&&n.attributes.set("count",e.repeatCount.toString())}if(e.alternateEndings>0){let n=e.alternateEndings;const o=[];let h=0;for(;n>0;)1==(n>>h&1)&&(o.push(h+1),n&=~(1<<h)),h++;s.addElement("AlternateEndings").innerText=o.join(" ")}if(e.tripletFeel!==ue.NoTripletFeel&&(s.addElement("TripletFeel").innerText=ue[e.tripletFeel]),e.directions&&e.directions.size>0){const n=s.addElement("Directions");for(const o of e.directions)switch(o){case I.TargetFine:n.addElement("Target").innerText="Fine";break;case I.TargetSegno:n.addElement("Target").innerText="Segno";break;case I.TargetSegnoSegno:n.addElement("Target").innerText="SegnoSegno";break;case I.TargetCoda:n.addElement("Target").innerText="Coda";break;case I.TargetDoubleCoda:n.addElement("Target").innerText="DoubleCoda";break;case I.JumpDaCapo:n.addElement("Jump").innerText="DaCapo";break;case I.JumpDaCapoAlCoda:n.addElement("Jump").innerText="DaCapoAlCoda";break;case I.JumpDaCapoAlDoubleCoda:n.addElement("Jump").innerText="DaCapoAlDoubleCoda";break;case I.JumpDaCapoAlFine:n.addElement("Jump").innerText="DaCapoAlFine";break;case I.JumpDalSegno:n.addElement("Jump").innerText="DaSegno";break;case I.JumpDalSegnoAlCoda:n.addElement("Jump").innerText="DaSegnoAlCoda";break;case I.JumpDalSegnoAlDoubleCoda:n.addElement("Jump").innerText="DaSegnoAlDoubleCoda";break;case I.JumpDalSegnoAlFine:n.addElement("Jump").innerText="DaSegnoAlFine";break;case I.JumpDalSegnoSegno:n.addElement("Jump").innerText="DaSegnoSegno";break;case I.JumpDalSegnoSegnoAlCoda:n.addElement("Jump").innerText="DaSegnoSegnoAlCoda";break;case I.JumpDalSegnoSegnoAlDoubleCoda:n.addElement("Jump").innerText="DaSegnoSegnoAlDoubleCoda";break;case I.JumpDalSegnoSegnoAlFine:n.addElement("Jump").innerText="DaSegnoSegnoAlFine";break;case I.JumpDaCoda:n.addElement("Jump").innerText="DaCoda";break;case I.JumpDaDoubleCoda:n.addElement("Jump").innerText="DaDoubleCoda"}}this.writeFermatas(s,e)}writeFermatas(t,e){const s=e.fermata?.size??0;if(0!==s&&s>0){const i=t.addElement("Fermatas");for(const[a,n]of e.fermata)this.writeFermata(i,a,n)}}writeFermata(t,e,s){let i=-1,a=1;if(e>0)for(;a<10&&(i=e/C.QuarterTime*a,i!==Math.floor(i));)i=-1,a++;else i=0,a=1;if(-1===i)return;const n=t.addElement("Fermata");n.addElement("Type").innerText=Ct[s.type],n.addElement("Length").innerText=s.length.toString(),n.addElement("Offset").innerText=`${i}/${a}`}writeBarNode(t,e){const s=t.addElement("Bar");s.attributes.set("id",e.id.toString()),s.addElement("Voices").innerText=e.voices.map(i=>i.isEmpty?"-1":i.id.toString()).join(" "),s.addElement("Clef").innerText=Se[e.clef],e.clefOttava!==le.Regular&&(s.addElement("Ottavia").innerText=le[e.clefOttava].substr(1)),e.simileMark!==je.None&&(s.addElement("SimileMark").innerText=je[e.simileMark])}writeVoiceNode(t,e){if(e.isEmpty)return;const s=t.addElement("Voice");s.attributes.set("id",e.id.toString()),s.addElement("Beats").innerText=e.beats.map(i=>i.id).join(" ")}}Xt.SampleRate=44100,Xt.MidiProgramInfoLookup=new Map([[0,new A(v.Piano,"Acoustic Piano")],[1,new A(v.Piano,"Acoustic Piano")],[2,new A(v.Piano,"Electric Piano")],[3,new A(v.Piano,"Acoustic Piano")],[4,new A(v.Piano,"Electric Piano")],[5,new A(v.Piano,"Electric Piano")],[6,new A(v.Piano,"Harpsichord")],[7,new A(v.Piano,"Harpsichord")],[8,new A(v.PitchedIdiophone,"Celesta")],[9,new A(v.PitchedIdiophone,"Vibraphone")],[10,new A(v.PitchedIdiophone,"Vibraphone")],[11,new A(v.PitchedIdiophone,"Vibraphone")],[12,new A(v.PitchedIdiophone,"Xylophone")],[13,new A(v.PitchedIdiophone,"Xylophone")],[14,new A(v.PitchedIdiophone,"Vibraphone")],[15,new A(v.Banjo,"Banjo")],[16,new A(v.Piano,"Electric Organ")],[17,new A(v.Piano,"Electric Organ")],[18,new A(v.Piano,"Electric Organ")],[19,new A(v.Piano,"Electric Organ")],[20,new A(v.Piano,"Electric Organ")],[21,new A(v.Piano,"Electric Organ")],[22,new A(v.Woodwind,"Recorder")],[23,new A(v.Piano,"Electric Organ")],[24,new A(v.ClassicalGuitar,"Nylon Guitar")],[25,new A(v.SteelGuitar,"Steel Guitar")],[26,new A(v.SteelGuitar,"Electric Guitar")],[27,new A(v.ElectricGuitar,"Electric Guitar")],[28,new A(v.ElectricGuitar,"Electric Guitar")],[29,new A(v.ElectricGuitar,"Electric Guitar")],[30,new A(v.SteelGuitar,"Electric Guitar")],[31,new A(v.SteelGuitar,"Electric Guitar")],[32,new A(v.Bass,"Acoustic Bass")],[33,new A(v.Bass,"Electric Bass")],[34,new A(v.Bass,"Electric Bass")],[35,new A(v.Bass,"Acoustic Bass")],[36,new A(v.Bass,"Electric Bass")],[37,new A(v.Bass,"Electric Bass")],[38,new A(v.Synth,"Synth Bass")],[39,new A(v.Synth,"Synth Bass")],[40,new A(v.Strings,"Violin")],[41,new A(v.Strings,"Viola")],[42,new A(v.Strings,"Cello")],[43,new A(v.Strings,"Contrabass")],[44,new A(v.Strings,"Violin")],[45,new A(v.Strings,"Violin")],[46,new A(v.Piano,"Harp")],[47,new A(v.Membraphone,"Timpani")],[48,new A(v.Strings,"Violin")],[49,new A(v.Strings,"Violin")],[50,new A(v.Strings,"Violin")],[51,new A(v.Strings,"Violin")],[52,new A(v.Vocal,"Voice")],[53,new A(v.Vocal,"Voice")],[54,new A(v.Vocal,"Voice")],[55,new A(v.Synth,"Pad Synthesizer")],[56,new A(v.Brass,"Trumpet")],[57,new A(v.Brass,"Trombone")],[58,new A(v.Brass,"Tuba")],[59,new A(v.Brass,"Trumpet")],[60,new A(v.Brass,"French Horn")],[61,new A(v.Brass,"Trumpet")],[62,new A(v.Brass,"Trumpet")],[63,new A(v.Brass,"Trumpet")],[64,new A(v.Reed,"Saxophone")],[65,new A(v.Reed,"Saxophone")],[66,new A(v.Reed,"Saxophone")],[67,new A(v.Reed,"Saxophone")],[68,new A(v.Reed,"Oboe")],[69,new A(v.Reed,"English Horn")],[70,new A(v.Reed,"Bassoon")],[71,new A(v.Reed,"Clarinet")],[72,new A(v.Reed,"Piccolo")],[73,new A(v.Woodwind,"Flute")],[74,new A(v.Woodwind,"Recorder")],[75,new A(v.Woodwind,"Flute")],[76,new A(v.Woodwind,"Recorder")],[77,new A(v.Woodwind,"Flute")],[78,new A(v.Woodwind,"Recorder")],[79,new A(v.Woodwind,"Flute")],[80,new A(v.Synth,"Lead Synthesizer")],[81,new A(v.Synth,"Lead Synthesizer")],[82,new A(v.Synth,"Lead Synthesizer")],[83,new A(v.Synth,"Lead Synthesizer")],[84,new A(v.Synth,"Lead Synthesizer")],[85,new A(v.Synth,"Lead Synthesizer")],[86,new A(v.Synth,"Lead Synthesizer")],[87,new A(v.Synth,"Lead Synthesizer")],[88,new A(v.Synth,"Pad Synthesizer")],[89,new A(v.Synth,"Pad Synthesizer")],[90,new A(v.Synth,"Pad Synthesizer")],[91,new A(v.Synth,"Pad Synthesizer")],[92,new A(v.Synth,"Pad Synthesizer")],[93,new A(v.Synth,"Pad Synthesizer")],[94,new A(v.Synth,"Pad Synthesizer")],[95,new A(v.Synth,"Pad Synthesizer")],[96,new A(v.Fx,"Pad Synthesizer")],[97,new A(v.Fx,"Pad Synthesizer")],[98,new A(v.Fx,"Pad Synthesizer")],[99,new A(v.Fx,"Pad Synthesizer")],[100,new A(v.Fx,"Lead Synthesizer")],[101,new A(v.Fx,"Lead Synthesizer")],[102,new A(v.Fx,"Lead Synthesizer")],[103,new A(v.Fx,"Trumpet")],[104,new A(v.ElectricGuitar,"Banjo")],[105,new A(v.Banjo,"Banjo")],[106,new A(v.Ukulele,"Ukulele")],[107,new A(v.Banjo,"Banjo")],[108,new A(v.PitchedIdiophone,"Xylophone")],[109,new A(v.Reed,"Bassoon")],[110,new A(v.Strings,"Violin")],[111,new A(v.Woodwind,"Flute")],[112,new A(v.PitchedIdiophone,"Xylophone")],[113,new A(v.Idiophone,"Celesta")],[114,new A(v.PitchedIdiophone,"Vibraphone")],[115,new A(v.Idiophone,"Xylophone")],[116,new A(v.Membraphone,"Xylophone")],[117,new A(v.Membraphone,"Xylophone")],[118,new A(v.Membraphone,"Xylophone")],[119,new A(v.Idiophone,"Celesta")],[120,new A(v.Fx,"Steel Guitar")],[121,new A(v.Fx,"Recorder")],[122,new A(v.Fx,"Recorder")],[123,new A(v.Fx,"Recorder")],[124,new A(v.Fx,"Recorder")],[125,new A(v.Fx,"Recorder")],[126,new A(v.Fx,"Recorder")],[127,new A(v.Fx,"Timpani")]]),Xt.DrumKitProgramInfo=new A(v.PercussionKit,"Drums","drumKit");class $s{static buildCrc32Lookup(){const e=new Uint32Array(256);for(let s=0;s<e.length;s++){let i=s;for(let a=0;a<8;a++)i=1&~i?i>>>1:i>>>1^3988292384;e[s]=i}return e}get value(){return~this._checkValue}constructor(){this._checkValue=$s.CrcInit,this.reset()}update(t,e,s){for(let i=0;i<s;i++)this._checkValue=$s.Crc32Lookup[255&(this._checkValue^t[e+i])]^this._checkValue>>>8}reset(){this._checkValue=$s.CrcInit}}$s.Crc32Lookup=$s.buildCrc32Lookup(),$s.CrcInit=4294967295;class se{}se.MAX_WBITS=15,se.WSIZE=1<<se.MAX_WBITS,se.WMASK=se.WSIZE-1,se.MIN_MATCH=3,se.MAX_MATCH=258,se.DEFAULT_MEM_LEVEL=8,se.PENDING_BUF_SIZE=1<<se.DEFAULT_MEM_LEVEL+8,se.HASH_BITS=se.DEFAULT_MEM_LEVEL+7,se.HASH_SIZE=1<<se.HASH_BITS,se.HASH_SHIFT=(se.HASH_BITS+se.MIN_MATCH-1)/se.MIN_MATCH,se.HASH_MASK=se.HASH_SIZE-1,se.MIN_LOOKAHEAD=se.MAX_MATCH+se.MIN_MATCH+1,se.MAX_DIST=se.WSIZE-se.MIN_LOOKAHEAD;let In=(()=>{class r{constructor(e,s,i,a){this.length=null,this.numCodes=0,this.codes=null,this.huffman=e,this.minNumCodes=i,this.maxLength=a,this.freqs=new Int16Array(s),this.bitLengthCounts=new Int32Array(a)}reset(){for(let e=0;e<this.freqs.length;e++)this.freqs[e]=0;this.codes=null,this.length=null}buildTree(){const e=this.freqs.length,s=new Int32Array(e);let i=0,a=0;for(let d=0;d<e;d++){const u=this.freqs[d];if(0!==u){let f=i++;for(;f>0;){const p=Math.floor((f-1)/2);if(!(this.freqs[s[p]]>u))break;s[f]=s[p],f=p}s[f]=d,a=d}}for(;i<2;){const d=a<2?++a:0;s[i++]=d}this.numCodes=Math.max(a+1,this.minNumCodes);const n=i,o=new Int32Array(4*i-2),h=new Int32Array(2*i-1);let c=n;for(let d=0;d<i;d++){const u=s[d];o[2*d]=u,o[2*d+1]=-1,h[d]=this.freqs[u]<<8,s[d]=d}do{const d=s[0];let u=s[--i],f=0,p=1;for(;p<i;)p+1<i&&h[s[p]]>h[s[p+1]]&&p++,s[f]=s[p],f=p,p=2*p+1;let g=h[u];for(;p=f,f>0&&(f=Math.floor((p-1)/2),h[s[f]]>g);)s[p]=s[f];s[p]=u;const b=s[0];u=c++,o[2*u]=d,o[2*u+1]=b;const w=Math.min(255&h[d],255&h[b]);for(g=h[d]+h[b]-w+1,h[u]=g,f=0,p=1;p<i;)p+1<i&&h[s[p]]>h[s[p+1]]&&p++,s[f]=s[p],f=p,p=2*f+1;for(;p=f,p>0&&(f=Math.floor((p-1)/2),h[s[f]]>g);)s[p]=s[f];s[p]=u}while(i>1);this.buildLength(o)}buildLength(e){this.length=new Uint8Array(this.freqs.length);const s=Math.floor(e.length/2),i=Math.floor((s+1)/2);let a=0;for(let c=0;c<this.maxLength;c++)this.bitLengthCounts[c]=0;const n=new Int32Array(s);n[s-1]=0;for(let c=s-1;c>=0;c--)if(-1!==e[2*c+1]){let d=n[c]+1;d>this.maxLength&&(d=this.maxLength,a++),n[e[2*c]]=d,n[e[2*c+1]]=d}else this.bitLengthCounts[n[c]-1]++,this.length[e[2*c]]=n[c];if(0===a)return;let o=this.maxLength-1;do{for(;0===this.bitLengthCounts[--o];);do{this.bitLengthCounts[o]--,this.bitLengthCounts[++o]++,a-=1<<this.maxLength-1-o}while(a>0&&o<this.maxLength-1)}while(a>0);this.bitLengthCounts[this.maxLength-1]+=a,this.bitLengthCounts[this.maxLength-2]-=a;let h=2*i;for(let c=this.maxLength;0!==c;c--){let d=this.bitLengthCounts[c-1];for(;d>0;){const u=2*e[h++];-1===e[u+1]&&(this.length[e[u]]=c,d--)}}}getEncodedLength(){let e=0;for(let s=0;s<this.freqs.length;s++)e+=this.freqs[s]*this.length[s];return e}calcBLFreq(e){let s,i,a,n=-1,o=0;for(;o<this.numCodes;){a=1;const h=this.length[o];for(0===h?(s=138,i=3):(s=6,i=3,n!==h&&(e.freqs[h]++,a=0)),n=h,o++;o<this.numCodes&&n===this.length[o]&&(o++,!(++a>=s)););a<i?e.freqs[n]+=a:0!==n?e.freqs[r.Repeat3To6]++:a<=10?e.freqs[r.Repeat3To10]++:e.freqs[r.Repeat11To138]++}}setStaticCodes(e,s){this.codes=e,this.length=s}buildCodes(){const e=new Int32Array(this.maxLength);let s=0;this.codes=new Int16Array(this.freqs.length);for(let i=0;i<this.maxLength;i++)e[i]=s,s+=this.bitLengthCounts[i]<<15-i;for(let i=0;i<this.numCodes;i++){const a=this.length[i];a>0&&(this.codes[i]=ae.bitReverse(e[a-1]),e[a-1]+=1<<16-a)}}writeTree(e){let s,i,a,n=-1,o=0;for(;o<this.numCodes;){a=1;const h=this.length[o];for(0===h?(s=138,i=3):(s=6,i=3,n!==h&&(e.writeSymbol(h),a=0)),n=h,o++;o<this.numCodes&&n===this.length[o]&&(o++,!(++a>=s)););if(a<i)for(;a-- >0;)e.writeSymbol(n);else 0!==n?(e.writeSymbol(r.Repeat3To6),this.huffman.pending.writeBits(a-3,2)):a<=10?(e.writeSymbol(r.Repeat3To10),this.huffman.pending.writeBits(a-3,3)):(e.writeSymbol(r.Repeat11To138),this.huffman.pending.writeBits(a-11,7))}}writeSymbol(e){this.huffman.pending.writeBits(65535&this.codes[e],this.length[e])}}return r.Repeat3To6=16,r.Repeat3To10=17,r.Repeat11To138=18,r})();class ae{static staticInit(){let t=0;for(;t<144;)ae.staticLCodes[t]=ae.bitReverse(48+t<<8),ae.staticLLength[t++]=8;for(;t<256;)ae.staticLCodes[t]=ae.bitReverse(256+t<<7),ae.staticLLength[t++]=9;for(;t<280;)ae.staticLCodes[t]=ae.bitReverse(-256+t<<9),ae.staticLLength[t++]=7;for(;t<ae.LITERAL_NUM;)ae.staticLCodes[t]=ae.bitReverse(-88+t<<8),ae.staticLLength[t++]=8;for(t=0;t<ae.DIST_NUM;t++)ae.staticDCodes[t]=ae.bitReverse(t<<11),ae.staticDLength[t]=5}static bitReverse(t){return ae.bit4Reverse[15&t]<<12|ae.bit4Reverse[t>>4&15]<<8|ae.bit4Reverse[t>>8&15]<<4|ae.bit4Reverse[t>>12]}constructor(t){this.last_lit=0,this.extra_bits=0,this.pending=t,this.literalTree=new In(this,ae.LITERAL_NUM,257,15),this.distTree=new In(this,ae.DIST_NUM,1,15),this.blTree=new In(this,ae.BITLEN_NUM,4,7),this.d_buf=new Int16Array(ae.BUFSIZE),this.l_buf=new Uint8Array(ae.BUFSIZE)}isFull(){return this.last_lit>=ae.BUFSIZE}reset(){this.last_lit=0,this.extra_bits=0,this.literalTree.reset(),this.distTree.reset(),this.blTree.reset()}flushStoredBlock(t,e,s,i){this.pending.writeBits((ae.STORED_BLOCK<<1)+(i?1:0),3),this.pending.alignToByte(),this.pending.writeShort(s),this.pending.writeShort(~s),this.pending.writeBlock(t,e,s),this.reset()}flushBlock(t,e,s,i){this.literalTree.freqs[ae.EOF_SYMBOL]++,this.literalTree.buildTree(),this.distTree.buildTree(),this.literalTree.calcBLFreq(this.blTree),this.distTree.calcBLFreq(this.blTree),this.blTree.buildTree();let a=4;for(let h=18;h>a;h--)this.blTree.length[ae.BL_ORDER[h]]>0&&(a=h+1);let n=14+3*a+this.blTree.getEncodedLength()+this.literalTree.getEncodedLength()+this.distTree.getEncodedLength()+this.extra_bits,o=this.extra_bits;for(let h=0;h<ae.LITERAL_NUM;h++)o+=this.literalTree.freqs[h]*ae.staticLLength[h];for(let h=0;h<ae.DIST_NUM;h++)o+=this.distTree.freqs[h]*ae.staticDLength[h];n>=o&&(n=o),e>=0&&s+4<n>>3?this.flushStoredBlock(t,e,s,i):n===o?(this.pending.writeBits((ae.STATIC_TREES<<1)+(i?1:0),3),this.literalTree.setStaticCodes(ae.staticLCodes,ae.staticLLength),this.distTree.setStaticCodes(ae.staticDCodes,ae.staticDLength),this.compressBlock(),this.reset()):(this.pending.writeBits((ae.DYN_TREES<<1)+(i?1:0),3),this.sendAllTrees(a),this.compressBlock(),this.reset())}sendAllTrees(t){this.blTree.buildCodes(),this.literalTree.buildCodes(),this.distTree.buildCodes(),this.pending.writeBits(this.literalTree.numCodes-257,5),this.pending.writeBits(this.distTree.numCodes-1,5),this.pending.writeBits(t-4,4);for(let e=0;e<t;e++)this.pending.writeBits(this.blTree.length[ae.BL_ORDER[e]],3);this.literalTree.writeTree(this.blTree),this.distTree.writeTree(this.blTree)}compressBlock(){for(let t=0;t<this.last_lit;t++){const e=255&this.l_buf[t];let s=this.d_buf[t];if(0!==s--){const i=ae.Lcode(e);this.literalTree.writeSymbol(i);let a=Math.floor((i-261)/4);a>0&&a<=5&&this.pending.writeBits(e&(1<<a)-1,a);const n=ae.Dcode(s);this.distTree.writeSymbol(n),a=Math.floor(n/2)-1,a>0&&this.pending.writeBits(s&(1<<a)-1,a)}else this.literalTree.writeSymbol(e)}this.literalTree.writeSymbol(ae.EOF_SYMBOL)}tallyDist(t,e){this.d_buf[this.last_lit]=t,this.l_buf[this.last_lit++]=e-3;const s=ae.Lcode(e-3);this.literalTree.freqs[s]++,s>=265&&s<285&&(this.extra_bits+=Math.floor((s-261)/4));const i=ae.Dcode(t-1);return this.distTree.freqs[i]++,i>=4&&(this.extra_bits+=Math.floor(i/2)-1),this.isFull()}tallyLit(t){return this.d_buf[this.last_lit]=0,this.l_buf[this.last_lit++]=t,this.literalTree.freqs[t]++,this.isFull()}static Lcode(t){if(255===t)return 285;let e=257;for(;t>=8;)e+=4,t>>=1;return e+t}static Dcode(t){let e=0;for(;t>=4;)e+=2,t>>=1;return e+t}}ae.BUFSIZE=1<<se.DEFAULT_MEM_LEVEL+6,ae.LITERAL_NUM=286,ae.STORED_BLOCK=0,ae.STATIC_TREES=1,ae.DYN_TREES=2,ae.DIST_NUM=30,ae.staticLCodes=new Int16Array(ae.LITERAL_NUM),ae.staticLLength=new Uint8Array(ae.LITERAL_NUM),ae.staticDCodes=new Int16Array(ae.DIST_NUM),ae.staticDLength=new Uint8Array(ae.DIST_NUM),ae.BL_ORDER=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],ae.bit4Reverse=new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15]),ae.BITLEN_NUM=19,ae.EOF_SYMBOL=256,ae.staticInit();Symbol;Symbol,Symbol,Symbol,Symbol,Symbol,Symbol}}]);