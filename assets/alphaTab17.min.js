/*!
 * alphaTab v1.7.0-alpha.1554 (develop, build 1554)
 *
 * Copyright © 2025, Daniel Kuschny and Contributors, All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 *
 * Integrated Libraries:
 *
 * Library: TinySoundFont
 * License: MIT
 * Copyright: Copyright (C) 2017, 2018 Bernhard Schelling
 * URL: https://github.com/schellingb/TinySoundFont
 * Purpose: SoundFont loading and Audio Synthesis
 *
 * Library: SFZero
 * License: MIT
 * Copyright: Copyright (C) 2012 Steve Folta ()
 * URL: https://github.com/stevefolta/SFZero
 * Purpose: TinySoundFont is based on SFZEro
 *
 * Library: Haxe Standard Library
 * License: MIT
 * Copyright: Copyright (C)2005-2025 Haxe Foundation
 * URL: https://github.com/HaxeFoundation/haxe/tree/development/std
 * Purpose: XML Parser & Zip Inflate Algorithm
 *
 * Library: SharpZipLib
 * License: MIT
 * Copyright: Copyright © 2000-2018 SharpZipLib Contributors
 * URL: https://github.com/icsharpcode/SharpZipLib
 * Purpose: Zip Deflate Algorithm for writing compressed Zips
 *
 * Library: NVorbis
 * License: MIT
 * Copyright: Copyright (c) 2020 Andrew Ward
 * URL: https://github.com/NVorbis/NVorbis
 * Purpose: Vorbis Stream Decoding
 *
 * Library: libvorbis
 * License: BSD-3-Clause
 * Copyright: Copyright (c) 2002-2020 Xiph.org Foundation
 * URL: https://github.com/xiph/vorbis
 * Purpose: NVorbis adopted some code from libvorbis.
 *
 * @preserve
 * @license
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).alphaTab={})}(this,function(e){"use strict";class t{constructor(e){this._targets=new Set,this._callback=e,window.addEventListener("resize",this.onWindowResize.bind(this),!1)}observe(e){this._targets.add(e)}unobserve(e){this._targets.delete(e)}disconnect(){this._targets.clear()}onWindowResize(){const e=[];for(const t of this._targets)e.push({target:t,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this._callback(e,this)}}class s{constructor(e){this._elements=[];let t=null;const s=this.check.bind(this);this.check=()=>{t||(t=setTimeout(()=>{s(),t=null},100))},this._callback=e,window.addEventListener("resize",this.check,!0),document.addEventListener("scroll",this.check,!0)}observe(e){this._elements.indexOf(e)>=0||(this._elements.push(e),this.check())}unobserve(e){this._elements=this._elements.filter(t=>t!==e)}check(){const e=[];for(const t of this._elements){const s=t.getBoundingClientRect();s.top+s.height>=0&&s.top<=window.innerHeight&&s.left+s.width>=0&&s.left<=window.innerWidth&&e.push({target:t,isIntersecting:!0})}e.length&&this._callback(e,this)}}var i,a,r,n,o,h,l,c,d,u,p,m,g,f,y,b,S,w,B,k,T,_,x,N,P,v,E,M,F,C,D,L,I,A,R;void 0===Symbol.dispose&&(Symbol.dispose=Symbol("Symbol.dispose")),"undefined"!=typeof window&&("ResizeObserver"in globalThis||(globalThis.ResizeObserver=t),"IntersectionObserver"in globalThis||(globalThis.IntersectionObserver=s),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...e){this.innerHTML="",this.append(...e)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren)),"replaceAll"in String.prototype||(String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)}),e.AlphaTabErrorType=void 0,(i=e.AlphaTabErrorType||(e.AlphaTabErrorType={}))[i.General=0]="General",i[i.Format=1]="Format",i[i.AlphaTex=2]="AlphaTex";class O extends Error{constructor(e,t="",s){super(t??"",{cause:s}),this.type=e,Object.setPrototypeOf(this,O.prototype)}}class W{static print(e){e(`alphaTab ${W.version}`),e(`commit: ${W.commit}`),e(`build date: ${W.date}`)}}W.version="1.7.0-alpha.1554",W.date="2025-09-23T01:56:31.901Z",W.commit="cf42a854b9fa7c5cbcca400f8979eac2011480b6";class H{static getValue(e){return H._values||(H._values=new Map),e=e.toLowerCase().replaceAll(" ",""),H._values.has(e)?H._values.get(e):0}static getName(e){for(const[t,s]of H._values)if(s===e)return t;return e.toString()}static isPiano(e){return e<=7||e>=16&&e<=23}static isGuitar(e){return e>=24&&e<=39||105===e||43===e}static isBass(e){return e>=32&&e<=39}static bankToLsbMsb(e){return[127&e,e>>7&127]}}H._values=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]),function(e){e[e.NoBrackets=0]="NoBrackets",e[e.GroupStaves=1]="GroupStaves",e[e.GroupSimilarInstruments=2]="GroupSimilarInstruments"}(a||(a={})),function(e){e[e.Hidden=0]="Hidden",e[e.FirstSystem=1]="FirstSystem",e[e.AllSystems=2]="AllSystems"}(r||(r={})),function(e){e[e.FullName=0]="FullName",e[e.ShortName=1]="ShortName"}(n||(n={})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(o||(o={}));class G{constructor(){this.hideDynamics=!1,this.bracketExtendMode=a.GroupStaves,this.useSystemSignSeparator=!1,this.globalDisplayTuning=!0,this.perTrackDisplayTuning=null,this.globalDisplayChordDiagramsOnTop=!0,this.perTrackChordDiagramsOnTop=null,this.singleTrackTrackNamePolicy=r.FirstSystem,this.multiTrackTrackNamePolicy=r.FirstSystem,this.firstSystemTrackNameMode=n.ShortName,this.otherSystemsTrackNameMode=n.ShortName,this.firstSystemTrackNameOrientation=o.Vertical,this.otherSystemsTrackNameOrientation=o.Vertical,this.multiTrackMultiBarRest=!1,this.perTrackMultiBarRest=null}}class V{constructor(){this.masterBars=[],this.opening=null,this.closings=[],this.isClosed=!1}get openings(){const e=this.opening;return e?[e]:[]}get isOpened(){return!0===this.opening?.isRepeatStart}addMasterBar(e){null===this.opening&&(this.opening=e),this.masterBars.push(e),e.repeatGroup=this,e.isRepeatEnd&&(this.closings.push(e),this.isClosed=!0)}}class U{constructor(){this.colors=new Map}}!function(e){e[e.Neutral=0]="Neutral",e[e.C3=1]="C3",e[e.C4=2]="C4",e[e.F4=3]="F4",e[e.G2=4]="G2"}(h||(h={})),function(e){e[e._15ma=0]="_15ma",e[e._8va=1]="_8va",e[e.Regular=2]="Regular",e[e._8vb=3]="_8vb",e[e._15mb=4]="_15mb"}(l||(l={})),function(e){e[e.None=0]="None",e[e.Simple=1]="Simple",e[e.FirstOfDouble=2]="FirstOfDouble",e[e.SecondOfDouble=3]="SecondOfDouble"}(c||(c={})),function(e){e[e.Cb=-7]="Cb",e[e.Gb=-6]="Gb",e[e.Db=-5]="Db",e[e.Ab=-4]="Ab",e[e.Eb=-3]="Eb",e[e.Bb=-2]="Bb",e[e.F=-1]="F",e[e.C=0]="C",e[e.G=1]="G",e[e.D=2]="D",e[e.A=3]="A",e[e.E=4]="E",e[e.B=5]="B",e[e.FSharp=6]="FSharp",e[e.CSharp=7]="CSharp"}(d||(d={})),function(e){e[e.Major=0]="Major",e[e.Minor=1]="Minor"}(u||(u={})),function(e){e[e.Down=0]="Down",e[e.Hold=1]="Hold",e[e.Up=2]="Up"}(p||(p={}));class z{constructor(){this.ratioPosition=0,this.pedalType=p.Down,this.nextPedalMarker=null,this.previousPedalMarker=null}}!function(e){e[e.StandardNotationRepeats=0]="StandardNotationRepeats",e[e.GuitarTabsRepeats=1]="GuitarTabsRepeats",e[e.SlashRepeats=2]="SlashRepeats",e[e.NumberedRepeats=3]="NumberedRepeats",e[e.StandardNotationBarNumber=4]="StandardNotationBarNumber",e[e.GuitarTabsBarNumber=5]="GuitarTabsBarNumber",e[e.SlashBarNumber=6]="SlashBarNumber",e[e.NumberedBarNumber=7]="NumberedBarNumber",e[e.StandardNotationBarLines=8]="StandardNotationBarLines",e[e.GuitarTabsBarLines=9]="GuitarTabsBarLines",e[e.SlashBarLines=10]="SlashBarLines",e[e.NumberedBarLines=11]="NumberedBarLines",e[e.StandardNotationClef=12]="StandardNotationClef",e[e.GuitarTabsClef=13]="GuitarTabsClef",e[e.StandardNotationKeySignature=14]="StandardNotationKeySignature",e[e.NumberedKeySignature=15]="NumberedKeySignature",e[e.StandardNotationTimeSignature=16]="StandardNotationTimeSignature",e[e.GuitarTabsTimeSignature=17]="GuitarTabsTimeSignature",e[e.SlashTimeSignature=18]="SlashTimeSignature",e[e.NumberedTimeSignature=19]="NumberedTimeSignature",e[e.StandardNotationStaffLine=20]="StandardNotationStaffLine",e[e.GuitarTabsStaffLine=21]="GuitarTabsStaffLine",e[e.SlashStaffLine=22]="SlashStaffLine",e[e.NumberedStaffLine=23]="NumberedStaffLine"}(m||(m={}));class X extends U{}!function(e){e[e.Automatic=0]="Automatic",e[e.Dashed=1]="Dashed",e[e.Dotted=2]="Dotted",e[e.Heavy=3]="Heavy",e[e.HeavyHeavy=4]="HeavyHeavy",e[e.HeavyLight=5]="HeavyLight",e[e.LightHeavy=6]="LightHeavy",e[e.LightLight=7]="LightLight",e[e.None=8]="None",e[e.Regular=9]="Regular",e[e.Short=10]="Short",e[e.Tick=11]="Tick"}(g||(g={}));class Y{constructor(){this.id=Y._globalBarId++,this.index=0,this.nextBar=null,this.previousBar=null,this.clef=h.G2,this.clefOttava=l.Regular,this.voices=[],this.simileMark=c.None,this._filledVoices=new Set([0]),this.displayScale=1,this.displayWidth=-1,this.sustainPedals=[],this._isEmpty=!0,this._isRestOnly=!0,this.barLineLeft=g.Automatic,this.barLineRight=g.Automatic,this.keySignature=d.C,this.keySignatureType=u.Major}static resetIds(){Y._globalBarId=0}get isMultiVoice(){return this._filledVoices.size>1}get filledVoices(){return this._filledVoices}get masterBar(){return this.staff.track.score.masterBars[this.index]}get isEmpty(){return this._isEmpty}get hasChanges(){if(0===this.index)return!0;return!(this.keySignature===this.previousBar.keySignature&&this.keySignatureType===this.previousBar.keySignatureType&&this.clef===this.previousBar.clef&&this.clefOttava===this.previousBar.clefOttava)||(this.simileMark!==c.None||this.sustainPedals.length>0||this.barLineLeft!==g.Automatic||this.barLineRight!==g.Automatic)}get isRestOnly(){return this._isRestOnly}getActualBarLineLeft(e){return Y.actualBarLine(this,!1,e)}getActualBarLineRight(){return Y.actualBarLine(this,!0,!1)}static automaticToActualType(e,t,s){let i;return i=t?e.isRepeatEnd?g.LightHeavy:e.nextMasterBar?e.isFreeTime?g.Dashed:e.isDoubleBar?g.LightLight:g.Regular:g.LightHeavy:e.isRepeatStart?g.HeavyLight:s?g.Regular:g.None,i}static actualBarLine(e,t,s){const i=e.masterBar,a=t?e.barLineRight:e.barLineLeft;let r;return r=a===g.Automatic?Y.automaticToActualType(i,t,s):a,r}addVoice(e){e.bar=this,e.index=this.voices.length,this.voices.push(e)}finish(e,t=null){this._filledVoices.clear(),this._filledVoices.add(0),this._isEmpty=!0,this._isRestOnly=!0;for(let s=0,i=this.voices.length;s<i;s++){const i=this.voices[s];i.finish(e,t),i.isEmpty||(this._isEmpty=!1,this._filledVoices.add(s)),i.isRestOnly||(this._isRestOnly=!1)}const s=this.sustainPedals;if(s.length>0){let e=null;this.sustainPedals=[],this.previousBar&&this.previousBar.sustainPedals.length>0&&(e=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1]);const t=null!==e&&e.pedalType!==p.Up;for(const i of s){if(e&&e.pedalType!==p.Up){if(e.bar===this&&i.ratioPosition<=e.ratioPosition)continue;e.nextPedalMarker=i,i.previousPedalMarker=e}t&&i.pedalType===p.Down&&(i.pedalType=p.Hold),i.bar=this,this.sustainPedals.push(i),e=i}}else if(this.previousBar&&this.previousBar.sustainPedals.length>0){const e=this.previousBar.sustainPedals[this.previousBar.sustainPedals.length-1];if(e.pedalType!==p.Up){const t=new z;t.ratioPosition=0,t.bar=this,t.pedalType=p.Hold,this.sustainPedals.push(t),e.nextPedalMarker=t,t.previousPedalMarker=e}}}calculateDuration(){let e=0;for(const t of this.voices){const s=t.calculateDuration();s>e&&(e=s)}return e}}Y._globalBarId=0,function(e){e[e.PPP=0]="PPP",e[e.PP=1]="PP",e[e.P=2]="P",e[e.MP=3]="MP",e[e.MF=4]="MF",e[e.F=5]="F",e[e.FF=6]="FF",e[e.FFF=7]="FFF",e[e.PPPP=8]="PPPP",e[e.PPPPP=9]="PPPPP",e[e.PPPPPP=10]="PPPPPP",e[e.FFFF=11]="FFFF",e[e.FFFFF=12]="FFFFF",e[e.FFFFFF=13]="FFFFFF",e[e.SF=14]="SF",e[e.SFP=15]="SFP",e[e.SFPP=16]="SFPP",e[e.FP=17]="FP",e[e.RF=18]="RF",e[e.RFZ=19]="RFZ",e[e.SFZ=20]="SFZ",e[e.SFFZ=21]="SFFZ",e[e.FZ=22]="FZ",e[e.N=23]="N",e[e.PF=24]="PF",e[e.SFZP=25]="SFZP"}(f||(f={}));class J{static ticksToMillis(e,t){return e*(6e4/(t*J.QuarterTime))|0}static millisToTicks(e,t){return e/(6e4/(t*J.QuarterTime))|0}static toTicks(e){return J.valueToTicks(e)}static valueToTicks(e){let t=e;return t<0&&(t=1/-t),J.QuarterTime*(4/t)|0}static applyDot(e,t){return t?e+3*(e/4|0):e+(e/2|0)}static applyTuplet(e,t,s){return e*s/t|0}static removeTuplet(e,t,s){return e*t/s|0}static dynamicToVelocity(e,t=0){let s=1;switch(e){case f.PPP:s=J.MinVelocity+0*J.VelocityIncrement;break;case f.PP:s=J.MinVelocity+1*J.VelocityIncrement;break;case f.P:s=J.MinVelocity+2*J.VelocityIncrement;break;case f.MP:s=J.MinVelocity+3*J.VelocityIncrement;break;case f.MF:s=J.MinVelocity+4*J.VelocityIncrement;break;case f.F:s=J.MinVelocity+5*J.VelocityIncrement;break;case f.FF:s=J.MinVelocity+6*J.VelocityIncrement;break;case f.FFF:s=J.MinVelocity+7*J.VelocityIncrement;break;case f.PPPP:s=10;break;case f.PPPPP:s=5;break;case f.PPPPPP:s=3;break;case f.FFFF:s=J.MinVelocity+8*J.VelocityIncrement;break;case f.FFFFF:s=J.MinVelocity+9*J.VelocityIncrement;break;case f.FFFFFF:s=J.MinVelocity+10*J.VelocityIncrement;break;case f.SF:case f.SFP:case f.SFZP:case f.SFPP:case f.SFZ:case f.FZ:s=J.MinVelocity+6*J.VelocityIncrement;break;case f.FP:case f.RF:case f.RFZ:case f.SFFZ:s=J.MinVelocity+5*J.VelocityIncrement;break;case f.N:s=1;break;case f.PF:s=J.MinVelocity+(4.5*J.VelocityIncrement|0)}return s+=t*J.VelocityIncrement,Math.min(Math.max(s,1),127)}}J.QuarterTime=960,J.MinVelocity=15,J.VelocityIncrement=16,function(e){e[e.Tempo=0]="Tempo",e[e.Volume=1]="Volume",e[e.Instrument=2]="Instrument",e[e.Balance=3]="Balance",e[e.SyncPoint=4]="SyncPoint",e[e.Bank=4]="Bank"}(y||(y={}));class ${constructor(){this.barOccurence=0,this.millisecondOffset=0}}class q{constructor(){this.isLinear=!1,this.type=y.Tempo,this.value=0,this.ratioPosition=0,this.text=""}static buildTempoAutomation(e,t,s,i){(i<1||i>5)&&(i=2);const a=new Float32Array([1,.5,1,1.5,2,3]),r=new q;return r.type=y.Tempo,r.isLinear=e,r.ratioPosition=t,r.value=s*a[i],r}static buildInstrumentAutomation(e,t,s){const i=new q;return i.type=y.Instrument,i.isLinear=e,i.ratioPosition=t,i.value=s,i}}class j{constructor(e=0,t=0){this.offset=e,this.value=t}}j.MaxPosition=60,j.MaxValue=12,function(e){e[e.Default=0]="Default",e[e.Gradual=1]="Gradual",e[e.Fast=2]="Fast"}(b||(b={})),function(e){e[e.None=0]="None",e[e.Custom=1]="Custom",e[e.Bend=2]="Bend",e[e.Release=3]="Release",e[e.BendRelease=4]="BendRelease",e[e.Hold=5]="Hold",e[e.Prebend=6]="Prebend",e[e.PrebendBend=7]="PrebendBend",e[e.PrebendRelease=8]="PrebendRelease"}(S||(S={})),function(e){e[e.None=0]="None",e[e.BrushUp=1]="BrushUp",e[e.BrushDown=2]="BrushDown",e[e.ArpeggioUp=3]="ArpeggioUp",e[e.ArpeggioDown=4]="ArpeggioDown"}(w||(w={})),function(e){e[e.None=0]="None",e[e.Crescendo=1]="Crescendo",e[e.Decrescendo=2]="Decrescendo"}(B||(B={})),function(e){e[e.QuadrupleWhole=-4]="QuadrupleWhole",e[e.DoubleWhole=-2]="DoubleWhole",e[e.Whole=1]="Whole",e[e.Half=2]="Half",e[e.Quarter=4]="Quarter",e[e.Eighth=8]="Eighth",e[e.Sixteenth=16]="Sixteenth",e[e.ThirtySecond=32]="ThirtySecond",e[e.SixtyFourth=64]="SixtyFourth",e[e.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",e[e.TwoHundredFiftySixth=256]="TwoHundredFiftySixth"}(k||(k={})),function(e){e[e.None=0]="None",e[e.OnBeat=1]="OnBeat",e[e.BeforeBeat=2]="BeforeBeat",e[e.BendGrace=3]="BendGrace"}(T||(T={})),function(e){e[e.None=0]="None",e[e.Normal=1]="Normal",e[e.Heavy=2]="Heavy",e[e.Tenuto=3]="Tenuto"}(_||(_={})),function(e){e[e.Unknown=-2]="Unknown",e[e.NoOrDead=-1]="NoOrDead",e[e.Thumb=0]="Thumb",e[e.IndexFinger=1]="IndexFinger",e[e.MiddleFinger=2]="MiddleFinger",e[e.AnnularFinger=3]="AnnularFinger",e[e.LittleFinger=4]="LittleFinger"}(x||(x={})),function(e){e[e.None=0]="None",e[e.Natural=1]="Natural",e[e.Artificial=2]="Artificial",e[e.Pinch=3]="Pinch",e[e.Tap=4]="Tap",e[e.Semi=5]="Semi",e[e.Feedback=6]="Feedback"}(N||(N={})),function(e){e[e.Default=0]="Default",e[e.ForceNone=1]="ForceNone",e[e.ForceNatural=2]="ForceNatural",e[e.ForceSharp=3]="ForceSharp",e[e.ForceDoubleSharp=4]="ForceDoubleSharp",e[e.ForceFlat=5]="ForceFlat",e[e.ForceDoubleFlat=6]="ForceDoubleFlat"}(P||(P={})),function(e){e[e.None=0]="None",e[e.IntoFromBelow=1]="IntoFromBelow",e[e.IntoFromAbove=2]="IntoFromAbove"}(v||(v={})),function(e){e[e.None=0]="None",e[e.Shift=1]="Shift",e[e.Legato=2]="Legato",e[e.OutUp=3]="OutUp",e[e.OutDown=4]="OutDown",e[e.PickSlideDown=5]="PickSlideDown",e[e.PickSlideUp=6]="PickSlideUp"}(E||(E={})),function(e){e[e.None=0]="None",e[e.Slight=1]="Slight",e[e.Wide=2]="Wide"}(M||(M={})),e.TabRhythmMode=void 0,(F=e.TabRhythmMode||(e.TabRhythmMode={}))[F.Hidden=0]="Hidden",F[F.ShowWithBeams=1]="ShowWithBeams",F[F.ShowWithBars=2]="ShowWithBars",F[F.Automatic=3]="Automatic",e.FingeringMode=void 0,(C=e.FingeringMode||(e.FingeringMode={}))[C.ScoreDefault=0]="ScoreDefault",C[C.ScoreForcePiano=1]="ScoreForcePiano",C[C.SingleNoteEffectBand=2]="SingleNoteEffectBand",C[C.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano",e.NotationMode=void 0,(D=e.NotationMode||(e.NotationMode={}))[D.GuitarPro=0]="GuitarPro",D[D.SongBook=1]="SongBook",e.NotationElement=void 0,(L=e.NotationElement||(e.NotationElement={}))[L.ScoreTitle=0]="ScoreTitle",L[L.ScoreSubTitle=1]="ScoreSubTitle",L[L.ScoreArtist=2]="ScoreArtist",L[L.ScoreAlbum=3]="ScoreAlbum",L[L.ScoreWords=4]="ScoreWords",L[L.ScoreMusic=5]="ScoreMusic",L[L.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",L[L.ScoreCopyright=7]="ScoreCopyright",L[L.GuitarTuning=8]="GuitarTuning",L[L.TrackNames=9]="TrackNames",L[L.ChordDiagrams=10]="ChordDiagrams",L[L.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",L[L.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",L[L.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",L[L.EffectAlternateEndings=14]="EffectAlternateEndings",L[L.EffectCapo=15]="EffectCapo",L[L.EffectChordNames=16]="EffectChordNames",L[L.EffectCrescendo=17]="EffectCrescendo",L[L.EffectDynamics=18]="EffectDynamics",L[L.EffectFadeIn=19]="EffectFadeIn",L[L.EffectFermata=20]="EffectFermata",L[L.EffectFingering=21]="EffectFingering",L[L.EffectHarmonics=22]="EffectHarmonics",L[L.EffectLetRing=23]="EffectLetRing",L[L.EffectLyrics=24]="EffectLyrics",L[L.EffectMarker=25]="EffectMarker",L[L.EffectOttavia=26]="EffectOttavia",L[L.EffectPalmMute=27]="EffectPalmMute",L[L.EffectPickSlide=28]="EffectPickSlide",L[L.EffectPickStroke=29]="EffectPickStroke",L[L.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",L[L.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",L[L.EffectTap=32]="EffectTap",L[L.EffectTempo=33]="EffectTempo",L[L.EffectText=34]="EffectText",L[L.EffectTrill=35]="EffectTrill",L[L.EffectTripletFeel=36]="EffectTripletFeel",L[L.EffectWhammyBar=37]="EffectWhammyBar",L[L.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",L[L.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",L[L.EffectLeftHandTap=40]="EffectLeftHandTap",L[L.EffectFreeTime=41]="EffectFreeTime",L[L.EffectSustainPedal=42]="EffectSustainPedal",L[L.EffectGolpe=43]="EffectGolpe",L[L.EffectWahPedal=44]="EffectWahPedal",L[L.EffectBeatBarre=45]="EffectBeatBarre",L[L.EffectNoteOrnament=46]="EffectNoteOrnament",L[L.EffectRasgueado=47]="EffectRasgueado",L[L.EffectDirections=48]="EffectDirections",L[L.EffectBeatTimer=49]="EffectBeatTimer";class K{constructor(){this.notationMode=e.NotationMode.GuitarPro,this.fingeringMode=e.FingeringMode.ScoreDefault,this.elements=new Map,this.rhythmMode=e.TabRhythmMode.Automatic,this.rhythmHeight=15,this.transpositionPitches=[],this.displayTranspositionPitches=[],this.smallGraceTabNotes=!0,this.extendBendArrowsOnTiedNotes=!0,this.extendLineEffectsToBeatEnd=!1,this.slurHeight=5}isNotationElementVisible(e){return this.elements.has(e)?this.elements.get(e):!K.defaultElements.has(e)||K.defaultElements.get(e)}}K.defaultElements=new Map([[e.NotationElement.ZerosOnDiveWhammys,!1]]);class Q{constructor(e){this._value=void 0,this._factory=e}get value(){return void 0===this._value&&(this._value=this._factory()),this._value}}e.LogLevel=void 0,(I=e.LogLevel||(e.LogLevel={}))[I.None=0]="None",I[I.Debug=1]="Debug",I[I.Info=2]="Info",I[I.Warning=3]="Warning",I[I.Error=4]="Error";class Z{static format(e,t){return`[AlphaTab][${e}] ${t}`}debug(e,t,...s){console.debug(Z.format(e,t),...s)}warning(e,t,...s){console.warn(Z.format(e,t),...s)}info(e,t,...s){console.info(Z.format(e,t),...s)}error(e,t,...s){console.error(Z.format(e,t),...s)}}Z.logLevel=e.LogLevel.Info;class ee{static shouldLog(t){return ee.logLevel!==e.LogLevel.None&&t>=ee.logLevel}static debug(t,s,...i){ee.shouldLog(e.LogLevel.Debug)&&ee.log.debug(t,s,...i)}static warning(t,s,...i){ee.shouldLog(e.LogLevel.Warning)&&ee.log.warning(t,s,...i)}static info(t,s,...i){ee.shouldLog(e.LogLevel.Info)&&ee.log.info(t,s,...i)}static error(t,s,...i){ee.shouldLog(e.LogLevel.Error)&&ee.log.error(t,s,...i)}}ee.logLevel=e.LogLevel.Info,ee.log=new Z,function(e){e[e.NoTripletFeel=0]="NoTripletFeel",e[e.Triplet16th=1]="Triplet16th",e[e.Triplet8th=2]="Triplet8th",e[e.Dotted16th=3]="Dotted16th",e[e.Dotted8th=4]="Dotted8th",e[e.Scottish16th=5]="Scottish16th",e[e.Scottish8th=6]="Scottish8th"}(A||(A={}));class te{constructor(){this.alternateEndings=0,this.nextMasterBar=null,this.previousMasterBar=null,this.index=0,this.isDoubleBar=!1,this.isRepeatStart=!1,this.repeatCount=0,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.timeSignatureCommon=!1,this.isFreeTime=!1,this.tripletFeel=A.NoTripletFeel,this.section=null,this.tempoAutomations=[],this.fermata=null,this.start=0,this.isAnacrusis=!1,this.displayScale=1,this.displayWidth=-1,this.directions=null}get hasChanges(){if(0===this.index)return!1;return!(this.timeSignatureCommon===this.previousMasterBar.timeSignatureCommon&&this.timeSignatureNumerator===this.previousMasterBar.timeSignatureNumerator&&this.timeSignatureDenominator===this.previousMasterBar.timeSignatureDenominator&&this.tripletFeel===this.previousMasterBar.tripletFeel)||(0!==this.alternateEndings||this.isRepeatStart||this.isRepeatEnd||this.isFreeTime||this.isSectionStart||this.tempoAutomations.length>0||this.syncPoints&&this.syncPoints.length>0||null!==this.fermata&&this.fermata.size>0||null!==this.directions&&this.directions.size>0||this.isAnacrusis)}get keySignature(){return this.score.tracks[0].staves[0].bars[this.index].keySignature}set keySignature(e){this.score.tracks[0].staves[0].bars[this.index].keySignature=e}get keySignatureType(){return this.score.tracks[0].staves[0].bars[this.index].keySignatureType}set keySignatureType(e){this.score.tracks[0].staves[0].bars[this.index].keySignatureType=e}get isRepeatEnd(){return this.repeatCount>0}get isSectionStart(){return!!this.section}get tempoAutomation(){return this.tempoAutomations.length>0?this.tempoAutomations[0]:null}calculateDuration(e=!0){if(this.isAnacrusis&&e){let e=0;for(const t of this.score.tracks)for(const s of t.staves){const t=this.index<s.bars.length?s.bars[this.index].calculateDuration():0;t>e&&(e=t)}return e}return this.timeSignatureNumerator*J.valueToTicks(this.timeSignatureDenominator)}addFermata(e,t){let s=this.fermata;null===s&&(s=new Map,this.fermata=s),s.set(e,t)}addDirection(e){null==this.directions&&(this.directions=new Set),this.directions.add(e)}getFermata(e){const t=this.fermata;return null===t?null:t.has(e.playbackStart)?t.get(e.playbackStart):0===e.index&&t.has(0)?t.get(0):null}addSyncPoint(e){this.syncPoints||(this.syncPoints=[]),this.syncPoints.push(e)}}te.MaxAlternateEndings=8;class se{}se.DefaultChannelCount=17,se.MetronomeChannel=se.DefaultChannelCount-1,se.MetronomeKey=33,se.AudioChannels=2,se.MinVolume=0,se.MinProgram=0,se.MaxProgram=127,se.MinPlaybackSpeed=.125,se.MaxPlaybackSpeed=8,se.PercussionChannel=9,se.PercussionBank=128,se.MaxPitchWheel=16384,se.MaxPitchWheel20=4294967296,se.DefaultPitchWheel=se.MaxPitchWheel/2,se.MicroBufferCount=32,se.MicroBufferSize=64;class ie{constructor(){this.beats=[],this.id="empty",this.isComplete=!1}addBeat(e){e.graceIndex=this.beats.length,e.graceGroup=this,this.beats.push(e)}finish(){this.beats.length>0&&(this.id=`${this.beats[0].absoluteDisplayStart}_${this.beats[0].voice.index}`)}}!function(e){e[e.Glyphs=0]="Glyphs"}(R||(R={}));class ae extends U{}let re=class e{constructor(){this._isEmpty=!0,this._isRestOnly=!0,this.id=e._globalVoiceId++,this.index=0,this.beats=[]}static resetIds(){e._globalVoiceId=0}get isEmpty(){return this._isEmpty}forceNonEmpty(){this._isEmpty=!1}get isRestOnly(){return this._isRestOnly}insertBeat(e,t){t.nextBeat=e.nextBeat,t.nextBeat&&(t.nextBeat.previousBeat=t),t.previousBeat=e,t.voice=this,e.nextBeat=t,this.beats.splice(e.index+1,0,t)}addBeat(e){e.voice=this,e.index=this.beats.length,this.beats.push(e),e.isEmpty||(this._isEmpty=!1),e.isRest||(this._isRestOnly=!1)}chain(e,t=null){if(this.bar){if(e.index<this.beats.length-1)e.nextBeat=this.beats[e.index+1],e.nextBeat.previousBeat=e;else if(e.isLastOfVoice&&e.voice.bar.nextBar){const t=this.bar.nextBar.voices[this.index];t.beats.length>0?(e.nextBeat=t.beats[0],e.nextBeat.previousBeat=e):e.nextBeat.previousBeat=e}e.chain(t)}}addGraceBeat(e){if(0===this.beats.length)return void this.addBeat(e);const t=this.beats[this.beats.length-1];this.beats.splice(this.beats.length-1,1),this.addBeat(e),this.addBeat(t),this._isEmpty=!1,this._isRestOnly=!1}getBeatAtPlaybackStart(e){return this._beatLookup.has(e)?this._beatLookup.get(e):null}finish(e,t=null){this._isEmpty=!0,this._isRestOnly=!0,this._beatLookup=new Map;let s=null;for(let e=0;e<this.beats.length;e++){const i=this.beats[e];i.index=e,this.chain(i,t),i.graceType===T.None?(i.graceGroup=s,s&&(s.isComplete=!0),s=null):(s||(s=new ie),s.addBeat(i)),i.isEmpty||(this._isEmpty=!1),i.isRest||(this._isRestOnly=!1)}let i=0,a=0;for(let s=0;s<this.beats.length;s++){const r=this.beats[s];if(r.index=s,r.finish(e,t),r.graceType===T.None){if(r.graceGroup){const e=r.graceGroup.beats[0],t=r.graceGroup.beats[r.graceGroup.beats.length-1];if(e.graceType!==T.BendGrace){const s=t.playbackStart+t.playbackDuration-e.playbackStart;switch(e.graceType){case T.BeforeBeat:e.previousBeat?(e.previousBeat.playbackDuration-=s,a=e.previousBeat.voice===this?e.previousBeat.playbackStart+e.previousBeat.playbackDuration:-s):a=-s;for(const e of r.graceGroup.beats)this._beatLookup.delete(e.playbackStart),e.playbackStart=a,this._beatLookup.set(e.playbackStart,r),a+=e.playbackDuration;break;case T.OnBeat:r.playbackDuration-=s,a=t.voice===this?t.playbackStart+t.playbackDuration:-s}}}r.displayStart=i,r.playbackStart=a,this._beatLookup.set(r.playbackStart,r)}else r.displayStart=i,r.playbackStart=a;r.fermata?this.bar.masterBar.addFermata(r.playbackStart,r.fermata):r.fermata=this.bar.masterBar.getFermata(r),r.finishTuplet(),r.graceGroup&&r.graceGroup.finish(),i+=r.displayDuration,a+=r.playbackDuration}}calculateDuration(){if(this.isEmpty||0===this.beats.length)return 0;const e=this.beats[this.beats.length-1],t=this.beats[0];return e.playbackStart+e.playbackDuration-t.playbackStart}};var ne,oe,he,le,ce,de,ue,pe,me,ge,fe,ye,be,Se,we,Be,ke,Te,_e,xe,Ne,Pe,ve,Ee,Me;re._globalVoiceId=0,function(e){e[e.None=-1]="None",e[e.Space=32]="Space",e[e.Brace=57344]="Brace",e[e.BracketTop=57347]="BracketTop",e[e.BracketBottom=57348]="BracketBottom",e[e.SystemDivider=57351]="SystemDivider",e[e.GClef=57424]="GClef",e[e.GClef15mb=57425]="GClef15mb",e[e.GClef8vb=57426]="GClef8vb",e[e.GClef8va=57427]="GClef8va",e[e.GClef15ma=57428]="GClef15ma",e[e.CClef=57436]="CClef",e[e.CClef8vb=57437]="CClef8vb",e[e.FClef=57442]="FClef",e[e.FClef15mb=57443]="FClef15mb",e[e.FClef8vb=57444]="FClef8vb",e[e.FClef8va=57445]="FClef8va",e[e.FClef15ma=57446]="FClef15ma",e[e.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",e[e.SixStringTabClef=57453]="SixStringTabClef",e[e.FourStringTabClef=57454]="FourStringTabClef",e[e.Clef8=57469]="Clef8",e[e.Clef15=57470]="Clef15",e[e.TimeSig0=57472]="TimeSig0",e[e.TimeSig1=57473]="TimeSig1",e[e.TimeSig2=57474]="TimeSig2",e[e.TimeSig3=57475]="TimeSig3",e[e.TimeSig4=57476]="TimeSig4",e[e.TimeSig5=57477]="TimeSig5",e[e.TimeSig6=57478]="TimeSig6",e[e.TimeSig7=57479]="TimeSig7",e[e.TimeSig8=57480]="TimeSig8",e[e.TimeSig9=57481]="TimeSig9",e[e.TimeSigCommon=57482]="TimeSigCommon",e[e.TimeSigCutCommon=57483]="TimeSigCutCommon",e[e.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",e[e.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",e[e.NoteheadWhole=57506]="NoteheadWhole",e[e.NoteheadHalf=57507]="NoteheadHalf",e[e.NoteheadBlack=57508]="NoteheadBlack",e[e.NoteheadNull=57509]="NoteheadNull",e[e.NoteheadXOrnate=57514]="NoteheadXOrnate",e[e.NoteheadPlusDoubleWhole=57516]="NoteheadPlusDoubleWhole",e[e.NoteheadPlusWhole=57517]="NoteheadPlusWhole",e[e.NoteheadPlusHalf=57518]="NoteheadPlusHalf",e[e.NoteheadPlusBlack=57519]="NoteheadPlusBlack",e[e.NoteheadSquareWhite=57528]="NoteheadSquareWhite",e[e.NoteheadSquareBlack=57529]="NoteheadSquareBlack",e[e.NoteheadTriangleUpDoubleWhole=57530]="NoteheadTriangleUpDoubleWhole",e[e.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",e[e.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",e[e.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",e[e.NoteheadTriangleRightWhite=57537]="NoteheadTriangleRightWhite",e[e.NoteheadTriangleRightBlack=57538]="NoteheadTriangleRightBlack",e[e.NoteheadTriangleDownDoubleWhole=57548]="NoteheadTriangleDownDoubleWhole",e[e.NoteheadTriangleDownWhole=57540]="NoteheadTriangleDownWhole",e[e.NoteheadTriangleDownHalf=57541]="NoteheadTriangleDownHalf",e[e.NoteheadTriangleDownBlack=57543]="NoteheadTriangleDownBlack",e[e.NoteheadDiamondDoubleWhole=57559]="NoteheadDiamondDoubleWhole",e[e.NoteheadDiamondWhole=57560]="NoteheadDiamondWhole",e[e.NoteheadDiamondHalf=57561]="NoteheadDiamondHalf",e[e.NoteheadDiamondBlack=57563]="NoteheadDiamondBlack",e[e.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",e[e.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",e[e.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",e[e.NoteheadCircleXDoubleWhole=57520]="NoteheadCircleXDoubleWhole",e[e.NoteheadCircleXWhole=57521]="NoteheadCircleXWhole",e[e.NoteheadCircleXHalf=57522]="NoteheadCircleXHalf",e[e.NoteheadCircleX=57523]="NoteheadCircleX",e[e.NoteheadXDoubleWhole=57510]="NoteheadXDoubleWhole",e[e.NoteheadXWhole=57511]="NoteheadXWhole",e[e.NoteheadXHalf=57512]="NoteheadXHalf",e[e.NoteheadXBlack=57513]="NoteheadXBlack",e[e.NoteheadParenthesis=57550]="NoteheadParenthesis",e[e.NoteheadSlashedBlack1=57551]="NoteheadSlashedBlack1",e[e.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",e[e.NoteheadSlashedHalf1=57553]="NoteheadSlashedHalf1",e[e.NoteheadSlashedHalf2=57554]="NoteheadSlashedHalf2",e[e.NoteheadSlashedWhole1=57555]="NoteheadSlashedWhole1",e[e.NoteheadSlashedWhole2=57556]="NoteheadSlashedWhole2",e[e.NoteheadSlashedDoubleWhole1=57557]="NoteheadSlashedDoubleWhole1",e[e.NoteheadSlashedDoubleWhole2=57558]="NoteheadSlashedDoubleWhole2",e[e.NoteheadCircledBlack=57572]="NoteheadCircledBlack",e[e.NoteheadCircledHalf=57573]="NoteheadCircledHalf",e[e.NoteheadCircledWhole=57574]="NoteheadCircledWhole",e[e.NoteheadCircledDoubleWhole=57575]="NoteheadCircledDoubleWhole",e[e.NoteheadCircleSlash=57591]="NoteheadCircleSlash",e[e.NoteheadHeavyX=57592]="NoteheadHeavyX",e[e.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",e[e.NoteheadSlashHorizontalEnds=57601]="NoteheadSlashHorizontalEnds",e[e.NoteheadSlashWhiteWhole=57602]="NoteheadSlashWhiteWhole",e[e.NoteheadSlashWhiteHalf=57603]="NoteheadSlashWhiteHalf",e[e.NoteheadRoundWhiteWithDot=57621]="NoteheadRoundWhiteWithDot",e[e.NoteheadSquareBlackLarge=57626]="NoteheadSquareBlackLarge",e[e.NoteheadSquareBlackWhite=57627]="NoteheadSquareBlackWhite",e[e.NoteheadClusterDoubleWhole3rd=57640]="NoteheadClusterDoubleWhole3rd",e[e.NoteheadClusterWhole3rd=57641]="NoteheadClusterWhole3rd",e[e.NoteheadClusterHalf3rd=57642]="NoteheadClusterHalf3rd",e[e.NoteheadClusterQuarter3rd=57643]="NoteheadClusterQuarter3rd",e[e.NoteShapeRoundWhite=57776]="NoteShapeRoundWhite",e[e.NoteShapeRoundBlack=57777]="NoteShapeRoundBlack",e[e.NoteShapeSquareWhite=57778]="NoteShapeSquareWhite",e[e.NoteShapeSquareBlack=57779]="NoteShapeSquareBlack",e[e.NoteShapeTriangleRightWhite=57780]="NoteShapeTriangleRightWhite",e[e.NoteShapeTriangleRightBlack=57781]="NoteShapeTriangleRightBlack",e[e.NoteShapeTriangleLeftWhite=57782]="NoteShapeTriangleLeftWhite",e[e.NoteShapeTriangleLeftBlack=57783]="NoteShapeTriangleLeftBlack",e[e.NoteShapeDiamondWhite=57784]="NoteShapeDiamondWhite",e[e.NoteShapeDiamondBlack=57785]="NoteShapeDiamondBlack",e[e.NoteShapeTriangleUpWhite=57786]="NoteShapeTriangleUpWhite",e[e.NoteShapeTriangleUpBlack=57787]="NoteShapeTriangleUpBlack",e[e.NoteShapeMoonWhite=57788]="NoteShapeMoonWhite",e[e.NoteShapeMoonBlack=57789]="NoteShapeMoonBlack",e[e.NoteShapeTriangleRoundWhite=57790]="NoteShapeTriangleRoundWhite",e[e.NoteShapeTriangleRoundBlack=57791]="NoteShapeTriangleRoundBlack",e[e.NoteQuarterUp=57813]="NoteQuarterUp",e[e.Note8thUp=57815]="Note8thUp",e[e.MetNoteQuarterUp=60581]="MetNoteQuarterUp",e[e.MetNote8thUp=60583]="MetNote8thUp",e[e.MetAugmentationDot=60599]="MetAugmentationDot",e[e.ArrowheadBlackUp=60280]="ArrowheadBlackUp",e[e.ArrowheadBlackDown=60284]="ArrowheadBlackDown",e[e.AugmentationDot=57831]="AugmentationDot",e[e.TextBlackNoteLongStem=57841]="TextBlackNoteLongStem",e[e.TextBlackNoteFrac8thLongStem=57843]="TextBlackNoteFrac8thLongStem",e[e.TextBlackNoteFrac16thLongStem=57845]="TextBlackNoteFrac16thLongStem",e[e.TextBlackNoteFrac32ndLongStem=57846]="TextBlackNoteFrac32ndLongStem",e[e.TextCont8thBeamLongStem=57848]="TextCont8thBeamLongStem",e[e.TextCont16thBeamLongStem=57850]="TextCont16thBeamLongStem",e[e.TextCont32ndBeamLongStem=57851]="TextCont32ndBeamLongStem",e[e.TextAugmentationDot=57852]="TextAugmentationDot",e[e.TextTupletBracketStartLongStem=57857]="TextTupletBracketStartLongStem",e[e.TextTuplet3LongStem=57858]="TextTuplet3LongStem",e[e.TextTupletBracketEndLongStem=57859]="TextTupletBracketEndLongStem",e[e.Tremolo3=57890]="Tremolo3",e[e.Tremolo2=57889]="Tremolo2",e[e.Tremolo1=57888]="Tremolo1",e[e.Flag8thUp=57920]="Flag8thUp",e[e.Flag8thDown=57921]="Flag8thDown",e[e.Flag16thUp=57922]="Flag16thUp",e[e.Flag16thDown=57923]="Flag16thDown",e[e.Flag32ndUp=57924]="Flag32ndUp",e[e.Flag32ndDown=57925]="Flag32ndDown",e[e.Flag64thUp=57926]="Flag64thUp",e[e.Flag64thDown=57927]="Flag64thDown",e[e.Flag128thUp=57928]="Flag128thUp",e[e.Flag128thDown=57929]="Flag128thDown",e[e.Flag256thUp=57930]="Flag256thUp",e[e.Flag256thDown=57931]="Flag256thDown",e[e.AccidentalFlat=57952]="AccidentalFlat",e[e.AccidentalNatural=57953]="AccidentalNatural",e[e.AccidentalSharp=57954]="AccidentalSharp",e[e.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",e[e.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",e[e.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",e[e.AccidentalQuarterToneSharpNaturalArrowUp=57970]="AccidentalQuarterToneSharpNaturalArrowUp",e[e.AccidentalThreeQuarterTonesSharpArrowUp=57972]="AccidentalThreeQuarterTonesSharpArrowUp",e[e.RepeatDot=57412]="RepeatDot",e[e.Segno=57415]="Segno",e[e.Coda=57416]="Coda",e[e.ArticAccentAbove=58528]="ArticAccentAbove",e[e.ArticAccentBelow=58529]="ArticAccentBelow",e[e.ArticStaccatoAbove=58530]="ArticStaccatoAbove",e[e.ArticStaccatoBelow=58531]="ArticStaccatoBelow",e[e.ArticTenutoAbove=58532]="ArticTenutoAbove",e[e.ArticTenutoBelow=58533]="ArticTenutoBelow",e[e.ArticMarcatoAbove=58540]="ArticMarcatoAbove",e[e.ArticMarcatoBelow=58541]="ArticMarcatoBelow",e[e.FermataAbove=58560]="FermataAbove",e[e.FermataShortAbove=58564]="FermataShortAbove",e[e.FermataLongAbove=58566]="FermataLongAbove",e[e.RestLonga=58593]="RestLonga",e[e.RestDoubleWhole=58594]="RestDoubleWhole",e[e.RestWhole=58595]="RestWhole",e[e.RestHalf=58596]="RestHalf",e[e.RestQuarter=58597]="RestQuarter",e[e.Rest8th=58598]="Rest8th",e[e.Rest16th=58599]="Rest16th",e[e.Rest32nd=58600]="Rest32nd",e[e.Rest64th=58601]="Rest64th",e[e.Rest128th=58602]="Rest128th",e[e.Rest256th=58603]="Rest256th",e[e.RestHBarLeft=58607]="RestHBarLeft",e[e.RestHBarMiddle=58608]="RestHBarMiddle",e[e.RestHBarRight=58609]="RestHBarRight",e[e.Repeat1Bar=58624]="Repeat1Bar",e[e.Repeat2Bars=58625]="Repeat2Bars",e[e.Ottava=58640]="Ottava",e[e.OttavaAlta=58641]="OttavaAlta",e[e.OttavaBassaVb=58652]="OttavaBassaVb",e[e.Quindicesima=58644]="Quindicesima",e[e.QuindicesimaAlta=58645]="QuindicesimaAlta",e[e.DynamicPPPPPP=58663]="DynamicPPPPPP",e[e.DynamicPPPPP=58664]="DynamicPPPPP",e[e.DynamicPPPP=58665]="DynamicPPPP",e[e.DynamicPPP=58666]="DynamicPPP",e[e.DynamicPP=58667]="DynamicPP",e[e.DynamicPiano=58656]="DynamicPiano",e[e.DynamicMP=58668]="DynamicMP",e[e.DynamicMF=58669]="DynamicMF",e[e.DynamicPF=58670]="DynamicPF",e[e.DynamicForte=58658]="DynamicForte",e[e.DynamicFF=58671]="DynamicFF",e[e.DynamicFFF=58672]="DynamicFFF",e[e.DynamicFFFF=58673]="DynamicFFFF",e[e.DynamicFFFFF=58674]="DynamicFFFFF",e[e.DynamicFFFFFF=58675]="DynamicFFFFFF",e[e.DynamicFortePiano=58676]="DynamicFortePiano",e[e.DynamicNiente=58662]="DynamicNiente",e[e.DynamicSforzando1=58678]="DynamicSforzando1",e[e.DynamicSforzandoPiano=58679]="DynamicSforzandoPiano",e[e.DynamicSforzandoPianissimo=58680]="DynamicSforzandoPianissimo",e[e.DynamicSforzato=58681]="DynamicSforzato",e[e.DynamicSforzatoPiano=58682]="DynamicSforzatoPiano",e[e.DynamicSforzatoFF=58683]="DynamicSforzatoFF",e[e.DynamicRinforzando1=58684]="DynamicRinforzando1",e[e.DynamicRinforzando2=58685]="DynamicRinforzando2",e[e.DynamicForzando=58677]="DynamicForzando",e[e.DynamicCrescendoHairpin=58686]="DynamicCrescendoHairpin",e[e.GraceNoteSlashStemUp=58724]="GraceNoteSlashStemUp",e[e.GraceNoteSlashStemDown=58725]="GraceNoteSlashStemDown",e[e.OrnamentTrill=58726]="OrnamentTrill",e[e.OrnamentTurn=58727]="OrnamentTurn",e[e.OrnamentTurnInverted=58728]="OrnamentTurnInverted",e[e.OrnamentShortTrill=58732]="OrnamentShortTrill",e[e.OrnamentMordent=58733]="OrnamentMordent",e[e.StringsDownBow=58896]="StringsDownBow",e[e.StringsUpBow=58898]="StringsUpBow",e[e.KeyboardPedalPed=58960]="KeyboardPedalPed",e[e.KeyboardPedalUp=58965]="KeyboardPedalUp",e[e.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",e[e.GuitarString0=59443]="GuitarString0",e[e.GuitarString1=59444]="GuitarString1",e[e.GuitarString2=59445]="GuitarString2",e[e.GuitarString3=59446]="GuitarString3",e[e.GuitarString4=59447]="GuitarString4",e[e.GuitarString5=59448]="GuitarString5",e[e.GuitarString6=59449]="GuitarString6",e[e.GuitarString7=59450]="GuitarString7",e[e.GuitarString8=59451]="GuitarString8",e[e.GuitarString9=59452]="GuitarString9",e[e.GuitarOpenPedal=59453]="GuitarOpenPedal",e[e.GuitarClosePedal=59455]="GuitarClosePedal",e[e.GuitarGolpe=59458]="GuitarGolpe",e[e.GuitarFadeIn=59459]="GuitarFadeIn",e[e.GuitarFadeOut=59460]="GuitarFadeOut",e[e.GuitarVolumeSwell=59461]="GuitarVolumeSwell",e[e.FretboardFilledCircle=59480]="FretboardFilledCircle",e[e.FretboardX=59481]="FretboardX",e[e.FretboardO=59482]="FretboardO",e[e.Tuplet0=59520]="Tuplet0",e[e.Tuplet1=59521]="Tuplet1",e[e.Tuplet2=59522]="Tuplet2",e[e.Tuplet3=59523]="Tuplet3",e[e.Tuplet4=59524]="Tuplet4",e[e.Tuplet5=59525]="Tuplet5",e[e.Tuplet6=59526]="Tuplet6",e[e.Tuplet7=59527]="Tuplet7",e[e.Tuplet8=59528]="Tuplet8",e[e.Tuplet9=59529]="Tuplet9",e[e.TupletColon=59530]="TupletColon",e[e.WiggleTrill=60068]="WiggleTrill",e[e.GuitarVibratoStroke=60082]="GuitarVibratoStroke",e[e.GuitarWideVibratoStroke=60083]="GuitarWideVibratoStroke",e[e.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",e[e.WiggleSawtoothNarrow=60090]="WiggleSawtoothNarrow",e[e.WiggleSawtooth=60091]="WiggleSawtooth",e[e.OctaveBaselineM=60565]="OctaveBaselineM",e[e.OctaveBaselineB=60563]="OctaveBaselineB",e[e.GuitarLeftHandTapping=59456]="GuitarLeftHandTapping",e[e.Fingering0=60688]="Fingering0",e[e.Fingering1=60689]="Fingering1",e[e.Fingering2=60690]="Fingering2",e[e.Fingering3=60691]="Fingering3",e[e.Fingering4=60692]="Fingering4",e[e.Fingering5=60693]="Fingering5",e[e.FingeringPLower=60695]="FingeringPLower",e[e.FingeringTLower=60696]="FingeringTLower",e[e.FingeringILower=60697]="FingeringILower",e[e.FingeringMLower=60698]="FingeringMLower",e[e.FingeringALower=60699]="FingeringALower",e[e.FingeringCLower=60700]="FingeringCLower"}(ne||(ne={})),function(e){e[e.None=0]="None",e[e.Natural=1]="Natural",e[e.Sharp=2]="Sharp",e[e.Flat=3]="Flat",e[e.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",e[e.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",e[e.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",e[e.DoubleSharp=7]="DoubleSharp",e[e.DoubleFlat=8]="DoubleFlat"}(oe||(oe={}));class Fe{constructor(){this.note=null,this.tone=new Ce,this.octave=0}get realValue(){return 12*this.octave+this.tone.noteValue}}class Ce{constructor(e=0,t=P.Default){this.noteValue=e,this.accidentalMode=t}}class De{static getIndex(e){return e<0?0:0|Math.log2(e)}static keySignatureIsFlat(e){return e<0}static keySignatureIsNatural(e){return 0===e}static keySignatureIsSharp(e){return e>0}static applyPitchOffsets(e,t){for(let s=0;s<t.tracks.length;s++){if(s<e.notation.displayTranspositionPitches.length)for(const i of t.tracks[s].staves)i.displayTranspositionPitch=-e.notation.displayTranspositionPitches[s];if(s<e.notation.transpositionPitches.length)for(const i of t.tracks[s].staves)i.transpositionPitch=-e.notation.transpositionPitches[s]}}static isTuning(e){return!!De.parseTuning(e)}static parseTuning(e){let t="",s="";for(let i=0;i<e.length;i++){const a=e.charCodeAt(i);if(a>=48&&a<=57){if(!t)return null;s+=String.fromCharCode(a)}else{if(!De.TuningLetters.has(a))return null;t+=String.fromCharCode(a)}}if(!s||!t)return null;const i=new Fe;return i.octave=Number.parseInt(s,10)+1,i.note=t.toLowerCase(),i.tone=De.getToneForText(i.note),i.tone.noteValue<0&&(i.octave--,i.tone.noteValue+=12),i}static getTuningForText(e){const t=De.parseTuning(e);return t?t.realValue:-1}static getToneForText(e){const t=e.substring(0,1),s=e.substring(1);let i,a;switch(t.toLowerCase()){case"c":default:i=0;break;case"d":i=2;break;case"e":i=4;break;case"f":i=5;break;case"g":i=7;break;case"a":i=9;break;case"b":i=11}switch(a=De.parseAccidentalMode(s),a){case P.Default:case P.ForceNone:case P.ForceNatural:break;case P.ForceSharp:i++;break;case P.ForceDoubleSharp:i+=2;break;case P.ForceFlat:i--;break;case P.ForceDoubleFlat:i-=2}return new Ce(i,a)}static parseAccidentalMode(e){const t=e.toLowerCase();return De.accidentalModeMapping.has(t)?De.accidentalModeMapping.get(t):P.Default}static newGuid(){return`${Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}-${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}${Math.floor(65536*(1+Math.random())).toString(16).substring(1)}`}static isAlmostEqualTo(e,t){return Math.abs(e-t)<1e-5}static toHexString(e,t=0){let s="";do{s=String.fromCharCode("0123456789ABCDEF".charCodeAt(15&e))+s,e>>=4}while(e>0);for(;s.length<t;)s=`0${s}`;return s}static getAlternateEndingsList(e){const t=[];for(let s=0;s<te.MaxAlternateEndings;s++)e&1<<s&&t.push(s);return t}static deltaFretToHarmonicValue(e){switch(e){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return e;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}static clamp(e,t,s){return e<=t?t:e>=s?s:e}static buildMultiBarRestInfo(e,t,s){if(!e)return null;const i=e[0].score.stylesheet;if(!(e.length>1?i.multiTrackMultiBarRest:!0===i.perTrackMultiBarRest?.has(e[0].index)))return null;const a=new Map,r=e[0].score;let n=t,o=r.tempo;for(;n<=s;){const i=n;let h=null;for(;n<=s;){const s=r.masterBars[n];let a=!1;for(const e of s.tempoAutomations)e.value!==o&&(a=!0),o=e.value;if(s.alternateEndings||s.isRepeatStart&&s.index!==i||s.isFreeTime||s.isAnacrusis||null!==s.section||s.index!==i&&a||null!==s.fermata&&s.fermata.size>0||null!==s.directions&&s.directions.size>0)break;if(i>t&&s.previousMasterBar&&(s.timeSignatureCommon!==s.previousMasterBar.timeSignatureCommon||s.timeSignatureNumerator!==s.previousMasterBar.timeSignatureNumerator||s.timeSignatureDenominator!==s.previousMasterBar.timeSignatureDenominator||s.tripletFeel!==s.previousMasterBar.tripletFeel))break;let l=!0;for(const t of e){for(const e of t.staves){const t=e.bars[s.index];if(!t.isRestOnly){l=!1;break}if(t.index>0&&(t.keySignature!==t.previousBar.keySignature||t.keySignatureType!==t.previousBar.keySignatureType)){l=!1;break}}if(!l)break}if(!l)break;if(n++,s.index>i&&(null===h?h=[s.index]:h.push(s.index)),s.isRepeatEnd)break}h?a.set(i,h):n++}return a}static computeFirstDisplayedBarIndex(e,t){let s=t.display.startBar;return s--,s=Math.min(e.masterBars.length-1,Math.max(0,s)),s}static computeLastDisplayedBarIndex(e,t,s){let i=t.display.barCount;return i<0&&(i=e.masterBars.length),i=s+i-1,i=Math.min(e.masterBars.length-1,Math.max(0,i)),i}static getOrCreateHeaderFooterStyle(e,t){let s,i=e.style;if(e.style||(i=new je,e.style=i),i.headerAndFooter.has(t))s=i.headerAndFooter.get(t);else{if(s=new qe,je.defaultHeaderAndFooter.has(t)){const e=je.defaultHeaderAndFooter.get(t);s.template=e.template,s.textAlign=e.textAlign}i.headerAndFooter.set(t,s)}return s}static consolidate(e){if(0===e.masterBars.length){const t=new te;e.addMasterBar(t);const s=new q;s.isLinear=!1,s.type=y.Tempo,s.value=e.tempo,t.tempoAutomations.push(s);const i=new Y;e.tracks[0].staves[0].addBar(i);const a=new re;i.addVoice(a);const r=new Ye;return r.isEmpty=!0,void a.addBeat(r)}const t=new Set([se.PercussionChannel]);for(const s of e.tracks){if(1===s.staves.length&&s.staves[0].isPercussion)s.playbackInfo.primaryChannel=se.PercussionChannel,s.playbackInfo.secondaryChannel=se.PercussionChannel;else{if(s.playbackInfo.primaryChannel!==se.PercussionChannel)for(;t.has(s.playbackInfo.primaryChannel);)s.playbackInfo.primaryChannel++;if(t.add(s.playbackInfo.primaryChannel),s.playbackInfo.secondaryChannel!==se.PercussionChannel)for(;t.has(s.playbackInfo.secondaryChannel);)s.playbackInfo.secondaryChannel++;t.add(s.playbackInfo.secondaryChannel)}for(const t of s.staves){for(const e of t.bars)for(const t of e.voices)if(t.isEmpty&&0===t.beats.length){const e=new Ye;e.isEmpty=!0,t.addBeat(e)}const s=0===t.bars.length?1:t.bars[0].voices.length;for(;t.bars.length<e.masterBars.length;){const e=new Y;t.addBar(e);const i=e.previousBar;i&&(e.clef=i.clef,e.clefOttava=i.clefOttava,e.keySignature=e.previousBar.keySignature,e.keySignatureType=e.previousBar.keySignatureType);for(let t=0;t<s;t++){const t=new re;e.addVoice(t);const s=new Ye;s.isEmpty=!0,t.addBeat(s)}}}}}static trimEmptyBarsAtEnd(e){for(;e.masterBars.length>1;){const t=e.masterBars.length-1,s=e.masterBars[t];if(s.hasChanges)return;for(const s of e.tracks)for(const e of s.staves)if(t<e.bars.length){const s=e.bars[t];if(!s.isEmpty||s.hasChanges)return}for(const s of e.tracks)for(const e of s.staves)if(t<e.bars.length){const s=e.bars[t];e.bars.pop(),s.previousBar.nextBar=null}e.masterBars.pop(),s.previousMasterBar.nextMasterBar=null}}static getAllMusicFontSymbols(){return 0===De.allMusicFontSymbols.length&&(De.allMusicFontSymbols=Object.values(ne).filter(e=>"number"==typeof e).map(e=>e)),De.allMusicFontSymbols}static flooredDivision(e,t){return e-t*Math.floor(e/t)}static translateKeyTransposeTable(e){const t=[];for(const s of e){const e=[];t.push(e);for(const t of s){const s=Number.parseInt(t.charAt(0),10)*("b"===t.charAt(1)?-1:1);e.push(s)}}return t}static transposeKey(e,t){if(0===t)return e;if(t<0){const s=De.keyTransposeTable[-t].indexOf(e);return-1===s?e:s-7}return De.keyTransposeTable[t][e+7]}static computeAccidental(e,t,s,i,a=null){const r=e+7,n=s%12,o=r<7?oe.Flat:oe.Sharp,h=De.KeySignatureLookup[r][n],l=De.AccidentalNotes[n];let c=oe.None;if(i)switch(c=l?o:oe.Natural,c){case oe.Natural:c=oe.NaturalQuarterNoteUp;break;case oe.Sharp:c=oe.SharpQuarterNoteUp;break;case oe.Flat:c=oe.FlatQuarterNoteUp}else{switch(t){case P.ForceSharp:c=oe.Sharp;break;case P.ForceDoubleSharp:c=oe.DoubleSharp;break;case P.ForceFlat:c=oe.Flat;break;case P.ForceDoubleFlat:c=oe.DoubleFlat;break;default:l?c=o:h&&(c=oe.Natural)}c!==oe.None?null!=a?a===c&&(c=oe.None):h&&c===o&&(c=oe.None):null!==a&&(c=a===oe.Natural?oe.None:oe.Natural)}return c}}De.TuningLetters=new Set([67,68,69,70,71,65,66,99,100,101,102,103,97,98,35]),De.accidentalModeMapping=new Map([["default",P.Default],["d",P.Default],["forcenone",P.ForceNone],["-",P.ForceNone],["forcenatural",P.ForceNatural],["n",P.ForceNatural],["forcesharp",P.ForceSharp],["#",P.ForceSharp],["forcedoublesharp",P.ForceDoubleSharp],["##",P.ForceDoubleSharp],["x",P.ForceDoubleSharp],["forceflat",P.ForceFlat],["b",P.ForceFlat],["forcedoubleflat",P.ForceDoubleFlat],["bb",P.ForceDoubleFlat]]),De.allMusicFontSymbols=[],De.displayTranspositionPitches=new Map([[24,-12],[25,-12],[26,-12],[27,-12],[28,-12],[29,-12],[30,-12],[31,-12],[32,-12],[33,-12],[34,-12],[35,-12],[36,-12],[37,-12],[38,-12],[39,-12],[43,-12]]),De.keyTransposeTable=De.translateKeyTransposeTable([["7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#"],["2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b","0#"],["3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#"],["4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b"],["1#","2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#"],["6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b"],["1b","0#","1#","2#","3#","4#","7b","6#","7#","4b","3b","2b","1b","0#","1#"],["4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#"],["3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b","2b","1b"],["2#","3#","4#","7b","6b","5b","4b","3b","2b","1b","0#","1#","2#","3#","4#"],["5b","4b","3b","2b","1b","0#","1#","2#","3#","4#","5#","6#","7#","4b","3b"],["0#","1#","2#","3#","4#","7b","6b","6#","4b","3b","2b","1b","0#","1#","2#"]]),De.KeySignatureLookup=[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],De.AccidentalNotes=[!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!0,!1],function(e){e[e.None=0]="None",e[e.Up=1]="Up",e[e.Down=2]="Down"}(he||(he={})),function(e){e[e.Above=0]="Above",e[e.Inside=1]="Inside",e[e.Below=2]="Below",e[e.Outside=3]="Outside"}(le||(le={}));class Le{constructor(e="",t=0,s=0,i=ne.None,a=ne.None,r=ne.None,n=ne.None,o=le.Inside){this.elementType=e,this.outputMidiNumber=s,this.staffLine=t,this.noteHeadDefault=i,this.noteHeadHalf=a!==ne.None?a:i,this.noteHeadWhole=r!==ne.None?r:i,this.techniqueSymbol=n,this.techniqueSymbolPlacement=o}getSymbol(e){switch(e){case k.Whole:return this.noteHeadWhole;case k.Half:return this.noteHeadHalf;default:return this.noteHeadDefault}}}class Ie{static articulationFromElementVariation(e,t){return e<Ie.gp6ElementAndVariationToArticulation.length?(t>=Ie.gp6ElementAndVariationToArticulation.length&&(t=0),Ie.gp6ElementAndVariationToArticulation[e][t]):38}static getArticulationName(e){const t=Ie.getArticulation(e);let s=e.percussionArticulation;t&&(s=t.outputMidiNumber);for(const[e,t]of Ie.instrumentArticulationNames)if(t===s)return e;return"unknown"}static getArticulation(e){const t=e.percussionArticulation;if(t<0)return null;const s=e.beat.voice.bar.staff.track.percussionArticulations;return t<s.length?s[t]:Ie.getArticulationByInputMidiNumber(t)}static getElementAndVariation(e){const t=Ie.getArticulation(e);if(!t)return[-1,-1];for(let e=0;e<Ie.gp6ElementAndVariationToArticulation.length;e++){const s=Ie.gp6ElementAndVariationToArticulation[e];for(let i=0;i<s.length;i++){const a=Ie.getArticulationByInputMidiNumber(s[i]);if(a?.outputMidiNumber===t.outputMidiNumber)return[e,i]}}return[-1,-1]}static getArticulationByInputMidiNumber(e){return Ie.instrumentArticulations.has(e)?Ie.instrumentArticulations.get(e):null}}Ie.gp6ElementAndVariationToArticulation=[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]],Ie.instrumentArticulations=new Map([[38,new Le("snare",3,38,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[37,new Le("snare",3,37,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[91,new Le("snare",3,38,ne.NoteheadDiamondWhite,ne.NoteheadDiamondWhite,ne.NoteheadDiamondWhite)],[42,new Le("hiHat",-1,42,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[92,new Le("hiHat",-1,46,ne.NoteheadCircleSlash,ne.NoteheadCircleSlash,ne.NoteheadCircleSlash)],[46,new Le("hiHat",-1,46,ne.NoteheadCircleX,ne.NoteheadCircleX,ne.NoteheadCircleX)],[44,new Le("hiHat",9,44,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[35,new Le("kickDrum",8,35,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[36,new Le("kickDrum",7,36,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[50,new Le("tom",1,50,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[48,new Le("tom",2,48,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[47,new Le("tom",4,47,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[45,new Le("tom",5,45,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[43,new Le("tom",6,43,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[93,new Le("ride",0,51,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.PictEdgeOfCymbal,le.Below)],[51,new Le("ride",0,51,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[53,new Le("ride",0,53,ne.NoteheadDiamondWhite,ne.NoteheadDiamondWhite,ne.NoteheadDiamondWhite)],[94,new Le("ride",0,51,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.ArticStaccatoAbove,le.Above)],[55,new Le("splash",-2,55,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[95,new Le("splash",-2,55,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.ArticStaccatoAbove,le.Below)],[52,new Le("china",-3,52,ne.NoteheadHeavyXHat,ne.NoteheadHeavyXHat,ne.NoteheadHeavyXHat)],[96,new Le("china",-3,52,ne.NoteheadHeavyXHat,ne.NoteheadHeavyXHat,ne.NoteheadHeavyXHat)],[49,new Le("crash",-2,49,ne.NoteheadHeavyX,ne.NoteheadHeavyX,ne.NoteheadHeavyX)],[97,new Le("crash",-2,49,ne.NoteheadHeavyX,ne.NoteheadHeavyX,ne.NoteheadHeavyX,ne.ArticStaccatoAbove,le.Below)],[57,new Le("crash",-1,57,ne.NoteheadHeavyX,ne.NoteheadHeavyX,ne.NoteheadHeavyX)],[98,new Le("crash",-1,57,ne.NoteheadHeavyX,ne.NoteheadHeavyX,ne.NoteheadHeavyX,ne.ArticStaccatoAbove,le.Below)],[99,new Le("cowbell",1,56,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpHalf,ne.NoteheadTriangleUpWhole)],[100,new Le("cowbell",1,56,ne.NoteheadXBlack,ne.NoteheadXHalf,ne.NoteheadXWhole)],[56,new Le("cowbell",0,56,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpHalf,ne.NoteheadTriangleUpWhole)],[101,new Le("cowbell",0,56,ne.NoteheadXBlack,ne.NoteheadXHalf,ne.NoteheadXWhole)],[102,new Le("cowbell",-1,56,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpHalf,ne.NoteheadTriangleUpWhole)],[103,new Le("cowbell",-1,56,ne.NoteheadXBlack,ne.NoteheadXHalf,ne.NoteheadXWhole)],[77,new Le("woodblock",-9,77,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpBlack)],[76,new Le("woodblock",-10,76,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpBlack)],[60,new Le("bongo",-4,60,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[104,new Le("bongo",-5,60,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole,ne.NoteheadParenthesis,le.Inside)],[105,new Le("bongo",-6,60,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[61,new Le("bongo",-7,61,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[106,new Le("bongo",-8,61,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole,ne.NoteheadParenthesis,le.Inside)],[107,new Le("bongo",-16,61,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[66,new Le("timbale",10,66,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[65,new Le("timbale",9,65,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[68,new Le("agogo",12,68,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[67,new Le("agogo",11,67,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[64,new Le("conga",17,64,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[108,new Le("conga",16,64,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[109,new Le("conga",15,64,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole,ne.NoteheadParenthesis,le.Inside)],[63,new Le("conga",14,63,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[110,new Le("conga",13,63,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[62,new Le("conga",19,62,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole,ne.NoteheadParenthesis,le.Inside)],[72,new Le("whistle",-11,72,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[71,new Le("whistle",-17,71,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[73,new Le("guiro",38,73,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[74,new Le("guiro",37,74,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[86,new Le("surdo",36,86,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[87,new Le("surdo",35,87,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadParenthesis,le.Inside)],[54,new Le("tambourine",3,54,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpBlack)],[111,new Le("tambourine",2,54,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpBlack,ne.StringsUpBow,le.Below)],[112,new Le("tambourine",1,54,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpBlack,ne.NoteheadTriangleUpBlack,ne.StringsDownBow,le.Below)],[113,new Le("tambourine",-7,54,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[79,new Le("cuica",30,79,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[78,new Le("cuica",29,78,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[58,new Le("vibraslap",28,58,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[81,new Le("triangle",27,81,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[80,new Le("triangle",26,80,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadParenthesis,le.Inside)],[114,new Le("grancassa",25,43,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[115,new Le("piatti",18,49,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[116,new Le("piatti",24,49,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[69,new Le("cabasa",23,69,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[117,new Le("cabasa",22,69,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole,ne.StringsUpBow,le.Below)],[85,new Le("castanets",21,85,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[75,new Le("claves",20,75,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[70,new Le("maraca",-12,70,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[118,new Le("maraca",-13,70,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole,ne.StringsUpBow,le.Below)],[119,new Le("maraca",-14,70,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[120,new Le("maraca",-15,70,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole,ne.StringsUpBow,le.Below)],[82,new Le("shaker",-23,54,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[122,new Le("shaker",-24,54,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole,ne.StringsUpBow,le.Below)],[84,new Le("bellTree",-18,53,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[123,new Le("bellTree",-19,53,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole,ne.StringsUpBow,le.Below)],[83,new Le("jingleBell",-20,53,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[124,new Le("unpitched",-21,62,ne.NoteheadNull,ne.NoteheadNull,ne.NoteheadNull,ne.GuitarGolpe,le.Above)],[125,new Le("unpitched",-22,62,ne.NoteheadNull,ne.NoteheadNull,ne.NoteheadNull,ne.GuitarGolpe,le.Below)],[39,new Le("handClap",3,39,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[40,new Le("snare",3,40,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[31,new Le("snare",3,40,ne.NoteheadSlashedBlack2,ne.NoteheadSlashedBlack2,ne.NoteheadSlashedBlack2)],[41,new Le("tom",5,41,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole)],[59,new Le("ride",2,59,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.PictEdgeOfCymbal,le.Below)],[126,new Le("ride",2,59,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[127,new Le("ride",2,59,ne.NoteheadDiamondWhite,ne.NoteheadDiamondWhite,ne.NoteheadDiamondWhite)],[29,new Le("ride",2,59,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.ArticStaccatoAbove,le.Above)],[30,new Le("crash",-3,49,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[33,new Le("snare",3,37,ne.NoteheadXBlack,ne.NoteheadXBlack,ne.NoteheadXBlack)],[34,new Le("snare",3,38,ne.NoteheadBlack,ne.NoteheadBlack,ne.NoteheadBlack)]]),Ie.instrumentArticulationNames=new Map([["Ride (choke)",29],["Cymbal (hit)",30],["Snare (side stick)",31],["Snare (side stick) 2",33],["Snare (hit)",34],["Kick (hit)",35],["Kick (hit) 2",36],["Snare (side stick) 3",37],["Snare (hit) 2",38],["Hand Clap (hit)",39],["Snare (hit) 3",40],["Low Floor Tom (hit)",41],["Hi-Hat (closed)",42],["Very Low Tom (hit)",43],["Pedal Hi-Hat (hit)",44],["Low Tom (hit)",45],["Hi-Hat (open)",46],["Mid Tom (hit)",47],["High Tom (hit)",48],["Crash high (hit)",49],["High Floor Tom (hit)",50],["Ride (middle)",51],["China (hit)",52],["Ride (bell)",53],["Tambourine (hit)",54],["Splash (hit)",55],["Cowbell medium (hit)",56],["Crash medium (hit)",57],["Vibraslap (hit)",58],["Ride (edge)",59],["Hand (hit)",60],["Hand (hit)",61],["Bongo high (hit)",60],["Bongo low (hit)",61],["Conga high (mute)",62],["Conga high (hit)",63],["Conga low (hit)",64],["Timbale high (hit)",65],["Timbale low (hit)",66],["Agogo high (hit)",67],["Agogo tow (hit)",68],["Cabasa (hit)",69],["Left Maraca (hit)",70],["Whistle high (hit)",71],["Whistle low (hit)",72],["Guiro (hit)",73],["Guiro (scrap-return)",74],["Claves (hit)",75],["Woodblock high (hit)",76],["Woodblock low (hit)",77],["Cuica (mute)",78],["Cuica (open)",79],["Triangle (rnute)",80],["Triangle (hit)",81],["Shaker (hit)",82],["Tinkle Bell (hat)",83],["Jingle Bell (hit)",83],["Bell Tree (hit)",84],["Castanets (hit)",85],["Surdo (hit)",86],["Surdo (mute)",87],["Snare (rim shot)",91],["Hi-Hat (half)",92],["Ride (edge) 2",93],["Ride (choke) 2",94],["Splash (choke)",95],["China (choke)",96],["Crash high (choke)",97],["Crash medium (choke)",98],["Cowbell low (hit)",99],["Cowbell low (tip)",100],["Cowbell medium (tip)",101],["Cowbell high (hit)",102],["Cowbell high (tip)",103],["Hand (mute)",104],["Hand (slap)",105],["Hand (mute) 2",106],["Hand (slap) 2",107],["Conga low (slap)",108],["Conga low (mute)",109],["Conga high (slap)",110],["Tambourine (return)",111],["Tambourine (roll)",112],["Tambourine (hand)",113],["Grancassa (hit)",114],["Piatti (hat)",115],["Piatti (hand)",116],["Cabasa (return)",117],["Left Maraca (return)",118],["Right Maraca (hit)",119],["Right Maraca (return)",120],["Shaker (return)",122],["Bell Tee (return)",123],["Golpe (thumb)",124],["Golpe (finger)",125],["Ride (middle) 2",126],["Ride (bell) 2",127]]),function(e){e[e.None=0]="None",e[e.InvertedTurn=1]="InvertedTurn",e[e.Turn=2]="Turn",e[e.UpperMordent=3]="UpperMordent",e[e.LowerMordent=4]="LowerMordent"}(ce||(ce={}));class Ae{constructor(){this.tieDestinationNoteId=-1,this.tieOriginNoteId=-1,this.slurDestinationNoteId=-1,this.slurOriginNoteId=-1,this.hammerPullDestinationNoteId=-1,this.hammerPullOriginNoteId=-1,this.slideTargetNoteId=-1,this.slideOriginNoteId=-1}}!function(e){e[e.Effects=0]="Effects",e[e.StandardNotationNoteHead=1]="StandardNotationNoteHead",e[e.StandardNotationAccidentals=2]="StandardNotationAccidentals",e[e.StandardNotationEffects=3]="StandardNotationEffects",e[e.GuitarTabFretNumber=4]="GuitarTabFretNumber",e[e.GuitarTabEffects=5]="GuitarTabEffects",e[e.SlashNoteHead=6]="SlashNoteHead",e[e.SlashEffects=7]="SlashEffects",e[e.NumberedNumber=8]="NumberedNumber",e[e.NumberedAccidentals=9]="NumberedAccidentals",e[e.NumberedEffects=10]="NumberedEffects"}(de||(de={}));class Re extends U{}class Oe{constructor(){this.id=Oe.GlobalNoteId++,this.index=0,this.accentuated=_.None,this.bendType=S.None,this.bendStyle=b.Default,this.bendOrigin=null,this.isContinuedBend=!1,this.bendPoints=null,this.maxBendPoint=null,this.fret=-1,this.string=-1,this.showStringNumber=!1,this.octave=-1,this.tone=-1,this.percussionArticulation=-1,this.isVisible=!0,this.isLeftHandTapped=!1,this.isHammerPullOrigin=!1,this.hammerPullOrigin=null,this.hammerPullDestination=null,this.isSlurDestination=!1,this.slurOrigin=null,this.slurDestination=null,this.harmonicType=N.None,this.harmonicValue=0,this.isGhost=!1,this.isLetRing=!1,this.letRingDestination=null,this.isPalmMute=!1,this.palmMuteDestination=null,this.isDead=!1,this.isStaccato=!1,this.slideInType=v.None,this.slideOutType=E.None,this.slideTarget=null,this.slideOrigin=null,this.vibrato=M.None,this.tieOrigin=null,this.tieDestination=null,this.isTieDestination=!1,this.leftHandFinger=x.Unknown,this.rightHandFinger=x.Unknown,this.trillValue=-1,this.trillSpeed=k.ThirtySecond,this.durationPercent=1,this.accidentalMode=P.Default,this.dynamics=f.F,this.isEffectSlurOrigin=!1,this.hasEffectSlur=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this.ornament=ce.None,this._noteIdBag=null}static resetIds(){Oe.GlobalNoteId=0}get hasBend(){return null!==this.bendPoints&&this.bendType!==S.None}get isStringed(){return this.string>=0}get isPiano(){return!this.isStringed&&this.octave>=0&&this.tone>=0}get isPercussion(){return!this.isStringed&&this.percussionArticulation>=0}get element(){return this.isPercussion?Ie.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?Ie.getElementAndVariation(this)[1]:-1}get isHammerPullDestination(){return!!this.hammerPullOrigin}get isSlurOrigin(){return!!this.slurDestination}get isHarmonic(){return this.harmonicType!==N.None}get isTieOrigin(){return null!==this.tieDestination}get isFingering(){return this.leftHandFinger!==x.Unknown||this.rightHandFinger!==x.Unknown}get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return this.trillValue>=0}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get stringTuning(){return this.beat.voice.bar.staff.capo+Oe.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(e,t){return e.tuning.length>0?e.tuning[e.tuning.length-(t-1)-1]:0}get realValue(){return this.calculateRealValue(!0,!0)}get realValueWithoutHarmonic(){return this.calculateRealValue(!0,!1)}calculateRealValue(e,t){const s=e?this.beat.voice.bar.staff.transpositionPitch:0;if(t){let t=this.calculateRealValue(e,!1);return this.isStringed&&(this.harmonicType===N.Natural?t=this.harmonicPitch+this.stringTuning-s:t+=this.harmonicPitch),t}return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-s:this.isPiano?12*this.octave+this.tone-s:0}get harmonicPitch(){if(this.harmonicType===N.None||!this.isStringed)return 0;const e=this.harmonicValue;return De.isAlmostEqualTo(e,2.4)?36:De.isAlmostEqualTo(e,2.7)?34:e<3?0:e<=3.5?31:e<=4?28:e<=5?24:e<=6?34:e<=7?19:e<=8.5?36:e<=9?28:e<=10?34:e<=11?0:e<=12?12:e<14?0:e<=15?34:e<=16?28:e<=17?36:e<=18?0:e<=19?19:e<=21?0:e<=22?36:e<=24?24:0}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let e=this.realValue;switch(this.harmonicType!==N.Natural&&this.harmonicType!==N.None&&(e-=this.harmonicPitch),this.beat.ottava){case l._15ma:e-=24;break;case l._8va:e-=12;break;case l.Regular:break;case l._8vb:e+=12;break;case l._15mb:e+=24}switch(this.beat.voice.bar.clefOttava){case l._15ma:e-=24;break;case l._8va:e-=12;break;case l.Regular:break;case l._8vb:e+=12;break;case l._15mb:e+=24}return e-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!=0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!=0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!=0:!!this.beat.isContinuedWhammy&&this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!=0}addBendPoint(e){let t=this.bendPoints;null===t&&(t=[],this.bendPoints=t),t.push(e),(!this.maxBendPoint||e.value>this.maxBendPoint.value)&&(this.maxBendPoint=e),this.bendType===S.None&&(this.bendType=S.Custom)}finish(t,s=null){const i=new Q(()=>Oe.nextNoteOnSameLine(this)),a=t&&t.notation.notationMode===e.NotationMode.SongBook;if(this.isTieDestination&&(this.chain(s),a&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0)),this.isLetRing&&(i.value&&i.value.isLetRing?this.letRingDestination=i.value:this.letRingDestination=this,a&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1)),this.isPalmMute&&(i.value&&i.value.isPalmMute?this.palmMuteDestination=i.value:this.palmMuteDestination=this),this.isHammerPullOrigin){const e=Oe.findHammerPullDestination(this);e?(this.hammerPullDestination=e,e.hammerPullOrigin=this):this.isHammerPullOrigin=!1}switch(this.slideOutType){case E.Shift:case E.Legato:this.slideTarget||(this.slideTarget=i.value),this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=E.None}let r=null;this.isHammerPullOrigin&&this.hammerPullDestination?r=this.hammerPullDestination:this.slideOutType===E.Legato&&this.slideTarget&&(r=this.slideTarget),r&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&this.beat.pickStroke===he.None?(this.effectSlurOrigin.effectSlurDestination=r,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=r,this.effectSlurDestination.effectSlurOrigin=this));const n=this.bendPoints,o=null!=n&&n.length>0;if(o){const e=this.isTieDestination&&this.tieOrigin.hasBend;this.isContinuedBend=e}else this.bendType=S.None;if(o&&this.bendType===S.Custom)if(4===n.length){const e=n[0],t=n[1],s=n[2],i=n[3];t.value===s.value?i.value>e.value?t.value>i.value?this.bendType=S.BendRelease:!this.isContinuedBend&&e.value>0?(this.bendType=S.PrebendBend,n.splice(2,1),n.splice(1,1)):(this.bendType=S.Bend,n.splice(2,1),n.splice(1,1)):i.value<e.value?this.isContinuedBend?(this.bendType=S.Release,n.splice(2,1),n.splice(1,1)):(this.bendType=S.PrebendRelease,n.splice(2,1),n.splice(1,1)):t.value>e.value?this.bendType=S.BendRelease:e.value>0&&!this.isContinuedBend?(this.bendType=S.Prebend,n.splice(2,1),n.splice(1,1)):(this.bendType=S.Hold,n.splice(2,1),n.splice(1,1)):ee.warning("Model","Unsupported bend type detected, fallback to custom",null)}else if(2===n.length){const e=n[0],t=n[1];t.value>e.value?!this.isContinuedBend&&e.value>0?this.bendType=S.PrebendBend:this.bendType=S.Bend:t.value<e.value?this.isContinuedBend?this.bendType=S.Release:this.bendType=S.PrebendRelease:e.value>0&&!this.isContinuedBend?this.bendType=S.Prebend:this.bendType=S.Hold}this.initialBendValue>0&&(this.accidentalMode=P.Default)}static nextNoteOnSameLine(e){let t=e.beat.nextBeat;for(;t&&t.voice.bar.index<=e.beat.voice.bar.index+Oe.MaxOffsetForSameLineSearch;){const s=t.getNoteOnString(e.string);if(s)return s;t=t.nextBeat}return null}static findHammerPullDestination(e){let t=e.beat.nextBeat;for(;t&&t.voice.bar.index<=e.beat.voice.bar.index+Oe.MaxOffsetForSameLineSearch;){let s=t.getNoteOnString(e.string);if(s)return s;for(let i=e.string;i>0;i--)if(s=t.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}for(let i=e.string;i<=e.beat.voice.bar.staff.tuning.length;i++)if(s=t.getNoteOnString(i),s){if(s.isLeftHandTapped)return s;break}t=t.nextBeat}return null}static findTieOrigin(e){let t=e.beat.previousBeat;for(;t&&t.voice.bar.index>=e.beat.voice.bar.index-Oe.MaxOffsetForSameLineSearch;){if(e.isStringed){const s=t.getNoteOnString(e.string);if(s)return s}else if(-1===e.octave&&-1===e.tone){if(e.index<t.notes.length)return t.notes[e.index]}else{const s=t.getNoteWithRealValue(e.realValue);if(s)return s}t=t.previousBeat}return null}chain(e=null){if(null!==e)if(null!==this._noteIdBag){let t;e.has(Oe.NoteIdLookupKey)?t=e.get(Oe.NoteIdLookupKey):(t=new Map,e.set(Oe.NoteIdLookupKey,t)),-1===this._noteIdBag.hammerPullDestinationNoteId&&-1===this._noteIdBag.tieDestinationNoteId&&-1===this._noteIdBag.slurDestinationNoteId&&-1===this._noteIdBag.slideTargetNoteId||t.set(this.id,this),-1!==this._noteIdBag.hammerPullOriginNoteId&&(this.hammerPullOrigin=t.get(this._noteIdBag.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),-1!==this._noteIdBag.tieOriginNoteId&&(this.tieOrigin=t.get(this._noteIdBag.tieOriginNoteId),this.tieOrigin.tieDestination=this),-1!==this._noteIdBag.slurOriginNoteId&&(this.slurOrigin=t.get(this._noteIdBag.slurOriginNoteId),this.slurOrigin.slurDestination=this),-1!==this._noteIdBag.slideOriginNoteId&&(this.slideOrigin=t.get(this._noteIdBag.slideOriginNoteId),this.slideOrigin.slideTarget=this),this._noteIdBag=null}else{if(!this.isTieDestination&&null===this.tieOrigin)return;const e=this.tieOrigin??Oe.findTieOrigin(this);e?(e.tieDestination=this,this.tieOrigin=e,this.fret=e.fret,this.octave=e.octave,this.tone=e.tone,e.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1}}toJson(e){null!==this.tieDestination&&e.set("tiedestinationnoteid",this.tieDestination.id),null!==this.tieOrigin&&e.set("tieoriginnoteid",this.tieOrigin.id),null!==this.slurDestination&&e.set("slurdestinationnoteid",this.slurDestination.id),null!==this.slurOrigin&&e.set("sluroriginnoteid",this.slurOrigin.id),null!==this.hammerPullOrigin&&e.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),null!==this.hammerPullDestination&&e.set("hammerpulldestinationnoteid",this.hammerPullDestination.id),null!==this.slideTarget&&e.set("slidetargetnoteid",this.slideTarget.id),null!==this.slideOrigin&&e.set("slideoriginnoteid",this.slideOrigin.id)}setProperty(e,t){switch(e){case"tiedestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Ae),this._noteIdBag.tieDestinationNoteId=t,!0;case"tieoriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Ae),this._noteIdBag.tieOriginNoteId=t,!0;case"slurdestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Ae),this._noteIdBag.slurDestinationNoteId=t,!0;case"sluroriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Ae),this._noteIdBag.slurOriginNoteId=t,!0;case"hammerpulloriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Ae),this._noteIdBag.hammerPullOriginNoteId=t,!0;case"hammerpulldestinationnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Ae),this._noteIdBag.hammerPullDestinationNoteId=t,!0;case"slidetargetnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Ae),this._noteIdBag.slideTargetNoteId=t,!0;case"slideoriginnoteid":return null==this._noteIdBag&&(this._noteIdBag=new Ae),this._noteIdBag.slideOriginNoteId=t,!0}return!1}}Oe.GlobalNoteId=0,Oe.MaxOffsetForSameLineSearch=3,Oe.NoteIdLookupKey="NoteIdLookup";class We{constructor(e){this._isEqualLengthTuplet=!0,this.totalDuration=0,this.beats=[],this.isFull=!1,this.voice=e}check(e){if(0===this.beats.length)return this.beats.push(e),this.totalDuration+=e.playbackDuration,!0;if(e.graceType!==T.None)return!0;if(e.voice!==this.voice||this.isFull||e.tupletNumerator!==this.beats[0].tupletNumerator||e.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(e.playbackDuration!==this.beats[0].playbackDuration&&(this._isEqualLengthTuplet=!1),this.beats.push(e),this.totalDuration+=e.playbackDuration,this._isEqualLengthTuplet)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{const e=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(const t of We.AllTicks)if(this.totalDuration===t*e){this.isFull=!0;break}}return!0}}We.HalfTicks=1920,We.QuarterTicks=960,We.EighthTicks=480,We.SixteenthTicks=240,We.ThirtySecondTicks=120,We.SixtyFourthTicks=60,We.OneHundredTwentyEighthTicks=30,We.TwoHundredFiftySixthTicks=15,We.AllTicks=[We.HalfTicks,We.QuarterTicks,We.EighthTicks,We.SixteenthTicks,We.ThirtySecondTicks,We.SixtyFourthTicks,We.OneHundredTwentyEighthTicks,We.TwoHundredFiftySixthTicks],function(e){e[e.None=0]="None",e[e.Custom=1]="Custom",e[e.Dive=2]="Dive",e[e.Dip=3]="Dip",e[e.Hold=4]="Hold",e[e.Predive=5]="Predive",e[e.PrediveDive=6]="PrediveDive"}(ue||(ue={}));class He{static clone(e){const t=new j;return t.offset=e.offset,t.value=e.value,t}}class Ge{static clone(e){const t=new Oe;if(t.index=e.index,t.accentuated=e.accentuated,t.bendType=e.bendType,t.bendStyle=e.bendStyle,t.isContinuedBend=e.isContinuedBend,e.bendPoints){t.bendPoints=[];for(const s of e.bendPoints)t.addBendPoint(He.clone(s))}return t.fret=e.fret,t.string=e.string,t.showStringNumber=e.showStringNumber,t.octave=e.octave,t.tone=e.tone,t.percussionArticulation=e.percussionArticulation,t.isVisible=e.isVisible,t.isLeftHandTapped=e.isLeftHandTapped,t.isHammerPullOrigin=e.isHammerPullOrigin,t.isSlurDestination=e.isSlurDestination,t.harmonicType=e.harmonicType,t.harmonicValue=e.harmonicValue,t.isGhost=e.isGhost,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.isDead=e.isDead,t.isStaccato=e.isStaccato,t.slideInType=e.slideInType,t.slideOutType=e.slideOutType,t.vibrato=e.vibrato,t.isTieDestination=e.isTieDestination,t.leftHandFinger=e.leftHandFinger,t.rightHandFinger=e.rightHandFinger,t.trillValue=e.trillValue,t.trillSpeed=e.trillSpeed,t.durationPercent=e.durationPercent,t.accidentalMode=e.accidentalMode,t.dynamics=e.dynamics,t.ornament=e.ornament,t}}class Ve{static clone(e){const t=new $;return t.barOccurence=e.barOccurence,t.millisecondOffset=e.millisecondOffset,t}}class Ue{static clone(e){const t=new q;return t.isLinear=e.isLinear,t.type=e.type,t.value=e.value,t.syncPointValue=e.syncPointValue?Ve.clone(e.syncPointValue):void 0,t.ratioPosition=e.ratioPosition,t.text=e.text,t}}class ze{static clone(e){const t=new Ye;t.index=e.index,t.notes=[];for(const s of e.notes)t.addNote(Ge.clone(s));t.isEmpty=e.isEmpty,t.whammyStyle=e.whammyStyle,t.ottava=e.ottava,t.isLegatoOrigin=e.isLegatoOrigin,t.duration=e.duration,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.automations=[];for(const s of e.automations)t.automations.push(Ue.clone(s));if(t.dots=e.dots,t.fade=e.fade,t.lyrics=e.lyrics?e.lyrics.slice():null,t.pop=e.pop,t.slap=e.slap,t.tap=e.tap,t.text=e.text,t.slashed=e.slashed,t.deadSlapped=e.deadSlapped,t.brushType=e.brushType,t.brushDuration=e.brushDuration,t.tupletDenominator=e.tupletDenominator,t.tupletNumerator=e.tupletNumerator,t.isContinuedWhammy=e.isContinuedWhammy,t.whammyBarType=e.whammyBarType,e.whammyBarPoints){t.whammyBarPoints=[];for(const s of e.whammyBarPoints)t.addWhammyBarPoint(He.clone(s))}return t.vibrato=e.vibrato,t.chordId=e.chordId,t.graceType=e.graceType,t.pickStroke=e.pickStroke,t.tremoloSpeed=e.tremoloSpeed,t.crescendo=e.crescendo,t.displayStart=e.displayStart,t.playbackStart=e.playbackStart,t.displayDuration=e.displayDuration,t.playbackDuration=e.playbackDuration,t.overrideDisplayDuration=e.overrideDisplayDuration,t.golpe=e.golpe,t.dynamics=e.dynamics,t.invertBeamDirection=e.invertBeamDirection,t.preferredBeamDirection=e.preferredBeamDirection,t.isEffectSlurOrigin=e.isEffectSlurOrigin,t.beamingMode=e.beamingMode,t.wahPedal=e.wahPedal,t.barreFret=e.barreFret,t.barreShape=e.barreShape,t.rasgueado=e.rasgueado,t.showTimer=e.showTimer,t.timer=e.timer,t}}!function(e){e[e.None=0]="None",e[e.Thumb=1]="Thumb",e[e.Finger=2]="Finger"}(pe||(pe={})),function(e){e[e.None=0]="None",e[e.FadeIn=1]="FadeIn",e[e.FadeOut=2]="FadeOut",e[e.VolumeSwell=3]="VolumeSwell"}(me||(me={})),function(e){e[e.None=0]="None",e[e.Open=1]="Open",e[e.Closed=2]="Closed"}(ge||(ge={})),function(e){e[e.None=0]="None",e[e.Full=1]="Full",e[e.Half=2]="Half"}(fe||(fe={})),function(e){e[e.None=0]="None",e[e.Ii=1]="Ii",e[e.Mi=2]="Mi",e[e.MiiTriplet=3]="MiiTriplet",e[e.MiiAnapaest=4]="MiiAnapaest",e[e.PmpTriplet=5]="PmpTriplet",e[e.PmpAnapaest=6]="PmpAnapaest",e[e.PeiTriplet=7]="PeiTriplet",e[e.PeiAnapaest=8]="PeiAnapaest",e[e.PaiTriplet=9]="PaiTriplet",e[e.PaiAnapaest=10]="PaiAnapaest",e[e.AmiTriplet=11]="AmiTriplet",e[e.AmiAnapaest=12]="AmiAnapaest",e[e.Ppp=13]="Ppp",e[e.Amii=14]="Amii",e[e.Amip=15]="Amip",e[e.Eami=16]="Eami",e[e.Eamii=17]="Eamii",e[e.Peami=18]="Peami"}(ye||(ye={})),function(e){e[e.Auto=0]="Auto",e[e.ForceSplitToNext=1]="ForceSplitToNext",e[e.ForceMergeWithNext=2]="ForceMergeWithNext",e[e.ForceSplitOnSecondaryToNext=3]="ForceSplitOnSecondaryToNext"}(be||(be={})),function(e){e[e.Effects=0]="Effects",e[e.StandardNotationStem=1]="StandardNotationStem",e[e.StandardNotationFlags=2]="StandardNotationFlags",e[e.StandardNotationBeams=3]="StandardNotationBeams",e[e.StandardNotationTuplet=4]="StandardNotationTuplet",e[e.StandardNotationEffects=5]="StandardNotationEffects",e[e.StandardNotationRests=6]="StandardNotationRests",e[e.GuitarTabStem=7]="GuitarTabStem",e[e.GuitarTabFlags=8]="GuitarTabFlags",e[e.GuitarTabBeams=9]="GuitarTabBeams",e[e.GuitarTabTuplet=10]="GuitarTabTuplet",e[e.GuitarTabEffects=11]="GuitarTabEffects",e[e.GuitarTabRests=12]="GuitarTabRests",e[e.SlashStem=13]="SlashStem",e[e.SlashFlags=14]="SlashFlags",e[e.SlashBeams=15]="SlashBeams",e[e.SlashTuplet=16]="SlashTuplet",e[e.SlashRests=17]="SlashRests",e[e.SlashEffects=18]="SlashEffects",e[e.NumberedDuration=19]="NumberedDuration",e[e.NumberedEffects=20]="NumberedEffects",e[e.NumberedRests=21]="NumberedRests",e[e.NumberedTuplet=22]="NumberedTuplet"}(Se||(Se={}));class Xe extends U{}class Ye{constructor(){this.id=Ye._globalBeatId++,this.index=0,this.previousBeat=null,this.nextBeat=null,this.notes=[],this.noteStringLookup=new Map,this.noteValueLookup=new Map,this.isEmpty=!1,this.whammyStyle=b.Default,this.ottava=l.Regular,this.fermata=null,this.isLegatoOrigin=!1,this.minNote=null,this.maxNote=null,this.maxStringNote=null,this.minStringNote=null,this.duration=k.Quarter,this.isLetRing=!1,this.isPalmMute=!1,this.automations=[],this.dots=0,this.fade=me.None,this.lyrics=null,this.pop=!1,this.slap=!1,this.tap=!1,this.text=null,this.slashed=!1,this.deadSlapped=!1,this.brushType=w.None,this.brushDuration=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.tupletGroup=null,this.isContinuedWhammy=!1,this.whammyBarType=ue.None,this.whammyBarPoints=null,this.maxWhammyPoint=null,this.minWhammyPoint=null,this.vibrato=M.None,this.chordId=null,this.graceType=T.None,this.graceGroup=null,this.graceIndex=-1,this.pickStroke=he.None,this.tremoloSpeed=null,this.crescendo=B.None,this.displayStart=0,this.playbackStart=0,this.displayDuration=0,this.playbackDuration=0,this.golpe=pe.None,this.dynamics=f.F,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.isEffectSlurOrigin=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this.beamingMode=be.Auto,this.wahPedal=ge.None,this.barreFret=-1,this.barreShape=fe.None,this.rasgueado=ye.None,this.showTimer=!1,this.timer=null}static resetIds(){Ye._globalBeatId=0}get isLastOfVoice(){return this.index===this.voice.beats.length-1}get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}get isRest(){return this.isEmpty||!this.deadSlapped&&0===this.notes.length}get isFullBarRest(){return this.isRest&&1===this.voice.beats.length&&this.duration===k.Whole}get fadeIn(){return this.fade===me.FadeIn}set fadeIn(e){this.fade=e?me.FadeIn:me.None}get hasRasgueado(){return this.rasgueado!==ye.None}get hasTuplet(){return!(-1===this.tupletDenominator&&-1===this.tupletNumerator||1===this.tupletDenominator&&1===this.tupletNumerator)}get hasWhammyBar(){return null!==this.whammyBarPoints&&this.whammyBarType!==ue.None}get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}get isTremolo(){return!!this.tremoloSpeed}get displayEnd(){return this.displayStart+this.displayDuration}get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get isBarre(){return this.barreShape!==fe.None&&this.barreFret>=0}addWhammyBarPoint(e){let t=this.whammyBarPoints;null===t&&(t=[],this.whammyBarPoints=t),t.push(e),(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e),(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e),this.whammyBarType===ue.None&&(this.whammyBarType=ue.Custom)}removeWhammyBarPoint(e){const t=this.whammyBarPoints;if(null===t||e<0||e>=t.length)return;t.splice(e,1);const s=t[e];if(s===this.maxWhammyPoint){this.maxWhammyPoint=null;for(const e of t)(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e)}if(s===this.minWhammyPoint){this.minWhammyPoint=null;for(const e of t)(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e)}}addNote(e){e.beat=this,e.index=this.notes.length,this.notes.push(e),e.isStringed&&this.noteStringLookup.set(e.string,e)}removeNote(e){const t=this.notes.indexOf(e);t>=0&&(this.notes.splice(t,1),e.isStringed&&this.noteStringLookup.delete(e.string))}getAutomation(e){for(let t=0,s=this.automations.length;t<s;t++){const s=this.automations[t];if(s.type===e)return s}return null}getNoteOnString(e){return this.noteStringLookup.has(e)?this.noteStringLookup.get(e):null}calculateDuration(){if(void 0!==this.overrideDisplayDuration)return this.overrideDisplayDuration;if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let e=J.toTicks(this.duration);return 2===this.dots?e=J.applyDot(e,!0):1===this.dots&&(e=J.applyDot(e,!1)),this.tupletDenominator>0&&this.tupletNumerator>=0&&(e=J.applyTuplet(e,this.tupletNumerator,this.tupletDenominator)),e}updateDurations(){const e=this.calculateDuration();switch(this.playbackDuration=e,this.graceType){case T.BeforeBeat:case T.OnBeat:switch(this.duration){case k.Sixteenth:this.playbackDuration=J.toTicks(k.SixtyFourth);break;case k.ThirtySecond:this.playbackDuration=J.toTicks(k.OneHundredTwentyEighth);break;default:this.playbackDuration=J.toTicks(k.ThirtySecond)}this.displayDuration=0;break;case T.BendGrace:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=e;const t=this.previousBeat;t&&t.graceType===T.BendGrace&&(this.playbackDuration=t.playbackDuration)}}finishTuplet(){const e=this.previousBeat;let t=e?e.tupletGroup:null;(this.hasTuplet||this.graceType!==T.None&&t)&&(e&&t&&t.check(this)||(t=new We(this.voice),t.check(this)),this.tupletGroup=t);const s=this.voice.bar.masterBar.calculateDuration(!1),i=[];for(const e of this.automations)0===e.ratioPosition&&(e.ratioPosition=this.playbackStart/s),e.type!==y.Tempo&&i.push(e);this.automations=i}finish(t,s=null){switch(null===this.getAutomation(y.Instrument)&&0===this.index&&0===this.voice.index&&0===this.voice.bar.index&&0===this.voice.bar.staff.index&&this.automations.push(q.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case T.OnBeat:case T.BeforeBeat:const e=this.graceGroup.beats.length;this.duration=1===e?k.Eighth:2===e?k.Sixteenth:k.ThirtySecond}this.brushType===w.None&&(this.brushDuration=0);const i=t?t.notation.notationMode:e.NotationMode.GuitarPro;let a="grad"===this.text||"grad."===this.text;a&&i===e.NotationMode.SongBook&&(this.text="");let r=!1;this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null;let n=0,o=!1;for(let h=0,l=this.notes.length;h<l;h++){const l=this.notes[h];if(l.dynamics=this.dynamics,l.finish(t,s),l.isLetRing&&(this.isLetRing=!0),l.isPalmMute&&(this.isPalmMute=!0),i===e.NotationMode.SongBook&&l.hasBend&&this.graceType!==T.BendGrace){if(!l.isTieOrigin)switch(l.bendType){case S.Bend:case S.PrebendRelease:case S.PrebendBend:r=!0}a||l.bendStyle===b.Gradual?(a=!0,l.bendStyle=b.Gradual,r=!1):l.bendStyle=b.Fast}l.isVisible&&(n++,(!this.minNote||l.realValue<this.minNote.realValue)&&(this.minNote=l),(!this.maxNote||l.realValue>this.maxNote.realValue)&&(this.maxNote=l),(!this.minStringNote||l.string<this.minStringNote.string)&&(this.minStringNote=l),(!this.maxStringNote||l.string>this.maxStringNote.string)&&(this.maxStringNote=l),l.hasEffectSlur&&(o=!0))}if(o&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),this.notes.length>0&&0===n&&(this.isEmpty=!0),this.isRest||this.isLetRing&&this.isPalmMute)this.isRest&&this.previousBeat&&t&&t.notation.notationMode===e.NotationMode.GuitarPro&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute&&(this.isPalmMute=!0));else{let e=this.previousBeat;for(;e&&e.isRest;)this.isLetRing||(e.isLetRing=!1),this.isPalmMute||(e.isPalmMute=!1),e=e.previousBeat}const h=this.whammyBarPoints,l=null!==h&&h.length>0;if(l){const e=!!this.previousBeat&&this.previousBeat.hasWhammyBar;this.isContinuedWhammy=e}else this.whammyBarType=ue.None;if(l&&this.whammyBarType===ue.Custom)if(i===e.NotationMode.SongBook&&(this.whammyStyle=a?b.Gradual:b.Fast),4===h.length){const t=h[0],s=h[1],a=h[2],r=h[3];s.value===a.value&&(t.value<s.value&&s.value<r.value||t.value>s.value&&s.value>r.value?(0===t.value||this.isContinuedWhammy?this.whammyBarType=ue.Dive:this.whammyBarType=ue.PrediveDive,h.splice(2,1),h.splice(1,1)):t.value>s.value&&s.value<r.value||t.value<s.value&&s.value>r.value?(this.whammyBarType=ue.Dip,s.offset!==a.offset&&i!==e.NotationMode.SongBook||h.splice(2,1)):t.value===s.value&&s.value===r.value&&(0===t.value||this.isContinuedWhammy?this.whammyBarType=ue.Hold:this.whammyBarType=ue.Predive,h.splice(2,1),h.splice(1,1)))}else if(2===h.length){const e=h[0],t=h[1];e.value<t.value||e.value>t.value?0===e.value||this.isContinuedWhammy?this.whammyBarType=ue.Dive:this.whammyBarType=ue.PrediveDive:e.value===t.value&&(0===e.value||this.isContinuedWhammy?this.whammyBarType=ue.Hold:this.whammyBarType=ue.Predive)}if(this.updateDurations(),r){const e=ze.clone(this);e.id=Ye._globalBeatId++,e.pickStroke=he.None;for(let t=0,s=e.notes.length;t<s;t++){const s=e.notes[t],i=this.notes[t];if(s.bendType=S.None,s.maxBendPoint=null,s.bendPoints=null,s.bendStyle=b.Default,s.id=Oe.GlobalNoteId++,i.isTieOrigin&&(s.tieDestination=i.tieDestination,i.tieDestination.tieOrigin=s),i.isTieDestination&&(s.tieOrigin=i.tieOrigin?i.tieOrigin:null,i.tieOrigin.tieDestination=s),i.hasBend&&i.isTieOrigin){const e=Oe.findTieOrigin(i);if(e&&e.hasBend){s.bendType=S.Hold;const e=i.bendPoints[i.bendPoints.length-1];s.addBendPoint(new j(0,e.value)),s.addBendPoint(new j(j.MaxPosition,e.value))}}s.isTieDestination=!0}this.graceType=T.BendGrace,this.graceGroup=new ie,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,e),e.graceGroup=new ie,e.graceGroup.addBeat(this),e.graceGroup.isComplete=!0,e.graceGroup.finish()}}isBefore(e){return this.voice.bar.index<e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index<e.index}isAfter(e){return this.voice.bar.index>e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index>e.index}hasNoteOnString(e){return this.noteStringLookup.has(e)}getNoteWithRealValue(e){return this.noteValueLookup.has(e)?this.noteValueLookup.get(e):null}chain(e=null){for(const t of this.notes)this.noteValueLookup.set(t.realValue,t),t.chain(e)}}Ye._globalBeatId=0,function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"}(we||(we={})),function(e){e[e.Top=0]="Top",e[e.Middle=1]="Middle",e[e.Bottom=2]="Bottom",e[e.Alphabetic=3]="Alphabetic"}(Be||(Be={}));class Je{constructor(e,t){this.width=e,this.height=t}}class $e{static fillMusicFontSymbolSafe(e,t,s,i,a,r){e.settings.display.resources.engravingSettings.hasSymbol(a)&&e.fillMusicFontSymbol(t,s,i,a,r)}static fillMusicFontSymbolsSafe(e,t,s,i,a,r){const n=a.filter(t=>e.settings.display.resources.engravingSettings.hasSymbol(t));0!==n.length&&e.fillMusicFontSymbols(t,s,i,n,r)}}!function(e){e[e.Title=0]="Title",e[e.SubTitle=1]="SubTitle",e[e.Artist=2]="Artist",e[e.Album=3]="Album",e[e.Words=4]="Words",e[e.Music=5]="Music",e[e.WordsAndMusic=6]="WordsAndMusic",e[e.Transcriber=7]="Transcriber",e[e.Copyright=8]="Copyright",e[e.CopyrightSecondLine=9]="CopyrightSecondLine",e[e.ChordDiagramList=10]="ChordDiagramList"}(ke||(ke={}));class qe{constructor(e="",t=void 0,s=we.Left){this.template=e,this.isVisible=t,this.textAlign=s}buildText(e){let t=!1,s=!1;const i=this.template.replace(qe.PlaceholderPattern,(i,a)=>{s=!0;let r="";switch(a){case"TITLE":r=e.title;break;case"SUBTITLE":r=e.subTitle;break;case"ARTIST":r=e.artist;break;case"ALBUM":r=e.album;break;case"WORDS":case"WORDSMUSIC":r=e.words;break;case"MUSIC":r=e.music;break;case"TABBER":r=e.tab;break;case"COPYRIGHT":r=e.copyright;break;default:r=""}return r&&(t=!0),r});return s&&!t?"":i}}qe.PlaceholderPattern=/%([^%]+)%/g;class je extends U{constructor(){super(...arguments),this.headerAndFooter=new Map}}je.defaultHeaderAndFooter=new Map([[ke.Title,new qe("%TITLE%",void 0,we.Center)],[ke.SubTitle,new qe("%SUBTITLE%",void 0,we.Center)],[ke.Artist,new qe("%ARTIST%",void 0,we.Center)],[ke.Album,new qe("%ALBUM%",void 0,we.Center)],[ke.Words,new qe("Words by %WORDS%",void 0,we.Left)],[ke.Music,new qe("Music by %MUSIC%",void 0,we.Right)],[ke.WordsAndMusic,new qe("Words & Music by %MUSIC%",void 0,we.Right)],[ke.Transcriber,new qe("Tabbed by %TABBER%",!1,we.Right)],[ke.Copyright,new qe("%COPYRIGHT%",void 0,we.Center)],[ke.CopyrightSecondLine,new qe("All Rights Reserved - International Copyright Secured",!0,we.Center)]]);class Ke{constructor(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0,this.album="",this.artist="",this.copyright="",this.instructions="",this.music="",this.notices="",this.subTitle="",this.title="",this.words="",this.tab="",this.tempo=120,this.tempoLabel="",this.masterBars=[],this.tracks=[],this.defaultSystemsLayout=3,this.systemsLayout=[],this.stylesheet=new G}static resetIds(){Y.resetIds(),Ye.resetIds(),re.resetIds(),Oe.resetIds()}rebuildRepeatGroups(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0;for(const e of this.masterBars)this.addMasterBarToRepeatGroups(e)}addMasterBar(e){e.score=this,e.index=this.masterBars.length,0!==this.masterBars.length&&(e.previousMasterBar=this.masterBars[this.masterBars.length-1],e.previousMasterBar.nextMasterBar=e,e.start=e.previousMasterBar.start+(e.previousMasterBar.isAnacrusis?0:e.previousMasterBar.calculateDuration())),this.addMasterBarToRepeatGroups(e),this.masterBars.push(e)}addMasterBarToRepeatGroups(e){e.isRepeatStart?(this._currentRepeatGroup?.isClosed&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--),this._currentRepeatGroup=new V,this._openedRepeatGroups.push(this._currentRepeatGroup),this._properlyOpenedRepeatGroups++):this._currentRepeatGroup||(this._currentRepeatGroup=new V,this._openedRepeatGroups.push(this._currentRepeatGroup)),this._currentRepeatGroup.addMasterBar(e),e.isRepeatEnd&&this._properlyOpenedRepeatGroups>1&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--,this._currentRepeatGroup=this._openedRepeatGroups.length>0?this._openedRepeatGroups[this._openedRepeatGroups.length-1]:null)}addTrack(e){e.score=this,e.index=this.tracks.length,this.tracks.push(e)}finish(e){const t=new Map;for(let s=0,i=this.tracks.length;s<i;s++)this.tracks[s].finish(e,t)}applyFlatSyncPoints(e){for(const e of this.masterBars)e.syncPoints=void 0;for(const t of e){const e=new q;e.ratioPosition=Math.min(1,Math.max(0,t.barPosition)),e.type=y.SyncPoint,e.syncPointValue=new $,e.syncPointValue.millisecondOffset=t.millisecondOffset,e.syncPointValue.barOccurence=t.barOccurence,t.barIndex<this.masterBars.length&&this.masterBars[t.barIndex].addSyncPoint(e)}for(const e of this.masterBars)e.syncPoints&&e.syncPoints.sort((e,t)=>{const s=e.syncPointValue.barOccurence-t.syncPointValue.barOccurence;return 0!==s?s:e.ratioPosition-t.ratioPosition})}exportFlatSyncPoints(){const e=[];for(const t of this.masterBars){const s=t.syncPoints;if(s)for(const i of s)e.push({barIndex:t.index,barOccurence:i.syncPointValue.barOccurence,barPosition:i.ratioPosition,millisecondOffset:i.syncPointValue.millisecondOffset})}return e}}class Qe{init(e,t){this.data=e,this.settings=t,Ke.resetIds()}}class Ze extends O{constructor(t=null,s){super(e.AlphaTabErrorType.Format,t??"Unsupported format",s),Object.setPrototypeOf(this,Ze.prototype)}}class et{constructor(){this.name="",this.firstFret=1,this.strings=[],this.barreFrets=[],this.showName=!0,this.showDiagram=!0,this.showFingering=!0}get uniqueId(){return[this.name,this.firstFret.toString(),this.strings.join(","),this.barreFrets.join(","),this.showDiagram.toString(),this.showFingering.toString(),this.showName.toString()].join("|")}}!function(e){e[e.IgnoreSpaces=0]="IgnoreSpaces",e[e.Begin=1]="Begin",e[e.Text=2]="Text",e[e.Comment=3]="Comment",e[e.Dash=4]="Dash"}(Te||(Te={}));class tt{constructor(){this.startBar=0,this.text=""}finish(e=!1){this.chunks=[],this.parse(this.text,0,this.chunks,e)}parse(e,t,s,i){if(!e)return;let a=Te.Begin,r=Te.Begin,n=!1,o=0;for(;t<e.length;){const s=e.charCodeAt(t);switch(a){case Te.IgnoreSpaces:switch(s){case tt.CharCodeLF:case tt.CharCodeCR:case tt.CharCodeTab:break;case tt.CharCodeSpace:if(!n){a=r;continue}break;default:n=!1,a=r;continue}break;case Te.Begin:if(s!==tt.CharCodeBrackedOpen){o=t,a=Te.Text;continue}a=Te.Comment;break;case Te.Comment:if(s===tt.CharCodeBrackedClose)a=Te.Begin;break;case Te.Text:switch(s){case tt.CharCodeDash:a=Te.Dash;break;case tt.CharCodeCR:case tt.CharCodeLF:case tt.CharCodeSpace:const s=e.substr(o,t-o);this.addChunk(s,i),a=Te.IgnoreSpaces,r=Te.Begin}break;case Te.Dash:if(s!==tt.CharCodeDash){const s=e.substr(o,t-o);this.addChunk(s,i),n=!0,a=Te.IgnoreSpaces,r=Te.Begin;continue}}t+=1}a===Te.Text&&t!==o&&this.addChunk(e.substr(o,t-o),i)}addChunk(e,t){e=this.prepareChunk(e),(!t||e.length>0&&"-"!==e)&&this.chunks.push(e)}prepareChunk(e){const t=e.split("+").join(" ");let s=t.length;for(;s>0&&"_"===t.charAt(s-1);)s--;return s!==t.length?t.substr(0,s):t}}tt.CharCodeLF=10,tt.CharCodeTab=9,tt.CharCodeCR=13,tt.CharCodeSpace=32,tt.CharCodeBrackedClose=93,tt.CharCodeBrackedOpen=91,tt.CharCodeDash=45;class st{constructor(){this.marker="",this.text=""}}class it extends O{constructor(t){super(e.AlphaTabErrorType.Format,t),Object.setPrototypeOf(this,it.prototype)}}class at{constructor(e,t,s,i=255){this.raw=0,this.raw=(255&i)<<24|(255&e)<<16|(255&t)<<8|255&s,this.updateRgba()}updateRgba(){255===this.a?this.rgba=`#${De.toHexString(this.r,2)}${De.toHexString(this.g,2)}${De.toHexString(this.b,2)}`:this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return 255&this.raw}static random(e=100){return new at(255*Math.random()|0,255*Math.random()|0,255*Math.random()|0,e)}static fromJson(e){if(e instanceof at)return e;switch(typeof e){case"number":{const t=new at(0,0,0,0);return t.raw=e,t.updateRgba(),t}case"string":{const t=e;if(t.startsWith("#")){if(4===t.length)return new at(17*Number.parseInt(t[1],16),17*Number.parseInt(t[2],16),17*Number.parseInt(t[3],16));if(5===t.length)return new at(17*Number.parseInt(t[1],16),17*Number.parseInt(t[2],16),17*Number.parseInt(t[3],16),17*Number.parseInt(t[4],16));if(7===t.length)return new at(Number.parseInt(t.substring(1,3),16),Number.parseInt(t.substring(3,5),16),Number.parseInt(t.substring(5,7),16));if(9===t.length)return new at(Number.parseInt(t.substring(1,3),16),Number.parseInt(t.substring(3,5),16),Number.parseInt(t.substring(5,7),16),Number.parseInt(t.substring(7,9),16))}else if(t.startsWith("rgba")||t.startsWith("rgb")){const e=t.indexOf("("),s=t.lastIndexOf(")");if(-1===e||-1===s)throw new it("No values specified for rgb/rgba function");const i=t.substring(e+1,s).split(",");if(3===i.length)return new at(Number.parseInt(i[0],10),Number.parseInt(i[1],10),Number.parseInt(i[2],10));if(4===i.length)return new at(Number.parseInt(i[0],10),Number.parseInt(i[1],10),Number.parseInt(i[2],10),255*Number.parseFloat(i[3]))}return null}}throw new it("Unsupported format for color")}static toJson(e){return null===e?null:e.raw}}at.BlackRgb="#000000";class rt{constructor(){this.volume=15,this.balance=8,this.port=1,this.program=0,this.bank=0,this.primaryChannel=0,this.secondaryChannel=0,this.isMute=!1,this.isSolo=!1}}class nt{static getTextForTuning(e,t){const s=nt.getTextPartsForTuning(e);return t?s.join(""):s[0]}static getTextPartsForTuning(e,t=-1){const s=e/12|0,i=e%12;return[nt.noteNames[i],(s+t).toString()]}static getDefaultTuningFor(e){return nt._defaultTunings.has(e)?nt._defaultTunings.get(e):null}static getPresetsFor(e){switch(e){case 7:return nt._sevenStrings;case 6:return nt._sixStrings;case 5:return nt._fiveStrings;case 4:return nt._fourStrings}return[]}static initialize(){nt._defaultTunings.set(7,new nt("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),nt._sevenStrings.push(nt._defaultTunings.get(7)),nt._defaultTunings.set(6,new nt("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),nt._sixStrings.push(nt._defaultTunings.get(6)),nt._sixStrings.push(new nt("Guitar Tune down ½ step",[63,58,54,49,44,39],!1)),nt._sixStrings.push(new nt("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),nt._sixStrings.push(new nt("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),nt._sixStrings.push(new nt("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),nt._sixStrings.push(new nt("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),nt._sixStrings.push(new nt("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),nt._sixStrings.push(new nt("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),nt._sixStrings.push(new nt("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),nt._sixStrings.push(new nt("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),nt._sixStrings.push(new nt("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),nt._sixStrings.push(new nt("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),nt._sixStrings.push(new nt("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),nt._sixStrings.push(new nt("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),nt._sixStrings.push(new nt("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),nt._sixStrings.push(new nt("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),nt._sixStrings.push(new nt("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),nt._sixStrings.push(new nt("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),nt._sixStrings.push(new nt("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),nt._sixStrings.push(new nt("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),nt._sixStrings.push(new nt("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),nt._sixStrings.push(new nt("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),nt._sixStrings.push(new nt("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),nt._sixStrings.push(new nt("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),nt._sixStrings.push(new nt("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),nt._sixStrings.push(new nt("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),nt._sixStrings.push(new nt("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),nt._sixStrings.push(new nt("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),nt._sixStrings.push(new nt("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),nt._sixStrings.push(new nt("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),nt._sixStrings.push(new nt("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),nt._defaultTunings.set(5,new nt("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),nt._fiveStrings.push(nt._defaultTunings.get(5)),nt._fiveStrings.push(new nt("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),nt._fiveStrings.push(new nt("Banjo Open D Tuning",[62,57,54,50,69],!1)),nt._fiveStrings.push(new nt("Banjo Open G Tuning",[62,59,55,50,67],!1)),nt._fiveStrings.push(new nt("Banjo G Minor Tuning",[62,58,55,50,67],!1)),nt._fiveStrings.push(new nt("Banjo G Modal Tuning",[62,57,55,50,67],!1)),nt._defaultTunings.set(4,new nt("Bass Standard Tuning",[43,38,33,28],!0)),nt._fourStrings.push(nt._defaultTunings.get(4)),nt._fourStrings.push(new nt("Bass Tune down ½ step",[42,37,32,27],!1)),nt._fourStrings.push(new nt("Bass Tune down 1 step",[41,36,31,26],!1)),nt._fourStrings.push(new nt("Bass Tune down 2 step",[39,34,29,24],!1)),nt._fourStrings.push(new nt("Bass Dropped D Tuning",[43,38,33,26],!1)),nt._fourStrings.push(new nt("Ukulele C Tuning",[45,40,36,43],!1)),nt._fourStrings.push(new nt("Ukulele G Tuning",[52,47,43,38],!1)),nt._fourStrings.push(new nt("Mandolin Standard Tuning",[64,57,50,43],!1)),nt._fourStrings.push(new nt("Mandolin or Violin Tuning",[76,69,62,55],!1)),nt._fourStrings.push(new nt("Viola Tuning",[69,62,55,48],!1)),nt._fourStrings.push(new nt("Cello Tuning",[57,50,43,36],!1))}static findTuning(e){const t=nt.getPresetsFor(e.length);for(let s=0,i=t.length;s<i;s++){const i=t[s];let a=!0;for(let t=0,s=e.length;t<s;t++)if(e[t]!==i.tunings[t]){a=!1;break}if(a)return i}return null}constructor(e="",t=null,s=!1){this.isStandard=s,this.name=e,this.tunings=t??[]}finish(){const e=nt.findTuning(this.tunings);e&&(0===this.name.length&&(this.name=e.name),this.isStandard=e.isStandard)}}nt._sevenStrings=[],nt._sixStrings=[],nt._fiveStrings=[],nt._fourStrings=[],nt._defaultTunings=new Map,nt.noteNames=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],nt.initialize();class ot{constructor(){this.index=0,this.bars=[],this.chords=null,this.capo=0,this.transpositionPitch=0,this.displayTranspositionPitch=0,this.stringTuning=new nt("",[],!1),this.showSlash=!1,this.showNumbered=!1,this.showTablature=!0,this.showStandardNotation=!0,this.isPercussion=!1,this.standardNotationLineCount=ot.DefaultStandardNotationLineCount,this._filledVoices=new Set([0])}get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return this.stringTuning.tunings.length>0}get filledVoices(){return this._filledVoices}finish(e,t=null){this.isPercussion&&(this.stringTuning.tunings=[],this.showTablature=!1),this.stringTuning.finish();for(let s=0,i=this.bars.length;s<i;s++){this.bars[s].finish(e,t);for(const e of this.bars[s].filledVoices)this._filledVoices.add(e)}}addChord(e,t){t.staff=this;let s=this.chords;null===s&&(s=new Map,this.chords=s),s.set(e,t)}hasChord(e){return this.chords?.has(e)??!1}getChord(e){return this.chords?.get(e)??null}addBar(e){const t=this.bars;e.staff=this,e.index=t.length,t.length>0&&(e.previousBar=t[t.length-1],e.previousBar.nextBar=e),t.push(e)}}ot.DefaultStandardNotationLineCount=5,function(e){e[e.TrackName=0]="TrackName",e[e.BracesAndBrackets=1]="BracesAndBrackets",e[e.SystemSeparator=2]="SystemSeparator",e[e.StringTuning=3]="StringTuning"}(_e||(_e={}));class ht extends U{}class lt{constructor(){this.index=0,this.staves=[],this.playbackInfo=new rt,this.color=new at(200,0,0,255),this.name="",this.isVisibleOnMultiTrack=!0,this.shortName="",this.defaultSystemsLayout=3,this.systemsLayout=[],this.percussionArticulations=[]}get isPercussion(){return this.staves.some(e=>e.isPercussion)}addLineBreaks(e){this.lineBreaks||(this.lineBreaks=new Set),this.lineBreaks.add(e)}ensureStaveCount(e){for(;this.staves.length<e;)this.addStaff(new ot)}addStaff(e){e.index=this.staves.length,e.track=this,this.staves.push(e)}finish(e,t=null){this.shortName||(this.shortName=this.name,this.shortName.length>lt.ShortNameMaxLength&&(this.shortName=this.shortName.substr(0,lt.ShortNameMaxLength)));for(const s of this.staves)s.finish(e,t),s.isPercussion&&(this.playbackInfo.program=0)}applyLyrics(e){for(const t of e)t.finish();const t=this.staves[0];for(let s=0;s<e.length;s++){const i=e[s];if(i.startBar>=0&&i.startBar<t.bars.length){let a=t.bars[i.startBar].voices[0].beats[0];for(let t=0;t<i.chunks.length&&a;t++){for(;a&&(a.isEmpty||a.isRest);)a=a.nextBeat;a&&(a.lyrics||(a.lyrics=new Array(e.length),a.lyrics.fill("")),a.lyrics[s]=i.chunks[t],a=a.nextBeat)}}}}}lt.ShortNameMaxLength=10;class ct{static float64ToBytes(e){return ct._dataView.setFloat64(0,e,!0),ct._conversionByteArray}static bytesToInt64LE(e){ct._conversionByteArray.set(e,0);const t=ct._dataView.getBigInt64(0,!0);return t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER?Number(t):Number.MAX_SAFE_INTEGER}static bytesToFloat64LE(e){return ct._conversionByteArray.set(e,0),ct._dataView.getFloat64(0,!0)}static bytesToFloat32LE(e){return ct._conversionByteArray.set(e,0),ct._dataView.getFloat32(0,!0)}static float32BEToBytes(e){return ct._dataView.setFloat32(0,e,!1),ct._conversionByteArray.slice(0,4)}static uint16ToInt16(e){return ct._dataView.setUint16(0,e,!0),ct._dataView.getInt16(0,!0)}static int16ToUint32(e){return ct._dataView.setInt16(0,e,!0),ct._dataView.getUint32(0,!0)}static int32ToUint16(e){return ct._dataView.setInt32(0,e,!0),ct._dataView.getUint16(0,!0)}static int32ToInt16(e){return ct._dataView.setInt32(0,e,!0),ct._dataView.getInt16(0,!0)}static int32ToUint32(e){return ct._dataView.setInt32(0,e,!0),ct._dataView.getUint32(0,!0)}static uint8ToInt8(e){return ct._dataView.setUint8(0,e),ct._dataView.getInt8(0)}}ct._conversionBuffer=new ArrayBuffer(8),ct._conversionByteArray=new Uint8Array(ct._conversionBuffer),ct._dataView=new DataView(ct._conversionBuffer);class dt{static readInt32BE(e){return e.readByte()<<24|e.readByte()<<16|e.readByte()<<8|e.readByte()}static readFloat32BE(e){const t=new Uint8Array(4);return e.read(t,0,t.length),t.reverse(),ct.bytesToFloat32LE(t)}static readFloat64BE(e){const t=new Uint8Array(8);return e.read(t,0,t.length),t.reverse(),ct.bytesToFloat64LE(t)}static readInt32LE(e){const t=e.readByte(),s=e.readByte(),i=e.readByte();return e.readByte()<<24|i<<16|s<<8|t}static readInt64LE(e){const t=new Uint8Array(8);return e.read(t,0,t.length),ct.bytesToInt64LE(t)}static readUInt32LE(e){const t=e.readByte(),s=e.readByte(),i=e.readByte();return e.readByte()<<24|i<<16|s<<8|t}static decodeUInt32LE(e,t){const s=e[t],i=e[t+1],a=e[t+2];return e[t+3]<<24|a<<16|i<<8|s}static readUInt16LE(e){const t=e.readByte(),s=e.readByte();return ct.int32ToUint16(s<<8|t)}static readInt16LE(e){const t=e.readByte(),s=e.readByte();return ct.int32ToInt16(s<<8|t)}static readUInt32BE(e){const t=e.readByte(),s=e.readByte(),i=e.readByte(),a=e.readByte();return ct.int32ToUint32(t<<24|s<<16|i<<8|a)}static readUInt16BE(e){const t=e.readByte(),s=e.readByte();return ct.int32ToInt16(t<<8|s)}static readInt16BE(e){const t=e.readByte(),s=e.readByte();return ct.int32ToInt16(t<<8|s)}static readByteArray(e,t){const s=new Uint8Array(t);return e.read(s,0,t),s}static read8BitChars(e,t){const s=new Uint8Array(t);return e.read(s,0,s.length),dt.toString(s,"utf-8")}static read8BitString(e){let t="",s=e.readByte();for(;0!==s;)t+=String.fromCharCode(s),s=e.readByte();return t}static read8BitStringLength(e,t){let s="",i=-1;for(let a=0;a<t;a++){const t=e.readByte();0===t&&-1===i&&(i=a),s+=String.fromCharCode(t)}const a=s;return i>=0?a.substr(0,i):a}static readSInt8(e){const t=e.readByte();return-256*((255&t)>>7)+(255&t)}static readInt24(e,t){let s=e[t]|e[t+1]<<8|e[t+2]<<16;return 8388608&~s||(s|=255<<24),s}static readInt16(e,t){return ct.int32ToInt16(e[t]|e[t+1]<<8)}static toString(e,t){const s=dt.detectEncoding(e);s&&(t=s),t||(t="utf-8");return new TextDecoder(t).decode(e.buffer)}static detectEncoding(e){return e.length>2&&254===e[0]&&255===e[1]?"utf-16be":e.length>2&&255===e[0]&&254===e[1]?"utf-16le":e.length>4&&0===e[0]&&0===e[1]&&254===e[2]&&255===e[3]?"utf-32be":e.length>4&&255===e[0]&&254===e[1]&&0===e[2]&&0===e[3]?"utf-32le":null}static stringToBytes(e){return(new TextEncoder).encode(e)}static writeInt32BE(e,t){e.writeByte(t>>24&255),e.writeByte(t>>16&255),e.writeByte(t>>8&255),e.writeByte(255&t)}static writeInt32LE(e,t){e.writeByte(255&t),e.writeByte(t>>8&255),e.writeByte(t>>16&255),e.writeByte(t>>24&255)}static writeUInt16LE(e,t){e.writeByte(255&t),e.writeByte(t>>8&255)}static writeInt16LE(e,t){e.writeByte(255&t),e.writeByte(t>>8&255)}static writeInt16BE(e,t){e.writeByte(t>>8&255),e.writeByte(255&t)}static writeFloat32BE(e,t){const s=ct.float32BEToBytes(t);e.write(s,0,s.length)}static*iterateCodepoints(e){let t=0;for(;t<e.length;){let s=e.charCodeAt(t);dt.isLeadingSurrogate(s)&&t+1<e.length&&(t++,s=1024*(s-55296)+(e.charCodeAt(t)-56320)+65536),t++,yield s}}static isLeadingSurrogate(e){return e>=55296&&e<=56319}static isTrailingSurrogate(e){return e>=56320&&e<=57343}}class ut{constructor(){this.length=0,this.position=0}get bytesWritten(){return this.position}getBuffer(){return this._buffer}static empty(){return ut.withCapacity(0)}static withCapacity(e){const t=new ut;return t._buffer=new Uint8Array(e),t}static fromBuffer(e){const t=new ut;return t._buffer=e,t.length=e.length,t}static fromString(e){const t=dt.stringToBytes(e);return ut.fromBuffer(t)}reset(){this.position=0}skip(e){this.position+=e}readByte(){return this.length-this.position<=0?-1:this._buffer[this.position++]}read(e,t,s){let i=this.length-this.position;return i>s&&(i=s),i<=0?0:(e.set(this._buffer.subarray(this.position,this.position+i),t),this.position+=i,i)}writeByte(e){const t=this.position+1;this.ensureCapacity(t),this._buffer[this.position]=255&e,t>this.length&&(this.length=t),this.position=t}write(e,t,s){const i=this.position+s;this.ensureCapacity(i);const a=Math.min(s,e.length-t);this._buffer.set(e.subarray(t,t+a),this.position),i>this.length&&(this.length=i),this.position=i}ensureCapacity(e){if(e>this._buffer.length){let t=e;t<256&&(t=256),t<2*this._buffer.length&&(t=2*this._buffer.length);const s=new Uint8Array(t);this.length>0&&s.set(this._buffer.subarray(0,0+this.length),0),this._buffer=s}}readAll(){return this.toArray()}toArray(){const e=new Uint8Array(this.length);return e.set(this._buffer.subarray(0,0+this.length),0),e}copyTo(e){e.write(this._buffer,0,this.length)}}!function(e){e[e.TargetFine=0]="TargetFine",e[e.TargetSegno=1]="TargetSegno",e[e.TargetSegnoSegno=2]="TargetSegnoSegno",e[e.TargetCoda=3]="TargetCoda",e[e.TargetDoubleCoda=4]="TargetDoubleCoda",e[e.JumpDaCapo=5]="JumpDaCapo",e[e.JumpDaCapoAlCoda=6]="JumpDaCapoAlCoda",e[e.JumpDaCapoAlDoubleCoda=7]="JumpDaCapoAlDoubleCoda",e[e.JumpDaCapoAlFine=8]="JumpDaCapoAlFine",e[e.JumpDalSegno=9]="JumpDalSegno",e[e.JumpDalSegnoAlCoda=10]="JumpDalSegnoAlCoda",e[e.JumpDalSegnoAlDoubleCoda=11]="JumpDalSegnoAlDoubleCoda",e[e.JumpDalSegnoAlFine=12]="JumpDalSegnoAlFine",e[e.JumpDalSegnoSegno=13]="JumpDalSegnoSegno",e[e.JumpDalSegnoSegnoAlCoda=14]="JumpDalSegnoSegnoAlCoda",e[e.JumpDalSegnoSegnoAlDoubleCoda=15]="JumpDalSegnoSegnoAlDoubleCoda",e[e.JumpDalSegnoSegnoAlFine=16]="JumpDalSegnoSegnoAlFine",e[e.JumpDaCoda=17]="JumpDaCoda",e[e.JumpDaDoubleCoda=18]="JumpDaDoubleCoda"}(xe||(xe={})),function(e){e[e.Short=0]="Short",e[e.Medium=1]="Medium",e[e.Long=2]="Long"}(Ne||(Ne={}));class pt{constructor(){this.type=Ne.Short,this.length=0}}!function(e){e[e.Up=0]="Up",e[e.Down=1]="Down"}(Pe||(Pe={})),function(e){e[e.No=0]="No",e[e.Eof=1]="Eof",e[e.Number=2]="Number",e[e.DoubleDot=3]="DoubleDot",e[e.Dot=4]="Dot",e[e.String=5]="String",e[e.Tuning=6]="Tuning",e[e.LParensis=7]="LParensis",e[e.RParensis=8]="RParensis",e[e.LBrace=9]="LBrace",e[e.RBrace=10]="RBrace",e[e.Pipe=11]="Pipe",e[e.MetaCommand=12]="MetaCommand",e[e.Multiply=13]="Multiply",e[e.LowerThan=14]="LowerThan"}(ve||(ve={})),function(e){e[e.KnownStaffMeta=0]="KnownStaffMeta",e[e.UnknownStaffMeta=1]="UnknownStaffMeta",e[e.EndOfMetaDetected=2]="EndOfMetaDetected"}(Ee||(Ee={}));class mt extends O{constructor(t,s,i,a,r,n,o,h=null){super(e.AlphaTabErrorType.AlphaTex,t),this.position=s,this.line=i,this.col=a,this.nonTerm=r??"",this.expected=n??ve.No,this.symbol=o??ve.No,this.symbolData=h,Object.setPrototypeOf(this,mt.prototype)}static symbolError(e,t,s,i,a,r,n=null){let o=`MalFormed AlphaTex: @${e} (line ${t}, col ${s}): Error on block ${i}`;return a!==r?(o+=`, expected a ${ve[a]} found a ${ve[r]}`,null!==n&&(o+=`: '${n}'`)):o+=`, invalid value: '${n}'`,new mt(o,e,t,s,i,a,r,n)}static errorMessage(e,t,s,i){return new mt(e=`MalFormed AlphaTex: @${t} (line ${s}, col ${i}): ${e}`,t,s,i,null,null,null,null)}}!function(e){e[e.Auto=0]="Auto",e[e.Explicit=1]="Explicit"}(Me||(Me={}));class gt{constructor(e){this._position=0,this._line=1,this._col=0,this._codepoint=gt.Eof,this.sy=ve.No,this.syData="",this.lastValidSpot=[0,1,0],this.allowTuning=!1,this.logErrors=!0,this._codepoints=[...dt.iterateCodepoints(e)]}init(e=!1){this._position=0,this._line=1,this._col=0,this.saveValidSpot(),this._codepoint=this.nextCodepoint(),this.sy=this.newSy(e)}saveValidSpot(){this.lastValidSpot=[this._position,this._line,this._col]}nextCodepoint(){return this._position<this._codepoints.length?(this._codepoint=this._codepoints[this._position++],10===this._codepoint?(this._line++,this._col=0):this._col++):this._codepoint=gt.Eof,this._codepoint}newSy(e=!1){for(this.saveValidSpot(),this.sy=ve.No;this.sy===ve.No;)if(this.syData=null,this._codepoint===gt.Eof)this.sy=ve.Eof;else if(gt.isWhiteSpace(this._codepoint))this._codepoint=this.nextCodepoint(),this.saveValidSpot();else if(47===this._codepoint){if(this._codepoint=this.nextCodepoint(),47===this._codepoint)for(;13!==this._codepoint&&10!==this._codepoint&&this._codepoint!==gt.Eof;)this._codepoint=this.nextCodepoint();else if(42===this._codepoint)for(;this._codepoint!==gt.Eof;)if(42===this._codepoint){if(this._codepoint=this.nextCodepoint(),47===this._codepoint){this._codepoint=this.nextCodepoint();break}}else this._codepoint=this.nextCodepoint();else this.errorMessage(`Unexpected character ${String.fromCodePoint(this._codepoint)}`);this.saveValidSpot()}else if(34===this._codepoint||39===this._codepoint){const e=this._codepoint;this._codepoint=this.nextCodepoint();let t="";this.sy=ve.String;let s=-1;for(;this._codepoint!==e&&this._codepoint!==gt.Eof;){let i=-1;if(92===this._codepoint)if(this._codepoint=this.nextCodepoint(),92===this._codepoint)i=92;else if(this._codepoint===e)i=e;else if(82===this._codepoint||114===this._codepoint)i=13;else if(78===this._codepoint||110===this._codepoint)i=10;else if(84===this._codepoint||116===this._codepoint)i=9;else if(117===this._codepoint){let e="";for(let t=0;t<4;t++)this._codepoint=this.nextCodepoint(),this._codepoint===gt.Eof&&this.errorMessage("Unexpected end of escape sequence"),e+=String.fromCodePoint(this._codepoint);i=Number.parseInt(e,16),Number.isNaN(i)&&this.errorMessage(`Invalid unicode value ${e}`)}else this.errorMessage("Unsupported escape sequence");else i=this._codepoint;dt.isLeadingSurrogate(s)&&dt.isTrailingSurrogate(i)?(i=1024*(s-55296)+(i-56320)+65536,t+=String.fromCodePoint(i)):dt.isLeadingSurrogate(i)||(dt.isLeadingSurrogate(s)&&(t+=String.fromCodePoint(s)),i>0&&(t+=String.fromCodePoint(i))),s=i,this._codepoint=this.nextCodepoint()}this._codepoint===gt.Eof&&this.errorMessage("String opened but never closed"),this.syData=t,this._codepoint=this.nextCodepoint()}else if(45===this._codepoint)this.readNumberOrName(e);else if(46===this._codepoint)this.sy=ve.Dot,this.syData=".",this._codepoint=this.nextCodepoint();else if(58===this._codepoint)this.sy=ve.DoubleDot,this.syData=":",this._codepoint=this.nextCodepoint();else if(40===this._codepoint)this.sy=ve.LParensis,this._codepoint=this.nextCodepoint(),this.syData="(";else if(92===this._codepoint)this._codepoint=this.nextCodepoint(),this.sy=ve.MetaCommand,92===this._codepoint&&(this._codepoint=this.nextCodepoint()),this.syData=this.readName();else if(41===this._codepoint)this.sy=ve.RParensis,this.syData=")",this._codepoint=this.nextCodepoint();else if(123===this._codepoint)this.sy=ve.LBrace,this.syData="{",this._codepoint=this.nextCodepoint();else if(125===this._codepoint)this.sy=ve.RBrace,this.syData="}",this._codepoint=this.nextCodepoint();else if(124===this._codepoint)this.sy=ve.Pipe,this.syData="|",this._codepoint=this.nextCodepoint();else if(42===this._codepoint)this.sy=ve.Multiply,this.syData="*",this._codepoint=this.nextCodepoint();else if(60===this._codepoint)this.sy=ve.LowerThan,this.syData="<",this._codepoint=this.nextCodepoint();else if(gt.isDigit(this._codepoint))this.readNumberOrName(e);else if(gt.isNameLetter(this._codepoint)){const e=this.readName(),t=this.allowTuning?De.parseTuning(e):null;t?(this.sy=ve.Tuning,this.syData=t):(this.sy=ve.String,this.syData=e)}else this.errorMessage(`Unexpected character ${String.fromCodePoint(this._codepoint)}`);return this.sy}errorMessage(e){const t=mt.errorMessage(e,this.lastValidSpot[0],this.lastValidSpot[1],this.lastValidSpot[2]);throw this.logErrors&&ee.error("AlphaTex",t.message),t}readNumberOrName(e){let t="";this.sy=ve.Number,45===this._codepoint&&(t+=String.fromCodePoint(this._codepoint),this._codepoint=this.nextCodepoint(),gt.isDigit(this._codepoint)||(this.sy=ve.String));let s=!0,i=!1;do{switch(this.sy){case ve.Number:gt.isDigit(this._codepoint)?(t+=String.fromCodePoint(this._codepoint),this._codepoint=this.nextCodepoint(),s=!0):e&&!i&&46===this._codepoint&&gt.isDigit(this._codepoints[this._position])?(t+=String.fromCodePoint(this._codepoint),this._codepoint=this.nextCodepoint(),s=!0,i=!0):gt.isNameLetter(this._codepoint)?(this.sy=ve.String,t+=String.fromCodePoint(this._codepoint),this._codepoint=this.nextCodepoint(),s=!0):s=!1;break;case ve.String:gt.isNameLetter(this._codepoint)?(t+=String.fromCodePoint(this._codepoint),this._codepoint=this.nextCodepoint(),s=!0):s=!1;break;default:s=!1}}while(s);0===t.length&&this.errorMessage("number was empty"),this.sy===ve.String?this.syData=t:this.syData=e?Number.parseFloat(t):Number.parseInt(t,10)}readName(){let e="";do{e+=String.fromCodePoint(this._codepoint),this._codepoint=this.nextCodepoint()}while(gt.isNameLetter(this._codepoint)||gt.isDigit(this._codepoint)||45===this._codepoint);return e}static isNameLetter(e){return!gt.isTerminal(e)&&(33<=e&&e<=47||58<=e&&e<=126||128<=e)}static isTerminal(e){return 46===e||123===e||125===e||91===e||93===e||40===e||41===e||124===e||39===e||34===e||42===e||92===e}static isWhiteSpace(e){return 9===e||10===e||11===e||13===e||32===e}static isDigit(e){return e>=48&&e<=57}}gt.Eof=0;class ft extends Qe{constructor(){super(...arguments),this._trackChannel=0,this._barIndex=0,this._voiceIndex=0,this._currentDuration=k.QuadrupleWhole,this._currentDynamics=f.PPP,this._currentTuplet=0,this._ignoredInitialVoice=!1,this._staffHasExplicitDisplayTransposition=!1,this._staffDisplayTranspositionApplied=!1,this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._percussionArticulationNames=new Map,this._sustainPedalToBeat=new Map,this._slurs=new Map,this._articulationValueToIndex=new Map,this._accidentalMode=Me.Explicit,this._syncPoints=[],this.logErrors=!0}get name(){return"AlphaTex"}initFromString(e,t){this.data=ut.empty(),this._lexer=new gt(e),this.settings=t,Ke.resetIds()}get sy(){return this._lexer.sy}get syData(){return this._lexer.syData}set sy(e){this._lexer.sy=e}newSy(e=!1){return this._lexer.newSy(e)}readScore(){try{if(this.data.length>0&&(this._lexer=new gt(dt.toString(this.data.readAll(),this.settings.importer.encoding))),this._lexer.logErrors=this.logErrors,this._lexer.allowTuning=!0,this._lyrics=new Map,this._sustainPedalToBeat=new Map,this._lexer.init(),this.createDefaultScore(),this._currentDuration=k.Quarter,this._currentDynamics=f.F,this._currentTuplet=1,this.sy===ve.LowerThan)throw new Ze("Unknown start sign '<' (meant to import as XML?)");if(this.sy!==ve.Eof){const e=this.metaData(),t=this.bars();if(!e&&!t)throw new Ze("No alphaTex data found");this.sy===ve.Dot&&(this.sy=this.newSy(),this.syncPoints())}De.consolidate(this._score),this._score.finish(this.settings),De.trimEmptyBarsAtEnd(this._score),this._score.rebuildRepeatGroups(),this._score.applyFlatSyncPoints(this._syncPoints);for(const[e,t]of this._lyrics)this._score.tracks[e].applyLyrics(t);for(const[e,t]of this._sustainPedalToBeat){const s=t.voice.bar.masterBar.calculateDuration();e.ratioPosition=t.playbackStart/s}return this._score}catch(e){if(e instanceof mt)throw new Ze(e.message,e);throw e}}syncPoints(){for(;this.sy!==ve.Eof;)this.syncPoint()}syncPoint(){this.sy===ve.MetaCommand&&"sync"===this.syData||this.error("syncPoint",ve.MetaCommand,!0),this.sy=this.newSy(),this.sy!==ve.Number&&this.error("syncPointBarIndex",ve.Number,!0);const e=this.syData;this.sy=this.newSy(),this.sy!==ve.Number&&this.error("syncPointBarOccurence",ve.Number,!0);const t=this.syData;this.sy=this.newSy(),this.sy!==ve.Number&&this.error("syncPointBarMillis",ve.Number,!0);const s=this.syData;this.sy=this.newSy(!0);let i=0;this.sy===ve.Number&&(i=this.syData,this.sy=this.newSy()),this._syncPoints.push({barIndex:e,barOccurence:t,barPosition:i,millisecondOffset:s})}error(e,t,s=!0){let i,a=!1;s?(i=this.sy,i!==ve.String&&i!==ve.Number&&i!==ve.MetaCommand||(a=!0)):(i=t,a=!0);const r=mt.symbolError(this._lexer.lastValidSpot[0],this._lexer.lastValidSpot[1],this._lexer.lastValidSpot[2],e,t,i,a?this.syData:null);throw this.logErrors&&ee.error(this.name,r.message),r}errorMessage(e){const t=mt.errorMessage(e,this._lexer.lastValidSpot[0],this._lexer.lastValidSpot[1],this._lexer.lastValidSpot[2]);throw this.logErrors&&ee.error(this.name,t.message),t}createDefaultScore(){this._score=new Ke,this._score.tempo=120,this._score.tempoLabel="",this.newTrack()}newTrack(){this._currentTrack=new lt,this._currentTrack.ensureStaveCount(1),this._currentTrack.playbackInfo.program=25,this._currentTrack.playbackInfo.primaryChannel=this._trackChannel++,this._currentTrack.playbackInfo.secondaryChannel=this._trackChannel++;const e=this._currentTrack.staves[0];e.displayTranspositionPitch=0,e.stringTuning.tunings=nt.getDefaultTuningFor(6).tunings,this._articulationValueToIndex.clear(),this.beginStaff(e),this._score.addTrack(this._currentTrack),this._lyrics.set(this._currentTrack.index,[]),this._currentDynamics=f.F}parseClefFromString(e){switch(e.toLowerCase()){case"g2":case"treble":default:return h.G2;case"f4":case"bass":return h.F4;case"c3":case"alto":return h.C3;case"c4":case"tenor":return h.C4;case"n":case"neutral":return h.Neutral}}parseClefFromInt(e){switch(e){case 0:return h.Neutral;case 43:default:return h.G2;case 65:return h.F4;case 48:return h.C3;case 60:return h.C4}}parseTripletFeelFromString(e){switch(e.toLowerCase()){case"no":case"none":case"notripletfeel":default:return A.NoTripletFeel;case"t16":case"triplet-16th":case"triplet16th":return A.Triplet16th;case"t8":case"triplet-8th":case"triplet8th":return A.Triplet8th;case"d16":case"dotted-16th":case"dotted16th":return A.Dotted16th;case"d8":case"dotted-8th":case"dotted8th":return A.Dotted8th;case"s16":case"scottish-16th":case"scottish16th":return A.Scottish16th;case"s8":case"scottish-8th":case"scottish8th":return A.Scottish8th}}parseTripletFeelFromInt(e){switch(e){case 0:default:return A.NoTripletFeel;case 1:return A.Triplet16th;case 2:return A.Triplet8th;case 3:return A.Dotted16th;case 4:return A.Dotted8th;case 5:return A.Scottish16th;case 6:return A.Scottish8th}}parseKeySignature(e){switch(e.toLowerCase()){case"cb":case"cbmajor":case"abminor":return d.Cb;case"gb":case"gbmajor":case"ebminor":return d.Gb;case"db":case"dbmajor":case"bbminor":return d.Db;case"ab":case"abmajor":case"fminor":return d.Ab;case"eb":case"ebmajor":case"cminor":return d.Eb;case"bb":case"bbmajor":case"gminor":return d.Bb;case"f":case"fmajor":case"dminor":return d.F;case"c":case"cmajor":case"aminor":default:return d.C;case"g":case"gmajor":case"eminor":return d.G;case"d":case"dmajor":case"bminor":return d.D;case"a":case"amajor":case"f#minor":return d.A;case"e":case"emajor":case"c#minor":return d.E;case"b":case"bmajor":case"g#minor":return d.B;case"f#":case"f#major":case"d#minor":return d.FSharp;case"c#":case"c#major":case"a#minor":return d.CSharp}}parseKeySignatureType(e){return e.toLowerCase().endsWith("minor")?u.Minor:u.Major}metaData(){let e=!1,t=!1,s=!0;for(;this.sy===ve.MetaCommand&&s;){const i=this.syData.toLowerCase();switch(i){case"title":case"subtitle":case"artist":case"album":case"words":case"music":case"copyright":case"instructions":case"notices":case"tab":this.sy=this.newSy(),this.sy!==ve.String&&this.error(i,ve.String,!0);const a=this.syData;this.sy=this.newSy(),e=!0;let r=ke.ChordDiagramList;switch(i){case"title":this._score.title=a,r=ke.Title;break;case"subtitle":this._score.subTitle=a,r=ke.SubTitle;break;case"artist":this._score.artist=a,r=ke.Artist;break;case"album":this._score.album=a,r=ke.Album;break;case"words":this._score.words=a,r=ke.Words;break;case"music":this._score.music=a,r=ke.Music;break;case"copyright":this._score.copyright=a,r=ke.Copyright;break;case"instructions":this._score.instructions=a;break;case"notices":this._score.notices=a;break;case"tab":this._score.tab=a,r=ke.Transcriber}r!==ke.ChordDiagramList&&this.headerFooterStyle(r);break;case"copyright2":this.sy=this.newSy(),this.sy!==ve.String&&this.error(i,ve.String,!0),this.headerFooterStyle(ke.CopyrightSecondLine),e=!0;break;case"wordsandmusic":this.sy=this.newSy(),this.sy!==ve.String&&this.error(i,ve.String,!0),this.headerFooterStyle(ke.WordsAndMusic),e=!0;break;case"tempo":this.sy=this.newSy(!0),this.sy===ve.Number?this._score.tempo=this.syData:this.error("tempo",ve.Number,!0),this.sy=this.newSy(),this.sy===ve.String&&(this._score.tempoLabel=this.syData,this.sy=this.newSy()),e=!0;break;case"defaultsystemslayout":this.sy=this.newSy(),this.sy===ve.Number?(this._score.defaultSystemsLayout=this.syData,this.sy=this.newSy(),e=!0):this.error("default-systems-layout",ve.Number,!0);break;case"systemslayout":for(this.sy=this.newSy(),e=!0;this.sy===ve.Number;)this._score.systemsLayout.push(this.syData),this.sy=this.newSy();break;case"hidedynamics":this._score.stylesheet.hideDynamics=!0,this.sy=this.newSy(),e=!0;break;case"showdynamics":this._score.stylesheet.hideDynamics=!1,this.sy=this.newSy(),e=!0;break;case"bracketextendmode":this.sy=this.newSy(),this.sy!==ve.String&&this.error("bracketExtendMode",ve.String,!0),this._score.stylesheet.bracketExtendMode=this.parseBracketExtendMode(this.syData),this.sy=this.newSy(),e=!0;break;case"usesystemsignseparator":this._score.stylesheet.useSystemSignSeparator=!0,this.sy=this.newSy(),e=!0;break;case"multibarrest":this._score.stylesheet.multiTrackMultiBarRest=!0,this.sy=this.newSy(),e=!0;break;case"singletracktracknamepolicy":this.sy=this.newSy(),this.sy!==ve.String&&this.error("singleTrackTrackNamePolicy",ve.String,!0),this._score.stylesheet.singleTrackTrackNamePolicy=this.parseTrackNamePolicy(this.syData),this.sy=this.newSy(),e=!0;break;case"multitracktracknamepolicy":this.sy=this.newSy(),this.sy!==ve.String&&this.error("multiTrackTrackNamePolicy",ve.String,!0),this._score.stylesheet.multiTrackTrackNamePolicy=this.parseTrackNamePolicy(this.syData),this.sy=this.newSy(),e=!0;break;case"firstsystemtracknamemode":this.sy=this.newSy(),this.sy!==ve.String&&this.error("firstSystemTrackNameMode",ve.String,!0),this._score.stylesheet.firstSystemTrackNameMode=this.parseTrackNameMode(this.syData),this.sy=this.newSy(),e=!0;break;case"othersystemstracknamemode":this.sy=this.newSy(),this.sy!==ve.String&&this.error("otherSystemsTrackNameMode",ve.String,!0),this._score.stylesheet.otherSystemsTrackNameMode=this.parseTrackNameMode(this.syData),this.sy=this.newSy(),e=!0;break;case"firstsystemtracknameorientation":this.sy=this.newSy(),this.sy!==ve.String&&this.error("firstSystemTrackNameOrientation",ve.String,!0),this._score.stylesheet.firstSystemTrackNameOrientation=this.parseTrackNameOrientation(this.syData),this.sy=this.newSy(),e=!0;break;case"othersystemstracknameorientation":this.sy=this.newSy(),this.sy!==ve.String&&this.error("otherSystemsTrackNameOrientation",ve.String,!0),this._score.stylesheet.otherSystemsTrackNameOrientation=this.parseTrackNameOrientation(this.syData),this.sy=this.newSy(),e=!0;break;default:switch(this.handleStaffMeta()){case Ee.KnownStaffMeta:t=!0;break;case Ee.UnknownStaffMeta:e||t?this.error("metaDataTags",ve.String,!1):s=!1;break;case Ee.EndOfMetaDetected:s=!1}}}return e?(this.sy!==ve.Dot&&this.error("song",ve.Dot,!0),this.sy=this.newSy()):this.sy===ve.Dot&&(this.sy=this.newSy(),e=!0),e||t}headerFooterStyle(e){const t=De.getOrCreateHeaderFooterStyle(this._score,e);if(void 0===t.isVisible&&(t.isVisible=!0),this.sy===ve.String){const e=this.syData;e?t.template=e:t.isVisible=!1,this.sy=this.newSy()}if(this.sy===ve.String){switch(this.syData.toLowerCase()){case"left":t.textAlign=we.Left;break;case"center":t.textAlign=we.Center;break;case"right":t.textAlign=we.Right}this.sy=this.newSy()}}parseTrackNamePolicy(e){switch(e.toLowerCase()){case"hidden":return r.Hidden;case"allsystems":return r.AllSystems;default:return r.FirstSystem}}parseTrackNameMode(e){return"fullname"===e.toLowerCase()?n.FullName:n.ShortName}parseTrackNameOrientation(e){return"horizontal"===e.toLowerCase()?o.Horizontal:o.Vertical}handleStaffMeta(){switch(this.syData.toLowerCase()){case"capo":return this.sy=this.newSy(),this.sy===ve.Number?this._currentStaff.capo=this.syData:this.error("capo",ve.Number,!0),this.sy=this.newSy(),Ee.KnownStaffMeta;case"tuning":this.sy=this.newSy();const e=this._currentStaff.tuning.length;switch(this._staffHasExplicitTuning=!0,this._staffTuningApplied=!1,this.sy){case ve.String:const e=this.syData.toLowerCase();"piano"===e||"none"===e||"voice"===e?this.makeCurrentStaffPitched():this.error("tuning",ve.Tuning,!0),this.sy=this.newSy();break;case ve.Tuning:const t=[];do{const e=this.syData;t.push(e.realValue),this.sy=this.newSy()}while(this.sy===ve.Tuning);this._currentStaff.stringTuning.tunings=t;break;default:this.error("tuning",ve.Tuning,!0)}return this.sy===ve.String&&("hide"===this.syData.toLowerCase()?(this._score.stylesheet.perTrackDisplayTuning||(this._score.stylesheet.perTrackDisplayTuning=new Map),this._score.stylesheet.perTrackDisplayTuning.set(this._currentTrack.index,!1),this.sy=this.newSy(),this.sy===ve.String&&(this._currentStaff.stringTuning.name=this.syData,this.sy=this.newSy())):(this._currentStaff.stringTuning.name=this.syData,this.sy=this.newSy())),e!==this._currentStaff.tuning.length&&(this._currentStaff.chords?.size??0)>0&&this.errorMessage("Tuning must be defined before any chord"),Ee.KnownStaffMeta;case"instrument":return this._staffTuningApplied=!1,this.readTrackInstrument(),Ee.KnownStaffMeta;case"bank":return this.sy=this.newSy(),this.sy!==ve.Number&&this.error("bank",ve.Number,!0),this._currentTrack.playbackInfo.bank=this.syData,this.sy=this.newSy(),Ee.KnownStaffMeta;case"lyrics":this.sy=this.newSy();const t=new tt;return t.startBar=0,t.text="",this.sy===ve.Number&&(t.startBar=this.syData,this.sy=this.newSy()),this.sy===ve.String?(t.text=this.syData,this.sy=this.newSy()):this.error("lyrics",ve.String,!0),this._lyrics.get(this._currentTrack.index).push(t),Ee.KnownStaffMeta;case"chord":this.sy=this.newSy();const s=new et;this.chordProperties(s),this.sy===ve.String?(s.name=this.syData,this.sy=this.newSy()):this.error("chord-name",ve.String,!0);for(let e=0;e<this._currentStaff.tuning.length;e++)this.sy===ve.Number?s.strings.push(this.syData):this.sy===ve.String&&"x"===this.syData.toLowerCase()&&s.strings.push(-1),this.sy=this.newSy();return this._currentStaff.addChord(this.getChordId(this._currentStaff,s.name),s),Ee.KnownStaffMeta;case"articulation":this.sy=this.newSy();let i="";if(this.sy===ve.String?(i=this.syData,this.sy=this.newSy()):this.error("articulation-name",ve.String,!0),"defaults"===i){for(const[e,t]of Ie.instrumentArticulationNames)this._percussionArticulationNames.set(e.toLowerCase(),t),this._percussionArticulationNames.set(ft.toArticulationId(e),t);return Ee.KnownStaffMeta}let a=0;return this.sy===ve.Number?(a=this.syData,this.sy=this.newSy()):this.error("articulation-number",ve.Number,!0),Ie.instrumentArticulations.has(a)||this.errorMessage(`Unknown articulation ${a}. Refer to https://www.alphatab.net/docs/alphatex/percussion for available ids`),this._percussionArticulationNames.set(i.toLowerCase(),a),Ee.KnownStaffMeta;case"accidentals":return this.handleAccidentalMode(),Ee.KnownStaffMeta;case"displaytranspose":return this.sy=this.newSy(),this.sy===ve.Number?(this._currentStaff.displayTranspositionPitch=-1*this.syData,this._staffHasExplicitDisplayTransposition=!0):this.error("displaytranspose",ve.Number,!0),this.sy=this.newSy(),Ee.KnownStaffMeta;case"transpose":return this.sy=this.newSy(),this.sy===ve.Number?this._currentStaff.transpositionPitch=-1*this.syData:this.error("transpose",ve.Number,!0),this.sy=this.newSy(),Ee.KnownStaffMeta;case"track":case"staff":return Ee.EndOfMetaDetected;case"voice":return this.sy=this.newSy(),this.handleNewVoice()?Ee.EndOfMetaDetected:Ee.KnownStaffMeta;default:return Ee.UnknownStaffMeta}}readTrackInstrument(){if(this.sy=this.newSy(),this.sy===ve.Number){const e=this.syData;e>=0&&e<=127?this._currentTrack.playbackInfo.program=this.syData:this.error("instrument",ve.Number,!1)}else if(this.sy===ve.String){const e=this.syData.toLowerCase();if("percussion"===e){for(const e of this._currentTrack.staves)this.applyPercussionStaff(e);this._currentTrack.playbackInfo.primaryChannel=se.PercussionChannel,this._currentTrack.playbackInfo.secondaryChannel=se.PercussionChannel}else this._currentTrack.playbackInfo.program=H.getValue(e)}else this.error("instrument",ve.Number,!0);this.sy=this.newSy()}handleAccidentalMode(){switch(this.sy=this.newSy(),this.sy!==ve.String&&this.error("accidental-mode",ve.String,!0),this.syData){case"auto":this._accidentalMode=Me.Auto;break;case"explicit":this._accidentalMode=Me.Explicit}this.sy=this.newSy()}makeCurrentStaffPitched(){this._currentStaff.stringTuning.tunings=[],this._staffHasExplicitDisplayTransposition||(this._currentStaff.displayTranspositionPitch=0)}static toArticulationId(e){return e.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}applyPercussionStaff(e){e.isPercussion=!0,e.showTablature=!1,e.track.playbackInfo.program=0}chordProperties(e){if(this.sy===ve.LBrace){for(this.sy=this.newSy();this.sy===ve.String;)switch(this.syData.toLowerCase()){case"firstfret":if(this.sy=this.newSy(),this.sy===ve.Number)e.firstFret=this.syData;else this.error("chord-firstfret",ve.Number,!0);this.sy=this.newSy();break;case"showdiagram":switch(this.sy=this.newSy(),this.sy){case ve.String:e.showDiagram="false"!==this.syData.toLowerCase();break;case ve.Number:e.showDiagram=0!==this.syData;break;default:this.error("chord-showdiagram",ve.String,!0)}this.sy=this.newSy();break;case"showfingering":switch(this.sy=this.newSy(),this.sy){case ve.String:e.showDiagram="false"!==this.syData.toLowerCase();break;case ve.Number:e.showFingering=0!==this.syData;break;default:this.error("chord-showfingering",ve.String,!0)}this.sy=this.newSy();break;case"showname":switch(this.sy=this.newSy(),this.sy){case ve.String:e.showName="false"!==this.syData.toLowerCase();break;case ve.Number:e.showName=0!==this.syData;break;default:this.error("chord-showname",ve.String,!0)}this.sy=this.newSy();break;case"barre":for(this.sy=this.newSy();this.sy===ve.Number;)e.barreFrets.push(this.syData),this.sy=this.newSy();break;default:this.error("chord-properties",ve.String,!1)}this.sy!==ve.RBrace&&this.error("chord-properties",ve.RBrace,!0),this.sy=this.newSy()}}bars(){const e=this.bar();for(;this.sy!==ve.Eof;)if(this.sy===ve.Pipe)this.sy=this.newSy(),this.bar();else{if(this.sy!==ve.MetaCommand)break;this.bar()}return e}trackStaffMeta(){if(this.sy!==ve.MetaCommand)return!1;if("track"===this.syData.toLowerCase()&&(this._staffHasExplicitDisplayTransposition=!1,this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._staffDisplayTranspositionApplied=!1,this._ignoredInitialVoice=!1,this.sy=this.newSy(),this._score.masterBars.length>0&&this.newTrack(),this.sy===ve.String&&(this._currentTrack.name=this.syData,this.sy=this.newSy()),this.sy===ve.String&&(this._currentTrack.shortName=this.syData,this.sy=this.newSy()),this.trackProperties()),this.sy===ve.MetaCommand&&"staff"===this.syData.toLowerCase()){if(this._staffHasExplicitDisplayTransposition=!1,this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._staffDisplayTranspositionApplied=!1,this._ignoredInitialVoice=!1,this.sy=this.newSy(),this._currentTrack.staves[0].bars.length>0){const e=this._currentStaff.isPercussion;this._currentTrack.ensureStaveCount(this._currentTrack.staves.length+1),this.beginStaff(this._currentTrack.staves[this._currentTrack.staves.length-1]),e&&this.applyPercussionStaff(this._currentStaff),this._currentDynamics=f.F}this.staffProperties()}return this.sy===ve.MetaCommand&&"voice"===this.syData.toLowerCase()&&(this.sy=this.newSy(),this.handleNewVoice()),!0}handleNewVoice(){if(0===this._voiceIndex&&(0===this._currentStaff.bars.length||1===this._currentStaff.bars.length&&this._currentStaff.bars[0].isEmpty&&!this._ignoredInitialVoice))return this._ignoredInitialVoice=!0,!1;for(const e of this._currentStaff.bars){const t=new re;e.addVoice(t)}return this._voiceIndex++,this._barIndex=0,!0}beginStaff(e){this._currentStaff=e,this._slurs.clear(),this._barIndex=0,this._voiceIndex=0}trackProperties(){if(this.sy===ve.LBrace){for(this.sy=this.newSy();this.sy===ve.String;)switch(this.syData.toLowerCase()){case"color":this.sy=this.newSy(),this.sy!==ve.String&&this.error("track-color",ve.String,!0),this._currentTrack.color=at.fromJson(this.syData),this.sy=this.newSy();break;case"defaultsystemslayout":this.sy=this.newSy(),this.sy===ve.Number?(this._currentTrack.defaultSystemsLayout=this.syData,this.sy=this.newSy()):this.error("default-systems-layout",ve.Number,!0);break;case"systemslayout":for(this.sy=this.newSy();this.sy===ve.Number;)this._currentTrack.systemsLayout.push(this.syData),this.sy=this.newSy();break;case"volume":this.sy=this.newSy(),this.sy!==ve.Number&&this.error("track-volume",ve.Number,!0),this._currentTrack.playbackInfo.volume=De.clamp(this.syData,0,16),this.sy=this.newSy();break;case"balance":this.sy=this.newSy(),this.sy!==ve.Number&&this.error("track-balance",ve.Number,!0),this._currentTrack.playbackInfo.balance=De.clamp(this.syData,0,16),this.sy=this.newSy();break;case"mute":this.sy=this.newSy(),this._currentTrack.playbackInfo.isMute=!0;break;case"solo":this.sy=this.newSy(),this._currentTrack.playbackInfo.isSolo=!0;break;case"multibarrest":this.sy=this.newSy(),this._score.stylesheet.perTrackMultiBarRest||(this._score.stylesheet.perTrackMultiBarRest=new Set),this._score.stylesheet.perTrackMultiBarRest.add(this._currentTrack.index);break;case"instrument":this.readTrackInstrument();break;case"bank":this.sy=this.newSy(),this.sy!==ve.Number&&this.error("bank",ve.Number,!0),this._currentTrack.playbackInfo.bank=this.syData,this.sy=this.newSy();break;default:this.error("track-properties",ve.String,!1)}this.sy!==ve.RBrace&&this.error("track-properties",ve.RBrace,!0),this.sy=this.newSy()}}staffProperties(){if(this.sy!==ve.LBrace)return;this.sy=this.newSy();let e=!1,t=!1,s=!1,i=!1;for(;this.sy===ve.String;)switch(this.syData.toLowerCase()){case"score":e=!0,this.sy=this.newSy(),this.sy===ve.Number&&(this._currentStaff.standardNotationLineCount=this.syData,this.sy=this.newSy());break;case"tabs":t=!0,this.sy=this.newSy();break;case"slash":s=!0,this.sy=this.newSy();break;case"numbered":i=!0,this.sy=this.newSy();break;default:this.error("staff-properties",ve.String,!1)}(e||t||s||i)&&(this._currentStaff.showStandardNotation=e,this._currentStaff.showTablature=t,this._currentStaff.showSlash=s,this._currentStaff.showNumbered=i),this.sy!==ve.RBrace&&this.error("staff-properties",ve.RBrace,!0),this.sy=this.newSy()}bar(){const e=this.trackStaffMeta(),t=this.newBar(this._currentStaff);if(this._currentStaff.bars.length>this._score.masterBars.length){const e=new te;this._score.addMasterBar(e),e.index>0&&(e.timeSignatureDenominator=e.previousMasterBar.timeSignatureDenominator,e.timeSignatureNumerator=e.previousMasterBar.timeSignatureNumerator,e.tripletFeel=e.previousMasterBar.tripletFeel)}const s=this.barMeta(t),i=this._currentTrack.playbackInfo.program;this._staffTuningApplied||this._staffHasExplicitTuning||(this._currentStaff.stringTuning.tunings=[],15===i||i>=24&&i<=31?this._currentStaff.stringTuning.tunings=nt.getDefaultTuningFor(6).tunings:i>=32&&i<=39?this._currentStaff.stringTuning.tunings=[43,38,33,28]:40===i||44===i||45===i||48===i||49===i||50===i||51===i?this._currentStaff.stringTuning.tunings=[52,57,50,43]:41===i?this._currentStaff.stringTuning.tunings=[57,50,43,36]:42===i?this._currentStaff.stringTuning.tunings=[45,38,31,24]:43===i?this._currentStaff.stringTuning.tunings=[43,38,33,28]:105===i?this._currentStaff.stringTuning.tunings=[50,47,43,38,55]:106===i?this._currentStaff.stringTuning.tunings=[57,52,45]:107===i?this._currentStaff.stringTuning.tunings=[52,45,38,31]:110===i&&(this._currentStaff.stringTuning.tunings=[64,57,50,43]),this._staffTuningApplied=!0),this._staffDisplayTranspositionApplied||this._staffHasExplicitDisplayTransposition||(De.displayTranspositionPitches.has(i)?this._currentStaff.displayTranspositionPitch=De.displayTranspositionPitches.get(i):this._currentStaff.displayTranspositionPitch=0,this._staffDisplayTranspositionApplied=!0);let a=!1;const r=t.voices[this._voiceIndex];if(!(this.sy===ve.MetaCommand&&("track"===this.syData.toLowerCase()||"staff"===this.syData.toLowerCase())))for(;this.sy!==ve.Pipe&&this.sy!==ve.Eof&&this.beat(r);)a=!0;if(0===r.beats.length){const e=new Ye;e.isEmpty=!0,r.addBeat(e)}return e||s||a}newBar(e){if(this._barIndex<e.bars.length){const t=e.bars[this._barIndex];return this._barIndex++,t}const t=0===e.bars.length?1:e.bars[0].voices.length,s=new Y;e.addBar(s),s.previousBar&&(s.clef=s.previousBar.clef,s.clefOttava=s.previousBar.clefOttava,s.keySignature=s.previousBar.keySignature,s.keySignatureType=s.previousBar.keySignatureType),this._barIndex++,s.index>0&&(s.clef=s.previousBar.clef);for(let e=0;e<t;e++){const e=new re;s.addVoice(e)}return s}beat(e){this.beatDuration();const t=new Ye;if(e.addBeat(t),this._lexer.allowTuning=!this._currentStaff.isPercussion,this.sy===ve.LParensis){for(this.sy=this.newSy(),this.note(t);this.sy!==ve.RParensis&&this.sy!==ve.Eof&&(this._lexer.allowTuning=!this._currentStaff.isPercussion,this.note(t)););this.sy!==ve.RParensis&&this.error("note-list",ve.RParensis,!0),this.sy=this.newSy()}else if(this.sy===ve.String&&"r"===this.syData.toLowerCase())this.sy=this.newSy();else if(!this.note(t))return e.beats.splice(e.beats.length-1,1),!1;this.sy===ve.Dot&&(this.sy=this.newSy(),this.sy!==ve.Number&&this.error("duration",ve.Number,!0),this._currentDuration=this.parseDuration(this.syData),this.sy=this.newSy()),t.duration=this._currentDuration,t.dynamics=this._currentDynamics,1===this._currentTuplet||t.hasTuplet||ft.applyTuplet(t,this._currentTuplet);let s=1;this.sy===ve.Multiply&&(this.sy=this.newSy(),this.sy!==ve.Number?this.error("multiplier",ve.Number,!0):s=this.syData,this.sy=this.newSy()),this.beatEffects(t);for(let i=0;i<s-1;i++)e.addBeat(ze.clone(t));return!0}beatDuration(){if(this.sy===ve.DoubleDot&&(this.sy=this.newSy(),this.sy!==ve.Number&&this.error("duration",ve.Number,!0),this._currentDuration=this.parseDuration(this.syData),this._currentTuplet=1,this.sy=this.newSy(),this.sy===ve.LBrace)){for(this.sy=this.newSy();this.sy===ve.String;){if("tu"===this.syData.toLowerCase())this.sy=this.newSy(),this.sy!==ve.Number&&this.error("duration-tuplet",ve.Number,!0),this._currentTuplet=this.syData,this.sy=this.newSy();else this.error("beat-duration",ve.String,!1)}this.sy!==ve.RBrace&&this.error("beat-duration",ve.RBrace,!0),this.sy=this.newSy()}}beatEffects(e){if(this.sy===ve.LBrace){for(this.sy=this.newSy();this.sy===ve.String;)this.applyBeatEffect(e)||this.error("beat-effects",ve.String,!1);this.sy!==ve.RBrace&&this.error("beat-effects",ve.RBrace,!0),this.sy=this.newSy()}}applyBeatEffect(e){const t=this.syData.toLowerCase();if("f"===t)e.fade=me.FadeIn;else if("fo"===t)e.fade=me.FadeOut;else if("vs"===t)e.fade=me.VolumeSwell;else if("v"===t)e.vibrato=M.Slight;else if("vw"===t)e.vibrato=M.Wide;else if("s"===t)e.slap=!0;else if("p"===t)e.pop=!0;else if("tt"===t)e.tap=!0;else if("txt"===t){if(this.sy=this.newSy(),this.sy!==ve.String)return this.error("beat-text",ve.String,!0),!1;e.text=this.syData}else if("lyrics"===t){this.sy=this.newSy();let t=0;if(this.sy===ve.Number&&(t=this.syData,this.sy=this.newSy()),this.sy!==ve.String)return this.error("lyrics",ve.String,!0),!1;for(e.lyrics||(e.lyrics=[]);e.lyrics.length<=t;)e.lyrics.push("");e.lyrics[t]=this.syData}else if("dd"===t)e.dots=2;else if("d"===t)e.dots=1;else if("su"===t)e.pickStroke=he.Up;else if("sd"===t)e.pickStroke=he.Down;else{if("tu"===t){if(this.sy=this.newSy(),this.sy!==ve.Number)return this.error("tuplet",ve.Number,!0),!1;const t=this.syData;if(this.sy=this.newSy(),this.sy===ve.Number){const s=this.syData;this.sy=this.newSy(),e.tupletNumerator=t,e.tupletDenominator=s}else ft.applyTuplet(e,t);return!0}if("tb"===t||"tbe"===t){this.sy=this.newSy();const s="tbe"===t;for(this.sy===ve.String&&(e.whammyBarType=this.parseWhammyType(this.syData),this.sy=this.newSy()),this.sy===ve.String&&(e.whammyStyle=this.parseBendStyle(this.syData),this.sy=this.newSy()),this.sy!==ve.LParensis&&this.error("tremolobar-effect",ve.LParensis,!0),this.sy=this.newSy(!0);this.sy!==ve.RParensis&&this.sy!==ve.Eof;){let t=0,i=0;s?(this.sy!==ve.Number&&this.error("tremolobar-effect",ve.Number,!0),t=this.syData,this.sy=this.newSy(!0),this.sy!==ve.Number&&this.error("tremolobar-effect",ve.Number,!0),i=this.syData):(this.sy!==ve.Number&&this.error("tremolobar-effect",ve.Number,!0),t=0,i=this.syData),e.addWhammyBarPoint(new j(t,i)),this.sy=this.newSy(!0)}if(null!=e.whammyBarPoints){for(;e.whammyBarPoints.length>60;)e.removeWhammyBarPoint(e.whammyBarPoints.length-1);if(s)e.whammyBarPoints.sort((e,t)=>e.offset-t.offset);else{const t=e.whammyBarPoints.length,s=j.MaxPosition/(t-1)|0;let i=0;for(;i<t;)e.whammyBarPoints[i].offset=Math.min(j.MaxPosition,i*s),i++}}this.sy!==ve.RParensis&&this.error("tremolobar-effect",ve.RParensis,!0)}else{if("bu"===t||"bd"===t||"au"===t||"ad"===t){switch(t){case"bu":e.brushType=w.BrushUp;break;case"bd":e.brushType=w.BrushDown;break;case"au":e.brushType=w.ArpeggioUp;break;case"ad":e.brushType=w.ArpeggioDown}return this.sy=this.newSy(),this.sy===ve.Number?(e.brushDuration=this.syData,this.sy=this.newSy(),!0):(e.updateDurations(),"bu"===t||"bd"===t?e.brushDuration=e.playbackDuration/4/e.notes.length:"au"!==t&&"ad"!==t||(e.brushDuration=e.playbackDuration/e.notes.length),!0)}if("ch"===t){this.sy=this.newSy();const t=this.syData,s=this.getChordId(this._currentStaff,t);if(!this._currentStaff.hasChord(s)){const e=new et;e.showDiagram=!1,e.name=t,this._currentStaff.addChord(s,e)}e.chordId=s}else{if("gr"===t)return this.sy=this.newSy(),"ob"===this.syData.toLowerCase()?(e.graceType=T.OnBeat,this.sy=this.newSy()):"b"===this.syData.toLowerCase()?(e.graceType=T.BendGrace,this.sy=this.newSy()):e.graceType=T.BeforeBeat,!0;if("dy"===t){this.sy=this.newSy();const t=this.syData.toUpperCase();switch(t){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":e.dynamics=f[t]}this._currentDynamics=e.dynamics}else if("cre"===t)e.crescendo=B.Crescendo;else if("dec"===t)e.crescendo=B.Decrescendo;else{if("tempo"===t){const t=this.readTempoAutomation(!1);return e.automations.push(t),e.voice.bar.masterBar.tempoAutomations.push(t),!0}if("volume"===t){this.sy=this.newSy(),this.sy!==ve.Number&&this.error("volume",ve.Number,!0);const t=new q;return t.isLinear=!0,t.type=y.Volume,t.value=this.syData,this.sy=this.newSy(),e.automations.push(t),!0}if("balance"===t){this.sy=this.newSy(),this.sy!==ve.Number&&this.error("balance",ve.Number,!0);const t=new q;return t.isLinear=!0,t.type=y.Balance,t.value=De.clamp(this.syData,0,16),this.sy=this.newSy(),e.automations.push(t),!0}if("tp"===t){if(this.sy=this.newSy(),e.tremoloSpeed=k.Eighth,this.sy===ve.Number){switch(this.syData){case 8:default:e.tremoloSpeed=k.Eighth;break;case 16:e.tremoloSpeed=k.Sixteenth;break;case 32:e.tremoloSpeed=k.ThirtySecond}this.sy=this.newSy()}return!0}if("spd"===t){const t=new z;return t.pedalType=p.Down,t.ratioPosition=e.voice.bar.sustainPedals.length,this._sustainPedalToBeat.set(t,e),e.voice.bar.sustainPedals.push(t),this.sy=this.newSy(),!0}if("sph"===t){const t=new z;return t.pedalType=p.Hold,t.ratioPosition=e.voice.bar.sustainPedals.length,this._sustainPedalToBeat.set(t,e),e.voice.bar.sustainPedals.push(t),this.sy=this.newSy(),!0}if("spu"===t){const t=new z;return t.pedalType=p.Up,t.ratioPosition=e.voice.bar.sustainPedals.length,this._sustainPedalToBeat.set(t,e),e.voice.bar.sustainPedals.push(t),this.sy=this.newSy(),!0}if("spe"===t){const t=new z;return t.pedalType=p.Up,t.ratioPosition=1,e.voice.bar.sustainPedals.push(t),this.sy=this.newSy(),!0}if("slashed"===t)return e.slashed=!0,this.sy=this.newSy(),!0;if("ds"===t)return e.deadSlapped=!0,this.sy=this.newSy(),1===e.notes.length&&e.notes[0].isDead&&e.removeNote(e.notes[0]),!0;if("glpf"===t)return this.sy=this.newSy(),e.golpe=pe.Finger,!0;if("glpt"===t)return this.sy=this.newSy(),e.golpe=pe.Thumb,!0;if("waho"===t)return this.sy=this.newSy(),e.wahPedal=ge.Open,!0;if("wahc"===t)return this.sy=this.newSy(),e.wahPedal=ge.Closed,!0;if("barre"===t){if(this.sy=this.newSy(),this.sy!==ve.Number&&this.error("beat-barre",ve.Number,!0),e.barreFret=this.syData,e.barreShape=fe.Full,this.sy=this.newSy(),this.sy===ve.String)switch(this.syData.toLowerCase()){case"full":e.barreShape=fe.Full,this.sy=this.newSy();break;case"half":e.barreShape=fe.Half,this.sy=this.newSy()}return!0}if("rasg"===t){switch(this.sy=this.newSy(),this.sy!==ve.String&&this.error("rasgueado",ve.String,!0),this.syData.toLowerCase()){case"ii":e.rasgueado=ye.Ii;break;case"mi":e.rasgueado=ye.Mi;break;case"miitriplet":e.rasgueado=ye.MiiTriplet;break;case"miianapaest":e.rasgueado=ye.MiiAnapaest;break;case"pmptriplet":e.rasgueado=ye.PmpTriplet;break;case"pmpanapaest":e.rasgueado=ye.PmpAnapaest;break;case"peitriplet":e.rasgueado=ye.PeiTriplet;break;case"peianapaest":e.rasgueado=ye.PeiAnapaest;break;case"paitriplet":e.rasgueado=ye.PaiTriplet;break;case"paianapaest":e.rasgueado=ye.PaiAnapaest;break;case"amitriplet":e.rasgueado=ye.AmiTriplet;break;case"amianapaest":e.rasgueado=ye.AmiAnapaest;break;case"ppp":e.rasgueado=ye.Ppp;break;case"amii":e.rasgueado=ye.Amii;break;case"amip":e.rasgueado=ye.Amip;break;case"eami":e.rasgueado=ye.Eami;break;case"eamii":e.rasgueado=ye.Eamii;break;case"peami":e.rasgueado=ye.Peami}return this.sy=this.newSy(),!0}if("ot"===t)this.sy=this.newSy(),this.sy!==ve.String&&this.error("beat-ottava",ve.String,!0),e.ottava=this.parseClefOttavaFromString(this.syData);else if("legatoorigin"===t)e.isLegatoOrigin=!0;else if("instrument"===t){this.sy=this.newSy();let t=0;this.sy===ve.Number?t=this.syData:this.sy===ve.String?t=H.getValue(this.syData):this.error("instrument-change",ve.Number,!0);const s=new q;s.isLinear=!1,s.type=y.Instrument,s.value=t,e.automations.push(s)}else if("bank"===t){this.sy=this.newSy(),this.sy!==ve.Number&&this.error("bank-change",ve.Number,!0);const t=new q;t.isLinear=!1,t.type=y.Bank,t.value=this.syData,e.automations.push(t)}else{if("fermata"===t){this.sy=this.newSy(),this.sy!==ve.String&&this.error("fermata",ve.Number,!0);const t=new pt;return t.type=this.parseFermataFromString(this.syData),this.sy=this.newSy(!0),this.sy===ve.Number&&(t.length=this.syData,this.sy=this.newSy()),e.fermata=t,!0}if("beam"===t)switch(this.sy=this.newSy(),this.sy!==ve.String&&this.error("beam",ve.Number,!0),this.syData.toLowerCase()){case"invert":e.invertBeamDirection=!0;break;case"up":e.preferredBeamDirection=Pe.Up;break;case"down":e.preferredBeamDirection=Pe.Down;break;case"auto":e.beamingMode=be.Auto;break;case"split":e.beamingMode=be.ForceSplitToNext;break;case"merge":e.beamingMode=be.ForceMergeWithNext;break;case"splitsecondary":e.beamingMode=be.ForceSplitOnSecondaryToNext}else{if("timer"!==t)return!1;e.showTimer=!0}}}}}}return this.sy=this.newSy(),!0}parseBracketExtendMode(e){switch(e.toLowerCase()){case"nobrackets":return a.NoBrackets;case"groupstaves":default:return a.GroupStaves;case"groupsimilarinstruments":return a.GroupSimilarInstruments}}parseFermataFromString(e){switch(e.toLowerCase()){case"short":return Ne.Short;case"medium":default:return Ne.Medium;case"long":return Ne.Long}}parseClefOttavaFromString(e){switch(e.toLowerCase()){case"15ma":return l._15ma;case"8va":return l._8va;case"regular":default:return l.Regular;case"8vb":return l._8vb;case"15mb":return l._15mb}}getChordId(e,t){return t.toLowerCase()+e.index+e.track.index}static applyTuplet(e,t){switch(t){case 3:e.tupletNumerator=3,e.tupletDenominator=2;break;case 5:e.tupletNumerator=5,e.tupletDenominator=4;break;case 6:e.tupletNumerator=6,e.tupletDenominator=4;break;case 7:e.tupletNumerator=7,e.tupletDenominator=4;break;case 9:e.tupletNumerator=9,e.tupletDenominator=8;break;case 10:e.tupletNumerator=10,e.tupletDenominator=8;break;case 11:e.tupletNumerator=11,e.tupletDenominator=8;break;case 12:e.tupletNumerator=12,e.tupletDenominator=8;break;default:e.tupletNumerator=1,e.tupletDenominator=1}}isNoteText(e){return"x"===e||"-"===e||"r"===e}note(e){let t=!1,s=!1,i=-1,a=-1,r=-1,n=P.Default;switch(this.sy){case ve.Number:i=this.syData,this._currentStaff.isPercussion&&!Ie.instrumentArticulations.has(i)&&this.errorMessage(`Unknown percussion articulation ${i}`);break;case ve.String:if(this._currentStaff.isPercussion){const e=this.syData.toLowerCase();this._percussionArticulationNames.has(e)?i=this._percussionArticulationNames.get(e):this.errorMessage(`Unknown percussion articulation '${this.syData}'`)}else t="x"===this.syData,s="-"===this.syData,s||t?i=0:this.error("note-fret",ve.Number,!0);break;case ve.Tuning:0===e.index&&0===e.voice.index&&0===e.voice.bar.index&&this.makeCurrentStaffPitched();const o=this.syData;a=o.octave,r=o.tone.noteValue,this._accidentalMode===Me.Explicit&&(n=o.tone.accidentalMode);break;default:return!1}this.sy=this.newSy();const o=-1===a&&this._currentStaff.tuning.length>0&&!this._currentStaff.isPercussion;let h=-1;o&&(this.sy!==ve.Dot&&this.error("note",ve.Dot,!0),this.sy=this.newSy(),this.sy!==ve.Number&&this.error("note-string",ve.Number,!0),h=this.syData,(h<1||h>this._currentStaff.tuning.length)&&this.error("note-string",ve.Number,!1),this.sy=this.newSy());const l=new Oe;if(o)l.string=this._currentStaff.tuning.length-(h-1),l.isDead=t,l.isTieDestination=s,s||(l.fret=i);else if(this._currentStaff.isPercussion){const e=i;let t=0;if(this._articulationValueToIndex.has(e))t=this._articulationValueToIndex.get(e);else{t=this._currentTrack.percussionArticulations.length;const s=Ie.getArticulationByInputMidiNumber(e);null===s&&this.errorMessage(`Unknown articulation value ${e}`),this._currentTrack.percussionArticulations.push(s),this._articulationValueToIndex.set(e,t)}l.percussionArticulation=t}else l.octave=a,l.tone=r,l.accidentalMode=n,l.isTieDestination=s;return e.addNote(l),this.noteEffects(l),!0}noteEffects(e){if(this.sy===ve.LBrace){for(this.sy=this.newSy();this.sy===ve.String;){const t=this.syData.toLowerCase();if("b"===t||"be"===t){this.sy=this.newSy();const s="be"===t;for(this.sy===ve.String&&(e.bendType=this.parseBendType(this.syData),this.sy=this.newSy()),this.sy===ve.String&&(e.bendStyle=this.parseBendStyle(this.syData),this.sy=this.newSy()),this.sy!==ve.LParensis&&this.error("bend-effect",ve.LParensis,!0),this.sy=s?this.newSy(!0):this.newSy();this.sy!==ve.RParensis&&this.sy!==ve.Eof;){let t=0,i=0;s?(this.sy!==ve.Number&&this.error("bend-effect-value",ve.Number,!0),t=this.syData,this.sy=this.newSy(),this.sy!==ve.Number&&this.error("bend-effect-value",ve.Number,!0),i=this.syData):(this.sy!==ve.Number&&this.error("bend-effect-value",ve.Number,!0),i=this.syData),e.addBendPoint(new j(t,i)),this.sy=s?this.newSy(!0):this.newSy()}const i=e.bendPoints;if(null!=i){for(;i.length>60;)i.splice(i.length-1,1);if(s)i.sort((e,t)=>e.offset-t.offset);else{const e=i.length,t=60/(e-1)|0;let s=0;for(;s<e;)i[s].offset=Math.min(60,s*t),s++}}this.sy!==ve.RParensis&&this.error("bend-effect",ve.RParensis,!0),this.sy=this.newSy()}else if("nh"===t)e.harmonicType=N.Natural,e.harmonicValue=De.deltaFretToHarmonicValue(e.fret),this.sy=this.newSy();else if("ah"===t)e.harmonicType=N.Artificial,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("th"===t)e.harmonicType=N.Tap,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("ph"===t)e.harmonicType=N.Pinch,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("sh"===t)e.harmonicType=N.Semi,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("fh"===t)e.harmonicType=N.Feedback,e.harmonicValue=this.harmonicValue(e.harmonicValue);else if("tr"===t){this.sy=this.newSy(),this.sy!==ve.Number&&this.error("trill-effect",ve.Number,!0);const t=this.syData;this.sy=this.newSy();let s=k.Sixteenth;if(this.sy===ve.Number){switch(this.syData){case 16:default:s=k.Sixteenth;break;case 32:s=k.ThirtySecond;break;case 64:s=k.SixtyFourth}this.sy=this.newSy()}e.trillValue=t+e.stringTuning,e.trillSpeed=s}else if("v"===t)this.sy=this.newSy(),e.vibrato=M.Slight;else if("vw"===t)this.sy=this.newSy(),e.vibrato=M.Wide;else if("sl"===t)this.sy=this.newSy(),e.slideOutType=E.Legato;else if("ss"===t)this.sy=this.newSy(),e.slideOutType=E.Shift;else if("sib"===t)this.sy=this.newSy(),e.slideInType=v.IntoFromBelow;else if("sia"===t)this.sy=this.newSy(),e.slideInType=v.IntoFromAbove;else if("sou"===t)this.sy=this.newSy(),e.slideOutType=E.OutUp;else if("sod"===t)this.sy=this.newSy(),e.slideOutType=E.OutDown;else if("psd"===t)this.sy=this.newSy(),e.slideOutType=E.PickSlideDown;else if("psu"===t)this.sy=this.newSy(),e.slideOutType=E.PickSlideUp;else if("h"===t)this.sy=this.newSy(),e.isHammerPullOrigin=!0;else if("lht"===t)this.sy=this.newSy(),e.isLeftHandTapped=!0;else if("g"===t)this.sy=this.newSy(),e.isGhost=!0;else if("ac"===t)this.sy=this.newSy(),e.accentuated=_.Normal;else if("hac"===t)this.sy=this.newSy(),e.accentuated=_.Heavy;else if("ten"===t)this.sy=this.newSy(),e.accentuated=_.Tenuto;else if("pm"===t)this.sy=this.newSy(),e.isPalmMute=!0;else if("st"===t)this.sy=this.newSy(),e.isStaccato=!0;else if("lr"===t)this.sy=this.newSy(),e.isLetRing=!0;else if("x"===t)this.sy=this.newSy(),e.isDead=!0;else if("-"===t||"t"===t)this.sy=this.newSy(),e.isTieDestination=!0;else if("lf"===t){this.sy=this.newSy();let t=x.Thumb;this.sy===ve.Number&&(t=this.toFinger(this.syData),this.sy=this.newSy()),e.leftHandFinger=t}else if("rf"===t){this.sy=this.newSy();let t=x.Thumb;this.sy===ve.Number&&(t=this.toFinger(this.syData),this.sy=this.newSy()),e.rightHandFinger=t}else if("acc"===t)this.sy=this.newSy(),this.sy!==ve.String&&this.error("note-accidental",ve.String,!0),e.accidentalMode=De.parseAccidentalMode(this.syData),this.sy=this.newSy();else if("turn"===t)this.sy=this.newSy(),e.ornament=ce.Turn;else if("iturn"===t)this.sy=this.newSy(),e.ornament=ce.InvertedTurn;else if("umordent"===t)this.sy=this.newSy(),e.ornament=ce.UpperMordent;else if("lmordent"===t)this.sy=this.newSy(),e.ornament=ce.LowerMordent;else if("string"===t)this.sy=this.newSy(),e.showStringNumber=!0;else if("hide"===t)this.sy=this.newSy(),e.isVisible=!1;else if("slur"===t){this.sy=this.newSy(),this.sy!==ve.String&&this.error("slur",ve.String,!0);const t=this.syData;if(this._slurs.has(t)){const s=this._slurs.get(t);s.slurDestination=e,e.slurOrigin=s,e.isSlurDestination=!0}else this._slurs.set(t,e);this.sy=this.newSy()}else this.applyBeatEffect(e.beat)||this.error(t,ve.String,!1)}this.sy!==ve.RBrace&&this.error("note-effect",ve.RBrace,!1),this.sy=this.newSy()}}harmonicValue(e){return this.sy=this.newSy(!0),this.sy===ve.Number&&(e=this.syData,this.sy=this.newSy(!0)),e}toFinger(e){switch(e){case 1:return x.Thumb;case 2:return x.IndexFinger;case 3:return x.MiddleFinger;case 4:return x.AnnularFinger;case 5:return x.LittleFinger}return x.Thumb}parseDuration(e){switch(e){case-4:return k.QuadrupleWhole;case-2:return k.DoubleWhole;case 1:return k.Whole;case 2:return k.Half;case 4:return k.Quarter;case 8:return k.Eighth;case 16:return k.Sixteenth;case 32:return k.ThirtySecond;case 64:return k.SixtyFourth;case 128:return k.OneHundredTwentyEighth;case 256:return k.TwoHundredFiftySixth;default:return k.Quarter}}parseBendStyle(e){switch(e.toLowerCase()){case"gradual":return b.Gradual;case"fast":return b.Fast;default:return b.Default}}parseBendType(e){switch(e.toLowerCase()){case"none":return S.None;case"custom":default:return S.Custom;case"bend":return S.Bend;case"release":return S.Release;case"bendrelease":return S.BendRelease;case"hold":return S.Hold;case"prebend":return S.Prebend;case"prebendbend":return S.PrebendBend;case"prebendrelease":return S.PrebendRelease}}barMeta(e){let t=!1;const s=e.masterBar;let i=!1;for(;!i&&this.sy===ve.MetaCommand;){t=!0;const a=this.syData.toLowerCase();if("ts"===a)this.sy=this.newSy(),this.sy===ve.String?"common"===this.syData.toLowerCase()?(s.timeSignatureCommon=!0,s.timeSignatureNumerator=4,s.timeSignatureDenominator=4,this.sy=this.newSy()):this.error("timesignature-numerator",ve.String,!0):(this.sy!==ve.Number&&this.error("timesignature-numerator",ve.Number,!0),s.timeSignatureNumerator=this.syData,this.sy=this.newSy(),this.sy!==ve.Number&&this.error("timesignature-denominator",ve.Number,!0),s.timeSignatureDenominator=this.syData,this.sy=this.newSy());else if("ft"===a)s.isFreeTime=!0,this.sy=this.newSy();else if("ro"===a)s.isRepeatStart=!0,this.sy=this.newSy();else if("rc"===a)this.sy=this.newSy(),this.sy!==ve.Number&&this.error("repeatclose",ve.Number,!0),this.syData>2048&&this.error("repeatclose",ve.Number,!1),s.repeatCount=this.syData,this.sy=this.newSy();else if("ae"===a)if(this.sy=this.newSy(),this.sy===ve.LParensis){for(this.sy=this.newSy(),this.sy!==ve.Number&&this.error("alternateending",ve.Number,!0),this.applyAlternateEnding(s);this.sy===ve.Number;)this.applyAlternateEnding(s);this.sy!==ve.RParensis&&this.error("alternateending-list",ve.RParensis,!0),this.sy=this.newSy()}else this.sy!==ve.Number&&this.error("alternateending",ve.Number,!0),this.applyAlternateEnding(s);else if("ks"===a)this.sy=this.newSy(),this.sy!==ve.String&&this.error("keysignature",ve.String,!0),e.keySignature=this.parseKeySignature(this.syData),e.keySignatureType=this.parseKeySignatureType(this.syData),this.sy=this.newSy();else if("clef"===a){switch(this.sy=this.newSy(),this.sy){case ve.String:e.clef=this.parseClefFromString(this.syData);break;case ve.Number:e.clef=this.parseClefFromInt(this.syData);break;case ve.Tuning:const t=this.syData;e.clef=this.parseClefFromInt(t.realValue);break;default:this.error("clef",ve.String,!0)}this.sy=this.newSy()}else if("tempo"===a){const e=this.readTempoAutomation(!0);s.tempoAutomations.push(e)}else if("section"===a){this.sy=this.newSy(),this.sy!==ve.String&&this.error("section",ve.String,!0);let e=this.syData;this.sy=this.newSy();let t="";this.sy!==ve.String||this.isNoteText(this.syData.toLowerCase())||(t=e,e=this.syData,this.sy=this.newSy());const i=new st;i.marker=t,i.text=e,s.section=i}else if("tf"===a){switch(this._lexer.allowTuning=!1,this.sy=this.newSy(),this._lexer.allowTuning=!0,this.sy){case ve.String:s.tripletFeel=this.parseTripletFeelFromString(this.syData);break;case ve.Number:s.tripletFeel=this.parseTripletFeelFromInt(this.syData);break;default:this.error("triplet-feel",ve.String,!0)}this.sy=this.newSy()}else if("ac"===a)s.isAnacrusis=!0,this.sy=this.newSy();else if("db"===a)s.isDoubleBar=!0,e.barLineRight=g.LightLight,this.sy=this.newSy();else if("barlineleft"===a)this.sy=this.newSy(),this.sy!==ve.String&&this.error("barlineleft",ve.String,!0),e.barLineLeft=this.parseBarLineStyle(this.syData),this.sy=this.newSy();else if("barlineright"===a)this.sy=this.newSy(),this.sy!==ve.String&&this.error("barlineright",ve.String,!0),e.barLineRight=this.parseBarLineStyle(this.syData),this.sy=this.newSy();else if("accidentals"===a)this.handleAccidentalMode();else if("jump"===a)this.handleDirections(s);else if("ottava"===a)this.sy=this.newSy(),this.sy!==ve.String&&this.error("ottava",ve.String,!0),e.clefOttava=this.parseClefOttavaFromString(this.syData),this.sy=this.newSy();else if("simile"===a)this.sy=this.newSy(),this.sy!==ve.String&&this.error("simile",ve.String,!0),e.simileMark=this.parseSimileMarkFromString(this.syData),this.sy=this.newSy();else if("scale"===a)this.sy=this.newSy(!0),this.sy!==ve.Number&&this.error("scale",ve.Number,!0),s.displayScale=this.syData,e.displayScale=this.syData,this.sy=this.newSy();else if("width"===a)this.sy=this.newSy(),this.sy!==ve.Number&&this.error("width",ve.Number,!0),s.displayWidth=this.syData,e.displayWidth=this.syData,this.sy=this.newSy();else if("spd"===a){const t=new z;t.pedalType=p.Down,this.sy=this.newSy(!0),this.sy!==ve.Number&&this.error("spd",ve.Number,!0),t.ratioPosition=this.syData,e.sustainPedals.push(t),this.sy=this.newSy()}else if("spu"===a){const t=new z;t.pedalType=p.Up,this.sy=this.newSy(!0),this.sy!==ve.Number&&this.error("spu",ve.Number,!0),t.ratioPosition=this.syData,e.sustainPedals.push(t),this.sy=this.newSy()}else if("sph"===a){const t=new z;t.pedalType=p.Hold,this.sy=this.newSy(!0),this.sy!==ve.Number&&this.error("sph",ve.Number,!0),t.ratioPosition=this.syData,e.sustainPedals.push(t),this.sy=this.newSy()}else if(0===e.index)switch(this.handleStaffMeta()){case Ee.KnownStaffMeta:break;case Ee.UnknownStaffMeta:this.error("measure-effects",ve.String,!1);break;case Ee.EndOfMetaDetected:i=!0}else if(this.handleStaffMeta()===Ee.EndOfMetaDetected)i=!0;else this.error("measure-effects",ve.String,!1)}if(0===s.index&&0===s.tempoAutomations.length){const e=new q;e.isLinear=!1,e.type=y.Tempo,e.value=this._score.tempo,e.text=this._score.tempoLabel,s.tempoAutomations.push(e)}return t}parseBarLineStyle(e){switch(e.toLowerCase()){case"automatic":return g.Automatic;case"dashed":return g.Dashed;case"dotted":return g.Dotted;case"heavy":return g.Heavy;case"heavyheavy":return g.HeavyHeavy;case"heavylight":return g.HeavyLight;case"lightheavy":return g.LightHeavy;case"lightlight":return g.LightLight;case"none":return g.None;case"regular":return g.Regular;case"short":return g.Short;case"tick":return g.Tick}return g.Automatic}parseSimileMarkFromString(e){switch(e.toLowerCase()){case"none":default:return c.None;case"simple":return c.Simple;case"firstofdouble":return c.FirstOfDouble;case"secondofdouble":return c.SecondOfDouble}}handleDirections(e){switch(this.sy=this.newSy(),this.sy!==ve.String&&this.error("direction",ve.String,!0),this.syData.toLowerCase()){case"fine":e.addDirection(xe.TargetFine);break;case"segno":e.addDirection(xe.TargetSegno);break;case"segnosegno":e.addDirection(xe.TargetSegnoSegno);break;case"coda":e.addDirection(xe.TargetCoda);break;case"doublecoda":e.addDirection(xe.TargetDoubleCoda);break;case"dacapo":e.addDirection(xe.JumpDaCapo);break;case"dacapoalcoda":e.addDirection(xe.JumpDaCapoAlCoda);break;case"dacapoaldoublecoda":e.addDirection(xe.JumpDaCapoAlDoubleCoda);break;case"dacapoalfine":e.addDirection(xe.JumpDaCapoAlFine);break;case"dalsegno":e.addDirection(xe.JumpDalSegno);break;case"dalsegnoalcoda":e.addDirection(xe.JumpDalSegnoAlCoda);break;case"dalsegnoaldoublecoda":e.addDirection(xe.JumpDalSegnoAlDoubleCoda);break;case"dalsegnoalfine":e.addDirection(xe.JumpDalSegnoAlFine);break;case"dalsegnosegno":e.addDirection(xe.JumpDalSegnoSegno);break;case"dalsegnosegnoalcoda":e.addDirection(xe.JumpDalSegnoSegnoAlCoda);break;case"dalsegnosegnoaldoublecoda":e.addDirection(xe.JumpDalSegnoSegnoAlDoubleCoda);break;case"dalsegnosegnoalfine":e.addDirection(xe.JumpDalSegnoSegnoAlFine);break;case"dacoda":e.addDirection(xe.JumpDaCoda);break;case"dadoublecoda":e.addDirection(xe.JumpDaDoubleCoda);break;default:return void this.errorMessage(`Unexpected direction value: '${this.syData}'`)}this.sy=this.newSy()}readTempoAutomation(e){this.sy=this.newSy(!0);const t=new q;return t.isLinear=!1,t.type=y.Tempo,this.sy===ve.LBrace&&e?(this.sy=this.newSy(!0),this.sy!==ve.Number&&this.error("tempo",ve.Number,!0),t.value=this.syData,this.sy=this.newSy(!0),this.sy===ve.String&&(t.text=this.syData,this.sy=this.newSy(!0)),this.sy!==ve.Number&&this.error("tempo",ve.Number,!0),t.ratioPosition=this.syData,this.sy=this.newSy(),this.sy!==ve.RBrace&&this.error("tempo",ve.RBrace,!0),this.sy=this.newSy()):this.sy===ve.Number?(t.value=this.syData,this.sy=this.newSy(),this.sy===ve.String&&"r"!==this.syData&&(t.text=this.syData,this.sy=this.newSy())):this.error("tempo",ve.Number,!0),t}applyAlternateEnding(e){const t=this.syData;t<1&&this.error("alternateending",ve.Number,!0),e.alternateEndings|=1<<t-1,this.sy=this.newSy()}parseWhammyType(e){switch(e.toLowerCase()){case"none":return ue.None;case"custom":default:return ue.Custom;case"dive":return ue.Dive;case"dip":return ue.Dip;case"hold":return ue.Hold;case"predive":return ue.Predive;case"predivedive":return ue.PrediveDive}}}let yt=class{};class bt extends yt{constructor(e){super(),this.n=e}}class St extends yt{constructor(e,t){super(),this.left=e,this.right=t}}class wt extends yt{constructor(e,t){super(),this.n=e,this.table=t}}class Bt{static make(e,t,s,i){const a=[],r=[];if(i>32)throw new it("Invalid huffman");for(let e=0;e<i;e++)a.push(0),r.push(0);for(let r=0;r<s;r++){const s=e[r+t];if(s>=i)throw new it("Invalid huffman");a[s]++}let n=0;for(let e=1;e<i-1;e++)n=n+a[e]<<1,r[e]=n;const o=new Map;for(let i=0;i<s;i++){const s=e[i+t];if(0!==s){const e=r[s-1];r[s-1]=e+1,o.set(e<<5|s,i)}}return Bt.treeCompress(new St(Bt.treeMake(o,i,0,1),Bt.treeMake(o,i,1,1)))}static treeMake(e,t,s,i){if(i>t)throw new it("Invalid huffman");const a=s<<5|i;return e.has(a)?new bt(e.get(a)):(s<<=1,i+=1,new St(Bt.treeMake(e,t,s,i),Bt.treeMake(e,t,1|s,i)))}static treeCompress(e){const t=Bt.treeDepth(e);if(0===t)return e;if(1===t){if(e instanceof St)return new St(Bt.treeCompress(e.left),Bt.treeCompress(e.right));throw new it("assert")}const s=1<<t,i=[];for(let e=0;e<s;e++)i.push(new bt(-1));return Bt.treeWalk(i,0,0,t,e),new wt(t,i)}static treeWalk(e,t,s,i,a){a instanceof St&&i>0?(Bt.treeWalk(e,t,s+1,i-1,a.left),Bt.treeWalk(e,t|1<<s,s+1,i-1,a.right)):e[t]=Bt.treeCompress(a)}static treeDepth(e){if(e instanceof bt)return 0;if(e instanceof wt)throw new it("assert");if(e instanceof St){const t=Bt.treeDepth(e.left),s=Bt.treeDepth(e.right);return 1+(t<s?t:s)}return 0}}var kt,Tt,_t,xt,Nt,Pt,vt,Et,Mt,Ft,Ct,Dt,Lt,It,At,Rt,Ot,Wt,Ht,Gt,Vt,Ut,zt,Xt,Yt,Jt,$t,qt;!function(e){e[e.Head=0]="Head",e[e.Block=1]="Block",e[e.CData=2]="CData",e[e.Flat=3]="Flat",e[e.Crc=4]="Crc",e[e.Dist=5]="Dist",e[e.DistOne=6]="DistOne",e[e.Done=7]="Done"}(kt||(kt={}));class jt{constructor(){this.buffer=new Uint8Array(jt.BufferSize),this.pos=0}slide(){const e=new Uint8Array(jt.BufferSize);this.pos-=jt.Size,e.set(this.buffer.subarray(jt.Size,jt.Size+this.pos),0),this.buffer=e}addBytes(e,t,s){this.pos+s>jt.BufferSize&&this.slide(),this.buffer.set(e.subarray(t,t+s),this.pos),this.pos+=s}addByte(e){this.pos===jt.BufferSize&&this.slide(),this.buffer[this.pos]=e,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}}jt.Size=32768,jt.BufferSize=65536;class Kt{static buildFixedHuffman(){const e=[];for(let t=0;t<288;t++)e.push(t<=143?8:t<=255?9:t<=279?7:8);return Bt.make(e,0,288,10)}constructor(e){this._nbits=0,this._bits=0,this._state=kt.Block,this._isFinal=!1,this._huffman=Kt._fixedHuffman,this._huffdist=null,this._len=0,this._dist=0,this._needed=0,this._output=null,this._outpos=0,this._lengths=[],this._window=new jt,this._input=e;for(let e=0;e<19;e++)this._lengths.push(-1)}readBytes(e,t,s){if(this._needed=s,this._outpos=t,this._output=e,s>0)for(;this.inflateLoop(););return s-this._needed}inflateLoop(){switch(this._state){case kt.Head:const e=this._input.readByte();if(8!==(15&e))throw new it("Invalid data");const t=this._input.readByte(),s=!!(32&t);if(((e<<8)+t)%31!=0)throw new it("Invalid data");if(s)throw new it("Unsupported dictionary");return this._state=kt.Block,!0;case kt.Crc:return this._state=kt.Done,!0;case kt.Done:return!1;case kt.Block:switch(this._isFinal=this.getBit(),this.getBits(2)){case 0:this._len=dt.readUInt16LE(this._input);if(dt.readUInt16LE(this._input)!==65535-this._len)throw new it("Invalid data");this._state=kt.Flat;const e=this.inflateLoop();return this.resetBits(),e;case 1:return this._huffman=Kt._fixedHuffman,this._huffdist=null,this._state=kt.CData,!0;case 2:const t=this.getBits(5)+257,s=this.getBits(5)+1,i=this.getBits(4)+4;for(let e=0;e<i;e++)this._lengths[Kt.CodeLengthsPos[e]]=this.getBits(3);for(let e=i;e<19;e++)this._lengths[Kt.CodeLengthsPos[e]]=0;this._huffman=Bt.make(this._lengths,0,19,8);const a=[];for(let e=0;e<t+s;e++)a.push(0);return this.inflateLengths(a,t+s),this._huffdist=Bt.make(a,t,s,16),this._huffman=Bt.make(a,0,t,16),this._state=kt.CData,!0;default:throw new it("Invalid data")}case kt.Flat:{const e=this._len<this._needed?this._len:this._needed,t=dt.readByteArray(this._input,e);return this._len-=e,this.addBytes(t,0,e),0===this._len&&(this._state=this._isFinal?kt.Crc:kt.Block),this._needed>0}case kt.DistOne:{const e=this._len<this._needed?this._len:this._needed;return this.addDistOne(e),this._len-=e,0===this._len&&(this._state=kt.CData),this._needed>0}case kt.Dist:for(;this._len>0&&this._needed>0;){const e=this._len<this._dist?this._len:this._dist,t=this._needed<e?this._needed:e;this.addDist(this._dist,t),this._len-=t}return 0===this._len&&(this._state=kt.CData),this._needed>0;case kt.CData:let i=this.applyHuffman(this._huffman);if(i<256)return this.addByte(i),this._needed>0;if(256===i)return this._state=this._isFinal?kt.Crc:kt.Block,!0;i=i-257&255;let a=Kt.LenExtraBitsTbl[i];if(-1===a)throw new it("Invalid data");this._len=Kt.LenBaseValTbl[i]+this.getBits(a);const r=this._huffdist,n=r?this.applyHuffman(r):this.getRevBits(5);if(a=Kt.DistExtraBitsTbl[n],-1===a)throw new it("Invalid data");if(this._dist=Kt.DistBaseValTbl[n]+this.getBits(a),this._dist>this._window.available())throw new it("Invalid data");return this._state=1===this._dist?kt.DistOne:kt.Dist,!0}return!1}addDistOne(e){const t=this._window.getLastChar();for(let s=0;s<e;s++)this.addByte(t)}addByte(e){this._window.addByte(e),this._output[this._outpos]=e,this._needed--,this._outpos++}addDist(e,t){this.addBytes(this._window.buffer,this._window.pos-e,t)}getBit(){0===this._nbits&&(this._nbits=8,this._bits=this._input.readByte());const e=!(1&~this._bits);return this._nbits--,this._bits=this._bits>>1,e}getBits(e){for(;this._nbits<e;)this._bits=this._bits|this._input.readByte()<<this._nbits,this._nbits+=8;const t=this._bits&(1<<e)-1;return this._nbits-=e,this._bits=this._bits>>e,t}getRevBits(e){return 0===e?0:this.getBit()?1<<e-1|this.getRevBits(e-1):this.getRevBits(e-1)}resetBits(){this._bits=0,this._nbits=0}addBytes(e,t,s){this._window.addBytes(e,t,s),this._output.set(e.subarray(t,t+s),this._outpos),this._needed-=s,this._outpos+=s}inflateLengths(e,t){let s=0,i=0;for(;s<t;){const a=this.applyHuffman(this._huffman);switch(a){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:i=a,e[s]=a,s++;break;case 16:const r=s+3+this.getBits(2);if(r>t)throw new it("Invalid data");for(;s<r;)e[s]=i,s++;break;case 17:if(s+=3+this.getBits(3),s>t)throw new it("Invalid data");break;case 18:if(s+=11+this.getBits(7),s>t)throw new it("Invalid data");break;default:throw new it("Invalid data")}}}applyHuffman(e){if(e instanceof bt)return e.n;if(e instanceof St)return this.applyHuffman(this.getBit()?e.right:e.left);if(e instanceof wt)return this.applyHuffman(e.table[this.getBits(e.n)]);throw new it("Invalid data")}}Kt.LenExtraBitsTbl=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1],Kt.LenBaseValTbl=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],Kt.DistExtraBitsTbl=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1],Kt.DistBaseValTbl=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],Kt.CodeLengthsPos=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Kt._fixedHuffman=Kt.buildFixedHuffman();class Qt{constructor(e,t){this.fullName=e;const s=e.lastIndexOf("/");this.fileName=-1===s||s===e.length-1?this.fullName:e.substr(s+1),this.data=t}}Qt.OptionalDataDescriptorSignature=134695760,Qt.CompressionMethodDeflate=8,Qt.LocalFileHeaderSignature=67324752,Qt.CentralFileHeaderSignature=33639248,Qt.EndOfCentralDirSignature=101010256;class Zt{constructor(e){this._readable=e}read(){const e=[];for(;;){const t=this.readEntry();if(!t)break;e.push(t)}return e}readEntry(){const e=this._readable;if(dt.readInt32LE(e)!==Qt.LocalFileHeaderSignature)return null;dt.readUInt16LE(e);const t=dt.readUInt16LE(e),s=dt.readUInt16LE(e),i=0!==s;if(i&&s!==Qt.CompressionMethodDeflate)return null;dt.readInt16LE(this._readable),dt.readInt16LE(this._readable),dt.readInt32LE(e),dt.readInt32LE(e);const a=dt.readInt32LE(e),r=dt.readInt16LE(e),n=dt.readInt16LE(e),o=dt.toString(dt.readByteArray(e,r),"utf-8");let h;if(e.skip(n),i){const e=ut.empty(),t=new Kt(this._readable),s=new Uint8Array(65536);for(;;){const i=t.readBytes(s,0,s.length);if(e.write(s,0,i),i<s.length)break}h=e.toArray()}else h=dt.readByteArray(this._readable,a);if(8&t){dt.readInt32LE(this._readable)===Qt.OptionalDataDescriptorSignature&&dt.readInt32LE(this._readable),dt.readInt32LE(this._readable),dt.readInt32LE(this._readable)}return new Qt(o,h)}}!function(e){e[e.None=0]="None",e[e.Element=1]="Element",e[e.Text=2]="Text",e[e.CDATA=3]="CDATA",e[e.Document=4]="Document",e[e.DocumentType=5]="DocumentType",e[e.Comment=6]="Comment"}(Tt||(Tt={}));class es{constructor(){this.nodeType=Tt.None,this.localName=null,this.value=null,this.childNodes=[],this.attributes=new Map,this.firstChild=null,this.firstElement=null}*childElements(){for(const e of this.childNodes)e.nodeType===Tt.Element&&(yield e)}addChild(e){this.childNodes.push(e),this.firstChild=e,e.nodeType!==Tt.Element&&e.nodeType!==Tt.CDATA||(this.firstElement=e)}getAttribute(e,t=""){return this.attributes.has(e)?this.attributes.get(e):t}getElementsByTagName(e,t=!1){const s=[];return this.searchElementsByTagName(this.childNodes,s,e,t),s}searchElementsByTagName(e,t,s,i=!1){for(const a of e)a&&a.nodeType===Tt.Element&&a.localName===s&&t.push(a),i&&this.searchElementsByTagName(a.childNodes,t,s,!0)}findChildElement(e){for(const t of this.childNodes)if(t&&t.nodeType===Tt.Element&&t.localName===e)return t;return null}addElement(e){const t=new es;return t.nodeType=Tt.Element,t.localName=e,this.addChild(t),t}get innerText(){if(this.nodeType===Tt.Element||this.nodeType===Tt.Document){if(this.firstElement&&this.firstElement.nodeType===Tt.CDATA)return this.firstElement.innerText;let e="";for(const t of this.childNodes)e+=t.innerText?.toString();return e.trim()}return this.value??""}set innerText(e){const t=new es;t.nodeType=Tt.Text,t.value=e,this.childNodes=[t]}setCData(e){const t=new es;t.nodeType=Tt.CDATA,t.value=e,this.childNodes=[t]}}class ts extends O{constructor(t,s,i){super(e.AlphaTabErrorType.Format,t),this.pos=0,this.xml=s,this.pos=i,Object.setPrototypeOf(this,ts.prototype)}}!function(e){e[e.IgnoreSpaces=0]="IgnoreSpaces",e[e.Begin=1]="Begin",e[e.BeginNode=2]="BeginNode",e[e.TagName=3]="TagName",e[e.Body=4]="Body",e[e.AttribName=5]="AttribName",e[e.Equals=6]="Equals",e[e.AttvalBegin=7]="AttvalBegin",e[e.AttribVal=8]="AttribVal",e[e.Childs=9]="Childs",e[e.Close=10]="Close",e[e.WaitEnd=11]="WaitEnd",e[e.WaitEndRet=12]="WaitEndRet",e[e.Pcdata=13]="Pcdata",e[e.Header=14]="Header",e[e.Comment=15]="Comment",e[e.Doctype=16]="Doctype",e[e.Cdata=17]="Cdata",e[e.Escape=18]="Escape"}(_t||(_t={}));class ss{static parse(e,t,s){let i=e.charCodeAt(t),a=_t.Begin,r=_t.Begin,n=0,o="",h=_t.Begin,l=null,c=null,d=0,u=0;for(;t<e.length;){switch(i=e.charCodeAt(t),a){case _t.IgnoreSpaces:switch(i){case ss.CharCodeLF:case ss.CharCodeCR:case ss.CharCodeTab:case ss.CharCodeSpace:break;default:a=r;continue}break;case _t.Begin:if(i!==ss.CharCodeLowerThan){n=t,a=_t.Pcdata;continue}a=_t.IgnoreSpaces,r=_t.BeginNode;break;case _t.Pcdata:if(i===ss.CharCodeLowerThan){o+=e.substr(n,t-n);const i=new es;i.nodeType=Tt.Text,i.value=o,o="",s.addChild(i),a=_t.IgnoreSpaces,r=_t.BeginNode}else i===ss.CharCodeAmp&&(o+=e.substr(n,t-n),a=_t.Escape,h=_t.Pcdata,n=t+1);break;case _t.Cdata:if(i===ss.CharCodeBrackedClose&&e.charCodeAt(t+1)===ss.CharCodeBrackedClose&&e.charCodeAt(t+2)===ss.CharCodeGreaterThan){const i=new es;i.nodeType=Tt.CDATA,i.value=e.substr(n,t-n),s.addChild(i),t+=2,a=_t.Begin}break;case _t.BeginNode:switch(i){case ss.CharCodeExclamation:if(e.charCodeAt(t+1)===ss.CharCodeBrackedOpen){if(t+=2,"CDATA["!==e.substr(t,6).toUpperCase())throw new ts("Expected <![CDATA[",e,t);t+=5,a=_t.Cdata,n=t+1}else if(e.charCodeAt(t+1)===ss.CharCodeUpperD||e.charCodeAt(t+1)===ss.CharCodeLowerD){if("OCTYPE"!==e.substr(t+2,6).toUpperCase())throw new ts("Expected <!DOCTYPE",e,t);t+=8,a=_t.Doctype,n=t+1}else{if(e.charCodeAt(t+1)!==ss.CharCodeMinus||e.charCodeAt(t+2)!==ss.CharCodeMinus)throw new ts("Expected \x3c!--",e,t);t+=2,a=_t.Comment,n=t+1}break;case ss.CharCodeQuestion:a=_t.Header,n=t;break;case ss.CharCodeSlash:if(!s)throw new ts("Expected node name",e,t);n=t+1,a=_t.IgnoreSpaces,r=_t.Close;break;default:a=_t.TagName,n=t;continue}break;case _t.TagName:if(!ss.isValidChar(i)){if(t===n)throw new ts("Expected node name",e,t);l=new es,l.nodeType=Tt.Element,l.localName=e.substr(n,t-n),s.addChild(l),a=_t.IgnoreSpaces,r=_t.Body;continue}break;case _t.Body:switch(i){case ss.CharCodeSlash:a=_t.WaitEnd;break;case ss.CharCodeGreaterThan:a=_t.Childs;break;default:a=_t.AttribName,n=t;continue}break;case _t.AttribName:if(!ss.isValidChar(i)){if(n===t)throw new ts("Expected attribute name",e,t);if(c=e.substr(n,t-n),l.attributes.has(c))throw new ts(`Duplicate attribute [${c}]`,e,t);a=_t.IgnoreSpaces,r=_t.Equals;continue}break;case _t.Equals:if(i!==ss.CharCodeEquals)throw new ts("Expected =",e,t);a=_t.IgnoreSpaces,r=_t.AttvalBegin;break;case _t.AttvalBegin:switch(i){case ss.CharCodeDoubleQuote:case ss.CharCodeSingleQuote:o="",a=_t.AttribVal,n=t+1,u=i}break;case _t.AttribVal:if(i===ss.CharCodeAmp)o+=e.substr(n,t-n),a=_t.Escape,h=_t.AttribVal,n=t+1;else if(i===u){o+=e.substr(n,t-n);const s=o;o="",l.attributes.set(c,s),a=_t.IgnoreSpaces,r=_t.Body}break;case _t.Childs:n=t=ss.parse(e,t,l),a=_t.Begin;break;case _t.WaitEnd:if(i!==ss.CharCodeGreaterThan)throw new ts("Expected >",e,t);a=_t.Begin;break;case _t.WaitEndRet:if(i===ss.CharCodeGreaterThan)return t;throw new ts("Expected >",e,t);case _t.Close:if(!ss.isValidChar(i)){if(n===t)throw new ts("Expected node name",e,t);if(e.substr(n,t-n)!==s.localName)throw new ts(`Expected </${s.localName}>`,e,t);a=_t.IgnoreSpaces,r=_t.WaitEndRet;continue}break;case _t.Comment:i===ss.CharCodeMinus&&e.charCodeAt(t+1)===ss.CharCodeMinus&&e.charCodeAt(t+2)===ss.CharCodeGreaterThan&&(t+=2,a=_t.Begin);break;case _t.Doctype:if(i===ss.CharCodeBrackedOpen)d++;else if(i===ss.CharCodeBrackedClose)d--;else if(i===ss.CharCodeGreaterThan&&0===d){const i=new es;i.nodeType=Tt.DocumentType,i.value=e.substr(n,t-n),s.addChild(i),a=_t.Begin}break;case _t.Header:i===ss.CharCodeQuestion&&e.charCodeAt(t+1)===ss.CharCodeGreaterThan&&(t++,a=_t.Begin);break;case _t.Escape:if(i===ss.CharCodeSemi){const s=e.substr(n,t-n);if(s.charCodeAt(0)===ss.CharCodeSharp){const e=s.charCodeAt(1)===ss.CharCodeLowerX?Number.parseInt(`0${s.substr(1,s.length-1)}`,10):Number.parseInt(s.substr(1,s.length-1),10);o+=String.fromCharCode(e)}else ss.Escapes.has(s)?o+=ss.Escapes.get(s):o+=`&${s};`?.toString();n=t+1,a=h}else ss.isValidChar(i)||i===ss.CharCodeSharp||(o+="&",o+=e.substr(n,t-n),n=--t+1,a=h)}t++}if(a===_t.Begin&&(n=t,a=_t.Pcdata),a===_t.Pcdata){if(t!==n){o+=e.substr(n,t-n);const i=new es;i.nodeType=Tt.Text,i.value=o,s.addChild(i)}return t}if(a===_t.Escape&&h===_t.Pcdata){o+="&",o+=e.substr(n,t-n);const i=new es;return i.nodeType=Tt.Text,i.value=o,s.addChild(i),t}throw new ts("Unexpected end",e,t)}static isValidChar(e){return e>=ss.CharCodeLowerA&&e<=ss.CharCodeLowerZ||e>=ss.CharCodeUpperA&&e<=ss.CharCodeUpperZ||e>=ss.CharCode0&&e<=ss.CharCode9||e===ss.CharCodeColon||e===ss.CharCodeDot||e===ss.CharCodeUnderscore||e===ss.CharCodeMinus}}ss.CharCodeLF=10,ss.CharCodeTab=9,ss.CharCodeCR=13,ss.CharCodeSpace=32,ss.CharCodeLowerThan=60,ss.CharCodeAmp=38,ss.CharCodeBrackedClose=93,ss.CharCodeBrackedOpen=91,ss.CharCodeGreaterThan=62,ss.CharCodeExclamation=33,ss.CharCodeUpperD=68,ss.CharCodeLowerD=100,ss.CharCodeMinus=45,ss.CharCodeQuestion=63,ss.CharCodeSlash=47,ss.CharCodeEquals=61,ss.CharCodeDoubleQuote=34,ss.CharCodeSingleQuote=39,ss.CharCodeSharp=35,ss.CharCodeLowerX=120,ss.CharCodeLowerA=97,ss.CharCodeLowerZ=122,ss.CharCodeUpperA=65,ss.CharCodeUpperZ=90,ss.CharCode0=48,ss.CharCode9=57,ss.CharCodeColon=58,ss.CharCodeDot=46,ss.CharCodeUnderscore=95,ss.CharCodeSemi=59,ss.Escapes=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]);class is{constructor(e,t){this._result=[],this._indention=e,this._xmlHeader=t,this._currentIndention="",this._isStartOfLine=!0}writeNode(e){switch(e.nodeType){case Tt.None:break;case Tt.Element:this._result.length>0&&this.writeLine(),this.write(`<${e.localName}`);for(const[t,s]of e.attributes)this.write(` ${t}="`),this.writeAttributeValue(s),this.write('"');if(0===e.childNodes.length)this.write("/>");else{if(this.write(">"),1!==e.childNodes.length||e.firstElement){this.indent();for(const t of e.childNodes)t.nodeType!==Tt.Element&&t.nodeType!==Tt.Comment||this.writeNode(t);this.unindend(),this.writeLine()}else this.writeNode(e.childNodes[0]);this.write(`</${e.localName}>`)}break;case Tt.Text:e.value&&this.write(e.value);break;case Tt.CDATA:null!==e.value&&this.write(`<![CDATA[${e.value}]]>`);break;case Tt.Document:this._xmlHeader&&this.write('<?xml version="1.0" encoding="utf-8"?>');for(const t of e.childNodes)this.writeNode(t);break;case Tt.DocumentType:this.write(`<!DOCTYPE ${e.value}>`);break;case Tt.Comment:this.write(`\x3c!-- ${e.value} --\x3e`)}}unindend(){this._currentIndention=this._currentIndention.substr(0,this._currentIndention.length-this._indention.length)}indent(){this._currentIndention+=this._indention}writeAttributeValue(e){for(let t=0;t<e.length;t++){const s=e.charAt(t);switch(s){case"<":this._result.push("&lt;");break;case">":this._result.push("&gt;");break;case"&":this._result.push("&amp;");break;case"'":this._result.push("&apos;");break;case'"':this._result.push("&quot;");break;default:this._result.push(s)}}}static write(e,t,s){const i=new is(t,s);return i.writeNode(e),i.toString()}write(e){this._isStartOfLine&&this._result.push(this._currentIndention),this._result.push(e),this._isStartOfLine=!1}writeLine(e=null){e&&this.write(e),this._indention.length>0&&!this._isStartOfLine&&(this._result.push("\n"),this._isStartOfLine=!0)}toString(){return this._result.join("").trimRight()}}class as extends es{constructor(){super(),this.nodeType=Tt.Document}parse(e){ss.parse(e,0,this)}toString(){return this.toFormattedString()}toFormattedString(e="",t=!1){return is.write(this,e,t)}}class rs{constructor(){this.noteRange=1,this.x=0,this.y=0}}!function(e){e[e.None=0]="None",e[e.Rectangle=1]="Rectangle",e[e.Ellipse=2]="Ellipse",e[e.Circle=3]="Circle"}(xt||(xt={}));class ns extends rs{constructor(){super(...arguments),this.align=we.Left,this.frame=xt.None,this.text="",this.fontFace="",this.weight=0,this.height=0}}class os extends rs{constructor(){super(...arguments),this.chord=new et}}class hs extends rs{}class ls extends rs{}class cs extends rs{constructor(){super(...arguments),this.number=0}}class ds extends rs{constructor(){super(...arguments),this.decrescendo=!1}}class us extends rs{constructor(){super(...arguments),this.allNumbers=!1,this.firstNumber=0,this.lastNumber=0}}class ps extends rs{constructor(){super(...arguments),this.octave=1}}class ms extends rs{}class gs{constructor(){this.defaultClef=h.G2,this.description="",this.percussion=!1,this.instrument=0,this.volume=0,this.transpose=0,this.index=0}}class fs{constructor(){this.from=0,this.to=0,this.curly=!1}}class ys{constructor(){this.currentBarIndex=-1,this.currentBarComplete=!0,this.currentBarDuration=0,this.currentPosition=0,this.voiceStemDir=null,this.repeatCount=0,this.repeatEnd=null}}class bs{constructor(){this._trackChannel=0,this._beamingMode=be.Auto,this._isFirstSystem=!0,this._staffLookup=new Map,this._brackets=[],this._staffLayoutLookup=new Map,this._staffLayouts=[],this._timeSignature=new te,this._voiceStates=new Map}parseXml(e,t){this._galleryObjects=new Map,this._tieStarts=[],this._tieStartIds=new Map,this._voiceCounts=new Map,this._slurs=new Map,this._crescendo=new Map,this._isFirstSystem=!0;const s=new as;try{s.parse(e)}catch(e){throw new Ze("Could not parse XML",e)}this.parseDom(s),this.consolidate(),this.score.finish(t)}consolidate(){De.consolidate(this.score),bs.applyEffectRange(this._slurs,(e,t)=>{t.isLegatoOrigin=!0}),bs.applyEffectRange(this._crescendo,(e,t)=>{t.crescendo=e.decrescendo?B.Decrescendo:B.Crescendo})}static applyEffectRange(e,t){for(const[s,i]of e){const e=i.noteRange;let a=s;for(let s=0;s<e;s++)if(t(i,a),a.index+1<a.voice.beats.length)a=a.voice.beats[a.index+1];else{if(!(a.voice.bar.index+1<a.voice.bar.staff.bars.length))break;a=a.voice.bar.staff.bars[a.voice.bar.index+1].voices[a.voice.index].beats[0]}}}parseDom(e){const t=e.firstElement;if(!t)throw new Ze("No valid XML");if("score"!==t.localName)throw new Ze('Root node of XML was not "score"');this.score=new Ke,this.score.tempo=120;for(const e of t.childElements())switch(e.localName){case"info":this.parseInfo(e);break;case"layout":this.parseLayout(e);break;case"gallery":this.parseGallery(e);break;case"pageObjects":this.parsePageObjects(e);break;case"systems":this.parseSystems(e)}}parseLayout(e){for(const t of e.childElements())switch(t.localName){case"staves":this.parseLayoutStaves(t);break;case"brackets":this.parseBrackets(t)}const t=this._brackets.filter(e=>!!e.curly);t.sort((e,t)=>e.from-t.from);let s=0,i=null;for(let e=0;e<this._staffLayouts.length;e++){const a=this._staffLayouts[e];for(;s<t.length&&e>t[s].to;)s++;i&&s<t.length&&e>t[s].from&&e<=t[s].to?i.ensureStaveCount(i.staves.length+1):(i=new lt,i.ensureStaveCount(1),i.name=a.description,i.playbackInfo.volume=Math.floor(a.volume/128*16),i.playbackInfo.program=a.instrument,a.percussion?(i.playbackInfo.primaryChannel=9,i.playbackInfo.secondaryChannel=9):(i.playbackInfo.primaryChannel=this._trackChannel++,i.playbackInfo.secondaryChannel=this._trackChannel++),this.score.addTrack(i));const r=i.staves[i.staves.length-1];r.isPercussion=a.percussion,r.transpositionPitch=a.transpose,r.displayTranspositionPitch=0,r.showTablature=!1,this._staffLookup.set(a.index,r)}}parseBrackets(e){for(const t of e.childElements())if("bracket"===t.localName)this.parseBracket(t)}parseBracket(e){const t=new fs;t.from=Number.parseInt(e.getAttribute("from"),10),t.to=Number.parseInt(e.getAttribute("to"),10),e.attributes.has("curly")&&(t.curly="true"===e.attributes.get("curly")),this._brackets.push(t)}parseLayoutStaves(e){for(const t of e.childElements())if("staffLayout"===t.localName)this.parseStaffLayout(t)}parseStaffLayout(e){const t=new gs;t.description=e.getAttribute("description");for(const s of e.childElements())switch(s.localName){case"notation":s.attributes.has("defaultClef")&&(t.defaultClef=this.parseClef(s.attributes.get("defaultClef")));break;case"sound":s.attributes.has("percussion")&&(t.percussion="true"===s.attributes.get("percussion")),s.attributes.has("instr")&&(t.instrument=Number.parseInt(s.attributes.get("instr"),10)),s.attributes.has("volume")&&(t.volume=Number.parseInt(s.attributes.get("volume"),10)),s.attributes.has("transpose")&&(t.transpose=Number.parseInt(s.attributes.get("transpose"),10))}this._staffLayoutLookup.set(t.description,t),t.index=this._staffLayouts.length,this._staffLayouts.push(t)}parseClef(e){switch(e){case"treble":return h.G2;case"bass":return h.F4;case"alto":case"tenor":return h.C4}return h.G2}parseClefOttava(e){return e.endsWith("-")?l._8vb:e.endsWith("+")?l._8va:l.Regular}parseSystems(e){for(const t of e.childElements())if("system"===t.localName)this.parseSystem(t)}parseSystem(e){e.attributes.has("tempo")&&0===this.score.masterBars.length&&(this.score.tempo=Number.parseInt(e.attributes.get("tempo"),10)),"0"===e.getAttribute("beamGrouping")&&(this._beamingMode=be.ForceSplitToNext);for(const t of e.childElements())if("staves"===t.localName)this.parseStaves(e,t);this._isFirstSystem=!1}parseStaves(e,t){const s=this.score.masterBars.length;for(const i of t.childElements())if("staff"===i.localName)this.parseStaff(e,s,i)}parseStaff(e,t,s){const i=s.getAttribute("layout");this._currentStaffLayout=this._staffLayoutLookup.get(i),this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!1,this.parseTime(s.getAttribute("defaultTime"));const a=this._staffLookup.get(this._currentStaffLayout.index);for(;a.bars.length<t;)this.addNewBar(a);for(const r of s.childElements())if("voices"===r.localName)this.parseVoices(i,a,e,t,r)}parseTime(e){switch(e){case"allaBreve":case"C":this._timeSignature.timeSignatureNumerator=2,this._timeSignature.timeSignatureDenominator=2,this._timeSignature.timeSignatureCommon=!0;break;case"longAllaBreve":this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!0;break;default:if(e.indexOf("/")>0){const t=e.split("/");this._timeSignature.timeSignatureNumerator=Number.parseInt(t[0],10),this._timeSignature.timeSignatureDenominator=Number.parseInt(t[1],10),this._timeSignature.timeSignatureCommon=!1}}}parseVoices(e,t,s,i,a){let r=0;for(const n of a.childElements())if("voice"===n.localName)this.parseVoice(e,t,s,r,i,n),r++}getOrCreateBar(e,t){return t<e.bars.length?e.bars[t]:this.addNewBar(e)}addNewBar(e){const t=new Y;if(e.bars.length>0?(t.clef=e.bars[e.bars.length-1].clef,t.clefOttava=e.bars[e.bars.length-1].clefOttava,t.keySignature=e.bars[e.bars.length-1].keySignature,t.keySignatureType=e.bars[e.bars.length-1].keySignatureType):t.clef=this._currentStaffLayout.defaultClef,e.addBar(t),e.bars.length>this.score.masterBars.length){const e=new te;this.score.addMasterBar(e),e.index>0&&(e.tripletFeel=e.previousMasterBar.tripletFeel),e.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,e.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,e.timeSignatureCommon=this._timeSignature.timeSignatureCommon}return t}newBar(e,t){this._currentVoiceState.currentBarIndex++,this._currentBar=this.getOrCreateBar(e,this._currentVoiceState.currentBarIndex),this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1),this._currentVoiceState.currentBarComplete=!1,this._currentVoiceState.currentPosition=0,this.ensureVoice(e,t)}parseVoice(e,t,s,i,a,r){const n=`${e}_${i}`;if(this._currentVoiceState&&!this._currentVoiceState.currentBarComplete&&(this._currentBar.masterBar.isAnacrusis=!0),this._voiceStates.has(n)?(this._currentVoiceState=this._voiceStates.get(n),this._currentBar=this.getOrCreateBar(t,this._currentVoiceState.currentBarIndex),this.ensureVoice(t,i)):(this._currentVoiceState=new ys,this._currentVoiceState.currentBarIndex=a-1,this._voiceStates.set(n,this._currentVoiceState),this.newBar(t,i)),r.attributes.has("stemDir"))switch(r.attributes.get("stemDir")){case"up":this._currentVoiceState.voiceStemDir=Pe.Up;break;case"down":this._currentVoiceState.voiceStemDir=Pe.Down;break;default:this._currentVoiceState.voiceStemDir=null}else this._currentVoiceState.voiceStemDir=null;const o=r.findChildElement("noteObjects");if(s.attributes.has("tempo")){const e=new q;e.isLinear=!0,e.type=y.Tempo,e.value=Number.parseInt(s.attributes.get("tempo"),10),e.ratioPosition=this._currentVoiceState.currentPosition/this._currentVoiceState.currentBarDuration,this._currentBar.masterBar.tempoAutomations.push(e)}if(o)for(const e of o.childElements())switch(this._currentVoiceState.currentBarComplete&&"barline"!==e.localName&&this.newBar(t,i),e.localName){case"clefSign":this._currentBar.clef=this.parseClef(e.getAttribute("clef")),this._currentBar.clefOttava=this.parseClefOttava(e.getAttribute("clef"));break;case"keySign":this._currentBar.keySignature=Number.parseInt(e.getAttribute("fifths"),10);break;case"timeSign":this.parseTime(e.getAttribute("time")),this._currentBar.masterBar.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,this._currentBar.masterBar.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,this._currentBar.masterBar.timeSignatureCommon=this._timeSignature.timeSignatureCommon,this._currentVoiceState.currentPosition=0,this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1);break;case"barline":switch(e.getAttribute("type")){case"double":this._currentBar.barLineRight=g.LightLight,this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"end":this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0);break;case"repEnd":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this.parseBarDrawObject(e),this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"repBegin":this.newBar(t,i),this._currentBar.masterBar.isRepeatStart=!0,this._currentVoiceState.repeatEnd=null,this._currentVoiceState.repeatCount=0;break;case"repEndBegin":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this.parseBarDrawObject(e),this.newBar(t,i),this._currentBar.masterBar.isRepeatStart=!0;break;default:this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0}break;case"chord":const s=new Ye;this.initFromPreviousBeat(s,this._currentVoice),s.beamingMode=this._beamingMode,this._currentVoiceState.voiceStemDir&&(s.preferredBeamDirection=this._currentVoiceState.voiceStemDir),this.parseDuration(s,e.findChildElement("duration")),s.updateDurations(),this._currentVoiceState.currentPosition+=s.playbackDuration,this._currentVoice.addBeat(s),this.parseChord(s,e),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0);break;case"rest":const a=this.parseRestDurations(e.findChildElement("duration"));a&&(this.initFromPreviousBeat(a,this._currentVoice),a.updateDurations(),this._currentVoiceState.currentPosition+=a.playbackDuration,this._currentVoice.addBeat(a),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0))}}initFromPreviousBeat(e,t){const s=this.getLastBeat(t);s&&(e.dynamics=s.dynamics)}getLastBeat(e){if(e.beats.length>0)return e.beats[e.beats.length-1];if(e.bar.index>0){const t=e.bar.staff.bars[e.bar.index-1];if(e.index<t.voices.length){const s=t.voices[e.index];return this.getLastBeat(s)}}return null}ensureVoice(e,t){for(;this._currentBar.voices.length<t+1;)this._currentBar.addVoice(new re);(!this._voiceCounts.has(e.track.index)||this._voiceCounts.get(e.track.index)<this._currentBar.voices.length)&&this._voiceCounts.set(e.track.index,this._currentBar.voices.length),this._currentVoice=this._currentBar.voices[t]}parseChord(e,t){const s=new Oe;for(const i of t.childElements())switch(i.localName){case"stem":switch(i.getAttribute("dir")){case"up":e.preferredBeamDirection=Pe.Up;break;case"down":e.preferredBeamDirection=Pe.Down}break;case"articulation":switch(i.getAttribute("type")){case"staccato":s.isStaccato=!0;break;case"normalAccent":s.accentuated=_.Normal;break;case"strongAccent":s.accentuated=_.Heavy}break;case"lyric":this.parseLyric(e,i);break;case"drawObjects":this.parseBeatDrawObject(e,i);break;case"heads":this.parseHeads(e,s,i);break;case"beam":switch(i.getAttribute("group")){case"force":e.beamingMode=be.ForceMergeWithNext;break;case"divide":e.beamingMode=be.ForceSplitToNext}}}parseHeads(e,t,s){for(const i of s.childElements())if("head"===i.localName)this.parseHead(e,t,i)}parseHead(e,t,s){const i=new Oe,a=De.parseTuning(s.getAttribute("pitch"));i.octave=a.octave-1,i.tone=a.tone.noteValue,i.isStaccato=t.isStaccato,i.accentuated=t.accentuated,e.addNote(i);for(const e of s.childElements())switch(e.localName){case"alter":e.attributes.has("step")&&(i.tone+=Number.parseInt(e.attributes.get("step"),10));break;case"tie":e.attributes.has("begin")?this._tieStartIds.has(i.id)||(this._tieStartIds.set(i.id,!0),this._tieStarts.push(i)):e.attributes.has("end")&&this._tieStarts.length>0&&!i.isTieDestination&&(i.isTieDestination=!0,i.tieOrigin=this._tieStarts[0],this._tieStarts.splice(0,1),this._tieStartIds.delete(i.id))}}parseBeatDrawObject(e,t){for(const s of t.childElements())if("drawObj"===s.localName){const t=this.parseDrawObj(s);if(t)if(t instanceof ns)t.fontFace.startsWith("capella")?"u"===t.text?(e.fermata=new pt,e.fermata.type=Ne.Medium):"f"===t.text?e.dynamics=f.F:"j"===t.text&&(e.dynamics=f.MF):this._isFirstSystem&&""===this.score.title&&t.align===we.Center&&t.height>16&&t.weight>400?this.score.title=t.text:this._isFirstSystem&&""===this.score.artist&&t.align===we.Center&&t.y<0?this.score.artist=t.text:this._isFirstSystem&&""===this.score.music&&t.align===we.Right&&t.y<0?this.score.music=t.text:t.text.startsWith("by capella")||(e.text=t.text);else if(t instanceof os);else if(t instanceof ls)e.vibrato=M.Slight;else if(t instanceof ds)e.crescendo=t.decrescendo?B.Decrescendo:B.Crescendo,t.noteRange++,this._crescendo.set(e,t);else if(t instanceof hs){const s=t;this._slurs.set(e,s)}else t instanceof us&&this.applyVolta(t)}}parseBarDrawObject(e){for(const t of e.childElements())if("drawObj"===t.localName){const e=this.parseDrawObj(t);e&&e instanceof us&&this.applyVolta(e)}}applyVolta(e){if(e.lastNumber>0?(this._currentVoiceState.repeatCount=e.lastNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)):e.firstNumber>0&&(this._currentVoiceState.repeatCount=e.firstNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)),e.lastNumber>0&&e.firstNumber>0){let t=0;for(let s=e.firstNumber;s<=e.lastNumber;s++)t|=1<<s-1;this._currentBar.masterBar.alternateEndings=t}else e.lastNumber>0?this._currentBar.masterBar.alternateEndings=1<<e.lastNumber-1:e.firstNumber>0&&(this._currentBar.masterBar.alternateEndings=1<<e.firstNumber-1)}parseLyric(e,t){for(const s of t.childElements())if("verse"===s.localName){e.lyrics||(e.lyrics=[]);let t=s.innerText;"true"===s.getAttribute("hyphen")&&(t+="-"),e.lyrics.push(t)}}parseRestDurations(e){const t=e.getAttribute("base");if(-1!==t.indexOf("/")){const t=new Ye;return t.beamingMode=this._beamingMode,this.parseDuration(t,e),t}if(1===Number.parseInt(t,10)){const e=new Ye;return e.beamingMode=this._beamingMode,e.duration=k.Whole,e}return ee.warning("Importer","Multi-Bar rests are not supported"),null}parseDurationValue(e){switch(e){case"2/1":return k.DoubleWhole;case"1/1":return k.Whole;case"1/2":return k.Half;case"1/4":return k.Quarter;case"1/8":return k.Eighth;case"1/16":return k.Sixteenth;case"1/32":return k.ThirtySecond;case"1/64":return k.SixtyFourth;case"1/128":return k.OneHundredTwentyEighth;default:return ee.warning("Importer","Unsupported duration"),k.Quarter}}parseDuration(e,t){const s=t.getAttribute("base");e.duration=this.parseDurationValue(s),t.attributes.has("dots")&&(e.dots=Number.parseInt(t.attributes.get("dots"),10));const i=t.findChildElement("tuplet");if(i){e.tupletNumerator=Number.parseInt(i.getAttribute("count"),10);const t="true"===i.getAttribute("tripartite")?3:1,s="true"===i.getAttribute("prolong")?0:1;let a=0;for(;t*Math.pow(2,a+s)<e.tupletNumerator;)a++;e.tupletDenominator=t*Math.pow(2,a)}}parsePageObjects(e){for(const t of e.childElements())if("drawObj"===t.localName){const e=this.parseDrawObj(t);if(e&&e instanceof ns)switch(e.align){case we.Center:this.score.title?this.score.subTitle||(this.score.subTitle=t.innerText):this.score.title=t.innerText;break;case we.Right:this.score.artist||(this.score.artist=t.innerText)}}}parseGallery(e){for(const t of e.childElements())if("drawObj"===t.localName){const e=this.parseDrawObj(t);e&&this._galleryObjects.set(t.getAttribute("name"),e)}}parseDrawObj(e){let t=null,s=1;for(const i of e.childElements())switch(i.localName){case"text":t=this.parseText(i);break;case"guitar":t=this.parseGuitar(i);break;case"slur":t=this.parseSlur(i);break;case"wavyLine":t=this.parseWavyLine(i);break;case"bracket":t=this.parseTupletBracket(i);break;case"wedge":t=this.parseWedge(i);break;case"volta":t=this.parseVolta(i);break;case"octaveClef":t=this.parseOctaveClef(i);break;case"trill":t=this.parseTrill(i);break;case"basic":i.attributes.has("noteRange")&&(s=Number.parseInt(i.attributes.get("noteRange"),10))}return t&&(t.noteRange=s),t}parseTrill(e){return new ms}parseOctaveClef(e){const t=new ps;return e.attributes.has("octave")&&(t.octave=Number.parseInt(e.attributes.get("octave"),10)),t}parseVolta(e){const t=new us;return t.allNumbers="true"===e.attributes.get("allNumbers"),e.attributes.has("firstNumber")&&(t.firstNumber=Number.parseInt(e.attributes.get("firstNumber"),10)),e.attributes.has("lastNumber")&&(t.lastNumber=Number.parseInt(e.attributes.get("lastNumber"),10)),t}parseWedge(e){const t=new ds;return t.decrescendo="true"===e.attributes.get("decrescendo"),t}parseTupletBracket(e){const t=new cs;return e.attributes.has("number")&&(t.number=Number.parseInt(e.attributes.get("number"),10)),t}parseWavyLine(e){return new ls}parseSlur(e){return new hs}parseGuitar(e){const t=new os,s=e.innerText.trim();for(let e=0;e<s.length;e++)"/"===s.charAt(e)?t.chord.strings.push(0):t.chord.strings.push(Number.parseInt(s.charAt(e),10));return t}parseText(e){const t=new ns;switch(e.attributes.has("x")&&(t.x=Number.parseFloat(e.attributes.get("x"))),e.attributes.has("x")&&(t.y=Number.parseFloat(e.attributes.get("y"))),e.getAttribute("align")){case"left":t.align=we.Left;break;case"center":t.align=we.Center;break;case"right":t.align=we.Right}switch(e.getAttribute("frame")){case"rectangle":t.frame=xt.Rectangle;break;case"ellipse":t.frame=xt.Ellipse;break;case"circle":t.frame=xt.Circle;break;case"none":t.frame=xt.None}if(e.firstElement)for(const s of e.childElements())switch(s.localName){case"font":t.fontFace=s.getAttribute("face"),s.attributes.has("weight")&&(t.weight=Number.parseInt(s.attributes.get("weight"),10)),s.attributes.has("height")&&(t.height=Number.parseInt(s.attributes.get("height"),10));break;case"content":t.text=s.innerText}else t.text=e.innerText;return t}parseInfo(e){for(const t of e.childElements())switch(t.localName){case"author":this.score.tab=t.firstChild.innerText;break;case"comment":this.score.notices=t.firstChild.innerText}}}class Ss extends Qe{get name(){return"Capella"}readScore(){ee.debug(this.name,"Loading ZIP entries");let e,t=null;if(e=new Zt(this.data).read(),ee.debug(this.name,"Zip entries loaded"),e.length>0){for(const s of e)if("score.xml"===s.fileName)t=dt.toString(s.data,this.settings.importer.encoding)}else this.data.reset(),t=dt.toString(this.data.readAll(),this.settings.importer.encoding);if(!t)throw new Ze("No valid capella file");ee.debug(this.name,"Start Parsing score.xml");try{const e=new bs;e.parseXml(t,this.settings),ee.debug(this.name,"score.xml parsed");return e.score}catch(e){throw new Ze("Failed to parse CapXML",e)}}}class ws extends Qe{constructor(){super(...arguments),this._versionNumber=0,this._globalTripletFeel=A.NoTripletFeel,this._lyricsTrack=0,this._lyrics=[],this._barCount=0,this._trackCount=0,this._playbackInfos=[],this._doubleBars=new Set,this._clefsPerTrack=new Map,this._keySignatures=new Map,this._beatTextChunksByTrack=new Map,this._directionLookup=new Map}get name(){return"Guitar Pro 3-5"}readScore(){if(this._directionLookup.clear(),this.readVersion(),this._score=new Ke,this.readScoreInformation(),this._versionNumber<500&&(this._globalTripletFeel=Bs.gpReadBool(this.data)?A.Triplet8th:A.NoTripletFeel),this._versionNumber>=400&&this.readLyrics(),this._versionNumber>=510&&this.data.skip(19),this._versionNumber>=500&&(this.readPageSetup(),this._score.tempoLabel=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this._score.tempo=dt.readInt32LE(this.data),this._versionNumber>=510&&Bs.gpReadBool(this.data),dt.readInt32LE(this.data),this._versionNumber>=400&&this.data.readByte(),this.readPlaybackInfos(),this._versionNumber>=500&&(this.readDirection(xe.TargetCoda),this.readDirection(xe.TargetDoubleCoda),this.readDirection(xe.TargetSegno),this.readDirection(xe.TargetSegnoSegno),this.readDirection(xe.TargetFine),this.readDirection(xe.JumpDaCapo),this.readDirection(xe.JumpDaCapoAlCoda),this.readDirection(xe.JumpDaCapoAlDoubleCoda),this.readDirection(xe.JumpDaCapoAlFine),this.readDirection(xe.JumpDalSegno),this.readDirection(xe.JumpDalSegnoAlCoda),this.readDirection(xe.JumpDalSegnoAlDoubleCoda),this.readDirection(xe.JumpDalSegnoAlFine),this.readDirection(xe.JumpDalSegnoSegno),this.readDirection(xe.JumpDalSegnoSegnoAlCoda),this.readDirection(xe.JumpDalSegnoSegnoAlDoubleCoda),this.readDirection(xe.JumpDalSegnoSegnoAlFine),this.readDirection(xe.JumpDaCoda),this.readDirection(xe.JumpDaDoubleCoda),this.data.skip(4)),this._barCount=dt.readInt32LE(this.data),this._trackCount=dt.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),this._score.masterBars.length>0){const e=q.buildTempoAutomation(!1,0,this._score.tempo,2);e.text=this._score.tempoLabel,this._score.masterBars[0].tempoAutomations.push(e)}return De.consolidate(this._score),this._score.finish(this.settings),this._lyrics&&this._lyricsTrack>=0&&this._score.tracks[this._lyricsTrack].applyLyrics(this._lyrics),this._score}readDirection(e){let t,s=dt.readInt16LE(this.data);-1!==s&&(s--,this._directionLookup.has(s)?t=this._directionLookup.get(s):(t=[],this._directionLookup.set(s,t)),t.push(e))}readVersion(){let e=Bs.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!e.startsWith(ws.VersionString))throw new Ze("Unsupported format");e=e.substr(ws.VersionString.length+1);const t=e.indexOf(String.fromCharCode(46));this._versionNumber=100*Number.parseInt(e.substr(0,t),10)+Number.parseInt(e.substr(t+1),10),ee.debug(this.name,`Guitar Pro version ${e} detected`)}readScoreInformation(){this._score.title=Bs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.subTitle=Bs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.artist=Bs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.album=Bs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.words=Bs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.music=this._versionNumber>=500?Bs.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this._score.words,this._score.copyright=Bs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.tab=Bs.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.instructions=Bs.gpReadStringIntUnused(this.data,this.settings.importer.encoding);const e=dt.readInt32LE(this.data);let t="";for(let s=0;s<e;s++)s>0&&(t+="\r\n"),t+=Bs.gpReadStringIntUnused(this.data,this.settings.importer.encoding)?.toString();this._score.notices=t}readLyrics(){this._lyrics=[],this._lyricsTrack=dt.readInt32LE(this.data)-1;for(let e=0;e<5;e++){const e=new tt;e.startBar=dt.readInt32LE(this.data)-1,e.text=Bs.gpReadStringInt(this.data,this.settings.importer.encoding),this._lyrics.push(e)}}readPageSetup(){this.data.skip(28);const e=dt.readInt16LE(this.data);De.getOrCreateHeaderFooterStyle(this._score,ke.Title).isVisible=!!(1&e),De.getOrCreateHeaderFooterStyle(this._score,ke.Title).template=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),De.getOrCreateHeaderFooterStyle(this._score,ke.SubTitle).isVisible=!!(2&e),De.getOrCreateHeaderFooterStyle(this._score,ke.SubTitle).template=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),De.getOrCreateHeaderFooterStyle(this._score,ke.Artist).isVisible=!!(4&e),De.getOrCreateHeaderFooterStyle(this._score,ke.Artist).template=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),De.getOrCreateHeaderFooterStyle(this._score,ke.Album).isVisible=!!(8&e),De.getOrCreateHeaderFooterStyle(this._score,ke.Album).template=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),De.getOrCreateHeaderFooterStyle(this._score,ke.Words).isVisible=!!(16&e),De.getOrCreateHeaderFooterStyle(this._score,ke.Words).template=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),De.getOrCreateHeaderFooterStyle(this._score,ke.Music).isVisible=!!(32&e),De.getOrCreateHeaderFooterStyle(this._score,ke.Music).template=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),De.getOrCreateHeaderFooterStyle(this._score,ke.WordsAndMusic).isVisible=!!(64&e),De.getOrCreateHeaderFooterStyle(this._score,ke.WordsAndMusic).template=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),De.getOrCreateHeaderFooterStyle(this._score,ke.Copyright).isVisible=!!(128&e),De.getOrCreateHeaderFooterStyle(this._score,ke.Copyright).template=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),De.getOrCreateHeaderFooterStyle(this._score,ke.CopyrightSecondLine).isVisible=!!(128&e),De.getOrCreateHeaderFooterStyle(this._score,ke.CopyrightSecondLine).template=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this._playbackInfos=[];let e=0;for(let t=0;t<64;t++){const t=new rt;t.primaryChannel=e++,t.secondaryChannel=e++,t.program=dt.readInt32LE(this.data),t.volume=this.data.readByte(),t.balance=this.data.readByte(),this.data.skip(6),this._playbackInfos.push(t)}}readMasterBars(){for(let e=0;e<this._barCount;e++)this.readMasterBar()}readMasterBar(){let e=null;this._score.masterBars.length>0&&(e=this._score.masterBars[this._score.masterBars.length-1]);const t=new te,s=this.data.readByte();if(1&s?t.timeSignatureNumerator=this.data.readByte():e&&(t.timeSignatureNumerator=e.timeSignatureNumerator),2&s?t.timeSignatureDenominator=this.data.readByte():e&&(t.timeSignatureDenominator=e.timeSignatureDenominator),t.isRepeatStart=!!(4&s),8&s&&(t.repeatCount=this.data.readByte()+(this._versionNumber>=500?0:1)),16&s&&this._versionNumber<500){let s=e,i=0;for(;s&&(!s.isRepeatEnd||s===e)&&!s.isRepeatStart;)i|=s.alternateEndings,s=s.previousMasterBar;let a=0;const r=this.data.readByte();for(let e=0;e<8;e++){const t=1<<e;r>e&&0===(i&t)&&(a|=t)}t.alternateEndings=a}if(32&s){const e=new st;e.text=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),e.marker="",Bs.gpReadColor(this.data,!1),t.section=e}if(64&s&&this._keySignatures.set(this._score.masterBars.length,[dt.readSInt8(this.data),this.data.readByte()]),this._versionNumber>=500&&3&s&&this.data.skip(4),this._versionNumber>=500&&(t.alternateEndings=this.data.readByte()),this._versionNumber>=500){switch(this.data.readByte()){case 1:t.tripletFeel=A.Triplet8th;break;case 2:t.tripletFeel=A.Triplet16th}this.data.readByte()}else t.tripletFeel=this._globalTripletFeel;const i=!!(128&s);t.isDoubleBar=i;const a=this._score.masterBars.length;if(this._directionLookup.has(a))for(const e of this._directionLookup.get(a))t.addDirection(e);this._score.addMasterBar(t),i&&this._doubleBars.add(t.index)}readTracks(){for(let e=0;e<this._trackCount;e++)this.readTrack()}readTrack(){const e=new lt;e.ensureStaveCount(1),this._score.addTrack(e);const t=e.staves[0],s=this.data.readByte();e.name=Bs.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),1&s&&(t.isPercussion=!0),this._versionNumber>=500&&(e.isVisibleOnMultiTrack=!!(8&s)),null===this._score.stylesheet.perTrackDisplayTuning&&(this._score.stylesheet.perTrackDisplayTuning=new Map),this._score.stylesheet.perTrackDisplayTuning.set(e.index,!!(128&s));const i=dt.readInt32LE(this.data),a=[];for(let e=0;e<7;e++){const t=dt.readInt32LE(this.data);i>e&&a.push(t)}t.stringTuning.tunings=a;const r=dt.readInt32LE(this.data),n=dt.readInt32LE(this.data)-1,o=dt.readInt32LE(this.data)-1;if(this.data.skip(4),n>=0&&n<this._playbackInfos.length){const i=this._playbackInfos[n];i.port=r,i.isSolo=!!(16&s),i.isMute=!!(32&s),i.secondaryChannel=o,H.isGuitar(i.program)&&(t.displayTranspositionPitch=-12),e.playbackInfo=i}if(t.capo=dt.readInt32LE(this.data),e.color=Bs.gpReadColor(this.data,!1),this._versionNumber>=500){const s=this.data.readByte();t.showTablature=!!(1&s),t.showStandardNotation=!!(2&s);const i=!!(100&s);null===this._score.stylesheet.perTrackChordDiagramsOnTop&&(this._score.stylesheet.perTrackChordDiagramsOnTop=new Map),this._score.stylesheet.perTrackChordDiagramsOnTop.set(e.index,i),this.data.readByte(),this.data.readByte(),e.playbackInfo.bank=this.data.readByte(),this.data.readByte();12===dt.readInt32LE(this.data)?this._clefsPerTrack.set(n,h.F4):this._clefsPerTrack.set(n,h.G2),dt.readInt32LE(this.data),dt.readInt32LE(this.data),this.data.skip(10),this.data.readByte(),this.data.readByte(),this.readRseBank(),this._versionNumber>=510&&(this.data.skip(4),Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding))}else H.isBass(e.playbackInfo.program)?this._clefsPerTrack.set(n,h.F4):this._clefsPerTrack.set(n,h.G2)}readBars(){for(let e=0;e<this._barCount;e++)for(let e=0;e<this._trackCount;e++)this.readBar(this._score.tracks[e])}readBar(e){const t=new Y,s=e.staves[0];if(s.isPercussion?t.clef=h.Neutral:this._clefsPerTrack.has(e.index)&&(t.clef=this._clefsPerTrack.get(e.index)),s.addBar(t),this._keySignatures.has(t.index)){const e=this._keySignatures.get(t.index);t.keySignature=e[0],t.keySignatureType=e[1]}else t.index>0&&(t.keySignature=t.previousBar.keySignature,t.keySignatureType=t.previousBar.keySignatureType);this._doubleBars.has(t.index)&&(t.barLineRight=g.LightLight);let i=1;this._versionNumber>=500&&(this.data.readByte(),i=2);for(let s=0;s<i;s++)this.readVoice(e,t)}readVoice(e,t){const s=dt.readInt32LE(this.data);if(0===s)return;const i=new re;t.addVoice(i);for(let a=0;a<s;a++)this.readBeat(e,t,i)}readBeat(e,t,s){const i=new Ye,a=this.data.readByte();if(1&a&&(i.dots=1),64&a){const e=this.data.readByte();i.isEmpty=!(2&e)}s.addBeat(i);switch(dt.readSInt8(this.data)){case-2:i.duration=k.Whole;break;case-1:i.duration=k.Half;break;case 0:i.duration=k.Quarter;break;case 1:i.duration=k.Eighth;break;case 2:i.duration=k.Sixteenth;break;case 3:i.duration=k.ThirtySecond;break;case 4:i.duration=k.SixtyFourth;break;default:i.duration=k.Quarter}if(32&a)switch(i.tupletNumerator=dt.readInt32LE(this.data),i.tupletNumerator){case 1:i.tupletDenominator=1;break;case 3:i.tupletDenominator=2;break;case 5:case 6:case 7:i.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:i.tupletDenominator=8;break;case 2:case 4:case 8:break;default:i.tupletNumerator=1,i.tupletDenominator=1}2&a&&this.readChord(i);const r=this.settings.importer.beatTextAsLyrics&&e.index!==this._lyricsTrack;if(4&a){const t=Bs.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(r){const s=new tt;s.text=t.trim(),s.finish(!0);const i=[];for(let e=s.chunks.length-1;e>=0;e--)i.push(s.chunks[e]);this._beatTextChunksByTrack.set(e.index,i)}else i.text=t}let n=N.None;8&a&&(n=this.readBeatEffects(i)),16&a&&this.readMixTableChange(i);const o=this.data.readByte();for(let a=6;a>=0;a--)if(o&1<<a&&6-a<t.staff.tuning.length){const r=this.readNote(e,t,s,i,6-a);n!==N.None&&(r.harmonicType=n,r.harmonicType===N.Natural&&(r.harmonicValue=De.deltaFretToHarmonicValue(r.fret)))}if(this._versionNumber>=500){const e=dt.readInt16LE(this.data);if(1&e&&i.index>0&&(s.beats[i.index-1].beamingMode=be.ForceSplitToNext),2&e&&(i.preferredBeamDirection=Pe.Down),4&e&&i.index>0&&(s.beats[i.index-1].beamingMode=be.ForceMergeWithNext),8&e&&(i.preferredBeamDirection=Pe.Up),16&e&&(i.ottava=l._8va),32&e&&(i.ottava=l._8vb),64&e&&(i.ottava=l._15ma),256&e&&(i.ottava=l._15mb),2048&e){const e=0!==this.data.readByte();i.index>0&&e&&(s.beats[i.index-1].beamingMode=be.ForceSplitOnSecondaryToNext)}}r&&!i.isRest&&this._beatTextChunksByTrack.has(e.index)&&this._beatTextChunksByTrack.get(e.index).length>0&&(i.lyrics=[this._beatTextChunksByTrack.get(e.index).pop()])}readChord(e){const t=new et,s=De.newGuid();if(this._versionNumber>=500){this.data.skip(17),t.name=Bs.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),t.firstFret=dt.readInt32LE(this.data);for(let s=0;s<7;s++){const i=dt.readInt32LE(this.data);s<e.voice.bar.staff.tuning.length&&t.strings.push(i)}const s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let e=0;e<s;e++)t.barreFrets.push(i[e]);this.data.skip(26)}else if(0!==this.data.readByte())if(this._versionNumber>=400){this.data.skip(16),t.name=Bs.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),t.firstFret=dt.readInt32LE(this.data);for(let s=0;s<7;s++){const i=dt.readInt32LE(this.data);s<e.voice.bar.staff.tuning.length&&t.strings.push(i)}const s=this.data.readByte(),i=new Uint8Array(5);this.data.read(i,0,i.length);for(let e=0;e<s;e++)t.barreFrets.push(i[e]);this.data.skip(26)}else{this.data.skip(25),t.name=Bs.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),t.firstFret=dt.readInt32LE(this.data);for(let s=0;s<6;s++){const i=dt.readInt32LE(this.data);s<e.voice.bar.staff.tuning.length&&t.strings.push(i)}this.data.skip(36)}else{const s=this._versionNumber>=406?7:6;if(t.name=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),t.firstFret=dt.readInt32LE(this.data),t.firstFret>0)for(let i=0;i<s;i++){const s=dt.readInt32LE(this.data);i<e.voice.bar.staff.tuning.length&&t.strings.push(s)}}t.name&&(e.chordId=s,e.voice.bar.staff.addChord(e.chordId,t))}readBeatEffects(e){const t=this.data.readByte();let s=0;if(this._versionNumber>=400&&(s=this.data.readByte()),16&t&&(e.fade=me.FadeIn),(this._versionNumber<400&&1&t||2&t)&&(e.vibrato=M.Slight),1&s&&(e.rasgueado=ye.Ii),32&t&&this._versionNumber>=400){switch(dt.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0}}else if(32&t){switch(dt.readSInt8(this.data)){case 1:e.tap=!0;break;case 2:e.slap=!0;break;case 3:e.pop=!0}this.data.skip(4)}if(4&s&&this.readTremoloBarEffect(e),64&t){let t=0,s=0;this._versionNumber<500?(s=this.data.readByte(),t=this.data.readByte()):(t=this.data.readByte(),s=this.data.readByte()),t>0?(e.brushType=w.BrushUp,e.brushDuration=ws.toStrokeValue(t)):s>0&&(e.brushType=w.BrushDown,e.brushDuration=ws.toStrokeValue(s))}if(2&s)switch(dt.readSInt8(this.data)){case 0:e.pickStroke=he.None;break;case 1:e.pickStroke=he.Up;break;case 2:e.pickStroke=he.Down}if(this._versionNumber<400){if(4&t)return N.Natural;if(8&t)return N.Artificial}return N.None}readTremoloBarEffect(e){this.data.readByte(),dt.readInt32LE(this.data);const t=dt.readInt32LE(this.data);if(t>0)for(let s=0;s<t;s++){const t=new j(0,0);t.offset=dt.readInt32LE(this.data),t.value=dt.readInt32LE(this.data)/ws.BendStep|0,Bs.gpReadBool(this.data),e.addWhammyBarPoint(t)}}static toStrokeValue(e){switch(e){case 1:case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}readRseBank(){this.data.skip(4),this.data.skip(4),this.data.skip(4),this.data.skip(4)}readMixTableChange(e){const t=new ks;t.instrument=dt.readSInt8(this.data),this._versionNumber>=500&&this.readRseBank(),t.volume=dt.readSInt8(this.data),t.balance=dt.readSInt8(this.data);const s=dt.readSInt8(this.data),i=dt.readSInt8(this.data),a=dt.readSInt8(this.data),r=dt.readSInt8(this.data);if(this._versionNumber>=500&&(t.tempoName=Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.tempo=dt.readInt32LE(this.data),t.volume>=0&&this.data.readByte(),t.balance>=0&&this.data.readByte(),s>=0&&this.data.readByte(),i>=0&&this.data.readByte(),a>=0&&this.data.readByte(),r>=0&&this.data.readByte(),t.tempo>=0&&(t.duration=dt.readSInt8(this.data),this._versionNumber>=510&&this.data.readByte()),this._versionNumber>=400&&this.data.readByte(),this._versionNumber>=500){const t=dt.readSInt8(this.data);t>=100?e.wahPedal=ge.Closed:t>=0&&(e.wahPedal=ge.Open)}if(this._versionNumber>=510&&(Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding),Bs.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.volume>=0){const s=new q;s.isLinear=!0,s.type=y.Volume,s.value=t.volume,e.automations.push(s)}if(t.balance>=0){const s=new q;s.isLinear=!0,s.type=y.Balance,s.value=t.balance,e.automations.push(s)}if(t.instrument>=0){const s=new q;s.isLinear=!0,s.type=y.Instrument,s.value=t.instrument,e.automations.push(s)}if(t.tempo>=0){const s=new q;s.isLinear=!0,s.type=y.Tempo,s.value=t.tempo,e.automations.push(s),e.voice.bar.masterBar.tempoAutomations.some(e=>e.ratioPosition===s.ratioPosition&&e.value===s.value)||e.voice.bar.masterBar.tempoAutomations.push(s)}}readNote(e,t,s,i,a){const r=new Oe;r.string=t.staff.tuning.length-a;const n=this.data.readByte();if(2&n?r.accentuated=_.Heavy:64&n&&(r.accentuated=_.Normal),r.isGhost=!!(4&n),32&n){const e=this.data.readByte();3===e?r.isDead=!0:2===e&&(r.isTieDestination=!0)}if(1&n&&this._versionNumber<500&&(this.data.readByte(),this.data.readByte()),16&n){const e=dt.readSInt8(this.data);r.dynamics=this.toDynamicValue(e),i.dynamics=r.dynamics}32&n&&(r.fret=dt.readSInt8(this.data)),128&n&&(r.leftHandFinger=dt.readSInt8(this.data),r.rightHandFinger=dt.readSInt8(this.data));let o=!1;if(this._versionNumber>=500){1&n&&(r.durationPercent=dt.readFloat64BE(this.data));o=!!(2&this.data.readByte())}if(i.addNote(r),8&n&&this.readNoteEffects(e,s,i,r),t.staff.isPercussion&&(r.percussionArticulation=r.fret,r.string=-1,r.fret=-1),o){const e=De.computeAccidental(t.keySignature,P.Default,r.realValueWithoutHarmonic,!1);e===oe.Sharp?r.accidentalMode=P.ForceFlat:e===oe.Flat&&(r.accidentalMode=P.ForceSharp)}return r}toDynamicValue(e){switch(e){case 1:return f.PPP;case 2:return f.PP;case 3:return f.P;case 4:return f.MP;case 5:return f.MF;case 6:default:return f.F;case 7:return f.FF;case 8:return f.FFF}}readNoteEffects(e,t,s,i){const a=this.data.readByte();let r=0;this._versionNumber>=400&&(r=this.data.readByte()),1&a&&this.readBend(i),16&a&&this.readGrace(t,i),4&r&&this.readTremoloPicking(s),8&r?this.readSlide(i):this._versionNumber<400&&4&a&&(i.slideOutType=E.Shift),16&r&&this.readArtificialHarmonic(i),32&r&&this.readTrill(i),i.isLetRing=!!(8&a),i.isHammerPullOrigin=!!(2&a),64&r&&(i.vibrato=M.Slight),i.isPalmMute=!!(2&r),i.isStaccato=!!(1&r)}readBend(e){this.data.readByte(),dt.readInt32LE(this.data);const t=dt.readInt32LE(this.data);if(t>0)for(let s=0;s<t;s++){const t=new j(0,0);t.offset=dt.readInt32LE(this.data),t.value=dt.readInt32LE(this.data)/ws.BendStep|0,Bs.gpReadBool(this.data),e.addBendPoint(t)}}readGrace(e,t){const s=new Ye,i=new Oe;i.string=t.string,i.fret=dt.readSInt8(this.data),s.duration=k.ThirtySecond,s.dynamics=this.toDynamicValue(dt.readSInt8(this.data));switch(dt.readSInt8(this.data)){case 0:case 2:break;case 1:i.slideOutType=E.Legato,i.slideTarget=t;break;case 3:i.isHammerPullOrigin=!0}if(i.dynamics=s.dynamics,this.data.skip(1),this._versionNumber<500)s.graceType=T.BeforeBeat;else{const e=this.data.readByte();i.isDead=!!(1&e),s.graceType=2&e?T.OnBeat:T.BeforeBeat}e.addGraceBeat(s),s.addNote(i)}readTremoloPicking(e){switch(this.data.readByte()){case 1:e.tremoloSpeed=k.Eighth;break;case 2:e.tremoloSpeed=k.Sixteenth;break;case 3:e.tremoloSpeed=k.ThirtySecond}}readSlide(e){if(this._versionNumber>=500){const t=dt.readSInt8(this.data);1&t?e.slideOutType=E.Shift:2&t?e.slideOutType=E.Legato:4&t?e.slideOutType=E.OutDown:8&t&&(e.slideOutType=E.OutUp),16&t?e.slideInType=v.IntoFromBelow:32&t&&(e.slideInType=v.IntoFromAbove)}else{switch(dt.readSInt8(this.data)){case 1:e.slideOutType=E.Shift;break;case 2:e.slideOutType=E.Legato;break;case 3:e.slideOutType=E.OutDown;break;case 4:e.slideOutType=E.OutUp;break;case-1:e.slideInType=v.IntoFromBelow;break;case-2:e.slideInType=v.IntoFromAbove}}}readArtificialHarmonic(e){const t=this.data.readByte();if(this._versionNumber>=500)switch(t){case 1:e.harmonicType=N.Natural,e.harmonicValue=De.deltaFretToHarmonicValue(e.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),e.harmonicType=N.Artificial;break;case 3:e.harmonicType=N.Tap,e.harmonicValue=De.deltaFretToHarmonicValue(this.data.readByte());break;case 4:e.harmonicType=N.Pinch,e.harmonicValue=12;break;case 5:e.harmonicType=N.Semi,e.harmonicValue=12}else if(this._versionNumber>=400)switch(t){case 1:e.harmonicType=N.Natural;break;case 3:e.harmonicType=N.Tap;break;case 4:e.harmonicType=N.Pinch;break;case 5:e.harmonicType=N.Semi;break;case 15:case 17:case 22:e.harmonicType=N.Artificial}}readTrill(e){switch(e.trillValue=this.data.readByte()+e.stringTuning,this.data.readByte()){case 1:e.trillSpeed=k.Sixteenth;break;case 2:e.trillSpeed=k.ThirtySecond;break;case 3:e.trillSpeed=k.SixtyFourth}}}ws.VersionString="FICHIER GUITAR PRO ",ws.BendStep=25;class Bs{static gpReadColor(e,t=!1){const s=e.readByte(),i=e.readByte(),a=e.readByte();let r=255;return t?r=e.readByte():e.skip(1),new at(s,i,a,r)}static gpReadBool(e){return 0!==e.readByte()}static gpReadStringIntUnused(e,t){return e.skip(4),Bs.gpReadString(e,e.readByte(),t)}static gpReadStringInt(e,t){return Bs.gpReadString(e,dt.readInt32LE(e),t)}static gpReadStringIntByte(e,t){const s=dt.readInt32LE(e)-1;return e.readByte(),Bs.gpReadString(e,s,t)}static gpReadString(e,t,s){const i=new Uint8Array(t);return e.read(i,0,i.length),dt.toString(i,s)}static gpWriteString(e,t){const s=dt.stringToBytes(t);e.writeByte(t.length),e.write(s,0,s.length)}static gpReadStringByteLength(e,t,s){const i=e.readByte(),a=Bs.gpReadString(e,i,s);return i<t&&e.skip(t-i),a}}class ks{constructor(){this.volume=-1,this.balance=-1,this.instrument=-1,this.tempoName="",this.tempo=-1,this.duration=-1}}class Ts{constructor(){this.x=0,this.y=0,this.w=0,this.h=0}scaleWith(e){this.x*=e,this.y*=e,this.w*=e,this.h*=e}}!function(e){e[e.Boolean=0]="Boolean",e[e.Integer=1]="Integer",e[e.Float=2]="Float",e[e.String=3]="String",e[e.Point=4]="Point",e[e.Size=5]="Size",e[e.Rectangle=6]="Rectangle",e[e.Color=7]="Color"}(Nt||(Nt={}));class _s{constructor(e){this._types=new Map,this.raw=new Map,e&&this.read(e)}read(e){const t=ut.fromBuffer(e),s=dt.readInt32BE(t);for(let e=0;e<s;e++){const e=Bs.gpReadString(t,t.readByte(),"utf-8"),s=t.readByte();switch(this._types.set(e,s),s){case Nt.Boolean:const s=1===t.readByte();this.addValue(e,s);break;case Nt.Integer:const i=dt.readInt32BE(t);this.addValue(e,i);break;case Nt.Float:const a=dt.readFloat32BE(t);this.addValue(e,a);break;case Nt.String:const r=Bs.gpReadString(t,dt.readInt16BE(t),"utf-8");this.addValue(e,r);break;case Nt.Point:const n=dt.readInt32BE(t),o=dt.readInt32BE(t);this.addValue(e,new j(n,o));break;case Nt.Size:const h=dt.readInt32BE(t),l=dt.readInt32BE(t);this.addValue(e,new j(h,l));break;case Nt.Rectangle:const c=new Ts;c.x=dt.readInt32BE(t),c.y=dt.readInt32BE(t),c.w=dt.readInt32BE(t),c.h=dt.readInt32BE(t),this.addValue(e,c);break;case Nt.Color:const d=Bs.gpReadColor(t,!0);this.addValue(e,d)}}}apply(e){for(const[t,s]of this.raw)switch(t){case"StandardNotation/hideDynamics":e.stylesheet.hideDynamics=s;break;case"System/bracketExtendMode":e.stylesheet.bracketExtendMode=s;break;case"Global/useSystemSignSeparator":e.stylesheet.useSystemSignSeparator=s;break;case"Global/DisplayTuning":e.stylesheet.globalDisplayTuning=s;break;case"Global/DrawChords":e.stylesheet.globalDisplayChordDiagramsOnTop=s;break;case"System/showTrackNameSingle":s||(e.stylesheet.singleTrackTrackNamePolicy=r.Hidden);break;case"System/showTrackNameMulti":s||(e.stylesheet.multiTrackTrackNamePolicy=r.Hidden);break;case"System/trackNameModeSingle":if(e.stylesheet.singleTrackTrackNamePolicy!==r.Hidden)switch(s){case 0:case 1:e.stylesheet.singleTrackTrackNamePolicy=r.FirstSystem;break;case 2:e.stylesheet.singleTrackTrackNamePolicy=r.AllSystems}break;case"System/trackNameModeMulti":if(e.stylesheet.multiTrackTrackNamePolicy!==r.Hidden)switch(s){case 0:case 1:e.stylesheet.multiTrackTrackNamePolicy=r.FirstSystem;break;case 2:e.stylesheet.multiTrackTrackNamePolicy=r.AllSystems}break;case"System/shortTrackNameOnFirstSystem":e.stylesheet.firstSystemTrackNameMode=s?n.ShortName:n.FullName;break;case"System/shortTrackNameOnOtherSystems":e.stylesheet.otherSystemsTrackNameMode=s?n.ShortName:n.FullName;break;case"System/horizontalTrackNameOnFirstSystem":e.stylesheet.firstSystemTrackNameOrientation=s?o.Horizontal:o.Vertical;break;case"System/horizontalTrackNameOnOtherSystems":e.stylesheet.otherSystemsTrackNameOrientation=s?o.Horizontal:o.Vertical;break;case"Header/Title":De.getOrCreateHeaderFooterStyle(e,ke.Title).template=s;break;case"Header/TitleAlignment":De.getOrCreateHeaderFooterStyle(e,ke.Title).textAlign=this.toTextAlign(s);break;case"Header/drawTitle":De.getOrCreateHeaderFooterStyle(e,ke.Title).isVisible=s;break;case"Header/Subtitle":De.getOrCreateHeaderFooterStyle(e,ke.SubTitle).template=s;break;case"Header/SubtitleAlignment":De.getOrCreateHeaderFooterStyle(e,ke.SubTitle).textAlign=this.toTextAlign(s);break;case"Header/drawSubtitle":De.getOrCreateHeaderFooterStyle(e,ke.SubTitle).isVisible=s;break;case"Header/Artist":De.getOrCreateHeaderFooterStyle(e,ke.Artist).template=s;break;case"Header/ArtistAlignment":De.getOrCreateHeaderFooterStyle(e,ke.Artist).textAlign=this.toTextAlign(s);break;case"Header/drawArtist":De.getOrCreateHeaderFooterStyle(e,ke.Artist).isVisible=s;break;case"Header/Album":De.getOrCreateHeaderFooterStyle(e,ke.Album).template=s;break;case"Header/AlbumAlignment":De.getOrCreateHeaderFooterStyle(e,ke.Album).textAlign=this.toTextAlign(s);break;case"Header/drawAlbum":De.getOrCreateHeaderFooterStyle(e,ke.Album).isVisible=s;break;case"Header/Words":De.getOrCreateHeaderFooterStyle(e,ke.Words).template=s;break;case"Header/WordsAlignment":De.getOrCreateHeaderFooterStyle(e,ke.Words).textAlign=this.toTextAlign(s);break;case"Header/drawWords":De.getOrCreateHeaderFooterStyle(e,ke.Words).isVisible=s;break;case"Header/Music":De.getOrCreateHeaderFooterStyle(e,ke.Music).template=s;break;case"Header/MusicAlignment":De.getOrCreateHeaderFooterStyle(e,ke.Music).textAlign=this.toTextAlign(s);break;case"Header/drawMusic":De.getOrCreateHeaderFooterStyle(e,ke.Music).isVisible=s;break;case"Header/WordsAndMusic":De.getOrCreateHeaderFooterStyle(e,ke.WordsAndMusic).template=s;break;case"Header/WordsAndMusicAlignment":De.getOrCreateHeaderFooterStyle(e,ke.WordsAndMusic).textAlign=this.toTextAlign(s);break;case"Header/drawWordsAndMusic":De.getOrCreateHeaderFooterStyle(e,ke.WordsAndMusic).isVisible=s;break;case"Header/Tabber":De.getOrCreateHeaderFooterStyle(e,ke.Transcriber).template=s;break;case"Header/TabberAlignment":De.getOrCreateHeaderFooterStyle(e,ke.Transcriber).textAlign=this.toTextAlign(s);break;case"Header/drawTabber":De.getOrCreateHeaderFooterStyle(e,ke.Transcriber).isVisible=s;break;case"Footer/Copyright":De.getOrCreateHeaderFooterStyle(e,ke.Copyright).template=s;break;case"Footer/CopyrightAlignment":De.getOrCreateHeaderFooterStyle(e,ke.Copyright).textAlign=this.toTextAlign(s);break;case"Footer/drawCopyright":De.getOrCreateHeaderFooterStyle(e,ke.Copyright).isVisible=s;break;case"Footer/Copyright2":De.getOrCreateHeaderFooterStyle(e,ke.CopyrightSecondLine).template=s;break;case"Footer/Copyright2Alignment":De.getOrCreateHeaderFooterStyle(e,ke.CopyrightSecondLine).textAlign=this.toTextAlign(s);break;case"Footer/drawCopyright2":De.getOrCreateHeaderFooterStyle(e,ke.CopyrightSecondLine).isVisible=s}}toTextAlign(e){switch(e){case 0:return we.Left;case 1:return we.Center;case 2:return we.Right}return we.Left}addValue(e,t,s){this.raw.set(e,t),void 0!==s&&this._types.set(e,s)}writeTo(e){dt.writeInt32BE(e,this.raw.size);for(const[t,s]of this.raw){const i=this.getDataType(t,s);switch(Bs.gpWriteString(e,t),e.writeByte(i),i){case Nt.Boolean:e.writeByte(s?1:0);break;case Nt.Integer:dt.writeInt32BE(e,s);break;case Nt.Float:dt.writeFloat32BE(e,s);break;case Nt.String:const t=dt.stringToBytes(s);dt.writeInt16BE(e,t.length),e.write(t,0,t.length);break;case Nt.Point:case Nt.Size:dt.writeInt32BE(e,s.offset),dt.writeInt32BE(e,s.value);break;case Nt.Rectangle:dt.writeInt32BE(e,s.x),dt.writeInt32BE(e,s.y),dt.writeInt32BE(e,s.w),dt.writeInt32BE(e,s.h);break;case Nt.Color:e.writeByte(s.r),e.writeByte(s.g),e.writeByte(s.b),e.writeByte(s.a)}}}getDataType(t,s){if(this._types.has(t))return this._types.get(t);const i=typeof s;switch(typeof s){case"string":return Nt.String;case"number":return s===(0|s)?Nt.Integer:Nt.Float;case"object":if(s instanceof j)return Nt.Point;if(s instanceof Ts)return Nt.Rectangle;if(s instanceof at)return Nt.Color}throw new O(e.AlphaTabErrorType.General,`Unknown value type in BinaryStylesheet: ${i}`)}static writeForScore(e){const t=new _s;switch(t.addValue("StandardNotation/hideDynamics",e.stylesheet.hideDynamics,Nt.Boolean),t.addValue("System/bracketExtendMode",e.stylesheet.bracketExtendMode,Nt.Integer),t.addValue("Global/useSystemSignSeparator",e.stylesheet.useSystemSignSeparator,Nt.Boolean),t.addValue("Global/DisplayTuning",e.stylesheet.globalDisplayTuning,Nt.Boolean),t.addValue("Global/DrawChords",e.stylesheet.globalDisplayChordDiagramsOnTop,Nt.Boolean),e.stylesheet.singleTrackTrackNamePolicy){case r.Hidden:t.addValue("System/showTrackNameSingle",!1,Nt.Boolean);break;case r.FirstSystem:t.addValue("System/trackNameModeSingle",0,Nt.Integer);break;case r.AllSystems:t.addValue("System/trackNameModeSingle",2,Nt.Integer)}switch(e.stylesheet.multiTrackTrackNamePolicy){case r.Hidden:t.addValue("System/showTrackNameMulti",!1,Nt.Boolean);break;case r.FirstSystem:t.addValue("System/trackNameModeMulti",0,Nt.Integer);break;case r.AllSystems:t.addValue("System/trackNameModeMulti",2,Nt.Integer)}switch(e.stylesheet.firstSystemTrackNameMode){case n.FullName:t.addValue("System/shortTrackNameOnFirstSystem",!1,Nt.Boolean);break;case n.ShortName:t.addValue("System/shortTrackNameOnFirstSystem",!0,Nt.Boolean)}switch(e.stylesheet.otherSystemsTrackNameMode){case n.FullName:t.addValue("System/shortTrackNameOnOtherSystems",!1,Nt.Boolean);break;case n.ShortName:t.addValue("System/shortTrackNameOnOtherSystems",!0,Nt.Boolean)}switch(e.stylesheet.firstSystemTrackNameOrientation){case o.Horizontal:t.addValue("System/horizontalTrackNameOnFirstSystem",!0,Nt.Boolean);break;case o.Vertical:t.addValue("System/horizontalTrackNameOnFirstSystem",!1,Nt.Boolean)}switch(e.stylesheet.otherSystemsTrackNameOrientation){case o.Horizontal:t.addValue("System/horizontalTrackNameOnOtherSystems",!0,Nt.Boolean);break;case o.Vertical:t.addValue("System/horizontalTrackNameOnOtherSystems",!1,Nt.Boolean)}const s=e.style;if(s)for(const[e,i]of s.headerAndFooter)switch(e){case ke.Title:_s.addHeaderAndFooter(t,i,"Header/","Title");break;case ke.SubTitle:_s.addHeaderAndFooter(t,i,"Header/","Subtitle");break;case ke.Artist:_s.addHeaderAndFooter(t,i,"Header/","Artist");break;case ke.Album:_s.addHeaderAndFooter(t,i,"Header/","Album");break;case ke.Words:_s.addHeaderAndFooter(t,i,"Header/","Words");break;case ke.Music:_s.addHeaderAndFooter(t,i,"Header/","Music");break;case ke.WordsAndMusic:_s.addHeaderAndFooter(t,i,"Header/","WordsAndMusic");break;case ke.Transcriber:_s.addHeaderAndFooter(t,i,"Header/","Tabber");break;case ke.Copyright:_s.addHeaderAndFooter(t,i,"Footer/","Copyright");break;case ke.CopyrightSecondLine:_s.addHeaderAndFooter(t,i,"Footer/","Copyright2")}const i=ut.withCapacity(128);return t.writeTo(i),i.toArray()}static addHeaderAndFooter(e,t,s,i){e.addValue(`${s}${i}`,t.template,Nt.String),e.addValue(`${s}${i}Alignment`,t.textAlign,Nt.Integer),void 0!==t.isVisible&&e.addValue(`${s}draw${i}`,t.isVisible,Nt.Boolean)}}class xs{}class Ns{constructor(){this.id="",this.dots=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.value=k.Quarter}}class Ps{constructor(){this.name="",this.path="",this.role="",this.program=0,this.bank=0}get uniqueId(){return`${this.path};${this.name};${this.role}`}}class vs{constructor(){this._hasAnacrusis=!1,this._skipApplyLyrics=!1,this._backingTrackPadding=0,this._doubleBars=new Set,this._keySignatures=new Map,this._transposeKeySignaturePerTrack=new Map}parseXml(e,t){this._masterTrackAutomations=new Map,this._automationsPerTrackIdAndBarIndex=new Map,this._sustainPedalsPerTrackIdAndBarIndex=new Map,this._tracksMapping=[],this._tracksById=new Map,this._masterBars=[],this._barsOfMasterBar=[],this._voicesOfBar=new Map,this._barsById=new Map,this._voiceById=new Map,this._beatsOfVoice=new Map,this._beatById=new Map,this._rhythmOfBeat=new Map,this._rhythmById=new Map,this._notesOfBeat=new Map,this._noteById=new Map,this._tappedNotes=new Map,this._lyricsByTrack=new Map,this._soundsByTrack=new Map,this._skipApplyLyrics=!1;const s=new as;try{s.parse(e)}catch(e){throw new Ze("Could not parse XML",e)}if(this.parseDom(s),this.buildModel(),De.consolidate(this.score),this.score.finish(t),!this._skipApplyLyrics&&this._lyricsByTrack.size>0)for(const[e,t]of this._lyricsByTrack){this._tracksById.get(e).applyLyrics(t)}}parseDom(e){const t=e.firstElement;if(t){if("GPIF"!==t.localName)throw new Ze("Root node of XML was not GPIF");this.score=new Ke;for(const e of t.childElements())switch(e.localName){case"Score":this.parseScoreNode(e);break;case"MasterTrack":this.parseMasterTrackNode(e);break;case"BackingTrack":this.parseBackingTrackNode(e);break;case"Tracks":this.parseTracksNode(e);break;case"MasterBars":this.parseMasterBarsNode(e);break;case"Bars":this.parseBars(e);break;case"Voices":this.parseVoices(e);break;case"Beats":this.parseBeats(e);break;case"Notes":this.parseNotes(e);break;case"Rhythms":this.parseRhythms(e);break;case"Assets":this.parseAssets(e)}}}parseAssets(e){for(const t of e.childElements())if("Asset"===t.localName)t.getAttribute("id")===this._backingTrackAssetId&&this.parseBackingTrackAsset(t)}parseBackingTrackAsset(e){let t="";for(const s of e.childElements())if("EmbeddedFilePath"===s.localName)t=s.innerText;const s=this.loadAsset;if(s){const e=s(t);e?this.score.backingTrack.rawAudioFile=e:this.score.backingTrack=void 0}}parseScoreNode(e){for(const t of e.childElements())switch(t.localName){case"Title":this.score.title=t.innerText;break;case"SubTitle":this.score.subTitle=t.innerText;break;case"Artist":this.score.artist=t.innerText;break;case"Album":this.score.album=t.innerText;break;case"Words":this.score.words=t.innerText;break;case"Music":this.score.music=t.innerText;break;case"WordsAndMusic":const e=t.innerText;""!==e&&(e&&!this.score.words&&(this.score.words=e),e&&!this.score.music&&(this.score.music=e));break;case"Copyright":this.score.copyright=t.innerText;break;case"Tabber":this.score.tab=t.innerText;break;case"Instructions":this.score.instructions=t.innerText;break;case"Notices":this.score.notices=t.innerText;break;case"ScoreSystemsDefaultLayout":this.score.defaultSystemsLayout=vs.parseIntSafe(t.innerText,4);break;case"ScoreSystemsLayout":this.score.systemsLayout=vs.splitSafe(t.innerText).map(e=>vs.parseIntSafe(e,4))}}static parseIntSafe(e,t){if(!e)return t;const s=Number.parseInt(e,10);return Number.isNaN(s)?t:s}static parseFloatSafe(e,t){if(!e)return t;const s=Number.parseFloat(e);return Number.isNaN(s)?t:s}static splitSafe(e,t=" "){return e?e.split(t).map(e=>e.trim()).filter(e=>e.length>0):[]}parseBackingTrackNode(e){const t=new xs;let s=!1,i="",a="";for(const t of e.childElements())switch(t.localName){case"Enabled":s="true"===t.innerText;break;case"Source":i=t.innerText;break;case"AssetId":a=t.innerText;break;case"FramePadding":this._backingTrackPadding=vs.parseIntSafe(t.innerText,0)/vs.SampleRate*1e3}s&&"Local"===i&&(this.score.backingTrack=t,this._backingTrackAssetId=a)}parseMasterTrackNode(e){for(const t of e.childElements())switch(t.localName){case"Automations":this.parseAutomations(t,this._masterTrackAutomations,null,null);break;case"Tracks":this._tracksMapping=vs.splitSafe(t.innerText);break;case"Anacrusis":this._hasAnacrusis=!0}}parseAutomations(e,t,s,i){for(const a of e.childElements())if("Automation"===a.localName)this.parseAutomation(a,t,s,i)}parseAutomation(e,t,s,i){let a,r=null,n=!1,o=-1,h=0,l=0,c=null,d=0,u=null;for(const t of e.childElements())switch(t.localName){case"Type":r=t.innerText;break;case"Linear":n="true"===t.innerText.toLowerCase();break;case"Bar":o=vs.parseIntSafe(t.innerText,0);break;case"Position":h=vs.parseFloatSafe(t.innerText,0);break;case"Value":if(t.firstElement&&t.firstElement.nodeType===Tt.CDATA)c=t.innerText;else if(t.firstElement&&t.firstElement.nodeType===Tt.Element&&"SyncPoint"===r){a=new $;for(const e of t.childElements())switch(e.localName){case"BarIndex":o=vs.parseIntSafe(e.innerText,0);break;case"BarOccurrence":a.barOccurence=vs.parseIntSafe(e.innerText,0);break;case"FrameOffset":const t=vs.parseFloatSafe(e.innerText,0);a.millisecondOffset=t/vs.SampleRate*1e3}}else{const e=vs.splitSafe(t.innerText);1===e.length?(l=vs.parseFloatSafe(e[0],0),d=1):(l=vs.parseFloatSafe(e[0],0),d=vs.parseIntSafe(e[1],0))}break;case"Text":u=t.innerText}if(!r)return;const m=[];switch(r){case"Tempo":m.push(q.buildTempoAutomation(n,h,l,d));break;case"SyncPoint":const e=new q;e.type=y.SyncPoint,e.isLinear=n,e.ratioPosition=h,e.syncPointValue=a,m.push(e);break;case"Sound":if(c&&s&&s.has(c)){const e=new q;e.type=y.Bank,e.ratioPosition=h,e.value=s.get(c).bank,m.push(e);const t=q.buildInstrumentAutomation(n,h,s.get(c).program);m.push(t)}break;case"SustainPedal":if(i){let e;i.has(o)?e=i.get(o):(e=[],i.set(o,e));const t=new z;switch(t.ratioPosition=h,d){case 1:t.pedalType=p.Down;break;case 3:t.pedalType=p.Up}e.push(t)}}if(m.length){if(u)for(const e of m)e.text=u;if(o>=0){t.has(o)||t.set(o,[]);for(const e of m)t.get(o).push(e)}}}parseTracksNode(e){for(const t of e.childElements())if("Track"===t.localName)this.parseTrack(t)}parseTrack(e){this._articulationByName=new Map;const t=new lt;t.ensureStaveCount(1);t.staves[0].showStandardNotation=!0;const s=e.getAttribute("id");for(const i of e.childElements())switch(i.localName){case"Name":t.name=i.innerText;break;case"Color":const e=vs.splitSafe(i.innerText);if(e.length>=3){const s=vs.parseIntSafe(e[0],0),i=vs.parseIntSafe(e[1],0),a=vs.parseIntSafe(e[2],0);t.color=new at(s,i,a,255)}break;case"Instrument":const a=i.getAttribute("ref");(a.endsWith("-gs")||a.endsWith("GrandStaff"))&&(t.ensureStaveCount(2),t.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this.parseInstrumentSet(t,i);break;case"NotationPatch":this.parseNotationPatch(t,i);break;case"ShortName":t.shortName=i.innerText;break;case"SystemsDefautLayout":t.defaultSystemsLayout=vs.parseIntSafe(i.innerText,4);break;case"SystemsLayout":t.systemsLayout=vs.splitSafe(i.innerText).map(e=>vs.parseIntSafe(e,4));break;case"Lyrics":this.parseLyrics(s,i);break;case"Properties":this.parseTrackProperties(t,i);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this.parseGeneralMidi(t,i);break;case"Sounds":this.parseSounds(s,t,i);break;case"PlaybackState":const r=i.innerText;t.playbackInfo.isSolo="Solo"===r,t.playbackInfo.isMute="Mute"===r;break;case"PartSounding":this.parsePartSounding(s,t,i);break;case"Staves":this.parseStaves(t,i);break;case"Transpose":this.parseTranspose(s,t,i);break;case"RSE":this.parseRSE(t,i);break;case"Automations":this.parseTrackAutomations(s,i)}this._tracksById.set(s,t)}parseTrackAutomations(e,t){const s=new Map;this._automationsPerTrackIdAndBarIndex.set(e,s);const i=new Map;this._sustainPedalsPerTrackIdAndBarIndex.set(e,i),this.parseAutomations(t,s,this._soundsByTrack.get(e),i)}parseNotationPatch(e,t){for(const s of t.childElements())switch(s.localName){case"LineCount":const t=vs.parseIntSafe(s.innerText,5);for(const s of e.staves)s.standardNotationLineCount=t;break;case"Elements":this.parseElements(e,s)}}parseInstrumentSet(e,t){for(const s of t.childElements())switch(s.localName){case"Type":if("drumKit"===s.innerText)for(const t of e.staves)t.isPercussion=!0;break;case"Elements":this.parseElements(e,s);break;case"LineCount":const t=vs.parseIntSafe(s.innerText,5);for(const s of e.staves)s.standardNotationLineCount=t}}parseElements(e,t){for(const s of t.childElements())if("Element"===s.localName)this.parseElement(e,s)}parseElement(e,t){const s=t.findChildElement("Type")?.innerText??"";for(const i of t.childElements())switch(i.localName){case"Name":case"Articulations":this.parseArticulations(e,i,s)}}parseArticulations(e,t,s){for(const i of t.childElements())if("Articulation"===i.localName)this.parseArticulation(e,i,s)}parseArticulation(e,t,s){const i=new Le;i.outputMidiNumber=-1,i.elementType=s;let a="";for(const e of t.childElements()){const t=e.innerText;switch(e.localName){case"Name":a=e.innerText;break;case"OutputMidiNumber":i.outputMidiNumber=vs.parseIntSafe(t,0);break;case"TechniqueSymbol":i.techniqueSymbol=this.parseTechniqueSymbol(t);break;case"TechniquePlacement":switch(t){case"outside":i.techniqueSymbolPlacement=le.Outside;break;case"inside":i.techniqueSymbolPlacement=le.Inside;break;case"above":i.techniqueSymbolPlacement=le.Above;break;case"below":i.techniqueSymbolPlacement=le.Below}break;case"Noteheads":const s=vs.splitSafe(t);s.length>=1&&(i.noteHeadDefault=this.parseNoteHead(s[0])),s.length>=2&&(i.noteHeadHalf=this.parseNoteHead(s[1])),s.length>=3&&(i.noteHeadWhole=this.parseNoteHead(s[2])),i.noteHeadHalf===ne.None&&(i.noteHeadHalf=i.noteHeadDefault),i.noteHeadWhole===ne.None&&(i.noteHeadWhole=i.noteHeadDefault);break;case"StaffLine":i.staffLine=vs.parseIntSafe(t,0)}}-1!==i.outputMidiNumber?(e.percussionArticulations.push(i),a.length>0&&this._articulationByName.set(a,i)):a.length>0&&this._articulationByName.has(a)&&(this._articulationByName.get(a).staffLine=i.staffLine)}parseTechniqueSymbol(e){switch(e){case"pictEdgeOfCymbal":return ne.PictEdgeOfCymbal;case"articStaccatoAbove":return ne.ArticStaccatoAbove;case"noteheadParenthesis":return ne.NoteheadParenthesis;case"stringsUpBow":return ne.StringsUpBow;case"stringsDownBow":return ne.StringsDownBow;case"guitarGolpe":return ne.GuitarGolpe;default:return ne.None}}parseNoteHead(e){switch(e){case"noteheadDoubleWholeSquare":return ne.NoteheadDoubleWholeSquare;case"noteheadDoubleWhole":return ne.NoteheadDoubleWhole;case"noteheadWhole":return ne.NoteheadWhole;case"noteheadHalf":return ne.NoteheadHalf;case"noteheadBlack":return ne.NoteheadBlack;case"noteheadNull":return ne.NoteheadNull;case"noteheadXOrnate":return ne.NoteheadXOrnate;case"noteheadTriangleUpWhole":return ne.NoteheadTriangleUpWhole;case"noteheadTriangleUpHalf":return ne.NoteheadTriangleUpHalf;case"noteheadTriangleUpBlack":return ne.NoteheadTriangleUpBlack;case"noteheadDiamondBlackWide":return ne.NoteheadDiamondBlackWide;case"noteheadDiamondWhite":return ne.NoteheadDiamondWhite;case"noteheadDiamondWhiteWide":return ne.NoteheadDiamondWhiteWide;case"noteheadCircleX":return ne.NoteheadCircleX;case"noteheadXWhole":return ne.NoteheadXWhole;case"noteheadXHalf":return ne.NoteheadXHalf;case"noteheadXBlack":return ne.NoteheadXBlack;case"noteheadParenthesis":return ne.NoteheadParenthesis;case"noteheadSlashedBlack2":return ne.NoteheadSlashedBlack2;case"noteheadCircleSlash":return ne.NoteheadCircleSlash;case"noteheadHeavyX":return ne.NoteheadHeavyX;case"noteheadHeavyXHat":return ne.NoteheadHeavyXHat;default:return ee.warning("GPIF","Unknown notehead symbol",e),ne.None}}parseStaves(e,t){let s=0;for(const i of t.childElements())if("Staff"===i.localName){e.ensureStaveCount(s+1);const t=e.staves[s];this.parseStaff(t,i),s++}}parseStaff(e,t){for(const s of t.childElements())if("Properties"===s.localName)this.parseStaffProperties(e,s)}parseStaffProperties(e,t){for(const s of t.childElements())if("Property"===s.localName)this.parseStaffProperty(e,s)}parseStaffProperty(e,t){switch(t.getAttribute("name")){case"Tuning":for(const s of t.childElements())switch(s.localName){case"Pitches":const i=vs.splitSafe(t.findChildElement("Pitches")?.innerText),a=new Array(i.length);for(let e=0;e<a.length;e++)a[a.length-1-e]=vs.parseIntSafe(i[e],0);e.stringTuning.tunings=a;break;case"Label":e.stringTuning.name=s.innerText}e.isPercussion||(e.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this.parseDiagramCollectionForStaff(e,t);break;case"CapoFret":const s=vs.parseIntSafe(t.findChildElement("Fret")?.innerText,0);e.capo=s}}parseLyrics(e,t){const s=[];for(const e of t.childElements())if("Line"===e.localName)s.push(this.parseLyricsLine(e));this._lyricsByTrack.set(e,s)}parseLyricsLine(e){const t=new tt;for(const s of e.childElements())switch(s.localName){case"Offset":t.startBar=vs.parseIntSafe(s.innerText,0);break;case"Text":t.text=s.innerText}return t}parseDiagramCollectionForTrack(e,t){const s=t.findChildElement("Items");if(s)for(const t of s.childElements())if("Item"===t.localName)this.parseDiagramItemForTrack(e,t)}parseDiagramCollectionForStaff(e,t){const s=t.findChildElement("Items");if(s)for(const t of s.childElements())if("Item"===t.localName)this.parseDiagramItemForStaff(e,t)}parseDiagramItemForTrack(e,t){const s=new et,i=t.getAttribute("id");for(const t of e.staves)t.addChord(i,s);this.parseDiagramItemForChord(s,t)}parseDiagramItemForStaff(e,t){const s=new et,i=t.getAttribute("id");e.addChord(i,s),this.parseDiagramItemForChord(s,t)}parseDiagramItemForChord(e,t){e.name=t.getAttribute("name");const s=t.findChildElement("Diagram");if(!s)return e.showDiagram=!1,void(e.showFingering=!1);const i=vs.parseIntSafe(s.getAttribute("stringCount"),6),a=vs.parseIntSafe(s.getAttribute("baseFret"),0);e.firstFret=a+1;for(let t=0;t<i;t++)e.strings.push(-1);for(const t of s.childElements())switch(t.localName){case"Fret":const s=vs.parseIntSafe(t.getAttribute("string"),0);e.strings[i-s-1]=a+vs.parseIntSafe(t.getAttribute("fret"),0);break;case"Fingering":const r=new Map;for(const s of t.childElements())if("Position"===s.localName){let t=x.Unknown;const i=a+vs.parseIntSafe(s.getAttribute("fret"),0);switch(s.getAttribute("finger")){case"Index":t=x.IndexFinger;break;case"Middle":t=x.MiddleFinger;break;case"Rank":t=x.AnnularFinger;break;case"Pinky":t=x.LittleFinger;break;case"Thumb":t=x.Thumb}t!==x.Unknown&&(r.has(t)?e.barreFrets.push(i):r.set(t,!0))}break;case"Property":switch(t.getAttribute("name")){case"ShowName":e.showName="true"===t.getAttribute("value");break;case"ShowDiagram":e.showDiagram="true"===t.getAttribute("value");break;case"ShowFingering":e.showFingering="true"===t.getAttribute("value")}}}parseTrackProperties(e,t){for(const s of t.childElements())if("Property"===s.localName)this.parseTrackProperty(e,s)}parseTrackProperty(e,t){switch(t.getAttribute("name")){case"Tuning":const s=vs.splitSafe(t.findChildElement("Pitches")?.innerText),i=new Array(s.length);for(let e=0;e<i.length;e++)i[i.length-1-e]=vs.parseIntSafe(s[e],0);for(const t of e.staves)t.stringTuning.tunings=i,t.showStandardNotation=!0,t.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this.parseDiagramCollectionForTrack(e,t);break;case"CapoFret":const a=vs.parseIntSafe(t.findChildElement("Fret")?.innerText,0);for(const t of e.staves)t.capo=a}}parseGeneralMidi(e,t){for(const s of t.childElements())switch(s.localName){case"Program":e.playbackInfo.program=vs.parseIntSafe(s.innerText,0);break;case"Port":e.playbackInfo.port=vs.parseIntSafe(s.innerText,0);break;case"PrimaryChannel":e.playbackInfo.primaryChannel=vs.parseIntSafe(s.innerText,0);break;case"SecondaryChannel":e.playbackInfo.secondaryChannel=vs.parseIntSafe(s.innerText,0)}if("Percussion"===t.getAttribute("table"))for(const t of e.staves)t.isPercussion=!0}parseSounds(e,t,s){for(const i of s.childElements())if("Sound"===i.localName)this.parseSound(e,t,i)}parseSound(e,t,s){const i=new Ps;for(const e of s.childElements())switch(e.localName){case"Name":i.name=e.innerText;break;case"Path":i.path=e.innerText;break;case"Role":i.role=e.innerText;break;case"MIDI":this.parseSoundMidi(i,e)}this._soundsByTrack.has(e)||(this._soundsByTrack.set(e,new Map),t.playbackInfo.program=i.program,t.playbackInfo.bank=i.bank),this._soundsByTrack.get(e).set(i.uniqueId,i)}parseSoundMidi(e,t){let s=0,i=0;for(const a of t.childElements())switch(a.localName){case"Program":e.program=vs.parseIntSafe(a.innerText,0);break;case"MSB":s=vs.parseIntSafe(a.innerText,0);break;case"LSB":i=vs.parseIntSafe(a.innerText,0)}e.bank=(127&s)<<7|i}parsePartSounding(e,t,s){for(const i of s.childElements())switch(i.localName){case"TranspositionPitch":for(const e of t.staves)e.displayTranspositionPitch=vs.parseIntSafe(i.innerText,0);break;case"NominalKey":const s=Math.max(0,nt.noteNames.indexOf(i.innerText));this._transposeKeySignaturePerTrack.set(e,s)}}parseTranspose(e,t,s){let i=0,a=0;for(const e of s.childElements())switch(e.localName){case"Chromatic":a=vs.parseIntSafe(e.innerText,0);break;case"Octave":i=vs.parseIntSafe(e.innerText,0)}const r=12*i+a;for(const e of t.staves)e.displayTranspositionPitch=r;const n=De.flooredDivision(r,12);this._transposeKeySignaturePerTrack.set(e,n)}parseRSE(e,t){for(const s of t.childElements())if("ChannelStrip"===s.localName)this.parseChannelStrip(e,s)}parseChannelStrip(e,t){for(const s of t.childElements())if("Parameters"===s.localName)this.parseChannelStripParameters(e,s)}parseChannelStripParameters(e,t){if(t.firstChild&&t.firstChild.value){const s=vs.splitSafe(t.firstChild.value);s.length>=12&&(e.playbackInfo.balance=Math.floor(16*vs.parseFloatSafe(s[11],.5)),e.playbackInfo.volume=Math.floor(16*vs.parseFloatSafe(s[12],.9)))}}parseMasterBarsNode(e){for(const t of e.childElements())if("MasterBar"===t.localName)this.parseMasterBar(t)}parseMasterBar(e){const t=new te;0===this._masterBars.length&&this._hasAnacrusis&&(t.isAnacrusis=!0);for(const s of e.childElements())switch(s.localName){case"Time":const e=s.innerText.split("/");t.timeSignatureNumerator=vs.parseIntSafe(e[0],4),t.timeSignatureDenominator=vs.parseIntSafe(e[1],4);break;case"FreeTime":t.isFreeTime=!0;break;case"DoubleBar":t.isDoubleBar=!0,this._doubleBars.add(t);break;case"Section":t.section=new st,t.section.marker=s.findChildElement("Letter")?.innerText??"",t.section.text=s.findChildElement("Text")?.innerText??"";break;case"Repeat":"true"===s.getAttribute("start").toLowerCase()&&(t.isRepeatStart=!0),"true"===s.getAttribute("end").toLowerCase()&&s.getAttribute("count")&&(t.repeatCount=vs.parseIntSafe(s.getAttribute("count"),1));break;case"AlternateEndings":const i=vs.splitSafe(s.innerText);let a=0;for(let e=0;e<i.length;e++)a|=1<<-1+vs.parseIntSafe(i[e],0);t.alternateEndings=a;break;case"Bars":this._barsOfMasterBar.push(vs.splitSafe(s.innerText));break;case"TripletFeel":switch(s.innerText){case"NoTripletFeel":t.tripletFeel=A.NoTripletFeel;break;case"Triplet8th":t.tripletFeel=A.Triplet8th;break;case"Triplet16th":t.tripletFeel=A.Triplet16th;break;case"Dotted8th":t.tripletFeel=A.Dotted8th;break;case"Dotted16th":t.tripletFeel=A.Dotted16th;break;case"Scottish8th":t.tripletFeel=A.Scottish8th;break;case"Scottish16th":t.tripletFeel=A.Scottish16th}break;case"Key":const r=vs.parseIntSafe(s.findChildElement("AccidentalCount")?.innerText,0),n=s.findChildElement("Mode");let o=u.Major;if(n)switch(n.innerText.toLowerCase()){case"major":o=u.Major;break;case"minor":o=u.Minor}this._keySignatures.set(this._masterBars.length,[r,o]);break;case"Fermatas":this.parseFermatas(t,s);break;case"XProperties":this.parseMasterBarXProperties(t,s);break;case"Directions":this.parseDirections(t,s)}this._masterBars.push(t)}parseDirections(e,t){for(const s of t.childElements())switch(s.localName){case"Target":switch(s.innerText){case"Coda":e.addDirection(xe.TargetCoda);break;case"DoubleCoda":e.addDirection(xe.TargetDoubleCoda);break;case"Segno":e.addDirection(xe.TargetSegno);break;case"SegnoSegno":e.addDirection(xe.TargetSegnoSegno);break;case"Fine":e.addDirection(xe.TargetFine)}break;case"Jump":switch(s.innerText){case"DaCapo":e.addDirection(xe.JumpDaCapo);break;case"DaCapoAlCoda":e.addDirection(xe.JumpDaCapoAlCoda);break;case"DaCapoAlDoubleCoda":e.addDirection(xe.JumpDaCapoAlDoubleCoda);break;case"DaCapoAlFine":e.addDirection(xe.JumpDaCapoAlFine);break;case"DaSegno":e.addDirection(xe.JumpDalSegno);break;case"DaSegnoAlCoda":e.addDirection(xe.JumpDalSegnoAlCoda);break;case"DaSegnoAlDoubleCoda":e.addDirection(xe.JumpDalSegnoAlDoubleCoda);break;case"DaSegnoAlFine":e.addDirection(xe.JumpDalSegnoAlFine);break;case"DaSegnoSegno":e.addDirection(xe.JumpDalSegnoSegno);break;case"DaSegnoSegnoAlCoda":e.addDirection(xe.JumpDalSegnoSegnoAlCoda);break;case"DaSegnoSegnoAlDoubleCoda":e.addDirection(xe.JumpDalSegnoSegnoAlDoubleCoda);break;case"DaSegnoSegnoAlFine":e.addDirection(xe.JumpDalSegnoSegnoAlFine);break;case"DaCoda":e.addDirection(xe.JumpDaCoda);break;case"DaDoubleCoda":e.addDirection(xe.JumpDaDoubleCoda)}}}parseFermatas(e,t){for(const s of t.childElements())if("Fermata"===s.localName)this.parseFermata(e,s)}parseFermata(e,t){let s=0;const i=new pt;for(const e of t.childElements())switch(e.localName){case"Type":switch(e.innerText){case"Short":i.type=Ne.Short;break;case"Medium":i.type=Ne.Medium;break;case"Long":i.type=Ne.Long}break;case"Length":i.length=vs.parseFloatSafe(e.innerText,0);break;case"Offset":const t=e.innerText.split("/");if(2===t.length){s=vs.parseIntSafe(t[0],4)/vs.parseIntSafe(t[1],4)*J.QuarterTime|0}}e.addFermata(s,i)}parseBars(e){for(const t of e.childElements())if("Bar"===t.localName)this.parseBar(t)}parseBar(e){const t=new Y,s=e.getAttribute("id");for(const i of e.childElements())switch(i.localName){case"Voices":this._voicesOfBar.set(s,vs.splitSafe(i.innerText));break;case"Clef":switch(i.innerText){case"Neutral":t.clef=h.Neutral;break;case"G2":t.clef=h.G2;break;case"F4":t.clef=h.F4;break;case"C4":t.clef=h.C4;break;case"C3":t.clef=h.C3}break;case"Ottavia":switch(i.innerText){case"8va":t.clefOttava=l._8va;break;case"15ma":t.clefOttava=l._15ma;break;case"8vb":t.clefOttava=l._8vb;break;case"15mb":t.clefOttava=l._15mb}break;case"SimileMark":switch(i.innerText){case"Simple":t.simileMark=c.Simple;break;case"FirstOfDouble":t.simileMark=c.FirstOfDouble;break;case"SecondOfDouble":t.simileMark=c.SecondOfDouble}break;case"XProperties":this.parseBarXProperties(i,t)}this._barsById.set(s,t)}parseVoices(e){for(const t of e.childElements())if("Voice"===t.localName)this.parseVoice(t)}parseVoice(e){const t=new re,s=e.getAttribute("id");for(const t of e.childElements())if("Beats"===t.localName)this._beatsOfVoice.set(s,vs.splitSafe(t.innerText));this._voiceById.set(s,t)}parseBeats(e){for(const t of e.childElements())if("Beat"===t.localName)this.parseBeat(t)}parseBeat(e){const t=new Ye,s=e.getAttribute("id");for(const i of e.childElements())switch(i.localName){case"Notes":this._notesOfBeat.set(s,vs.splitSafe(i.innerText));break;case"Rhythm":this._rhythmOfBeat.set(s,i.getAttribute("ref"));break;case"Fadding":switch(i.innerText){case"FadeIn":t.fade=me.FadeIn;break;case"FadeOut":t.fade=me.FadeOut;break;case"VolumeSwell":t.fade=me.VolumeSwell}break;case"Tremolo":switch(i.innerText){case"1/2":t.tremoloSpeed=k.Eighth;break;case"1/4":t.tremoloSpeed=k.Sixteenth;break;case"1/8":t.tremoloSpeed=k.ThirtySecond}break;case"Chord":t.chordId=i.innerText;break;case"Hairpin":switch(i.innerText){case"Crescendo":t.crescendo=B.Crescendo;break;case"Decrescendo":t.crescendo=B.Decrescendo}break;case"Arpeggio":"Up"===i.innerText?t.brushType=w.ArpeggioUp:t.brushType=w.ArpeggioDown;break;case"Properties":this.parseBeatProperties(i,t);break;case"XProperties":this.parseBeatXProperties(i,t);break;case"FreeText":t.text=i.innerText;break;case"TransposedPitchStemOrientation":switch(i.innerText){case"Upward":t.preferredBeamDirection=Pe.Up;break;case"Downward":t.preferredBeamDirection=Pe.Down}break;case"Dynamic":switch(i.innerText){case"PPP":t.dynamics=f.PPP;break;case"PP":t.dynamics=f.PP;break;case"P":t.dynamics=f.P;break;case"MP":t.dynamics=f.MP;break;case"MF":t.dynamics=f.MF;break;case"F":t.dynamics=f.F;break;case"FF":t.dynamics=f.FF;break;case"FFF":t.dynamics=f.FFF}break;case"GraceNotes":switch(i.innerText){case"OnBeat":t.graceType=T.OnBeat;break;case"BeforeBeat":t.graceType=T.BeforeBeat}break;case"Legato":"true"===i.getAttribute("origin")&&(t.isLegatoOrigin=!0);break;case"Whammy":const e=new j(0,0);e.value=this.toBendValue(vs.parseFloatSafe(i.getAttribute("originValue"),0)),e.offset=this.toBendOffset(vs.parseFloatSafe(i.getAttribute("originOffset"),0)),t.addWhammyBarPoint(e);const a=new j(0,0);a.value=this.toBendValue(vs.parseFloatSafe(i.getAttribute("middleValue"),0)),a.offset=this.toBendOffset(vs.parseFloatSafe(i.getAttribute("middleOffset1"),0)),t.addWhammyBarPoint(a);const r=new j(0,0);r.value=this.toBendValue(vs.parseFloatSafe(i.getAttribute("middleValue"),0)),r.offset=this.toBendOffset(vs.parseFloatSafe(i.getAttribute("middleOffset2"),0)),t.addWhammyBarPoint(r);const n=new j(0,0);n.value=this.toBendValue(vs.parseFloatSafe(i.getAttribute("destinationValue"),0)),n.offset=this.toBendOffset(vs.parseFloatSafe(i.getAttribute("destinationOffset"),0)),t.addWhammyBarPoint(n);break;case"Ottavia":switch(i.innerText){case"8va":t.ottava=l._8va;break;case"8vb":t.ottava=l._8vb;break;case"15ma":t.ottava=l._15ma;break;case"15mb":t.ottava=l._15mb}break;case"Lyrics":t.lyrics=this.parseBeatLyrics(i),this._skipApplyLyrics=!0;break;case"Slashed":t.slashed=!0;break;case"DeadSlapped":t.deadSlapped=!0;break;case"Golpe":switch(i.innerText){case"Finger":t.golpe=pe.Finger;break;case"Thumb":t.golpe=pe.Thumb}break;case"Wah":switch(i.innerText){case"Open":t.wahPedal=ge.Open;break;case"Closed":t.wahPedal=ge.Closed}break;case"UserTransposedPitchStemOrientation":switch(i.innerText){case"Downward":t.preferredBeamDirection=Pe.Down;break;case"Upward":t.preferredBeamDirection=Pe.Up}break;case"Timer":t.showTimer=!0,t.timer=vs.parseIntSafe(i.innerText,-1),t.timer<0&&(t.timer=null)}this._beatById.set(s,t)}parseBeatLyrics(e){const t=[];for(const s of e.childElements())if("Line"===s.localName)t.push(s.innerText);return t}parseBeatXProperties(e,t){for(const s of e.childElements())if("XProperty"===s.localName){let e=0;switch(s.getAttribute("id")){case"1124204546":switch(e=vs.parseIntSafe(s.findChildElement("Int")?.innerText,0),e){case 1:t.beamingMode=be.ForceMergeWithNext;break;case 2:t.beamingMode=be.ForceSplitToNext}break;case"1124204552":if(e=vs.parseIntSafe(s.findChildElement("Int")?.innerText,0),1===e)t.beamingMode!==be.ForceSplitToNext&&(t.beamingMode=be.ForceSplitOnSecondaryToNext);break;case"1124204545":e=vs.parseIntSafe(s.findChildElement("Int")?.innerText,0),t.invertBeamDirection=1===e;break;case"687935489":e=vs.parseIntSafe(s.findChildElement("Int")?.innerText,0),t.brushDuration=e}}}parseBarXProperties(e,t){for(const s of e.childElements())if("XProperty"===s.localName){if("1124139520"===s.getAttribute("id")){const e=s.findChildElement("Double")??s.findChildElement("Float");t.displayScale=vs.parseFloatSafe(e?.innerText,1)}}}parseMasterBarXProperties(e,t){for(const s of t.childElements())if("XProperty"===s.localName){if("1124073984"===s.getAttribute("id"))e.displayScale=vs.parseFloatSafe(s.findChildElement("Double")?.innerText,1)}}parseBeatProperties(e,t){let s=!1,i=null,a=null,r=null,n=null,o=null;for(const h of e.childElements())if("Property"===h.localName){switch(h.getAttribute("name")){case"Brush":"Up"===h.findChildElement("Direction")?.innerText?t.brushType=w.BrushUp:t.brushType=w.BrushDown;break;case"PickStroke":"Up"===h.findChildElement("Direction")?.innerText?t.pickStroke=he.Up:t.pickStroke=he.Down;break;case"Slapped":h.findChildElement("Enable")&&(t.slap=!0);break;case"Popped":h.findChildElement("Enable")&&(t.pop=!0);break;case"VibratoWTremBar":switch(h.findChildElement("Strength")?.innerText){case"Wide":t.vibrato=M.Wide;break;case"Slight":t.vibrato=M.Slight}break;case"WhammyBar":s=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":i||(i=new j(0,0)),i.value=this.toBendValue(vs.parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarOriginOffset":i||(i=new j(0,0)),i.offset=this.toBendOffset(vs.parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleValue":a=this.toBendValue(vs.parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset1":r=this.toBendOffset(vs.parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarMiddleOffset2":n=this.toBendOffset(vs.parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationValue":o||(o=new j(j.MaxPosition,0)),o.value=this.toBendValue(vs.parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"WhammyBarDestinationOffset":o||(o=new j(0,0)),o.offset=this.toBendOffset(vs.parseFloatSafe(h.findChildElement("Float")?.innerText,0));break;case"BarreFret":t.barreFret=vs.parseIntSafe(h.findChildElement("Fret")?.innerText,0);break;case"BarreString":switch(h.findChildElement("String")?.innerText){case"0":t.barreShape=fe.Full;break;case"1":t.barreShape=fe.Half}break;case"Rasgueado":switch(h.findChildElement("Rasgueado")?.innerText){case"ii_1":t.rasgueado=ye.Ii;break;case"mi_1":t.rasgueado=ye.Mi;break;case"mii_1":t.rasgueado=ye.MiiTriplet;break;case"mii_2":t.rasgueado=ye.MiiAnapaest;break;case"pmp_1":t.rasgueado=ye.PmpTriplet;break;case"pmp_2":t.rasgueado=ye.PmpAnapaest;break;case"pei_1":t.rasgueado=ye.PeiTriplet;break;case"pei_2":t.rasgueado=ye.PeiAnapaest;break;case"pai_1":t.rasgueado=ye.PaiTriplet;break;case"pai_2":t.rasgueado=ye.PaiAnapaest;break;case"ami_1":t.rasgueado=ye.AmiTriplet;break;case"ami_2":t.rasgueado=ye.AmiAnapaest;break;case"ppp_1":t.rasgueado=ye.Ppp;break;case"amii_1":t.rasgueado=ye.Amii;break;case"amip_1":t.rasgueado=ye.Amip;break;case"eami_1":t.rasgueado=ye.Eami;break;case"eamii_1":t.rasgueado=ye.Eamii;break;case"peami_1":t.rasgueado=ye.Peami}}}s&&(i||(i=new j(0,0)),o||(o=new j(j.MaxPosition,0)),t.addWhammyBarPoint(i),r&&a&&t.addWhammyBarPoint(new j(r,a)),n&&a&&t.addWhammyBarPoint(new j(n,a)),r||n||!a||t.addWhammyBarPoint(new j(j.MaxPosition/2|0,a)),t.addWhammyBarPoint(o))}parseNotes(e){for(const t of e.childElements())if("Note"===t.localName)this.parseNote(t)}parseNote(e){const t=new Oe,s=e.getAttribute("id");for(const i of e.childElements())switch(i.localName){case"Properties":this.parseNoteProperties(i,t,s);break;case"AntiAccent":"normal"===i.innerText.toLowerCase()&&(t.isGhost=!0);break;case"LetRing":t.isLetRing=!0;break;case"Trill":t.trillValue=vs.parseIntSafe(i.innerText,-1),t.trillSpeed=k.Sixteenth;break;case"Accent":const e=vs.parseIntSafe(i.innerText,0);1&e&&(t.isStaccato=!0),4&e&&(t.accentuated=_.Heavy),8&e&&(t.accentuated=_.Normal),16&e&&(t.accentuated=_.Tenuto);break;case"Tie":"true"===i.getAttribute("destination").toLowerCase()&&(t.isTieDestination=!0);break;case"Vibrato":switch(i.innerText){case"Slight":t.vibrato=M.Slight;break;case"Wide":t.vibrato=M.Wide}break;case"LeftFingering":switch(i.innerText){case"P":t.leftHandFinger=x.Thumb;break;case"I":t.leftHandFinger=x.IndexFinger;break;case"M":t.leftHandFinger=x.MiddleFinger;break;case"A":t.leftHandFinger=x.AnnularFinger;break;case"C":t.leftHandFinger=x.LittleFinger}break;case"RightFingering":switch(i.innerText){case"P":t.rightHandFinger=x.Thumb;break;case"I":t.rightHandFinger=x.IndexFinger;break;case"M":t.rightHandFinger=x.MiddleFinger;break;case"A":t.rightHandFinger=x.AnnularFinger;break;case"C":t.rightHandFinger=x.LittleFinger}break;case"InstrumentArticulation":t.percussionArticulation=vs.parseIntSafe(i.innerText,0);break;case"Ornament":switch(i.innerText){case"Turn":t.ornament=ce.Turn;break;case"InvertedTurn":t.ornament=ce.InvertedTurn;break;case"UpperMordent":t.ornament=ce.UpperMordent;break;case"LowerMordent":t.ornament=ce.LowerMordent}}this._noteById.set(s,t)}parseNoteProperties(e,t,s){let i=!1,a=null,r=null,n=null,o=null,h=null,l=-1,c=-1,d=!1;for(const u of e.childElements())if("Property"===u.localName){switch(u.getAttribute("name")){case"ShowStringNumber":u.findChildElement("Enable")&&(t.showStringNumber=!0);break;case"String":t.string=vs.parseIntSafe(u.findChildElement("String")?.innerText,0)+1;break;case"Fret":t.fret=vs.parseIntSafe(u.findChildElement("Fret")?.innerText,0);break;case"Element":l=vs.parseIntSafe(u.findChildElement("Element")?.innerText,0);break;case"Variation":c=vs.parseIntSafe(u.findChildElement("Variation")?.innerText,0);break;case"Tapped":this._tappedNotes.set(s,!0);break;case"HarmonicType":const e=u.findChildElement("HType");if(e)switch(e.innerText){case"NoHarmonic":t.harmonicType=N.None;break;case"Natural":t.harmonicType=N.Natural;break;case"Artificial":t.harmonicType=N.Artificial;break;case"Pinch":t.harmonicType=N.Pinch;break;case"Tap":t.harmonicType=N.Tap;break;case"Semi":t.harmonicType=N.Semi;break;case"Feedback":t.harmonicType=N.Feedback}break;case"HarmonicFret":const p=u.findChildElement("HFret");p&&(t.harmonicValue=vs.parseFloatSafe(p.innerText,0));break;case"Muted":u.findChildElement("Enable")&&(t.isDead=!0);break;case"PalmMuted":u.findChildElement("Enable")&&(t.isPalmMute=!0);break;case"Octave":t.octave=vs.parseIntSafe(u.findChildElement("Number")?.innerText,0),-1===t.tone&&(t.tone=0);break;case"Tone":t.tone=vs.parseIntSafe(u.findChildElement("Step")?.innerText,0);break;case"ConcertPitch":d||this.parseConcertPitch(u,t);break;case"TransposedPitch":t.accidentalMode=P.Default,this.parseConcertPitch(u,t),d=!0;break;case"Bended":i=!0;break;case"BendOriginValue":a||(a=new j(0,0)),a.value=this.toBendValue(vs.parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"BendOriginOffset":a||(a=new j(0,0)),a.offset=this.toBendOffset(vs.parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"BendMiddleValue":r=this.toBendValue(vs.parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset1":n=this.toBendOffset(vs.parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"BendMiddleOffset2":o=this.toBendOffset(vs.parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"BendDestinationValue":h||(h=new j(j.MaxPosition,0)),h.value=this.toBendValue(vs.parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"BendDestinationOffset":h||(h=new j(0,0)),h.offset=this.toBendOffset(vs.parseFloatSafe(u.findChildElement("Float")?.innerText,0));break;case"HopoOrigin":u.findChildElement("Enable")&&(t.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":t.isLeftHandTapped=!0;break;case"Slide":const m=vs.parseIntSafe(u.findChildElement("Flags")?.innerText,0);1&m?t.slideOutType=E.Shift:2&m?t.slideOutType=E.Legato:4&m?t.slideOutType=E.OutDown:8&m&&(t.slideOutType=E.OutUp),16&m?t.slideInType=v.IntoFromBelow:32&m&&(t.slideInType=v.IntoFromAbove),64&m?t.slideOutType=E.PickSlideDown:128&m&&(t.slideOutType=E.PickSlideUp)}}i&&(a||(a=new j(0,0)),h||(h=new j(j.MaxPosition,0)),t.addBendPoint(a),n&&r&&t.addBendPoint(new j(n,r)),o&&r&&t.addBendPoint(new j(o,r)),n||o||!r||t.addBendPoint(new j(j.MaxPosition/2|0,r)),t.addBendPoint(h)),-1!==l&&-1!==c&&(t.percussionArticulation=Ie.articulationFromElementVariation(l,c))}parseConcertPitch(e,t){const s=e.findChildElement("Pitch");if(s)for(const e of s.childElements())if("Accidental"===e.localName)switch(e.innerText){case"x":t.accidentalMode=P.ForceDoubleSharp;break;case"#":t.accidentalMode=P.ForceSharp;break;case"b":t.accidentalMode=P.ForceFlat;break;case"bb":t.accidentalMode=P.ForceDoubleFlat}}toBendValue(e){return e*vs.BendPointValueFactor|0}toBendOffset(e){return e*vs.BendPointPositionFactor}parseRhythms(e){for(const t of e.childElements())if("Rhythm"===t.localName)this.parseRhythm(t)}parseRhythm(e){const t=new Ns,s=e.getAttribute("id");t.id=s;for(const s of e.childElements())switch(s.localName){case"NoteValue":switch(s.innerText){case"Long":t.value=k.QuadrupleWhole;break;case"DoubleWhole":t.value=k.DoubleWhole;break;case"Whole":t.value=k.Whole;break;case"Half":t.value=k.Half;break;case"Quarter":t.value=k.Quarter;break;case"Eighth":t.value=k.Eighth;break;case"16th":t.value=k.Sixteenth;break;case"32nd":t.value=k.ThirtySecond;break;case"64th":t.value=k.SixtyFourth;break;case"128th":t.value=k.OneHundredTwentyEighth;break;case"256th":t.value=k.TwoHundredFiftySixth}break;case"PrimaryTuplet":t.tupletNumerator=vs.parseIntSafe(s.getAttribute("num"),-1),t.tupletDenominator=vs.parseIntSafe(s.getAttribute("den"),-1);break;case"AugmentationDot":t.dots=vs.parseIntSafe(s.getAttribute("count"),0)}this._rhythmById.set(s,t)}buildModel(){for(let e=0,t=this._masterBars.length;e<t;e++){const t=this._masterBars[e];this.score.addMasterBar(t)}const e=this._masterBars[this._masterBars.length-1];this._doubleBars.has(e)&&(this._doubleBars.delete(e),e.isDoubleBar=!1);const t=[];for(const e of this._tracksMapping){if(!e)continue;const s=this._tracksById.get(e);this.score.addTrack(s),t.push(e)}let s;for(const e of this._barsOfMasterBar){let i=0,a=0;s=[d.C,u.Major],this._transposeKeySignaturePerTrack.has(t[0])&&(s=[De.transposeKey(s[0],this._transposeKeySignaturePerTrack.get(t[0])),s[1]]);for(let r=0;r<e.length&&a<this.score.tracks.length;r++){const n=e[r];if(n!==vs.InvalidId){const e=this._barsById.get(n),r=this.score.tracks[a],o=r.staves[i];o.addBar(e);const h=o.bars.length-1;if(this._keySignatures.has(h)&&(s=this._keySignatures.get(h),this._transposeKeySignaturePerTrack.has(t[a])&&(s=[De.transposeKey(s[0],this._transposeKeySignaturePerTrack.get(t[a])),s[1]])),e.keySignature=s[0],e.keySignatureType=s[1],this._doubleBars.has(e.masterBar)&&(e.barLineRight=g.LightLight),this._voicesOfBar.has(n))for(const t of this._voicesOfBar.get(n))if(t!==vs.InvalidId){const s=this._voiceById.get(t);if(e.addVoice(s),this._beatsOfVoice.has(t))for(const e of this._beatsOfVoice.get(t))if(e!==vs.InvalidId){const t=ze.clone(this._beatById.get(e));s.addBeat(t);const i=this._rhythmOfBeat.get(e),a=this._rhythmById.get(i);if(t.duration=a.value,t.dots=a.dots,t.tupletNumerator=a.tupletNumerator,t.tupletDenominator=a.tupletDenominator,this._notesOfBeat.has(e))for(const s of this._notesOfBeat.get(e))if(s!==vs.InvalidId){const e=Ge.clone(this._noteById.get(s));o.isPercussion?(e.fret=-1,e.string=-1):e.percussionArticulation=-1,t.addNote(e),this._tappedNotes.has(s)&&(t.tap=!0)}}}else{const t=new re;e.addVoice(t);const s=new Ye;s.isEmpty=!0,s.duration=k.Quarter,t.addBeat(s)}i===r.staves.length-1?(a++,i=0):i++,s=[d.C,u.Major],a<t.length&&this._transposeKeySignaturePerTrack.has(t[a])&&(s=[De.transposeKey(s[0],this._transposeKeySignaturePerTrack.get(t[a])),s[1]])}else a++}}for(const e of this._tracksMapping){if(!e)continue;const t=this._tracksById.get(e);let s=!1;for(const e of t.staves)if(e.isPercussion){s=!0;break}if(s||(t.percussionArticulations=[]),this._automationsPerTrackIdAndBarIndex.has(e)){const s=this._automationsPerTrackIdAndBarIndex.get(e);for(const[e,i]of s)if(t.staves.length>0&&e<t.staves[0].bars.length){const s=t.staves[0].bars[e];if(s.voices.length>0&&s.voices[0].beats.length>0){const e=s.voices[0].beats[0];for(const t of i){t.type===y.Bank&&0===t.value&&0===s.index||e.automations.push(t)}}}}if(this._sustainPedalsPerTrackIdAndBarIndex.has(e)){const s=this._sustainPedalsPerTrackIdAndBarIndex.get(e);for(const[e,i]of s)if(t.staves.length>0&&e<t.staves[0].bars.length){t.staves[0].bars[e].sustainPedals=i}}}for(const[e,t]of this._masterTrackAutomations){const s=this.score.masterBars[e];for(let i=0,a=t.length;i<a;i++){const a=t[i];switch(a.type){case y.Tempo:0===e&&(this.score.tempo=0|a.value,a.text&&(this.score.tempoLabel=a.text)),s.tempoAutomations.push(a);break;case y.SyncPoint:a.syncPointValue.millisecondOffset-=this._backingTrackPadding,s.addSyncPoint(a)}}}}}vs.InvalidId="-1",vs.BendPointPositionFactor=j.MaxPosition/100,vs.BendPointValueFactor=.04,vs.SampleRate=44100;class Es{constructor(){this.isMultiRest=!1,this.trackViewGroups=[]}}class Ms{constructor(){this.showNumbered=!1,this.showSlash=!1,this.showStandardNotation=!1,this.showTablature=!1}}class Fs{apply(e){if(this.scoreViews.length>0){let t=0;e.stylesheet.multiTrackMultiBarRest=this.scoreViews[0].isMultiRest;for(const s of this.scoreViews[0].trackViewGroups){if(t<e.tracks.length){const i=e.tracks[t];for(const e of i.staves)e.isPercussion||(e.showTablature=s.showTablature),e.showStandardNotation=s.showStandardNotation,e.showSlash=s.showSlash,e.showNumbered=s.showNumbered}t++}for(let s=1;s<this.scoreViews.length;s++)this.scoreViews[s].isMultiRest&&(e.stylesheet.perTrackMultiBarRest||(e.stylesheet.perTrackMultiBarRest=new Set),t=s-1,e.stylesheet.perTrackMultiBarRest.add(t))}}constructor(e){this.scoreViews=[];const t=ut.fromBuffer(e),s=dt.readInt32BE(t);for(let e=0;e<s;e++){const e=new Es;this.scoreViews.push(e),e.isMultiRest=Bs.gpReadBool(t);const s=dt.readInt32BE(t);for(let i=0;i<s;i++){let s=t.readByte();0===s&&(s=1);const i=new Ms;i.showStandardNotation=!!(1&s),i.showTablature=!!(2&s),i.showSlash=!!(4&s),i.showNumbered=!!(8&s),e.trackViewGroups.push(i)}}}static writeForScore(e){const t=ut.withCapacity(128),s=[new Es];s[0].isMultiRest=e.stylesheet.multiTrackMultiBarRest;for(const t of e.tracks){const i=new Ms;i.showStandardNotation=t.staves[0].showStandardNotation,i.showTablature=t.staves[0].showTablature,i.showSlash=t.staves[0].showSlash,i.showNumbered=t.staves[0].showNumbered,s[0].trackViewGroups.push(i);const a=new Es;a.isMultiRest=!0===e.stylesheet.perTrackMultiBarRest?.has(t.index),a.trackViewGroups.push(i),s.push(a)}dt.writeInt32BE(t,s.length);for(const e of s){t.writeByte(e.isMultiRest?1:0),dt.writeInt32BE(t,e.trackViewGroups.length);for(const s of e.trackViewGroups){let e=0;s.showStandardNotation&&(e|=1),s.showTablature&&(e|=2),s.showSlash&&(e|=4),s.showNumbered&&(e|=8),t.writeByte(e)}}return dt.writeInt32BE(t,1),t.toArray()}}class Cs{constructor(){this.trackViewGroups=[]}}class Ds{constructor(){this.isVisible=!1}}!function(e){e[e.PageVertical=0]="PageVertical",e[e.PageGrid=1]="PageGrid",e[e.PageParchment=2]="PageParchment",e[e.ScreenVertical=3]="ScreenVertical",e[e.ScreenHorizontal=4]="ScreenHorizontal",e[e.PageHorizontal=5]="PageHorizontal"}(Pt||(Pt={}));class Ls{constructor(e,t){this.zoomLevel=4,this.view=Pt.PageVertical,this.muiltiVoiceCursor=!1,this.scoreViews=[];const s=ut.fromBuffer(t);this.zoomLevel=dt.readInt32BE(s),this.view=s.readByte(),this.muiltiVoiceCursor=0!==s.readByte();const i=e.scoreViews.length;for(let t=0;t<i;t++){const i=new Cs;this.scoreViews.push(i);const a=e.scoreViews[t];for(let e=0;e<a.trackViewGroups.length;e++){const e=new Ds;e.isVisible=0!==s.readByte(),i.trackViewGroups.push(e)}}}apply(e){if(this.scoreViews.length>0){let t=0;for(const s of this.scoreViews[0].trackViewGroups){if(t<e.tracks.length){e.tracks[t].isVisibleOnMultiTrack=s.isVisible}t++}}}static writeForScore(e){const t=ut.withCapacity(128);dt.writeInt32BE(t,4),t.writeByte(0);const s=e.tracks.length>0&&e.tracks[0].staves[0].bars[0].isMultiVoice;t.writeByte(s?255:0);for(const s of e.tracks)t.writeByte(s.isVisibleOnMultiTrack?255:0);for(const s of e.tracks)t.writeByte(255);return t.toArray()}}class Is extends Qe{get name(){return"Guitar Pro 7-8"}readScore(){ee.debug(this.name,"Loading ZIP entries");const e=new Zt(this.data);let t;try{t=e.read()}catch(e){throw new Ze("No Zip archive",e)}ee.debug(this.name,"Zip entries loaded");let s=null,i=null,a=null,r=null;const n=new Map;for(const e of t)switch(n.set(e.fullName,e),e.fileName){case"score.gpif":s=dt.toString(e.data,this.settings.importer.encoding);break;case"BinaryStylesheet":i=e.data;break;case"PartConfiguration":a=e.data;break;case"LayoutConfiguration":r=e.data}if(!s)throw new Ze("No score.gpif found in zip archive");ee.debug(this.name,"Start Parsing score.gpif");const o=new vs;o.loadAsset=e=>{if(n.has(e))return n.get(e).data},o.parseXml(s,this.settings),ee.debug(this.name,"score.gpif parsed");const h=o.score;if(i){ee.debug(this.name,"Start Parsing BinaryStylesheet");new _s(i).apply(h),ee.debug(this.name,"BinaryStylesheet parsed")}let l=null;if(a&&(ee.debug(this.name,"Start Parsing Part Configuration"),l=new Fs(a),l.apply(h),ee.debug(this.name,"Part Configuration parsed")),r&&null!=l){ee.debug(this.name,"Start Parsing Layout Configuration");new Ls(l,r).apply(h),ee.debug(this.name,"Layout Configuration parsed")}return h}}class As extends O{constructor(){super(e.AlphaTabErrorType.Format,"Unexpected end of data within reader"),Object.setPrototypeOf(this,As.prototype)}}class Rs{constructor(e){this._currentByte=0,this._position=Rs.ByteSize,this._source=e}readByte(){return this.readBits(8)}readBytes(e){const t=new Uint8Array(e);for(let s=0;s<e;s++)t[s]=255&this.readByte();return t}readBits(e){let t=0,s=e-1;for(;s>=0;)t|=this.readBit()<<s,s--;return t}readBitsReversed(e){let t=0;for(let s=0;s<e;s++)t|=this.readBit()<<s;return t}readBit(){if(this._position>=8){if(this._currentByte=this._source.readByte(),-1===this._currentByte)throw new As;this._position=0}const e=this._currentByte>>Rs.ByteSize-this._position-1&1;return this._position++,e}readAll(){const e=ut.empty();try{for(;;)e.writeByte(255&this.readByte())}catch(e){if(!(e instanceof As))throw e}return e.toArray()}}Rs.ByteSize=8;class Os{constructor(){this.fileName="",this.fileSize=0,this.data=null}}class Ws{constructor(){this.files=[],this.files=[],this.fileFilter=e=>!0}load(e){const t=new Rs(e);this.readBlock(t)}readHeader(e){return this.getString(e.readBytes(4),0,4)}decompress(e,t=!1){const s=ut.empty();let i;const a=this.getInteger(e.readBytes(4),0);try{for(;s.length<a;){if(1===e.readBits(1)){const t=e.readBits(4),a=e.readBitsReversed(t),r=e.readBitsReversed(t),n=s.length-a,o=Math.min(a,r);i=s.getBuffer(),s.write(i,n,o)}else{const t=e.readBitsReversed(2);for(let i=0;i<t;i++)s.writeByte(e.readByte())}}}catch(e){if(!(e instanceof As))throw e}i=s.getBuffer();const r=t?4:0,n=s.length-r,o=new Uint8Array(n),h=n;return o.set(i.subarray(r,r+h),0),o}readBlock(e){const t=this.readHeader(e);if("BCFZ"===t)this.readUncompressedBlock(this.decompress(e,!0));else{if("BCFS"!==t)throw new Ze("Unsupported format");this.readUncompressedBlock(e.readAll())}}readUncompressedBlock(e){const t=4096;let s=t;for(;s+3<e.length;){if(2===this.getInteger(e,s)){const i=new Os;i.fileName=this.getString(e,s+4,127),i.fileSize=this.getInteger(e,s+140);const a=!this.fileFilter||this.fileFilter(i.fileName);a&&this.files.push(i);const r=s+148;let n=0,o=0;const h=a?ut.withCapacity(i.fileSize):null;for(;n=this.getInteger(e,r+4*o++),0!==n;)s=n*t,a&&h.write(e,s,t);if(a){i.data=new Uint8Array(Math.min(i.fileSize,h.length));const e=h.toArray();i.data.set(e.subarray(0,0+i.data.length),0)}}s+=t}}getString(e,t,s){let i="";for(let a=0;a<s;a++){const s=255&e[t+a];if(0===s)break;i+=String.fromCharCode(s)}return i}getInteger(e,t){return e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]}}Ws.HeaderBcFs="BCFS",Ws.HeaderBcFz="BCFZ";class Hs extends Qe{get name(){return"Guitar Pro 6"}readScore(){ee.debug(this.name,"Loading GPX filesystem");const e=new Ws;e.fileFilter=e=>e.endsWith("score.gpif")||e.endsWith("BinaryStylesheet")||e.endsWith("PartConfiguration")||e.endsWith("LayoutConfiguration"),e.load(this.data),ee.debug(this.name,"GPX filesystem loaded");let t=null,s=null,i=null,a=null;for(const r of e.files)switch(r.fileName){case"score.gpif":t=dt.toString(r.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=r.data;break;case"PartConfiguration":i=r.data;break;case"LayoutConfiguration":a=r.data}if(!t)throw new Ze("No score.gpif found in GPX");ee.debug(this.name,"Start Parsing score.gpif");const r=new vs;r.parseXml(t,this.settings),ee.debug(this.name,"score.gpif parsed");const n=r.score;if(s){ee.debug(this.name,"Start Parsing BinaryStylesheet");new _s(s).apply(n),ee.debug(this.name,"BinaryStylesheet parsed")}let o=null;if(i&&(ee.debug(this.name,"Start Parsing Part Configuration"),o=new Fs(i),o.apply(n),ee.debug(this.name,"Part Configuration parsed")),a&&null!=o){ee.debug(this.name,"Start Parsing Layout Configuration");new Ls(o,a).apply(n),ee.debug(this.name,"Layout Configuration parsed")}return n}}class Gs{constructor(){this.maxLine=-1e3,this.maxLineNote=null,this.minLine=-1e3,this.minLineNote=null}}class Vs{constructor(e){this._registeredAccidentals=new Map,this._appliedScoreLines=new Map,this._appliedScoreLinesByValue=new Map,this._notesByValue=new Map,this._beatLines=new Map,this.maxLineBeat=null,this.minLineBeat=null,this.maxLine=-1e3,this.minLine=-1e3,this._barRenderer=e,this._bar=e.bar}static getPercussionLine(e,t){return t<e.staff.track.percussionArticulations.length?e.staff.track.percussionArticulations[t].staffLine:Ie.getArticulationByInputMidiNumber(t)?.staffLine??0}static getNoteValue(e){if(e.isPercussion)return e.percussionArticulation;let t=e.displayValue;switch(e.accidentalMode){case P.ForceDoubleFlat:t+=2;break;case P.ForceDoubleSharp:t-=2;break;case P.ForceFlat:t+=1;break;case P.ForceSharp:t-=1}return t}applyAccidental(e){const t=Vs.getNoteValue(e),s=e.hasQuarterToneOffset;return this.getAccidental(t,s,e.beat,!1,e)}applyAccidentalForValue(e,t,s,i){return this.getAccidental(t,s,e,i,null)}static computeLineWithoutAccidentals(e,t){let s=0;const i=Vs.getNoteValue(t);return s=t.isPercussion?Vs.getPercussionLine(e,i):Vs.calculateNoteSteps(e.keySignature,e.clef,i),s}getAccidental(e,t,s,i,a=null){let r=0,n=oe.None;if(null!=a?a.isPercussion:this._bar.staff.isPercussion)r=Vs.getPercussionLine(this._bar,e);else{const s=a?a.accidentalMode:P.Default;r=Vs.calculateNoteSteps(this._bar.keySignature,this._bar.clef,e);const i=this._registeredAccidentals.has(r)?this._registeredAccidentals.get(r):null;n=De.computeAccidental(this._bar.keySignature,s,e,t,i);let o=!1;switch(n){case oe.NaturalQuarterNoteUp:case oe.SharpQuarterNoteUp:case oe.FlatQuarterNoteUp:break;default:if(a&&a.isTieDestination&&0===a.beat.index){const e=this._barRenderer.scoreRenderer.layout?.getRendererForBar(this._barRenderer.staff.staffId,a.tieOrigin.beat.voice.bar);if(e&&e.staff===this._barRenderer.staff){e.accidentalHelper.getNoteLine(a.tieOrigin)===r&&(o=!0)}}o?n=oe.None:n!==oe.None&&this._registeredAccidentals.set(r,n)}}return a?(this._appliedScoreLines.set(a.id,r),this._notesByValue.set(e,a)):this._appliedScoreLinesByValue.set(e,r),(-1e3===this.minLine||this.minLine<r)&&(this.minLine=r,this.minLineBeat=s),(-1e3===this.maxLine||this.maxLine>r)&&(this.maxLine=r,this.maxLineBeat=s),i||this.registerLine(s,r,a),n}registerLine(e,t,s){let i;this._beatLines.has(e.id)?i=this._beatLines.get(e.id):(i=new Gs,this._beatLines.set(e.id,i)),(-1e3===i.minLine||t<i.minLine)&&(i.minLine=t,i.minLineNote=s),(-1e3===i.minLine||t>i.maxLine)&&(i.maxLine=t,i.maxLineNote=s)}getMaxLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).maxLine:0}getMaxLineNote(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).maxLineNote:null}getMinLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).minLine:0}getMinLineNote(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).minLineNote:null}static calculateNoteSteps(e,t,s){const i=e,a=t,r=s%12,n=(s/12|0)-1;let o=Vs.OctaveSteps[a];o-=n*Vs.StepsPerOctave;return o-=(De.keySignatureIsSharp(i)||De.keySignatureIsNatural(i)?Vs.SharpNoteSteps:Vs.FlatNoteSteps)[r],o}getNoteLine(e){return this._appliedScoreLines.get(e.id)}getNoteLineForValue(e,t=!1){return this._appliedScoreLinesByValue.has(e)?this._appliedScoreLinesByValue.get(e):t&&this._notesByValue.has(e)?this.getNoteLine(this._notesByValue.get(e)):0}}Vs.StepsPerOctave=7,Vs.OctaveSteps=[38,32,30,26,38],Vs.SharpNoteSteps=[0,0,1,1,2,3,3,4,4,5,5,6],Vs.FlatNoteSteps=[0,1,1,2,2,3,4,4,5,5,6,6];class Us{constructor(){this.currentDynamics=f.F,this.slideOrigins=new Map,this.transpose=0,this.isExplicitlyBeamed=!1,this.tieStarts=new Set,this.tieStartIds=new Map,this.slideOrigins=new Map,this.slurStarts=new Map}}class zs extends Le{constructor(){super(...arguments),this.outputMidiChannel=-1,this.outputMidiProgram=-1,this.outputMidiBank=-1,this.outputVolume=-1,this.outputBalance=-1}}class Xs{constructor(e){this.instruments=new Map,this._instrumentIdToArticulationIndex=new Map,this._lyricsLine=0,this._lyricsLines=new Map,this.track=e}getLyricLine(e){if(this._lyricsLines.has(e))return this._lyricsLines.get(e);const t=this._lyricsLine;return this._lyricsLines.set(e,t),this._lyricsLine++,t}getOrCreateArticulation(e,t){const s=12*t.octave+t.tone,i=`${e}_${s}`;if(this._instrumentIdToArticulationIndex.has(i))return this._instrumentIdToArticulationIndex.get(i);let a;a=this.instruments.has(e)?this.instruments.get(e):Xs.defaultNoteArticulation;const r=this.track.percussionArticulations.length,n=t.beat.voice.bar;let o;o=0===s?4:Vs.calculateNoteSteps(n.keySignature,n.clef,s);const h=o-(9-(2*t.beat.voice.bar.staff.standardNotationLineCount-1)),l=new Le(a.elementType,h,a.outputMidiNumber,a.noteHeadDefault,a.noteHeadHalf,a.noteHeadWhole,a.techniqueSymbol,a.techniqueSymbolPlacement);return this._instrumentIdToArticulationIndex.set(i,r),this.track.percussionArticulations.push(l),r}}Xs.defaultNoteArticulation=new Le("Default",0,0,ne.NoteheadBlack,ne.NoteheadHalf,ne.NoteheadWhole);class Ys extends Qe{constructor(){super(...arguments),this._idToTrackInfo=new Map,this._indexToTrackInfo=new Map,this._staffToContext=new Map,this._divisionsPerQuarterNote=1,this._currentDynamics=f.F,this._musicalPosition=0,this._lastBeat=null,this._nextMasterBarRepeatEnding=0,this._nextBeatAutomations=null,this._nextBeatChord=null,this._nextBeatCrescendo=null,this._nextBeatLetRing=!1,this._nextBeatPalmMute=!1,this._nextBeatOttavia=null,this._nextBeatText=null,this._simileMarkAllStaves=null,this._simileMarkPerStaff=null,this._isBeatSlash=!1,this._keyAllStaves=null,this._currentTrillStep=-1}get name(){return"MusicXML"}readScore(){const e=this.extractMusicXml(),t=new as;try{t.parse(e)}catch(e){throw new Ze("Unsupported format",e)}return this._score=new Ke,this._score.tempo=120,this._score.stylesheet.hideDynamics=!0,this.parseDom(t),De.consolidate(this._score),this._score.finish(this.settings),this._score.rebuildRepeatGroups(),this._score}extractMusicXml(){const e=new Zt(this.data);let t;try{t=e.read()}catch{t=[]}if(0===t.length)return this.data.reset(),dt.toString(this.data.readAll(),this.settings.importer.encoding);const s=t.find(e=>"META-INF/container.xml"===e.fullName);if(!s)throw new Ze("No compressed MusicXML");const i=new as;try{i.parse(dt.toString(s.data,this.settings.importer.encoding))}catch(e){throw new Ze("Malformed container.xml, could not parse as XML",e)}const a=i.firstElement;if(!a||"container"!==a.localName)throw new Ze("Malformed container.xml, root element not 'container'");const r=a.findChildElement("rootfiles");if(!r)throw new Ze("Malformed container.xml, 'container/rootfiles' not found");let n="";for(const e of r.childElements())if("rootfile"===e.localName){n=e.getAttribute("full-path");break}if(!n)throw new Ze("Unsupported compressed MusicXML, missing rootfile");const o=t.find(e=>e.fullName===n);if(!o)throw new Ze(`Malformed container.xml, '${n}' not contained in zip`);return dt.toString(o.data,this.settings.importer.encoding)}parseDom(e){const t=e.firstElement;if(!t)throw new Ze("Unsupported format");switch(t.localName){case"score-partwise":this.parsePartwise(t);break;case"score-timewise":this.parseTimewise(t);break;default:throw new Ze("Unsupported format")}}parsePartwise(e){for(const t of e.childElements())switch(t.localName){case"credit":this.parseCredit(t);break;case"identification":this.parseIdentification(t);break;case"movement-title":this.parseMovementTitle(t);break;case"part":this.parsePartwisePart(t);break;case"part-list":this.parsePartList(t);break;case"work":this.parseWork(t)}}parseTimewise(e){let t=0;for(const s of e.childElements())switch(s.localName){case"credit":this.parseCredit(s);break;case"identification":this.parseIdentification(s);break;case"movement-title":this.parseMovementTitle(s);break;case"part-list":this.parsePartList(s);break;case"work":this.parseWork(s);break;case"measure":this.parseTimewiseMeasure(s,t),t++}}parseCredit(e){if("1"!==e.getAttribute("page","1"))return;const t=[];let s=null,i="";for(const a of e.childElements())switch(a.localName){case"credit-type":t.push(a.innerText);break;case"credit-words":null===s&&(s=a),i+=a.innerText}if(t.length>0)for(const e of t)switch(e){case"title":this._score.title=Ys.sanitizeDisplay(i);break;case"subtitle":this._score.subTitle=Ys.sanitizeDisplay(i);break;case"composer":case"arranger":this._score.artist=Ys.sanitizeDisplay(i);break;case"lyricist":this._score.words=Ys.sanitizeDisplay(i);break;case"rights":this._score.copyright=Ys.sanitizeDisplay(i)}else if(s){const e=s.getAttribute("font-size","0"),t=s.getAttribute("font-size","top"),a=s.getAttribute("halign","left");if("top"===t){if(i.includes("copyright")||i.includes("Copyright")||i.includes("©")||i.includes("(c)")||i.includes("(C)"))return void(this._score.copyright=Ys.sanitizeDisplay(i));if("center"===a||"center"===e){if(0===this._score.title.length)return void(this._score.title=Ys.sanitizeDisplay(i));if(0===this._score.subTitle.length)return void(this._score.subTitle=Ys.sanitizeDisplay(i));if(0===this._score.album.length)return void(this._score.album=Ys.sanitizeDisplay(i))}else if(("right"===a||"right"===e)&&0===this._score.music.length)return void(this._score.music=Ys.sanitizeDisplay(i));if(0===this._score.artist.length)return void(this._score.artist=Ys.sanitizeDisplay(i));if(0===this._score.words.length)return void(this._score.words=Ys.sanitizeDisplay(i))}}}static sanitizeDisplay(e){return e.replaceAll("\r","").replaceAll("\n"," ").replaceAll("\t","  ").replaceAll(" "," ")}parseIdentification(e){for(const t of e.childElements())switch(t.localName){case"creator":if(t.attributes.has("type"))switch(t.attributes.get("type")){case"composer":this._score.artist=Ys.sanitizeDisplay(t.innerText);break;case"lyricist":this._score.words=Ys.sanitizeDisplay(t.innerText);break;case"arranger":this._score.music=Ys.sanitizeDisplay(t.innerText)}else this._score.artist=Ys.sanitizeDisplay(t.innerText);break;case"rights":this._score.copyright.length>0&&(this._score.copyright+=", "),this._score.copyright+=t.innerText,t.attributes.has("type")&&(this._score.copyright+=` (${t.attributes.get("type")})`);break;case"encoding":this.parseEncoding(t)}}parseEncoding(e){for(const t of e.childElements())switch(t.localName){case"encoder":this._score.tab.length>0&&(this._score.tab+=", "),this._score.tab+=t.innerText,t.attributes.has("type")&&(this._score.tab+=` (${t.attributes.get("type")})`);break;case"encoding-description":this._score.notices+=Ys.sanitizeDisplay(t.innerText)}}parseMovementTitle(e){0===this._score.title.length?this._score.title=Ys.sanitizeDisplay(e.innerText):this._score.subTitle=Ys.sanitizeDisplay(e.innerText)}parsePartList(e){for(const t of e.childElements())if("score-part"===t.localName)this.parseScorePart(t)}parseScorePart(e){const t=new lt;t.ensureStaveCount(1),this._score.addTrack(t);const s=e.attributes.get("id"),i=new Xs(t);this._idToTrackInfo.set(s,i),this._indexToTrackInfo.set(t.index,i);for(const s of e.childElements())switch(s.localName){case"part-name":t.name=Ys.sanitizeDisplay(s.innerText);break;case"part-name-display":t.name=this.parsePartDisplayAsText(s);break;case"part-abbreviation":t.shortName=Ys.sanitizeDisplay(s.innerText);break;case"part-abbreviation-display":t.shortName=this.parsePartDisplayAsText(s);break;case"score-instrument":this.parseScoreInstrument(s,i);break;case"midi-device":s.attributes.has("port")&&(t.playbackInfo.port=Number.parseInt(s.attributes.get("port"),10));break;case"midi-instrument":this.parseScorePartMidiInstrument(s,i)}i.firstArticulation&&(i.firstArticulation.outputMidiProgram>=0&&(t.playbackInfo.program=i.firstArticulation.outputMidiProgram),i.firstArticulation.outputMidiBank>=0&&(t.playbackInfo.bank=i.firstArticulation.outputMidiBank),i.firstArticulation.outputBalance>=0&&(t.playbackInfo.balance=i.firstArticulation.outputBalance),i.firstArticulation.outputVolume>=0&&(t.playbackInfo.volume=i.firstArticulation.outputVolume),i.firstArticulation.outputMidiChannel>=0&&(t.playbackInfo.primaryChannel=i.firstArticulation.outputMidiChannel,t.playbackInfo.secondaryChannel=i.firstArticulation.outputMidiChannel))}parseScoreInstrument(e,t){const s=new zs;t.firstArticulation||(t.firstArticulation=s),t.instruments.set(e.getAttribute("id",""),s)}parseScorePartMidiInstrument(e,t){const s=e.getAttribute("id","");if(!t.instruments.has(s))return;const i=t.instruments.get(s);for(const t of e.childElements())switch(t.localName){case"midi-channel":i.outputMidiChannel=Number.parseInt(t.innerText,10)-1;break;case"midi-bank":i.outputMidiBank=Number.parseInt(t.innerText,10)-1;break;case"midi-program":i.outputMidiProgram=Number.parseInt(t.innerText,10)-1;break;case"midi-unpitched":i.outputMidiNumber=Number.parseInt(t.innerText,10)-1;break;case"volume":i.outputVolume=Ys.interpolatePercent(Number.parseFloat(t.innerText));break;case"pan":i.outputBalance=Ys.interpolatePan(Number.parseFloat(t.innerText))}}static interpolatePercent(e){return 0|Ys.interpolate(0,100,0,16,e)}static interpolatePan(e){return 0|Ys.interpolate(-90,90,0,16,e)}static interpolate(e,t,s,i,a){return s+(i-s)*((a-e)/(t-e))}parsePartDisplayAsText(e){let t="";for(const s of e.childElements())switch(s.localName){case"display-text":t+=s.innerText;break;case"accidental-text":switch(s.innerText){case"sharp":t+="♯";break;case"natural":t+="♮";break;case"flat":t+="♭";break;case"double-sharp":t+="𝄪";break;case"sharp-sharp":t+="♯♯";break;case"flat-flat":t+="𝄫";break;case"natural-sharp":t+="♮♯";break;case"natural-flat":t+="♮♭";break;case"sharp-down":t+="𝄱";break;case"sharp-up":t+="𝄰";break;case"natural-down":t+="𝄯";break;case"natural-up":t+="𝄮";break;case"flat-down":t+="𝄭";break;case"flat-up":t+="𝄬";break;case"arrow-down":t+="↓";break;case"arrow-up":t+="↑";break;case"triple-sharp":t+="♯𝄪";break;case"triple-flat":t+="𝄬𝄬𝄬";break;case"sharp-1":t+="♯¹";break;case"sharp-2":t+="♯²";break;case"sharp-3":t+="♯³";break;case"sharp-4":t+="♯⁴";break;case"sharp-5":t+="♯⁵";break;case"flat-1":t+="♭¹";break;case"flat-2":t+="♭²";break;case"flat-3":t+="♭³";break;case"flat-4":t+="♭⁴";break;case"flat-5":t+="♭⁵"}}return Ys.sanitizeDisplay(t)}parseWork(e){for(const t of e.childElements())if("work-title"===t.localName)this._score.title=Ys.sanitizeDisplay(t.innerText)}parsePartwisePart(e){const t=e.attributes.get("id");if(!t||!this._idToTrackInfo.has(t))return;const s=this._idToTrackInfo.get(t).track;let i=0;for(const t of e.childElements())if("measure"===t.localName)this.parsePartwiseMeasure(t,s,i),i++}parsePartwiseMeasure(e,t,s){const i=this.getOrCreateMasterBar(e,s);this.parsePartMeasure(e,i,t)}parseTimewiseMeasure(e,t){const s=this.getOrCreateMasterBar(e,t);for(const t of e.childElements())if("part"===t.localName)this.parseTimewisePart(t,s)}getOrCreateMasterBar(e,t){const s="yes"===e.attributes.get("implicit");for(;this._score.masterBars.length<=t;){const e=new te;s&&(e.isAnacrusis=!0),this._score.addMasterBar(e),e.index>0&&(e.timeSignatureDenominator=e.previousMasterBar.timeSignatureDenominator,e.timeSignatureNumerator=e.previousMasterBar.timeSignatureNumerator,e.tripletFeel=e.previousMasterBar.tripletFeel)}return this._score.masterBars[t]}parseTimewisePart(e,t){const s=e.attributes.get("id");if(!s||!this._idToTrackInfo.has(s))return;const i=this._idToTrackInfo.get(s).track;this.parsePartMeasure(e,t,i)}parsePartMeasure(e,t,s){this._musicalPosition=0,this._lastBeat=null,t.alternateEndings=this._nextMasterBarRepeatEnding;const i=[];for(const a of e.childElements())switch(a.localName){case"note":this.parseNote(a,t,s);break;case"backup":this.parseBackup(a);break;case"forward":this.parseForward(a);break;case"direction":this.parseDirection(a,t,s);break;case"attributes":this.parseAttributes(a,t,s);break;case"harmony":this.parseHarmony(a,s);break;case"print":this.parsePrint(a,t,s);break;case"sound":this.parseSound(a,t,s);break;case"barline":i.push(a)}for(const e of i)this.parseBarLine(e,t,s);this.applySimileMarks(t,s);const a=this.getOrCreateStaff(s,0);this.getOrCreateBar(a,t),this._keyAllStaves=null}parsePrint(e,t,s){("yes"===e.getAttribute("new-system","no")||"yes"===e.getAttribute("new-page","no"))&&s.addLineBreaks(t.index)}applySimileMarks(e,t){if(null!==this._simileMarkAllStaves){for(const s of t.staves){const t=this.getOrCreateBar(s,e);t.simileMark=this._simileMarkAllStaves,t.simileMark!==c.None&&this.clearBar(t)}this._simileMarkAllStaves===c.FirstOfDouble?this._simileMarkAllStaves=c.SecondOfDouble:this._simileMarkAllStaves=null}if(null!==this._simileMarkPerStaff){const s=Array.from(this._simileMarkPerStaff.keys());for(const i of s){const s=this.getOrCreateStaff(t,i),a=this.getOrCreateBar(s,e);a.simileMark=this._simileMarkPerStaff.get(i),a.simileMark!==c.None&&this.clearBar(a),a.simileMark===c.FirstOfDouble?this._simileMarkPerStaff.set(i,c.SecondOfDouble):this._simileMarkPerStaff.delete(i)}0===this._simileMarkPerStaff.size&&(this._simileMarkPerStaff=null)}}clearBar(e){for(const t of e.voices){const e=new Ye;e.isEmpty=!0,t.addBeat(e)}}parseBarLine(e,t,s){for(const i of e.childElements())switch(i.localName){case"bar-style":this.parseBarStyle(i,t,s,e.getAttribute("location","right"));break;case"ending":this.parseEnding(i,t);break;case"repeat":this.parseRepeat(i,t)}}parseRepeat(e,t){const s=e.getAttribute("direction");let i=Number.parseInt(e.getAttribute("times"),10);(i<0||Number.isNaN(i))&&(i=2),"backward"===s?t.repeatCount=i:"forward"===s&&(t.isRepeatStart=!0)}parseEnding(e,t){const s=e.getAttribute("number").split(",").map(e=>Number.parseInt(e,10));let i=0;for(const e of s)i|=1<<e-1&255;switch(t.alternateEndings=i,e.getAttribute("type","")){case"start":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding|i;break;case"stop":case"discontinue":this._nextMasterBarRepeatEnding=this._nextMasterBarRepeatEnding&~i}}parseBarStyle(e,t,s,i){let a=g.Automatic;switch(e.innerText){case"dashed":a=g.Dashed;break;case"dotted":a=g.Dotted;break;case"heavy":a=g.Heavy;break;case"heavy-heavy":a=g.HeavyHeavy;break;case"heavy-light":a=g.HeavyLight;break;case"light-heavy":a=g.LightHeavy;break;case"light-light":a=g.LightLight;break;case"none":a=g.None;break;case"regular":a=g.Regular;break;case"short":a=g.Short;break;case"tick":a=g.Tick}for(const e of s.staves){const s=this.getOrCreateBar(e,t);switch(i){case"left":s.barLineLeft=a;break;case"right":s.barLineRight=a}}}parseSound(e,t,s){for(const s of e.childElements())switch(s.localName){case"midi-instrument":this.parseSoundMidiInstrument(s,t);break;case"swing":this.parseSwing(s,t)}if(e.attributes.has("coda")&&t.addDirection(xe.TargetCoda),e.attributes.has("tocoda")&&t.addDirection(xe.JumpDaCoda),e.attributes.has("dacapo")&&t.addDirection(xe.JumpDaCapo),e.attributes.has("dalsegno")&&t.addDirection(xe.JumpDalSegno),e.attributes.has("fine")&&t.addDirection(xe.TargetFine),e.attributes.has("segno")&&t.addDirection(xe.TargetSegno),e.attributes.has("pan")){this._nextBeatAutomations||(this._nextBeatAutomations=[]);const t=new q;t.type=y.Balance,t.value=Ys.interpolatePan(Number.parseFloat(e.attributes.get("pan"))),this._nextBeatAutomations.push(t)}if(e.attributes.has("tempo")){this._nextBeatAutomations||(this._nextBeatAutomations=[]);const t=new q;t.type=y.Tempo,t.value=Ys.interpolatePercent(Number.parseFloat(e.attributes.get("tempo"))),this._nextBeatAutomations.push(t)}}parseSwing(e,t){let s=0,i=0,a=null;for(const r of e.childElements())switch(r.localName){case"straight":return void(t.tripletFeel=A.NoTripletFeel);case"first":s=Number.parseInt(r.innerText,10);break;case"second":i=Number.parseInt(r.innerText,10);break;case"swing-type":a=this.parseBeatDuration(r)}a||(a=k.Eighth),a===k.Eighth?2===s&&1===i?t.tripletFeel=A.Triplet8th:3===s&&1===i?t.tripletFeel=A.Dotted8th:1===s&&3===i&&(t.tripletFeel=A.Scottish8th):a===k.Sixteenth&&(2===s&&1===i?t.tripletFeel=A.Triplet16th:3===s&&1===i?t.tripletFeel=A.Dotted16th:1===s&&3===i&&(t.tripletFeel=A.Scottish16th))}parseSoundMidiInstrument(e,t){let s;for(const t of e.childElements())switch(t.localName){case"midi-bank":this._nextBeatAutomations||(this._nextBeatAutomations=[]),s=new q,s.type=y.Bank,s.value=Number.parseInt(t.innerText,10)-1,this._nextBeatAutomations.push(s);break;case"midi-program":this._nextBeatAutomations||(this._nextBeatAutomations=[]),s=new q,s.type=y.Instrument,s.value=Number.parseInt(t.innerText,10)-1,this._nextBeatAutomations.push(s);break;case"volume":this._nextBeatAutomations||(this._nextBeatAutomations=[]),s=new q,s.type=y.Volume,s.value=Ys.interpolatePercent(Number.parseFloat(t.innerText)),this._nextBeatAutomations.push(s);break;case"pan":this._nextBeatAutomations||(this._nextBeatAutomations=[]),s=new q,s.type=y.Balance,s.value=Ys.interpolatePan(Number.parseFloat(t.innerText)),this._nextBeatAutomations.push(s)}}parseHarmony(e,t){const s=new et;let i=!1,a="";for(const t of e.childElements())switch(t.localName){case"root":s.name=this.parseHarmonyRoot(t);break;case"kind":s.name=s.name+this.parseHarmonyKind(t),"yes"===t.getAttribute("parentheses-degrees","no")&&(i=!0);break;case"frame":this.parseHarmonyFrame(t,s);break;case"degree":a+=this.parseDegree(t)}a&&(s.name+=i?`(${a})`:a),null===this._nextBeatChord&&(this._nextBeatChord=s)}parseDegree(e){let t="",s="",i="";for(const a of e.childElements())switch(a.localName){case"degree-value":t=a.innerText;break;case"degree-alter":switch(a.innerText){case"-1":s="♭";break;case"1":s="♯"}break;case"degree-type":i+=a.getAttribute("text","")}return`${i}${s}${t}`}parseHarmonyRoot(e){let t="",s="";for(const i of e.childElements())switch(i.localName){case"root-step":t=i.innerText;break;case"root-alter":switch(Number.parseFloat(i.innerText)){case-2:s="bb";break;case-1:s="b";break;case 0:s="";break;case 1:s="#";break;case 2:s="##"}}return t+s}parseHarmonyKind(e){const t=e.getAttribute("text");let s="";if(t)s=t;else{const t=e.innerText;switch(t){case"major":s="";break;case"minor":s="m";break;case"augmented":s="+";break;case"diminished":s="○";break;case"dominant":s="7";break;case"major-seventh":s="7M";break;case"minor-seventh":s="m7";break;case"diminished-seventh":s="○7";break;case"augmented-seventh":s="+7";break;case"half-diminished":s="⍉";break;case"major-minor":s="mMaj";break;case"major-sixth":s="maj6";break;case"minor-sixth":s="m6";break;case"dominant-ninth":s="9";break;case"major-ninth":s="maj9";break;case"minor-ninth":s="m9";break;case"dominant-11th":s="11";break;case"major-11th":s="maj11";break;case"minor-11th":s="m11";break;case"dominant-13th":s="13";break;case"major-13th":s="maj13";break;case"minor-13th":s="m13";break;case"suspended-second":s="sus2";break;case"suspended-fourth":s="sus4";break;case"Neapolitan":s="♭II";break;case"Italian":s="It⁺⁶";break;case"French":case"German":s="Fr⁺⁶";break;default:s=t}}return s}parseHarmonyFrame(e,t){for(const s of e.childElements())switch(s.localName){case"frame-strings":const e=Number.parseInt(s.innerText,10);t.strings=new Array(e);for(let s=0;s<e;s++)t.strings[s]=-1;break;case"first-fret":t.firstFret=Number.parseInt(s.innerText,10);break;case"frame-note":let i=null,a=null;for(const e of s.childElements())switch(e.localName){case"string":i=Number.parseInt(e.innerText,10);break;case"fret":a=Number.parseInt(e.innerText,10),i&&a>=0&&(t.strings[i-1]=a);break;case"barre":i&&a&&"start"===e.getAttribute("type")&&t.barreFrets.push(a)}}}parseAttributes(e,t,s){let i,a,r;if(null==this._lastBeat)for(const n of e.childElements())switch(n.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(n.innerText);break;case"key":this.parseKey(n,t,s);break;case"time":this.parseTime(n,t);break;case"staves":s.ensureStaveCount(Number.parseInt(n.innerText,10));break;case"clef":i=Number.parseInt(n.getAttribute("number","1"),10)-1,a=this.getOrCreateStaff(s,i),r=this.getOrCreateBar(a,t),this.parseClef(n,r);break;case"staff-details":i=Number.parseInt(n.getAttribute("number","1"),10)-1,a=this.getOrCreateStaff(s,i),this.parseStaffDetails(n,a);break;case"transpose":this.parseTranspose(n,s);break;case"measure-style":this.parseMeasureStyle(n,s,!1)}else for(const t of e.childElements())switch(t.localName){case"divisions":this._divisionsPerQuarterNote=Number.parseFloat(t.innerText);break;case"measure-style":this.parseMeasureStyle(t,s,!0)}}parseMeasureStyle(e,t,s){for(const t of e.childElements())switch(t.localName){case"measure-repeat":if(!s){let s=null;switch(t.getAttribute("type")){case"start":switch(Number.parseInt(t.getAttribute("slashes","1"),10)){case 1:s=c.Simple;break;case 2:s=c.FirstOfDouble}break;case"stop":s=null}if(e.attributes.has("number")){this._simileMarkPerStaff=this._simileMarkPerStaff??new Map;const t=Number.parseInt(e.attributes.get("number"),10)-1;null==s?this._simileMarkPerStaff.delete(t):this._simileMarkPerStaff.set(t,s)}else this._simileMarkAllStaves=s}break;case"slash":switch(t.getAttribute("type")){case"start":this._isBeatSlash=!0;break;case"stop":this._isBeatSlash=!1}}}parseTranspose(e,t){let s=0;for(const t of e.childElements())switch(t.localName){case"chromatic":s+=Number.parseFloat(t.innerText);break;case"octave-change":s+=12*Number.parseFloat(t.innerText)}if(e.attributes.has("number")){const i=this.getOrCreateStaff(t,Number.parseInt(e.attributes.get("number"),10)-1);this.getStaffContext(i).transpose=s,i.displayTranspositionPitch=s}else for(const e of t.staves)this.getStaffContext(e).transpose=s,e.displayTranspositionPitch=s}parseStaffDetails(e,t){for(const s of e.childElements())switch(s.localName){case"staff-lines":t.standardNotationLineCount=Number.parseInt(s.innerText,10);break;case"staff-tuning":this.parseStaffTuning(s,t);break;case"capo":t.capo=Number.parseInt(s.innerText,10)}}parseStaffTuning(e,t){0===t.stringTuning.tunings.length&&(t.showTablature=!0,t.showStandardNotation=!1,t.stringTuning.tunings=new Array(t.standardNotationLineCount).fill(0));const s=Number.parseInt(e.getAttribute("line"),10);let i="C",a="",r=0;for(const t of e.childElements())switch(t.localName){case"tuning-step":i=t.innerText;break;case"tuning-alter":r=Number.parseFloat(t.innerText);break;case"tuning-octave":a=t.innerText}const n=De.getTuningForText(i+a)+r;t.tuning[t.tuning.length-s]=n}parseClef(e,t){let s="s",i=0;for(const a of e.childElements())switch(a.localName){case"sign":s=a.innerText.toLowerCase();break;case"line":i=Number.parseInt(a.innerText,10);break;case"clef-octave-change":switch(Number.parseInt(a.innerText,10)){case-2:t.clefOttava=l._15mb;break;case-1:t.clefOttava=l._8vb;break;case 1:t.clefOttava=l._8va;break;case 2:t.clefOttava=l._15mb}}switch(s){case"g":default:t.clef=h.G2;break;case"f":t.clef=h.F4;break;case"c":t.clef=3===i?h.C3:h.C4;break;case"percussion":t.clef=h.Neutral,t.staff.isPercussion=!0;break;case"tab":t.clef=h.G2,t.staff.showTablature=!0}}parseTime(e,t){let s=!1,i=!1;for(const a of e.childElements()){const e=a.innerText;switch(a.localName){case"beats":s||(-1===e.indexOf("+")?t.timeSignatureNumerator=Number.parseInt(e,10):t.timeSignatureNumerator=e.split("+").map(e=>Number.parseInt(e,10)).reduce((e,t)=>t+e,0),s=!0);break;case"beat-type":i||(-1===e.indexOf("+")?t.timeSignatureDenominator=Number.parseInt(e,10):t.timeSignatureDenominator=e.split("+").map(e=>Number.parseInt(e,10)).reduce((e,t)=>t+e,0),i=!0)}}switch(e.getAttribute("symbol","")){case"common":case"cut":t.timeSignatureCommon=!0}}parseKey(e,t,s){let i,a,r=-d.C,n="";for(const t of e.childElements())switch(t.localName){case"fifths":r=Number.parseInt(t.innerText,10);break;case"mode":n=t.innerText}if(i=-7<=r&&r<=7?r:d.C,a="minor"===n?u.Minor:u.Major,e.attributes.has("number")){const r=this.getOrCreateStaff(s,Number.parseInt(e.attributes.get("number"),10)-1),n=this.getOrCreateBar(r,t);n.keySignature=i,n.keySignatureType=a}else{this._keyAllStaves=[i,a];for(const e of s.staves)e.bars.length>t.index&&(e.bars[t.index].keySignature=i,e.bars[t.index].keySignatureType=a)}}parseDirection(e,t,s){const i=[];let a=null,r=-1,n=-1;for(const t of e.childElements())switch(t.localName){case"direction-type":const e=t.firstElement;e&&i.push(e);break;case"offset":a=Number.parseFloat(t.innerText);break;case"voice":break;case"staff":r=Number.parseInt(t.innerText,10)-1;break;case"sound":t.attributes.has("tempo")&&(n=Number.parseFloat(t.attributes.get("tempo")))}let o=null;o=r>=0?this.getOrCreateStaff(s,r):null!==this._lastBeat?this._lastBeat.voice.bar.staff:this.getOrCreateStaff(s,0);const h=o?this.getOrCreateBar(o,t):null,l=()=>{let e=this._musicalPosition;null!==a&&(e+=a);return e/t.calculateDuration(!1)};if(n>0){const e=new q;e.type=y.Tempo,e.value=n,e.ratioPosition=l(),this.hasSameTempo(t,e)||(t.tempoAutomations.push(e),0===t.index&&(t.score.tempo=e.value))}let c="";for(const e of i)switch(e.localName){case"rehearsal":t.section=new st,t.section.marker=e.innerText;break;case"segno":t.addDirection(xe.TargetSegno);break;case"coda":t.addDirection(xe.TargetCoda);break;case"words":c=e.innerText;break;case"wedge":switch(e.getAttribute("type")){case"crescendo":this._nextBeatCrescendo=B.Crescendo;break;case"diminuendo":this._nextBeatCrescendo=B.Decrescendo;break;case"stop":this._nextBeatCrescendo=null}break;case"dynamics":const s=this.parseDynamics(e);null!==s&&(this._currentDynamics=s,this._score.stylesheet.hideDynamics=!1);break;case"dashes":const i=e.getAttribute("type","start");switch(c){case"LetRing":this._nextBeatLetRing="start"===i||"continue"===i;break;case"P.M.":this._nextBeatPalmMute="start"===i||"continue"===i}c="";break;case"pedal":const a=this.parsePedal(e);if(a&&h){a.ratioPosition=l();const e=h.sustainPedals.length>0&&h.sustainPedals[h.sustainPedals.length-1].pedalType!==p.Up;(a.pedalType!==p.Up||e)&&h.sustainPedals.push(a)}break;case"metronome":this.parseMetronome(e,t,l());break;case"octave-shift":this._nextBeatOttavia=this.parseOctaveShift(e)}c&&(this._nextBeatText=c)}parseOctaveShift(e){const t=e.getAttribute("type");switch(Number.parseInt(e.getAttribute("size","8"),10)){case 15:switch(t){case"up":return l._15mb;case"down":return l._15ma;case"stop":return l.Regular;case"continue":return this._nextBeatOttavia}break;case 8:switch(t){case"up":return l._8vb;case"down":return l._8va;case"stop":return l.Regular;case"continue":return this._nextBeatOttavia}}return null}parseMetronome(e,t,s){let i=null,a=-1;for(const t of e.childElements())switch(t.localName){case"beat-unit":i=this.parseBeatDuration(t);break;case"per-minute":a=Number.parseFloat(t.innerText)}if(null!==i&&a>0){const e=new q;e.type=y.Tempo,e.value=a*(i/4)|0,e.ratioPosition=s,this.hasSameTempo(t,e)||(t.tempoAutomations.push(e),0===t.index&&(t.score.tempo=e.value))}}hasSameTempo(e,t){for(const s of e.tempoAutomations)if(t.ratioPosition===s.ratioPosition&&t.value===s.value)return!0;return!1}parsePedal(e){const t=new z;switch(e.getAttribute("type")){case"start":t.pedalType=p.Down;break;case"stop":t.pedalType=p.Up;break;case"continue":t.pedalType=p.Hold;break;default:return null}return t}parseDynamics(e){for(const t of e.childElements()){const e=t.localName.toUpperCase();switch(e){case"PPP":case"PP":case"P":case"MP":case"MF":case"F":case"FF":case"FFF":case"PPPP":case"PPPPP":case"PPPPPP":case"FFFF":case"FFFFF":case"FFFFFF":case"SF":case"SFP":case"SFPP":case"FP":case"RF":case"RFZ":case"SFZ":case"SFFZ":case"FZ":case"N":case"PF":case"SFZP":return f[e]}}return null}parseForward(e){for(const t of e.childElements())if("duration"===t.localName)this._musicalPosition+=this.musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(t.innerText))}parseBackup(e){for(const t of e.childElements())if("duration"===t.localName){if(this._lastBeat){let e=this._musicalPosition;e-=this.musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(t.innerText)),e<0&&(e=0),this._musicalPosition=e}}}getOrCreateStaff(e,t){for(;e.staves.length<=t;){const t=new ot;e.addStaff(t),this._score.masterBars.length>0&&this.getOrCreateBar(t,this._score.masterBars[this._score.masterBars.length-1])}return e.staves[t]}getOrCreateBar(e,t){const s=0===e.bars.length?1:e.bars[0].voices.length;for(;e.bars.length<=t.index;){const t=new Y;e.addBar(t),t.previousBar&&(t.clef=t.previousBar.clef,t.clefOttava=t.previousBar.clefOttava,t.keySignature=t.previousBar.keySignature,t.keySignatureType=t.previousBar.keySignatureType),null!=this._keyAllStaves&&(t.keySignature=this._keyAllStaves[0],t.keySignatureType=this._keyAllStaves[1]);for(let e=0;e<s;e++){const e=new re;t.addVoice(e)}}return e.bars[t.index]}getOrCreateVoice(e,t){let s=!1;for(;e.voices.length<=t;)e.addVoice(new re),s=!0;if(s)for(const s of e.staff.bars)for(;s.voices.length<=t;)s.addVoice(new re);return e.voices[t]}parseNote(e,t,s){let i=null,a=T.None,r=0,n=null,o=!1,h=0,l=0,c=-1,d=null,u=0,p=-1,m=-1,g=null,f=null,y=!1,b=null;const S="no"!==e.getAttribute("print-object","yes"),w=()=>{if(null!==i)return;o&&!this._lastBeat&&(ee.warning("MusicXML","Malformed MusicXML, <chord /> cannot be set on the first note of a measure"),o=!1),o&&!f&&(ee.warning("MusicXML","Cannot mix <chord /> and <rest />"),o=!1);const e=this.getOrCreateStaff(s,h);if(o)return i=this._lastBeat,void i.addNote(f);const w=this.getOrCreateBar(e,t),B=this.getOrCreateVoice(w,l),_=0===B.beats.length?0:B.beats[B.beats.length-1].displayEnd;let x=this._musicalPosition-_;if(x>0){if(this._lastBeat&&this._lastBeat.beamingMode===be.ForceMergeWithNext&&this._lastBeat.voice.bar.staff.index!==h&&B.beats.length>0&&B.beats[B.beats.length-1].beamingMode===be.ForceMergeWithNext){const e=B.beats[B.beats.length-1].duration;for(;x>0;){const t=this.createRestForGap(x,e);if(null===t)break;this.insertBeatToVoice(t,B),x-=t.playbackDuration}}if(x>0){const e=new Ye;e.dynamics=this._currentDynamics,e.isEmpty=!0,e.duration=k.TwoHundredFiftySixth,e.overrideDisplayDuration=x,e.updateDurations(),this.insertBeatToVoice(e,B)}}else x<0&&ee.error("MusicXML","Unsupported forward/backup detected. Cannot fill new beats into already filled area of voice");c<0&&null!==d&&(c=J.toTicks(d),u>0&&(c=J.applyDot(c,2===u)));const N=new Ye;i=N,null===n?N.beamingMode=this.getStaffContext(e).isExplicitlyBeamed?be.ForceSplitToNext:be.Auto:(N.beamingMode=n,this.getStaffContext(e).isExplicitlyBeamed=!0),N.isEmpty=!1,N.dynamics=this._currentDynamics,this._isBeatSlash&&(N.slashed=!0);const P=this._nextBeatAutomations;if(this._nextBeatAutomations=null,null!==P)for(const e of P)N.automations.push(e);const v=this._nextBeatChord;this._nextBeatChord=null,null!==v&&(N.chordId=v.uniqueId,B.bar.staff.hasChord(v.uniqueId)||B.bar.staff.addChord(N.chordId,v));const E=this._nextBeatCrescendo;null!==E&&(N.crescendo=E);const M=this._nextBeatOttavia;if(null!==M&&(N.ottava=M),N.isLetRing=this._nextBeatLetRing,N.isPalmMute=this._nextBeatPalmMute,this._nextBeatText&&(N.text=this._nextBeatText,this._nextBeatText=null),null!==f&&N.addNote(f),this.insertBeatToVoice(N,B),null!==f){f.isVisible=S;const e=this._indexToTrackInfo.get(s.index);null!==b?f.percussionArticulation=e.getOrCreateArticulation(b,f):y||(f.percussionArticulation=e.getOrCreateArticulation("",f))}a!==T.None?(N.graceType=a,this.applyBeatDurationFromTicks(N,r,null,!1)):(N.tupletNumerator=p,N.tupletDenominator=m,N.dots=u,N.preferredBeamDirection=g,this.applyBeatDurationFromTicks(N,c,d,!0)),this._musicalPosition=N.displayEnd,this._lastBeat=N};for(const t of e.childElements())switch(t.localName){case"grace":const e=Number.parseFloat(t.getAttribute("make-time","-1"));e>=0?(r=this.musicXmlDivisionsToAlphaTabTicks(e),a=T.BeforeBeat):a=T.OnBeat,"yes"===t.getAttribute("slash")&&(a=T.BeforeBeat);break;case"chord":o=!0;break;case"cue":return;case"pitch":f=this.parsePitch(t),y=!0;break;case"unpitched":f=this.parseUnpitched(t,s);break;case"rest":f=null,null===d&&(d=k.Whole);break;case"duration":c=this.parseDuration(t);break;case"instrument":b=t.getAttribute("id","");break;case"voice":l=Number.parseInt(t.innerText,10),Number.isNaN(l)?(ee.warning("MusicXML","Voices need to be specified as numbers"),l=0):l-=1;break;case"type":d=this.parseBeatDuration(t);break;case"dot":u++;break;case"accidental":null===f?ee.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.parseAccidental(t,f);break;case"time-modification":for(const e of t.childElements())switch(e.localName){case"actual-notes":p=Number.parseInt(e.innerText,10);break;case"normal-notes":m=Number.parseInt(e.innerText,10)}break;case"stem":g=this.parseStem(t);break;case"notehead":null===f?ee.warning("MusicXML","Malformed MusicXML, missing pitch or unpitched for note"):this.parseNoteHead(t,f,d??k.Quarter,g??this.estimateBeamDirection(f));break;case"staff":h=Number.parseInt(t.innerText,10)-1;break;case"beam":if("1"===t.getAttribute("number","1"))switch(t.innerText){case"begin":case"continue":n=be.ForceMergeWithNext;break;case"end":n=be.ForceSplitToNext}break;case"notations":w(),this.parseNotations(t,f,i);break;case"lyric":w(),this.parseLyric(t,i,s);break;case"play":this.parsePlay(t,f)}if(y){const e=this.getOrCreateStaff(s,h),t=this.getStaffContext(e).transpose;if(0!==t){const e=12*f.octave+f.tone+t;f.octave=e/12|0,f.tone=e-12*f.octave}}w()}parsePlay(e,t){for(const s of e.childElements())if("mute"===s.localName)t&&"palm"===s.innerText&&(t.isPalmMute=!0)}estimateBeamDirection(e){return e.calculateRealValue(!1,!1)<Ys.B4Value?Pe.Down:Pe.Up}parseNoteHead(e,t,s,i){"yes"===e.getAttribute("parentheses","no")&&(t.isGhost=!0);const a=e.getAttribute("filled","");let r;switch("yes"===a?r=!0:"no"===a&&(r=!1),t.style=new Re,e.innerText){case"arrow down":t.style.noteHeadCenterOnStem=!0,this.applyNoteHead(t,s,r,ne.NoteheadTriangleDownDoubleWhole,ne.NoteheadTriangleDownWhole,ne.NoteheadTriangleDownHalf,ne.NoteheadTriangleDownBlack);break;case"arrow up":t.style.noteHeadCenterOnStem=!0,this.applyNoteHead(t,s,r,ne.NoteheadTriangleUpDoubleWhole,ne.NoteheadTriangleUpWhole,ne.NoteheadTriangleUpHalf,ne.NoteheadTriangleUpBlack);break;case"back slashed":this.applyNoteHead(t,s,r,ne.NoteheadSlashedDoubleWhole2,ne.NoteheadSlashedWhole2,ne.NoteheadSlashedHalf2,ne.NoteheadSlashedBlack2);break;case"circle dot":t.style.noteHead=ne.NoteheadRoundWhiteWithDot;break;case"circle-x":this.applyNoteHead(t,s,r,ne.NoteheadCircleXDoubleWhole,ne.NoteheadCircleXWhole,ne.NoteheadCircleXHalf,ne.NoteheadCircleX);break;case"circled":this.applyNoteHead(t,s,r,ne.NoteheadCircledDoubleWhole,ne.NoteheadCircledWhole,ne.NoteheadCircledHalf,ne.NoteheadCircledBlack);break;case"cluster":this.applyNoteHead(t,s,r,ne.NoteheadClusterDoubleWhole3rd,ne.NoteheadClusterWhole3rd,ne.NoteheadClusterHalf3rd,ne.NoteheadClusterQuarter3rd);break;case"cross":this.applyNoteHead(t,s,r,ne.NoteheadPlusDoubleWhole,ne.NoteheadPlusWhole,ne.NoteheadPlusHalf,ne.NoteheadPlusBlack);break;case"diamond":this.applyNoteHead(t,s,r,ne.NoteheadDiamondDoubleWhole,ne.NoteheadDiamondWhole,ne.NoteheadDiamondHalf,ne.NoteheadDiamondBlack);break;case"do":this.applyNoteHead(t,s,r,ne.NoteShapeTriangleUpWhite,ne.NoteShapeTriangleUpWhite,ne.NoteShapeTriangleUpWhite,ne.NoteShapeTriangleUpBlack);break;case"fa":i===Pe.Up?this.applyNoteHead(t,s,r,ne.NoteShapeTriangleRightWhite,ne.NoteShapeTriangleRightWhite,ne.NoteShapeTriangleRightWhite,ne.NoteShapeTriangleRightBlack):this.applyNoteHead(t,s,r,ne.NoteShapeTriangleLeftWhite,ne.NoteShapeTriangleLeftWhite,ne.NoteShapeTriangleLeftWhite,ne.NoteShapeTriangleLeftBlack);break;case"fa up":this.applyNoteHead(t,s,r,ne.NoteShapeTriangleLeftWhite,ne.NoteShapeTriangleLeftWhite,ne.NoteShapeTriangleLeftWhite,ne.NoteShapeTriangleLeftBlack);break;case"inverted triangle":this.applyNoteHead(t,s,r,ne.NoteheadTriangleDownDoubleWhole,ne.NoteheadTriangleDownWhole,ne.NoteheadTriangleDownHalf,ne.NoteheadTriangleDownBlack);break;case"la":case"square":this.applyNoteHead(t,s,r,ne.NoteShapeSquareWhite,ne.NoteShapeSquareWhite,ne.NoteShapeSquareWhite,ne.NoteShapeSquareBlack);break;case"left triangle":this.applyNoteHead(t,s,r,ne.NoteheadTriangleRightWhite,ne.NoteheadTriangleRightWhite,ne.NoteheadTriangleRightWhite,ne.NoteheadTriangleRightBlack);break;case"mi":this.applyNoteHead(t,s,r,ne.NoteShapeDiamondWhite,ne.NoteShapeDiamondWhite,ne.NoteShapeDiamondWhite,ne.NoteShapeDiamondBlack);break;case"none":t.style.noteHead=ne.NoteheadNull;break;case"normal":this.applyNoteHead(t,s,r,ne.NoteheadDoubleWhole,ne.NoteheadWhole,ne.NoteheadHalf,ne.NoteheadBlack);break;case"re":this.applyNoteHead(t,s,r,ne.NoteShapeMoonWhite,ne.NoteShapeMoonWhite,ne.NoteShapeMoonWhite,ne.NoteShapeMoonBlack);break;case"rectangle":this.applyNoteHead(t,s,r,ne.NoteheadSquareWhite,ne.NoteheadSquareWhite,ne.NoteheadSquareWhite,ne.NoteheadSquareBlack);break;case"slash":this.applyNoteHead(t,s,r,ne.NoteheadSlashWhiteWhole,ne.NoteheadSlashWhiteWhole,ne.NoteheadSlashWhiteHalf,ne.NoteheadSlashHorizontalEnds);break;case"slashed":this.applyNoteHead(t,s,r,ne.NoteheadSlashedDoubleWhole1,ne.NoteheadSlashedWhole1,ne.NoteheadSlashedHalf1,ne.NoteheadSlashedBlack1);break;case"so":this.applyNoteHead(t,s,r,ne.NoteShapeRoundWhite,ne.NoteShapeRoundWhite,ne.NoteShapeRoundWhite,ne.NoteShapeRoundBlack);break;case"ti":this.applyNoteHead(t,s,r,ne.NoteShapeTriangleRoundWhite,ne.NoteShapeTriangleRoundWhite,ne.NoteShapeTriangleRoundWhite,ne.NoteShapeTriangleRoundBlack);break;case"triangle":this.applyNoteHead(t,s,r,ne.NoteheadTriangleUpDoubleWhole,ne.NoteheadTriangleUpWhole,ne.NoteheadTriangleUpHalf,ne.NoteheadTriangleUpBlack);break;case"x":this.applyNoteHead(t,s,r,ne.NoteheadXDoubleWhole,ne.NoteheadXWhole,ne.NoteheadXHalf,ne.NoteheadXBlack)}}createRestForGap(e,t){let s=J.toTicks(t);for(;s>e;){if(t===k.TwoHundredFiftySixth)return null;t*=2,s=J.toTicks(t)}const i=new Ye;return i.dynamics=this._currentDynamics,i.isEmpty=!1,i.duration=t,i.overrideDisplayDuration=s,i.updateDurations(),i}insertBeatToVoice(e,t){if(t.beats.length>0){const s=t.beats[t.beats.length-1];s.nextBeat=e,e.previousBeat=s;let i=s;for(;null!==i&&i.graceType!==T.None;)i=i.index>0?i.previousBeat:null;null!==i&&(e.displayStart=i.displayEnd)}t.addBeat(e)}musicXmlDivisionsToAlphaTabTicks(e){return e*J.QuarterTime/this._divisionsPerQuarterNote}parseBeatDuration(e){switch(e.innerText){case"1024th":case"512th":case"256th":return k.TwoHundredFiftySixth;case"128th":return k.OneHundredTwentyEighth;case"64th":return k.SixtyFourth;case"32nd":return k.ThirtySecond;case"16th":return k.Sixteenth;case"eighth":return k.Eighth;case"quarter":return k.Quarter;case"half":return k.Half;case"whole":return k.Whole;case"breve":return k.DoubleWhole;case"long":return k.QuadrupleWhole}return null}applyBeatDurationFromTicks(e,t,s,i){if(!s)for(let e=0;e<Ys.allDurations.length;e++){if(!(t>=Ys.allDurationTicks[e]))break;s=Ys.allDurations[e]}e.duration=s??k.Sixteenth,i&&(e.overrideDisplayDuration=t),e.updateDurations()}parseLyric(e,t,s){const i=this._indexToTrackInfo.get(s.index).getLyricLine(e.getAttribute("number",""));for(null===t.lyrics&&(t.lyrics=[]);t.lyrics.length<=i;)t.lyrics.push("");for(const s of e.childElements())switch(s.localName){case"text":t.lyrics[i]?t.lyrics[i]+=` ${s.innerText}`:t.lyrics[i]=s.innerText;break;case"elision":t.lyrics[i]+=s.innerText}}parseNotations(e,t,s){for(const i of e.childElements())switch(i.localName){case"tied":t&&this.parseTied(i,t,s.voice.bar.staff);break;case"slur":t&&this.parseSlur(i,t);break;case"glissando":t&&this.parseGlissando(i,t);break;case"slide":t&&this.parseSlide(i,t);break;case"ornaments":t&&this.parseOrnaments(i,t);break;case"technical":this.parseTechnical(i,t,s);break;case"articulations":t&&this.parseArticulations(i,t);break;case"dynamics":const e=this.parseDynamics(i);null!==e&&(s.dynamics=e,this._currentDynamics=e);break;case"fermata":this.parseFermata(i,s);break;case"arpeggiate":this.parseArpeggiate(i,s)}}getStaffContext(e){if(!this._staffToContext.has(e)){const t=new Us;return this._staffToContext.set(e,t),t}return this._staffToContext.get(e)}parseGlissando(e,t){const s=e.getAttribute("type"),i=e.getAttribute("number","1"),a=this.getStaffContext(t.beat.voice.bar.staff);switch(s){case"start":a.slideOrigins.set(i,t);break;case"stop":if(a.slideOrigins.has(i)){const e=a.slideOrigins.get(i);e.slideTarget=t,t.slideOrigin=e,e.slideOutType=E.Shift}}}parseSlur(e,t){const s=e.getAttribute("number","1"),i=this.getStaffContext(t.beat.voice.bar.staff);switch(e.getAttribute("type")){case"start":i.slurStarts.set(s,t);break;case"stop":if(i.slurStarts.has(s)){t.isSlurDestination=!0;const e=i.slurStarts.get(s);e.slurDestination=t,t.slurOrigin=e,i.slurStarts.delete(s)}}}parseArpeggiate(e,t){switch(e.getAttribute("direction","down")){case"down":t.brushType=w.ArpeggioDown;break;case"up":t.brushType=w.ArpeggioUp}}parseFermata(e,t){let s;switch(e.innerText){case"normal":default:s=Ne.Medium;break;case"angled":s=Ne.Short;break;case"square":s=Ne.Long}t.fermata=new pt,t.fermata.type=s}parseArticulations(e,t){for(const s of e.childElements())switch(s.localName){case"accent":t.accentuated=_.Normal;break;case"strong-accent":t.accentuated=_.Heavy;break;case"staccato":t.isStaccato=!0;break;case"tenuto":t.accentuated=_.Tenuto}}parseTechnical(e,t,s){const i=[];for(const a of e.childElements())switch(a.localName){case"up-bow":s.pickStroke=he.Up;break;case"down-bow":s.pickStroke=he.Down;break;case"harmonic":break;case"fingering":t&&(t.leftHandFinger=this.parseFingering(a));break;case"pluck":t&&(t.rightHandFinger=this.parseFingering(a));break;case"fret":t&&(t.fret=Number.parseInt(a.innerText,10));break;case"string":t&&(t.string=s.voice.bar.staff.tuning.length-Number.parseInt(a.innerText,10)+1);break;case"hammer-on":case"pull-off":t&&(t.isHammerPullOrigin=!0);break;case"bend":i.push(a);break;case"tap":s.tap=!0;break;case"smear":t&&(t.vibrato=M.Slight);break;case"golpe":switch(a.getAttribute("placement","above")){case"above":s.golpe=pe.Finger;break;case"below":s.golpe=pe.Thumb}}t&&i.length>0&&this.parseBends(i,t)}parseBends(e,t){const s=j.MaxPosition/e.length;let i=0,a=0,r=!0;for(const n of e){const e=n.findChildElement("bend-alter");if(e){const o=Math.round(2*Math.abs(Number.parseFloat(e.innerText)));n.findChildElement("pre-bend")?r?(i+=o,t.addBendPoint(new j(a,i)),a+=s,t.addBendPoint(new j(a,i)),r=!1):a+=s:n.findChildElement("release")?(r&&(i+=o),t.addBendPoint(new j(a,i)),a+=s,i-=o,t.addBendPoint(new j(a,i)),r=!1):(t.addBendPoint(new j(a,i)),i+=o,a+=s,t.addBendPoint(new j(a,i)),r=!1)}}}parseFingering(e){switch(e.innerText){case"0":return x.NoOrDead;case"1":case"p":case"t":return x.Thumb;case"2":case"i":return x.IndexFinger;case"3":case"m":return x.MiddleFinger;case"4":case"a":return x.AnnularFinger;case"5":case"c":return x.LittleFinger}return x.Unknown}parseOrnaments(e,t){let s=-1;for(const i of e.childElements())switch(i.localName){case"trill-mark":s=Number.parseInt(i.getAttribute("trill-step","2"),10),t.isStringed?t.trillValue=t.stringTuning+s:t.isPercussion||(t.trillValue=t.calculateRealValue(!1,!1)+s);break;case"turn":t.ornament=ce.Turn;break;case"inverted-turn":t.ornament=ce.InvertedTurn;break;case"wavy-line":s>0?"start"===i.getAttribute("type")&&(this._currentTrillStep=s):this._currentTrillStep>0?"stop"===i.getAttribute("type")?this._currentTrillStep=-1:t.isStringed?t.trillValue=t.stringTuning+this._currentTrillStep:t.isPercussion||(t.trillValue=t.calculateRealValue(!1,!1)+this._currentTrillStep):t.vibrato=M.Slight;break;case"mordent":t.ornament=ce.LowerMordent;break;case"inverted-mordent":t.ornament=ce.UpperMordent;break;case"tremolo":switch(i.innerText){case"1":t.beat.tremoloSpeed=k.Eighth;break;case"2":t.beat.tremoloSpeed=k.Sixteenth;break;case"3":t.beat.tremoloSpeed=k.ThirtySecond}}}parseSlide(e,t){const s=e.getAttribute("type"),i=e.getAttribute("number","1"),a=this.getStaffContext(t.beat.voice.bar.staff);switch(s){case"start":a.slideOrigins.set(i,t);break;case"stop":if(a.slideOrigins.has(i)){const e=a.slideOrigins.get(i);e.slideTarget=t,t.slideOrigin=e,e.slideOutType=E.Shift}}}parseTied(e,t,s){const i=e.getAttribute("type"),a=e.getAttribute("number",""),r=this.getStaffContext(s);if("start"===i){if(a){if(r.tieStartIds.has(a)){const e=r.tieStartIds.get(a);r.tieStarts.delete(e)}r.tieStartIds.set(a,t)}r.tieStarts.add(t)}else if("stop"===i&&!t.isTieDestination){let e=null;if(a){if(!r.tieStartIds.has(a))return;e=r.tieStartIds.get(a),r.tieStartIds.delete(a),r.tieStarts.delete(t)}else{const s=this.calculatePitchedNoteValue(t);for(const t of r.tieStarts)if(this.calculatePitchedNoteValue(t)===s){e=t,r.tieStarts.delete(e);break}}if(!e)return;t.isTieDestination=!0,t.tieOrigin=e}}parseStem(e){switch(e.innerText){case"down":return Pe.Down;case"up":return Pe.Up;default:return null}}parseAccidental(e,t){switch(e.innerText){case"sharp":t.accidentalMode=P.ForceSharp;break;case"natural":t.accidentalMode=P.ForceNatural;break;case"flat":t.accidentalMode=P.ForceFlat;break;case"double-sharp":t.accidentalMode=P.ForceDoubleSharp;break;case"flat-flat":t.accidentalMode=P.ForceDoubleFlat}}calculatePitchedNoteValue(e){return 12*e.octave+e.tone}parseDuration(e){return this.musicXmlDivisionsToAlphaTabTicks(Number.parseFloat(e.innerText))}parseUnpitched(e,t){let s="",i=0;for(const t of e.childElements())switch(t.localName){case"display-step":s=t.innerText;break;case"display-octave":i=Number.parseInt(t.innerText,10)+1}const a=new Oe;if(""===s)a.octave=0,a.tone=0;else{const e=12*i+De.getToneForText(s).noteValue;a.octave=e/12|0,a.tone=e-12*a.octave}return a}parsePitch(e){let t="",s=0,i=0;for(const a of e.childElements())switch(a.localName){case"step":t=a.innerText;break;case"alter":s=Number.parseFloat(a.innerText),Number.isNaN(s)&&(s=0);break;case"octave":i=Number.parseInt(a.innerText,10)+1}s|=0;const a=12*i+De.getToneForText(t).noteValue+s,r=new Oe;return r.octave=a/12|0,r.tone=a-12*r.octave,r}applyNoteHead(e,t,s,i,a,r,n){if(void 0===s)switch(t){case k.QuadrupleWhole:case k.DoubleWhole:e.style.noteHead=i;break;case k.Whole:e.style.noteHead=a;break;case k.Half:e.style.noteHead=r;break;default:e.style.noteHead=n}else if(!0===s)e.style.noteHead=n;else switch(t){case k.QuadrupleWhole:case k.DoubleWhole:e.style.noteHead=i;break;case k.Whole:e.style.noteHead=a;break;case k.Half:default:e.style.noteHead=r}}}Ys.B4Value=71,Ys.allDurations=[k.TwoHundredFiftySixth,k.OneHundredTwentyEighth,k.SixtyFourth,k.ThirtySecond,k.Sixteenth,k.Eighth,k.Quarter,k.Half,k.Whole,k.DoubleWhole,k.QuadrupleWhole],Ys.allDurationTicks=Ys.allDurations.map(e=>J.toTicks(e)),e.LayoutMode=void 0,(vt=e.LayoutMode||(e.LayoutMode={}))[vt.Page=0]="Page",vt[vt.Horizontal=1]="Horizontal";class Js{constructor(e){this._writePosition=0,this._readPosition=0,this.count=0,this._buffer=new Float32Array(e)}clear(){this._readPosition=0,this._writePosition=0,this.count=0,this._buffer=new Float32Array(this._buffer.length)}write(e,t,s){let i=0;s>this._buffer.length-this.count&&(s=this._buffer.length-this.count);const a=Math.min(this._buffer.length-this._writePosition,s);return this._buffer.set(e.subarray(t,t+a),this._writePosition),this._writePosition+=a,this._writePosition%=this._buffer.length,i+=a,i<s&&(this._buffer.set(e.subarray(t+i,t+i+s-i),this._writePosition),this._writePosition+=s-i,i=s),this.count+=i,i}read(e,t,s){s>this.count&&(s=this.count);let i=0;const a=Math.min(this._buffer.length-this._readPosition,s);return e.set(this._buffer.subarray(this._readPosition,this._readPosition+a),t),i+=a,this._readPosition+=a,this._readPosition%=this._buffer.length,i<s&&(e.set(this._buffer.subarray(this._readPosition,this._readPosition+s-i),t+i),this._readPosition+=s-i,i=s),this.count-=i,i}}class $s{constructor(e=void 0){this._listeners=[],this._fireOnRegister=e}on(e){return this._listeners.push(e),this._fireOnRegister?.()&&e(),()=>{this.off(e)}}off(e){this._listeners=this._listeners.filter(t=>t!==e)}trigger(){for(const e of this._listeners)e()}}class qs{constructor(e=void 0){this._listeners=[],this._fireOnRegister=e}on(e){if(this._listeners.push(e),this._fireOnRegister){const t=this._fireOnRegister();null!==t&&e(t)}return()=>{this.off(e)}}off(e){this._listeners=this._listeners.filter(t=>t!==e)}trigger(e){for(const t of this._listeners)t(e)}}class js{constructor(){this.ready=new $s,this.samplesPlayed=new qs,this.sampleRequest=new $s}get sampleRate(){return js.preferredSampleRate}open(){ee.debug("AlphaSynth","Initializing synth worker"),this._worker=Hc.globalThis,this._worker.addEventListener("message",this.handleMessage.bind(this)),this.ready.trigger()}destroy(){this._worker.postMessage({cmd:"alphaSynth.output.destroy"})}handleMessage(e){const t=e.data;switch(t.cmd){case js.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case js.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(t.samples)}}addSamples(e){this._worker.postMessage({cmd:"alphaSynth.output.addSamples",samples:Hc.prepareForPostMessage(e)})}play(){this._worker.postMessage({cmd:"alphaSynth.output.play"})}pause(){this._worker.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this._worker.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(e){}async getOutputDevice(){return null}}js.CmdOutputPrefix="alphaSynth.output.",js.CmdOutputAddSamples=`${js.CmdOutputPrefix}addSamples`,js.CmdOutputPlay=`${js.CmdOutputPrefix}play`,js.CmdOutputPause=`${js.CmdOutputPrefix}pause`,js.CmdOutputResetSamples=`${js.CmdOutputPrefix}resetSamples`,js.CmdOutputStop=`${js.CmdOutputPrefix}stop`,js.CmdOutputSampleRequest=`${js.CmdOutputPrefix}sampleRequest`,js.CmdOutputSamplesPlayed=`${js.CmdOutputPrefix}samplesPlayed`,js.preferredSampleRate=0;class Ks{constructor(e){this.isDefault=!1,this.device=e}get deviceId(){return this.device.deviceId}get label(){return this.device.label}}class Qs{static findKnownDevice(e){return Qs._knownDevices.find(t=>t.deviceId===e)}static createAudioContext(){if("AudioContext"in Hc.globalThis)return new AudioContext;if("webkitAudioContext"in Hc.globalThis)return new webkitAudioContext;throw new O(e.AlphaTabErrorType.General,"AudioContext not found")}static async checkSinkIdSupport(){return"setSinkId"in Qs.createAudioContext()||(ee.warning("WebAudio","Browser does not support changing the output device"),!1)}static async enumerateOutputDevices(){try{if(!await Qs.checkSinkIdSupport())return[];try{await navigator.mediaDevices.getUserMedia({audio:!0})}catch(e){ee.warning("WebAudio","Output device permission rejected",e)}const e=await navigator.mediaDevices.enumerateDevices();let t="",s="";const i=new Map;for(const a of e)"audiooutput"===a.kind&&(i.set(a.groupId,new Ks(a)),"default"!==a.deviceId&&""!==a.deviceId||(t=a.groupId,s=a.deviceId));const a=Array.from(i.values());let r=a.find(e=>e.deviceId===s);return r||(r=a.find(e=>e.device.groupId===t)),!r&&a.length>0&&(r=a[0]),r&&(r.isDefault=!0),Qs._knownDevices=a,a}catch(e){return ee.error("WebAudio","Failed to enumerate output devices",e),[]}}}Qs._knownDevices=[];class Zs{constructor(){this._context=null,this._buffer=null,this._source=null,this.ready=new $s,this.samplesPlayed=new qs,this.sampleRequest=new $s}get sampleRate(){return this._context?this._context.sampleRate:Zs.PreferredSampleRate}activate(e){this._context||(this._context=Qs.createAudioContext()),"suspended"!==this._context.state&&"interrupted"!==this._context.state||(ee.debug("WebAudio","Audio Context is suspended, trying resume"),this._context.resume().then(()=>{ee.debug("WebAudio",`Audio Context resume success: state=${this._context?.state}, sampleRate:${this._context?.sampleRate}`),e&&e()},e=>{ee.warning("WebAudio",`Audio Context resume failed: state=${this._context?.state}, sampleRate:${this._context?.sampleRate}, reason=${e}`)}))}patchIosSampleRate(){const e=navigator.userAgent;if(-1!==e.indexOf("iPhone")||-1!==e.indexOf("iPad")){const e=Qs.createAudioContext(),t=e.createBuffer(1,1,Zs.PreferredSampleRate),s=e.createBufferSource();s.buffer=t,s.connect(e.destination),s.start(0),s.disconnect(0),e.close()}}open(e){this.patchIosSampleRate(),this._context=Qs.createAudioContext();"suspended"===this._context.state&&this.registerResumeHandler()}registerResumeHandler(){this._resumeHandler=(()=>{this.activate(()=>{this.unregisterResumeHandler()})}).bind(this),document.body.addEventListener("touchend",this._resumeHandler,!1),document.body.addEventListener("click",this._resumeHandler,!1)}unregisterResumeHandler(){const e=this._resumeHandler;e&&(document.body.removeEventListener("touchend",e,!1),document.body.removeEventListener("click",e,!1))}play(){const e=this._context;this.activate(),this._buffer=e.createBuffer(2,Zs.BufferSize,e.sampleRate),this._source=e.createBufferSource(),this._source.buffer=this._buffer,this._source.loop=!0}pause(){this._source&&(this._source.stop(0),this._source.disconnect()),this._source=null}destroy(){this.pause(),this._context?.close(),this._context=null,this.unregisterResumeHandler()}onSamplesPlayed(e){this.samplesPlayed.trigger(e)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}enumerateOutputDevices(){return Qs.enumerateOutputDevices()}async setOutputDevice(e){await Qs.checkSinkIdSupport()&&(e?await this._context.setSinkId(e.deviceId):await this._context.setSinkId(""))}async getOutputDevice(){if(!await Qs.checkSinkIdSupport())return null;const e=this._context.sinkId;if("string"!=typeof e||""===e||"default"===e)return null;let t=Qs.findKnownDevice(e);if(t)return t;const s=await this.enumerateOutputDevices();return t=s.find(t=>t.deviceId===e),t||(ee.warning("WebAudio","Could not find output device in device list",e,s),null)}}Zs.BufferSize=4096,Zs.PreferredSampleRate=44100;class ei{static init(){var e;ei._isRegistered||(ei._isRegistered=!0,registerProcessor("alphatab",((e=class extends AudioWorkletProcessor{constructor(t){super(t),this._outputBuffer=new Float32Array(0),this._bufferCount=0,this._requestedBufferCount=0,this._isStopped=!1,ee.debug("WebAudio","creating processor"),this._bufferCount=Math.floor(t.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/e.BufferSize),this._circularBuffer=new Js(e.BufferSize*this._bufferCount),this.port.onmessage=this.handleMessage.bind(this)}handleMessage(e){const t=e.data;switch(t.cmd){case js.CmdOutputAddSamples:const e=t.samples;this._circularBuffer.write(e,0,e.length),this._requestedBufferCount--;break;case js.CmdOutputResetSamples:this._circularBuffer.clear();break;case js.CmdOutputStop:this._isStopped=!0}}process(e,t,s){if(1!==t.length&&2!==t[0].length)return!1;const i=t[0][0],a=t[0][1];if(!i||!a)return!0;const r=i.length+a.length;let n=this._outputBuffer;n.length!==r&&(n=new Float32Array(r),this._outputBuffer=n);const o=this._circularBuffer.read(n,0,Math.min(n.length,this._circularBuffer.count));let h=0;const l=Math.min(i.length,o);for(let e=0;e<l;e++)i[e]=n[h++],a[e]=n[h++];if(o<i.length)for(let e=o;e<i.length;e++)i[e]=0,a[e]=0;return this.port.postMessage({cmd:js.CmdOutputSamplesPlayed,samples:o/se.AudioChannels}),this.requestBuffers(),this._circularBuffer.count>0||!this._isStopped}requestBuffers(){const t=this._bufferCount/2|0,s=t*e.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*e.BufferSize<s){for(let e=0;e<t;e++)this.port.postMessage({cmd:js.CmdOutputSampleRequest});this._requestedBufferCount+=t}}}).BufferSize=4096,e)))}}ei._isRegistered=!1;class ti extends Zs{constructor(e){super(),this._worklet=null,this._bufferTimeInMilliseconds=0,this._settings=e}open(e){super.open(e),this._bufferTimeInMilliseconds=e,this.onReady()}play(){super.play();const e=this._context;Hc.createAudioWorklet(e,this._settings).then(()=>{this._worklet=new AudioWorkletNode(e,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this._bufferTimeInMilliseconds}}),this._worklet.port.onmessage=this.handleMessage.bind(this),this._source.connect(this._worklet),this._source.start(0),this._worklet.connect(e.destination)},e=>{ee.error("WebAudio",`Audio Worklet creation failed: reason=${e}`)})}handleMessage(e){const t=e.data;switch(t.cmd){case js.CmdOutputSamplesPlayed:this.onSamplesPlayed(t.samples);break;case js.CmdOutputSampleRequest:this.onSampleRequest()}}pause(){super.pause(),this._worklet&&(this._worklet.port.postMessage({cmd:js.CmdOutputStop}),this._worklet.port.onmessage=null,this._worklet.disconnect()),this._worklet=null}addSamples(e){this._worklet?.port.postMessage({cmd:js.CmdOutputAddSamples,samples:Hc.prepareForPostMessage(e)})}resetSamples(){this._worklet?.port.postMessage({cmd:js.CmdOutputResetSamples})}}!function(e){e[e.SingleTrackMultiChannel=0]="SingleTrackMultiChannel",e[e.MultiTrack=1]="MultiTrack"}(Et||(Et={}));class si{constructor(){this.events=[]}addEvent(e){if(0===this.events.length||e.tick>=this.events[this.events.length-1].tick)this.events.push(e);else{let t=this.events.length;for(;t>0;){if(!(this.events[t-1].tick>e.tick))break;t--}this.events.splice(t,0,e)}}writeTo(e){const t=ut.empty();let s=0;for(const e of this.events){const i=e.tick-s;ii.writeVariableInt(t,i),e.writeTo(t),s=e.tick}const i=new Uint8Array([77,84,114,107]);e.write(i,0,i.length);const a=t.toArray();dt.writeInt32BE(e,a.length),e.write(a,0,a.length)}}class ii{constructor(){this.format=Et.SingleTrackMultiChannel,this.division=J.QuarterTime,this.tracks=[]}get events(){if(1===this.tracks.length)return this.tracks[0].events;const e=[];for(const e of this.tracks)this.events.push(...e.events);return e.sort((e,t)=>e.tick-t.tick),e}ensureTracks(e){for(;this.tracks.length<e;)this.tracks.push(new si)}addEvent(e){this.format===Et.SingleTrackMultiChannel?(this.ensureTracks(1),this.tracks[0].addEvent(e)):(this.ensureTracks(e.track+1),this.tracks[e.track].addEvent(e))}toBinary(){const e=ut.empty();return this.writeTo(e),e.toArray()}writeTo(e){const t=new Uint8Array([77,84,104,100]);e.write(t,0,t.length),dt.writeInt32BE(e,6),dt.writeInt16BE(e,this.format),dt.writeInt16BE(e,this.tracks.length),dt.writeInt16BE(e,this.division);for(const t of this.tracks)t.writeTo(e)}static writeVariableInt(e,t){const s=new Uint8Array(4);let i=0;do{s[i++]=127&t,t>>=7}while(t>0);for(;i>0;)i--,i>0?e.writeByte(128|s[i]):e.writeByte(s[i])}}!function(e){e[e.TimeSignature=88]="TimeSignature",e[e.NoteOn=128]="NoteOn",e[e.NoteOff=144]="NoteOff",e[e.ControlChange=176]="ControlChange",e[e.ProgramChange=192]="ProgramChange",e[e.TempoChange=81]="TempoChange",e[e.PitchBend=224]="PitchBend",e[e.PerNotePitchBend=96]="PerNotePitchBend",e[e.EndOfTrack=47]="EndOfTrack",e[e.AlphaTabRest=241]="AlphaTabRest",e[e.AlphaTabMetronome=242]="AlphaTabMetronome",e[e.SystemExclusive=240]="SystemExclusive",e[e.SystemExclusive2=247]="SystemExclusive2",e[e.Meta=255]="Meta"}(Mt||(Mt={}));class ai{constructor(e,t,s){this.track=e,this.tick=t,this.type=s}get command(){return this.type}get message(){return 0}get data1(){return 0}get data2(){return 0}}class ri extends ai{constructor(e,t,s,i,a,r){super(e,t,Mt.TimeSignature),this.track=e,this.tick=t,this.numerator=s,this.denominatorIndex=i,this.midiClocksPerMetronomeClick=a,this.thirtySecondNodesInQuarter=r}writeTo(e){e.writeByte(255),e.writeByte(88),ii.writeVariableInt(e,4),e.writeByte(255&this.numerator),e.writeByte(255&this.denominatorIndex),e.writeByte(255&this.midiClocksPerMetronomeClick),e.writeByte(255&this.thirtySecondNodesInQuarter)}}class ni extends ai{writeTo(e){e.writeByte(240);const t=ut.withCapacity(16);t.writeByte(ni.AlphaTabManufacturerId),this.writeEventData(t),t.writeByte(247),ii.writeVariableInt(e,t.length),t.copyTo(e)}}ni.AlphaTabManufacturerId=125,ni.MetronomeEventId=0,ni.RestEventId=1;class oi extends ni{constructor(e,t,s,i,a){super(e,t,Mt.AlphaTabMetronome),this.isMetronome=!0,this.metronomeNumerator=s,this.metronomeDurationInMilliseconds=a,this.metronomeDurationInTicks=i}writeEventData(e){e.writeByte(ni.MetronomeEventId),e.writeByte(this.metronomeNumerator),dt.writeInt32LE(e,this.metronomeDurationInTicks),dt.writeInt32LE(e,this.metronomeDurationInMilliseconds)}}class hi extends ni{constructor(e,t,s){super(e,t,Mt.AlphaTabRest),this.channel=s}writeEventData(e){e.writeByte(ni.RestEventId),e.writeByte(this.channel)}}class li extends ai{constructor(e,t,s,i,a,r){super(e,t,s),this.channel=i,this.noteKey=a,this.noteVelocity=r}get data1(){return this.noteKey}get data2(){return this.noteVelocity}}class ci extends li{constructor(e,t,s,i,a){super(e,t,Mt.NoteOn,s,i,a)}writeTo(e){e.writeByte(15&this.channel|144),e.writeByte(255&this.noteKey),e.writeByte(255&this.noteVelocity)}}class di extends li{constructor(e,t,s,i,a){super(e,t,Mt.NoteOff,s,i,a)}writeTo(e){e.writeByte(15&this.channel|128),e.writeByte(255&this.noteKey),e.writeByte(255&this.noteVelocity)}}class ui extends ai{constructor(e,t,s,i,a){super(e,t,Mt.ControlChange),this.channel=s,this.controller=i,this.value=a}writeTo(e){e.writeByte(15&this.channel|176),e.writeByte(255&this.controller),e.writeByte(255&this.value)}get data1(){return this.controller}get data2(){return this.value}}class pi extends ai{constructor(e,t,s,i){super(e,t,Mt.ProgramChange),this.channel=s,this.program=i}writeTo(e){e.writeByte(15&this.channel|192),e.writeByte(255&this.program)}get data1(){return this.program}}class mi extends ai{get microSecondsPerQuarterNote(){return 6e7/this.beatsPerMinute}set microSecondsPerQuarterNote(e){this.beatsPerMinute=6e7/e}constructor(e,t){super(0,e,Mt.TempoChange),this.beatsPerMinute=0,this.microSecondsPerQuarterNote=t}writeTo(e){e.writeByte(255),e.writeByte(81),e.writeByte(3),e.writeByte(this.microSecondsPerQuarterNote>>16&255),e.writeByte(this.microSecondsPerQuarterNote>>8&255),e.writeByte(255&this.microSecondsPerQuarterNote)}}class gi extends ai{constructor(e,t,s,i){super(e,t,Mt.PitchBend),this.channel=s,this.value=i}writeTo(e){e.writeByte(15&this.channel|224),e.writeByte(127&this.value),e.writeByte(this.value>>7&127)}get data1(){return 127&this.value}get data2(){return this.value>>7&127}}class fi extends ai{constructor(e,t,s,i,a){super(e,t,Mt.PerNotePitchBend),this.channel=s,this.noteKey=i,this.value=a}writeTo(t){throw new O(e.AlphaTabErrorType.General,"Note Bend (Midi2.0) events cannot be exported to SMF1.0")}}class yi extends ai{constructor(e,t){super(e,t,Mt.EndOfTrack)}writeTo(e){e.writeByte(255),e.writeByte(47),e.writeByte(0)}}class bi{constructor(e,t){this.time=0,this.eventIndex=e,this.event=t,this.isMetronome=this.event.type===Mt.AlphaTabMetronome}static newMetronomeEvent(e,t,s,i,a){const r=new oi(0,t,s,i,a);return new bi(e,r)}}class Si{constructor(){this.masterBarIndex=0,this.masterBarOccurence=0,this.synthBpm=0,this.synthTime=0,this.synthTick=0,this.syncTime=0,this.syncBpm=0}updateSyncBpm(e,t){const s=(e-this.synthTime)/(t-this.syncTime)*this.synthBpm;this.syncBpm=s}}class wi{constructor(e,t,s){this.bpm=e,this.ticks=t,this.time=s}}class Bi{constructor(){this.tempoChanges=[],this.tempoChangeIndex=0,this.syncPoints=[],this.firstProgramEventPerChannel=new Map,this.firstTimeSignatureNumerator=0,this.firstTimeSignatureDenominator=0,this.synthData=[],this.division=J.QuarterTime,this.eventIndex=0,this.currentTime=0,this.syncPointIndex=0,this.playbackRange=null,this.playbackRangeStartTime=0,this.playbackRangeEndTime=0,this.endTick=0,this.endTime=0,this.currentTempo=0,this.syncPointTempo=0}}class ki{get isPlayingMain(){return this._currentState===this._mainState}get isPlayingOneTimeMidi(){return this._currentState===this._oneTimeState}get isPlayingCountIn(){return this._currentState===this._countInState}constructor(e){this._oneTimeState=null,this._countInState=null,this.isLooping=!1,this.playbackSpeed=1,this.instrumentPrograms=new Set,this.percussionKeys=new Set,this._synthesizer=e,this._mainState=new Bi,this._currentState=this._mainState}get mainPlaybackRange(){return this._mainState.playbackRange}set mainPlaybackRange(e){this._mainState.playbackRange=e,e&&(this._mainState.playbackRangeStartTime=this.tickPositionToTimePositionWithSpeed(this._mainState,e.startTick,1),this._mainState.playbackRangeEndTime=this.tickPositionToTimePositionWithSpeed(this._mainState,e.endTick,1))}get currentTime(){return this._currentState.currentTime/this.playbackSpeed}get currentEndTick(){return this._currentState.endTick}get currentEndTime(){return this._currentState.endTime/this.playbackSpeed}get currentTempo(){return this._currentState.currentTempo}get modifiedTempo(){return this._currentState.syncPointTempo*this.playbackSpeed}get syncPointTempo(){return this._currentState.syncPointTempo}get currentSyncPoints(){return this._currentState.syncPoints}mainSeek(e){if(e*=this.playbackSpeed,this.mainPlaybackRange&&(e<this._mainState.playbackRangeStartTime?e=this._mainState.playbackRangeStartTime:e>this._mainState.playbackRangeEndTime&&(e=this._mainState.playbackRangeEndTime)),e>this._mainState.currentTime)this.mainSilentProcess(e-this._mainState.currentTime);else if(e<this._mainState.currentTime){if(this._mainState.currentTime=0,this._mainState.eventIndex=0,this._mainState.syncPointIndex=0,this._mainState.tempoChangeIndex=0,this._mainState.currentTempo=this._mainState.tempoChanges[0].bpm,this._mainState.syncPointTempo=this._mainState.syncPoints.length>0?this._mainState.syncPoints[0].syncBpm:this._mainState.currentTempo,this.isPlayingMain){const e=this._synthesizer.metronomeVolume;this._synthesizer.noteOffAll(!0),this._synthesizer.resetSoft(),this._synthesizer.setupMetronomeChannel(e)}this.mainSilentProcess(e)}}mainSilentProcess(e){if(e<=0)return;const t=Date.now(),s=this._mainState.currentTime+e;if(this.isPlayingMain)for(;this._mainState.currentTime<s;)this.fillMidiEventQueueLimited(s-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(se.MicroBufferSize);this._mainState.currentTime=s;const i=Date.now()-t;ee.debug("Sequencer",`Silent seek finished in ${i}ms (main)`)}loadOneTimeMidi(e){this._oneTimeState=this.createStateFromFile(e),this._currentState=this._oneTimeState}loadMidi(e){this.instrumentPrograms.clear(),this.percussionKeys.clear(),this._mainState=this.createStateFromFile(e),this._currentState=this._mainState}createStateFromFile(e){const t=new Bi;this.percussionKeys.add(se.MetronomeKey),t.tempoChanges=[],t.division=e.division,t.eventIndex=0,t.currentTime=0,t.synthData=[];let s=120,i=0,a=0,r=0,n=0,o=0,h=0,l=0,c=0;for(const d of e.events){const u=new bi(t.synthData.length,d);t.synthData.push(u);const p=d.tick-c;if(i+=p,a+=p*(6e4/(s*e.division)),u.time=a,c=d.tick,n>0)for(;h<i;){const e=bi.newMetronomeEvent(t.synthData.length,h,Math.floor(h/n)%r,n,o);t.synthData.push(e),e.time=l,h+=n,l+=o}if(d.type===Mt.TempoChange){s=d.beatsPerMinute,t.tempoChanges.push(new wi(s,i,a)),o=n*(6e4/(s*e.division))}else if(d.type===Mt.TimeSignature){const i=d,a=Math.pow(2,i.denominatorIndex);r=i.numerator,n=t.division*(4/a)|0,o=n*(6e4/(s*e.division)),0===t.firstTimeSignatureDenominator&&(t.firstTimeSignatureNumerator=i.numerator,t.firstTimeSignatureDenominator=a)}else if(d.type===Mt.ProgramChange){const e=d,s=e.channel;t.firstProgramEventPerChannel.has(s)||t.firstProgramEventPerChannel.set(s,u);s===se.PercussionChannel||this.instrumentPrograms.add(e.program)}else if(d.type===Mt.NoteOn){const e=d;e.channel===se.PercussionChannel&&this.percussionKeys.add(e.noteKey)}}return t.currentTempo=t.tempoChanges.length>0?t.tempoChanges[0].bpm:s,t.syncPointTempo=t.currentTempo,t.synthData.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.eventIndex-t.eventIndex),t.endTime=a,t.endTick=i,t}fillMidiEventQueue(){return this.fillMidiEventQueueLimited(-1)}fillMidiEventQueueToEndTime(e){for(;this._mainState.currentTime<e;)this.fillMidiEventQueueLimited(e-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(se.MicroBufferSize);let t=!1;for(this._currentState.currentTime=e;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime;){const e=this._currentState.synthData[this._currentState.eventIndex];this._synthesizer.dispatchEvent(e),this._currentState.eventIndex++,t=!0}return t}fillMidiEventQueueLimited(e){let t=se.MicroBufferSize/this._synthesizer.outSampleRate*1e3*this.playbackSpeed,s=this.internalEndTime;e>0&&(e<t&&(t=e),s=Math.min(this.internalEndTime,this._currentState.currentTime+e));let i=!1;for(this._currentState.currentTime+=t;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime&&this._currentState.currentTime<s;)this._synthesizer.dispatchEvent(this._currentState.synthData[this._currentState.eventIndex]),this._currentState.eventIndex++,i=!0;return i}mainTickPositionToTimePosition(e){return this.tickPositionToTimePositionWithSpeed(this._mainState,e,this.playbackSpeed)}mainUpdateSyncPoints(e){const t=this._mainState;if(e.sort((e,t)=>e.synthTick-t.synthTick),t.syncPoints=[],e.length>=0){let s=120,i=0,a=0,r=0;for(let n=0;n<e.length;n++){const o=e[n];let h,l,c,d=0;if(0===n)h=s,l=0,c=0;else{const t=e[n-1];h=t.syncBpm,l=t.syncTime,c=t.synthTick}for(;r<t.tempoChanges.length&&t.tempoChanges[r].ticks<=o.synthTick;){if(d=t.tempoChanges[r].ticks-i,d>0){i+=d,a+=d*(6e4/(s*t.division));const e=(i-c)*((o.syncTime-l)/(o.synthTick-c))+l,r=new Si;r.synthTick=i,r.synthBpm=s,r.synthTime=a,r.syncTime=e,r.syncBpm=h}s=t.tempoChanges[r].bpm,r++}d=o.synthTick-i,i+=d,a+=d*(6e4/(s*t.division)),t.syncPoints.push(o)}}t.syncPointIndex=0,t.syncPointTempo=t.syncPoints.length>0?t.syncPoints[0].syncBpm:t.currentTempo}currentTimePositionToTickPosition(e){const t=this._currentState;if(0===t.tempoChanges.length)return 0;e*=this.playbackSpeed,this.updateCurrentTempo(t,e);const s=t.tempoChanges[t.tempoChangeIndex],i=(e-s.time)/(6e4/(s.bpm*t.division))|0;return s.ticks+i+1}currentUpdateCurrentTempo(e){this.updateCurrentTempo(this._mainState,e*this.playbackSpeed)}updateCurrentTempo(e,t){let s=e.tempoChangeIndex;for(t<e.tempoChanges[s].time&&(s=0);s+1<e.tempoChanges.length&&e.tempoChanges[s+1].time<=t;)s++;s!==e.tempoChangeIndex&&(e.tempoChangeIndex=s,e.currentTempo=e.tempoChanges[e.tempoChangeIndex].bpm,0===e.syncPoints.length&&(e.syncPointTempo=e.currentTempo))}currentUpdateSyncPoints(e){this.updateSyncPoints(this._mainState,e)}updateSyncPoints(e,t){const s=e.syncPoints;if(s.length>0){let i=Math.min(e.syncPointIndex,s.length-1);for(t<s[i].syncTime&&(i=0);i+1<s.length&&s[i+1].syncTime<=t;)i++;i!==e.syncPointIndex&&(e.syncPointIndex=i,e.syncPointTempo=s[i].syncBpm)}else e.syncPointTempo=e.currentTempo}mainTimePositionFromBackingTrack(e,t){const s=this._mainState,i=s.syncPoints;if(e<0||0===i.length)return e;this.updateSyncPoints(this._mainState,e);const a=Math.min(s.syncPointIndex,i.length-1),r=i[a],n=e-r.syncTime;let o;if(a+1<i.length){const e=i[a+1],t=n/(e.syncTime-r.syncTime);o=(e.synthTime-r.synthTime)*t}else{const e=n/(t-r.syncTime);o=(s.endTime-r.synthTime)*e}return(r.synthTime+o)/this.playbackSpeed}mainTimePositionToBackingTrack(e,t){const s=this._mainState,i=s.syncPoints;if(e<0||0===i.length)return e;e*=this.playbackSpeed;let a=Math.min(s.syncPointIndex,i.length-1);for(e<i[a].synthTime&&(a=0);a+1<i.length&&i[a+1].synthTime<=e;)a++;const r=i[a],n=e-r.synthTime;let o;if(a+1<i.length){const e=i[a+1],t=n/(e.synthTime-r.synthTime),s=e.syncTime-r.syncTime;o=r.syncTime+s*t}else{const e=n/(s.endTime-r.synthTime),i=t-r.syncTime;o=r.syncTime+i*e}return o}tickPositionToTimePositionWithSpeed(e,t,s){let i=0,a=120,r=0;for(const s of e.tempoChanges){if(t<s.ticks)break;i=s.time,a=s.bpm,r=s.ticks}return i+=(t-=r)*(6e4/(a*e.division)),i/s}get internalEndTime(){return this.isPlayingMain&&this.mainPlaybackRange?this._currentState.playbackRangeEndTime:this._currentState.endTime}get isFinished(){return this._currentState.currentTime>=this.internalEndTime}stop(){this.isPlayingMain&&this.mainPlaybackRange?this._currentState.currentTime=this.mainPlaybackRange.startTick:this._currentState.currentTime=0,this._currentState.eventIndex=0}resetOneTimeMidi(){this._oneTimeState=null,this._currentState=this._mainState}resetCountIn(){this._countInState=null,this._currentState=this._mainState}startCountIn(){this.generateCountInMidi(),this._currentState=this._countInState,this.stop(),this._synthesizer.noteOffAll(!0)}generateCountInMidi(){const e=new Bi;e.division=this._mainState.division;let t=120,s=4,i=4;0===this._mainState.eventIndex?(t=this._mainState.tempoChanges[0].bpm,s=this._mainState.firstTimeSignatureNumerator,i=this._mainState.firstTimeSignatureDenominator):(t=this._synthesizer.currentTempo,s=this._synthesizer.timeSignatureNumerator,i=this._synthesizer.timeSignatureDenominator),e.tempoChanges.push(new wi(t,0,0));const a=e.division*(4/i)|0,r=a*(6e4/(t*this._mainState.division));let n=0,o=0;for(let t=0;t<s;t++){const s=bi.newMetronomeEvent(e.synthData.length,n,t,a,r);e.synthData.push(s),s.time=o,n+=a,o+=r}e.synthData.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.eventIndex-t.eventIndex),e.endTime=o,e.endTick=n,e.currentTempo=t,e.syncPointTempo=t,this._countInState=e}}!function(e){e[e.Paused=0]="Paused",e[e.Playing=1]="Playing"}(Ft||(Ft={}));class Ti{constructor(e,t){this.state=e,this.stopped=t}}class _i{constructor(e,t,s,i,a,r,n){this.originalTempo=0,this.modifiedTempo=0,this.currentTime=e,this.endTime=t,this.currentTick=s,this.endTick=i,this.isSeek=a,this.originalTempo=r,this.modifiedTempo=n}}class xi{constructor(){this.id="",this.size=0}static load(e,t,s){if(e&&xi.HeaderSize>e.size)return!1;if(s.position+xi.HeaderSize>=s.length)return!1;if(t.id=dt.read8BitStringLength(s,4),t.id.charCodeAt(0)<=32||t.id.charCodeAt(0)>=122)return!1;if(t.size=dt.readUInt32LE(s),e&&xi.HeaderSize+t.size>e.size)return!1;e&&(e.size-=xi.HeaderSize+t.size);const i="RIFF"===t.id,a="LIST"===t.id;return(!i||!e)&&(!i&&!a||(t.id=dt.read8BitStringLength(s,4),!(t.id.charCodeAt(0)<=32||t.id.charCodeAt(0)>=122)&&(t.size-=4,!0)))}}xi.HeaderSize=8;class Ni{constructor(e,t,s,i){this.packetData=e,this.isBeginningOfStream=t,this.isEndOfStream=s,this.granulePosition=s?i:null}addData(e){const t=this.packetData,s=new Uint8Array(t.length+e.length);s.set(t,0),s.set(e,t.length)}}!function(e){e[e.ContinuesPacket=1]="ContinuesPacket",e[e.BeginningOfStream=2]="BeginningOfStream",e[e.EndOfStream=4]="EndOfStream"}(Ct||(Ct={}));class Pi{constructor(e){this._readable=e}read(){const e=[];for(;this.findAndReadPage(e););return e}findAndReadPage(e){return!!this.seekPageHeader()&&this.readPage(e)}seekPageHeader(){for(let e=0;e<65536;e++){if(1399285583===dt.readInt32LE(this._readable))return!0;this._readable.position-=3}return!1}readPage(t){const s=this._readable.readByte();if(-1===s||0!==s)return!1;const i=this._readable.readByte(),a=dt.readInt64LE(this._readable);this._readable.skip(4),this._readable.skip(4),this._readable.skip(4);const r=this._readable.readByte();if(-1===r)return!1;const n=[];let o=0;for(let e=0;e<r;e++){const e=this._readable.readByte();o===n.length&&n.push(0),n[o]+=e,e<255&&o++}for(let s=0;s<n.length;s++){const r=new Uint8Array(n[s]);if(this._readable.read(r,0,r.length)!==r.length)return!1;if(0!==(i&Ct.ContinuesPacket)){if(0===t.length)throw new O(e.AlphaTabErrorType.Format,"OGG: Continuation page without any previous packets");t[t.length-1].addData(r)}else{const e=new Ni(r,0!==(i&Ct.BeginningOfStream)&&0===s,0!==(i&Ct.EndOfStream)&&s===n.length-1,a);t.push(e)}}return!0}}class vi{constructor(){this.audioChannels=0,this.audioSampleRate=0,this.samples=new Float32Array(0),this.bitrateMaximum=0,this.bitrateNominal=0,this.bitrateMinimum=0,this.blocksize0=0,this.blocksize1=0}}class Ei{constructor(){this.value=0,this.bitsRead=0}}class Mi{constructor(e){this._bitBucket=0n,this._bitCount=0n,this._overflowBits=0n,this._source=e}readByte(){return this.readBits(Mi.ByteSize)}readBit(){return 1===this.readBits(1)}readBytes(e){const t=new Uint8Array(e);for(let s=0;s<e;s++)t[s]=255&this.readByte();return t}readBits(e){if(0===e)return 0;const t=this.tryPeekBits(e);return this.skipBits(e),t.value}tryPeekBits(t){if(t<0||t>32)throw new O(e.AlphaTabErrorType.General,"IO: Cannot read more than 32 bits in one go");if(0===t)return new Ei;const s=new Ei;for(;this._bitCount<t;){const e=BigInt(this._source.readByte());if(-1n===e)return s.bitsRead=Number(this._bitCount),s.value=Number(this._bitBucket),this._bitBucket=0n,this._bitCount=0n,s;this._bitBucket=(0xffn&e)<<this._bitCount|this._bitBucket,this._bitCount+=8n,this._bitCount>32&&(this._overflowBits=e>>40n-this._bitCount&0xffn)}let i=this._bitBucket;return t<64&&(i&=(1n<<BigInt(t))-1n),s.value=Number(i),s.bitsRead=t,s}skipBits(e){let t=BigInt(e);if(0===e);else if(this._bitCount>t){if(this._bitBucket=e>31?0n:this._bitBucket>>t,this._bitCount>32){const s=this._bitCount-32n;this._bitBucket=this._bitBucket|this._overflowBits<<this._bitCount-t-s,s>e&&(this._overflowBits=this._overflowBits>>t&0xffn)}this._bitCount-=t}else if(this._bitCount===t)this._bitBucket=0n,this._bitCount=0n;else{for(t-=this._bitCount,this._bitCount=0n,this._bitBucket=0n;t>8;){if(-1===this._source.readByte()){t=0n;break}t-=8n}if(t>0){const e=BigInt(this._source.readByte());-1n===e||(this._bitBucket=e>>t,this._bitCount=8n-t)}}}}Mi.ByteSize=8;class Fi{constructor(){this.codebooks=[],this.timeDomainTransforms=[],this.floors=[],this.residues=[],this.mappings=[],this.modes=[]}}class Ci{static ilog(e){let t=0;for(;e>0;)++t,e>>=1;return t}static bitReverse(e,t=32){let s=BigInt(e);s=(s&BigInt(2863311530))>>1n|(s&BigInt(1431655765))<<1n,s=(s&BigInt(3435973836))>>2n|(s&BigInt(858993459))<<2n,s=(s&BigInt(4042322160))>>4n|(s&BigInt(252645135))<<4n,s=(s&BigInt(4278255360))>>8n|(s&BigInt(16711935))<<8n,s=(s>>16n|s<<16n)>>32n-BigInt(t);return Number(BigInt.asUintN(32,s))}static convertFromVorbisFloat32(e){const t=BigInt(e);let s=t&BigInt(2097151);const i=t&BigInt(2147483648),a=(t&BigInt(2145386496))>>21n;return 0n!==i&&(s=-s),Number(s)*Math.pow(2,Number(a)-788)}}class Di{constructor(e){this._data=e}get(e){return this._data[e]}}class Li{get(e){return e}}Li.instance=new Li;class Ii{constructor(t,s){this._maxBits=0,this._overflowList=null,this._prefixList=null,this._prefixBitLength=0,this.dimensions=0,this.entries=0,this.mapType=0;if(5653314!==t.readBits(24))throw new O(e.AlphaTabErrorType.Format,"Vorbis: Book header had invalid signature!");this.dimensions=t.readBits(16),this.entries=t.readBits(24),this._lengths=new Int32Array(this.entries),this.initTree(t,s),this.initLookupTable(t)}get(e,t){return this._lookupTable[e*this.dimensions+t]}decodeScalar(e){let t=e.tryPeekBits(this._prefixBitLength);if(0===t.bitsRead)return-1;let s=this._prefixList[t.value];if(null!=s)return e.skipBits(s.length),s.value;if(t=e.tryPeekBits(this._maxBits),null!==this._overflowList)for(let i=0;i<this._overflowList.length;i++){s=this._overflowList[i];const a=t.value&s.mask;if(s.bits===a)return e.skipBits(s.length),s.value}return-1}initTree(t,s){let i,a,r=0;if(t.readBit()){let e=t.readBits(5)+1;for(let s=0;s<this.entries;){let i=t.readBits(Ci.ilog(this.entries-s));for(;--i>=0;)this._lengths[s++]=e;++e}r=0,i=!1,a=e}else{a=-1,i=t.readBit();for(let e=0;e<this.entries;e++)!i||t.readBit()?(this._lengths[e]=t.readBits(5)+1,++r):this._lengths[e]=-1,this._lengths[e]>a&&(a=this._lengths[e])}if(this._maxBits=a,a>-1){let t,a=null;i&&r>=this.entries>>2&&(a=new Int32Array(this.entries),a.set(this._lengths.subarray(0,this.entries),0),i=!1),t=i?r:0;let n=null,o=null;if(i?0!==t&&(a=new Int32Array(t),o=new Int32Array(t),n=new Int32Array(t)):o=new Int32Array(this.entries),!this.computeCodewords(i,o,a,this._lengths,this.entries,n))throw new O(e.AlphaTabErrorType.Format,"Vorbis: Failed to compute codewords");const h=null==n?Li.instance:new Di(n);s.generateTable(h,a??this._lengths,o),this._prefixList=s.prefixTree,this._prefixBitLength=s.tableBits,this._overflowList=s.overflowList}}computeCodewords(e,t,s,i,a,r){const n=new Uint32Array(32);let o=0,h=0;for(o=0;o<a&&!(i[o]>0);++o);if(o===a)return!0;this.addEntry(e,t,s,0,o,h++,i[o],r);for(let e=1;e<=i[o];++e)n[e]=1<<32-e;for(let l=o+1;l<a;++l){let a=i[l];if(a<=0)continue;for(;a>0&&0===n[a];)--a;if(0===a)return!1;const o=n[a];if(n[a]=0,this.addEntry(e,t,s,Ci.bitReverse(o),l,h++,i[l],r),a!==i[l])for(let e=i[l];e>a;--e)n[e]=o+(1<<32-e)}return!0}addEntry(e,t,s,i,a,r,n,o){e?(t[r]=i,s[r]=n,o[r]=a):t[a]=i}initLookupTable(e){if(this.mapType=e.readBits(4),0===this.mapType)return;const t=Ci.convertFromVorbisFloat32(e.readBits(32)),s=Ci.convertFromVorbisFloat32(e.readBits(32)),i=e.readBits(4)+1,a=e.readBit();let r=this.entries*this.dimensions;const n=new Float32Array(r);1===this.mapType&&(r=this.lookup1Values());const o=new Uint32Array(r);for(let t=0;t<r;t++)o[t]=e.readBits(i);if(1===this.mapType)for(let e=0;e<this.entries;e++){let i=0,h=1;for(let l=0;l<this.dimensions;l++){const c=o[e/h%r|0]*s+t+i;n[e*this.dimensions+l]=c,a&&(i=c),h*=r}}else for(let e=0;e<this.entries;e++){let i=0,r=e*this.dimensions;for(let h=0;h<this.dimensions;h++){const l=o[r]*s+t+i;n[e*this.dimensions+h]=l,a&&(i=l),++r}}this._lookupTable=n}lookup1Values(){let e=Math.floor(Math.exp(Math.log(this.entries)/this.dimensions));return Math.floor(Math.pow(e+1,this.dimensions))<=this.entries&&++e,e}}class Ai{constructor(){this.value=0,this.length=0,this.bits=0,this.mask=0}}class Ri{constructor(){this.tableBits=0,this.prefixTree=[],this.overflowList=null}generateTable(e,t,s){const i=new Array(t.length);let a=0;for(let r=0;r<i.length;r++){const n=new Ai;n.value=e.get(r),n.length=t[r]<=0?99999:t[r],n.bits=s[r],n.mask=(1<<t[r])-1,i[r]=n,t[r]>0&&a<t[r]&&(a=t[r])}i.sort((e,t)=>{const s=e.length-t.length;return 0===s?e.bits-t.bits:s});const r=a>Ri.MAX_TABLE_BITS?Ri.MAX_TABLE_BITS:a,n=[];let o=null;for(let e=0;e<i.length&&i[e].length<99999;e++){const t=i[e].length;if(t>r)for(o=[];e<i.length&&i[e].length<99999;e++)o.push(i[e]);else{const s=1<<r-t,a=i[e];for(let e=0;e<s;e++){const s=e<<t|a.bits;for(;n.length<=s;)n.push(null);n[s]=a}}}for(;n.length<1<<r;)n.push(null);this.tableBits=r,this.prefixTree=n,this.overflowList=o}}Ri.MAX_TABLE_BITS=10;class Oi{constructor(e){e.readBits(16)}}class Wi{get executeChannel(){return(this.forceEnergy||this.amp>0)&&!this.forceNoEnergy}constructor(e){this.amp=0,this.forceEnergy=!1,this.forceNoEnergy=!1,this.coeff=e}}class Hi{constructor(t,s,i,a){if(this._order=t.readBits(8),this._rate=t.readBits(16),this._bark_map_size=t.readBits(16),this._ampBits=t.readBits(6),this._ampOfs=t.readBits(8),this._books=new Array(t.readBits(4)+1),this._order<1||this._rate<1||this._bark_map_size<1||0===this._books.length)throw new O(e.AlphaTabErrorType.Format,"Vorbis: Invalid Floor0 Data");this._ampDiv=(1<<this._ampBits)-1;for(let s=0;s<this._books.length;s++){const i=t.readBits(8);if(i<0||i>=a.length)throw new O(e.AlphaTabErrorType.Format,"Vorbis: Invalid Floor0 Data");const r=a[i];if(0===r.mapType||r.dimensions<1)throw new O(e.AlphaTabErrorType.Format,"Vorbis: Invalid Floor0 Data");this._books[s]=r}this._bookBits=Ci.ilog(this._books.length),this._barkMaps=new Map([[s,this.synthesizeBarkCurve(s/2)],[i,this.synthesizeBarkCurve(i/2)]]),this._wMap=new Map([[s,this.synthesizeWDelMap(s/2)],[i,this.synthesizeWDelMap(i/2)]])}synthesizeBarkCurve(e){const t=this._bark_map_size/Hi.toBARK(this._rate/2),s=new Int32Array(e+1);for(let i=0;i<e-1;i++)s[i]=Math.min(this._bark_map_size-1,Math.floor(Hi.toBARK(this._rate/2/e*i)*t));return s[e]=-1,s}static toBARK(e){return 13.1*Math.atan(74e-5*e)+2.24*Math.atan(1.85e-8*e*e)+1e-4*e}synthesizeWDelMap(e){const t=Math.PI/this._bark_map_size,s=new Float32Array(e);for(let i=0;i<e;i++)s[i]=2*Math.cos(t*i);return s}unpack(e,t,s){const i=new Wi(new Float32Array(this._order+1));if(i.amp=e.readBits(this._ampBits),i.amp>0){i.amp=i.amp/this._ampDiv*this._ampOfs;const t=e.readBits(this._bookBits);if(t>=this._books.length)return i.amp=0,i;const s=this._books[t];for(let t=0;t<this._order;){const a=s.decodeScalar(e);if(-1===a)return i.amp=0,i;for(let e=0;t<this._order&&e<s.dimensions;e++,t++)i.coeff[t]=s.get(a,e)}let a=0;for(let e=0;e<this._order;){for(let t=0;e<this._order&&t<s.dimensions;e++,t++)i.coeff[e]+=a;a=i.coeff[e-1]}}return i}apply(e,t,s){const i=e,a=t/2;if(i.amp>0){const e=this._barkMaps.get(t),r=this._wMap.get(t);let n=0;for(n=0;n<this._order;n++)i.coeff[n]=2*Math.cos(i.coeff[n]);for(n=0;n<a;){let t=0;const a=e[n];let o=.5,h=.5;const l=r[a];for(t=1;t<this._order;t+=2)h*=l-i.coeff[t-1],o*=l-i.coeff[t];for(t===this._order?(h*=l-i.coeff[t-1],o*=o*(4-l*l),h*=h):(o*=o*(2-l),h*=h*(2+l)),h=i.amp/Math.sqrt(o+h)-this._ampOfs,h=Math.exp(.11512925*h),s[n]*=h;e[++n]===a;)s[n]*=h}}else s.fill(0,0,a)}}class Gi{constructor(){this.posts=new Int32Array(64),this.postCount=0,this.forceEnergy=!1,this.forceNoEnergy=!1}get executeChannel(){return(this.forceEnergy||this.postCount>0)&&!this.forceNoEnergy}}class Vi{constructor(t,s){let i=-1;this._partitionClass=new Int32Array(t.readBits(5));for(let e=0;e<this._partitionClass.length;e++)this._partitionClass[e]=t.readBits(4),this._partitionClass[e]>i&&(i=this._partitionClass[e]);++i,this._classDimensions=new Int32Array(i),this._classSubclasses=new Int32Array(i),this._classMasterbooks=new Array(i),this._classMasterBookIndex=new Int32Array(i),this._subclassBooks=new Array(i),this._subclassBookIndex=new Array(i);for(let e=0;e<i;e++){this._classDimensions[e]=t.readBits(3)+1,this._classSubclasses[e]=t.readBits(2),this._classSubclasses[e]>0&&(this._classMasterBookIndex[e]=t.readBits(8),this._classMasterbooks[e]=s[this._classMasterBookIndex[e]]),this._subclassBooks[e]=new Array(1<<this._classSubclasses[e]),this._subclassBookIndex[e]=new Int32Array(this._subclassBooks[e].length);for(let i=0;i<this._subclassBooks[e].length;i++){const a=t.readBits(8)-1;a>=0&&(this._subclassBooks[e][i]=s[a]),this._subclassBookIndex[e][i]=a}}this._multiplier=t.readBits(2),this._range=Vi._rangeLookup[this._multiplier],this._yBits=Vi._yBitsLookup[this._multiplier],++this._multiplier;const a=t.readBits(4),r=[];r.push(0),r.push(1<<a);for(let e=0;e<this._partitionClass.length;e++){const s=this._partitionClass[e];for(let e=0;e<this._classDimensions[s];e++)r.push(t.readBits(a))}this._xList=new Int32Array(r),this._lNeigh=new Int32Array(r.length),this._hNeigh=new Int32Array(r.length),this._sortIdx=new Int32Array(r.length),this._sortIdx[0]=0,this._sortIdx[1]=1;for(let e=2;e<this._lNeigh.length;e++){this._lNeigh[e]=0,this._hNeigh[e]=1,this._sortIdx[e]=e;for(let t=2;t<e;t++){const s=this._xList[t];s<this._xList[e]?s>this._xList[this._lNeigh[e]]&&(this._lNeigh[e]=t):s<this._xList[this._hNeigh[e]]&&(this._hNeigh[e]=t)}}for(let t=0;t<this._sortIdx.length-1;t++)for(let s=t+1;s<this._sortIdx.length;s++){if(this._xList[t]===this._xList[s])throw new O(e.AlphaTabErrorType.Format,"Vorbis: Invalid Floor1 Data");if(this._xList[this._sortIdx[t]]>this._xList[this._sortIdx[s]]){const e=this._sortIdx[t];this._sortIdx[t]=this._sortIdx[s],this._sortIdx[s]=e}}}unpack(e,t,s){const i=new Gi;if(e.readBit()){let t=2;i.posts[0]=e.readBits(this._yBits),i.posts[1]=e.readBits(this._yBits);for(let s=0;s<this._partitionClass.length;s++){const a=this._partitionClass[s],r=this._classDimensions[a],n=this._classSubclasses[a],o=(1<<n)-1;let h=0;if(n>0&&(h=this._classMasterbooks[a].decodeScalar(e),-1===h)){t=0;break}for(let l=0;l<r;l++){const r=this._subclassBooks[a][h&o];if(h>>=n,null!=r&&(i.posts[t]=r.decodeScalar(e),-1===i.posts[t])){t=0,s=this._partitionClass.length;break}++t}}i.postCount=t}return i}apply(e,t,s){const i=e,a=t/2;if(i.postCount>0){const e=this.unwrapPosts(i);let t=0,r=i.posts[0]*this._multiplier;for(let n=1;n<i.postCount;n++){const o=this._sortIdx[n];if(e[o]){const e=this._xList[o],n=i.posts[o]*this._multiplier;t<a&&this.renderLineMulti(t,r,Math.min(e,a),n,s),t=e,r=n}if(t>=a)break}t<a&&this.renderLineMulti(t,r,a,r,s)}else s.fill(0,0,a)}unwrapPosts(e){const t=new Array(64);t.fill(!1),t[0]=!0,t[1]=!0;const s=new Int32Array(64);s[0]=e.posts[0],s[1]=e.posts[1];for(let i=2;i<e.postCount;i++){const a=this._lNeigh[i],r=this._hNeigh[i],n=this.renderPoint(this._xList[a],s[a],this._xList[r],s[r],this._xList[i]),o=e.posts[i],h=this._range-n,l=n;let c;c=h<l?2*h:2*l,0!==o?(t[a]=!0,t[r]=!0,t[i]=!0,s[i]=o>=c?h>l?o-l+n:n-o+h-1:o%2==1?n-(o+1)/2:n+o/2):(t[i]=!1,s[i]=n)}for(let t=0;t<e.postCount;t++)e.posts[t]=s[t];return t}renderPoint(e,t,s,i,a){const r=i-t,n=s-e,o=Math.abs(r)*(a-e)/n|0;return r<0?t-o:t+o}renderLineMulti(e,t,s,i,a){const r=i-t,n=s-e;let o=Math.abs(r);const h=1-2*(r>>31&1),l=r/n|0;let c=e,d=t,u=-n;for(a[e]*=Vi.inverse_dB_table[t],o-=Math.abs(l)*n;++c<s;)d+=l,u+=o,u>=0&&(u-=n,d+=h),a[c]*=Vi.inverse_dB_table[d]}}Vi._rangeLookup=[256,128,86,64],Vi._yBitsLookup=[8,7,7,6],Vi.inverse_dB_table=new Float32Array([1.0649863e-7,1.1341951e-7,1.2079015e-7,1.2863978e-7,1.3699951e-7,1.4590251e-7,1.5538408e-7,1.6548181e-7,1.7623575e-7,1.8768855e-7,1.9988561e-7,2.128753e-7,2.2670913e-7,2.4144197e-7,2.5713223e-7,2.7384213e-7,2.9163793e-7,3.1059021e-7,3.3077411e-7,3.5226968e-7,3.7516214e-7,3.9954229e-7,4.255068e-7,4.5315863e-7,4.8260743e-7,5.1396998e-7,5.4737065e-7,5.8294187e-7,6.2082472e-7,6.6116941e-7,7.0413592e-7,7.4989464e-7,7.9862701e-7,8.505263e-7,9.0579828e-7,9.6466216e-7,10273513e-13,10941144e-13,11652161e-13,12409384e-13,13215816e-13,14074654e-13,14989305e-13,15963394e-13,17000785e-13,18105592e-13,19282195e-13,20535261e-13,21869758e-13,23290978e-13,24804557e-13,26416497e-13,2813319e-12,29961443e-13,31908506e-13,33982101e-13,36190449e-13,38542308e-13,41047004e-13,4371447e-12,46555282e-13,49580707e-13,5280274e-12,5623416e-12,59888572e-13,63780469e-13,67925283e-13,72339451e-13,77040476e-13,82047e-10,87378876e-13,93057248e-13,99104632e-13,10554501e-12,11240392e-12,11970856e-12,12748789e-12,13577278e-12,14459606e-12,15399272e-12,16400004e-12,17465768e-12,18600792e-12,19809576e-12,21096914e-12,22467911e-12,23928002e-12,25482978e-12,27139006e-12,28902651e-12,30780908e-12,32781225e-12,34911534e-12,37180282e-12,39596466e-12,42169667e-12,4491009e-11,47828601e-12,50936773e-12,54246931e-12,57772202e-12,61526565e-12,65524908e-12,69783085e-12,74317983e-12,79147585e-12,8429104e-11,89768747e-12,95602426e-12,.00010181521,.00010843174,.00011547824,.00012298267,.00013097477,.00013948625,.00014855085,.00015820453,.00016848555,.00017943469,.00019109536,.00020351382,.00021673929,.00023082423,.00024582449,.00026179955,.00027881276,.00029693158,.00031622787,.00033677814,.00035866388,.00038197188,.00040679456,.00043323036,.00046138411,.00049136745,.00052329927,.00055730621,.00059352311,.00063209358,.00067317058,716917e-9,.0007635063,.00081312324,.00086596457,.00092223983,.00098217216,.0010459992,.0011139742,.0011863665,.0012634633,.0013455702,.0014330129,.0015261382,.0016253153,.0017309374,.0018434235,.0019632195,.0020908006,.0022266726,.0023713743,.0025254795,.0026895994,.0028643847,.0030505286,.0032487691,.0034598925,.0036847358,.0039241906,.0041792066,.004450795,.0047400328,.0050480668,.0053761186,.0057254891,.0060975636,.0064938176,.0069158225,.0073652516,.0078438871,.0083536271,.0088964928,.009474637,.010090352,.01074608,.011444421,.012188144,.012980198,.013823725,.014722068,.015678791,.016697687,.017782797,.018938423,.020169149,.021479854,.022875735,.02436233,.025945531,.027631618,.029427276,.031339626,.033376252,.035545228,.037855157,.040315199,.042935108,.045725273,.048696758,.051861348,.055231591,.05882085,.062643361,.066714279,.071049749,.075666962,.080584227,.085821044,.091398179,.097337747,.1036633,.11039993,.11757434,.12521498,.13335215,.14201813,.15124727,.16107617,.1715438,.18269168,.19456402,.20720788,.22067342,.23501402,.25028656,.26655159,.28387361,.30232132,.32196786,.34289114,.36517414,.38890521,.41417847,.44109412,.4697589,.50028648,.53279791,.56742212,.6042964,.64356699,.68538959,.72993007,.77736504,.8278826,.88168307,.9389798,1]);class Ui{constructor(t,s,i,a){const r=t.readBits(16);switch(r){case 0:this.floor=new Hi(t,s,i,a);break;case 1:this.floor=new Vi(t,a);break;default:throw new O(e.AlphaTabErrorType.Format,`Vorbis: Invalid Floor type: ${r}`)}}apply(e,t,s){this.floor.apply(e,t,s)}unpack(e,t,s){return this.floor.unpack(e,t,s)}}class zi{constructor(t,s,i){this._begin=t.readBits(24),this._end=t.readBits(24),this._partitionSize=t.readBits(24)+1,this._classifications=t.readBits(6)+1,this._classBook=i[t.readBits(8)],this._cascade=new Int32Array(this._classifications);let a=0;for(let e=0;e<this._classifications;e++){const s=t.readBits(3);t.readBit()?this._cascade[e]=t.readBits(5)<<3|s:this._cascade[e]=s,a+=zi.icount(this._cascade[e])}const r=new Int32Array(a);for(let s=0;s<a;s++)if(r[s]=t.readBits(8),0===i[r[s]].mapType)throw new O(e.AlphaTabErrorType.Format,"Vorbis: Invalid Residue 0");const n=this._classBook.entries;let o=this._classBook.dimensions,h=1;for(;o>0;){if(h*=this._classifications,h>n)throw new O(e.AlphaTabErrorType.Format,"Vorbis: Invalid Residue 0");--o}this._books=new Array(this._classifications),a=0;let l,c=0;for(let e=0;e<this._classifications;e++)if(l=Ci.ilog(this._cascade[e]),this._books[e]=new Array(l),l>0){c=Math.max(c,l);for(let t=0;t<l;t++)(this._cascade[e]&1<<t)>0&&(this._books[e][t]=i[r[a++]])}this._maxStages=c,this._decodeMap=new Array(h);for(let e=0;e<h;e++){let t=e,s=h/this._classifications|0;this._decodeMap[e]=new Int32Array(this._classBook.dimensions);for(let i=0;i<this._classBook.dimensions;i++){const a=t/s|0;t-=a*s,s=s/this._classifications|0,this._decodeMap[e][i]=a}}this._channels=s}static icount(e){let t=0;for(;0!==e;)t+=1&e,e>>=1;return t}decode(e,t,s,i){const a=(this._end<s/2?this._end:s/2)-this._begin;if(a>0&&-1!==t.indexOf(!1)){const t=a/this._partitionSize,s=(t+this._classBook.dimensions-1)/this._classBook.dimensions|0,r=[];for(let e=0;e<this._channels;e++)r.push(new Array(s));for(let s=0;s<this._maxStages;s++)for(let a=0,n=0;a<t;n++){if(0===s)for(let i=0;i<this._channels;i++){const o=this._classBook.decodeScalar(e);if(!(o>=0&&o<this._decodeMap.length)){a=t,s=this._maxStages;break}r[i][n]=this._decodeMap[o]}for(let o=0;a<t&&o<this._classBook.dimensions;o++,a++){const h=this._begin+a*this._partitionSize;for(let l=0;l<this._channels;l++){const c=r[l][n][o];if(this._cascade[c]&1<<s){const r=this._books[c][s];if(r&&this.writeVectors(r,e,i,l,h,this._partitionSize)){a=t,s=this._maxStages;break}}}}}}}writeVectors(e,t,s,i,a,r){const n=s[i],o=r/e.dimensions,h=new Int32Array(o);for(let s=0;s<o;s++)if(h[s]=e.decodeScalar(t),-1===h[s])return!0;for(let t=0;t<e.dimensions;t++)for(let s=0;s<o;s++,a++)n[a]+=e.get(h[s],t);return!1}}class Xi extends zi{writeVectors(e,t,s,i,a,r){const n=s[i];for(let s=0;s<r;){const i=e.decodeScalar(t);if(-1===i)return!0;for(let t=0;t<e.dimensions;s++,t++)n[a+s]+=e.get(i,t)}return!1}}class Yi extends zi{constructor(e,t,s){super(e,1,s),this._realChannels=t}decode(e,t,s,i){super.decode(e,t,s*this._realChannels,i)}writeVectors(e,t,s,i,a,r){let n=0;a/=this._realChannels;for(let i=0;i<r;){const r=e.decodeScalar(t);if(-1===r)return!0;for(let t=0;t<e.dimensions;t++,i++)s[n][a]+=e.get(r,t),++n===this._realChannels&&(n=0,a++)}return!1}}class Ji{constructor(t,s,i){const a=t.readBits(16);switch(a){case 0:this.residue=new zi(t,s,i);break;case 1:this.residue=new Xi(t,s,i);break;case 2:this.residue=new Yi(t,s,i);break;default:throw new O(e.AlphaTabErrorType.Format,`Vorbis: Invalid Residue type: ${a}`)}}decode(e,t,s,i){this.residue.decode(e,t,s,i)}}class $i{constructor(t,s,i,a,r){if(0!==t.readBits(16))throw new O(e.AlphaTabErrorType.Format,"Vorbis: Invalid mapping type!");let n=1;t.readBit()&&(n+=t.readBits(4));let o=0;t.readBit()&&(o=t.readBits(8)+1);const h=Ci.ilog(s-1);this._couplingAngle=new Int32Array(o),this._couplingMangitude=new Int32Array(o);for(let i=0;i<o;i++){const a=t.readBits(h),r=t.readBits(h);if(a===r||a>s-1||r>s-1)throw new O(e.AlphaTabErrorType.Format,"Vorbis: Invalid magnitude or angle in mapping header!");this._couplingAngle[i]=r,this._couplingMangitude[i]=a}if(0!==t.readBits(2))throw new O(e.AlphaTabErrorType.Format,"Vorbis: Reserved bits not 0 in mapping header.");const l=new Int32Array(s);if(n>1)for(let i=0;i<s;i++)if(l[i]=t.readBits(4),l[i]>n)throw new O(e.AlphaTabErrorType.Format,"Vorbis: Invalid channel mux submap index in mapping header!");this._submapFloor=new Array(n),this._submapResidue=new Array(n);for(let s=0;s<n;s++){t.skipBits(8);const r=t.readBits(8);if(r>=i.length)throw new O(e.AlphaTabErrorType.Format,"Vorbis: Invalid floor number in mapping header!");const n=t.readBits(8);if(n>=a.length)throw new O(e.AlphaTabErrorType.Format,"Vorbis: Invalid residue number in mapping header!");this._submapFloor[s]=i[r],this._submapResidue[s]=a[n]}this._channelFloor=new Array(s),this._channelResidue=new Array(s);for(let e=0;e<s;e++)this._channelFloor[e]=this._submapFloor[l[e]],this._channelResidue[e]=this._submapResidue[l[e]];this._mdct=r}decodePacket(e,t,s){const i=t>>1,a=new Array(this._channelFloor.length),r=new Array(this._channelFloor.length);r.fill(!1);for(let n=0;n<this._channelFloor.length;n++)a[n]=this._channelFloor[n].unpack(e,t,n),r[n]=!a[n].executeChannel,s[n].fill(0,0,i);for(let e=0;e<this._couplingAngle.length;e++)(a[this._couplingAngle[e]].executeChannel||a[this._couplingMangitude[e]].executeChannel)&&(a[this._couplingAngle[e]].forceEnergy=!0,a[this._couplingMangitude[e]].forceEnergy=!0);for(let i=0;i<this._submapFloor.length;i++){for(let e=0;e<this._channelFloor.length;e++)this._submapFloor[i]===this._channelFloor[e]&&this._submapResidue[i]===this._channelResidue[e]||(a[e].forceNoEnergy=!0);this._submapResidue[i].decode(e,r,t,s)}for(let e=this._couplingAngle.length-1;e>=0;e--)if(a[this._couplingAngle[e]].executeChannel||a[this._couplingMangitude[e]].executeChannel){const t=s[this._couplingMangitude[e]],a=s[this._couplingAngle[e]];for(let e=0;e<i;e++){let s,i;const r=t[e],n=a[e];r>0?n>0?(s=r,i=r-n):(i=r,s=r+n):n>0?(s=r,i=r+n):(i=r,s=r-n),t[e]=s,a[e]=i}}for(let e=0;e<this._channelFloor.length;e++)a[e].executeChannel?(this._channelFloor[e].apply(a[e],t,s[e]),this._mdct.reverse(s[e],t)):s[e].fill(0,i,2*i)}}class qi{constructor(){this.packetStartIndex=0,this.packetTotalLength=0,this.packetValidLength=0}}class ji{constructor(){this.overlapInfo=new qi,this.windowIndex=0}}class Ki{constructor(e=null){this.samplePosition=null,this.samplePosition=e}}class Qi{constructor(t,s,i,a,r){if(this._overlapInfo=null,this._channels=s,this._blockFlag=t.readBit(),0!==t.readBits(32))throw new O(e.AlphaTabErrorType.Format,"Vorbis: Mode header had invalid window or transform type!");const n=t.readBits(8);if(n>=r.length)throw new O(e.AlphaTabErrorType.Format,"Vorbis: Mode header had invalid mapping index!");this._mapping=r[n],this._blockFlag?(this._blockSize=a,this._windows=[Qi.calcWindow(i,a,i),Qi.calcWindow(a,a,i),Qi.calcWindow(i,a,a),Qi.calcWindow(a,a,a)],this._overlapInfo=[Qi.calcOverlap(i,a,i),Qi.calcOverlap(a,a,i),Qi.calcOverlap(i,a,a),Qi.calcOverlap(a,a,a)]):(this._blockSize=i,this._windows=[Qi.calcWindow(i,i,i)])}decode(e,t){const s=this.getPacketInfo(e);this._mapping.decodePacket(e,this._blockSize,t);const i=this._windows[s.windowIndex];for(let e=0;e<this._blockSize;e++)for(let s=0;s<this._channels;s++)t[s][e]*=i[e];return s.overlapInfo}getPacketInfo(e){const t=new ji;if(this._blockFlag){const s=e.readBit(),i=e.readBit();t.windowIndex=(s?1:0)+(i?2:0);const a=this._overlapInfo[t.windowIndex];t.overlapInfo.packetStartIndex=a.packetStartIndex,t.overlapInfo.packetValidLength=a.packetValidLength,t.overlapInfo.packetTotalLength=a.packetTotalLength}else t.windowIndex=0,t.overlapInfo.packetStartIndex=0,t.overlapInfo.packetValidLength=this._blockSize/2,t.overlapInfo.packetTotalLength=this._blockSize;return t}static calcWindow(e,t,s){const i=new Float32Array(t),a=e/2,r=s/2,n=t/4-a/2,o=t-t/4-r/2;for(let e=0;e<a;e++){let t=Math.sin((e+.5)/a*Qi.M_PI2);t*=t,i[n+e]=Math.sin(t*Qi.M_PI2)}for(let e=n+a;e<o;e++)i[e]=1;for(let e=0;e<r;e++){let t=Math.sin((r-e-.5)/r*Qi.M_PI2);t*=t,i[o+e]=Math.sin(t*Qi.M_PI2)}return i}static calcOverlap(e,t,s){const i=s/4,a=t/4-e/4,r=t/4*3+i,n=r-2*i,o=new qi;return o.packetStartIndex=a,o.packetValidLength=n,o.packetTotalLength=r,o}}Qi.M_PI2=1.57079632695;class Zi{constructor(e){this._n=e,this._n2=e>>1,this._n4=this._n2>>1,this._n8=this._n4>>1,this._ld=Ci.ilog(e)-1,this._a=new Float32Array(this._n2),this._b=new Float32Array(this._n2),this._c=new Float32Array(this._n4);let t=0,s=0;for(;t<this._n4;++t,s+=2)this._a[s]=Math.cos(4*t*Zi.M_PI/e),this._a[s+1]=-Math.sin(4*t*Zi.M_PI/e),this._b[s]=.5*Math.cos((s+1)*Zi.M_PI/e/2),this._b[s+1]=.5*Math.sin((s+1)*Zi.M_PI/e/2);for(t=0,s=0;t<this._n8;++t,s+=2)this._c[s]=Math.cos(2*(s+1)*Zi.M_PI/e),this._c[s+1]=-Math.sin(2*(s+1)*Zi.M_PI/e);this._bitrev=new Uint16Array(this._n8);for(let e=0;e<this._n8;++e)this._bitrev[e]=ct.int32ToUint16(Ci.bitReverse(e,this._ld-3)<<2)}calcReverse(e){let t,s;const i=new Float32Array(this._n2);{let t=this._n2-2,s=0,a=0;const r=this._n2;for(;a!==r;)i[t+1]=e[a]*this._a[s]-e[a+2]*this._a[s+1],i[t]=e[a]*this._a[s+1]+e[a+2]*this._a[s],t-=2,s+=2,a+=4;for(a=this._n2-3;t>=0;)i[t+1]=-e[a+2]*this._a[s]- -e[a]*this._a[s+1],i[t]=-e[a+2]*this._a[s+1]+-e[a]*this._a[s],t-=2,s+=2,a-=4}t=e,s=i;{let e=this._n2-8,i=this._n4,a=0,r=this._n4,n=0;for(;e>=0;){let o,h;h=s[i+1]-s[a+1],o=s[i]-s[a],t[r+1]=s[i+1]+s[a+1],t[r]=s[i]+s[a],t[n+1]=h*this._a[e+4]-o*this._a[e+5],t[n]=o*this._a[e+4]+h*this._a[e+5],h=s[i+3]-s[a+3],o=s[i+2]-s[a+2],t[r+3]=s[i+3]+s[a+3],t[r+2]=s[i+2]+s[a+2],t[n+3]=h*this._a[e]-o*this._a[e+1],t[n+2]=o*this._a[e]+h*this._a[e+1],e-=8,r+=4,n+=4,i+=4,a+=4}}this.step3_iter0_loop(this._n>>4,t,this._n2-1-0*this._n4,-this._n8),this.step3_iter0_loop(this._n>>4,t,this._n2-1-1*this._n4,-this._n8),this.step3_inner_r_loop(this._n>>5,t,this._n2-1-0*this._n8,-(this._n>>4),16),this.step3_inner_r_loop(this._n>>5,t,this._n2-1-1*this._n8,-(this._n>>4),16),this.step3_inner_r_loop(this._n>>5,t,this._n2-1-2*this._n8,-(this._n>>4),16),this.step3_inner_r_loop(this._n>>5,t,this._n2-1-3*this._n8,-(this._n>>4),16);let a=2;for(;a<this._ld-3>>1;++a){const e=this._n>>a+2,s=e>>1,i=1<<a+1;for(let r=0;r<i;++r)this.step3_inner_r_loop(this._n>>a+4,t,this._n2-1-e*r,-s,1<<a+3)}for(;a<this._ld-6;++a){const e=this._n>>a+2,s=1<<a+3,i=e>>1,r=this._n>>a+6,n=1<<a+1;let o=this._n2-1,h=0;for(let a=r;a>0;--a)this.step3_inner_s_loop(n,t,o,-i,h,s,e),h+=4*s,o-=8}this.step3_inner_s_loop_ld654(this._n>>5,t,this._n2-1,this._n);{let e=0,i=this._n4-4,a=this._n2-4;for(;i>=0;){let r;r=this._bitrev[e],s[a+3]=t[r],s[a+2]=t[r+1],s[i+3]=t[r+2],s[i+2]=t[r+3],r=this._bitrev[e+1],s[a+1]=t[r],s[a]=t[r+1],s[i+1]=t[r+2],s[i]=t[r+3],i-=4,a-=4,e+=2}}{let e=0,t=0,i=this._n2-4;for(;t<i;){let a,r,n,o,h,l;a=s[t]-s[i+2],r=s[t+1]+s[i+3],n=this._c[e+1]*a+this._c[e]*r,o=this._c[e+1]*r-this._c[e]*a,h=s[t]+s[i+2],l=s[t+1]-s[i+3],s[t]=h+n,s[t+1]=l+o,s[i+2]=h-n,s[i+3]=o-l,a=s[t+2]-s[i],r=s[t+3]+s[i+1],n=this._c[e+3]*a+this._c[e+2]*r,o=this._c[e+3]*r-this._c[e+2]*a,h=s[t+2]+s[i],l=s[t+3]-s[i+1],s[t+2]=h+n,s[t+3]=l+o,s[i]=h-n,s[i+1]=o-l,e+=4,t+=4,i-=4}}{let t=this._n2-8,s=this._n2-8,a=0,r=this._n2-4,n=this._n2,o=this._n-4;for(;s>=0;){let h,l,c,d;d=i[s+6]*this._b[t+7]-i[s+7]*this._b[t+6],c=-i[s+6]*this._b[t+6]-i[s+7]*this._b[t+7],e[a]=d,e[r+3]=-d,e[n]=c,e[o+3]=c,l=i[s+4]*this._b[t+5]-i[s+5]*this._b[t+4],h=-i[s+4]*this._b[t+4]-i[s+5]*this._b[t+5],e[a+1]=l,e[r+2]=-l,e[n+1]=h,e[o+2]=h,d=i[s+2]*this._b[t+3]-i[s+3]*this._b[t+2],c=-i[s+2]*this._b[t+2]-i[s+3]*this._b[t+3],e[a+2]=d,e[r+1]=-d,e[n+2]=c,e[o+1]=c,l=i[s]*this._b[t+1]-i[s+1]*this._b[t],h=-i[s]*this._b[t]-i[s+1]*this._b[t+1],e[a+3]=l,e[r]=-l,e[n+3]=h,e[o]=h,t-=8,s-=8,a+=4,n+=4,r-=4,o-=4}}}step3_inner_r_loop(e,t,s,i,a){let r,n,o=s,h=o+i,l=0;for(let s=e>>2;s>0;--s)r=t[o]-t[h],n=t[o-1]-t[h-1],t[o]+=t[h],t[o-1]+=t[h-1],t[h]=r*this._a[l]-n*this._a[l+1],t[h-1]=n*this._a[l]+r*this._a[l+1],l+=a,r=t[o-2]-t[h-2],n=t[o-3]-t[h-3],t[o-2]+=t[h-2],t[o-3]+=t[h-3],t[h-2]=r*this._a[l]-n*this._a[l+1],t[h-3]=n*this._a[l]+r*this._a[l+1],l+=a,r=t[o-4]-t[h-4],n=t[o-5]-t[h-5],t[o-4]+=t[h-4],t[o-5]+=t[h-5],t[h-4]=r*this._a[l]-n*this._a[l+1],t[h-5]=n*this._a[l]+r*this._a[l+1],l+=a,r=t[o-6]-t[h-6],n=t[o-7]-t[h-7],t[o-6]+=t[h-6],t[o-7]+=t[h-7],t[h-6]=r*this._a[l]-n*this._a[l+1],t[h-7]=n*this._a[l]+r*this._a[l+1],l+=a,o-=8,h-=8}step3_iter0_loop(e,t,s,i){let a=s,r=a+i,n=0;for(let s=e>>2;s>0;--s){let e,s;e=t[a]-t[r],s=t[a-1]-t[r-1],t[a]+=t[r],t[a-1]+=t[r-1],t[r]=e*this._a[n]-s*this._a[n+1],t[r-1]=s*this._a[n]+e*this._a[n+1],n+=8,e=t[a-2]-t[r-2],s=t[a-3]-t[r-3],t[a-2]+=t[r-2],t[a-3]+=t[r-3],t[r-2]=e*this._a[n]-s*this._a[n+1],t[r-3]=s*this._a[n]+e*this._a[n+1],n+=8,e=t[a-4]-t[r-4],s=t[a-5]-t[r-5],t[a-4]+=t[r-4],t[a-5]+=t[r-5],t[r-4]=e*this._a[n]-s*this._a[n+1],t[r-5]=s*this._a[n]+e*this._a[n+1],n+=8,e=t[a-6]-t[r-6],s=t[a-7]-t[r-7],t[a-6]+=t[r-6],t[a-7]+=t[r-7],t[r-6]=e*this._a[n]-s*this._a[n+1],t[r-7]=s*this._a[n]+e*this._a[n+1],n+=8,a-=8,r-=8}}step3_inner_s_loop(e,t,s,i,a,r,n){const o=this._a[a],h=this._a[a+1],l=this._a[a+r],c=this._a[a+r+1],d=this._a[a+2*r],u=this._a[a+2*r+1],p=this._a[a+3*r],m=this._a[a+3*r+1];let g,f,y=s,b=y+i;for(let s=e;s>0;--s)g=t[y]-t[b],f=t[y-1]-t[b-1],t[y]+=t[b],t[y-1]+=t[b-1],t[b]=g*o-f*h,t[b-1]=f*o+g*h,g=t[y-2]-t[b-2],f=t[y-3]-t[b-3],t[y-2]+=t[b-2],t[y-3]+=t[b-3],t[b-2]=g*l-f*c,t[b-3]=f*l+g*c,g=t[y-4]-t[b-4],f=t[y-5]-t[b-5],t[y-4]+=t[b-4],t[y-5]+=t[b-5],t[b-4]=g*d-f*u,t[b-5]=f*d+g*u,g=t[y-6]-t[b-6],f=t[y-7]-t[b-7],t[y-6]+=t[b-6],t[y-7]+=t[b-7],t[b-6]=g*p-f*m,t[b-7]=f*p+g*m,y-=n,b-=n}step3_inner_s_loop_ld654(e,t,s,i){const a=i>>3,r=this._a[a];let n=s;const o=n-16*e;for(;n>o;){let e,s;e=t[n]-t[n-8],s=t[n-1]-t[n-9],t[n]+=t[n-8],t[n-1]+=t[n-9],t[n-8]=e,t[n-9]=s,e=t[n-2]-t[n-10],s=t[n-3]-t[n-11],t[n-2]+=t[n-10],t[n-3]+=t[n-11],t[n-10]=(e+s)*r,t[n-11]=(s-e)*r,e=t[n-12]-t[n-4],s=t[n-5]-t[n-13],t[n-4]+=t[n-12],t[n-5]+=t[n-13],t[n-12]=s,t[n-13]=e,e=t[n-14]-t[n-6],s=t[n-7]-t[n-15],t[n-6]+=t[n-14],t[n-7]+=t[n-15],t[n-14]=(e+s)*r,t[n-15]=(e-s)*r,this.iter_54(t,n),this.iter_54(t,n-8),n-=16}}iter_54(e,t){const s=e[t]-e[t-4],i=e[t]+e[t-4],a=e[t-2]+e[t-6],r=e[t-2]-e[t-6];e[t]=i+a,e[t-2]=i-a;const n=e[t-3]-e[t-7];e[t-4]=s+n,e[t-6]=s-n;const o=e[t-1]-e[t-5],h=e[t-1]+e[t-5],l=e[t-3]+e[t-7];e[t-1]=h+l,e[t-3]=h-l,e[t-5]=o-r,e[t-7]=o+r}}Zi.M_PI=3.141592653589793;class ea{constructor(){this._setupCache=new Map}reverse(e,t){let s;this._setupCache.has(t)?s=this._setupCache.get(t):(s=new Zi(t),this._setupCache.set(t,s)),s.calcReverse(e)}}class ta{constructor(e,t,s){this._packetIndex=0,this._stream=e,this._setup=t,this._packets=s,this._currentPosition=0,this._prevPacketBuf=null,this._prevPacketStart=0,this._prevPacketEnd=0,this._prevPacketStop=0,this._nextPacketBuf=null,this._eosFound=!1,this._hasPosition=!1,this._modeFieldBits=Ci.ilog(t.modes.length-1)}decode(){let e=new Float32Array(this._packets[this._packets.length-1].granulePosition*this._stream.audioChannels);const t=new Float32Array(.2*this._stream.audioSampleRate*this._stream.audioChannels);let s=0,i=0;for(;s=this.read(t,0,t.length),0!==s;){if(i+s>=e.length){const s=new Float32Array(e.length+t.length);s.set(e,0),e=s}e.set(t.subarray(0,s),i),i+=s}return e.subarray(0,i)}read(e,t,s){if(0===s)return 0;let i=t;const a=t+s;for(;i<a;){if(this._prevPacketStart===this._prevPacketEnd){if(this._eosFound){this._nextPacketBuf=null,this._prevPacketBuf=null;break}const e=this.readNextPacket((i-t)/this._stream.audioChannels);null===e&&(this._prevPacketEnd=this._prevPacketStop),null===e||null===e.samplePosition||this._hasPosition||(this._hasPosition=!0,this._currentPosition=e.samplePosition-(this._prevPacketEnd-this._prevPacketStart)-(i-t)/this._stream.audioChannels)}const s=Math.min((a-i)/this._stream.audioChannels,this._prevPacketEnd-this._prevPacketStart);s>0&&(i+=this.copyBuffer(e,i,s))}return s=i-t,this._currentPosition+=s/this._stream.audioChannels,s}copyBuffer(e,t,s){let i=t;for(;s>0;this._prevPacketStart++,s--)for(let t=0;t<this._stream.audioChannels;t++)e[i++]=this._prevPacketBuf[t][this._prevPacketStart];return i-t}readNextPacket(e){const t=this.decodeNextPacket();if(this._eosFound=this._eosFound||t.isEndOfStream,null==t.curPacket)return null;if(null!==t.samplePosition&&t.isEndOfStream){const s=this._currentPosition+e+t.validLen-t.startIndex,i=t.samplePosition-s;i<0&&(t.validLen+=i,t.validLen<0&&(t.validLen=0))}return this._prevPacketEnd>0?(ta.overlapBuffers(this._prevPacketBuf,t.curPacket,this._prevPacketStart,this._prevPacketStop,t.startIndex,this._stream.audioChannels),this._prevPacketStart=t.startIndex):null==this._prevPacketBuf&&(this._prevPacketStart=t.validLen),this._nextPacketBuf=this._prevPacketBuf,this._prevPacketEnd=t.validLen,this._prevPacketStop=t.totalLen,this._prevPacketBuf=t.curPacket,new Ki(t.samplePosition)}static overlapBuffers(e,t,s,i,a,r){for(;s<i;s++,a++)for(let i=0;i<r;i++)t[i][a]+=e[i][s]}decodeNextPacket(){const e=new sa;let t=null;if(this._packetIndex>=this._packets.length)e.isEndOfStream=!0;else{t=this._packets[this._packetIndex++];const s=new Mi(ut.fromBuffer(t.packetData));if(e.isEndOfStream=t.isEndOfStream,!s.readBit()){const i=this._setup.modes[s.readBits(this._modeFieldBits)];if(null==this._nextPacketBuf){this._nextPacketBuf=new Array(this._stream.audioChannels);for(let e=0;e<this._stream.audioChannels;e++)this._nextPacketBuf[e]=new Float32Array(this._stream.blocksize1)}const a=i.decode(s,this._nextPacketBuf);return e.startIndex=a.packetStartIndex,e.validLen=a.packetValidLength,e.totalLen=a.packetTotalLength,e.samplePosition=t.granulePosition,e.curPacket=this._nextPacketBuf,e}}return e}}class sa{constructor(){this.curPacket=null,this.startIndex=0,this.validLen=0,this.totalLen=0,this.isEndOfStream=!1,this.samplePosition=null}}!function(e){e[e.IdentificationHeader=1]="IdentificationHeader",e[e.Comment=3]="Comment",e[e.SetupHeader=5]="SetupHeader"}(Dt||(Dt={}));class ia{constructor(e){this._packetIndex=-1,this._packets=e}read(){let e;for(;;){if(e=this.nextPacket(),null==e)return null;if(e.isBeginningOfStream){const t=this.readStream(e);if(null!=t)return t}}}nextPacket(){return this._packetIndex++,this._packetIndex<this._packets.length?this._packets[this._packetIndex]:null}readStream(e){const t=new vi;if(!this.readIdentificationHeader(t,e))return null;if(!this.readComments(this.nextPacket()))return null;const s=new Fi;if(!this.readSetupHeader(t,s,this.nextPacket()))return null;const i=[];let a;for(;a=this.nextPacket(),null!=a&&(i.push(a),!a.isEndOfStream););const r=new ta(t,s,i);return t.samples=r.decode(),t}comonHeaderDecode(e,t){const s=new Uint8Array(7);if(t.read(s,0,s.length),s[0]!==e)return!1;for(let e=0;e<ia.VorbisHeaderMarker.length;e++)if(s[1+e]!==ia.VorbisHeaderMarker[e])return!1;return!0}comonHeaderDecodeBit(e,t){const s=t.readBytes(7);if(s[0]!==e)return!1;for(let e=0;e<ia.VorbisHeaderMarker.length;e++)if(s[1+e]!==ia.VorbisHeaderMarker[e])return!1;return!0}readIdentificationHeader(e,t){const s=ut.fromBuffer(t.packetData);if(!this.comonHeaderDecode(Dt.IdentificationHeader,s))return!1;if(0!==dt.readUInt32LE(s))return!1;if(e.audioChannels=s.readByte(),e.audioSampleRate=dt.readUInt32LE(s),e.audioChannels<=0||e.audioSampleRate<=0)return!1;e.bitrateMaximum=dt.readInt32LE(s),e.bitrateNominal=dt.readInt32LE(s),e.bitrateMinimum=dt.readInt32LE(s);const i=s.readByte();if(e.blocksize0=1<<(15&i),e.blocksize1=1<<(i>>4),e.blocksize0>e.blocksize1||!ia.isAllowedBlockSize(e.blocksize0)||!ia.isAllowedBlockSize(e.blocksize0))return!1;return 0!==s.readByte()}static isAllowedBlockSize(e){switch(e){case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:return!0;default:return!1}}readComments(e){if(null==e)return!1;const t=ut.fromBuffer(e.packetData);if(!this.comonHeaderDecode(Dt.Comment,t))return!1;const s=dt.readUInt32LE(t);t.skip(s);const i=dt.readUInt32LE(t);for(let e=0;e<i;e++){const e=dt.readUInt32LE(t);t.skip(e)}return 0!==t.readByte()}readSetupHeader(e,t,s){if(null==s)return!1;const i=new Mi(ut.fromBuffer(s.packetData)),a=new ea,r=new Ri;if(!this.comonHeaderDecodeBit(Dt.SetupHeader,i))return!1;let n=i.readByte()+1;for(let e=0;e<n;e++)t.codebooks.push(new Ii(i,r));n=i.readBits(6)+1;for(let e=0;e<n;e++)t.timeDomainTransforms.push(new Oi(i));n=i.readBits(6)+1;for(let s=0;s<n;s++)t.floors.push(new Ui(i,e.blocksize0,e.blocksize1,t.codebooks));n=i.readBits(6)+1;for(let s=0;s<n;s++)t.residues.push(new Ji(i,e.audioChannels,t.codebooks));n=i.readBits(6)+1;for(let s=0;s<n;s++)t.mappings.push(new $i(i,e.audioChannels,t.floors,t.residues,a));n=i.readBits(6)+1;for(let s=0;s<n;s++)t.modes.push(new Qi(i,e.audioChannels,e.blocksize0,e.blocksize1,t.mappings));return!!i.readBit()}}ia.VorbisHeaderMarker=new Uint8Array(["v".charCodeAt(0),"o".charCodeAt(0),"r".charCodeAt(0),"b".charCodeAt(0),"i".charCodeAt(0),"s".charCodeAt(0)]);class aa{constructor(e){this.streams=[];const t=new Pi(e).read(),s=new ia(t);for(;;){const e=s.read();if(null==e)break;this.streams.push(e)}}}class ra{constructor(){this.phdrs=[],this.pbags=[],this.pmods=[],this.pgens=[],this.insts=[],this.ibags=[],this.imods=[],this.igens=[],this.sHdrs=[],this.sampleData=new Uint8Array(0),this._sampleCache=new Map}decodeSamples(e,t,s){const i=`${e}_${t}_${s}`;if(!this._sampleCache.has(i)){let a;const r=this.sampleData.slice(e,t);if(s){a=new aa(ut.fromBuffer(r)).streams[0].samples}else{const e=new DataView(r.buffer,r.byteOffset,r.length);a=new Float32Array(r.length/2);for(let t=0;t<a.length;t++)a[t]=e.getInt16(2*t,!0)/32767}return this._sampleCache.set(i,a),a}return this._sampleCache.get(i)}load(e){const t=new xi,s=new xi;if(!xi.load(null,t,e)||"sfbk"!==t.id)throw new it("Soundfont is not a valid Soundfont2 file");for(;xi.load(t,s,e);){const t=new xi;if("pdta"===s.id)for(;xi.load(s,t,e);)switch(t.id){case"phdr":for(let s=0,i=t.size/ua.SizeInFile|0;s<i;s++)this.phdrs.push(new ua(e));break;case"pbag":for(let s=0,i=t.size/ca.SizeInFile|0;s<i;s++)this.pbags.push(new ca(e));break;case"pmod":for(let s=0,i=t.size/pa.SizeInFile|0;s<i;s++)this.pmods.push(new pa(e));break;case"pgen":for(let s=0,i=t.size/da.SizeInFile|0;s<i;s++)this.pgens.push(new da(e));break;case"inst":for(let s=0,i=t.size/la.SizeInFile|0;s<i;s++)this.insts.push(new la(e));break;case"ibag":for(let s=0,i=t.size/na.SizeInFile|0;s<i;s++)this.ibags.push(new na(e));break;case"imod":for(let s=0,i=t.size/oa.SizeInFile|0;s<i;s++)this.imods.push(new oa(e));break;case"igen":for(let s=0,i=t.size/ha.SizeInFile|0;s<i;s++)this.igens.push(new ha(e));break;case"shdr":for(let s=0,i=t.size/ma.SizeInFile|0;s<i;s++)this.sHdrs.push(new ma(e));break;default:e.position+=t.size}else if("sdta"===s.id)for(;xi.load(s,t,e);)if("smpl"===t.id)this.sampleData=new Uint8Array(t.size),e.read(this.sampleData,0,t.size);else e.position+=t.size;else e.position+=s.size}}}class na{constructor(e){this.instGenNdx=dt.readUInt16LE(e),this.instModNdx=dt.readUInt16LE(e)}}na.SizeInFile=4;class oa{constructor(e){this.modSrcOper=dt.readUInt16LE(e),this.modDestOper=dt.readUInt16LE(e),this.modAmount=dt.readInt16LE(e),this.modAmtSrcOper=dt.readUInt16LE(e),this.modTransOper=dt.readUInt16LE(e)}}oa.SizeInFile=10;class ha{constructor(e){this.genOper=dt.readUInt16LE(e),this.genAmount=new ga(e)}}ha.SizeInFile=4;class la{constructor(e){this.instName=dt.read8BitStringLength(e,20),this.instBagNdx=dt.readUInt16LE(e)}}la.SizeInFile=22;class ca{constructor(e){this.genNdx=dt.readUInt16LE(e),this.modNdx=dt.readUInt16LE(e)}}ca.SizeInFile=4;class da{constructor(e){this.genOper=dt.readUInt16LE(e),this.genAmount=new ga(e)}}da.SizeInFile=4,da.GenInstrument=41,da.GenKeyRange=43,da.GenVelRange=44,da.GenSampleId=53;class ua{constructor(e){this.presetName=dt.read8BitStringLength(e,20),this.preset=dt.readUInt16LE(e),this.bank=dt.readUInt16LE(e),this.presetBagNdx=dt.readUInt16LE(e),this.library=dt.readUInt32LE(e),this.genre=dt.readUInt32LE(e),this.morphology=dt.readUInt32LE(e)}}ua.SizeInFile=38;class pa{constructor(e){this.modSrcOper=dt.readUInt16LE(e),this.modDestOper=dt.readUInt16LE(e),this.modAmount=dt.readUInt16LE(e),this.modAmtSrcOper=dt.readUInt16LE(e),this.modTransOper=dt.readUInt16LE(e)}}pa.SizeInFile=10;class ma{constructor(e){this.sampleName=dt.read8BitStringLength(e,20),this.start=dt.readUInt32LE(e),this.end=dt.readUInt32LE(e),this.startLoop=dt.readUInt32LE(e),this.endLoop=dt.readUInt32LE(e),this.sampleRate=dt.readUInt32LE(e),this.originalPitch=e.readByte(),this.pitchCorrection=dt.readSInt8(e),this.sampleLink=dt.readUInt16LE(e),this.sampleType=dt.readUInt16LE(e)}}ma.SizeInFile=46;class ga{get shortAmount(){return ct.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return 255&this.wordAmount}get highByteAmount(){return(65280&this.wordAmount)>>8&255}constructor(e){this.wordAmount=dt.readUInt16LE(e)}}class fa{constructor(){this.presetIndex=0,this.bank=0,this.pitchWheel=0,this.perNotePitchWheel=new Map,this.midiPan=0,this.midiVolume=0,this.midiExpression=0,this.midiRpn=0,this.midiData=0,this.panOffset=0,this.gainDb=0,this.pitchRange=0,this.tuning=0,this.mixVolume=0,this.mute=!1,this.solo=!1}}class ya{constructor(){this.activeChannel=0,this.channelList=[]}setupVoice(e,t){const s=this.channelList[this.activeChannel],i=t.region.pan+s.panOffset;t.playingChannel=this.activeChannel,t.mixVolume=s.mixVolume,t.noteGainDb+=s.gainDb,t.updatePitchRatio(s,e.outSampleRate),i<=-.5?(t.panFactorLeft=1,t.panFactorRight=0):i>=.5?(t.panFactorLeft=0,t.panFactorRight=1):(t.panFactorLeft=Math.sqrt(.5-i),t.panFactorRight=Math.sqrt(.5+i))}}!function(e){e[e.None=0]="None",e[e.Continuous=1]="Continuous",e[e.Sustain=2]="Sustain"}(Lt||(Lt={})),function(e){e[e.StereoInterleaved=0]="StereoInterleaved",e[e.StereoUnweaved=1]="StereoUnweaved",e[e.Mono=2]="Mono"}(It||(It={}));class ba{constructor(){this.name="",this.presetNumber=0,this.bank=0,this.regions=null}}class Sa{static timecents2Secs(e){return Math.pow(2,e/1200)}static decibelsToGain(e){return e>-100?Math.pow(10,.05*e):0}static gainToDecibels(e){return e<=1e-5?-100:20*Math.log10(e)}static cents2Hertz(e){return 8.176*Math.pow(2,e/1200)}}class wa{constructor(e){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0,e&&(this.delay=e.delay,this.attack=e.attack,this.hold=e.hold,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.keynumToHold=e.keynumToHold,this.keynumToDecay=e.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(e){this.delay=this.delay<-11950?0:Sa.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:Sa.timecents2Secs(this.attack),this.release=this.release<-11950?0:Sa.timecents2Secs(this.release),0===this.keynumToHold&&(this.hold=this.hold<-11950?0:Sa.timecents2Secs(this.hold)),0===this.keynumToDecay&&(this.decay=this.decay<-11950?0:Sa.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:this.sustain=e?Sa.decibelsToGain(-this.sustain/10):1-this.sustain/1e3}}!function(e){e[e.StartAddrsOffset=0]="StartAddrsOffset",e[e.EndAddrsOffset=1]="EndAddrsOffset",e[e.StartloopAddrsOffset=2]="StartloopAddrsOffset",e[e.EndloopAddrsOffset=3]="EndloopAddrsOffset",e[e.StartAddrsCoarseOffset=4]="StartAddrsCoarseOffset",e[e.ModLfoToPitch=5]="ModLfoToPitch",e[e.VibLfoToPitch=6]="VibLfoToPitch",e[e.ModEnvToPitch=7]="ModEnvToPitch",e[e.InitialFilterFc=8]="InitialFilterFc",e[e.InitialFilterQ=9]="InitialFilterQ",e[e.ModLfoToFilterFc=10]="ModLfoToFilterFc",e[e.ModEnvToFilterFc=11]="ModEnvToFilterFc",e[e.EndAddrsCoarseOffset=12]="EndAddrsCoarseOffset",e[e.ModLfoToVolume=13]="ModLfoToVolume",e[e.Unused1=14]="Unused1",e[e.ChorusEffectsSend=15]="ChorusEffectsSend",e[e.ReverbEffectsSend=16]="ReverbEffectsSend",e[e.Pan=17]="Pan",e[e.Unused2=18]="Unused2",e[e.Unused3=19]="Unused3",e[e.Unused4=20]="Unused4",e[e.DelayModLFO=21]="DelayModLFO",e[e.FreqModLFO=22]="FreqModLFO",e[e.DelayVibLFO=23]="DelayVibLFO",e[e.FreqVibLFO=24]="FreqVibLFO",e[e.DelayModEnv=25]="DelayModEnv",e[e.AttackModEnv=26]="AttackModEnv",e[e.HoldModEnv=27]="HoldModEnv",e[e.DecayModEnv=28]="DecayModEnv",e[e.SustainModEnv=29]="SustainModEnv",e[e.ReleaseModEnv=30]="ReleaseModEnv",e[e.KeynumToModEnvHold=31]="KeynumToModEnvHold",e[e.KeynumToModEnvDecay=32]="KeynumToModEnvDecay",e[e.DelayVolEnv=33]="DelayVolEnv",e[e.AttackVolEnv=34]="AttackVolEnv",e[e.HoldVolEnv=35]="HoldVolEnv",e[e.DecayVolEnv=36]="DecayVolEnv",e[e.SustainVolEnv=37]="SustainVolEnv",e[e.ReleaseVolEnv=38]="ReleaseVolEnv",e[e.KeynumToVolEnvHold=39]="KeynumToVolEnvHold",e[e.KeynumToVolEnvDecay=40]="KeynumToVolEnvDecay",e[e.Instrument=41]="Instrument",e[e.Reserved1=42]="Reserved1",e[e.KeyRange=43]="KeyRange",e[e.VelRange=44]="VelRange",e[e.StartloopAddrsCoarseOffset=45]="StartloopAddrsCoarseOffset",e[e.Keynum=46]="Keynum",e[e.Velocity=47]="Velocity",e[e.InitialAttenuation=48]="InitialAttenuation",e[e.Reserved2=49]="Reserved2",e[e.EndloopAddrsCoarseOffset=50]="EndloopAddrsCoarseOffset",e[e.CoarseTune=51]="CoarseTune",e[e.FineTune=52]="FineTune",e[e.SampleID=53]="SampleID",e[e.SampleModes=54]="SampleModes",e[e.Reserved3=55]="Reserved3",e[e.ScaleTuning=56]="ScaleTuning",e[e.ExclusiveClass=57]="ExclusiveClass",e[e.OverridingRootKey=58]="OverridingRootKey",e[e.Unused5=59]="Unused5",e[e.EndOper=60]="EndOper"}(At||(At={}));class Ba{constructor(e){this.loopMode=Lt.None,this.samples=Ba.NoSamples,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv=new wa,this.modEnv=new wa,this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,e&&(this.loopMode=e.loopMode,this.samples=e.samples,this.sampleRate=e.sampleRate,this.loKey=e.loKey,this.hiKey=e.hiKey,this.loVel=e.loVel,this.hiVel=e.hiVel,this.group=e.group,this.offset=e.offset,this.end=e.end,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this.transpose=e.transpose,this.tune=e.tune,this.pitchKeyCenter=e.pitchKeyCenter,this.pitchKeyTrack=e.pitchKeyTrack,this.attenuation=e.attenuation,this.pan=e.pan,this.ampEnv=new wa(e.ampEnv),this.modEnv=new wa(e.modEnv),this.initialFilterQ=e.initialFilterQ,this.initialFilterFc=e.initialFilterFc,this.modEnvToPitch=e.modEnvToPitch,this.modEnvToFilterFc=e.modEnvToFilterFc,this.modLfoToFilterFc=e.modLfoToFilterFc,this.modLfoToVolume=e.modLfoToVolume,this.delayModLFO=e.delayModLFO,this.freqModLFO=e.freqModLFO,this.modLfoToPitch=e.modLfoToPitch,this.delayVibLFO=e.delayVibLFO,this.freqVibLFO=e.freqVibLFO,this.vibLfoToPitch=e.vibLfoToPitch)}clear(e){this.loopMode=Lt.None,this.samples=Ba.NoSamples,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,e||(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(e,t){switch(e){case At.StartAddrsOffset:this.offset+=ct.int16ToUint32(t.shortAmount);break;case At.EndAddrsOffset:this.end+=ct.int16ToUint32(t.shortAmount);break;case At.StartloopAddrsOffset:this.loopStart+=ct.int16ToUint32(t.shortAmount);break;case At.EndloopAddrsOffset:this.loopEnd+=ct.int16ToUint32(t.shortAmount);break;case At.StartAddrsCoarseOffset:this.offset+=32768*ct.int16ToUint32(t.shortAmount);break;case At.ModLfoToPitch:this.modLfoToPitch=t.shortAmount;break;case At.VibLfoToPitch:this.vibLfoToPitch=t.shortAmount;break;case At.ModEnvToPitch:this.modEnvToPitch=t.shortAmount;break;case At.InitialFilterFc:this.initialFilterFc=t.shortAmount;break;case At.InitialFilterQ:this.initialFilterQ=t.shortAmount;break;case At.ModLfoToFilterFc:this.modLfoToFilterFc=t.shortAmount;break;case At.ModEnvToFilterFc:this.modEnvToFilterFc=t.shortAmount;break;case At.EndAddrsCoarseOffset:this.end+=32768*ct.int16ToUint32(t.shortAmount);break;case At.ModLfoToVolume:this.modLfoToVolume=t.shortAmount;break;case At.Pan:this.pan=t.shortAmount/1e3;break;case At.DelayModLFO:this.delayModLFO=t.shortAmount;break;case At.FreqModLFO:this.freqModLFO=t.shortAmount;break;case At.DelayVibLFO:this.delayVibLFO=t.shortAmount;break;case At.FreqVibLFO:this.freqVibLFO=t.shortAmount;break;case At.DelayModEnv:this.modEnv.delay=t.shortAmount;break;case At.AttackModEnv:this.modEnv.attack=t.shortAmount;break;case At.HoldModEnv:this.modEnv.hold=t.shortAmount;break;case At.DecayModEnv:this.modEnv.decay=t.shortAmount;break;case At.SustainModEnv:this.modEnv.sustain=t.shortAmount;break;case At.ReleaseModEnv:this.modEnv.release=t.shortAmount;break;case At.KeynumToModEnvHold:this.modEnv.keynumToHold=t.shortAmount;break;case At.KeynumToModEnvDecay:this.modEnv.keynumToDecay=t.shortAmount;break;case At.DelayVolEnv:this.ampEnv.delay=t.shortAmount;break;case At.AttackVolEnv:this.ampEnv.attack=t.shortAmount;break;case At.HoldVolEnv:this.ampEnv.hold=t.shortAmount;break;case At.DecayVolEnv:this.ampEnv.decay=t.shortAmount;break;case At.SustainVolEnv:this.ampEnv.sustain=t.shortAmount;break;case At.ReleaseVolEnv:this.ampEnv.release=t.shortAmount;break;case At.KeynumToVolEnvHold:this.ampEnv.keynumToHold=t.shortAmount;break;case At.KeynumToVolEnvDecay:this.ampEnv.keynumToDecay=t.shortAmount;break;case At.KeyRange:this.loKey=t.lowByteAmount,this.hiKey=t.highByteAmount;break;case At.VelRange:this.loVel=t.lowByteAmount,this.hiVel=t.highByteAmount;break;case At.StartloopAddrsCoarseOffset:this.loopStart+=32768*ct.int16ToUint32(t.shortAmount);break;case At.InitialAttenuation:this.attenuation+=.1*t.shortAmount;break;case At.EndloopAddrsCoarseOffset:this.loopEnd+=32768*ct.int16ToUint32(t.shortAmount);break;case At.CoarseTune:this.transpose+=t.shortAmount;break;case At.FineTune:this.tune+=t.shortAmount;break;case At.SampleModes:this.loopMode=3&~t.wordAmount?1==(3&t.wordAmount)?Lt.Continuous:Lt.None:Lt.Sustain;break;case At.ScaleTuning:this.pitchKeyTrack=t.shortAmount;break;case At.ExclusiveClass:this.group=t.wordAmount;break;case At.OverridingRootKey:this.pitchKeyCenter=t.shortAmount}}}Ba.NoSamples=new Float32Array(0),function(e){e[e.None=0]="None",e[e.Delay=1]="Delay",e[e.Attack=2]="Attack",e[e.Hold=3]="Hold",e[e.Decay=4]="Decay",e[e.Sustain=5]="Sustain",e[e.Release=6]="Release",e[e.Done=7]="Done"}(Rt||(Rt={}));class ka{constructor(){this.level=0,this.slope=0,this.samplesUntilNextSegment=0,this.segment=Rt.None,this.midiVelocity=0,this.parameters=null,this.segmentIsExponential=!1,this.isAmpEnv=!1}nextSegment(e,t){if(this.parameters)for(;;)switch(e){case Rt.None:if(this.samplesUntilNextSegment=this.parameters.delay*t|0,this.samplesUntilNextSegment>0)return this.segment=Rt.Delay,this.segmentIsExponential=!1,this.level=0,void(this.slope=0);e=Rt.Delay;break;case Rt.Delay:if(this.samplesUntilNextSegment=this.parameters.attack*t|0,this.samplesUntilNextSegment>0)return this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*t|0),this.segment=Rt.Attack,this.segmentIsExponential=!1,this.level=0,void(this.slope=1/this.samplesUntilNextSegment);e=Rt.Attack;break;case Rt.Attack:if(this.samplesUntilNextSegment=this.parameters.hold*t|0,this.samplesUntilNextSegment>0)return this.segment=Rt.Hold,this.segmentIsExponential=!1,this.level=1,void(this.slope=0);e=Rt.Hold;break;case Rt.Hold:if(this.samplesUntilNextSegment=this.parameters.decay*t|0,this.samplesUntilNextSegment>0){if(this.segment=Rt.Decay,this.level=1,this.isAmpEnv){const e=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(e),this.segmentIsExponential=!0,this.parameters.sustain>0&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/e|0)}else this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*t|0,this.segmentIsExponential=!1;return}e=Rt.Decay;break;case Rt.Decay:return this.segment=Rt.Sustain,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,void(this.segmentIsExponential=!1);case Rt.Sustain:if(this.segment=Rt.Release,this.samplesUntilNextSegment=(this.parameters.release<=0?ka.FastReleaseTime:this.parameters.release)*t|0,this.isAmpEnv){const e=-9.226/this.samplesUntilNextSegment;this.slope=Math.exp(e),this.segmentIsExponential=!0}else this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1;return;default:return this.segment=Rt.Done,this.segmentIsExponential=!1,this.level=0,this.slope=0,void(this.samplesUntilNextSegment=134217727)}}setup(e,t,s,i,a){this.parameters=new wa(e),this.parameters.keynumToHold>0&&(this.parameters.hold+=this.parameters.keynumToHold*(60-t),this.parameters.hold=this.parameters.hold<-1e4?0:Sa.timecents2Secs(this.parameters.hold)),this.parameters.keynumToDecay>0&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-t),this.parameters.decay=this.parameters.decay<-1e4?0:Sa.timecents2Secs(this.parameters.decay)),this.midiVelocity=0|s,this.isAmpEnv=i,this.nextSegment(Rt.None,a)}process(e,t){this.slope>0&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,e):this.level+=this.slope*e),this.samplesUntilNextSegment-=e,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,t)}}ka.FastReleaseTime=.01;class Ta{constructor(){this.samplesUntil=0,this.level=0,this.delta=0}setup(e,t,s){this.samplesUntil=e*s|0,this.delta=4*Sa.cents2Hertz(t)/s,this.level=0}process(e){this.samplesUntil>e?this.samplesUntil-=e:(this.level+=this.delta*e,this.level>1?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level))}}class _a{constructor(e){this.qInv=0,this.a0=0,this.a1=0,this.b1=0,this.b2=0,this.z1=0,this.z2=0,this.active=!1,e&&(this.qInv=e.qInv,this.a0=e.a0,this.a1=e.a1,this.b1=e.b1,this.b2=e.b2,this.z1=e.z1,this.z2=e.z2,this.active=e.active)}setup(e){const t=Math.tan(Math.PI*e),s=t*t,i=1/(1+t*this.qInv+s);this.a0=s*i,this.a1=2*this.a0,this.b1=2*(s-1)*i,this.b2=(1-t*this.qInv+s)*i}process(e){const t=e*this.a0+this.z1;return this.z1=e*this.a1+this.z2-this.b1*t,this.z2=e*this.a0-this.b2*t,t}}class xa{constructor(){this.playingPreset=0,this.playingKey=0,this.playingChannel=0,this.region=null,this.pitchInputTimecents=0,this.pitchOutputFactor=0,this.sourceSamplePosition=0,this.noteGainDb=0,this.panFactorLeft=0,this.panFactorRight=0,this.playIndex=0,this.loopStart=0,this.loopEnd=0,this.ampEnv=new ka,this.modEnv=new ka,this.lowPass=new _a,this.modLfo=new Ta,this.vibLfo=new Ta,this.mixVolume=0,this.mute=!1}updatePitchRatio(e,t){let s=e.pitchWheel;e.perNotePitchWheel.has(this.playingKey)&&(s+=e.perNotePitchWheel.get(this.playingKey)-8192);const i=8192===s?e.tuning:s/16383*e.pitchRange*2-e.pitchRange+e.tuning;this.calcPitchRatio(i,t)}calcPitchRatio(e,t){if(!this.region)return;const s=this.playingKey+this.region.transpose+this.region.tune/100;let i=this.region.pitchKeyCenter+(s-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);0!==e&&(i+=e),this.pitchInputTimecents=100*i,this.pitchOutputFactor=this.region.sampleRate/(Sa.timecents2Secs(100*this.region.pitchKeyCenter)*t)}end(e){this.region&&(this.ampEnv.nextSegment(Rt.Sustain,e),this.modEnv.nextSegment(Rt.Sustain,e),this.region.loopMode===Lt.Sustain&&(this.loopEnd=this.loopStart))}endQuick(e){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(Rt.Sustain,e),this.modEnv.parameters.release=0,this.modEnv.nextSegment(Rt.Sustain,e)}render(e,t,s,i,a){if(!this.region)return;const r=this.region,n=r.samples;let o=0,h=e.outputMode===It.StereoUnweaved?i:-1;const l=0!==r.modEnvToPitch||0!==r.modEnvToFilterFc,c=this.modLfo.delta>0&&(0!==r.modLfoToPitch||0!==r.modLfoToFilterFc||0!==r.modLfoToVolume),d=this.vibLfo.delta>0&&0!==r.vibLfoToPitch,u=this.loopStart<this.loopEnd,p=this.loopStart,m=this.loopEnd,g=r.end,f=m+1;let y=this.sourceSamplePosition;const b=new _a(this.lowPass),S=0!==r.modLfoToFilterFc||0!==r.modEnvToFilterFc;let w=0,B=0,k=0,T=0;const _=0!==r.modLfoToPitch||0!==r.modEnvToPitch||0!==r.vibLfoToPitch;let x=0,N=0,P=0,v=0;const E=0!==r.modLfoToVolume;let M=0,F=0;for(S?(w=e.outSampleRate,B=r.initialFilterFc,k=r.modLfoToFilterFc,T=r.modEnvToFilterFc):(w=0,B=0,k=0,T=0),_?(x=0,N=r.modLfoToPitch,P=r.vibLfoToPitch,v=r.modEnvToPitch):(x=Sa.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,N=0,P=0,v=0),E?F=.1*r.modLfoToVolume:(M=Sa.decibelsToGain(this.noteGainDb),F=0);i>0;){let r,C,D=0,L=i>xa.RenderEffectSampleBlock?xa.RenderEffectSampleBlock:i;if(i-=L,S){const e=B+this.modLfo.level*k+this.modEnv.level*T;b.active=e<=13500,b.active&&b.setup(Sa.cents2Hertz(e)/w)}switch(_&&(x=Sa.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*N+this.vibLfo.level*P+this.modEnv.level*v))*this.pitchOutputFactor),E&&(M=Sa.decibelsToGain(this.noteGainDb+this.modLfo.level*F)),r=M*this.ampEnv.level,a?r=0:r*=this.mixVolume,this.ampEnv.process(L,e.outSampleRate),l&&this.modEnv.process(L,e.outSampleRate),c&&this.modLfo.process(L),d&&this.vibLfo.process(L),e.outputMode){case It.StereoInterleaved:for(C=r*this.panFactorLeft,D=r*this.panFactorRight;L-- >0&&y<g;){const e=0|y,i=e>=m&&u?p:e+1,a=y-e;let r=n[e]*(1-a)+n[i]*a;b.active&&(r=b.process(r)),t[s+o]+=r*C,o++,t[s+o]+=r*D,o++,y+=x,y>=f&&u&&(y-=m-p+1)}break;case It.StereoUnweaved:for(C=r*this.panFactorLeft,D=r*this.panFactorRight;L-- >0&&y<g;){const e=0|y,i=e>=m&&u?p:e+1,a=y-e;let r=n[e]*(1-a)+n[i]*a;b.active&&(r=b.process(r)),t[s+o]+=r*C,o++,t[s+h]+=r*D,h++,y+=x,y>=f&&u&&(y-=m-p+1)}break;case It.Mono:for(;L-- >0&&y<g;){const e=0|y,i=e>=m&&u?p:e+1,a=y-e;let h=n[e]*(1-a)+n[i]*a;b.active&&(h=b.process(h)),t[s+o]=h*r,o++,y+=x,y>=f&&u&&(y-=m-p+1)}}if(y>=g||this.ampEnv.segment===Rt.Done)return void this.kill()}this.sourceSamplePosition=y,(b.active||S)&&(this.lowPass=b)}kill(){this.playingPreset=-1}}xa.RenderEffectSampleBlock=se.MicroBufferSize;class Na{constructor(e){this.value=e}}class Pa{get isEmpty(){return void 0===this._head}clear(){this._head=void 0,this._tail=void 0}enqueue(e){const t=new Na(e);this._tail?(this._tail.next=t,this._tail=t):(this._head=t,this._tail=t)}peek(){const e=this._head;if(e)return e.value}dequeue(){const e=this._head;if(!e)return;const t=e.next;return this._head=t,t||(this._tail=void 0),e.value}}!function(e){e[e.BankSelectCoarse=0]="BankSelectCoarse",e[e.ModulationCoarse=1]="ModulationCoarse",e[e.DataEntryCoarse=6]="DataEntryCoarse",e[e.VolumeCoarse=7]="VolumeCoarse",e[e.PanCoarse=10]="PanCoarse",e[e.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",e[e.BankSelectFine=32]="BankSelectFine",e[e.ModulationFine=33]="ModulationFine",e[e.DataEntryFine=38]="DataEntryFine",e[e.VolumeFine=39]="VolumeFine",e[e.PanFine=42]="PanFine",e[e.ExpressionControllerFine=43]="ExpressionControllerFine",e[e.HoldPedal=64]="HoldPedal",e[e.LegatoPedal=68]="LegatoPedal",e[e.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",e[e.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",e[e.RegisteredParameterFine=100]="RegisteredParameterFine",e[e.RegisteredParameterCourse=101]="RegisteredParameterCourse",e[e.AllSoundOff=120]="AllSoundOff",e[e.ResetControllers=121]="ResetControllers",e[e.AllNotesOff=123]="AllNotesOff"}(Ot||(Ot={}));class va{constructor(e){this._midiEventQueue=new Pa,this._mutedChannels=new Map,this._soloChannels=new Map,this._isAnySolo=!1,this._transpositionPitches=new Map,this._liveTranspositionPitches=new Map,this.currentTempo=0,this.timeSignatureNumerator=0,this.timeSignatureDenominator=0,this.presets=null,this._voices=[],this._channels=null,this._voicePlayIndex=0,this.outputMode=It.StereoInterleaved,this.outSampleRate=0,this.globalGainDb=0,this.outSampleRate=e}synthesize(e,t,s){return this.fillWorkingBuffer(e,t,s)}synthesizeSilent(e){this.fillWorkingBuffer(null,0,e)}channelGetMixVolume(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].mixVolume:1}channelSetMixVolume(e,t){const s=this.channelInit(e);for(const s of this._voices)s.playingChannel===e&&-1!==s.playingPreset&&(s.mixVolume=t);s.mixVolume=t}channelSetMute(e,t){t?this._mutedChannels.set(e,!0):this._mutedChannels.delete(e)}channelSetSolo(e,t){t?this._soloChannels.set(e,!0):this._soloChannels.delete(e),this._isAnySolo=this._soloChannels.size>0}resetChannelStates(){this._mutedChannels=new Map,this._soloChannels=new Map,this._liveTranspositionPitches=new Map,this.applyTranspositionPitches(new Map),this._isAnySolo=!1}setChannelTranspositionPitch(e,t){let s=0;this._liveTranspositionPitches.has(e)&&(s=this._liveTranspositionPitches.get(e)),0===t?this._liveTranspositionPitches.delete(e):this._liveTranspositionPitches.set(e,t);for(const i of this._voices)if(i.playingChannel===e&&9!==i.playingChannel){let e=0;e-=s,e+=t,i.playingKey+=e,this._channels&&i.updatePitchRatio(this._channels.channelList[i.playingChannel],this.outSampleRate)}}applyTranspositionPitches(e){const t=this._transpositionPitches;for(const s of this._voices)if(s.playingChannel>=0&&9!==s.playingChannel){let i=0;t.has(s.playingChannel)&&(i-=t.get(s.playingChannel)),e.has(s.playingChannel)&&(i+=e.get(s.playingChannel)),s.playingKey+=i,this._channels&&s.updatePitchRatio(this._channels.channelList[s.playingChannel],this.outSampleRate)}this._transpositionPitches=e}dispatchEvent(e){this._midiEventQueue.enqueue(e)}fillWorkingBuffer(e,t,s){const i=this._isAnySolo,a=[];for(;!this._midiEventQueue.isEmpty;){const e=this._midiEventQueue.dequeue();e.isMetronome&&this.metronomeVolume>0?(this.channelNoteOff(se.MetronomeChannel,se.MetronomeKey),this.channelNoteOn(se.MetronomeChannel,se.MetronomeKey,95/127)):e.event&&this.processMidiMessage(e.event),a.push(e)}for(const a of this._voices)if(-1!==a.playingPreset){const r=a.playingChannel,n=this._mutedChannels.has(r)||i&&r!==se.MetronomeChannel&&!this._soloChannels.has(r);e?a.render(this,e,t,s,n):a.kill()}return a}processMidiMessage(e){switch(e.type){case Mt.TimeSignature:const t=e;this.timeSignatureNumerator=t.numerator,this.timeSignatureDenominator=Math.pow(2,t.denominatorIndex);break;case Mt.NoteOn:const s=e;this.channelNoteOn(s.channel,s.noteKey,s.noteVelocity/127);break;case Mt.NoteOff:const i=e;this.channelNoteOff(i.channel,i.noteKey);break;case Mt.ControlChange:const a=e;this.channelMidiControl(a.channel,a.controller,a.value);break;case Mt.ProgramChange:const r=e;this.channelSetPresetNumber(r.channel,r.program,9===r.channel);break;case Mt.TempoChange:const n=e;this.currentTempo=n.beatsPerMinute;break;case Mt.PitchBend:const o=e;this.channelSetPitchWheel(o.channel,o.value);break;case Mt.PerNotePitchBend:const h=e;let l=h.value;l=l*se.MaxPitchWheel/se.MaxPitchWheel20,this.channelSetPerNotePitchWheel(h.channel,h.noteKey,l)}}get metronomeVolume(){return this.channelGetMixVolume(se.MetronomeChannel)}set metronomeVolume(e){this.setupMetronomeChannel(e)}setupMetronomeChannel(e){this.channelSetMixVolume(se.MetronomeChannel,e),e>0&&(this.channelSetVolume(se.MetronomeChannel,1),this.channelSetPresetNumber(se.MetronomeChannel,0,!0))}get masterVolume(){return Sa.decibelsToGain(this.globalGainDb)}set masterVolume(e){const t=Sa.gainToDecibels(e),s=t-this.globalGainDb;if(0!==s){for(const e of this._voices)-1!==e.playingPreset&&(e.noteGainDb+=s);this.globalGainDb=t}}resetSoft(){for(const e of this._voices)-1!==e.playingPreset&&(e.ampEnv.segment<Rt.Release||0!==e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate);if(this._channels)for(const e of this._channels.channelList)e.presetIndex=0,e.bank=0,e.pitchWheel=8192,e.midiPan=8192,e.perNotePitchWheel.clear(),e.midiVolume=16383,e.midiExpression=16383,e.midiRpn=65535,e.midiData=0,e.panOffset=0,e.gainDb=0,e.pitchRange=2,e.tuning=0}get presetCount(){return this.presets?.length??0}reset(){for(const e of this._voices)-1!==e.playingPreset&&(e.ampEnv.segment<Rt.Release||0!==e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate);this._channels=null}setOutput(e,t,s){this.outputMode=e,this.outSampleRate=t>=1?t:44100,this.globalGainDb=s}noteOn(e,t,s){if(!this.presets)return;const i=127*s|0;if(e<0||e>=this.presets.length)return;if(s<=0)return void this.noteOff(e,t);const a=this._voicePlayIndex++;for(const r of this.presets[e].regions){if(t<r.loKey||t>r.hiKey||i<r.loVel||i>r.hiVel)continue;let n=null;if(0!==r.group)for(const t of this._voices)t.playingPreset===e&&t.region.group===r.group?t.endQuick(this.outSampleRate):-1!==t.playingPreset||n||(n=t);else for(const e of this._voices)-1===e.playingPreset&&(n=e);if(!n){for(let e=0;e<4;e++){const e=new xa;e.playingPreset=-1,this._voices.push(e)}n=this._voices[this._voices.length-4]}n.region=r,n.playingPreset=e,n.playingKey=t,n.playIndex=a,n.noteGainDb=this.globalGainDb-r.attenuation-Sa.gainToDecibels(1/s),this._channels?this._channels.setupVoice(this,n):(n.calcPitchRatio(0,this.outSampleRate),n.panFactorLeft=Math.sqrt(.5-r.pan),n.panFactorRight=Math.sqrt(.5+r.pan)),n.sourceSamplePosition=r.offset;const o=r.loopMode!==Lt.None&&r.loopStart<r.loopEnd;n.loopStart=o?r.loopStart:0,n.loopEnd=o?r.loopEnd:0,n.ampEnv.setup(r.ampEnv,t,i,!0,this.outSampleRate),n.modEnv.setup(r.modEnv,t,i,!1,this.outSampleRate);const h=r.initialFilterQ/10;n.lowPass.qInv=1/Math.pow(10,h/20),n.lowPass.z1=0,n.lowPass.z2=0,n.lowPass.active=r.initialFilterFc<=13500,n.lowPass.active&&n.lowPass.setup(Sa.cents2Hertz(r.initialFilterFc)/this.outSampleRate),n.modLfo.setup(r.delayModLFO,r.freqModLFO,this.outSampleRate),n.vibLfo.setup(r.delayVibLFO,r.freqVibLFO,this.outSampleRate)}}bankNoteOn(e,t,s,i){const a=this.getPresetIndex(e,t);return-1!==a&&(this.noteOn(a,s,i),!0)}noteOff(e,t){let s=null,i=null;const a=[];for(const r of this._voices)r.playingPreset!==e||r.playingKey!==t||r.ampEnv.segment>=Rt.Release||(!s||r.playIndex<s.playIndex?(s=r,i=r,a.push(r)):r.playIndex===s.playIndex&&(i=r,a.push(r)));if(s)for(const r of a)r!==s&&r!==i&&(r.playIndex!==s.playIndex||r.playingPreset!==e||r.playingKey!==t||r.ampEnv.segment>=Rt.Release)||r.end(this.outSampleRate)}bankNoteOff(e,t,s){const i=this.getPresetIndex(e,t);return-1!==i&&(this.noteOff(i,s),!0)}noteOffAll(e){for(const t of this._voices)-1!==t.playingPreset&&(e?t.endQuick(this.outSampleRate):t.ampEnv.segment<Rt.Release&&t.end(this.outSampleRate))}get activeVoiceCount(){let e=0;for(const t of this._voices)-1!==t.playingPreset&&e++;return e}channelInit(e){if(this._channels&&e<this._channels.channelList.length)return this._channels.channelList[e];this._channels||(this._channels=new ya);for(let t=this._channels.channelList.length;t<=e;t++){const e=new fa;e.presetIndex=0,e.bank=0,e.pitchWheel=8192,e.midiPan=8192,e.midiVolume=16383,e.midiExpression=16383,e.midiRpn=65535,e.midiData=0,e.panOffset=0,e.gainDb=0,e.pitchRange=2,e.tuning=0,e.mixVolume=1,this._channels.channelList.push(e)}return this._channels.channelList[e]}getPresetIndex(e,t){if(!this.presets)return-1;for(let s=this.presets.length-1;s>=0;s--){const i=this.presets[s];if(i.presetNumber===t&&i.bank===e)return s}return-1}getPresetName(e){return this.presets?e<0||e>=this.presets.length?null:this.presets[e].name:null}bankGetPresetName(e,t){return this.getPresetName(this.getPresetIndex(e,t))}channelNoteOn(e,t,s){!this._channels||e>this._channels.channelList.length||(this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e)),this._channels.activeChannel=e,this.noteOn(this._channels.channelList[e].presetIndex,t,s))}channelNoteOff(e,t){this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e));const s=[];let i=null,a=null;for(const r of this._voices)-1===r.playingPreset||r.playingChannel!==e||r.playingKey!==t||r.ampEnv.segment>=Rt.Release||(!i||r.playIndex<i.playIndex?(i=r,a=r,s.push(r)):r.playIndex===i.playIndex&&(a=r,s.push(r)));if(this.channelInit(e).perNotePitchWheel.delete(t),i)for(const r of s)r!==i&&r!==a&&(r.playIndex!==i.playIndex||-1===r.playingPreset||r.playingChannel!==e||r.playingKey!==t||r.ampEnv.segment>=Rt.Release)||r.end(this.outSampleRate)}channelNoteOffAll(e){this.channelInit(e).perNotePitchWheel.clear();for(const t of this._voices)-1!==t.playingPreset&&t.playingChannel===e&&t.ampEnv.segment<Rt.Release&&t.end(this.outSampleRate)}channelSoundsOffAll(e){this.channelInit(e).perNotePitchWheel.clear();for(const t of this._voices)-1!==t.playingPreset&&t.playingChannel===e&&(t.ampEnv.segment<Rt.Release||0===t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate)}channelSetPresetIndex(e,t){this.channelInit(e).presetIndex=ct.int32ToUint16(t)}channelSetPresetNumber(e,t,s=!1){const i=this.channelInit(e);let a=0;return s?(a=this.getPresetIndex(128|32767&i.bank,t),-1===a&&(a=this.getPresetIndex(128,t)),-1===a&&(a=this.getPresetIndex(128,0)),-1===a&&(a=this.getPresetIndex(2047&i.bank,t))):a=this.getPresetIndex(2047&i.bank,t),i.presetIndex=a,-1!==a}channelSetBank(e,t){this.channelInit(e).bank=ct.int32ToUint16(t)}channelSetBankPreset(e,t,s){const i=this.channelInit(e),a=this.getPresetIndex(t,s);return-1!==a&&(i.presetIndex=ct.int32ToUint16(a),i.bank=ct.int32ToUint16(t),!0)}channelSetPan(e,t){for(const s of this._voices)if(s.playingChannel===e&&-1!==s.playingPreset){const e=s.region.pan+t-.5;e<=-.5?(s.panFactorLeft=1,s.panFactorRight=0):e>=.5?(s.panFactorLeft=0,s.panFactorRight=1):(s.panFactorLeft=Math.sqrt(.5-e),s.panFactorRight=Math.sqrt(.5+e))}this.channelInit(e).panOffset=t-.5}channelSetVolume(e,t){const s=this.channelInit(e),i=Sa.gainToDecibels(t),a=i-s.gainDb;if(0!==a){for(const t of this._voices)t.playingChannel===e&&-1!==t.playingPreset&&(t.noteGainDb+=a);s.gainDb=i}}channelSetPitchWheel(e,t){const s=this.channelInit(e);s.pitchWheel!==t&&(s.pitchWheel=ct.int32ToUint16(t),this.channelApplyPitch(e,s))}channelSetPerNotePitchWheel(e,t,s){this._transpositionPitches.has(e)&&(t+=this._transpositionPitches.get(e)),this._liveTranspositionPitches.has(e)&&(t+=this._liveTranspositionPitches.get(e));const i=this.channelInit(e);i.perNotePitchWheel.has(t)&&i.perNotePitchWheel.get(t)===s||(i.perNotePitchWheel.set(t,s),this.channelApplyPitch(e,i,t))}channelApplyPitch(e,t,s=-1){for(const i of this._voices)i.playingChannel!==e||-1===i.playingPreset||-1!==s&&i.playingKey!==s||i.updatePitchRatio(t,this.outSampleRate)}channelSetPitchRange(e,t){const s=this.channelInit(e);s.pitchRange!==t&&(s.pitchRange=t,8192!==s.pitchWheel&&this.channelApplyPitch(e,s))}channelSetTuning(e,t){const s=this.channelInit(e);s.tuning!==t&&(s.tuning=t,this.channelApplyPitch(e,s))}channelMidiControl(e,t,s){const i=this.channelInit(e);switch(t){case Ot.DataEntryFine:return i.midiData=ct.int32ToUint16(16256&i.midiData|s),void(0===i.midiRpn?this.channelSetPitchRange(e,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(e,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&this.channelSetTuning(e,s-64+(i.tuning-(0|i.tuning))));case Ot.VolumeCoarse:return i.midiVolume=ct.int32ToUint16(127&i.midiVolume|s<<7),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case Ot.VolumeFine:return i.midiVolume=ct.int32ToUint16(16256&i.midiVolume|s),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case Ot.ExpressionControllerCoarse:return i.midiExpression=ct.int32ToUint16(127&i.midiExpression|s<<7),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case Ot.ExpressionControllerFine:return i.midiExpression=ct.int32ToUint16(16256&i.midiExpression|s),void this.channelSetVolume(e,Math.pow(i.midiVolume/16383*(i.midiExpression/16383),3));case Ot.PanCoarse:return i.midiPan=ct.int32ToUint16(127&i.midiPan|s<<7),void this.channelSetPan(e,i.midiPan/16383);case Ot.PanFine:return i.midiPan=ct.int32ToUint16(16256&i.midiPan|s),void this.channelSetPan(e,i.midiPan/16383);case Ot.DataEntryCoarse:return i.midiData=ct.int32ToUint16(127&i.midiData|s<<7),void(0===i.midiRpn?this.channelSetPitchRange(e,(i.midiData>>7)+.01*(127&i.midiData)):1===i.midiRpn?this.channelSetTuning(e,(0|i.tuning)+(i.midiData-8192)/8192):2===i.midiRpn&&t===Ot.DataEntryCoarse&&this.channelSetTuning(e,s-64+(i.tuning-(0|i.tuning))));case Ot.BankSelectCoarse:return void(i.bank=ct.int32ToUint16(32768|s));case Ot.BankSelectFine:return void(i.bank=ct.int32ToUint16((32768&i.bank?(127&i.bank)<<7:0)|s));case Ot.RegisteredParameterCourse:return void(i.midiRpn=ct.int32ToUint16(127&(65535===i.midiRpn?0:i.midiRpn)|s<<7));case Ot.RegisteredParameterFine:return void(i.midiRpn=ct.int32ToUint16(16256&(65535===i.midiRpn?0:i.midiRpn)|s));case Ot.NonRegisteredParameterFine:case Ot.NonRegisteredParameterCourse:return void(i.midiRpn=65535);case Ot.AllSoundOff:return void this.channelSoundsOffAll(e);case Ot.AllNotesOff:return void this.channelNoteOffAll(e);case Ot.ResetControllers:return i.midiVolume=16383,i.midiExpression=16383,i.midiPan=8192,i.bank=0,this.channelSetVolume(e,1),this.channelSetPan(e,.5),void this.channelSetPitchRange(e,2)}}channelGetPresetIndex(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].presetIndex:0}channelGetPresetBank(e){return this._channels&&e<this._channels.channelList.length?32767&this._channels.channelList[e].bank:0}channelGetPan(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].panOffset-.5:.5}channelGetVolume(e){return this._channels&&e<this._channels.channelList.length?Sa.decibelsToGain(this._channels.channelList[e].gainDb):1}channelGetPitchWheel(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchWheel:8192}channelGetPitchRange(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchRange:2}channelGetTuning(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].tuning:0}resetPresets(){this.presets=[]}loadPresets(e,t,s,i){const a=[];for(let i=0;i<e.phdrs.length-1;i++){const r=e.phdrs[i];let n=0;const o=new ba;a.push(o),o.name=r.presetName,o.bank=r.bank,o.presetNumber=r.preset;let h=0;for(let t=r.presetBagNdx;t<e.phdrs[i+1].presetBagNdx;t++){let s=0,i=127,a=0,r=127;for(let n=e.pbags[t].genNdx;n<e.pbags[t+1].genNdx;n++){const t=e.pgens[n];if(t.genOper===da.GenKeyRange){s=t.genAmount.lowByteAmount,i=t.genAmount.highByteAmount;continue}if(t.genOper===da.GenVelRange){a=t.genAmount.lowByteAmount,r=t.genAmount.highByteAmount;continue}if(t.genOper!==da.GenInstrument)continue;if(t.genAmount.wordAmount>=e.insts.length)continue;for(let n=e.insts[t.genAmount.wordAmount].instBagNdx;n<e.insts[t.genAmount.wordAmount+1].instBagNdx;n++){let t=0,o=127,l=0,c=127;for(let d=e.ibags[n].instGenNdx;d<e.ibags[n+1].instGenNdx;d++){const n=e.igens[d];n.genOper!==da.GenKeyRange?n.genOper!==da.GenVelRange?53===n.genOper&&o>=s&&t<=i&&c>=a&&l<=r&&h++:(l=n.genAmount.lowByteAmount,c=n.genAmount.highByteAmount):(t=n.genAmount.lowByteAmount,o=n.genAmount.highByteAmount)}}}}o.regions=new Array(h);let l=new Ba;l.clear(!0);for(let a=r.presetBagNdx;a<e.phdrs[i+1].presetBagNdx;a++){const i=e.pbags[a],h=new Ba(l);let c=!1;for(let l=i.genNdx;l<e.pbags[a+1].genNdx;l++){const i=e.pgens[l];if(i.genOper===da.GenInstrument){const a=i.genAmount.wordAmount;if(a>=e.insts.length)continue;let l=new Ba;l.clear(!1);const d=e.insts[a];for(let i=d.instBagNdx;i<e.insts[a+1].instBagNdx;i++){const a=e.ibags[i],c=new Ba(l);let u=!1;for(let l=a.instGenNdx;l<e.ibags[i+1].instGenNdx;l++){const i=e.igens[l];if(i.genOper===da.GenSampleId){if(c.hiKey<h.loKey||c.loKey>h.hiKey)continue;if(c.hiVel<h.loVel||c.loVel>h.hiVel)continue;h.loKey>c.loKey&&(c.loKey=h.loKey),h.hiKey<c.hiKey&&(c.hiKey=h.hiKey),h.loVel>c.loVel&&(c.loVel=h.loVel),h.hiVel<c.hiVel&&(c.hiVel=h.hiVel),c.offset+=h.offset,c.end+=h.end,c.loopStart+=h.loopStart,c.loopEnd+=h.loopEnd,c.transpose+=h.transpose,c.tune+=h.tune,c.pitchKeyTrack+=h.pitchKeyTrack,c.attenuation+=h.attenuation,c.pan+=h.pan,c.ampEnv.delay+=h.ampEnv.delay,c.ampEnv.attack+=h.ampEnv.attack,c.ampEnv.hold+=h.ampEnv.hold,c.ampEnv.decay+=h.ampEnv.decay,c.ampEnv.sustain+=h.ampEnv.sustain,c.ampEnv.release+=h.ampEnv.release,c.modEnv.delay+=h.modEnv.delay,c.modEnv.attack+=h.modEnv.attack,c.modEnv.hold+=h.modEnv.hold,c.modEnv.decay+=h.modEnv.decay,c.modEnv.sustain+=h.modEnv.sustain,c.modEnv.release+=h.modEnv.release,c.initialFilterQ+=h.initialFilterQ,c.initialFilterFc+=h.initialFilterFc,c.modEnvToPitch+=h.modEnvToPitch,c.modEnvToFilterFc+=h.modEnvToFilterFc,c.delayModLFO+=h.delayModLFO,c.freqModLFO+=h.freqModLFO,c.modLfoToPitch+=h.modLfoToPitch,c.modLfoToFilterFc+=h.modLfoToFilterFc,c.modLfoToVolume+=h.modLfoToVolume,c.delayVibLFO+=h.delayVibLFO,c.freqVibLFO+=h.freqVibLFO,c.vibLfoToPitch+=h.vibLfoToPitch,c.ampEnv.envToSecs(!0),c.modEnv.envToSecs(!1),c.delayModLFO=c.delayModLFO<-11950?0:Sa.timecents2Secs(c.delayModLFO),c.delayVibLFO=c.delayVibLFO<-11950?0:Sa.timecents2Secs(c.delayVibLFO),c.pan<-.5?c.pan=-.5:c.pan>.5&&(c.pan=.5),(c.initialFilterQ<1500||c.initialFilterQ>13500)&&(c.initialFilterQ=0);const a=e.sHdrs[i.genAmount.wordAmount];c.offset+=a.start,c.end+=a.end,c.loopStart+=a.startLoop,c.loopEnd+=a.endLoop,a.endLoop>0&&(c.loopEnd-=1),-1===c.pitchKeyCenter&&(c.pitchKeyCenter=a.originalPitch),c.tune+=a.pitchCorrection,c.sampleRate=a.sampleRate;const l=r.bank===se.PercussionBank;if(l&&va.setContainsRange(s,c.loKey,c.hiKey)||!l&&t.has(r.preset))if(1&a.sampleType){ee.debug("AlphaSynth",`Loading of used sample ${a.sampleName} for preset ${r.presetName} (bank ${o.bank} program ${o.presetNumber})`);!!(16&a.sampleType)?c.samples=e.decodeSamples(a.start,a.end,!0):(c.samples=e.decodeSamples(2*c.offset,2*c.end,!1),c.loopStart>0&&(c.loopStart-=c.offset),c.loopEnd>0&&(c.loopEnd-=c.offset)),c.offset=0,c.end=c.samples.length-1}else ee.warning("AlphaSynth",`Skipping load of unsupported sample ${a.sampleName} for preset ${r.presetName}, sample type ${a.sampleType} is not supported (bank ${o.bank} program ${o.presetNumber})`),c.samples=new Float32Array(0);else ee.debug("AlphaSynth",`Skipping load of unused sample ${a.sampleName} for preset ${r.presetName} (bank ${o.bank} program ${o.presetNumber})`),c.samples=new Float32Array(0);o.regions[n]=new Ba(c),n++,u=!0}else c.operator(i.genOper,i.genAmount)}a!==e.ibags[d.instBagNdx]||u||(l=new Ba(c))}c=!0}else h.operator(i.genOper,i.genAmount)}i!==e.pbags[r.presetBagNdx]||c||(l=h)}}if(i&&this.presets)for(const e of a)this.presets.push(e);else this.presets=a}static setContainsRange(e,t,s){for(let i=t;i<=s;i++)if(e.has(i))return!0;return!1}hasSamplesForProgram(e){const t=this.presets;if(!t)return!1;for(const s of t)if(s.presetNumber===e)for(const e of s.regions)if(e.samples.length>0)return!0;return!1}hasSamplesForPercussion(e){const t=this.presets;if(!t)return!1;for(const s of t)if(s.bank===se.PercussionBank)for(const t of s.regions)if(t.loKey>=e&&t.hiKey<=e&&t.samples.length>0)return!0;return!1}}class Ea{constructor(e){this.events=e}}class Ma{constructor(e){this.playbackRange=e}}class Fa{constructor(){this.sampleRate=44100,this.useSyncPoints=!1,this.masterVolume=1,this.metronomeVolume=0,this.trackVolume=new Map,this.trackTranspositionPitches=new Map}}class Ca{constructor(){this.currentTime=0,this.endTime=0,this.currentTick=0,this.endTick=0}}class Da{get output(){return this._output}get isReadyForPlayback(){return this.isReady&&this.isSoundFontLoaded&&this._isMidiLoaded}get logLevel(){return ee.logLevel}set logLevel(e){ee.logLevel=e}get masterVolume(){return this.synthesizer.masterVolume}set masterVolume(e){e=Math.max(e,se.MinVolume),this.updateMasterVolume(e)}updateMasterVolume(e){this.synthesizer.masterVolume=e}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,se.MinVolume),this._metronomeVolume=e,this.synthesizer.metronomeVolume=e}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,se.MinVolume),this._countInVolume=e}get midiEventsPlayedFilter(){return Array.from(this._midiEventsPlayedFilter)}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=new Set(e)}get playbackSpeed(){return this.sequencer.playbackSpeed}set playbackSpeed(e){e=De.clamp(e,se.MinPlaybackSpeed,se.MaxPlaybackSpeed),this.updatePlaybackSpeed(e)}updatePlaybackSpeed(e){const t=this.sequencer.playbackSpeed;this.sequencer.playbackSpeed=e,this.timePosition=this.timePosition*(t/e)}get loadedMidiInfo(){return this._loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._tickPosition}set tickPosition(e){this.timePosition=this.sequencer.mainTickPositionToTimePosition(e)}get timePosition(){return this._timePosition}set timePosition(e){ee.debug("AlphaSynth",`Seeking to position ${e}ms (main)`),this.sequencer.mainSeek(e),this.updateTimePosition(e,!0),this.sequencer.isPlayingMain&&(this._notPlayedSamples=0,this.output.resetSamples())}get playbackRange(){return this.sequencer.mainPlaybackRange}set playbackRange(e){this.sequencer.mainPlaybackRange=e,e&&(this.tickPosition=e.startTick),this.playbackRangeChanged.trigger(new Ma(e))}get isLooping(){return this.sequencer.isLooping}set isLooping(e){this.sequencer.isLooping=e}destroy(){ee.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}constructor(e,t,s){this.isSoundFontLoaded=!1,this._isMidiLoaded=!1,this._tickPosition=0,this._timePosition=0,this._metronomeVolume=0,this._countInVolume=0,this._playedEventsQueue=new Pa,this._midiEventsPlayedFilter=new Set,this._notPlayedSamples=0,this._synthStopping=!1,this._currentPosition=new _i(0,0,0,0,!1,120,120),this.isReady=!1,this.state=Ft.Paused,this._loadedSoundFonts=[],this.readyForPlayback=new $s,this.finished=new $s,this.soundFontLoaded=new $s,this.soundFontLoadFailed=new qs,this.midiLoadFailed=new qs,this.midiEventsPlayed=new qs,ee.debug("AlphaSynth","Initializing player"),this.state=Ft.Paused,this.ready=new $s(()=>this.isReady),this.readyForPlayback=new $s(()=>this.isReadyForPlayback),this.midiLoaded=new qs(()=>this._loadedMidiInfo?this._loadedMidiInfo:null),this.stateChanged=new qs(()=>new Ti(this.state,!1)),this.positionChanged=new qs(()=>this._currentPosition),this.playbackRangeChanged=new qs(()=>this.playbackRange?new Ma(this.playbackRange):null),ee.debug("AlphaSynth","Creating output"),this._output=e,ee.debug("AlphaSynth","Creating synthesizer"),this.synthesizer=t,this.sequencer=new ki(this.synthesizer),ee.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this.checkReadyForPlayback()}),this.output.sampleRequest.on(()=>{this.onSampleRequest()}),this.output.samplesPlayed.on(this.onSamplesPlayed.bind(this)),this.output.open(s)}onSampleRequest(){if(this.state===Ft.Playing&&(!this.sequencer.isFinished||this.synthesizer.activeVoiceCount>0)){let e=new Float32Array(se.MicroBufferSize*se.MicroBufferCount*se.AudioChannels),t=0;for(let s=0;s<se.MicroBufferCount;s++){this.sequencer.fillMidiEventQueue();const s=this.synthesizer.synthesize(e,t,se.MicroBufferSize);t+=se.MicroBufferSize*se.AudioChannels;for(const e of s)this._midiEventsPlayedFilter.has(e.event.type)&&this._playedEventsQueue.enqueue(e);if(this.sequencer.isFinished)break}t<e.length&&(e=e.subarray(0,t)),this._notPlayedSamples+=e.length,this.output.addSamples(e)}else{const e=new Float32Array(0);this.output.addSamples(e)}}play(){return!(this.state!==Ft.Paused||!this._isMidiLoaded)&&(this.output.activate(),this.playInternal(),this._countInVolume>0&&(ee.debug("AlphaSynth","Starting countin"),this.sequencer.startCountIn(),this.synthesizer.setupMetronomeChannel(this._countInVolume),this.updateTimePosition(0,!0)),this.output.play(),!0)}playInternal(){this.sequencer.isPlayingOneTimeMidi&&(ee.debug("AlphaSynth","Cancelling one time midi"),this.stopOneTimeMidi()),ee.debug("AlphaSynth","Starting playback"),this.synthesizer.setupMetronomeChannel(this.metronomeVolume),this._synthStopping=!1,this.state=Ft.Playing,this.stateChanged.trigger(new Ti(this.state,!1))}pause(){this.state!==Ft.Paused&&this._isMidiLoaded&&(ee.debug("AlphaSynth","Pausing playback"),this.state=Ft.Paused,this.stateChanged.trigger(new Ti(this.state,!1)),this.output.pause(),this.synthesizer.noteOffAll(!1))}playPause(){this.state===Ft.Paused&&this._isMidiLoaded?this.play():this.pause()}stop(){this._isMidiLoaded&&(ee.debug("AlphaSynth","Stopping playback"),this.state=Ft.Paused,this.output.pause(),this._notPlayedSamples=0,this.sequencer.stop(),this.synthesizer.noteOffAll(!0),this.tickPosition=this.sequencer.mainPlaybackRange?this.sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new Ti(this.state,!0)))}playOneTimeMidiFile(e){this.sequencer.isPlayingOneTimeMidi?this.stopOneTimeMidi():this.pause(),this.sequencer.loadOneTimeMidi(e),this.synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this._notPlayedSamples=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this.synthesizer.resetPresets(),this._loadedSoundFonts=[],this.isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}loadSoundFont(e,t){this.pause();const s=ut.fromBuffer(e);try{ee.debug("AlphaSynth","Loading soundfont from bytes");const e=new ra;e.load(s),t||(this._loadedSoundFonts=[]),this._loadedSoundFonts.push(e),this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),ee.debug("AlphaSynth","soundFont successfully loaded"),this.checkReadyForPlayback()}catch(e){ee.error("AlphaSynth",`Could not load soundfont from bytes ${e}`),this.soundFontLoadFailed.trigger(e)}}checkReadyForPlayback(){if(this.isReadyForPlayback){this.synthesizer.setupMetronomeChannel(this.metronomeVolume);const e=this.sequencer.instrumentPrograms,t=this.sequencer.percussionKeys;let s=!1;for(const i of this._loadedSoundFonts)this.synthesizer.loadPresets(i,e,t,s),s=!0;this.readyForPlayback.trigger()}}loadMidiFile(e){this.stop();try{ee.debug("AlphaSynth","Loading midi from model"),this.sequencer.loadMidi(e),this._isMidiLoaded=!0,this._loadedMidiInfo=new _i(0,this.sequencer.currentEndTime,0,this.sequencer.currentEndTick,!1,this.sequencer.currentTempo,this.sequencer.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo),ee.debug("AlphaSynth","Midi successfully loaded"),this.checkReadyForPlayback(),this.tickPosition=0}catch(e){ee.error("AlphaSynth",`Could not load midi from model ${e}`),this.midiLoadFailed.trigger(e)}}applyTranspositionPitches(e){this.synthesizer.applyTranspositionPitches(e)}setChannelTranspositionPitch(e,t){this.synthesizer.setChannelTranspositionPitch(e,t)}setChannelMute(e,t){this.synthesizer.channelSetMute(e,t)}resetChannelStates(){this.synthesizer.resetChannelStates()}setChannelSolo(e,t){this.synthesizer.channelSetSolo(e,t)}setChannelVolume(e,t){t=Math.max(t,se.MinVolume),this.synthesizer.channelSetMixVolume(e,t)}onSamplesPlayed(e){if(0===e)return;const t=e/this.synthesizer.outSampleRate*1e3;this._notPlayedSamples-=e*se.AudioChannels,this.updateTimePosition(this._timePosition+t,!1),this.checkForFinish()}checkForFinish(){let e=0,t=0;this.playbackRange&&this.sequencer.isPlayingMain?(e=this.playbackRange.startTick,t=this.playbackRange.endTick):t=this.sequencer.currentEndTick,this._tickPosition>=t&&(this._notPlayedSamples<=0?(this._notPlayedSamples=0,this.sequencer.isPlayingCountIn?(ee.debug("AlphaSynth","Finished playback (count-in)"),this.sequencer.resetCountIn(),this.timePosition=this.sequencer.currentTime,this.playInternal(),this.output.resetSamples()):this.sequencer.isPlayingOneTimeMidi?(ee.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=Ft.Paused,this.stopOneTimeMidi()):this.isLooping?(ee.debug("AlphaSynth","Finished playback (main looping)"),this.finished.trigger(),this.tickPosition=e,this._synthStopping=!1):this.synthesizer.activeVoiceCount>0?this._synthStopping||(ee.debug("AlphaSynth","Signaling synth to stop all voices (all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0):(this._synthStopping=!1,ee.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.stop())):this._synthStopping||(ee.debug("AlphaSynth","Signaling synth to stop all voices (not all samples played)"),this.synthesizer.noteOffAll(!0),this._synthStopping=!0))}stopOneTimeMidi(){this.output.pause(),this.synthesizer.noteOffAll(!0),this.sequencer.resetOneTimeMidi(),this.timePosition=this.sequencer.currentTime}createPositionChangedEventArgs(e){let t=this._timePosition,s=this.sequencer.currentTimePositionToTickPosition(t);const i=this.sequencer.currentEndTime,a=this.sequencer.currentEndTick;return t>i&&(t=i,s=a),new _i(t,i,s,a,e,this.sequencer.currentTempo,this.sequencer.modifiedTempo)}updateTimePosition(e,t){this._timePosition=e;const s=this.createPositionChangedEventArgs(t);this._tickPosition=s.currentTick;const i=this.sequencer.isPlayingMain?"main":this.sequencer.isPlayingCountIn?"count-in":"one-time";if(ee.debug("AlphaSynth",`Position changed: (time: ${s.currentTime}/${s.endTime}, tick: ${s.currentTick}/${s.endTick}, Active Voices: ${this.synthesizer.activeVoiceCount} (${i}), Tempo original: ${this.sequencer.currentTempo}, Tempo modified: ${this.sequencer.modifiedTempo})`),this.sequencer.isPlayingMain&&(this._currentPosition=s,this.positionChanged.trigger(s)),t)this._playedEventsQueue.clear();else{const e=[];for(;!this._playedEventsQueue.isEmpty&&this._playedEventsQueue.peek().time<s.currentTime;){const t=this._playedEventsQueue.dequeue();e.push(t.event)}e.length>0&&(e.reverse(),this.midiEventsPlayed.trigger(new Ea(e)))}}hasSamplesForProgram(e){return this.synthesizer.hasSamplesForProgram(e)}hasSamplesForPercussion(e){return this.synthesizer.hasSamplesForPercussion(e)}loadBackingTrack(e){}updateSyncPoints(e){}}class La extends Da{constructor(e,t){super(e,new va(e.sampleRate),t)}exportAudio(e,t,s,i){const a=new Ia(e);a.loadMidiFile(t),e.useSyncPoints&&a.updateSyncPoints(s),a.applyTranspositionPitches(i);for(const[t,s]of e.trackTranspositionPitches)a.setChannelTranspositionPitch(t,s);for(const[t,s]of e.trackVolume)a.channelSetMixVolume(t,s);if(e.soundFonts)for(const t of e.soundFonts)a.loadSoundFont(t);else a.loadPresets(this.synthesizer.presets);return e.playbackRange&&a.limitExport(e.playbackRange),a.setup(),a}}class Ia{constructor(e){this._generatedAudioCurrentTime=0,this._generatedAudioEndTime=0,this._synth=new va(e.sampleRate),this._sequencer=new ki(this._synth),this._synth.masterVolume=Math.max(e.masterVolume,se.MinVolume),this._synth.metronomeVolume=Math.max(e.metronomeVolume,se.MinVolume)}loadSoundFont(e){const t=ut.fromBuffer(e),s=new ra;s.load(t);const i=this._sequencer.instrumentPrograms,a=this._sequencer.percussionKeys;this._synth.loadPresets(s,i,a,!0)}loadPresets(e){this._synth.presets=e}limitExport(e){this._sequencer.mainPlaybackRange=e,this._sequencer.mainSeek(this._sequencer.mainTickPositionToTimePosition(e.startTick))}setChannelTranspositionPitch(e,t){this._synth.setChannelTranspositionPitch(e,t)}applyTranspositionPitches(e){this._synth.applyTranspositionPitches(e)}loadMidiFile(e){this._sequencer.loadMidi(e)}updateSyncPoints(e){this._sequencer.mainUpdateSyncPoints(e)}channelSetMixVolume(e,t){t=Math.max(t,se.MinVolume),this._synth.channelSetMixVolume(e,t)}setup(){this._synth.setupMetronomeChannel(this._synth.metronomeVolume);const e=this._sequencer.currentSyncPoints,t=this._sequencer.currentEndTime;if(0===e.length)this._generatedAudioEndTime=t;else{const t=e[e.length-1];let s=t.syncTime;const i=this._sequencer.currentEndTick-t.synthTick;i>0&&(s+=J.ticksToMillis(i,t.syncBpm)),this._generatedAudioEndTime=s}}render(e){if(this._sequencer.isFinished)return;const t=1e3*se.MicroBufferSize/this._synth.outSampleRate,s=Math.ceil(e/t);let i=new Float32Array(se.MicroBufferSize*s*se.AudioChannels);const a=this._sequencer.currentSyncPoints;let r=0,n=this._generatedAudioCurrentTime;for(let e=0;e<s;e++){if(a.length>0){this._sequencer.currentUpdateSyncPoints(n),this._sequencer.currentUpdateCurrentTempo(this._sequencer.currentTime);const e=this._sequencer.syncPointTempo/this._sequencer.currentTempo;this._sequencer.playbackSpeed!==e&&(this._sequencer.playbackSpeed=e)}if(this._sequencer.fillMidiEventQueue(),this._synth.synthesize(i,r,se.MicroBufferSize),r+=se.MicroBufferSize*se.AudioChannels,n+=t,this._sequencer.isFinished)break}r<i.length&&(i=i.subarray(0,r));const o=new Ca;return o.currentTime=this._generatedAudioCurrentTime,o.endTime=this._generatedAudioEndTime,o.currentTick=this._sequencer.currentTimePositionToTickPosition(this._sequencer.currentTime),o.endTick=this._sequencer.currentEndTick,this._generatedAudioCurrentTime+=e,o.samples=i,this._sequencer.isFinished&&this._synth.noteOffAll(!0),o}}class Aa{static parseEnum(t,s){switch(typeof t){case"string":const e=Number.parseInt(t,10);return Number.isNaN(e)?s[Object.keys(s).find(e=>e.toLowerCase()===t.toLowerCase())]:e;case"number":return t;case"undefined":case"object":return}throw new O(e.AlphaTabErrorType.Format,`Could not parse enum value '${t}'`)}static parseEnumExact(e,t){if(e in t)return t[e]}static forEach(e,t){if(e instanceof Map)e.forEach(t);else if("object"==typeof e)for(const s in e)t(e[s],s)}static getValue(e,t){return e instanceof Map?e.get(t):"object"==typeof e?e[t]:null}}class Ra{constructor(e,t,s){this.text=e,this.startPos=t,this.endPos=s}}class Oa{constructor(e){this.style="normal",this.variant="normal",this.weight="normal",this.stretch="normal",this.lineHeight="normal",this.size="1rem",this.families=[],this.parseOnlyFamilies=!1,this._currentTokenIndex=-1,this._input="",this._currentToken=null,this._input=e,this._tokens=this.splitToTokens(e)}splitToTokens(e){const t=[];let s=0;for(;s<e.length;){let i=s;for(;i<e.length&&" "!==e.charAt(i);)i++;i>s&&t.push(new Ra(e.substring(s,i),s,i)),s=i+1}return t}parse(){if(this.reset(),1===this._tokens.length)switch(this._currentToken?.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this.fontStyleVariantWeight(),this.fontSizeLineHeight()),this.fontFamily()}static parseFamilies(e){const t=new Oa(e);return t.parseOnlyFamilies=!0,t.parse(),t.families}fontFamily(){if(!this._currentToken){if(this.parseOnlyFamilies)return;throw new Error("Missing font list")}const e=this._input.substr(this._currentToken.startPos).trim();let t=0;for(;t<e.length;){const s=e.charAt(t);if(" "===s||","===s)t++;else if('"'===s||"'"===s){const i=this.findEndOfQuote(e,t+1,s);this.families.push(e.substring(t+1,i).split(`\\${s}`).join(s)),t=i+1}else{const s=this.findEndOfQuote(e,t+1,",");this.families.push(e.substring(t,s).trim()),t=s+1}}}findEndOfQuote(e,t,s){let i=!1;for(;t<e.length;){const a=e.charAt(t);if(!i&&a===s)return t;i=!i&&"\\"===a,t+=1}return e.length}fontSizeLineHeight(){if(!this._currentToken)throw new Error("Missing font size");const e=this._currentToken.text.split("/");if(e.length>=3)throw new Error(`Invalid font size '${this._currentToken}' specified`);if(this.nextToken(),e.length>=2)if("/"===e[1]){if(!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this.nextToken()}else this.size=e[0],this.lineHeight=e[1];else{if(!(e.length>=1))throw new Error("Missing font size");if(this.size=e[0],this._currentToken&&0===this._currentToken.text.indexOf("/"))if("/"===this._currentToken.text){if(this.nextToken(),!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this.nextToken()}else this.lineHeight=this._currentToken.text.substr(1),this.nextToken()}}nextToken(){this._currentTokenIndex++,this._currentTokenIndex<this._tokens.length?this._currentToken=this._tokens[this._currentTokenIndex]:this._currentToken=null}fontStyleVariantWeight(){let e=!1,t=!1,s=!1,i=3;const a=[];for(;;){if(!this._currentToken)return;const r=this._currentToken.text;switch(r){case"normal":case"inherit":a.push(r),i--,this.nextToken();break;case"italic":case"oblique":this.style=r,e=!0,i--,this.nextToken();break;case"small-caps":this.variant=r,t=!0,i--,this.nextToken();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=r,s=!0,i--,this.nextToken();break;default:return}if(0===i)break}for(;a.length>0;){const i=a.pop();s?t?e||(this.style=i):this.variant=i:this.weight=i}}reset(){this._currentTokenIndex=-1,this.nextToken()}static quoteFont(e){if(-1===e.indexOf(" "))return e;return`"${e.replaceAll('"','\\"')}"`}}!function(e){e[e.Plain=0]="Plain",e[e.Italic=1]="Italic"}(Wt||(Wt={})),function(e){e[e.Regular=0]="Regular",e[e.Bold=1]="Bold"}(Ht||(Ht={}));class Wa{reset(){this._cssScale=0,this._css=this.toCssString()}get family(){return this._families[0]}set family(e){this.families=Oa.parseFamilies(e)}get families(){return this._families}set families(e){this._families=e,this.reset()}get size(){return this._size}set size(e){this._size=e,this.reset()}get style(){return this._style}set style(e){this._style=e,this.reset()}get weight(){return this._weight}set weight(e){this._weight=e,this.reset()}get isBold(){return this.weight===Ht.Bold}get isItalic(){return this.style===Wt.Italic}constructor(e,t,s=Wt.Plain,i=Ht.Regular){this._cssScale=0,this._families=Oa.parseFamilies(e),this._size=t,this._style=s,this._weight=i,this._css=this.toCssString()}withSize(e){return Wa.withFamilyList(this._families,e,this._style,this._weight)}static withFamilyList(e,t,s=Wt.Plain,i=Ht.Regular){const a=new Wa("",t,s,i);return a.families=e,a}toCssString(e=1){if(!(this._css&&Math.abs(e-this._cssScale)<.01)){let t="";this.isBold&&(t+="bold "),this.isItalic&&(t+="italic "),t+=this.size*e,t+="px ",t+=this.families.map(e=>Oa.quoteFont(e)).join(", "),this._css=t,this._cssScale=e}return this._css}static fromJson(e){if(e instanceof Wa)return e;switch(typeof e){case"undefined":default:return;case"object":{const t=e,s=t.get("families"),i=t.get("size"),a=Aa.parseEnum(t.get("style"),Wt),r=Aa.parseEnum(t.get("weight"),Ht);return Wa.withFamilyList(s,i,a,r)}case"string":{const t=new Oa(e);t.parse();const s=t.families,i=t.size.toLowerCase();let a=0;switch(i){case"xx-small":a=7;break;case"x-small":a=10;break;case"small":case"smaller":a=13;break;case"medium":a=16;break;case"large":case"larger":a=18;break;case"x-large":a=24;break;case"xx-large":a=32;break;default:try{a=i.endsWith("em")?16*Number.parseFloat(i.substr(0,i.length-2)):i.endsWith("pt")?16*Number.parseFloat(i.substr(0,i.length-2))/12:i.endsWith("px")?Number.parseFloat(i.substr(0,i.length-2)):12}catch{a=12}}let r=Wt.Plain;"italic"===t.style&&(r=Wt.Italic);let n=Ht.Regular;switch(t.weight.toLowerCase()){case"normal":case"lighter":break;default:n=Ht.Bold}return Wa.withFamilyList(s,a,r,n)}}}static toJson(e){if(!e)return;const t=new Map;return t.set("families",e.families),t.set("size",e.size),t.set("style",e.style),t.set("weight",e.weight),t}}class Ha{static clone(e){const t=new Va;return t.musicFontSize=e.musicFontSize,t.oneStaffSpace=e.oneStaffSpace,t.tabLineSpacing=e.tabLineSpacing,t.arrowShaftThickness=e.arrowShaftThickness,t.barlineSeparation=e.barlineSeparation,t.beamSpacing=e.beamSpacing,t.beamThickness=e.beamThickness,t.bracketThickness=e.bracketThickness,t.dashedBarlineDashLength=e.dashedBarlineDashLength,t.dashedBarlineGapLength=e.dashedBarlineGapLength,t.dashedBarlineThickness=e.dashedBarlineThickness,t.hairpinThickness=e.hairpinThickness,t.legerLineThickness=e.legerLineThickness,t.legerLineExtension=e.legerLineExtension,t.octaveLineThickness=e.octaveLineThickness,t.pedalLineThickness=e.pedalLineThickness,t.repeatBarlineDotSeparation=e.repeatBarlineDotSeparation,t.repeatEndingLineThickness=e.repeatEndingLineThickness,t.slurMidpointThickness=e.slurMidpointThickness,t.staffLineThickness=e.staffLineThickness,t.stemThickness=e.stemThickness,t.thickBarlineThickness=e.thickBarlineThickness,t.thinBarlineThickness=e.thinBarlineThickness,t.thinThickBarlineSeparation=e.thinThickBarlineSeparation,t.tieMidpointThickness=e.tieMidpointThickness,t.tupletBracketThickness=e.tupletBracketThickness,t.stemUp=new Map(e.stemUp),t.stemDown=new Map(e.stemDown),t.repeatOffsetX=new Map(e.repeatOffsetX),t.standardStemLength=e.standardStemLength,t.stemFlagOffsets=new Map(e.stemFlagOffsets),t.glyphTop=new Map(e.glyphTop),t.glyphBottom=new Map(e.glyphBottom),t.glyphWidths=new Map(e.glyphWidths),t.glyphHeights=new Map(e.glyphHeights),t.numberedBarRendererBarSize=e.numberedBarRendererBarSize,t.numberedBarRendererBarSpacing=e.numberedBarRendererBarSpacing,t.numberedDashGlyphPadding=e.numberedDashGlyphPadding,t.numberedDashGlyphWidth=e.numberedDashGlyphWidth,t.lineRangedGlyphDashGap=e.lineRangedGlyphDashGap,t.lineRangedGlyphDashSize=e.lineRangedGlyphDashSize,t.preNoteEffectPadding=e.preNoteEffectPadding,t.postNoteEffectPadding=e.postNoteEffectPadding,t.onNoteEffectPadding=e.onNoteEffectPadding,t.stringNumberCirclePadding=e.stringNumberCirclePadding,t.rowContainerPadding=e.rowContainerPadding,t.rowContainerGap=e.rowContainerGap,t.alternateEndingsPadding=e.alternateEndingsPadding,t.sustainPedalLinePadding=e.sustainPedalLinePadding,t.tieHeight=e.tieHeight,t.beatTimerPadding=e.beatTimerPadding,t.bendNoteHeadElementPadding=e.bendNoteHeadElementPadding,t.ghostParenthesisWidth=e.ghostParenthesisWidth,t.ghostParenthesisPadding=e.ghostParenthesisPadding,t.brokenBeamWidth=e.brokenBeamWidth,t.tabWhammyTextPadding=e.tabWhammyTextPadding,t.tabWhammyPerHalfHeight=e.tabWhammyPerHalfHeight,t.tabWhammyDashSize=e.tabWhammyDashSize,t.songBookWhammyDipHeight=e.songBookWhammyDipHeight,t.deadSlappedLineWidth=e.deadSlappedLineWidth,t.leftHandTabTieWidth=e.leftHandTabTieWidth,t.tabBendDashSize=e.tabBendDashSize,t.tabBendPerValueHeight=e.tabBendPerValueHeight,t.tabBendLabelPadding=e.tabBendLabelPadding,t.simpleSlideWidth=e.simpleSlideWidth,t.simpleSlideHeight=e.simpleSlideHeight,t.chordDiagramPaddingX=e.chordDiagramPaddingX,t.chordDiagramPaddingY=e.chordDiagramPaddingY,t.chordDiagramStringSpacing=e.chordDiagramStringSpacing,t.chordDiagramFretSpacing=e.chordDiagramFretSpacing,t.chordDiagramNutHeight=e.chordDiagramNutHeight,t.chordDiagramFretHeight=e.chordDiagramFretHeight,t.chordDiagramLineWidth=e.chordDiagramLineWidth,t.tripletFeelBracketPadding=e.tripletFeelBracketPadding,t.accidentalPadding=e.accidentalPadding,t.preBeatGlyphSpacing=e.preBeatGlyphSpacing,t.tempoNoteScale=e.tempoNoteScale,t.tuningGlyphCircleNumberScale=e.tuningGlyphCircleNumberScale,t.tuningGlyphStringColumnScale=e.tuningGlyphStringColumnScale,t.tuningGlyphStringRowPadding=e.tuningGlyphStringRowPadding,t.directionsScale=e.directionsScale,t}}class Ga{constructor(){this.topY=0,this.bottomY=0,this.x=0}}class Va{constructor(){this.musicFontSize=0,this.oneStaffSpace=0,this.tabLineSpacing=0,this.arrowShaftThickness=0,this.barlineSeparation=0,this.beamSpacing=0,this.beamThickness=0,this.bracketThickness=0,this.dashedBarlineDashLength=0,this.dashedBarlineGapLength=0,this.dashedBarlineThickness=0,this.hairpinThickness=0,this.legerLineThickness=0,this.legerLineExtension=0,this.octaveLineThickness=0,this.pedalLineThickness=0,this.repeatBarlineDotSeparation=0,this.repeatEndingLineThickness=0,this.slurMidpointThickness=0,this.staffLineThickness=0,this.stemThickness=0,this.thickBarlineThickness=0,this.thinBarlineThickness=0,this.thinThickBarlineSeparation=0,this.tieMidpointThickness=0,this.tupletBracketThickness=0,this.stemUp=new Map,this.stemDown=new Map,this.repeatOffsetX=new Map,this.standardStemLength=0,this.stemFlagOffsets=new Map,this.glyphTop=new Map,this.glyphBottom=new Map,this.glyphWidths=new Map,this.glyphHeights=new Map,this.numberedBarRendererBarSize=0,this.numberedBarRendererBarSpacing=0,this.numberedDashGlyphPadding=0,this.numberedDashGlyphWidth=0,this.lineRangedGlyphDashGap=0,this.lineRangedGlyphDashSize=0,this.preNoteEffectPadding=0,this.postNoteEffectPadding=0,this.onNoteEffectPadding=0,this.stringNumberCirclePadding=0,this.rowContainerPadding=0,this.rowContainerGap=0,this.alternateEndingsPadding=0,this.sustainPedalLinePadding=0,this.tieHeight=0,this.beatTimerPadding=0,this.bendNoteHeadElementPadding=0,this.ghostParenthesisWidth=0,this.ghostParenthesisPadding=0,this.brokenBeamWidth=0,this.tabWhammyTextPadding=0,this.tabWhammyPerHalfHeight=0,this.tabWhammyDashSize=0,this.songBookWhammyDipHeight=0,this.deadSlappedLineWidth=0,this.leftHandTabTieWidth=0,this.tabBendDashSize=0,this.tabBendPerValueHeight=0,this.tabBendLabelPadding=0,this.simpleSlideWidth=0,this.simpleSlideHeight=0,this.chordDiagramPaddingX=0,this.chordDiagramPaddingY=0,this.chordDiagramStringSpacing=0,this.chordDiagramFretSpacing=0,this.chordDiagramNutHeight=0,this.chordDiagramFretHeight=0,this.chordDiagramLineWidth=0,this.tripletFeelBracketPadding=0,this.accidentalPadding=0,this.preBeatGlyphSpacing=0,this.tempoNoteScale=.7,this.tuningGlyphCircleNumberScale=.7,this.tuningGlyphStringColumnScale=1.5,this.tuningGlyphStringRowPadding=0,this.directionsScale=.6}static get bravuraDefaults(){let e=Va._bravuraDefaults;return e||(e=new Va,e.fillFromSmufl(Va.bravuraMetadata),Va._bravuraDefaults=e),Ha.clone(e)}hasSymbol(e){return this.glyphWidths.get(e)>0&&this.glyphHeights.get(e)>0}fillFromSmufl(e,t=36){this.musicFontSize=t,this.oneStaffSpace=t/4,this.tabLineSpacing=Math.floor(1.5*this.oneStaffSpace),this.arrowShaftThickness=e.engravingDefaults.arrowShaftThickness*this.oneStaffSpace,this.barlineSeparation=e.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.beamSpacing=e.engravingDefaults.beamSpacing*this.oneStaffSpace,this.beamThickness=e.engravingDefaults.beamThickness*this.oneStaffSpace,this.bracketThickness=e.engravingDefaults.bracketThickness*this.oneStaffSpace,this.dashedBarlineDashLength=e.engravingDefaults.dashedBarlineDashLength*this.oneStaffSpace,this.dashedBarlineGapLength=e.engravingDefaults.dashedBarlineGapLength*this.oneStaffSpace,this.dashedBarlineThickness=e.engravingDefaults.dashedBarlineThickness*this.oneStaffSpace,this.hairpinThickness=e.engravingDefaults.hairpinThickness*this.oneStaffSpace,this.legerLineExtension=e.engravingDefaults.legerLineExtension*this.oneStaffSpace,this.legerLineThickness=e.engravingDefaults.legerLineThickness*this.oneStaffSpace,this.octaveLineThickness=e.engravingDefaults.octaveLineThickness*this.oneStaffSpace,this.pedalLineThickness=e.engravingDefaults.pedalLineThickness*this.oneStaffSpace,this.repeatBarlineDotSeparation=e.engravingDefaults.repeatBarlineDotSeparation*this.oneStaffSpace,this.repeatEndingLineThickness=e.engravingDefaults.repeatEndingLineThickness*this.oneStaffSpace,this.slurMidpointThickness=e.engravingDefaults.slurMidpointThickness*this.oneStaffSpace,this.staffLineThickness=e.engravingDefaults.staffLineThickness*this.oneStaffSpace,this.stemThickness=e.engravingDefaults.stemThickness*this.oneStaffSpace,this.thickBarlineThickness=e.engravingDefaults.thickBarlineThickness*this.oneStaffSpace,this.thinBarlineThickness=e.engravingDefaults.thinBarlineThickness*this.oneStaffSpace,"number"==typeof e.engravingDefaults.thinThickBarlineSeparation?this.thinThickBarlineSeparation=e.engravingDefaults.thinThickBarlineSeparation*this.oneStaffSpace:this.thinThickBarlineSeparation=e.engravingDefaults.barlineSeparation*this.oneStaffSpace,this.tieMidpointThickness=e.engravingDefaults.tieMidpointThickness*this.oneStaffSpace,this.tupletBracketThickness=e.engravingDefaults.tupletBracketThickness*this.oneStaffSpace;const s=3*this.oneStaffSpace;this.standardStemLength=s,this.stemFlagOffsets.set(k.QuadrupleWhole,0),this.stemFlagOffsets.set(k.DoubleWhole,0),this.stemFlagOffsets.set(k.Whole,0),this.stemFlagOffsets.set(k.Half,0),this.stemFlagOffsets.set(k.Quarter,0),this.stemFlagOffsets.set(k.Eighth,0),this.stemFlagOffsets.set(k.Sixteenth,0),this.stemFlagOffsets.set(k.ThirtySecond,0),this.stemFlagOffsets.set(k.SixtyFourth,0),this.stemFlagOffsets.set(k.OneHundredTwentyEighth,0),this.stemFlagOffsets.set(k.TwoHundredFiftySixth,0);for(const[t,s]of Object.entries(e.glyphsWithAnchors)){const e=Va.smuflNameToMusicFontSymbol(t);if(e){if(s.stemDownNW){const t=new Ga;t.x=s.stemDownNW[0]*this.oneStaffSpace,t.topY=s.stemDownNW[1]*this.oneStaffSpace,s.stemDownSW?t.bottomY=s.stemDownSW[1]*this.oneStaffSpace:t.bottomY=0,this.stemDown.set(e,t)}if(s.stemUpSE){const t=new Ga,i=s.stemUpSE[0]*this.oneStaffSpace;t.bottomY=s.stemUpSE[1]*this.oneStaffSpace,s.stemUpNW?(t.x=s.stemUpNW[0]*this.oneStaffSpace,t.topY=s.stemUpNW[1]*this.oneStaffSpace):(t.x=i-this.stemThickness,t.topY=0),this.stemUp.set(e,t)}if(s.repeatOffset&&this.repeatOffsetX.set(e,s.repeatOffset[0]*this.oneStaffSpace),s.stemUpNW){const t=s.stemUpNW[1]*this.oneStaffSpace;switch(e){case ne.Flag8thUp:this.stemFlagOffsets.set(k.Eighth,t);break;case ne.Flag16thUp:this.stemFlagOffsets.set(k.Sixteenth,t);break;case ne.Flag32ndUp:this.stemFlagOffsets.set(k.ThirtySecond,t);break;case ne.Flag64thUp:this.stemFlagOffsets.set(k.SixtyFourth,t);break;case ne.Flag128thUp:this.stemFlagOffsets.set(k.OneHundredTwentyEighth,t);break;case ne.Flag256thUp:this.stemFlagOffsets.set(k.TwoHundredFiftySixth,t)}}}}const i=new Set,a=e.glyphBBoxes;if(a)for(const[e,t]of Object.entries(a)){const s=Va.smuflNameToMusicFontSymbol(e);s&&(i.add(s),this.glyphTop.set(s,t.bBoxNE[1]*this.oneStaffSpace),this.glyphBottom.set(s,t.bBoxSW[1]*this.oneStaffSpace),this.glyphWidths.set(s,(t.bBoxNE[0]-t.bBoxSW[0])*this.oneStaffSpace),this.glyphHeights.set(s,(t.bBoxNE[1]-t.bBoxSW[1])*this.oneStaffSpace))}const r=new Set([ne.None,ne.Space,ne.NoteheadNull]);for(const e of De.getAllMusicFontSymbols())i.has(e)||(r.has(e)||ee.warning("SmuFL",`The provided SmuFL font is missing the glyph ${ne[e]} needed by alphaTab, the music notation might not show all details`),this.glyphTop.set(e,0),this.glyphBottom.set(e,0),this.glyphWidths.set(e,0),this.glyphHeights.set(e,0));this.numberedBarRendererBarSize=2*this.staffLineThickness,this.numberedBarRendererBarSpacing=this.beamSpacing+this.numberedBarRendererBarSize,this.preNoteEffectPadding=.4*this.oneStaffSpace,this.postNoteEffectPadding=.2*this.oneStaffSpace,this.lineRangedGlyphDashGap=.5*this.oneStaffSpace,this.lineRangedGlyphDashSize=1*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.numberedDashGlyphPadding=.3*this.oneStaffSpace,this.stringNumberCirclePadding=.3*this.oneStaffSpace,this.rowContainerPadding=Math.ceil(.3*this.oneStaffSpace),this.rowContainerGap=Math.ceil(1*this.oneStaffSpace),this.onNoteEffectPadding=.2*this.oneStaffSpace,this.alternateEndingsPadding=.3*this.oneStaffSpace,this.sustainPedalLinePadding=.5*this.oneStaffSpace,this.tieHeight=1.2*this.oneStaffSpace,this.beatTimerPadding=.22*this.oneStaffSpace,this.bendNoteHeadElementPadding=.22*this.oneStaffSpace,this.ghostParenthesisWidth=.6*this.oneStaffSpace,this.ghostParenthesisPadding=.3*this.oneStaffSpace,this.brokenBeamWidth=1*this.oneStaffSpace,this.tabWhammyTextPadding=.4*this.oneStaffSpace,this.tabWhammyDashSize=.4*this.oneStaffSpace,this.tabBendDashSize=.4*this.oneStaffSpace,this.songBookWhammyDipHeight=.6*this.oneStaffSpace,this.tabWhammyPerHalfHeight=.6*this.oneStaffSpace,this.tabBendPerValueHeight=.6*this.oneStaffSpace,this.tabBendLabelPadding=.3*this.oneStaffSpace,this.leftHandTabTieWidth=2.2*this.oneStaffSpace,this.numberedDashGlyphWidth=1.5*this.oneStaffSpace,this.deadSlappedLineWidth=.25*this.oneStaffSpace,this.simpleSlideWidth=1.3*this.oneStaffSpace,this.simpleSlideHeight=.3*this.oneStaffSpace,this.chordDiagramPaddingX=Math.ceil(.5*this.oneStaffSpace),this.chordDiagramPaddingY=Math.ceil(.2*this.oneStaffSpace),this.chordDiagramStringSpacing=Math.ceil(1.1*this.oneStaffSpace),this.chordDiagramFretSpacing=Math.ceil(1.3*this.oneStaffSpace),this.chordDiagramNutHeight=Math.ceil(.33*this.oneStaffSpace),this.chordDiagramFretHeight=Math.ceil(.1*this.oneStaffSpace),this.chordDiagramLineWidth=Math.ceil(.11*this.oneStaffSpace),this.tripletFeelBracketPadding=.2*this.oneStaffSpace,this.accidentalPadding=.1*this.oneStaffSpace,this.preBeatGlyphSpacing=.5*this.oneStaffSpace,this.tuningGlyphStringRowPadding=.2*this.oneStaffSpace}static smuflNameToMusicFontSymbol(e){const t=Va.smuflNameToGlyphNameMapping.has(e)?Va.smuflNameToGlyphNameMapping.get(e):e.substring(0,1).toUpperCase()+e.substring(1);return Aa.parseEnumExact(t,ne)}}Va.smuflNameToGlyphNameMapping=new Map([["4stringTabClef","FourStringTabClef"],["6stringTabClef","SixStringTabClef"]]),Va.bravuraMetadata={engravingDefaults:{arrowShaftThickness:.16,barlineSeparation:.4,beamSpacing:.25,beamThickness:.5,bracketThickness:.5,dashedBarlineDashLength:.5,dashedBarlineGapLength:.25,dashedBarlineThickness:.16,hairpinThickness:.16,legerLineExtension:.4,legerLineThickness:.16,lyricLineThickness:.16,octaveLineThickness:.16,pedalLineThickness:.16,repeatBarlineDotSeparation:.16,repeatEndingLineThickness:.16,slurEndpointThickness:.1,slurMidpointThickness:.22,staffLineThickness:.13,stemThickness:.12,subBracketThickness:.16,textEnclosureThickness:.16,thickBarlineThickness:.5,thinBarlineThickness:.16,tieEndpointThickness:.1,tieMidpointThickness:.22,thinThickBarlineSeparation:.4,tupletBracketThickness:.16},glyphBBoxes:{FourStringTabClef:{bBoxNE:[1.088,2.016],bBoxSW:[-.012,-2.032]},SixStringTabClef:{bBoxNE:[1.632,3.056],bBoxSW:[-.012,-2.992]},accidentalDoubleFlat:{bBoxNE:[1.644,1.748],bBoxSW:[0,-.7]},accidentalDoubleSharp:{bBoxNE:[.988,.508],bBoxSW:[0,-.5]},accidentalFlat:{bBoxNE:[.904,1.756],bBoxSW:[0,-.7]},accidentalNatural:{bBoxNE:[.672,1.364],bBoxSW:[0,-1.34]},accidentalQuarterToneFlatArrowUp:{bBoxNE:[.992,2.316],bBoxSW:[-.168,-.708]},accidentalQuarterToneSharpNaturalArrowUp:{bBoxNE:[.848,2.188],bBoxSW:[-.104,-1.36]},accidentalSharp:{bBoxNE:[.996,1.4],bBoxSW:[0,-1.392]},accidentalThreeQuarterTonesSharpArrowUp:{bBoxNE:[1.1,2.12],bBoxSW:[0,-1.388]},arrowheadBlackDown:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},arrowheadBlackUp:{bBoxNE:[.912,1.196],bBoxSW:[0,0]},articAccentAbove:{bBoxNE:[1.356,.98],bBoxSW:[0,.004]},articAccentBelow:{bBoxNE:[1.356,0],bBoxSW:[0,-.976]},articMarcatoAbove:{bBoxNE:[.94,1.012],bBoxSW:[-.004,-.004]},articMarcatoBelow:{bBoxNE:[.94,0],bBoxSW:[-.004,-1.016]},articStaccatoAbove:{bBoxNE:[.336,.336],bBoxSW:[0,0]},articStaccatoBelow:{bBoxNE:[.336,0],bBoxSW:[0,-.336]},articTenutoAbove:{bBoxNE:[1.352,.192],bBoxSW:[-.004,0]},articTenutoBelow:{bBoxNE:[1.352,0],bBoxSW:[-.004,-.192]},augmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},brace:{bBoxNE:[.328,3.988],bBoxSW:[.008,0]},bracketBottom:{bBoxNE:[1.876,0],bBoxSW:[0,-1.18]},bracketTop:{bBoxNE:[1.876,1.18],bBoxSW:[0,0]},cClef:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.024]},cClef8vb:{bBoxNE:[2.796,2.024],bBoxSW:[0,-2.964]},clef15:{bBoxNE:[1.436,1.02],bBoxSW:[0,-.012]},clef8:{bBoxNE:[.82,.988],bBoxSW:[0,0]},coda:{bBoxNE:[3.82,3.592],bBoxSW:[-.016,-.632]},dynamicCrescendoHairpin:{bBoxNE:[2.944,1.424],bBoxSW:[.016,.372]},dynamicFF:{bBoxNE:[2.44,1.776],bBoxSW:[-.54,-.608]},dynamicFFF:{bBoxNE:[3.32,1.776],bBoxSW:[-.62,-.608]},dynamicFFFF:{bBoxNE:[4.28,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFF:{bBoxNE:[5.24,1.776],bBoxSW:[-.62,-.608]},dynamicFFFFFF:{bBoxNE:[6.2,1.776],bBoxSW:[-.62,-.608]},dynamicForte:{bBoxNE:[1.456,1.776],bBoxSW:[-.564,-.608]},dynamicFortePiano:{bBoxNE:[2.476,1.776],bBoxSW:[-.564,-.608]},dynamicForzando:{bBoxNE:[1.988,1.776],bBoxSW:[-.564,-.608]},dynamicMF:{bBoxNE:[3.272,1.724],bBoxSW:[-.08,-.66]},dynamicMP:{bBoxNE:[3.3,1.096],bBoxSW:[-.08,-.568]},dynamicNiente:{bBoxNE:[1.232,1.096],bBoxSW:[-.092,-.04]},dynamicPF:{bBoxNE:[3.08,1.776],bBoxSW:[-.288,-.608]},dynamicPP:{bBoxNE:[2.912,1.096],bBoxSW:[-.328,-.568]},dynamicPPP:{bBoxNE:[4.292,1.096],bBoxSW:[-.368,-.568]},dynamicPPPP:{bBoxNE:[5.672,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPP:{bBoxNE:[7.092,1.096],bBoxSW:[-.408,-.568]},dynamicPPPPPP:{bBoxNE:[8.512,1.096],bBoxSW:[-.408,-.568]},dynamicPiano:{bBoxNE:[1.464,1.096],bBoxSW:[-.356,-.568]},dynamicRinforzando1:{bBoxNE:[2.5,1.776],bBoxSW:[-.08,-.608]},dynamicRinforzando2:{bBoxNE:[2.976,1.776],bBoxSW:[-.08,-.608]},dynamicSforzando1:{bBoxNE:[2.416,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPianissimo:{bBoxNE:[4.796,1.776],bBoxSW:[0,-.608]},dynamicSforzandoPiano:{bBoxNE:[3.38,1.776],bBoxSW:[0,-.608]},dynamicSforzato:{bBoxNE:[2.932,1.776],bBoxSW:[0,-.608]},dynamicSforzatoFF:{bBoxNE:[3.856,1.776],bBoxSW:[0,-.608]},dynamicSforzatoPiano:{bBoxNE:[4.304,1.776],bBoxSW:[0,-.608]},fClef:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.54]},fClef15ma:{bBoxNE:[2.736,1.984],bBoxSW:[-.02,-2.54]},fClef15mb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.968]},fClef8va:{bBoxNE:[2.736,1.98],bBoxSW:[-.02,-2.54]},fClef8vb:{bBoxNE:[2.736,1.048],bBoxSW:[-.02,-2.976]},fermataAbove:{bBoxNE:[2.42,1.316],bBoxSW:[.012,-.012]},fermataLongAbove:{bBoxNE:[2.412,1.332],bBoxSW:[0,-.004]},fermataShortAbove:{bBoxNE:[2.416,1.364],bBoxSW:[0,0]},fingering0:{bBoxNE:[.94,1.004],bBoxSW:[.08,-.004]},fingering1:{bBoxNE:[.548,1.016],bBoxSW:[.08,0]},fingering2:{bBoxNE:[.888,1.012],bBoxSW:[.08,-.012]},fingering3:{bBoxNE:[.82,1.008],bBoxSW:[.08,0]},fingering4:{bBoxNE:[.864,1.012],bBoxSW:[.08,.004]},fingering5:{bBoxNE:[.82,1.032],bBoxSW:[.08,0]},fingeringALower:{bBoxNE:[1.068,1.032],bBoxSW:[0,-.02]},fingeringCLower:{bBoxNE:[.888,1.044],bBoxSW:[0,-.028]},fingeringILower:{bBoxNE:[.656,1.54],bBoxSW:[-.052,-.028]},fingeringMLower:{bBoxNE:[1.66,1.028],bBoxSW:[-.032,-.016]},fingeringPLower:{bBoxNE:[1.088,1.028],bBoxSW:[-.216,-.612]},fingeringTLower:{bBoxNE:[.604,1.484],bBoxSW:[0,-.028]},flag128thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-2.32]},flag128thUp:{bBoxNE:[1.044,2.132],bBoxSW:[0,-3.248]},flag16thDown:{bBoxNE:[1.1635806326044895,3.2480256],bBoxSW:[0,-.036]},flag16thUp:{bBoxNE:[1.116,.008],bBoxSW:[0,-3.252]},flag256thDown:{bBoxNE:[1.196,3.252],bBoxSW:[0,-3.004]},flag256thUp:{bBoxNE:[1.056,2.816],bBoxSW:[0,-3.248]},flag32ndDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-.688]},flag32ndUp:{bBoxNE:[1.044,.596],bBoxSW:[0,-3.248]},flag64thDown:{bBoxNE:[1.092,3.248],bBoxSW:[0,-1.504]},flag64thUp:{bBoxNE:[1.044,1.388],bBoxSW:[0,-3.248]},flag8thDown:{bBoxNE:[1.224,3.232896633157715],bBoxSW:[0,-.056]},flag8thUp:{bBoxNE:[1.056,.036],bBoxSW:[0,-3.240768470618394]},fretboardFilledCircle:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardO:{bBoxNE:[.564,.564],bBoxSW:[0,0]},fretboardX:{bBoxNE:[.596,.596],bBoxSW:[0,0]},gClef:{bBoxNE:[2.684,4.392],bBoxSW:[0,-2.632]},gClef15ma:{bBoxNE:[2.684,5.276],bBoxSW:[0,-2.632]},gClef15mb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.524]},gClef8va:{bBoxNE:[2.684,5.28],bBoxSW:[0,-2.632]},gClef8vb:{bBoxNE:[2.684,4.392],bBoxSW:[0,-3.512]},graceNoteSlashStemDown:{bBoxNE:[2.02,0],bBoxSW:[0,-1.604]},graceNoteSlashStemUp:{bBoxNE:[2.02,1.604],bBoxSW:[0,0]},guitarClosePedal:{bBoxNE:[1.144,1.14],bBoxSW:[0,-.004]},guitarFadeIn:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarFadeOut:{bBoxNE:[1.448,1.46],bBoxSW:[0,0]},guitarGolpe:{bBoxNE:[1.08,1.128],bBoxSW:[.004,0]},guitarLeftHandTapping:{bBoxNE:[1.588,1.364],bBoxSW:[0,-.224]},guitarOpenPedal:{bBoxNE:[1.144,1.144],bBoxSW:[0,0]},guitarString0:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString1:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString2:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString3:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString4:{bBoxNE:[2.164,2.156],bBoxSW:[.004,0]},guitarString5:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString6:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString7:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString8:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarString9:{bBoxNE:[2.16,2.156],bBoxSW:[0,0]},guitarVibratoStroke:{bBoxNE:[.668,.476],bBoxSW:[-.056,0]},guitarVolumeSwell:{bBoxNE:[2.896,1.46],bBoxSW:[0,0]},guitarWideVibratoStroke:{bBoxNE:[.908,.896],bBoxSW:[-.096,0]},keyboardPedalPed:{bBoxNE:[4.076,2.22],bBoxSW:[0,-.032]},keyboardPedalUp:{bBoxNE:[1.8,1.8],bBoxSW:[0,0]},metAugmentationDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},metNote8thUp:{bBoxNE:[2.132,2.784],bBoxSW:[0,-.564]},metNoteQuarterUp:{bBoxNE:[1.328,2.752],bBoxSW:[0,-.564]},note8thUp:{bBoxNE:[2.264,3.492],bBoxSW:[0,-.552]},noteQuarterUp:{bBoxNE:[1.328,3.5],bBoxSW:[0,-.564]},noteShapeDiamondBlack:{bBoxNE:[1.444,.548],bBoxSW:[0,-.552]},noteShapeDiamondWhite:{bBoxNE:[1.444,.544],bBoxSW:[0,-.556]},noteShapeMoonBlack:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeMoonWhite:{bBoxNE:[1.444,.5],bBoxSW:[0,-.5]},noteShapeRoundBlack:{bBoxNE:[1.456,.552],bBoxSW:[0,-.552]},noteShapeRoundWhite:{bBoxNE:[1.464,.548],bBoxSW:[0,-.548]},noteShapeSquareBlack:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeSquareWhite:{bBoxNE:[1.44,.46],bBoxSW:[0,-.46]},noteShapeTriangleLeftBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleLeftWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightBlack:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRightWhite:{bBoxNE:[1.44,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleRoundWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpBlack:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteShapeTriangleUpWhite:{bBoxNE:[1.424,.5],bBoxSW:[0,-.5]},noteheadBlack:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadCircleSlash:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleX:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircleXDoubleWhole:{bBoxNE:[1.688,.62],bBoxSW:[0,-.62]},noteheadCircleXHalf:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadCircleXWhole:{bBoxNE:[.996,.5],bBoxSW:[0,-.5]},noteheadCircledBlack:{bBoxNE:[1.284,.668],bBoxSW:[-.084,-.684]},noteheadCircledDoubleWhole:{bBoxNE:[2.412,.852],bBoxSW:[0,-.872]},noteheadCircledHalf:{bBoxNE:[1.244,.668],bBoxSW:[-.072,-.648]},noteheadCircledWhole:{bBoxNE:[1.748,.844],bBoxSW:[0,-.9]},noteheadClusterDoubleWhole3rd:{bBoxNE:[2.428,1.62],bBoxSW:[0,-.62]},noteheadClusterHalf3rd:{bBoxNE:[1.264,1.5],bBoxSW:[0,-.5]},noteheadClusterQuarter3rd:{bBoxNE:[1.44,1.5],bBoxSW:[0,-.5]},noteheadClusterWhole3rd:{bBoxNE:[1.7,1.5],bBoxSW:[0,-.5]},noteheadDiamondBlack:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondBlackWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondDoubleWhole:{bBoxNE:[1.728,.62],bBoxSW:[0,-.62]},noteheadDiamondHalf:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadDiamondWhite:{bBoxNE:[1,.5],bBoxSW:[0,-.5]},noteheadDiamondWhiteWide:{bBoxNE:[1.4,.5],bBoxSW:[0,-.5]},noteheadDiamondWhole:{bBoxNE:[1.08,.5],bBoxSW:[0,-.5]},noteheadDoubleWhole:{bBoxNE:[2.396,.62],bBoxSW:[0,-.62]},noteheadDoubleWholeSquare:{bBoxNE:[1.664,.792],bBoxSW:[0,-.76]},noteheadHalf:{bBoxNE:[1.18,.5],bBoxSW:[0,-.5]},noteheadHeavyX:{bBoxNE:[1.54,.5],bBoxSW:[0,-.5]},noteheadHeavyXHat:{bBoxNE:[1.828,1.04],bBoxSW:[-.292,-.5]},noteheadParenthesis:{bBoxNE:[1.472,.728],bBoxSW:[-.292,-.72]},noteheadPlusBlack:{bBoxNE:[.996,.5],bBoxSW:[-.004,-.5]},noteheadPlusDoubleWhole:{bBoxNE:[1.892,.62],bBoxSW:[0,-.62]},noteheadPlusHalf:{bBoxNE:[1.044,.5],bBoxSW:[0,-.5]},noteheadPlusWhole:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadRoundWhiteWithDot:{bBoxNE:[1.004,.5],bBoxSW:[0,-.5]},noteheadSlashHorizontalEnds:{bBoxNE:[2.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteHalf:{bBoxNE:[3.12,1],bBoxSW:[0,-1]},noteheadSlashWhiteWhole:{bBoxNE:[3.92,1],bBoxSW:[0,-1]},noteheadSlashedBlack1:{bBoxNE:[1.5,.668],bBoxSW:[-.32,-.66]},noteheadSlashedBlack2:{bBoxNE:[1.504,.672],bBoxSW:[-.316,-.656]},noteheadSlashedDoubleWhole1:{bBoxNE:[2.384,.672],bBoxSW:[0,-.716]},noteheadSlashedDoubleWhole2:{bBoxNE:[2.384,.676],bBoxSW:[0,-.712]},noteheadSlashedHalf1:{bBoxNE:[1.544,.64],bBoxSW:[-.268,-.568]},noteheadSlashedHalf2:{bBoxNE:[1.52,.672],bBoxSW:[-.292,-.536]},noteheadSlashedWhole1:{bBoxNE:[1.732,.592],bBoxSW:[-.088,-.628]},noteheadSlashedWhole2:{bBoxNE:[1.744,.604],bBoxSW:[-.072,-.616]},noteheadSquareBlack:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadSquareBlackLarge:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareBlackWhite:{bBoxNE:[2,1],bBoxSW:[0,-1]},noteheadSquareWhite:{bBoxNE:[1.252,.5],bBoxSW:[0,-.5]},noteheadTriangleDownBlack:{bBoxNE:[1.168,.5],bBoxSW:[0,-.5]},noteheadTriangleDownDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleDownHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleDownWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadTriangleRightBlack:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleRightWhite:{bBoxNE:[1.356,.5],bBoxSW:[0,-.5]},noteheadTriangleUpBlack:{bBoxNE:[1.172,.5],bBoxSW:[0,-.5]},noteheadTriangleUpDoubleWhole:{bBoxNE:[1.932,.62],bBoxSW:[0,-.62]},noteheadTriangleUpHalf:{bBoxNE:[1.14,.5],bBoxSW:[0,-.5]},noteheadTriangleUpWhole:{bBoxNE:[1.276,.5],bBoxSW:[0,-.5]},noteheadWhole:{bBoxNE:[1.688,.5],bBoxSW:[0,-.5]},noteheadXBlack:{bBoxNE:[1.16,.5],bBoxSW:[0,-.5]},noteheadXDoubleWhole:{bBoxNE:[2.184,.62],bBoxSW:[0,-.62]},noteheadXHalf:{bBoxNE:[1.336,.5],bBoxSW:[0,-.5]},noteheadXOrnate:{bBoxNE:[.988,.504],bBoxSW:[0,-.504]},noteheadXWhole:{bBoxNE:[1.508,.5],bBoxSW:[0,-.5]},octaveBaselineB:{bBoxNE:[.796,1.352],bBoxSW:[0,-.04]},octaveBaselineM:{bBoxNE:[1.524,.928],bBoxSW:[0,-.02]},ornamentMordent:{bBoxNE:[2.916,1.276],bBoxSW:[.004,-.292]},ornamentShortTrill:{bBoxNE:[2.9,.98],bBoxSW:[0,0]},ornamentTrill:{bBoxNE:[2.084,1.56],bBoxSW:[0,-.04]},ornamentTurn:{bBoxNE:[1.84,.872],bBoxSW:[0,0]},ornamentTurnInverted:{bBoxNE:[1.828,.872],bBoxSW:[-.012,0]},ottava:{bBoxNE:[1.544,1.852],bBoxSW:[0,-.04]},ottavaAlta:{bBoxNE:[3.54,1.852],bBoxSW:[0,-.04]},ottavaBassaVb:{bBoxNE:[3.184,1.852],bBoxSW:[0,-.04]},pictEdgeOfCymbal:{bBoxNE:[4.828,2.14],bBoxSW:[.004,0]},quindicesima:{bBoxNE:[2.668,1.844],bBoxSW:[0,-.04]},quindicesimaAlta:{bBoxNE:[5.26,1.844],bBoxSW:[0,-.04]},repeat1Bar:{bBoxNE:[2.128,1.116],bBoxSW:[0,-1]},repeat2Bars:{bBoxNE:[3.048,1.116],bBoxSW:[0,-1]},repeatDot:{bBoxNE:[.4,.2],bBoxSW:[0,-.2]},rest128th:{bBoxNE:[1.94,2.756],bBoxSW:[0,-3]},rest16th:{bBoxNE:[1.28,.716],bBoxSW:[0,-2]},rest256th:{bBoxNE:[2.164,2.784],bBoxSW:[0,-4]},rest32nd:{bBoxNE:[1.452,1.704],bBoxSW:[0,-2]},rest64th:{bBoxNE:[1.692,1.72],bBoxSW:[0,-3.012]},rest8th:{bBoxNE:[.988,.696],bBoxSW:[0,-1.004]},restDoubleWhole:{bBoxNE:[.5,1],bBoxSW:[0,0]},restHBarLeft:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHBarMiddle:{bBoxNE:[1.42,.384],bBoxSW:[-.108,-.416]},restHBarRight:{bBoxNE:[1.5,1.048],bBoxSW:[0,-1.08]},restHalf:{bBoxNE:[1.128,.568],bBoxSW:[0,-.008]},restLonga:{bBoxNE:[.5,1],bBoxSW:[0,-.996]},restQuarter:{bBoxNE:[1.08,1.492],bBoxSW:[.004,-1.5]},restWhole:{bBoxNE:[1.128,.036],bBoxSW:[0,-.54]},segno:{bBoxNE:[2.2,3.036],bBoxSW:[.016,-.108]},stringsDownBow:{bBoxNE:[1.248,1.272],bBoxSW:[0,0]},stringsUpBow:{bBoxNE:[.996,1.98],bBoxSW:[.004,.004]},systemDivider:{bBoxNE:[4.232,4.24],bBoxSW:[0,-.272]},textAugmentationDot:{bBoxNE:[.4,.256],bBoxSW:[0,-.144]},textBlackNoteFrac16thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac32ndLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteFrac8thLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,-.56]},textBlackNoteLongStem:{bBoxNE:[1.328,3.512],bBoxSW:[0,-.564]},textCont16thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,2.264]},textCont32ndBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,1.504]},textCont8thBeamLongStem:{bBoxNE:[1.368,3.512],bBoxSW:[0,3.012]},textTuplet3LongStem:{bBoxNE:[.94,5.3],bBoxSW:[0,4.2]},textTupletBracketEndLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},textTupletBracketStartLongStem:{bBoxNE:[1.272,4.764],bBoxSW:[0,3.94]},timeSig0:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig1:{bBoxNE:[1.256,1.004],bBoxSW:[.08,-1]},timeSig2:{bBoxNE:[1.704,1.016],bBoxSW:[.08,-1.028]},timeSig3:{bBoxNE:[1.604,.996],bBoxSW:[.08,-1.004]},timeSig4:{bBoxNE:[1.8,1.004],bBoxSW:[.08,-1]},timeSig5:{bBoxNE:[1.532,.984],bBoxSW:[.08,-1.004]},timeSig6:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSig7:{bBoxNE:[1.684,.996],bBoxSW:[.08,-1]},timeSig8:{bBoxNE:[1.664,1.036],bBoxSW:[.08,-1.036]},timeSig9:{bBoxNE:[1.656,1.004],bBoxSW:[.08,-.996]},timeSigCommon:{bBoxNE:[1.696,1.004],bBoxSW:[.02,-.996]},timeSigCutCommon:{bBoxNE:[1.672,1.444],bBoxSW:[0,-1.436]},tremolo1:{bBoxNE:[.6,.376],bBoxSW:[-.6,-.372]},tremolo2:{bBoxNE:[.596,.748],bBoxSW:[-.604,-.748]},tremolo3:{bBoxNE:[.6,1.112],bBoxSW:[-.6,-1.12]},tuplet0:{bBoxNE:[1.2731041262817027,1.5],bBoxSW:[-.001204330173715796,-.032]},tuplet1:{bBoxNE:[1.024,1.488],bBoxSW:[.04,0]},tuplet2:{bBoxNE:[1.316,1.5],bBoxSW:[.04,-.024]},tuplet3:{bBoxNE:[1.224,1.5],bBoxSW:[.04,-.032]},tuplet4:{bBoxNE:[1.252,1.488],bBoxSW:[.04,0]},tuplet5:{bBoxNE:[1.308,1.492],bBoxSW:[.04,-.032]},tuplet6:{bBoxNE:[1.256,1.5],bBoxSW:[.04105974105482295,-.032]},tuplet7:{bBoxNE:[1.332,1.488],bBoxSW:[.12,-.016]},tuplet8:{bBoxNE:[1.292,1.5],bBoxSW:[.04,-.032]},tuplet9:{bBoxNE:[1.254940258945177,1.5],bBoxSW:[.04,-.032]},tupletColon:{bBoxNE:[.484,1.072],bBoxSW:[.04,.232]},unpitchedPercussionClef1:{bBoxNE:[1.528,1],bBoxSW:[0,-1]},wiggleSawtooth:{bBoxNE:[3.06,1.06],bBoxSW:[-.068,-1.068]},wiggleSawtoothNarrow:{bBoxNE:[2.06,1.064],bBoxSW:[-.072,-1.064]},wiggleTrill:{bBoxNE:[1.08,.836],bBoxSW:[-.144,.392]},wiggleVibratoMediumFast:{bBoxNE:[1.292,.8],bBoxSW:[-.104,-.164]}},glyphsWithAnchors:{accidentalDoubleFlat:{cutOutNE:[.988,.644],cutOutSE:[1.336,-.396]},accidentalFlat:{cutOutNE:[.252,.656],cutOutSE:[.504,-.476]},accidentalNatural:{cutOutNE:[.192,.776],cutOutSW:[.476,-.828]},accidentalQuarterToneFlatArrowUp:{cutOutNE:[.604,.664],cutOutSE:[.62,-.452]},accidentalQuarterToneSharpNaturalArrowUp:{cutOutSW:[.616,-.868]},accidentalSharp:{cutOutNE:[.84,.896],cutOutNW:[.144,.568],cutOutSE:[.84,-.596],cutOutSW:[.144,-.896]},accidentalThreeQuarterTonesSharpArrowUp:{cutOutNW:[.272,1.304],cutOutSE:[.86,-.584],cutOutSW:[.132,-.888]},dynamicFF:{opticalCenter:[1.852,0]},dynamicFFF:{opticalCenter:[2.472,0]},dynamicFFFF:{opticalCenter:[2.824,0]},dynamicFFFFF:{opticalCenter:[2.976,0]},dynamicFFFFFF:{opticalCenter:[3.504,0]},dynamicForte:{opticalCenter:[1.256,0]},dynamicFortePiano:{opticalCenter:[1.5,0]},dynamicForzando:{opticalCenter:[1.352,0]},dynamicMF:{opticalCenter:[1.796,0]},dynamicMP:{opticalCenter:[1.848,0]},dynamicNiente:{opticalCenter:[.616,0]},dynamicPF:{opticalCenter:[1.68,0]},dynamicPP:{opticalCenter:[1.708,0]},dynamicPPP:{opticalCenter:[2.368,0]},dynamicPPPP:{opticalCenter:[3.004,0]},dynamicPPPPP:{opticalCenter:[3.552,0]},dynamicPPPPPP:{opticalCenter:[4.248,0]},dynamicPiano:{opticalCenter:[1.22,0]},dynamicRinforzando1:{opticalCenter:[1.564,0]},dynamicRinforzando2:{opticalCenter:[2.084,0]},dynamicSforzando1:{opticalCenter:[1.3,0]},dynamicSforzandoPianissimo:{opticalCenter:[1.972,0]},dynamicSforzandoPiano:{opticalCenter:[1.904,0]},dynamicSforzato:{opticalCenter:[1.76,0]},dynamicSforzatoFF:{opticalCenter:[2.276,0]},dynamicSforzatoPiano:{opticalCenter:[1.848,0]},flag128thDown:{stemDownSW:[0,-2.076]},flag128thUp:{stemUpNW:[0,1.9]},flag16thDown:{stemDownSW:[0,.128]},flag16thUp:{stemUpNW:[0,-.088]},flag256thDown:{stemDownSW:[0,-2.812]},flag256thUp:{stemUpNW:[0,2.592]},flag32ndDown:{stemDownSW:[0,-.448]},flag32ndUp:{stemUpNW:[0,.376]},flag64thDown:{stemDownSW:[0,-1.244]},flag64thUp:{stemUpNW:[0,1.172]},flag8thDown:{graceNoteSlashNW:[-.596,2.168],graceNoteSlashSE:[1.328,.628],stemDownSW:[0,.132]},flag8thUp:{graceNoteSlashNE:[1.284,-.796],graceNoteSlashSW:[-.644,-2.456],stemUpNW:[0,-.04]},guitarVibratoStroke:{repeatOffset:[.608,0]},guitarWideVibratoStroke:{repeatOffset:[.82,0]},noteShapeDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1.444,0]},noteShapeDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1.436,0]},noteShapeMoonBlack:{stemDownNW:[0,.068],stemUpSE:[1.44,.068]},noteShapeMoonWhite:{stemDownNW:[0,.072],stemUpSE:[1.444,.068]},noteShapeRoundBlack:{stemDownNW:[0,-.168],stemUpSE:[1.444,.184]},noteShapeRoundWhite:{stemDownNW:[0,-.168],stemUpSE:[1.456,.192]},noteShapeSquareBlack:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeSquareWhite:{stemDownNW:[0,.46],stemUpSE:[1.44,-.46]},noteShapeTriangleLeftBlack:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleLeftWhite:{stemDownNW:[0,.5],stemUpSE:[1.436,-.5]},noteShapeTriangleRightBlack:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRightWhite:{stemDownNW:[0,.476],stemUpSE:[1.44,-.5]},noteShapeTriangleRoundBlack:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleRoundWhite:{stemDownNW:[0,.172],stemUpSE:[1.424,.172]},noteShapeTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteShapeTriangleUpWhite:{stemDownNW:[0,-.5],stemUpSE:[1.424,-.5]},noteheadBlack:{cutOutNW:[.208,.3],cutOutSE:[.94,-.296],splitStemDownNE:[.968,-.248],splitStemDownNW:[.12,-.416],splitStemUpSE:[1.092,.392],splitStemUpSW:[.312,.356],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadCircleSlash:{stemDownNW:[.004,0],stemUpSE:[1,0]},noteheadCircleX:{stemDownNW:[0,0],stemUpSE:[.996,0]},noteheadCircleXDoubleWhole:{noteheadOrigin:[.352,0]},noteheadCircleXHalf:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadCircledBlack:{stemDownNW:[0,-.164],stemUpSE:[1.18,.168]},noteheadCircledDoubleWhole:{noteheadOrigin:[.356,0]},noteheadCircledHalf:{stemDownNW:[0,-.144],stemUpSE:[1.172,.156]},noteheadClusterDoubleWhole3rd:{noteheadOrigin:[.364,0]},noteheadClusterHalf3rd:{stemDownNW:[0,-.164],stemUpSE:[1.264,1.144]},noteheadClusterQuarter3rd:{stemDownNW:[0,.26],stemUpSE:[1.44,.744]},noteheadDiamondBlack:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondBlackWide:{stemDownNW:[0,0],stemUpSE:[1.4,0]},noteheadDiamondDoubleWhole:{noteheadOrigin:[.324,0]},noteheadDiamondHalf:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadDiamondWhite:{stemDownNW:[0,0],stemUpSE:[1,0]},noteheadDiamondWhiteWide:{stemDownNW:[0,.004],stemUpSE:[1.4,0]},noteheadDoubleWhole:{noteheadOrigin:[.36,0]},noteheadHalf:{cutOutNW:[.204,.296],cutOutSE:[.98,-.3],splitStemDownNE:[.956,-.3],splitStemDownNW:[.128,-.428],splitStemUpSE:[1.108,.372],splitStemUpSW:[.328,.38],stemDownNW:[0,-.168],stemUpSE:[1.18,.168]},noteheadHeavyX:{stemDownNW:[0,-.436],stemUpSE:[1.54,.44]},noteheadHeavyXHat:{stemDownNW:[0,-.436],stemUpSE:[1.54,.456]},noteheadPlusBlack:{stemDownNW:[-.004,0],stemUpSE:[.996,0]},noteheadPlusDoubleWhole:{noteheadOrigin:[.372,0]},noteheadPlusHalf:{stemDownNW:[0,-.112],stemUpSE:[1.044,.088]},noteheadRoundWhiteWithDot:{stemDownNW:[0,0],stemUpSE:[1.004,0]},noteheadSlashHorizontalEnds:{stemDownNW:[0,-1],stemUpSE:[2.12,1]},noteheadSlashWhiteHalf:{stemDownNW:[0,-1],stemUpSE:[3.12,1]},noteheadSlashedBlack1:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedBlack2:{stemDownNW:[0,-.172],stemUpSE:[1.18,.164]},noteheadSlashedDoubleWhole1:{noteheadOrigin:[.356,0]},noteheadSlashedDoubleWhole2:{noteheadOrigin:[.356,0]},noteheadSlashedHalf1:{stemDownNW:[0,-.168],stemUpSE:[1.168,.164]},noteheadSlashedHalf2:{stemDownNW:[0,-.164],stemUpSE:[1.172,.168]},noteheadSquareBlack:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadSquareBlackLarge:{stemDownNW:[0,0],stemUpSE:[2,0]},noteheadSquareBlackWhite:{stemDownNW:[0,-1],stemUpSE:[2,1]},noteheadSquareWhite:{stemDownNW:[0,-.5],stemUpSE:[1.252,.5]},noteheadTriangleDownBlack:{stemDownNW:[0,.5],stemUpSE:[1.168,.5]},noteheadTriangleDownDoubleWhole:{noteheadOrigin:[.384,0]},noteheadTriangleDownHalf:{stemDownNW:[0,.464],stemUpSE:[1.14,.464]},noteheadTriangleRightBlack:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleRightWhite:{stemDownNW:[0,-.5],stemUpSE:[1.356,.5]},noteheadTriangleUpBlack:{stemDownNW:[0,-.5],stemUpSE:[1.172,-.5]},noteheadTriangleUpDoubleWhole:{noteheadOrigin:[.34,0]},noteheadTriangleUpHalf:{stemDownNW:[0,-.46],stemUpSE:[1.14,-.46]},noteheadWhole:{cutOutNW:[.172,.332],cutOutSE:[1.532,-.364]},noteheadXBlack:{stemDownNW:[0,-.44],stemUpSE:[1.16,.444]},noteheadXDoubleWhole:{noteheadOrigin:[.348,0]},noteheadXHalf:{stemDownNW:[0,-.412],stemUpSE:[1.336,.412]},noteheadXOrnate:{stemDownNW:[0,-.312],stemUpSE:[.988,.316]},wiggleSawtooth:{repeatOffset:[2.992,0]},wiggleSawtoothNarrow:{repeatOffset:[1.996,0]},wiggleTrill:{repeatOffset:[.948,0]},wiggleVibratoMediumFast:{repeatOffset:[1.18,0]}}};class Ua{constructor(){this.engravingSettings=Va.bravuraDefaults,this.copyrightFont=new Wa(Ua.sansFont,12,Wt.Plain,Ht.Bold),this.titleFont=new Wa(Ua.serifFont,32,Wt.Plain),this.subTitleFont=new Wa(Ua.serifFont,20,Wt.Plain),this.wordsFont=new Wa(Ua.serifFont,15,Wt.Plain),this.effectFont=new Wa(Ua.serifFont,12,Wt.Italic),this.timerFont=new Wa(Ua.serifFont,12,Wt.Plain),this.directionsFont=new Wa(Ua.serifFont,14,Wt.Plain),this.fretboardNumberFont=new Wa(Ua.sansFont,11,Wt.Plain),this.numberedNotationFont=new Wa(Ua.sansFont,16,Wt.Plain),this.numberedNotationGraceFont=new Wa(Ua.sansFont,14,Wt.Plain),this.tablatureFont=new Wa(Ua.sansFont,14,Wt.Plain),this.graceFont=new Wa(Ua.sansFont,12,Wt.Plain),this.staffLineColor=new at(165,165,165,255),this.barSeparatorColor=new at(34,34,17,255),this.barNumberFont=new Wa(Ua.sansFont,11,Wt.Plain),this.barNumberColor=new at(200,0,0,255),this.fingeringFont=new Wa(Ua.serifFont,14,Wt.Plain),this.inlineFingeringFont=new Wa(Ua.serifFont,12,Wt.Plain),this.markerFont=new Wa(Ua.serifFont,14,Wt.Plain,Ht.Bold),this.mainGlyphColor=new at(0,0,0,255),this.secondaryGlyphColor=new at(0,0,0,100),this.scoreInfoColor=new at(0,0,0,255)}getFontForElement(e){switch(e){case ke.Title:return this.titleFont;case ke.SubTitle:case ke.Artist:case ke.Album:return this.subTitleFont;case ke.Words:case ke.Music:case ke.WordsAndMusic:case ke.Transcriber:return this.wordsFont;case ke.Copyright:case ke.CopyrightSecondLine:return this.copyrightFont}return this.wordsFont}}Ua.sansFont="Arial, sans-serif",Ua.serifFont="Georgia, serif",e.StaveProfile=void 0,(Gt=e.StaveProfile||(e.StaveProfile={}))[Gt.Default=0]="Default",Gt[Gt.ScoreTab=1]="ScoreTab",Gt[Gt.Score=2]="Score",Gt[Gt.Tab=3]="Tab",Gt[Gt.TabMixed=4]="TabMixed",e.SystemsLayoutMode=void 0,(Vt=e.SystemsLayoutMode||(e.SystemsLayoutMode={}))[Vt.Automatic=0]="Automatic",Vt[Vt.UseModelLayout=1]="UseModelLayout";class za{constructor(){this.scale=1,this.stretchForce=1,this.layoutMode=e.LayoutMode.Page,this.staveProfile=e.StaveProfile.Default,this.barsPerRow=-1,this.startBar=1,this.barCount=-1,this.barCountPerPartial=10,this.justifyLastSystem=!1,this.resources=new Ua,this.padding=[35,35],this.firstSystemPaddingTop=5,this.systemPaddingTop=10,this.systemPaddingBottom=10,this.lastSystemPaddingBottom=0,this.systemLabelPaddingLeft=0,this.systemLabelPaddingRight=3,this.accoladeBarPaddingRight=3,this.notationStaffPaddingTop=5,this.notationStaffPaddingBottom=5,this.effectStaffPaddingTop=0,this.effectStaffPaddingBottom=0,this.firstStaffPaddingLeft=6,this.staffPaddingLeft=2,this.effectBandPaddingBottom=2,this.systemsLayoutMode=e.SystemsLayoutMode.Automatic}}class Xa{constructor(){this.encoding="utf-8",this.mergePartGroupsInMusicXml=!1,this.beatTextAsLyrics=!1}}e.ScrollMode=void 0,(Ut=e.ScrollMode||(e.ScrollMode={}))[Ut.Off=0]="Off",Ut[Ut.Continuous=1]="Continuous",Ut[Ut.OffScreen=2]="OffScreen";class Ya{constructor(){this.noteWideLength=240,this.noteWideAmplitude=1,this.noteSlightLength=360,this.noteSlightAmplitude=.5,this.beatWideLength=480,this.beatWideAmplitude=2,this.beatSlightLength=480,this.beatSlightAmplitude=2}}class Ja{constructor(){this.simpleSlidePitchOffset=6,this.simpleSlideDurationRatio=.25,this.shiftSlideDurationRatio=.5}}e.PlayerOutputMode=void 0,(zt=e.PlayerOutputMode||(e.PlayerOutputMode={}))[zt.WebAudioAudioWorklets=0]="WebAudioAudioWorklets",zt[zt.WebAudioScriptProcessor=1]="WebAudioScriptProcessor",e.PlayerMode=void 0,(Xt=e.PlayerMode||(e.PlayerMode={}))[Xt.Disabled=0]="Disabled",Xt[Xt.EnabledAutomatic=1]="EnabledAutomatic",Xt[Xt.EnabledSynthesizer=2]="EnabledSynthesizer",Xt[Xt.EnabledBackingTrack=3]="EnabledBackingTrack",Xt[Xt.EnabledExternalMedia=4]="EnabledExternalMedia";class $a{constructor(){this.soundFont=null,this.scrollElement="html,body",this.outputMode=e.PlayerOutputMode.WebAudioAudioWorklets,this.enablePlayer=!1,this.playerMode=e.PlayerMode.Disabled,this.enableCursor=!0,this.enableAnimatedBeatCursor=!0,this.enableElementHighlighting=!0,this.enableUserInteraction=!0,this.scrollOffsetX=0,this.scrollOffsetY=0,this.scrollMode=e.ScrollMode.Continuous,this.scrollSpeed=300,this.nativeBrowserSmoothScroll=!0,this.songBookBendDuration=75,this.songBookDipDuration=150,this.vibrato=new Ya,this.slide=new Ja,this.playTripletFeel=!0,this.bufferTimeInMilliseconds=500}}class qa{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>qa.setProperty(e,s.toLowerCase(),t))}static toJson(e){if(!e)return null;const t=new Map;if(t.set("scriptfile",e.scriptFile),t.set("fontdirectory",e.fontDirectory),null!==e.smuflFontSources){const s=new Map;t.set("smuflfontsources",s);for(const[t,i]of e.smuflFontSources)s.set(t.toString(),i)}return t.set("file",e.file),t.set("tex",e.tex),t.set("tracks",e.tracks),t.set("enablelazyloading",e.enableLazyLoading),t.set("engine",e.engine),t.set("loglevel",e.logLevel),t.set("useworkers",e.useWorkers),t.set("includenotebounds",e.includeNoteBounds),t}static setProperty(t,s,i){switch(s){case"scriptfile":return t.scriptFile=i,!0;case"fontdirectory":return t.fontDirectory=i,!0;case"smuflfontsources":return t.smuflFontSources=new Map,Aa.forEach(i,(s,i)=>{t.smuflFontSources.set(Aa.parseEnum(i,e.FontFileFormat),s)}),!0;case"file":return t.file=i,!0;case"tex":return t.tex=i,!0;case"tracks":return t.tracks=i,!0;case"enablelazyloading":return t.enableLazyLoading=i,!0;case"engine":return t.engine=i,!0;case"loglevel":return t.logLevel=Aa.parseEnum(i,e.LogLevel),!0;case"useworkers":return t.useWorkers=i,!0;case"includenotebounds":return t.includeNoteBounds=i,!0}return!1}}class ja{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>ja.setProperty(e,s.toLowerCase(),t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("topy",e.topY),t.set("bottomy",e.bottomY),t.set("x",e.x),t}static setProperty(e,t,s){switch(t){case"topy":return e.topY=s,!0;case"bottomy":return e.bottomY=s,!0;case"x":return e.x=s,!0}return!1}}class Ka{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Ka.setProperty(e,s.toLowerCase(),t))}static toJson(e){if(!e)return null;const t=new Map;t.set("musicfontsize",e.musicFontSize),t.set("onestaffspace",e.oneStaffSpace),t.set("tablinespacing",e.tabLineSpacing),t.set("arrowshaftthickness",e.arrowShaftThickness),t.set("barlineseparation",e.barlineSeparation),t.set("beamspacing",e.beamSpacing),t.set("beamthickness",e.beamThickness),t.set("bracketthickness",e.bracketThickness),t.set("dashedbarlinedashlength",e.dashedBarlineDashLength),t.set("dashedbarlinegaplength",e.dashedBarlineGapLength),t.set("dashedbarlinethickness",e.dashedBarlineThickness),t.set("hairpinthickness",e.hairpinThickness),t.set("legerlinethickness",e.legerLineThickness),t.set("legerlineextension",e.legerLineExtension),t.set("octavelinethickness",e.octaveLineThickness),t.set("pedallinethickness",e.pedalLineThickness),t.set("repeatbarlinedotseparation",e.repeatBarlineDotSeparation),t.set("repeatendinglinethickness",e.repeatEndingLineThickness),t.set("slurmidpointthickness",e.slurMidpointThickness),t.set("stafflinethickness",e.staffLineThickness),t.set("stemthickness",e.stemThickness),t.set("thickbarlinethickness",e.thickBarlineThickness),t.set("thinbarlinethickness",e.thinBarlineThickness),t.set("thinthickbarlineseparation",e.thinThickBarlineSeparation),t.set("tiemidpointthickness",e.tieMidpointThickness),t.set("tupletbracketthickness",e.tupletBracketThickness);{const s=new Map;t.set("stemup",s);for(const[t,i]of e.stemUp)s.set(t.toString(),ja.toJson(i))}{const s=new Map;t.set("stemdown",s);for(const[t,i]of e.stemDown)s.set(t.toString(),ja.toJson(i))}{const s=new Map;t.set("repeatoffsetx",s);for(const[t,i]of e.repeatOffsetX)s.set(t.toString(),i)}t.set("standardstemlength",e.standardStemLength);{const s=new Map;t.set("stemflagoffsets",s);for(const[t,i]of e.stemFlagOffsets)s.set(t.toString(),i)}{const s=new Map;t.set("glyphtop",s);for(const[t,i]of e.glyphTop)s.set(t.toString(),i)}{const s=new Map;t.set("glyphbottom",s);for(const[t,i]of e.glyphBottom)s.set(t.toString(),i)}{const s=new Map;t.set("glyphwidths",s);for(const[t,i]of e.glyphWidths)s.set(t.toString(),i)}{const s=new Map;t.set("glyphheights",s);for(const[t,i]of e.glyphHeights)s.set(t.toString(),i)}return t.set("numberedbarrendererbarsize",e.numberedBarRendererBarSize),t.set("numberedbarrendererbarspacing",e.numberedBarRendererBarSpacing),t.set("numbereddashglyphpadding",e.numberedDashGlyphPadding),t.set("numbereddashglyphwidth",e.numberedDashGlyphWidth),t.set("linerangedglyphdashgap",e.lineRangedGlyphDashGap),t.set("linerangedglyphdashsize",e.lineRangedGlyphDashSize),t.set("prenoteeffectpadding",e.preNoteEffectPadding),t.set("postnoteeffectpadding",e.postNoteEffectPadding),t.set("onnoteeffectpadding",e.onNoteEffectPadding),t.set("stringnumbercirclepadding",e.stringNumberCirclePadding),t.set("rowcontainerpadding",e.rowContainerPadding),t.set("rowcontainergap",e.rowContainerGap),t.set("alternateendingspadding",e.alternateEndingsPadding),t.set("sustainpedallinepadding",e.sustainPedalLinePadding),t.set("tieheight",e.tieHeight),t.set("beattimerpadding",e.beatTimerPadding),t.set("bendnoteheadelementpadding",e.bendNoteHeadElementPadding),t.set("ghostparenthesiswidth",e.ghostParenthesisWidth),t.set("ghostparenthesispadding",e.ghostParenthesisPadding),t.set("brokenbeamwidth",e.brokenBeamWidth),t.set("tabwhammytextpadding",e.tabWhammyTextPadding),t.set("tabwhammyperhalfheight",e.tabWhammyPerHalfHeight),t.set("tabwhammydashsize",e.tabWhammyDashSize),t.set("songbookwhammydipheight",e.songBookWhammyDipHeight),t.set("deadslappedlinewidth",e.deadSlappedLineWidth),t.set("lefthandtabtiewidth",e.leftHandTabTieWidth),t.set("tabbenddashsize",e.tabBendDashSize),t.set("tabbendpervalueheight",e.tabBendPerValueHeight),t.set("tabbendlabelpadding",e.tabBendLabelPadding),t.set("simpleslidewidth",e.simpleSlideWidth),t.set("simpleslideheight",e.simpleSlideHeight),t.set("chorddiagrampaddingx",e.chordDiagramPaddingX),t.set("chorddiagrampaddingy",e.chordDiagramPaddingY),t.set("chorddiagramstringspacing",e.chordDiagramStringSpacing),t.set("chorddiagramfretspacing",e.chordDiagramFretSpacing),t.set("chorddiagramnutheight",e.chordDiagramNutHeight),t.set("chorddiagramfretheight",e.chordDiagramFretHeight),t.set("chorddiagramlinewidth",e.chordDiagramLineWidth),t.set("tripletfeelbracketpadding",e.tripletFeelBracketPadding),t.set("accidentalpadding",e.accidentalPadding),t.set("prebeatglyphspacing",e.preBeatGlyphSpacing),t.set("temponotescale",e.tempoNoteScale),t.set("tuningglyphcirclenumberscale",e.tuningGlyphCircleNumberScale),t.set("tuningglyphstringcolumnscale",e.tuningGlyphStringColumnScale),t.set("tuningglyphstringrowpadding",e.tuningGlyphStringRowPadding),t.set("directionsscale",e.directionsScale),t}static setProperty(e,t,s){switch(t){case"musicfontsize":return e.musicFontSize=s,!0;case"onestaffspace":return e.oneStaffSpace=s,!0;case"tablinespacing":return e.tabLineSpacing=s,!0;case"arrowshaftthickness":return e.arrowShaftThickness=s,!0;case"barlineseparation":return e.barlineSeparation=s,!0;case"beamspacing":return e.beamSpacing=s,!0;case"beamthickness":return e.beamThickness=s,!0;case"bracketthickness":return e.bracketThickness=s,!0;case"dashedbarlinedashlength":return e.dashedBarlineDashLength=s,!0;case"dashedbarlinegaplength":return e.dashedBarlineGapLength=s,!0;case"dashedbarlinethickness":return e.dashedBarlineThickness=s,!0;case"hairpinthickness":return e.hairpinThickness=s,!0;case"legerlinethickness":return e.legerLineThickness=s,!0;case"legerlineextension":return e.legerLineExtension=s,!0;case"octavelinethickness":return e.octaveLineThickness=s,!0;case"pedallinethickness":return e.pedalLineThickness=s,!0;case"repeatbarlinedotseparation":return e.repeatBarlineDotSeparation=s,!0;case"repeatendinglinethickness":return e.repeatEndingLineThickness=s,!0;case"slurmidpointthickness":return e.slurMidpointThickness=s,!0;case"stafflinethickness":return e.staffLineThickness=s,!0;case"stemthickness":return e.stemThickness=s,!0;case"thickbarlinethickness":return e.thickBarlineThickness=s,!0;case"thinbarlinethickness":return e.thinBarlineThickness=s,!0;case"thinthickbarlineseparation":return e.thinThickBarlineSeparation=s,!0;case"tiemidpointthickness":return e.tieMidpointThickness=s,!0;case"tupletbracketthickness":return e.tupletBracketThickness=s,!0;case"stemup":return e.stemUp=new Map,Aa.forEach(s,(t,s)=>{const i=new Ga;ja.fromJson(i,t),e.stemUp.set(Aa.parseEnum(s,ne),i)}),!0;case"stemdown":return e.stemDown=new Map,Aa.forEach(s,(t,s)=>{const i=new Ga;ja.fromJson(i,t),e.stemDown.set(Aa.parseEnum(s,ne),i)}),!0;case"repeatoffsetx":return e.repeatOffsetX=new Map,Aa.forEach(s,(t,s)=>{e.repeatOffsetX.set(Aa.parseEnum(s,ne),t)}),!0;case"standardstemlength":return e.standardStemLength=s,!0;case"stemflagoffsets":return e.stemFlagOffsets=new Map,Aa.forEach(s,(t,s)=>{e.stemFlagOffsets.set(Aa.parseEnum(s,k),t)}),!0;case"glyphtop":return e.glyphTop=new Map,Aa.forEach(s,(t,s)=>{e.glyphTop.set(Aa.parseEnum(s,ne),t)}),!0;case"glyphbottom":return e.glyphBottom=new Map,Aa.forEach(s,(t,s)=>{e.glyphBottom.set(Aa.parseEnum(s,ne),t)}),!0;case"glyphwidths":return e.glyphWidths=new Map,Aa.forEach(s,(t,s)=>{e.glyphWidths.set(Aa.parseEnum(s,ne),t)}),!0;case"glyphheights":return e.glyphHeights=new Map,Aa.forEach(s,(t,s)=>{e.glyphHeights.set(Aa.parseEnum(s,ne),t)}),!0;case"numberedbarrendererbarsize":return e.numberedBarRendererBarSize=s,!0;case"numberedbarrendererbarspacing":return e.numberedBarRendererBarSpacing=s,!0;case"numbereddashglyphpadding":return e.numberedDashGlyphPadding=s,!0;case"numbereddashglyphwidth":return e.numberedDashGlyphWidth=s,!0;case"linerangedglyphdashgap":return e.lineRangedGlyphDashGap=s,!0;case"linerangedglyphdashsize":return e.lineRangedGlyphDashSize=s,!0;case"prenoteeffectpadding":return e.preNoteEffectPadding=s,!0;case"postnoteeffectpadding":return e.postNoteEffectPadding=s,!0;case"onnoteeffectpadding":return e.onNoteEffectPadding=s,!0;case"stringnumbercirclepadding":return e.stringNumberCirclePadding=s,!0;case"rowcontainerpadding":return e.rowContainerPadding=s,!0;case"rowcontainergap":return e.rowContainerGap=s,!0;case"alternateendingspadding":return e.alternateEndingsPadding=s,!0;case"sustainpedallinepadding":return e.sustainPedalLinePadding=s,!0;case"tieheight":return e.tieHeight=s,!0;case"beattimerpadding":return e.beatTimerPadding=s,!0;case"bendnoteheadelementpadding":return e.bendNoteHeadElementPadding=s,!0;case"ghostparenthesiswidth":return e.ghostParenthesisWidth=s,!0;case"ghostparenthesispadding":return e.ghostParenthesisPadding=s,!0;case"brokenbeamwidth":return e.brokenBeamWidth=s,!0;case"tabwhammytextpadding":return e.tabWhammyTextPadding=s,!0;case"tabwhammyperhalfheight":return e.tabWhammyPerHalfHeight=s,!0;case"tabwhammydashsize":return e.tabWhammyDashSize=s,!0;case"songbookwhammydipheight":return e.songBookWhammyDipHeight=s,!0;case"deadslappedlinewidth":return e.deadSlappedLineWidth=s,!0;case"lefthandtabtiewidth":return e.leftHandTabTieWidth=s,!0;case"tabbenddashsize":return e.tabBendDashSize=s,!0;case"tabbendpervalueheight":return e.tabBendPerValueHeight=s,!0;case"tabbendlabelpadding":return e.tabBendLabelPadding=s,!0;case"simpleslidewidth":return e.simpleSlideWidth=s,!0;case"simpleslideheight":return e.simpleSlideHeight=s,!0;case"chorddiagrampaddingx":return e.chordDiagramPaddingX=s,!0;case"chorddiagrampaddingy":return e.chordDiagramPaddingY=s,!0;case"chorddiagramstringspacing":return e.chordDiagramStringSpacing=s,!0;case"chorddiagramfretspacing":return e.chordDiagramFretSpacing=s,!0;case"chorddiagramnutheight":return e.chordDiagramNutHeight=s,!0;case"chorddiagramfretheight":return e.chordDiagramFretHeight=s,!0;case"chorddiagramlinewidth":return e.chordDiagramLineWidth=s,!0;case"tripletfeelbracketpadding":return e.tripletFeelBracketPadding=s,!0;case"accidentalpadding":return e.accidentalPadding=s,!0;case"prebeatglyphspacing":return e.preBeatGlyphSpacing=s,!0;case"temponotescale":return e.tempoNoteScale=s,!0;case"tuningglyphcirclenumberscale":return e.tuningGlyphCircleNumberScale=s,!0;case"tuningglyphstringcolumnscale":return e.tuningGlyphStringColumnScale=s,!0;case"tuningglyphstringrowpadding":return e.tuningGlyphStringRowPadding=s,!0;case"directionsscale":return e.directionsScale=s,!0}return!1}}class Qa{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Qa.setProperty(e,s.toLowerCase(),t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("smuflfontfamilyname",e.smuflFontFamilyName),t.set("engravingsettings",Ka.toJson(e.engravingSettings)),t.set("copyrightfont",Wa.toJson(e.copyrightFont)),t.set("titlefont",Wa.toJson(e.titleFont)),t.set("subtitlefont",Wa.toJson(e.subTitleFont)),t.set("wordsfont",Wa.toJson(e.wordsFont)),t.set("effectfont",Wa.toJson(e.effectFont)),t.set("timerfont",Wa.toJson(e.timerFont)),t.set("directionsfont",Wa.toJson(e.directionsFont)),t.set("fretboardnumberfont",Wa.toJson(e.fretboardNumberFont)),t.set("numberednotationfont",Wa.toJson(e.numberedNotationFont)),t.set("numberednotationgracefont",Wa.toJson(e.numberedNotationGraceFont)),t.set("tablaturefont",Wa.toJson(e.tablatureFont)),t.set("gracefont",Wa.toJson(e.graceFont)),t.set("stafflinecolor",at.toJson(e.staffLineColor)),t.set("barseparatorcolor",at.toJson(e.barSeparatorColor)),t.set("barnumberfont",Wa.toJson(e.barNumberFont)),t.set("barnumbercolor",at.toJson(e.barNumberColor)),t.set("fingeringfont",Wa.toJson(e.fingeringFont)),t.set("inlinefingeringfont",Wa.toJson(e.inlineFingeringFont)),t.set("markerfont",Wa.toJson(e.markerFont)),t.set("mainglyphcolor",at.toJson(e.mainGlyphColor)),t.set("secondaryglyphcolor",at.toJson(e.secondaryGlyphColor)),t.set("scoreinfocolor",at.toJson(e.scoreInfoColor)),t}static setProperty(e,t,s){switch(t){case"smuflfontfamilyname":return e.smuflFontFamilyName=s,!0;case"copyrightfont":return e.copyrightFont=Wa.fromJson(s),!0;case"titlefont":return e.titleFont=Wa.fromJson(s),!0;case"subtitlefont":return e.subTitleFont=Wa.fromJson(s),!0;case"wordsfont":return e.wordsFont=Wa.fromJson(s),!0;case"effectfont":return e.effectFont=Wa.fromJson(s),!0;case"timerfont":return e.timerFont=Wa.fromJson(s),!0;case"directionsfont":return e.directionsFont=Wa.fromJson(s),!0;case"fretboardnumberfont":return e.fretboardNumberFont=Wa.fromJson(s),!0;case"numberednotationfont":return e.numberedNotationFont=Wa.fromJson(s),!0;case"numberednotationgracefont":return e.numberedNotationGraceFont=Wa.fromJson(s),!0;case"tablaturefont":return e.tablatureFont=Wa.fromJson(s),!0;case"gracefont":return e.graceFont=Wa.fromJson(s),!0;case"stafflinecolor":return e.staffLineColor=at.fromJson(s),!0;case"barseparatorcolor":return e.barSeparatorColor=at.fromJson(s),!0;case"barnumberfont":return e.barNumberFont=Wa.fromJson(s),!0;case"barnumbercolor":return e.barNumberColor=at.fromJson(s),!0;case"fingeringfont":return e.fingeringFont=Wa.fromJson(s),!0;case"inlinefingeringfont":return e.inlineFingeringFont=Wa.fromJson(s),!0;case"markerfont":return e.markerFont=Wa.fromJson(s),!0;case"mainglyphcolor":return e.mainGlyphColor=at.fromJson(s),!0;case"secondaryglyphcolor":return e.secondaryGlyphColor=at.fromJson(s),!0;case"scoreinfocolor":return e.scoreInfoColor=at.fromJson(s),!0}return["engravingsettings"].indexOf(t)>=0&&(Ka.fromJson(e.engravingSettings,s),!0)}}class Za{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Za.setProperty(e,s.toLowerCase(),t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("scale",e.scale),t.set("stretchforce",e.stretchForce),t.set("layoutmode",e.layoutMode),t.set("staveprofile",e.staveProfile),t.set("barsperrow",e.barsPerRow),t.set("startbar",e.startBar),t.set("barcount",e.barCount),t.set("barcountperpartial",e.barCountPerPartial),t.set("justifylastsystem",e.justifyLastSystem),t.set("resources",Qa.toJson(e.resources)),t.set("padding",e.padding),t.set("firstsystempaddingtop",e.firstSystemPaddingTop),t.set("systempaddingtop",e.systemPaddingTop),t.set("systempaddingbottom",e.systemPaddingBottom),t.set("lastsystempaddingbottom",e.lastSystemPaddingBottom),t.set("systemlabelpaddingleft",e.systemLabelPaddingLeft),t.set("systemlabelpaddingright",e.systemLabelPaddingRight),t.set("accoladebarpaddingright",e.accoladeBarPaddingRight),t.set("notationstaffpaddingtop",e.notationStaffPaddingTop),t.set("notationstaffpaddingbottom",e.notationStaffPaddingBottom),t.set("effectstaffpaddingtop",e.effectStaffPaddingTop),t.set("effectstaffpaddingbottom",e.effectStaffPaddingBottom),t.set("firststaffpaddingleft",e.firstStaffPaddingLeft),t.set("staffpaddingleft",e.staffPaddingLeft),t.set("effectbandpaddingbottom",e.effectBandPaddingBottom),t.set("systemslayoutmode",e.systemsLayoutMode),t}static setProperty(t,s,i){switch(s){case"scale":return t.scale=i,!0;case"stretchforce":return t.stretchForce=i,!0;case"layoutmode":return t.layoutMode=Aa.parseEnum(i,e.LayoutMode),!0;case"staveprofile":return t.staveProfile=Aa.parseEnum(i,e.StaveProfile),!0;case"barsperrow":return t.barsPerRow=i,!0;case"startbar":return t.startBar=i,!0;case"barcount":return t.barCount=i,!0;case"barcountperpartial":return t.barCountPerPartial=i,!0;case"justifylastsystem":return t.justifyLastSystem=i,!0;case"padding":return t.padding=i,!0;case"firstsystempaddingtop":return t.firstSystemPaddingTop=i,!0;case"systempaddingtop":return t.systemPaddingTop=i,!0;case"systempaddingbottom":return t.systemPaddingBottom=i,!0;case"lastsystempaddingbottom":return t.lastSystemPaddingBottom=i,!0;case"systemlabelpaddingleft":return t.systemLabelPaddingLeft=i,!0;case"systemlabelpaddingright":return t.systemLabelPaddingRight=i,!0;case"accoladebarpaddingright":return t.accoladeBarPaddingRight=i,!0;case"notationstaffpaddingtop":return t.notationStaffPaddingTop=i,!0;case"notationstaffpaddingbottom":return t.notationStaffPaddingBottom=i,!0;case"effectstaffpaddingtop":return t.effectStaffPaddingTop=i,!0;case"effectstaffpaddingbottom":return t.effectStaffPaddingBottom=i,!0;case"firststaffpaddingleft":return t.firstStaffPaddingLeft=i,!0;case"staffpaddingleft":return t.staffPaddingLeft=i,!0;case"effectbandpaddingbottom":return t.effectBandPaddingBottom=i,!0;case"systemslayoutmode":return t.systemsLayoutMode=Aa.parseEnum(i,e.SystemsLayoutMode),!0}if(["resources"].indexOf(s)>=0)return Qa.fromJson(t.resources,i),!0;for(const e of["resources"])if(0===s.indexOf(e)&&Qa.setProperty(t.resources,s.substring(e.length),i))return!0;return!1}}class er{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>er.setProperty(e,s.toLowerCase(),t))}static toJson(e){if(!e)return null;const t=new Map;t.set("notationmode",e.notationMode),t.set("fingeringmode",e.fingeringMode);{const s=new Map;t.set("elements",s);for(const[t,i]of e.elements)s.set(t.toString(),i)}return t.set("rhythmmode",e.rhythmMode),t.set("rhythmheight",e.rhythmHeight),t.set("transpositionpitches",e.transpositionPitches),t.set("displaytranspositionpitches",e.displayTranspositionPitches),t.set("smallgracetabnotes",e.smallGraceTabNotes),t.set("extendbendarrowsontiednotes",e.extendBendArrowsOnTiedNotes),t.set("extendlineeffectstobeatend",e.extendLineEffectsToBeatEnd),t.set("slurheight",e.slurHeight),t}static setProperty(t,s,i){switch(s){case"notationmode":return t.notationMode=Aa.parseEnum(i,e.NotationMode),!0;case"fingeringmode":return t.fingeringMode=Aa.parseEnum(i,e.FingeringMode),!0;case"elements":return t.elements=new Map,Aa.forEach(i,(s,i)=>{t.elements.set(Aa.parseEnum(i,e.NotationElement),s)}),!0;case"rhythmmode":return t.rhythmMode=Aa.parseEnum(i,e.TabRhythmMode),!0;case"rhythmheight":return t.rhythmHeight=i,!0;case"transpositionpitches":return t.transpositionPitches=i,!0;case"displaytranspositionpitches":return t.displayTranspositionPitches=i,!0;case"smallgracetabnotes":return t.smallGraceTabNotes=i,!0;case"extendbendarrowsontiednotes":return t.extendBendArrowsOnTiedNotes=i,!0;case"extendlineeffectstobeatend":return t.extendLineEffectsToBeatEnd=i,!0;case"slurheight":return t.slurHeight=i,!0}return!1}}class tr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>tr.setProperty(e,s.toLowerCase(),t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("encoding",e.encoding),t.set("mergepartgroupsinmusicxml",e.mergePartGroupsInMusicXml),t.set("beattextaslyrics",e.beatTextAsLyrics),t}static setProperty(e,t,s){switch(t){case"encoding":return e.encoding=s,!0;case"mergepartgroupsinmusicxml":return e.mergePartGroupsInMusicXml=s,!0;case"beattextaslyrics":return e.beatTextAsLyrics=s,!0}return!1}}class sr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>sr.setProperty(e,s.toLowerCase(),t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("notewidelength",e.noteWideLength),t.set("notewideamplitude",e.noteWideAmplitude),t.set("noteslightlength",e.noteSlightLength),t.set("noteslightamplitude",e.noteSlightAmplitude),t.set("beatwidelength",e.beatWideLength),t.set("beatwideamplitude",e.beatWideAmplitude),t.set("beatslightlength",e.beatSlightLength),t.set("beatslightamplitude",e.beatSlightAmplitude),t}static setProperty(e,t,s){switch(t){case"notewidelength":return e.noteWideLength=s,!0;case"notewideamplitude":return e.noteWideAmplitude=s,!0;case"noteslightlength":return e.noteSlightLength=s,!0;case"noteslightamplitude":return e.noteSlightAmplitude=s,!0;case"beatwidelength":return e.beatWideLength=s,!0;case"beatwideamplitude":return e.beatWideAmplitude=s,!0;case"beatslightlength":return e.beatSlightLength=s,!0;case"beatslightamplitude":return e.beatSlightAmplitude=s,!0}return!1}}class ir{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>ir.setProperty(e,s.toLowerCase(),t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("simpleslidepitchoffset",e.simpleSlidePitchOffset),t.set("simpleslidedurationratio",e.simpleSlideDurationRatio),t.set("shiftslidedurationratio",e.shiftSlideDurationRatio),t}static setProperty(e,t,s){switch(t){case"simpleslidepitchoffset":return e.simpleSlidePitchOffset=s,!0;case"simpleslidedurationratio":return e.simpleSlideDurationRatio=s,!0;case"shiftslidedurationratio":return e.shiftSlideDurationRatio=s,!0}return!1}}class ar{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>ar.setProperty(e,s.toLowerCase(),t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("soundfont",e.soundFont),t.set("outputmode",e.outputMode),t.set("enableplayer",e.enablePlayer),t.set("playermode",e.playerMode),t.set("enablecursor",e.enableCursor),t.set("enableanimatedbeatcursor",e.enableAnimatedBeatCursor),t.set("enableelementhighlighting",e.enableElementHighlighting),t.set("enableuserinteraction",e.enableUserInteraction),t.set("scrolloffsetx",e.scrollOffsetX),t.set("scrolloffsety",e.scrollOffsetY),t.set("scrollmode",e.scrollMode),t.set("scrollspeed",e.scrollSpeed),t.set("nativebrowsersmoothscroll",e.nativeBrowserSmoothScroll),t.set("songbookbendduration",e.songBookBendDuration),t.set("songbookdipduration",e.songBookDipDuration),t.set("vibrato",sr.toJson(e.vibrato)),t.set("slide",ir.toJson(e.slide)),t.set("playtripletfeel",e.playTripletFeel),t.set("buffertimeinmilliseconds",e.bufferTimeInMilliseconds),t}static setProperty(t,s,i){switch(s){case"soundfont":return t.soundFont=i,!0;case"scrollelement":return t.scrollElement=i,!0;case"outputmode":return t.outputMode=Aa.parseEnum(i,e.PlayerOutputMode),!0;case"enableplayer":return t.enablePlayer=i,!0;case"playermode":return t.playerMode=Aa.parseEnum(i,e.PlayerMode),!0;case"enablecursor":return t.enableCursor=i,!0;case"enableanimatedbeatcursor":return t.enableAnimatedBeatCursor=i,!0;case"enableelementhighlighting":return t.enableElementHighlighting=i,!0;case"enableuserinteraction":return t.enableUserInteraction=i,!0;case"scrolloffsetx":return t.scrollOffsetX=i,!0;case"scrolloffsety":return t.scrollOffsetY=i,!0;case"scrollmode":return t.scrollMode=Aa.parseEnum(i,e.ScrollMode),!0;case"scrollspeed":return t.scrollSpeed=i,!0;case"nativebrowsersmoothscroll":return t.nativeBrowserSmoothScroll=i,!0;case"songbookbendduration":return t.songBookBendDuration=i,!0;case"songbookdipduration":return t.songBookDipDuration=i,!0;case"playtripletfeel":return t.playTripletFeel=i,!0;case"buffertimeinmilliseconds":return t.bufferTimeInMilliseconds=i,!0}if(["vibrato"].indexOf(s)>=0)return sr.fromJson(t.vibrato,i),!0;for(const e of["vibrato"])if(0===s.indexOf(e)&&sr.setProperty(t.vibrato,s.substring(e.length),i))return!0;if(["slide"].indexOf(s)>=0)return ir.fromJson(t.slide,i),!0;for(const e of["slide"])if(0===s.indexOf(e)&&ir.setProperty(t.slide,s.substring(e.length),i))return!0;return!1}}class rr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>rr.setProperty(e,s.toLowerCase(),t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("indent",e.indent),t.set("comments",e.comments),t}static setProperty(e,t,s){switch(t){case"indent":return e.indent=s,!0;case"comments":return e.comments=s,!0}return!1}}class nr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>nr.setProperty(e,s.toLowerCase(),t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("core",qa.toJson(e.core)),t.set("display",Za.toJson(e.display)),t.set("notation",er.toJson(e.notation)),t.set("importer",tr.toJson(e.importer)),t.set("player",ar.toJson(e.player)),t.set("exporter",rr.toJson(e.exporter)),t}static setProperty(e,t,s){if(["core",""].indexOf(t)>=0)return qa.fromJson(e.core,s),!0;for(const i of["core",""])if(0===t.indexOf(i)&&qa.setProperty(e.core,t.substring(i.length),s))return!0;if(["display",""].indexOf(t)>=0)return Za.fromJson(e.display,s),!0;for(const i of["display",""])if(0===t.indexOf(i)&&Za.setProperty(e.display,t.substring(i.length),s))return!0;if(["notation"].indexOf(t)>=0)return er.fromJson(e.notation,s),!0;for(const i of["notation"])if(0===t.indexOf(i)&&er.setProperty(e.notation,t.substring(i.length),s))return!0;if(["importer"].indexOf(t)>=0)return tr.fromJson(e.importer,s),!0;for(const i of["importer"])if(0===t.indexOf(i)&&tr.setProperty(e.importer,t.substring(i.length),s))return!0;if(["player"].indexOf(t)>=0)return ar.fromJson(e.player,s),!0;for(const i of["player"])if(0===t.indexOf(i)&&ar.setProperty(e.player,t.substring(i.length),s))return!0;if(["exporter"].indexOf(t)>=0)return rr.fromJson(e.exporter,s),!0;for(const i of["exporter"])if(0===t.indexOf(i)&&rr.setProperty(e.exporter,t.substring(i.length),s))return!0;return!1}}class or{constructor(){this.indent=2,this.comments=!1}}class hr{constructor(){this.core=new Vc,this.display=new za,this.notation=new K,this.importer=new Xa,this.player=new $a,this.exporter=new or}setSongBookModeSettings(){this.notation.notationMode=e.NotationMode.SongBook,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=e.FingeringMode.SingleNoteEffectBand,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(e.NotationElement.ParenthesisOnTiedBends,!1),this.notation.elements.set(e.NotationElement.TabNotesOnTiedBends,!1),this.notation.elements.set(e.NotationElement.ZerosOnDiveWhammys,!0)}static get songBook(){const e=new hr;return e.setSongBookModeSettings(),e}fillFromJson(e){nr.fromJson(this,e)}handleBackwardsCompatibility(){this.player.playerMode===e.PlayerMode.Disabled&&this.player.enablePlayer&&(this.player.playerMode=e.PlayerMode.EnabledAutomatic)}}class lr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>lr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("marker",e.marker),t.set("text",e.text),t}static setProperty(e,t,s){switch(t){case"marker":return e.marker=s,!0;case"text":return e.text=s,!0}return!1}}class cr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>cr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("baroccurence",e.barOccurence),t.set("millisecondoffset",e.millisecondOffset),t}static setProperty(e,t,s){switch(t){case"baroccurence":return e.barOccurence=s,!0;case"millisecondoffset":return e.millisecondOffset=s,!0}return!1}}class dr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>dr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("islinear",e.isLinear),t.set("type",e.type),t.set("value",e.value),e.syncPointValue&&t.set("syncpointvalue",cr.toJson(e.syncPointValue)),t.set("ratioposition",e.ratioPosition),t.set("text",e.text),t}static setProperty(e,t,s){switch(t){case"islinear":return e.isLinear=s,!0;case"type":return e.type=Aa.parseEnum(s,y),!0;case"value":return e.value=s,!0;case"syncpointvalue":return s?(e.syncPointValue=new $,cr.fromJson(e.syncPointValue,s)):e.syncPointValue=void 0,!0;case"ratioposition":return e.ratioPosition=s,!0;case"text":return e.text=s,!0}return!1}}class ur{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>ur.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("type",e.type),t.set("length",e.length),t}static setProperty(e,t,s){switch(t){case"type":return e.type=Aa.parseEnum(s,Ne),!0;case"length":return e.length=s,!0}return!1}}class pr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>pr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;if(t.set("alternateendings",e.alternateEndings),t.set("isdoublebar",e.isDoubleBar),t.set("isrepeatstart",e.isRepeatStart),t.set("repeatcount",e.repeatCount),t.set("timesignaturenumerator",e.timeSignatureNumerator),t.set("timesignaturedenominator",e.timeSignatureDenominator),t.set("timesignaturecommon",e.timeSignatureCommon),t.set("isfreetime",e.isFreeTime),t.set("tripletfeel",e.tripletFeel),e.section&&t.set("section",lr.toJson(e.section)),t.set("tempoautomations",e.tempoAutomations.map(e=>dr.toJson(e))),void 0!==e.syncPoints&&t.set("syncpoints",e.syncPoints?.map(e=>dr.toJson(e))),null!==e.fermata){const s=new Map;t.set("fermata",s);for(const[t,i]of e.fermata)s.set(t.toString(),ur.toJson(i))}if(t.set("start",e.start),t.set("isanacrusis",e.isAnacrusis),t.set("displayscale",e.displayScale),t.set("displaywidth",e.displayWidth),null!==e.directions){const s=[];t.set("directions",s);for(const t of e.directions)s.push(t)}return t}static setProperty(e,t,s){switch(t){case"alternateendings":return e.alternateEndings=s,!0;case"isdoublebar":return e.isDoubleBar=s,!0;case"isrepeatstart":return e.isRepeatStart=s,!0;case"repeatcount":return e.repeatCount=s,!0;case"timesignaturenumerator":return e.timeSignatureNumerator=s,!0;case"timesignaturedenominator":return e.timeSignatureDenominator=s,!0;case"timesignaturecommon":return e.timeSignatureCommon=s,!0;case"isfreetime":return e.isFreeTime=s,!0;case"tripletfeel":return e.tripletFeel=Aa.parseEnum(s,A),!0;case"section":return s?(e.section=new st,lr.fromJson(e.section,s)):e.section=null,!0;case"tempoautomations":e.tempoAutomations=[];for(const t of s){const s=new q;dr.fromJson(s,t),e.tempoAutomations.push(s)}return!0;case"syncpoints":if(s){e.syncPoints=[];for(const t of s){const s=new q;dr.fromJson(s,t),e.addSyncPoint(s)}}return!0;case"fermata":return e.fermata=new Map,Aa.forEach(s,(t,s)=>{const i=new pt;ur.fromJson(i,t),e.addFermata(Number.parseInt(s),i)}),!0;case"start":return e.start=s,!0;case"isanacrusis":return e.isAnacrusis=s,!0;case"displayscale":return e.displayScale=s,!0;case"displaywidth":return e.displayWidth=s,!0;case"directions":for(const t of s)e.addDirection(Aa.parseEnum(t,xe));return!0}return!1}}class mr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>mr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("offset",e.offset),t.set("value",e.value),t}static setProperty(e,t,s){switch(t){case"offset":return e.offset=s,!0;case"value":return e.value=s,!0}return!1}}class gr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>gr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;t.set("notehead",e.noteHead),t.set("noteheadcenteronstem",e.noteHeadCenterOnStem);{const s=new Map;t.set("colors",s);for(const[t,i]of e.colors)s.set(t.toString(),at.toJson(i))}return t}static setProperty(e,t,s){switch(t){case"notehead":return e.noteHead=Aa.parseEnum(s,ne),!0;case"noteheadcenteronstem":return e.noteHeadCenterOnStem=s,!0;case"colors":return e.colors=new Map,Aa.forEach(s,(t,s)=>{e.colors.set(Aa.parseEnum(s,de),at.fromJson(t))}),!0}return!1}}class fr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>fr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("id",e.id),t.set("accentuated",e.accentuated),t.set("bendtype",e.bendType),t.set("bendstyle",e.bendStyle),t.set("iscontinuedbend",e.isContinuedBend),null!==e.bendPoints&&t.set("bendpoints",e.bendPoints?.map(e=>mr.toJson(e))),t.set("fret",e.fret),t.set("string",e.string),t.set("showstringnumber",e.showStringNumber),t.set("octave",e.octave),t.set("tone",e.tone),t.set("percussionarticulation",e.percussionArticulation),t.set("isvisible",e.isVisible),t.set("islefthandtapped",e.isLeftHandTapped),t.set("ishammerpullorigin",e.isHammerPullOrigin),t.set("isslurdestination",e.isSlurDestination),t.set("harmonictype",e.harmonicType),t.set("harmonicvalue",e.harmonicValue),t.set("isghost",e.isGhost),t.set("isletring",e.isLetRing),t.set("ispalmmute",e.isPalmMute),t.set("isdead",e.isDead),t.set("isstaccato",e.isStaccato),t.set("slideintype",e.slideInType),t.set("slideouttype",e.slideOutType),t.set("vibrato",e.vibrato),t.set("istiedestination",e.isTieDestination),t.set("lefthandfinger",e.leftHandFinger),t.set("righthandfinger",e.rightHandFinger),t.set("trillvalue",e.trillValue),t.set("trillspeed",e.trillSpeed),t.set("durationpercent",e.durationPercent),t.set("accidentalmode",e.accidentalMode),t.set("dynamics",e.dynamics),t.set("ornament",e.ornament),e.style&&t.set("style",gr.toJson(e.style)),e.toJson(t),t}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"accentuated":return e.accentuated=Aa.parseEnum(s,_),!0;case"bendtype":return e.bendType=Aa.parseEnum(s,S),!0;case"bendstyle":return e.bendStyle=Aa.parseEnum(s,b),!0;case"iscontinuedbend":return e.isContinuedBend=s,!0;case"bendpoints":if(s){e.bendPoints=[];for(const t of s){const s=new j;mr.fromJson(s,t),e.addBendPoint(s)}}return!0;case"fret":return e.fret=s,!0;case"string":return e.string=s,!0;case"showstringnumber":return e.showStringNumber=s,!0;case"octave":return e.octave=s,!0;case"tone":return e.tone=s,!0;case"percussionarticulation":return e.percussionArticulation=s,!0;case"isvisible":return e.isVisible=s,!0;case"islefthandtapped":return e.isLeftHandTapped=s,!0;case"ishammerpullorigin":return e.isHammerPullOrigin=s,!0;case"isslurdestination":return e.isSlurDestination=s,!0;case"harmonictype":return e.harmonicType=Aa.parseEnum(s,N),!0;case"harmonicvalue":return e.harmonicValue=s,!0;case"isghost":return e.isGhost=s,!0;case"isletring":return e.isLetRing=s,!0;case"ispalmmute":return e.isPalmMute=s,!0;case"isdead":return e.isDead=s,!0;case"isstaccato":return e.isStaccato=s,!0;case"slideintype":return e.slideInType=Aa.parseEnum(s,v),!0;case"slideouttype":return e.slideOutType=Aa.parseEnum(s,E),!0;case"vibrato":return e.vibrato=Aa.parseEnum(s,M),!0;case"istiedestination":return e.isTieDestination=s,!0;case"lefthandfinger":return e.leftHandFinger=Aa.parseEnum(s,x),!0;case"righthandfinger":return e.rightHandFinger=Aa.parseEnum(s,x),!0;case"trillvalue":return e.trillValue=s,!0;case"trillspeed":return e.trillSpeed=Aa.parseEnum(s,k),!0;case"durationpercent":return e.durationPercent=s,!0;case"accidentalmode":return e.accidentalMode=Aa.parseEnum(s,P),!0;case"dynamics":return e.dynamics=Aa.parseEnum(s,f),!0;case"ornament":return e.ornament=Aa.parseEnum(s,ce),!0;case"style":return s?(e.style=new Re,gr.fromJson(e.style,s)):e.style=void 0,!0}return e.setProperty(t,s)}}class yr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>yr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;{const s=new Map;t.set("colors",s);for(const[t,i]of e.colors)s.set(t.toString(),at.toJson(i))}return t}static setProperty(e,t,s){return"colors"===t&&(e.colors=new Map,Aa.forEach(s,(t,s)=>{e.colors.set(Aa.parseEnum(s,Se),at.fromJson(t))}),!0)}}class br{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>br.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("id",e.id),t.set("notes",e.notes.map(e=>fr.toJson(e))),t.set("isempty",e.isEmpty),t.set("whammystyle",e.whammyStyle),t.set("ottava",e.ottava),t.set("islegatoorigin",e.isLegatoOrigin),t.set("duration",e.duration),t.set("automations",e.automations.map(e=>dr.toJson(e))),t.set("dots",e.dots),t.set("fade",e.fade),t.set("lyrics",e.lyrics),t.set("pop",e.pop),t.set("slap",e.slap),t.set("tap",e.tap),t.set("text",e.text),t.set("slashed",e.slashed),t.set("deadslapped",e.deadSlapped),t.set("brushtype",e.brushType),t.set("brushduration",e.brushDuration),t.set("tupletdenominator",e.tupletDenominator),t.set("tupletnumerator",e.tupletNumerator),t.set("iscontinuedwhammy",e.isContinuedWhammy),t.set("whammybartype",e.whammyBarType),null!==e.whammyBarPoints&&t.set("whammybarpoints",e.whammyBarPoints?.map(e=>mr.toJson(e))),t.set("vibrato",e.vibrato),t.set("chordid",e.chordId),t.set("gracetype",e.graceType),t.set("pickstroke",e.pickStroke),t.set("tremolospeed",e.tremoloSpeed),t.set("crescendo",e.crescendo),t.set("displaystart",e.displayStart),t.set("playbackstart",e.playbackStart),t.set("displayduration",e.displayDuration),t.set("playbackduration",e.playbackDuration),t.set("overridedisplayduration",e.overrideDisplayDuration),t.set("golpe",e.golpe),t.set("dynamics",e.dynamics),t.set("invertbeamdirection",e.invertBeamDirection),t.set("preferredbeamdirection",e.preferredBeamDirection),t.set("beamingmode",e.beamingMode),t.set("wahpedal",e.wahPedal),t.set("barrefret",e.barreFret),t.set("barreshape",e.barreShape),t.set("rasgueado",e.rasgueado),t.set("showtimer",e.showTimer),t.set("timer",e.timer),e.style&&t.set("style",yr.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"notes":e.notes=[];for(const t of s){const s=new Oe;fr.fromJson(s,t),e.addNote(s)}return!0;case"isempty":return e.isEmpty=s,!0;case"whammystyle":return e.whammyStyle=Aa.parseEnum(s,b),!0;case"ottava":return e.ottava=Aa.parseEnum(s,l),!0;case"islegatoorigin":return e.isLegatoOrigin=s,!0;case"duration":return e.duration=Aa.parseEnum(s,k),!0;case"automations":e.automations=[];for(const t of s){const s=new q;dr.fromJson(s,t),e.automations.push(s)}return!0;case"dots":return e.dots=s,!0;case"fade":return e.fade=Aa.parseEnum(s,me),!0;case"lyrics":return e.lyrics=s,!0;case"pop":return e.pop=s,!0;case"slap":return e.slap=s,!0;case"tap":return e.tap=s,!0;case"text":return e.text=s,!0;case"slashed":return e.slashed=s,!0;case"deadslapped":return e.deadSlapped=s,!0;case"brushtype":return e.brushType=Aa.parseEnum(s,w),!0;case"brushduration":return e.brushDuration=s,!0;case"tupletdenominator":return e.tupletDenominator=s,!0;case"tupletnumerator":return e.tupletNumerator=s,!0;case"iscontinuedwhammy":return e.isContinuedWhammy=s,!0;case"whammybartype":return e.whammyBarType=Aa.parseEnum(s,ue),!0;case"whammybarpoints":if(s){e.whammyBarPoints=[];for(const t of s){const s=new j;mr.fromJson(s,t),e.addWhammyBarPoint(s)}}return!0;case"vibrato":return e.vibrato=Aa.parseEnum(s,M),!0;case"chordid":return e.chordId=s,!0;case"gracetype":return e.graceType=Aa.parseEnum(s,T),!0;case"pickstroke":return e.pickStroke=Aa.parseEnum(s,he),!0;case"tremolospeed":return e.tremoloSpeed=Aa.parseEnum(s,k)??null,!0;case"crescendo":return e.crescendo=Aa.parseEnum(s,B),!0;case"displaystart":return e.displayStart=s,!0;case"playbackstart":return e.playbackStart=s,!0;case"displayduration":return e.displayDuration=s,!0;case"playbackduration":return e.playbackDuration=s,!0;case"overridedisplayduration":return e.overrideDisplayDuration=s,!0;case"golpe":return e.golpe=Aa.parseEnum(s,pe),!0;case"dynamics":return e.dynamics=Aa.parseEnum(s,f),!0;case"invertbeamdirection":return e.invertBeamDirection=s,!0;case"preferredbeamdirection":return e.preferredBeamDirection=Aa.parseEnum(s,Pe)??null,!0;case"beamingmode":return e.beamingMode=Aa.parseEnum(s,be),!0;case"wahpedal":return e.wahPedal=Aa.parseEnum(s,ge),!0;case"barrefret":return e.barreFret=s,!0;case"barreshape":return e.barreShape=Aa.parseEnum(s,fe),!0;case"rasgueado":return e.rasgueado=Aa.parseEnum(s,ye),!0;case"showtimer":return e.showTimer=s,!0;case"timer":return e.timer=s,!0;case"style":return s?(e.style=new Xe,yr.fromJson(e.style,s)):e.style=void 0,!0}return!1}}class Sr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Sr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;{const s=new Map;t.set("colors",s);for(const[t,i]of e.colors)s.set(t.toString(),at.toJson(i))}return t}static setProperty(e,t,s){return"colors"===t&&(e.colors=new Map,Aa.forEach(s,(t,s)=>{e.colors.set(Aa.parseEnum(s,R),at.fromJson(t))}),!0)}}class wr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>wr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("id",e.id),t.set("beats",e.beats.map(e=>br.toJson(e))),e.style&&t.set("style",Sr.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"beats":e.beats=[];for(const t of s){const s=new Ye;br.fromJson(s,t),e.addBeat(s)}return!0;case"style":return s?(e.style=new ae,Sr.fromJson(e.style,s)):e.style=void 0,!0}return!1}}class Br{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Br.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("ratioposition",e.ratioPosition),t.set("pedaltype",e.pedalType),t}static setProperty(e,t,s){switch(t){case"ratioposition":return e.ratioPosition=s,!0;case"pedaltype":return e.pedalType=Aa.parseEnum(s,p),!0}return!1}}class kr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>kr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;{const s=new Map;t.set("colors",s);for(const[t,i]of e.colors)s.set(t.toString(),at.toJson(i))}return t}static setProperty(e,t,s){return"colors"===t&&(e.colors=new Map,Aa.forEach(s,(t,s)=>{e.colors.set(Aa.parseEnum(s,m),at.fromJson(t))}),!0)}}class Tr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Tr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("id",e.id),t.set("clef",e.clef),t.set("clefottava",e.clefOttava),t.set("voices",e.voices.map(e=>wr.toJson(e))),t.set("similemark",e.simileMark),t.set("displayscale",e.displayScale),t.set("displaywidth",e.displayWidth),t.set("sustainpedals",e.sustainPedals.map(e=>Br.toJson(e))),t.set("barlineleft",e.barLineLeft),t.set("barlineright",e.barLineRight),t.set("keysignature",e.keySignature),t.set("keysignaturetype",e.keySignatureType),e.style&&t.set("style",kr.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"id":return e.id=s,!0;case"clef":return e.clef=Aa.parseEnum(s,h),!0;case"clefottava":return e.clefOttava=Aa.parseEnum(s,l),!0;case"voices":e.voices=[];for(const t of s){const s=new re;wr.fromJson(s,t),e.addVoice(s)}return!0;case"similemark":return e.simileMark=Aa.parseEnum(s,c),!0;case"displayscale":return e.displayScale=s,!0;case"displaywidth":return e.displayWidth=s,!0;case"sustainpedals":e.sustainPedals=[];for(const t of s){const s=new z;Br.fromJson(s,t),e.sustainPedals.push(s)}return!0;case"barlineleft":return e.barLineLeft=Aa.parseEnum(s,g),!0;case"barlineright":return e.barLineRight=Aa.parseEnum(s,g),!0;case"keysignature":return e.keySignature=Aa.parseEnum(s,d),!0;case"keysignaturetype":return e.keySignatureType=Aa.parseEnum(s,u),!0;case"style":return s?(e.style=new X,kr.fromJson(e.style,s)):e.style=void 0,!0}return!1}}class _r{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>_r.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("name",e.name),t.set("firstfret",e.firstFret),t.set("strings",e.strings),t.set("barrefrets",e.barreFrets),t.set("showname",e.showName),t.set("showdiagram",e.showDiagram),t.set("showfingering",e.showFingering),t}static setProperty(e,t,s){switch(t){case"name":return e.name=s,!0;case"firstfret":return e.firstFret=s,!0;case"strings":return e.strings=s,!0;case"barrefrets":return e.barreFrets=s,!0;case"showname":return e.showName=s,!0;case"showdiagram":return e.showDiagram=s,!0;case"showfingering":return e.showFingering=s,!0}return!1}}class xr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>xr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("isstandard",e.isStandard),t.set("name",e.name),t.set("tunings",e.tunings),t}static setProperty(e,t,s){switch(t){case"isstandard":return e.isStandard=s,!0;case"name":return e.name=s,!0;case"tunings":return e.tunings=s,!0}return!1}}class Nr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Nr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;if(t.set("bars",e.bars.map(e=>Tr.toJson(e))),null!==e.chords){const s=new Map;t.set("chords",s);for(const[t,i]of e.chords)s.set(t.toString(),_r.toJson(i))}return t.set("capo",e.capo),t.set("transpositionpitch",e.transpositionPitch),t.set("displaytranspositionpitch",e.displayTranspositionPitch),t.set("stringtuning",xr.toJson(e.stringTuning)),t.set("showslash",e.showSlash),t.set("shownumbered",e.showNumbered),t.set("showtablature",e.showTablature),t.set("showstandardnotation",e.showStandardNotation),t.set("ispercussion",e.isPercussion),t.set("standardnotationlinecount",e.standardNotationLineCount),t}static setProperty(e,t,s){switch(t){case"bars":e.bars=[];for(const t of s){const s=new Y;Tr.fromJson(s,t),e.addBar(s)}return!0;case"chords":return e.chords=new Map,Aa.forEach(s,(t,s)=>{const i=new et;_r.fromJson(i,t),e.addChord(s,i)}),!0;case"capo":return e.capo=s,!0;case"transpositionpitch":return e.transpositionPitch=s,!0;case"displaytranspositionpitch":return e.displayTranspositionPitch=s,!0;case"stringtuning":return xr.fromJson(e.stringTuning,s),!0;case"showslash":return e.showSlash=s,!0;case"shownumbered":return e.showNumbered=s,!0;case"showtablature":return e.showTablature=s,!0;case"showstandardnotation":return e.showStandardNotation=s,!0;case"ispercussion":return e.isPercussion=s,!0;case"standardnotationlinecount":return e.standardNotationLineCount=s,!0}return!1}}class Pr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Pr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("volume",e.volume),t.set("balance",e.balance),t.set("port",e.port),t.set("program",e.program),t.set("bank",e.bank),t.set("primarychannel",e.primaryChannel),t.set("secondarychannel",e.secondaryChannel),t.set("ismute",e.isMute),t.set("issolo",e.isSolo),t}static setProperty(e,t,s){switch(t){case"volume":return e.volume=s,!0;case"balance":return e.balance=s,!0;case"port":return e.port=s,!0;case"program":return e.program=s,!0;case"bank":return e.bank=s,!0;case"primarychannel":return e.primaryChannel=s,!0;case"secondarychannel":return e.secondaryChannel=s,!0;case"ismute":return e.isMute=s,!0;case"issolo":return e.isSolo=s,!0}return!1}}class vr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>vr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("elementtype",e.elementType),t.set("staffline",e.staffLine),t.set("noteheaddefault",e.noteHeadDefault),t.set("noteheadhalf",e.noteHeadHalf),t.set("noteheadwhole",e.noteHeadWhole),t.set("techniquesymbol",e.techniqueSymbol),t.set("techniquesymbolplacement",e.techniqueSymbolPlacement),t.set("outputmidinumber",e.outputMidiNumber),t}static setProperty(e,t,s){switch(t){case"elementtype":return e.elementType=s,!0;case"staffline":return e.staffLine=s,!0;case"noteheaddefault":return e.noteHeadDefault=Aa.parseEnum(s,ne),!0;case"noteheadhalf":return e.noteHeadHalf=Aa.parseEnum(s,ne),!0;case"noteheadwhole":return e.noteHeadWhole=Aa.parseEnum(s,ne),!0;case"techniquesymbol":return e.techniqueSymbol=Aa.parseEnum(s,ne),!0;case"techniquesymbolplacement":return e.techniqueSymbolPlacement=Aa.parseEnum(s,le),!0;case"outputmidinumber":return e.outputMidiNumber=s,!0}return!1}}class Er{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Er.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;{const s=new Map;t.set("colors",s);for(const[t,i]of e.colors)s.set(t.toString(),at.toJson(i))}return t}static setProperty(e,t,s){return"colors"===t&&(e.colors=new Map,Aa.forEach(s,(t,s)=>{e.colors.set(Aa.parseEnum(s,_e),at.fromJson(t))}),!0)}}class Mr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Mr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;if(t.set("staves",e.staves.map(e=>Nr.toJson(e))),t.set("playbackinfo",Pr.toJson(e.playbackInfo)),t.set("color",at.toJson(e.color)),t.set("name",e.name),t.set("isvisibleonmultitrack",e.isVisibleOnMultiTrack),t.set("shortname",e.shortName),t.set("defaultsystemslayout",e.defaultSystemsLayout),t.set("systemslayout",e.systemsLayout),void 0!==e.lineBreaks){const s=[];t.set("linebreaks",s);for(const t of e.lineBreaks)s.push(t)}return t.set("percussionarticulations",e.percussionArticulations.map(e=>vr.toJson(e))),e.style&&t.set("style",Er.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"staves":e.staves=[];for(const t of s){const s=new ot;Nr.fromJson(s,t),e.addStaff(s)}return!0;case"playbackinfo":return Pr.fromJson(e.playbackInfo,s),!0;case"color":return e.color=at.fromJson(s),!0;case"name":return e.name=s,!0;case"isvisibleonmultitrack":return e.isVisibleOnMultiTrack=s,!0;case"shortname":return e.shortName=s,!0;case"defaultsystemslayout":return e.defaultSystemsLayout=s,!0;case"systemslayout":return e.systemsLayout=s,!0;case"linebreaks":for(const t of s)e.addLineBreaks(t);return!0;case"percussionarticulations":e.percussionArticulations=[];for(const t of s){const s=new Le;vr.fromJson(s,t),e.percussionArticulations.push(s)}return!0;case"style":return s?(e.style=new ht,Er.fromJson(e.style,s)):e.style=void 0,!0}return!1}}class Fr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Fr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;if(t.set("hidedynamics",e.hideDynamics),t.set("bracketextendmode",e.bracketExtendMode),t.set("usesystemsignseparator",e.useSystemSignSeparator),t.set("globaldisplaytuning",e.globalDisplayTuning),null!==e.perTrackDisplayTuning){const s=new Map;t.set("pertrackdisplaytuning",s);for(const[t,i]of e.perTrackDisplayTuning)s.set(t.toString(),i)}if(t.set("globaldisplaychorddiagramsontop",e.globalDisplayChordDiagramsOnTop),null!==e.perTrackChordDiagramsOnTop){const s=new Map;t.set("pertrackchorddiagramsontop",s);for(const[t,i]of e.perTrackChordDiagramsOnTop)s.set(t.toString(),i)}if(t.set("singletracktracknamepolicy",e.singleTrackTrackNamePolicy),t.set("multitracktracknamepolicy",e.multiTrackTrackNamePolicy),t.set("firstsystemtracknamemode",e.firstSystemTrackNameMode),t.set("othersystemstracknamemode",e.otherSystemsTrackNameMode),t.set("firstsystemtracknameorientation",e.firstSystemTrackNameOrientation),t.set("othersystemstracknameorientation",e.otherSystemsTrackNameOrientation),t.set("multitrackmultibarrest",e.multiTrackMultiBarRest),null!==e.perTrackMultiBarRest){const s=[];t.set("pertrackmultibarrest",s);for(const t of e.perTrackMultiBarRest)s.push(t)}return t}static setProperty(e,t,s){switch(t){case"hidedynamics":return e.hideDynamics=s,!0;case"bracketextendmode":return e.bracketExtendMode=Aa.parseEnum(s,a),!0;case"usesystemsignseparator":return e.useSystemSignSeparator=s,!0;case"globaldisplaytuning":return e.globalDisplayTuning=s,!0;case"pertrackdisplaytuning":return e.perTrackDisplayTuning=new Map,Aa.forEach(s,(t,s)=>{e.perTrackDisplayTuning.set(Number.parseInt(s),t)}),!0;case"globaldisplaychorddiagramsontop":return e.globalDisplayChordDiagramsOnTop=s,!0;case"pertrackchorddiagramsontop":return e.perTrackChordDiagramsOnTop=new Map,Aa.forEach(s,(t,s)=>{e.perTrackChordDiagramsOnTop.set(Number.parseInt(s),t)}),!0;case"singletracktracknamepolicy":return e.singleTrackTrackNamePolicy=Aa.parseEnum(s,r),!0;case"multitracktracknamepolicy":return e.multiTrackTrackNamePolicy=Aa.parseEnum(s,r),!0;case"firstsystemtracknamemode":return e.firstSystemTrackNameMode=Aa.parseEnum(s,n),!0;case"othersystemstracknamemode":return e.otherSystemsTrackNameMode=Aa.parseEnum(s,n),!0;case"firstsystemtracknameorientation":return e.firstSystemTrackNameOrientation=Aa.parseEnum(s,o),!0;case"othersystemstracknameorientation":return e.otherSystemsTrackNameOrientation=Aa.parseEnum(s,o),!0;case"multitrackmultibarrest":return e.multiTrackMultiBarRest=s,!0;case"pertrackmultibarrest":return e.perTrackMultiBarRest=new Set(s),!0}return!1}}class Cr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Cr.setProperty(e,s,t))}static toJson(e){if(!e)return null;return new Map}static setProperty(e,t,s){return!1}}class Dr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Dr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("template",e.template),t.set("isvisible",e.isVisible),t.set("textalign",e.textAlign),t}static setProperty(e,t,s){switch(t){case"template":return e.template=s,!0;case"isvisible":return e.isVisible=s,!0;case"textalign":return e.textAlign=Aa.parseEnum(s,we),!0}return!1}}class Lr{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Lr.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;{const s=new Map;t.set("headerandfooter",s);for(const[t,i]of e.headerAndFooter)s.set(t.toString(),Dr.toJson(i))}{const s=new Map;t.set("colors",s);for(const[t,i]of e.colors)s.set(t.toString(),at.toJson(i))}return t}static setProperty(e,t,s){switch(t){case"headerandfooter":return e.headerAndFooter=new Map,Aa.forEach(s,(t,s)=>{const i=new qe;Dr.fromJson(i,t),e.headerAndFooter.set(Aa.parseEnum(s,ke),i)}),!0;case"colors":return e.colors=new Map,Aa.forEach(s,(t,s)=>{e.colors.set(Aa.parseEnum(s,ke),at.fromJson(t))}),!0}return!1}}class Ir{static fromJson(e,t){t&&Aa.forEach(t,(t,s)=>Ir.setProperty(e,s,t))}static toJson(e){if(!e)return null;const t=new Map;return t.set("album",e.album),t.set("artist",e.artist),t.set("copyright",e.copyright),t.set("instructions",e.instructions),t.set("music",e.music),t.set("notices",e.notices),t.set("subtitle",e.subTitle),t.set("title",e.title),t.set("words",e.words),t.set("tab",e.tab),t.set("tempo",e.tempo),t.set("tempolabel",e.tempoLabel),t.set("masterbars",e.masterBars.map(e=>pr.toJson(e))),t.set("tracks",e.tracks.map(e=>Mr.toJson(e))),t.set("defaultsystemslayout",e.defaultSystemsLayout),t.set("systemslayout",e.systemsLayout),t.set("stylesheet",Fr.toJson(e.stylesheet)),e.backingTrack&&t.set("backingtrack",Cr.toJson(e.backingTrack)),e.style&&t.set("style",Lr.toJson(e.style)),t}static setProperty(e,t,s){switch(t){case"album":return e.album=s,!0;case"artist":return e.artist=s,!0;case"copyright":return e.copyright=s,!0;case"instructions":return e.instructions=s,!0;case"music":return e.music=s,!0;case"notices":return e.notices=s,!0;case"subtitle":return e.subTitle=s,!0;case"title":return e.title=s,!0;case"words":return e.words=s,!0;case"tab":return e.tab=s,!0;case"tempo":return e.tempo=s,!0;case"tempolabel":return e.tempoLabel=s,!0;case"masterbars":e.masterBars=[];for(const t of s){const s=new te;pr.fromJson(s,t),e.addMasterBar(s)}return!0;case"tracks":e.tracks=[];for(const t of s){const s=new lt;Mr.fromJson(s,t),e.addTrack(s)}return!0;case"defaultsystemslayout":return e.defaultSystemsLayout=s,!0;case"systemslayout":return e.systemsLayout=s,!0;case"stylesheet":return Fr.fromJson(e.stylesheet,s),!0;case"backingtrack":return s?(e.backingTrack=new xs,Cr.fromJson(e.backingTrack,s)):e.backingTrack=void 0,!0;case"style":return s?(e.style=new je,Lr.fromJson(e.style,s)):e.style=void 0,!0}return!1}}class Ar{static jsonReplacer(e,t){if(t instanceof Map){if("fromEntries"in Object)return Object.fromEntries(t);const e={};for(const[s,i]of t)e[s]=i;return e}return ArrayBuffer.isView(t)?Array.apply([],[t]):t}static scoreToJson(e){const t=Ar.scoreToJsObject(e);return JSON.stringify(t,Ar.jsonReplacer)}static jsonToScore(e,t){return Ar.jsObjectToScore(JSON.parse(e),t)}static scoreToJsObject(e){return Ir.toJson(e)}static jsObjectToScore(e,t){const s=new Ke;return Ir.fromJson(s,e),s.finish(t??new hr),s}static settingsToJson(e){const t=Ar.settingsToJsObject(e);return JSON.stringify(t,Ar.jsonReplacer)}static jsonToSettings(e){return Ar.jsObjectToSettings(JSON.parse(e))}static settingsToJsObject(e){return nr.toJson(e)}static jsObjectToSettings(e){const t=new hr;return nr.fromJson(t,e),t}static jsObjectToMidiFile(e){const t=new ii;return Aa.forEach(e,(e,s)=>{switch(s){case"division":t.division=e;break;case"tracks":for(const s of e){const e=Ar.jsObjectToMidiTrack(s);t.tracks.push(e)}}}),t}static jsObjectToMidiTrack(e){const t=new si;return Aa.forEach(e,(e,s)=>{if("events"===s)for(const s of e){const e=Ar.jsObjectToMidiEvent(s);t.events.push(e)}}),t}static jsObjectToMidiEvent(t){const s=Aa.getValue(t,"track"),i=Aa.getValue(t,"tick"),a=Aa.getValue(t,"type");switch(a){case Mt.TimeSignature:return new ri(s,i,Aa.getValue(t,"numerator"),Aa.getValue(t,"denominatorIndex"),Aa.getValue(t,"midiClocksPerMetronomeClick"),Aa.getValue(t,"thirdySecondNodesInQuarter"));case Mt.AlphaTabRest:return new hi(s,i,Aa.getValue(t,"channel"));case Mt.AlphaTabMetronome:return new oi(s,i,Aa.getValue(t,"metronomeNumerator"),Aa.getValue(t,"metronomeDurationInTicks"),Aa.getValue(t,"metronomeDurationInMilliseconds"));case Mt.NoteOn:return new ci(s,i,Aa.getValue(t,"channel"),Aa.getValue(t,"noteKey"),Aa.getValue(t,"noteVelocity"));case Mt.NoteOff:return new di(s,i,Aa.getValue(t,"channel"),Aa.getValue(t,"noteKey"),Aa.getValue(t,"noteVelocity"));case Mt.ControlChange:return new ui(s,i,Aa.getValue(t,"channel"),Aa.getValue(t,"controller"),Aa.getValue(t,"value"));case Mt.ProgramChange:return new pi(s,i,Aa.getValue(t,"channel"),Aa.getValue(t,"program"));case Mt.TempoChange:const e=new mi(i,0);return e.beatsPerMinute=Aa.getValue(t,"beatsPerMinute"),e;case Mt.PitchBend:return new gi(s,i,Aa.getValue(t,"channel"),Aa.getValue(t,"value"));case Mt.PerNotePitchBend:return new fi(s,i,Aa.getValue(t,"channel"),Aa.getValue(t,"noteKey"),Aa.getValue(t,"value"));case Mt.EndOfTrack:return new yi(s,i)}throw new O(e.AlphaTabErrorType.Format,`Unknown Midi Event type: ${a}`)}static midiFileToJsObject(e){const t=new Map;t.set("division",e.division);const s=[];for(const t of e.tracks)s.push(Ar.midiTrackToJsObject(t));return t.set("tracks",s),t}static midiTrackToJsObject(e){const t=new Map,s=[];for(const t of e.events)s.push(Ar.midiEventToJsObject(t));return t.set("events",s),t}static midiEventToJsObject(e){const t=new Map;switch(t.set("track",e.track),t.set("tick",e.tick),t.set("type",e.type),e.type){case Mt.TimeSignature:t.set("numerator",e.numerator),t.set("denominatorIndex",e.denominatorIndex),t.set("midiClocksPerMetronomeClick",e.midiClocksPerMetronomeClick),t.set("thirdySecondNodesInQuarter",e.thirtySecondNodesInQuarter);break;case Mt.AlphaTabRest:t.set("channel",e.channel);break;case Mt.AlphaTabMetronome:t.set("metronomeNumerator",e.metronomeNumerator),t.set("metronomeDurationInMilliseconds",e.metronomeDurationInMilliseconds),t.set("metronomeDurationInTicks",e.metronomeDurationInTicks);break;case Mt.NoteOn:case Mt.NoteOff:t.set("channel",e.channel),t.set("noteKey",e.noteKey),t.set("noteVelocity",e.noteVelocity);break;case Mt.ControlChange:t.set("channel",e.channel),t.set("controller",e.controller),t.set("value",e.value);break;case Mt.ProgramChange:t.set("channel",e.channel),t.set("program",e.program);break;case Mt.TempoChange:t.set("beatsPerMinute",e.beatsPerMinute);break;case Mt.PitchBend:t.set("channel",e.channel),t.set("value",e.value);break;case Mt.PerNotePitchBend:t.set("channel",e.channel),t.set("noteKey",e.noteKey),t.set("value",e.value);case Mt.EndOfTrack:}return t}}class Rr{constructor(e,t){this._exporter=new Map,this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this)),this._player=new La(new js,t),this._player.positionChanged.on(this.onPositionChanged.bind(this)),this._player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this._player.finished.on(this.onFinished.bind(this)),this._player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.midiLoaded.on(this.onMidiLoaded.bind(this)),this._player.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this._player.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this._player.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this._player.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this._main.postMessage({cmd:"alphaSynth.ready"})}static init(){const e=Hc.globalThis;e.addEventListener("message",t=>{const s=t.data;if("alphaSynth.initialize"===s.cmd)js.preferredSampleRate=s.sampleRate,ee.logLevel=s.logLevel,Hc.globalThis.alphaSynthWebWorker=new Rr(e,s.bufferTimeInMilliseconds)})}handleMessage(e){const t=e.data,s=t.cmd;switch(s){case"alphaSynth.setLogLevel":ee.logLevel=t.value;break;case"alphaSynth.setMasterVolume":this._player.masterVolume=t.value;break;case"alphaSynth.setMetronomeVolume":this._player.metronomeVolume=t.value;break;case"alphaSynth.setPlaybackSpeed":this._player.playbackSpeed=t.value;break;case"alphaSynth.setTickPosition":this._player.tickPosition=t.value;break;case"alphaSynth.setTimePosition":this._player.timePosition=t.value;break;case"alphaSynth.setPlaybackRange":this._player.playbackRange=t.value;break;case"alphaSynth.setIsLooping":this._player.isLooping=t.value;break;case"alphaSynth.setCountInVolume":this._player.countInVolume=t.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this._player.midiEventsPlayedFilter=t.value;break;case"alphaSynth.play":this._player.play();break;case"alphaSynth.pause":this._player.pause();break;case"alphaSynth.playPause":this._player.playPause();break;case"alphaSynth.stop":this._player.stop();break;case"alphaSynth.playOneTimeMidiFile":this._player.playOneTimeMidiFile(Ar.jsObjectToMidiFile(t.midi));break;case"alphaSynth.loadSoundFontBytes":this._player.loadSoundFont(t.data,t.append);break;case"alphaSynth.resetSoundFonts":this._player.resetSoundFonts();break;case"alphaSynth.loadMidi":this._player.loadMidiFile(Ar.jsObjectToMidiFile(t.midi));break;case"alphaSynth.setChannelMute":this._player.setChannelMute(t.channel,t.mute);break;case"alphaSynth.setChannelTranspositionPitch":this._player.setChannelTranspositionPitch(t.channel,t.semitones);break;case"alphaSynth.setChannelSolo":this._player.setChannelSolo(t.channel,t.solo);break;case"alphaSynth.setChannelVolume":this._player.setChannelVolume(t.channel,t.volume);break;case"alphaSynth.resetChannelStates":this._player.resetChannelStates();break;case"alphaSynth.destroy":this._player.destroy(),this._main.postMessage({cmd:"alphaSynth.destroyed"});break;case"alphaSynth.applyTranspositionPitches":this._player.applyTranspositionPitches(new Map(JSON.parse(t.transpositionPitches)))}s.startsWith("alphaSynth.exporter")&&this.handleExporterMessage(e)}handleExporterMessage(e){const t=e.data,s=t.cmd;try{switch(s){case"alphaSynth.exporter.initialize":const e=this._player.exportAudio(t.options,Ar.jsObjectToMidiFile(t.midi),t.syncPoints,t.transpositionPitches);this._exporter.set(t.exporterId,e),this._main.postMessage({cmd:"alphaSynth.exporter.initialized",exporterId:t.exporterId});break;case"alphaSynth.exporter.render":if(this._exporter.has(t.exporterId)){const e=this._exporter.get(t.exporterId).render(t.milliseconds);this._main.postMessage({cmd:"alphaSynth.exporter.rendered",exporterId:t.exporterId,chunk:e})}else this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:t.exporterId,error:new Error("Unknown exporter ID")});break;case"alphaSynth.exporter.destroy":this._exporter.delete(t.exporterId)}}catch(e){this._main.postMessage({cmd:"alphaSynth.exporter.error",exporterId:t.exporterId,error:e})}}onPositionChanged(e){this._main.postMessage({cmd:"alphaSynth.positionChanged",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek,originalTempo:e.originalTempo,modifiedTempo:e.modifiedTempo})}onPlayerStateChanged(e){this._main.postMessage({cmd:"alphaSynth.playerStateChanged",state:e.state,stopped:e.stopped})}onFinished(){this._main.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this._main.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this.serializeException(Hc.prepareForPostMessage(e))})}serializeException(e){const t=JSON.parse(JSON.stringify(e));return e.message&&(t.message=e.message),e.stack&&(t.stack=e.stack),e.constructor&&e.constructor.name&&(t.type=e.constructor.name),t}onMidiLoaded(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek,originalTempo:e.originalTempo,modifiedTempo:e.modifiedTempo})}onMidiLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",error:this.serializeException(Hc.prepareForPostMessage(e))})}onReadyForPlayback(){this._main.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(e){this._main.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:e.events.map(Ar.midiEventToJsObject)})}onPlaybackRangeChanged(e){this._main.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:e.playbackRange})}}e.WebPlatform=void 0,(Yt=e.WebPlatform||(e.WebPlatform={}))[Yt.Browser=0]="Browser",Yt[Yt.NodeJs=1]="NodeJs",Yt[Yt.BrowserModule=2]="BrowserModule";class Or{constructor(e,t){this.characterWidths=e,this.characterHeights=t}}class Wr{static generateFontLookup(t){if(!Wr.FontSizeLookupTables.has(t))if(Hc.isRunningInWorker||Hc.webPlatform===e.WebPlatform.NodeJs){const e=new Or(new Uint8Array([8]),new Uint8Array([10]));Wr.FontSizeLookupTables.set(t,e)}else{const e=document.createElement("canvas").getContext("2d"),s=11;e.font=`${s}px ${t}`;const i=[],a=[];for(let t=Wr.ControlChars;t<255;t++){const s=String.fromCharCode(t),r=e.measureText(s);i.push(r.width);const n=r.actualBoundingBoxDescent+r.actualBoundingBoxAscent;a.push(n)}const r=new Or(new Uint8Array(i),new Uint8Array(a));Wr.FontSizeLookupTables.set(t,r)}}static measureString(e,t,s,i,a){let r;let n=t[0];for(let e=0;e<t.length;e++)if(Wr.FontSizeLookupTables.has(t[e])){n=t[e];break}Wr.FontSizeLookupTables.has(n)||Wr.generateFontLookup(n),r=Wr.FontSizeLookupTables.get(n);let o=1;i===Wt.Italic&&(o*=1.1),a===Ht.Bold&&(o*=1.1);let h=0,l=0;for(let t=0;t<e.length;t++){const i=Math.min(r.characterWidths.length-1,e.charCodeAt(t)-Wr.ControlChars);i>=0&&(h+=r.characterWidths[i]*s/11,l=Math.max(l,r.characterHeights[i]*s/11))}return o*=1.07,new Je(h*o,l)}}Wr.FontSizeLookupTables=new Map,Wr.ControlChars=32;class Hr{constructor(){this.id=De.newGuid(),this.x=0,this.y=0,this.width=0,this.height=0,this.totalWidth=0,this.totalHeight=0,this.firstMasterBarIndex=-1,this.lastMasterBarIndex=-1,this.renderResult=null}}class Gr{constructor(){this.beats=[]}addBeat(e){e.barBounds=this,this.beats.push(e),this.masterBarBounds.addBeat(e)}findBeatAtPos(e){let t=null;for(const s of this.beats)if(!t||s.realBounds.x<e)t=s;else if(s.realBounds.x>e)break;return t}finish(e=1){this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.beats.sort((e,t)=>e.realBounds.x-t.realBounds.x);for(const t of this.beats)t.finish(e)}}class Vr{constructor(){this.onNotesX=0,this.notes=null}addNote(e){this.notes||(this.notes=[]),e.beatBounds=this,this.notes.push(e)}findNoteAtPos(e,t){const s=this.notes;if(!s)return null;for(const i of s){const s=i.noteHeadBounds.y+i.noteHeadBounds.h,a=i.noteHeadBounds.x+i.noteHeadBounds.w;if(i.noteHeadBounds.x<=e&&i.noteHeadBounds.y<=t&&e<=a&&t<=s)return i.note}return null}finish(e=1){if(this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.onNotesX*=e,this.notes)for(const t of this.notes)t.finish(e)}}class Ur{constructor(){this.index=0,this.isFirstOfLine=!1,this.bars=[],this.staffSystemBounds=null}get staveGroupBounds(){return this.staffSystemBounds}addBar(e){e.masterBarBounds=this,this.bars.push(e)}findBeatAtPos(e){let t=null;for(const s of this.bars){const i=s.findBeatAtPos(e);if(i&&(!t||t.realBounds.x<i.realBounds.x)){const s=Math.abs(i.realBounds.x-e);(!t||s<1e7)&&(t=i)}}return t?t.beat:null}finish(e=1){this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e),this.lineAlignedBounds.scaleWith(e),this.bars.sort((e,t)=>e.realBounds.y<t.realBounds.y?-1:e.realBounds.y>t.realBounds.y?1:e.realBounds.x<t.realBounds.x?-1:e.realBounds.x>t.realBounds.x?1:0);for(const t of this.bars)t.finish(e)}addBeat(e){this.staffSystemBounds.boundsLookup.addBeat(e)}}class zr{finish(e=1){this.noteHeadBounds.scaleWith(e)}}class Xr{constructor(){this.index=0,this.bars=[]}finish(e=1){this.realBounds.scaleWith(e),this.visualBounds.scaleWith(e);for(const t of this.bars)t.finish(e)}addBar(e){this.boundsLookup.addMasterBar(e),e.staffSystemBounds=this,this.bars.push(e)}findBarAtPos(e){let t=null;for(const s of this.bars)if(!t||s.realBounds.x<e)t=s;else if(e>s.realBounds.x+s.realBounds.w)break;return t}}class Yr{constructor(){this._beatLookup=new Map,this._masterBarLookup=new Map,this._currentStaffSystem=null,this.staffSystems=[],this.isFinished=!1}toJson(){const e={},t=[];e.staffSystems=t;for(const e of this.staffSystems){const s={};s.visualBounds=this.boundsToJson(e.visualBounds),s.realBounds=this.boundsToJson(e.realBounds),s.bars=[];for(const t of e.bars){const e={};e.lineAlignedBounds=this.boundsToJson(t.lineAlignedBounds),e.visualBounds=this.boundsToJson(t.visualBounds),e.realBounds=this.boundsToJson(t.realBounds),e.index=t.index,e.bars=[];for(const s of t.bars){const t={};t.visualBounds=this.boundsToJson(s.visualBounds),t.realBounds=this.boundsToJson(s.realBounds),t.beats=[];for(const e of s.beats){const s={};s.visualBounds=this.boundsToJson(e.visualBounds),s.realBounds=this.boundsToJson(e.realBounds),s.onNotesX=e.onNotesX;const i=s;if(i.beatIndex=e.beat.index,i.voiceIndex=e.beat.voice.index,i.barIndex=e.beat.voice.bar.index,i.staffIndex=e.beat.voice.bar.staff.index,i.trackIndex=e.beat.voice.bar.staff.track.index,e.notes){const t=[];s.notes=t;for(const s of e.notes){const e={};e.index=s.note.index,e.noteHeadBounds=this.boundsToJson(s.noteHeadBounds),t.push(e)}}t.beats.push(s)}e.bars.push(t)}s.bars.push(e)}t.push(s)}return e}static fromJson(e,t){const s=new Yr,i=e.staffSystems;for(const e of i){const i=new Xr;i.visualBounds=Yr.boundsFromJson(e.visualBounds),i.realBounds=Yr.boundsFromJson(e.realBounds),s.addStaffSystem(i);for(const s of e.bars){const e=new Ur;e.index=s.index,e.isFirstOfLine=s.isFirstOfLine,e.lineAlignedBounds=Yr.boundsFromJson(s.lineAlignedBounds),e.visualBounds=Yr.boundsFromJson(s.visualBounds),e.realBounds=Yr.boundsFromJson(s.realBounds),i.addBar(e);for(const i of s.bars){const s=new Gr;s.visualBounds=Yr.boundsFromJson(i.visualBounds),s.realBounds=Yr.boundsFromJson(i.realBounds),e.addBar(s);for(const e of i.beats){const i=new Vr;i.visualBounds=Yr.boundsFromJson(e.visualBounds),i.realBounds=Yr.boundsFromJson(e.realBounds),i.onNotesX=e.onNotesX;const a=e;if(i.beat=t.tracks[a.trackIndex].staves[a.staffIndex].bars[a.barIndex].voices[a.voiceIndex].beats[a.beatIndex],e.notes){i.notes=[];for(const t of e.notes){const e=new zr,s=t;e.note=i.beat.notes[s.index],e.noteHeadBounds=Yr.boundsFromJson(t.noteHeadBounds),i.addNote(e)}}s.addBeat(i)}}}}return s}static boundsFromJson(e){const t=new Ts;return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}boundsToJson(e){const t={};return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}finish(e=1){for(const t of this.staffSystems)t.finish(e);this.isFinished=!0}addStaffSystem(e){e.index=this.staffSystems.length,e.boundsLookup=this,this.staffSystems.push(e),this._currentStaffSystem=e}addMasterBar(e){e.staffSystemBounds?this._masterBarLookup.set(e.index,e):(e.staffSystemBounds=this._currentStaffSystem,this._masterBarLookup.set(e.index,e),this._currentStaffSystem.addBar(e))}addBeat(e){this._beatLookup.has(e.beat.id)||this._beatLookup.set(e.beat.id,[]),this._beatLookup.get(e.beat.id)?.push(e)}findMasterBarByIndex(e){return this._masterBarLookup.has(e)?this._masterBarLookup.get(e):null}findMasterBar(e){const t=e.index;return this._masterBarLookup.has(t)?this._masterBarLookup.get(t):null}findBeat(e){const t=this.findBeats(e);return t?t[0]:null}findBeats(e){const t=e.id;return this._beatLookup.has(t)?this._beatLookup.get(t):null}getBeatAtPos(e,t){let s=0,i=this.staffSystems.length-1,a=-1;for(;s<=i;){const e=(i+s)/2|0,r=this.staffSystems[e];if(t>=r.realBounds.y&&t<=r.realBounds.y+r.realBounds.h){a=e;break}t<r.realBounds.y?i=e-1:s=e+1}if(-1===a)return null;const r=this.staffSystems[a].findBarAtPos(e);return r?r.findBeatAtPos(e):null}getNoteAtPos(e,t,s){const i=this.findBeats(e);if(i)for(const e of i){const i=e.findNoteAtPos(t,s);if(i)return i}return null}}class Jr{constructor(t){this._currentLayoutMode=e.LayoutMode.Page,this._currentRenderEngine=null,this._renderedTracks=null,this.canvas=null,this.score=null,this.tracks=null,this.layout=null,this.boundsLookup=null,this.width=0,this.preRender=new qs,this.renderFinished=new qs,this.partialRenderFinished=new qs,this.partialLayoutFinished=new qs,this.postRenderFinished=new $s,this.error=new qs,this.settings=t,this.recreateCanvas(),this.recreateLayout()}destroy(){this.score=null,this.canvas?.destroy(),this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}recreateCanvas(){return this._currentRenderEngine!==this.settings.core.engine&&(this.canvas?.destroy(),this.canvas=Hc.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this._currentRenderEngine=this.settings.core.engine,!0)}recreateLayout(){return(!this.layout||this._currentLayoutMode!==this.settings.display.layoutMode)&&(this.layout=Hc.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this._currentLayoutMode=this.settings.display.layoutMode,!0)}renderScore(e,t){try{this.score=e;let s=null;if(null!=e&&null!=t){if(t){s=[];for(const i of t)i>=0&&i<e.tracks.length&&s.push(e.tracks[i])}else s=e.tracks.slice(0);0===s.length&&e.tracks.length>0&&s.push(e.tracks[0])}this.tracks=s,this.render()}catch(e){this.error.trigger(e)}}renderTracks(e){0===e.length?this.score=null:this.score=e[0].score,this.tracks=e,this.render()}updateSettings(e){this.settings=e}renderResult(e){try{const t=this.layout;t?(ee.debug("Rendering",`Request render of lazy partial ${e}`),t.renderLazyPartial(e)):ee.warning("Rendering",`Request render of lazy partial ${e} ignored, no layout exists`)}catch(e){this.error.trigger(e)}}render(){if(0!==this.width)if(this.boundsLookup=new Yr,this.recreateCanvas(),this.canvas.lineWidth=1,this.canvas.settings=this.settings,this.tracks&&0!==this.tracks.length&&this.score){ee.debug("Rendering",`Rendering ${this.tracks.length} tracks`);for(let e=0;e<this.tracks.length;e++){const t=this.tracks[e];ee.debug("Rendering",`Track ${e}: ${t.name}`)}this.preRender.trigger(!1),this.recreateLayout(),this.layoutAndRender(),ee.debug("Rendering","Rendering finished")}else ee.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this._renderedTracks=null,this.onRenderFinished(),this.postRenderFinished.trigger(),ee.debug("Rendering","Clearing finished");else ee.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null)}resizeRender(){this.recreateLayout()||this.recreateCanvas()||this._renderedTracks!==this.tracks||!this.tracks?(ee.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(ee.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new Yr,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this.onRenderFinished(),this.postRenderFinished.trigger()):ee.debug("Rendering","Current layout does not support dynamic resizing, nothing was done",null),ee.debug("Rendering","Resize finished")}layoutAndRender(){ee.debug("Rendering",`Rendering at scale ${this.settings.display.scale} with layout ${this.layout.name}`,null),this.layout.layoutAndRender(),this._renderedTracks=this.tracks,this.onRenderFinished(),this.postRenderFinished.trigger()}onRenderFinished(){this.boundsLookup?.finish(this.settings.display.scale);const e=new Hr;e.totalHeight=this.layout.height,e.totalWidth=this.layout.width,e.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(e)}}class $r{constructor(e){this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this),!1)}static init(){Hc.globalThis.alphaTabWebWorker=new $r(Hc.globalThis)}handleMessage(e){const t=e.data;switch(t?t.cmd:""){case"alphaTab.initialize":const e=Ar.jsObjectToSettings(t.settings);ee.logLevel=e.core.logLevel,this._renderer=new Jr(e),this._renderer.partialRenderFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.partialRenderFinished",result:e})}),this._renderer.partialLayoutFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.partialLayoutFinished",result:e})}),this._renderer.renderFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.renderFinished",result:e})}),this._renderer.postRenderFinished.on(()=>{this._main.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:this._renderer.boundsLookup?.toJson()??null})}),this._renderer.preRender.on(e=>{this._main.postMessage({cmd:"alphaTab.preRender",resize:e})}),this._renderer.error.on(this.error.bind(this));break;case"alphaTab.invalidate":this._renderer.render();break;case"alphaTab.resizeRender":this._renderer.resizeRender();break;case"alphaTab.renderResult":this._renderer.renderResult(t.resultId);break;case"alphaTab.setWidth":this._renderer.width=t.width;break;case"alphaTab.renderScore":this.updateFontSizes(t.fontSizes);const s=null==t.score?null:Ar.jsObjectToScore(t.score,this._renderer.settings);this.renderMultiple(s,t.trackIndexes);break;case"alphaTab.updateSettings":this.updateSettings(t.settings)}}updateFontSizes(e){if(!(e instanceof Map)){const t=e;e=new Map;for(const s in t)e.set(s,t[s])}if(e){Wr.FontSizeLookupTables||(Wr.FontSizeLookupTables=new Map);for(const[t,s]of e)Wr.FontSizeLookupTables.set(t,s)}}updateSettings(e){nr.fromJson(this._renderer.settings,e)}renderMultiple(e,t){try{this._renderer.renderScore(e,t)}catch(e){this.error(e)}}error(e){ee.error("Worker","An unexpected error occurred in worker",e),this._main.postMessage({cmd:"alphaTab.error",error:e})}}class qr{constructor(){this._canvas=null,this._color=new at(0,0,0,255),this._font=new Wa("Arial",10,Wt.Plain),this._lineWidth=0,this._measureCanvas=document.createElement("canvas"),this._measureCanvas.width=10,this._measureCanvas.height=10,this._measureCanvas.style.width="10px",this._measureCanvas.style.height="10px",this._measureContext=this._measureCanvas.getContext("2d"),this._measureContext.textBaseline="hanging"}destroy(){}onRenderFinished(){return null}beginRender(e,t){this._musicFont=new Wa(this.settings.display.resources.smuflFontFamilyName,this.settings.display.resources.engravingSettings.musicFontSize,Wt.Plain,Ht.Regular);const s=this.settings.display.scale;this._canvas=document.createElement("canvas"),this._canvas.width=e*Hc.HighDpiFactor|0,this._canvas.height=t*Hc.HighDpiFactor|0,this._canvas.style.width=`${e}px`,this._canvas.style.height=`${t}px`,this._context=this._canvas.getContext("2d"),this._context.textBaseline="hanging",this._context.scale(Hc.HighDpiFactor*s,Hc.HighDpiFactor*s),this._context.lineWidth=this._lineWidth}endRender(){const e=this._canvas;return this._canvas=null,e}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._context.strokeStyle=e.rgba,this._context.fillStyle=e.rgba)}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._context&&(this._context.lineWidth=e)}fillRect(e,t,s,i){s>0&&this._context.fillRect(e,t,s,i)}strokeRect(e,t,s,i){const a=this.lineWidth%2==0?0:.5;this._context.strokeRect(e+a,t+a,s,i)}beginPath(){this._context.beginPath()}closePath(){this._context.closePath()}moveTo(e,t){this._context.moveTo(e,t)}lineTo(e,t){this._context.lineTo(e,t)}quadraticCurveTo(e,t,s,i){this._context.quadraticCurveTo(e,t,s,i)}bezierCurveTo(e,t,s,i,a,r){this._context.bezierCurveTo(e,t,s,i,a,r)}fillCircle(e,t,s){this._context.beginPath(),this._context.arc(e,t,s,0,2*Math.PI,!0),this.fill()}strokeCircle(e,t,s){this._context.beginPath(),this._context.arc(e,t,s,0,2*Math.PI,!0),this.stroke()}fill(){this._context.fill(),this._context.beginPath()}stroke(){this._context.stroke(),this._context.beginPath()}get font(){return this._font}set font(e){this._font=e,this._context&&(this._context.font=e.toCssString(1)),this._measureContext.font=e.toCssString(1)}get textAlign(){switch(this._context.textAlign){case"left":default:return we.Left;case"center":return we.Center;case"right":return we.Right}}set textAlign(e){switch(e){case we.Left:this._context.textAlign="left";break;case we.Center:this._context.textAlign="center";break;case we.Right:this._context.textAlign="right"}}get textBaseline(){switch(this._context.textBaseline){case"hanging":default:return Be.Top;case"middle":return Be.Middle;case"bottom":return Be.Bottom;case"alphabetic":return Be.Alphabetic}}set textBaseline(e){switch(e){case Be.Top:this._context.textBaseline="hanging";break;case Be.Middle:this._context.textBaseline="middle";break;case Be.Bottom:this._context.textBaseline="bottom";break;case Be.Alphabetic:this._context.textBaseline="alphabetic"}}beginGroup(e){}endGroup(){}fillText(e,t,s){this._context.fillText(e,t,s)}measureText(e){const t=this._measureContext.measureText(e);return new Je(t.width,t.actualBoundingBoxDescent+t.actualBoundingBoxAscent)}fillMusicFontSymbol(e,t,s,i,a=!1){i!==ne.None&&this.fillMusicFontSymbolText(e,t,s,String.fromCharCode(i),a)}fillMusicFontSymbols(e,t,s,i,a=!1){let r="";for(const e of i)e!==ne.None&&(r+=String.fromCharCode(e));this.fillMusicFontSymbolText(e,t,s,r,a)}fillMusicFontSymbolText(e,t,s,i,a){const r=this._context.textAlign,n=this._context.textBaseline,o=this._context.font;this._context.font=this._musicFont.toCssString(s),this._context.textBaseline="alphabetic",this._context.textAlign=a?"center":"left",this._context.fillText(i,e,t),this._context.textBaseline=n,this._context.font=o,this._context.textAlign=r}beginRotate(e,t,s){this._context.save(),this._context.translate(e,t),this._context.rotate(s*Math.PI/180)}endRotate(){this._context.restore()}}class jr{constructor(e,t=!1){this._midiFile=e,this._smf1Mode=t}addTimeSignature(e,t,s){let i=0,a=s;for(;a>>=1,a>0;)i++;this._midiFile.addEvent(new ri(0,e,t,i,48,8))}addRest(e,t,s){this._smf1Mode||this._midiFile.addEvent(new hi(e,t,s))}addNote(e,t,s,i,a,r){this._midiFile.addEvent(new ci(e,t,r,jr.fixValue(i),jr.fixValue(a))),this._midiFile.addEvent(new di(e,t+s,r,jr.fixValue(i),jr.fixValue(a)))}static fixValue(e){return e>127?127:e<0?0:e}addControlChange(e,t,s,i,a){this._midiFile.addEvent(new ui(e,t,s,i,jr.fixValue(a)))}addProgramChange(e,t,s,i){this._midiFile.addEvent(new pi(e,t,s,i))}addTempo(e,t){const s=new mi(e,0);s.beatsPerMinute=t,this._midiFile.addEvent(s)}addBend(e,t,s,i){i=i>=se.MaxPitchWheel?se.MaxPitchWheel:Math.floor(i),this._midiFile.addEvent(new gi(e,t,s,i))}addNoteBend(e,t,s,i,a){this._smf1Mode?this.addBend(e,t,s,a):(a=a*se.MaxPitchWheel20/se.MaxPitchWheel,this._midiFile.addEvent(new fi(e,t,s,i,a)))}finishTrack(e,t){this._midiFile.format!==Et.MultiTrack&&0!==e||this._midiFile.addEvent(new yi(e,t))}}class Kr{constructor(e,t){this.closingIndex=0,this.group=e,this.opening=t,e.closings=e.closings.sort((e,t)=>e.index-t.index),this.iterations=e.closings.map(e=>0)}}!function(e){e[e.PlayingNormally=0]="PlayingNormally",e[e.DirectionJumped=1]="DirectionJumped",e[e.DirectionJumpedAlCoda=2]="DirectionJumpedAlCoda",e[e.DirectionJumpedAlDoubleCoda=3]="DirectionJumpedAlDoubleCoda",e[e.DirectionJumpedAlFine=4]="DirectionJumpedAlFine"}(Jt||(Jt={}));class Qr{get finished(){return this.index>=this._score.masterBars.length}constructor(e){this._repeatStack=[],this._groupsOnStack=new Set,this._previousAlternateEndings=0,this._state=Jt.PlayingNormally,this.shouldPlay=!0,this.index=0,this.currentTick=0,this._score=e}processCurrent(){const e=this._score.masterBars[this.index];if(this._state===Jt.PlayingNormally){let t=e.alternateEndings;if(0===t&&(t=this._previousAlternateEndings),e===e.repeatGroup.opening&&e.repeatGroup.isClosed&&!this._groupsOnStack.has(e.repeatGroup)){const s=new Kr(e.repeatGroup,e);this._repeatStack.push(s),this._groupsOnStack.add(e.repeatGroup),this._previousAlternateEndings=0,t=e.alternateEndings}if(0===this._repeatStack.length||0===t)this.shouldPlay=!0;else{const e=this._repeatStack[this._repeatStack.length-1],s=e.iterations[e.closingIndex];this._previousAlternateEndings=t,this.shouldPlay=!!(t&1<<s)}}else this.shouldPlay=!0;this.shouldPlay&&(this.currentTick+=e.calculateDuration())}moveNext(){this.moveNextWithDirections()||this.moveNextWithNormalRepeats()}resetRepeats(){this._groupsOnStack.clear(),this._previousAlternateEndings=0,this._repeatStack=[]}handleDaCapo(e,t,s){return!!e.has(t)&&(this.index=0,this._state=s,this.resetRepeats(),!0)}handleDalSegno(e,t,s,i){if(e.has(t)){const e=this.findJumpTarget(i,this.index,!0);return-1!==e&&(this.index=e,this._state=s,this.resetRepeats(),!0)}return!1}handleDaCoda(e,t,s){if(e.has(t)){const e=this.findJumpTarget(s,this.index,!1);return-1===e?(this.index++,!0):(this.index=e,this._state=Jt.PlayingNormally,!0)}return!1}moveNextWithDirections(){const e=this._score.masterBars[this.index],t=null!==e.directions&&e.directions.size>0;if(this._state===Jt.PlayingNormally&&!t)return!1;if(!t)return this.index++,!0;switch(this._state){case Jt.PlayingNormally:return!!(this.handleDaCapo(e.directions,xe.JumpDaCapo,Jt.DirectionJumped)||this.handleDaCapo(e.directions,xe.JumpDaCapoAlCoda,Jt.DirectionJumpedAlCoda)||this.handleDaCapo(e.directions,xe.JumpDaCapoAlDoubleCoda,Jt.DirectionJumpedAlDoubleCoda)||this.handleDaCapo(e.directions,xe.JumpDaCapoAlFine,Jt.DirectionJumpedAlFine))||(!!(this.handleDalSegno(e.directions,xe.JumpDalSegno,Jt.DirectionJumped,xe.TargetSegno)||this.handleDalSegno(e.directions,xe.JumpDalSegnoAlCoda,Jt.DirectionJumpedAlCoda,xe.TargetSegno)||this.handleDalSegno(e.directions,xe.JumpDalSegnoAlDoubleCoda,Jt.DirectionJumpedAlDoubleCoda,xe.TargetSegno)||this.handleDalSegno(e.directions,xe.JumpDalSegnoAlFine,Jt.DirectionJumpedAlFine,xe.TargetSegno))||!!(this.handleDalSegno(e.directions,xe.JumpDalSegnoSegno,Jt.DirectionJumped,xe.TargetSegnoSegno)||this.handleDalSegno(e.directions,xe.JumpDalSegnoSegnoAlCoda,Jt.DirectionJumpedAlCoda,xe.TargetSegnoSegno)||this.handleDalSegno(e.directions,xe.JumpDalSegnoSegnoAlDoubleCoda,Jt.DirectionJumpedAlDoubleCoda,xe.TargetSegnoSegno)||this.handleDalSegno(e.directions,xe.JumpDalSegnoSegnoAlFine,Jt.DirectionJumpedAlFine,xe.TargetSegnoSegno)));case Jt.DirectionJumped:return this.index++,!0;case Jt.DirectionJumpedAlCoda:return this.handleDaCoda(e.directions,xe.JumpDaCoda,xe.TargetCoda)||this.index++,!0;case Jt.DirectionJumpedAlDoubleCoda:return this.handleDaCoda(e.directions,xe.JumpDaDoubleCoda,xe.TargetDoubleCoda)||this.index++,!0;case Jt.DirectionJumpedAlFine:return e.directions.has(xe.TargetFine)?(this.index=this._score.masterBars.length,!0):(this.index++,!0)}return!0}findJumpTarget(e,t,s){let i;return s?(i=this.findJumpTargetBackwards(e,t),-1===i&&(i=this.findJumpTargetForwards(e,t)),i):(i=this.findJumpTargetForwards(e,t),-1===i&&(i=this.findJumpTargetBackwards(e,t)),i)}findJumpTargetForwards(e,t){let s=t;for(;s<this._score.masterBars.length;){const t=this._score.masterBars[s].directions;if(t&&t.has(e))return s;s++}return-1}findJumpTargetBackwards(e,t){let s=t;for(;s>=0;){const t=this._score.masterBars[s].directions;if(t&&t.has(e))return s;s--}return-1}moveNextWithNormalRepeats(){const e=this._score.masterBars[this.index].repeatCount-1;if(this._repeatStack.length>0&&e>0){const t=this._repeatStack[this._repeatStack.length-1];if(t.iterations[t.closingIndex]<e){this.index=t.opening.index,t.iterations[t.closingIndex]++;for(let e=0;e<t.closingIndex;e++)t.iterations[e]=0;t.closingIndex=0,this._previousAlternateEndings=0}else t.closingIndex<t.group.closings.length-1?(t.closingIndex++,this.index++):(this._repeatStack.pop(),this._groupsOnStack.delete(t.group),this.index++)}else this.index++}}class Zr{constructor(e,t){this.beat=e,this.playbackStart=t}}class en{get duration(){return this.end-this.start}constructor(e,t){this._highlightedBeats=new Map,this.highlightedBeats=[],this.nextBeat=null,this.previousBeat=null,this.start=e,this.end=t}highlightBeat(e,t){e.isEmpty&&!e.voice.isEmpty||this._highlightedBeats.has(e.id)||(this._highlightedBeats.set(e.id,!0),this.highlightedBeats.push(new Zr(e,t)))}getVisibleBeatAtStart(e){for(const t of this.highlightedBeats)if(t.playbackStart===this.start&&e.has(t.beat.voice.bar.staff.track.index))return t.beat;return null}}class tn{constructor(e,t){this.tick=e,this.tempo=t}}class sn{constructor(){this.start=0,this.end=0,this.tempoChanges=[],this.firstBeat=null,this.lastBeat=null,this.nextMasterBar=null,this.previousMasterBar=null}get tempo(){return this.tempoChanges[0].tempo}insertAfter(e,t){null==this.firstBeat||null==e||null==this.lastBeat?(this.firstBeat=t,this.lastBeat=t):(t.nextBeat=e.nextBeat,t.previousBeat=e,e.nextBeat&&(e.nextBeat.previousBeat=t),e.nextBeat=t,e===this.lastBeat&&(this.lastBeat=t))}insertBefore(e,t){null==this.firstBeat||null==e||null==this.lastBeat?(this.firstBeat=t,this.lastBeat=t):(t.previousBeat=e.previousBeat,t.nextBeat=e,e.previousBeat&&(e.previousBeat.nextBeat=t),e.previousBeat=t,e===this.firstBeat&&(this.firstBeat=t))}addBeat(t,s,i,a){const r=i+a;if(null==this.firstBeat){const e=new en(i,r);e.highlightBeat(t,s),this.insertAfter(this.firstBeat,e)}else if(i>=this.lastBeat.end){const e=new en(this.lastBeat.end,r);e.highlightBeat(t,s),this.insertAfter(this.lastBeat,e)}else{let a=null;if(i<this.firstBeat.start)a=this.firstBeat;else{let t=this.firstBeat;for(;null!=t;){if(i>=t.start&&i<t.end){a=t;break}t=t.nextBeat}if(null===a)throw new O(e.AlphaTabErrorType.General,"Error on building lookup, unknown variant")}if(i<a.start)if(r===a.start){const e=new en(i,a.start);e.highlightBeat(t,s),this.insertBefore(this.firstBeat,e)}else if(r<a.end){const e=new en(i,a.start);e.highlightBeat(t,s),this.insertBefore(a,e);const n=new en(a.start,r);for(const e of a.highlightedBeats)n.highlightBeat(e.beat,e.playbackStart);n.highlightBeat(t,s),this.insertBefore(a,n),a.start=r}else if(r===a.end){const e=new en(i,a.start);e.highlightBeat(t,s),a.highlightBeat(t,s),this.insertBefore(a,e)}else{const e=new en(i,a.start);e.highlightBeat(t,s),a.highlightBeat(t,s),this.insertBefore(a,e),this.addBeat(t,s,a.end,r-a.end)}else if(i>a.start)if(r===a.end){const e=new en(a.start,i);for(const t of a.highlightedBeats)e.highlightBeat(t.beat,t.playbackStart);a.start=i,a.highlightBeat(t,s),this.insertBefore(a,e)}else if(r<a.end){const e=new en(a.start,i);this.insertBefore(a,e);const n=new en(i,r);this.insertBefore(a,n);for(const t of a.highlightedBeats)e.highlightBeat(t.beat,t.playbackStart),n.highlightBeat(t.beat,t.playbackStart);n.highlightBeat(t,s),a.start=r}else{const e=new en(a.start,i);for(const t of a.highlightedBeats)e.highlightBeat(t.beat,t.playbackStart);a.start=i,a.highlightBeat(t,s),this.insertBefore(a,e),this.addBeat(t,s,a.end,r-a.end)}else if(r===a.end)a.highlightBeat(t,s);else if(r<a.end){const e=new en(a.start,r);for(const t of a.highlightedBeats)e.highlightBeat(t.beat,t.playbackStart);e.highlightBeat(t,s),a.start=r,this.insertBefore(a,e)}else a.highlightBeat(t,s),this.addBeat(t,s,a.end,r-a.end)}}}!function(e){e[e.Unknown=0]="Unknown",e[e.ToNextBext=1]="ToNextBext",e[e.ToEndOfBar=2]="ToEndOfBar"}($t||($t={}));class an{get start(){return this.masterBar.start+this.beatLookup.start}get end(){return this.start+this.tickDuration}constructor(e){this.nextBeat=null,this.tickDuration=0,this.duration=0,this.cursorMode=$t.Unknown,this.masterBar=e}calculateDuration(){if(1===this.masterBar.tempoChanges.length)this.duration=J.ticksToMillis(this.tickDuration,this.masterBar.tempoChanges[0].tempo);else{let e=0,t=this.start,s=this.masterBar.tempoChanges[0].tempo;const i=this.end;for(const a of this.masterBar.tempoChanges)if(a.tick<t)s=a.tempo;else{if(a.tick>i)break;e+=J.ticksToMillis(a.tick-t,s),s=a.tempo,t=a.tick}i>t&&(e+=J.ticksToMillis(i-t,s)),this.duration=e}}}class rn{constructor(){this._currentMasterBar=null,this.masterBarLookup=new Map,this.masterBars=[],this.multiBarRestInfo=null}findBeat(e,t,s=null){let i=null;return s&&(i=this.findBeatFast(e,s,t)),i||(i=this.findBeatSlow(e,s,t,!1)),i}findBeatFast(e,t,s){if(s>=t.start&&s<t.end)return t;if(t.nextBeat&&s>=t.nextBeat.start&&s<t.nextBeat.end){const s=t.nextBeat;return this.fillNextBeat(s,e),s}return null}fillNextBeatMultiBarRest(e,t){const s=this.multiBarRestInfo.get(e.masterBar.masterBar.index);let i=e.masterBar;for(let e=0;e<s.length&&i;e++)i=i.nextMasterBar;i?i.nextMasterBar?(e.nextBeat=this.firstBeatInMasterBar(t,i.nextMasterBar,i.nextMasterBar.start,!0),e.nextBeat?(e.tickDuration=e.nextBeat.start-e.start,e.cursorMode=$t.ToNextBext,e.nextBeat.masterBar.masterBar.index!==i.masterBar.index+1&&(e.nextBeat.masterBar.masterBar.index!==i.masterBar.index||e.nextBeat.beat.playbackStart<=e.beat.playbackStart)&&(e.cursorMode=$t.ToEndOfBar)):(e.tickDuration=i.nextMasterBar.end-e.start,e.cursorMode=$t.ToEndOfBar)):(e.tickDuration=i.end-e.start,e.cursorMode=$t.ToEndOfBar):(ee.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain fill-next)"),e.tickDuration=(e.masterBar.end-e.masterBar.start)*(s.length+1),e.cursorMode=$t.ToEndOfBar),e.calculateDuration()}fillNextBeat(e,t){this.isMultiBarRestResult(e)?this.fillNextBeatMultiBarRest(e,t):this.fillNextBeatDefault(e,t)}fillNextBeatDefault(e,t){e.nextBeat=this.findBeatInMasterBar(e.masterBar,e.beatLookup.nextBeat,e.end,t,!0),null==e.nextBeat&&(e.nextBeat=this.findBeatSlow(t,e,e.end,!0)),e.nextBeat?(e.tickDuration=e.nextBeat.start-e.start,e.cursorMode=$t.ToNextBext,e.calculateDuration()):(e.tickDuration=e.masterBar.end-e.start,e.cursorMode=$t.ToEndOfBar,e.calculateDuration()),e.nextBeat&&e.nextBeat.masterBar.masterBar.index!==e.masterBar.masterBar.index+1&&(e.nextBeat.masterBar.masterBar.index!==e.masterBar.masterBar.index||e.nextBeat.beat.playbackStart<=e.beat.playbackStart)&&(e.cursorMode=$t.ToEndOfBar)}isMultiBarRestResult(e){return this.internalIsMultiBarRestResult(e.masterBar.masterBar.index,e.beat)}internalIsMultiBarRestResult(e,t){return this.multiBarRestInfo&&this.multiBarRestInfo.has(e)&&t.isRest&&t.voice.bar.isRestOnly}findBeatSlow(e,t,s,i){let a=null;return null!=t&&(t.masterBar.start<=s&&t.masterBar.end>s?a=t.masterBar:t.masterBar.nextMasterBar&&t.masterBar.nextMasterBar.start<=s&&t.masterBar.nextMasterBar.end>s&&(a=t.masterBar.nextMasterBar)),a||(a=this.findMasterBar(s)),a?this.firstBeatInMasterBar(e,a,s,i):null}firstBeatInMasterBar(e,t,s,i){let a=t;for(;a;){if(a.firstBeat){const t=this.findBeatInMasterBar(a,a.firstBeat,s,e,i);if(t)return t}a=a.nextMasterBar}return null}findBeatInMasterBar(e,t,s,i,a){if(!t)return null;let r=null,n=null;const o=s-e.start;for(;null!=t&&null==n;){if((t.start<=o||a&&o<0)&&o<t.end){if(r=t,n=t.getVisibleBeatAtStart(i),!n)if(a){let s=e;for(;null!=s&&null==n;){for(;null!=t;){if(n=t.getVisibleBeatAtStart(i),n){r=t,e=s;break}t=t.nextBeat}n&&r||(s=s.nextMasterBar,t=s?.firstBeat??null)}}else{let s=e;for(;null!=s&&null==n;){for(;null!=t;){if(n=t.getVisibleBeatAtStart(i),n){r=t,e=s;break}t=t.previousBeat}n&&r||(s=s.previousMasterBar,t=s?.firstBeat??null)}}}else if(t.end>o)break;t=t?.nextBeat??null}if(null==n)return null;return this.createResult(e,r,n,a,i)}createResult(e,t,s,i,a){const r=new an(e);if(r.beat=s,r.beatLookup=t,r.tickDuration=t.end-t.start,i){if(this.isMultiBarRestResult(r)){const s=this.multiBarRestInfo.get(e.masterBar.index);let i=e;for(let e=0;e<s.length&&i;e++)i=i.nextMasterBar;i?i.nextMasterBar?r.tickDuration=i.nextMasterBar.start-t.start:r.tickDuration=i.end-t.start:ee.warning("Synth","MultiBar Rest Info and the nextMasterBar are out of sync, this is an unexpected error. Please report it as bug.  (broken chain stretch-result)")}}else this.fillNextBeat(r,a);return r.calculateDuration(),r}findMasterBar(e){const t=this.masterBars;let s=0,i=t.length-1;for(;s<=i;){const a=(i+s)/2|0,r=t[a];if(e>=r.start&&e<r.end)return r;e<r.start?i=a-1:s=a+1}return null}getMasterBar(e){if(!this.masterBarLookup.has(e.index)){const t=new sn;return t.masterBar=e,t}return this.masterBarLookup.get(e.index)}getMasterBarStart(e){return this.masterBarLookup.has(e.index)?this.masterBarLookup.get(e.index).start:0}getBeatStart(e){return this.masterBarLookup.has(e.voice.bar.index)?this.masterBarLookup.get(e.voice.bar.index).start+e.playbackStart:0}addMasterBar(e){this.masterBars.push(e),this._currentMasterBar&&(e.previousMasterBar=this._currentMasterBar,this._currentMasterBar.nextMasterBar=e),this._currentMasterBar=e,this.masterBarLookup.has(e.masterBar.index)||this.masterBarLookup.set(e.masterBar.index,e)}addBeat(e,t,s){const i=this._currentMasterBar;if(i)if(t<0&&i.previousMasterBar){const a=i.previousMasterBar.end-i.previousMasterBar.start,r=a+t,n=r+s;if(i.previousMasterBar.addBeat(e,r,r,s),n>a){const a=s+t;i.addBeat(e,t,0,a)}}else i.addBeat(e,t,t,s)}}class nn{constructor(){this.noteOnly=0,this.untilTieOrSlideEnd=0,this.letRingEnd=0}}class on{constructor(){this.firstBeatDuration=0,this.secondBeatStartOffset=0,this.secondBeatDuration=0}}class hn{constructor(){this.durations=[],this.brushInfos=[]}}class ln{constructor(){this.synthTick=0,this.synthTime=0,this.currentTempo=0,this.automationToSyncPoint=new Map,this.createNewSyncPoints=!1}}class cn{constructor(e,t,s){this._programsPerChannel=new Map,this._currentTime=0,this._calculatedBeatTimers=new Set,this.tickLookup=new rn,this.applyTranspositionPitches=!0,this.syncPoints=[],this.transpositionPitches=new Map,this._currentTripletFeel=null,this.vibratoResolution=16,this._score=e,this._settings=t||new hr,this._handler=s}generate(){this.transpositionPitches.clear(),this._calculatedBeatTimers.clear(),this._currentTime=0;for(const e of this._score.tracks)this.generateTrack(e);ee.debug("Midi","Begin midi generation"),this.syncPoints=[],cn.playThroughSong(this._score,this.syncPoints,!1,(e,t,s,i,a)=>{this.generateMasterBar(e,t,s,i,a)},(e,t,s)=>{for(const i of this._score.tracks)for(const a of i.staves)e<a.bars.length&&this.generateBar(a.bars[e],t,s)},e=>{for(const t of this._score.tracks)this._handler.finishTrack(t.index,e)}),ee.debug("Midi","Midi generation done")}generateTrack(e){this.generateChannel(e,e.playbackInfo.primaryChannel,e.playbackInfo),e.playbackInfo.primaryChannel!==e.playbackInfo.secondaryChannel&&this.generateChannel(e,e.playbackInfo.secondaryChannel,e.playbackInfo)}addProgramChange(e,t,s,i){this._programsPerChannel.has(s)&&this._programsPerChannel.get(s)===i||(this._handler.addProgramChange(e.index,t,s,i),this._programsPerChannel.set(s,i))}addBankChange(e,t,s,i){const a=H.bankToLsbMsb(i);this._handler.addControlChange(e.index,t,s,Ot.BankSelectCoarse,a[1]),this._handler.addControlChange(e.index,t,s,Ot.BankSelectFine,a[0])}static buildTranspositionPitches(e,t){const s=new Map;for(const i of e.tracks){const e=i.index<t.notation.transpositionPitches.length?t.notation.transpositionPitches[i.index]:-i.staves[0].transpositionPitch;s.set(i.playbackInfo.primaryChannel,e),s.set(i.playbackInfo.secondaryChannel,e)}return s}generateChannel(e,t,s){const i=e.index<this._settings.notation.transpositionPitches.length?this._settings.notation.transpositionPitches[e.index]:-e.staves[0].transpositionPitch;this.transpositionPitches.set(t,i);const a=cn.toChannelShort(s.volume),r=cn.toChannelShort(s.balance);this._handler.addControlChange(e.index,0,t,Ot.VolumeCoarse,a),this._handler.addControlChange(e.index,0,t,Ot.PanCoarse,r),this._handler.addControlChange(e.index,0,t,Ot.ExpressionControllerCoarse,127),this._handler.addControlChange(e.index,0,t,Ot.RegisteredParameterFine,0),this._handler.addControlChange(e.index,0,t,Ot.RegisteredParameterCourse,0),this._handler.addControlChange(e.index,0,t,Ot.DataEntryFine,0),this._handler.addControlChange(e.index,0,t,Ot.DataEntryCoarse,cn.PitchBendRangeInSemitones),this.addBankChange(e,0,t,s.bank),this.addProgramChange(e,0,t,s.program)}static generateSyncPoints(e,t=!1){const s=[];return cn.playThroughSong(e,s,t,(e,t,s,i,a)=>{},(e,t,s)=>{},e=>{}),s}static buildModifiedTempoLookup(e){return cn.playThroughSong(e,[],!1,(e,t,s,i,a)=>{},(e,t,s)=>{},e=>{}).automationToSyncPoint}static playThroughSong(e,t,s,i,a,r){const n=new Qr(e),o=new ln;o.currentTempo=e.tempo,o.syncPoints=t,o.createNewSyncPoints=s;let h=null;const l=new Map;for(;!n.finished;){const t=n.index,s=e.masterBars[t],r=n.currentTick;if(n.processCurrent(),n.shouldPlay){let e=l.has(t)?l.get(t):-1;e++,l.set(t,e),i(s,h,r,o.currentTempo,e);a(t,r,s.tempoAutomations.length>0?s.tempoAutomations[0].value:o.currentTempo),o.synthTick=r,cn.processBarTime(s,e,o)}n.moveNext(),h=s}if(t.length>0){const e=t[t.length-1],s=n.currentTick-e.synthTick;if(s>0){const i=new Si;i.masterBarIndex=h.index,i.masterBarOccurence=l.get(h.index)-1,i.synthTick=n.currentTick,i.synthBpm=o.currentTempo,o.createNewSyncPoints?(i.syncBpm=e.synthBpm,i.synthBpm=e.synthBpm):1===t.length?i.syncBpm=e.synthBpm:i.syncBpm=t[t.length-2].syncBpm,i.synthTime=e.synthTime+J.ticksToMillis(s,e.synthBpm),i.syncTime=e.syncTime+J.ticksToMillis(s,i.syncBpm),o.createNewSyncPoints||e.updateSyncBpm(i.synthTime,i.syncTime),t.push(i)}}return r(n.currentTick),o}static processBarTime(e,t,s){const i=e.calculateDuration(),a=e.syncPoints,r=s.synthTick;s.createNewSyncPoints?cn.processBarTimeWithNewSyncPoints(e,t,s):a?cn.processBarTimeWithSyncPoints(e,t,s):cn.processBarTimeNoSyncPoints(e,s);const n=r+i,o=n-s.synthTick;o>0&&(s.synthTime+=J.ticksToMillis(o,s.currentTempo),s.synthTick=n)}static processBarTimeWithNewSyncPoints(e,t,s){const i=s.synthTick;if(0===e.index&&0===t){s.currentTempo=e.score.tempo;const a=new Si;a.masterBarIndex=e.index,a.masterBarOccurence=t,a.synthTick=i,a.synthBpm=s.currentTempo,a.synthTime=s.synthTime,a.syncBpm=s.currentTempo,a.syncTime=s.synthTime,s.syncPoints.push(a)}const a=e.calculateDuration();for(const r of e.tempoAutomations){const n=i+r.ratioPosition*a,o=n-s.synthTick;if(o>0&&(s.synthTick=n,s.synthTime+=J.ticksToMillis(o,s.currentTempo)),r.value!==s.currentTempo){s.currentTempo=r.value;const i=new Si;i.masterBarIndex=e.index,i.masterBarOccurence=t,i.synthTick=n,i.synthBpm=s.currentTempo,i.synthTime=s.synthTime,i.syncBpm=s.currentTempo,i.syncTime=s.synthTime,s.syncPoints.push(i)}}}static processBarTimeWithSyncPoints(e,t,s){const i=s.synthTick,a=e.calculateDuration();let r,n=0;for(const o of e.syncPoints){if(o.syncPointValue.barOccurence!==t)continue;const h=i+o.ratioPosition*a;for(;n<e.tempoAutomations.length&&e.tempoAutomations[n].ratioPosition<=o.ratioPosition;){const t=e.tempoAutomations[n],o=i+t.ratioPosition*a;r=o-s.synthTick,r>0&&(s.synthTick=o,s.synthTime+=J.ticksToMillis(r,s.currentTempo)),s.currentTempo=t.value,n++}r=h-s.synthTick,r>0&&(s.synthTick=h,s.synthTime+=J.ticksToMillis(r,s.currentTempo)),s.syncPoints.length>0&&s.syncPoints[s.syncPoints.length-1].updateSyncBpm(s.synthTime,o.syncPointValue.millisecondOffset);const l=new Si;l.masterBarIndex=e.index,l.masterBarOccurence=t,l.synthTick=h,l.synthBpm=s.currentTempo,l.synthTime=s.synthTime,l.syncTime=o.syncPointValue.millisecondOffset,l.syncBpm=0,s.syncPoints.push(l),s.automationToSyncPoint.set(o,l)}for(;n<e.tempoAutomations.length;){const t=e.tempoAutomations[n],o=i+t.ratioPosition*a;r=o-s.synthTick,r>0&&(s.synthTick=o,s.synthTime+=J.ticksToMillis(r,s.currentTempo)),s.currentTempo=t.value,n++}}static processBarTimeNoSyncPoints(e,t){const s=t.synthTick,i=e.calculateDuration();for(const a of e.tempoAutomations){const e=s+a.ratioPosition*i,r=e-t.synthTick;r>0&&(t.synthTick=e,t.synthTime+=J.ticksToMillis(r,t.currentTempo)),t.currentTempo=a.value}}static toChannelShort(e){const t=Math.max(-32768,Math.min(32767,8*e-1));return Math.max(t,-1)+1}generateMasterBar(e,t,s,i,a){t&&t.timeSignatureDenominator===e.timeSignatureDenominator&&t.timeSignatureNumerator===e.timeSignatureNumerator||this._handler.addTimeSignature(s,e.timeSignatureNumerator,e.timeSignatureDenominator);const r=e.calculateDuration(),n=new sn;if(e.tempoAutomations.length>0){e.tempoAutomations[0].ratioPosition>0&&n.tempoChanges.push(new tn(s,i));for(const t of e.tempoAutomations){const e=s+r*t.ratioPosition;this._handler.addTempo(e,t.value),n.tempoChanges.push(new tn(e,t.value))}}else t?n.tempoChanges.push(new tn(s,i)):(this._handler.addTempo(s,e.score.tempo),n.tempoChanges.push(new tn(s,e.score.tempo)));n.masterBar=e,n.start=s,n.end=n.start+r,this.tickLookup.addMasterBar(n)}generateBar(e,t,s){const i=this.getPlaybackBar(e),a=this._currentTime;for(const r of i.voices)this._currentTime=a,this.generateVoice(r,t,e,s);const r=i.masterBar,n=r.calculateDuration(),o=r.tempoAutomations.slice();if(0===o.length)this._currentTime=a+J.ticksToMillis(n,s);else{this._currentTime=a;let e=t,i=s;const r=t+n;for(const t of o){const s=n*t.ratioPosition-e;s>0&&(this._currentTime+=J.ticksToMillis(s,i)),i=t.value,e+=s}const h=r-e;h>0&&(this._currentTime+=J.ticksToMillis(h,i))}i.id!==e.id&&this.tickLookup.addBeat(e.voices[0].beats[0],0,n)}getPlaybackBar(e){switch(e.simileMark){case c.Simple:e.previousBar&&(e=this.getPlaybackBar(e.previousBar));break;case c.FirstOfDouble:case c.SecondOfDouble:e.previousBar&&e.previousBar.previousBar&&(e=this.getPlaybackBar(e.previousBar.previousBar))}return e}generateVoice(e,t,s,i){if(e.isEmpty&&(!e.bar.isEmpty||0!==e.index))return;const a=s.masterBar.tempoAutomations.slice();let r=i;const n=s.masterBar.calculateDuration();for(const i of e.beats){const e=i.playbackStart/n;for(;a.length>0&&a[0].ratioPosition<=e;)r=a.shift().value;this.generateBeat(i,t,s,r)}}generateBeat(e,t,s,i){let a=e.playbackStart,r=e.playbackDuration;const n=e.voice.bar.masterBar.calculateDuration();e.voice.bar.isEmpty?r=n:e.voice.bar.masterBar.tripletFeel!==A.NoTripletFeel&&this._settings.player.playTripletFeel&&(this._currentTripletFeel?(a-=this._currentTripletFeel.secondBeatStartOffset,r=this._currentTripletFeel.secondBeatDuration,this._currentTripletFeel=null):(this._currentTripletFeel=cn.calculateTripletFeelInfo(a,r,e),this._currentTripletFeel&&(r=this._currentTripletFeel.firstBeatDuration))),e.showTimer&&!this._calculatedBeatTimers.has(e.id)&&(e.timer=this._currentTime,this._calculatedBeatTimers.add(e.id)),this._currentTime+=J.ticksToMillis(r,i),s===e.voice.bar&&this.tickLookup.addBeat(e,a,r);const o=e.voice.bar.staff.track;for(const s of e.automations)this.generateNonTempoAutomation(e,s,t);if(e.isRest)this._handler.addRest(o.index,t+a,o.playbackInfo.primaryChannel);else if(e.deadSlapped)this.generateDeadSlap(e,t+a);else{const s=this.getBrushInfo(e),n=this.getRasgueadoInfo(e,r);for(const o of e.notes)this.generateNote(o,t+a,r,i,s,n)}if(e.fade!==me.None&&this.generateFade(e,t+a,r),e.vibrato!==M.None){let s=240,i=3;switch(e.vibrato){case M.Slight:s=this._settings.player.vibrato.beatSlightLength,i=this._settings.player.vibrato.beatSlightAmplitude;break;case M.Wide:s=this._settings.player.vibrato.beatWideLength,i=this._settings.player.vibrato.beatWideAmplitude}this.generateVibratorWithParams(t+a,e.playbackDuration,s,0,i,(t,s)=>{this._handler.addBend(e.voice.bar.staff.track.index,t,o.playbackInfo.secondaryChannel,s)})}}static calculateTripletFeelInfo(e,t,s){let i;switch(s.voice.bar.masterBar.tripletFeel){case A.Triplet8th:case A.Dotted8th:case A.Scottish8th:i=k.Eighth;break;case A.Triplet16th:case A.Dotted16th:case A.Scottish16th:i=k.Sixteenth;break;default:return null}const a=J.toTicks(i);if(t!==a)return null;if(e%a!==0)return null;if(!s.nextBeat||s.nextBeat.voice!==s.voice||s.playbackDuration!==a)return null;const r=new on;switch(s.voice.bar.masterBar.tripletFeel){case A.Triplet8th:r.firstBeatDuration=J.applyTuplet(J.toTicks(k.Quarter),3,2),r.secondBeatDuration=J.applyTuplet(J.toTicks(k.Eighth),3,2);break;case A.Dotted8th:r.firstBeatDuration=J.applyDot(J.toTicks(k.Eighth),!1),r.secondBeatDuration=J.toTicks(k.Sixteenth);break;case A.Scottish8th:r.firstBeatDuration=J.toTicks(k.Sixteenth),r.secondBeatDuration=J.applyDot(J.toTicks(k.Eighth),!1);break;case A.Triplet16th:r.firstBeatDuration=J.applyTuplet(J.toTicks(k.Eighth),3,2),r.secondBeatDuration=J.applyTuplet(J.toTicks(k.Sixteenth),3,2);break;case A.Dotted16th:r.firstBeatDuration=J.applyDot(J.toTicks(k.Sixteenth),!1),r.secondBeatDuration=J.toTicks(k.ThirtySecond);break;case A.Scottish16th:r.firstBeatDuration=J.toTicks(k.ThirtySecond),r.secondBeatDuration=J.applyDot(J.toTicks(k.Sixteenth),!1)}return r.secondBeatStartOffset=t-r.firstBeatDuration,r}generateDeadSlap(e,t){const s=J.toTicks(k.SixtyFourth),i=e.voice.bar.staff;if(i.tuning.length>0)for(const e of i.tuning)this._handler.addNote(i.track.index,t,s,e,J.dynamicToVelocity(f.F),i.track.playbackInfo.primaryChannel)}needsSecondaryChannel(e){return e.hasBend||e.beat.hasWhammyBar||e.beat.vibrato!==M.None}determineChannel(e,t){if(this.needsSecondaryChannel(t))return e.playbackInfo.secondaryChannel;let s=t;for(;s.isTieDestination;)if(s=s.tieOrigin,this.needsSecondaryChannel(s))return e.playbackInfo.secondaryChannel;for(s=t;s.isTieOrigin;)if(s=s.tieDestination,this.needsSecondaryChannel(s))return e.playbackInfo.secondaryChannel;return e.playbackInfo.primaryChannel}generateNote(e,t,s,i,a,r){const n=e.beat.voice.bar.staff.track,o=e.beat.voice.bar.staff;let h=e.calculateRealValue(this.applyTranspositionPitches,!0);if(e.isPercussion){const t=Ie.getArticulation(e);t&&(h=t.outputMidiNumber)}const l=null==r&&e.isStringed&&e.string<=a.length?a[e.string-1]:0,c=t+l,d=this.getNoteDuration(e,s,i);d.untilTieOrSlideEnd-=l,d.noteOnly-=l,d.letRingEnd-=l;const u=cn.getNoteVelocity(e),p=this.determineChannel(n,e);let m=0;const g=Math.max(d.untilTieOrSlideEnd,d.letRingEnd);m=e.hasBend?cn.getPitchWheel(e.bendPoints[0].value):e.beat.hasWhammyBar?cn.getPitchWheel(e.beat.whammyBarPoints[0].value):e.isTieDestination||e.slideOrigin&&e.slideOrigin.slideOutType===E.Legato?-1:cn.getPitchWheel(0),m>=0&&this._handler.addNoteBend(n.index,c,p,h,m),e.beat.hasRasgueado?this.generateRasgueado(n,e,c,h,u,p,r):e.ornament===ce.None?!e.isTrill||o.isPercussion?e.beat.isTremolo?this.generateTremoloPicking(e,c,d,h,u,p):(e.hasBend?this.generateBend(e,c,d,h,p,i):e.beat.hasWhammyBar&&0===e.index?this.generateWhammy(e.beat,c,d,p,i):e.slideInType!==v.None||e.slideOutType!==E.None?this.generateSlide(e,c,d,h,p,i):(e.vibrato!==M.None||e.isTieDestination&&e.tieOrigin.vibrato!==M.None)&&this.generateVibrato(e,c,d,h,p),e.isTieDestination||e.slideOrigin&&e.slideOrigin.slideOutType===E.Legato||this._handler.addNote(n.index,c,g,h,u,p)):this.generateTrill(e,c,d,h,u,p):this.generateOrnament(n,e,c,g,h,u,p)}generateOrnament(e,t,s,i,a,r,n){let o,h;const l=a%12,c=1/3;switch(t.ornament){case ce.Turn:o=[a+cn.OrnamentKeysUp[l],a,a+cn.OrnamentKeysDown[l]],h=[J.toTicks(k.Sixteenth)*c,J.toTicks(k.Sixteenth)*c,J.toTicks(k.Sixteenth)*c];break;case ce.InvertedTurn:o=[a+cn.OrnamentKeysDown[l],a,a+cn.OrnamentKeysUp[l]],h=[J.toTicks(k.Sixteenth)*c,J.toTicks(k.Sixteenth)*c,J.toTicks(k.Sixteenth)*c];break;case ce.UpperMordent:o=[a,a+cn.OrnamentKeysUp[l]],h=[J.toTicks(k.ThirtySecond),J.toTicks(k.ThirtySecond)];break;case ce.LowerMordent:o=[a,a+cn.OrnamentKeysDown[l]],h=[J.toTicks(k.ThirtySecond),J.toTicks(k.ThirtySecond)];break;default:return}let d=1;i<J.QuarterTime&&(d=i/J.QuarterTime),r-=J.VelocityIncrement;let u=0;for(let t=0;t<o.length;t++){const i=h[t]*d;this._handler.addNote(e.index,s,i,o[t],r,n),s+=i,u+=i}const p=i-u;this._handler.addNote(e.index,s,p,a,r,n)}getNoteDuration(t,s,i){const a=new nn;if(a.noteOnly=s,a.untilTieOrSlideEnd=s,a.letRingEnd=s,t.isDead)return a.noteOnly=this.applyStaticDuration(cn.DefaultDurationDead,s,i),a.untilTieOrSlideEnd=a.noteOnly,a.letRingEnd=a.noteOnly,a;if(t.isPalmMute)return a.noteOnly=this.applyStaticDuration(cn.DefaultDurationPalmMute,s,i),a.untilTieOrSlideEnd=a.noteOnly,a.letRingEnd=a.noteOnly,a;if(t.isStaccato)return a.noteOnly=s/2|0,a.untilTieOrSlideEnd=a.noteOnly,a.letRingEnd=a.noteOnly,a;if(t.isTieOrigin){const e=t.tieDestination;if(e)if(t.isTieDestination){const t=this.getNoteDuration(e,e.beat.playbackDuration,i);a.untilTieOrSlideEnd=s+t.untilTieOrSlideEnd}else{const s=t.beat.absolutePlaybackStart,r=this.getNoteDuration(e,e.beat.playbackDuration,i),n=e.beat.absolutePlaybackStart+r.untilTieOrSlideEnd;a.untilTieOrSlideEnd=n-s}}else if(t.slideOutType===E.Legato){const e=t.slideTarget;if(e){const s=t.beat.absolutePlaybackStart,r=this.getNoteDuration(e,e.beat.playbackDuration,i),n=e.beat.absolutePlaybackStart+r.untilTieOrSlideEnd;a.untilTieOrSlideEnd=n-s}}if(t.isLetRing&&this._settings.notation.notationMode===e.NotationMode.GuitarPro){let e=t.beat,i=0;const r=t.beat.voice.bar.masterBar.calculateDuration();for(;e.nextBeat;){const s=e.nextBeat;if(s.isRest)break;if(t.isStringed&&s.hasNoteOnString(t.string))break;if(e=e.nextBeat,i=e.absolutePlaybackStart-t.beat.absolutePlaybackStart+e.playbackDuration,i>r){i=r;break}}e===t.beat?a.letRingEnd=s:a.letRingEnd=i}else a.letRingEnd=a.untilTieOrSlideEnd;return a}applyStaticDuration(e,t,s){const i=s*e/j.MaxPosition|0;return Math.min(i,t)}static getNoteVelocity(e){let t=0;switch(!e.beat.voice.bar.staff.isPercussion&&e.hammerPullOrigin&&t--,e.isGhost&&t--,e.accentuated){case _.Normal:t++;break;case _.Heavy:t+=2}return J.dynamicToVelocity(e.dynamics,t)}generateFade(e,t,s){const i=e.voice.bar.staff.track;switch(e.fade){case me.FadeIn:this.generateFadeSteps(i,t,s,0,cn.toChannelShort(i.playbackInfo.volume));break;case me.FadeOut:this.generateFadeSteps(i,t,s,cn.toChannelShort(i.playbackInfo.volume),0);break;case me.VolumeSwell:const e=s/2|0;this.generateFadeSteps(i,t,e,0,cn.toChannelShort(i.playbackInfo.volume)),this.generateFadeSteps(i,t+e,e,cn.toChannelShort(i.playbackInfo.volume),0)}}generateFadeSteps(e,t,s,i,a){const r=(a-i)/(s=.8*s|0),n=s/120+1|0,o=t+s;for(let s=0;s<n;s++){const h=s===n-1,l=h?o:t+120*s,c=h?a:Math.round(i+(l-t)*r);this._handler.addControlChange(e.index,l,e.playbackInfo.primaryChannel,Ot.VolumeCoarse,c),this._handler.addControlChange(e.index,l,e.playbackInfo.secondaryChannel,Ot.VolumeCoarse,c)}}generateVibrato(e,t,s,i,a){let r=0,n=0;switch(e.vibrato!==M.None?e.vibrato:e.isTieDestination?e.tieOrigin.vibrato:M.Slight){case M.Slight:r=this._settings.player.vibrato.noteSlightLength,n=this._settings.player.vibrato.noteSlightAmplitude;break;case M.Wide:r=this._settings.player.vibrato.noteWideLength,n=this._settings.player.vibrato.noteWideAmplitude;break;default:return}const o=e.beat.voice.bar.staff.track;let h=0;if(e.isTieDestination&&e.tieOrigin.hasBend){const t=e.tieOrigin.bendPoints;h=t[t.length-1].value}this.generateVibratorWithParams(t,s.noteOnly,r,h,n,(e,t)=>{this._handler.addNoteBend(o.index,e,a,i,t)})}generateVibratorWithParams(e,t,s,i,a,r){const n=this.vibratoResolution,o=s/2|0,h=e+t;for(;e<h;){let t=0;const l=e+s<h?s:h-e;for(;t<l;){const s=i+a*Math.sin(t*Math.PI/o);r(e+t|0,cn.getPitchWheel(s)),t+=n}e+=s}r(0|h,cn.getPitchWheel(i))}static getPitchWheel(e){return se.DefaultPitchWheel+e/2*cn.PitchValuePerSemitone}generateSlide(e,t,s,i,a,r){const n=e.slideOutType===E.Legato?s.noteOnly:s.untilTieOrSlideEnd,o=[],h=e.beat.voice.bar.staff.track,l=this._settings.player.slide.simpleSlidePitchOffset,c=Math.floor(j.MaxPosition*this._settings.player.slide.simpleSlideDurationRatio),d=Math.floor(j.MaxPosition*this._settings.player.slide.shiftSlideDurationRatio);switch(e.slideInType){case v.IntoFromAbove:o.push(new j(0,l)),o.push(new j(c,0));break;case v.IntoFromBelow:o.push(new j(0,-l)),o.push(new j(c,0))}switch(e.slideOutType){case E.Legato:case E.Shift:o.push(new j(d,0));const t=2*(e.slideTarget.calculateRealValue(this.applyTranspositionPitches,!0)-e.calculateRealValue(this.applyTranspositionPitches,!0));o.push(new j(j.MaxPosition,t));break;case E.OutDown:o.push(new j(j.MaxPosition-c,0)),o.push(new j(j.MaxPosition,-l));break;case E.OutUp:o.push(new j(j.MaxPosition-c,0)),o.push(new j(j.MaxPosition,l))}this.generateWhammyOrBend(t,n,o,r,(e,t)=>{this._handler.addNoteBend(h.index,e,a,i,t)})}generateBend(e,t,s,i,a,r){const n=e.bendPoints,o=e.beat.voice.bar.staff.track,h=(e,t)=>{this._handler.addNoteBend(o.index,e,a,i,t)};let l,c=null;if(e.isTieOrigin&&this._settings.notation.extendBendArrowsOnTiedNotes){let t=e;for(;t.isTieOrigin&&!t.tieDestination.hasBend&&t.tieDestination.vibrato===M.None;)t=t.tieDestination;l=t.beat.absolutePlaybackStart-e.beat.absolutePlaybackStart+this.getNoteDuration(t,t.beat.playbackDuration,r).noteOnly}else if(e.isTieOrigin&&e.beat.graceType!==T.None){switch(e.tieDestination.bendType){case S.Bend:case S.BendRelease:case S.PrebendBend:c=e.tieDestination.bendPoints[1].value;break;case S.Prebend:case S.PrebendRelease:c=e.tieDestination.bendPoints[0].value}l=Math.max(s.noteOnly,J.millisToTicks(this._settings.player.songBookBendDuration,r))}else l=s.noteOnly;n[0].value>0&&!e.isContinuedBend&&t>0&&t--;const d=Math.min(l,J.millisToTicks(this._settings.player.songBookBendDuration,r));let u=[];switch(e.bendType){case S.Custom:u=n;break;case S.Bend:case S.Release:switch(e.bendStyle){case b.Default:u=n;break;case b.Gradual:u.push(new j(0,e.bendPoints[0].value)),(!c||c<e.bendPoints[1].value)&&(c=e.bendPoints[1].value),u.push(new j(j.MaxPosition,c));break;case b.Fast:return(!c||c<e.bendPoints[1].value)&&(c=e.bendPoints[1].value),void(e.beat.graceType===T.BendGrace?this.generateSongBookWhammyOrBend(t,l,!0,[e.bendPoints[0].value,c],d,r,h):this.generateSongBookWhammyOrBend(t,l,!1,[e.bendPoints[0].value,c],d,r,h))}break;case S.BendRelease:switch(e.bendStyle){case b.Default:u=n;break;case b.Gradual:u.push(new j(0,e.bendPoints[0].value)),u.push(new j(j.MaxPosition/2|0,e.bendPoints[1].value)),u.push(new j(j.MaxPosition,e.bendPoints[2].value));break;case b.Fast:return void this.generateSongBookWhammyOrBend(t,l,!1,[e.bendPoints[0].value,e.bendPoints[1].value,e.bendPoints[2].value],d,r,h)}break;case S.Hold:case S.Prebend:u=n;break;case S.PrebendBend:switch(e.bendStyle){case b.Default:u=n;break;case b.Gradual:u.push(new j(0,e.bendPoints[0].value)),u.push(new j(j.MaxPosition,e.bendPoints[1].value));break;case b.Fast:return h(t,0|cn.getPitchWheel(e.bendPoints[0].value)),(!c||c<e.bendPoints[1].value)&&(c=e.bendPoints[1].value),void this.generateSongBookWhammyOrBend(t,l,!1,[e.bendPoints[0].value,c],d,r,h)}break;case S.PrebendRelease:switch(e.bendStyle){case b.Default:u=n;break;case b.Gradual:u.push(new j(0,e.bendPoints[0].value)),u.push(new j(j.MaxPosition,e.bendPoints[1].value));break;case b.Fast:return h(t,0|cn.getPitchWheel(e.bendPoints[0].value)),void this.generateSongBookWhammyOrBend(t,l,!1,[e.bendPoints[0].value,e.bendPoints[1].value],d,r,h)}}this.generateWhammyOrBend(t,l,u,r,h)}generateSongBookWhammyOrBend(e,t,s,i,a,r,n){const o=s?e:e+t-a,h=a/(i.length-1);for(let e=0;e<i.length-1;e++){const t=cn.getPitchWheel(i[e]),s=cn.getPitchWheel(i[e+1]),a=o+h*e;this.generateBendValues(a,h,t,s,r,n)}}generateWhammy(e,t,s,i,a){const r=e.whammyBarPoints,n=e.voice.bar.staff.track,o=s.noteOnly;r[0].value>0&&!e.isContinuedWhammy&&t--;const h=(e,t)=>{this._handler.addBend(n.index,e,i,t)};let l=[];switch(e.whammyBarType){case ue.Custom:l=r;break;case ue.Dive:switch(e.whammyStyle){case b.Default:l=r;break;case b.Gradual:l.push(new j(0,r[0].value)),l.push(new j(j.MaxPosition,r[1].value));break;case b.Fast:const e=Math.min(o,J.millisToTicks(this._settings.player.songBookBendDuration,a));return void this.generateSongBookWhammyOrBend(t,o,!1,[r[0].value,r[1].value],e,a,h)}break;case ue.Dip:switch(e.whammyStyle){case b.Default:l=r;break;case b.Gradual:l.push(new j(0,r[0].value)),l.push(new j(j.MaxPosition/2|0,r[1].value)),l.push(new j(j.MaxPosition,r[2].value));break;case b.Fast:const e=Math.min(o,J.millisToTicks(this._settings.player.songBookDipDuration,a));return void this.generateSongBookWhammyOrBend(t,o,!0,[r[0].value,r[1].value,r[2].value],e,a,h)}break;case ue.Hold:case ue.Predive:l=r;break;case ue.PrediveDive:switch(e.whammyStyle){case b.Default:l=r;break;case b.Gradual:l.push(new j(0,r[0].value)),l.push(new j(j.MaxPosition/2|0,r[0].value)),l.push(new j(j.MaxPosition,r[1].value));break;case b.Fast:const e=cn.getPitchWheel(r[0].value);this._handler.addBend(n.index,t,i,0|e);const s=Math.min(o,J.millisToTicks(this._settings.player.songBookBendDuration,a));return void this.generateSongBookWhammyOrBend(t,o,!1,[r[0].value,r[1].value],s,a,h)}}this.generateWhammyOrBend(t,o,l,a,h)}generateWhammyOrBend(e,t,s,i,a){const r=t/j.MaxPosition;for(let t=0;t<s.length-1;t++){const n=s[t],o=s[t+1],h=cn.getPitchWheel(n.value),l=cn.getPitchWheel(o.value),c=r*(o.offset-n.offset),d=e+r*n.offset;this.generateBendValues(d,c,h,l,i,a)}}generateBendValues(e,t,s,i,a,r){const n=J.ticksToMillis(t,a),o=Math.abs(i-s)/cn.PitchValuePerSemitone,h=Math.max(cn.MinBreakpointsPerSemitone*o,n/cn.MillisecondsPerBreakpoint),l=t/h,c=(i-s)/h,d=e+t;for(let t=0;t<h;t++)r(0|e,Math.round(s)),s+=c,e+=l;r(0|d,i)}generateRasgueado(e,t,s,i,a,r,n){let o=s;for(let s=0;s<n.durations.length;s++){const h=n.brushInfos[s],l=t.isStringed&&t.string<=h.length?h[t.string-1]:0,c=n.durations[s];this._handler.addNote(e.index,o+l,c-l,i,a,r),o+=c}}generateTrill(e,t,s,i,a,r){const n=e.beat.voice.bar.staff.track,o=e.stringTuning+e.trillFret;let h=J.toTicks(e.trillSpeed),l=!0,c=t;const d=t+s.untilTieOrSlideEnd;for(;c+10<d;)c+h>=d&&(h=d-c),this._handler.addNote(n.index,c,h,l?o:i,a,r),l=!l,c+=h}generateTremoloPicking(e,t,s,i,a,r){const n=e.beat.voice.bar.staff.track;let o=J.toTicks(e.beat.tremoloSpeed),h=t;const l=t+s.untilTieOrSlideEnd;for(;h+10<l;)h+o>=l&&(o=l-h),this._handler.addNote(n.index,h,o,i,a,r),h+=o}getRasgueadoInfo(e,t){if(!e.hasRasgueado)return null;const s=new hn,i=cn.RasgueadoDurations.get(e.rasgueado).reduce((e,t)=>e+t,0);s.durations=cn.RasgueadoDurations.get(e.rasgueado).map(e=>t*e/i),s.brushInfos=new Array(s.durations.length);const a=J.toTicks(k.Sixteenth);let r=0,n=0;for(const t of e.notes)t.isTieDestination||(r|=1<<t.string-1,n++);const o=cn.RasgueadoDirections.get(e.rasgueado);for(let t=0;t<s.durations.length;t++){const i=s.durations[t]*a/J.QuarterTime,h=new Int32Array(e.voice.bar.staff.tuning.length);s.brushInfos[t]=h;const l=o[t];l!==w.None&&this.fillBrushInfo(e,h,l===w.ArpeggioDown||l===w.BrushDown,r,n,i)}return s}getBrushInfo(e){const t=new Int32Array(e.voice.bar.staff.tuning.length);if(e.brushType){let s=0,i=0;for(const t of e.notes)t.isTieDestination||(s|=1<<t.string-1,i++);this.fillBrushInfo(e,t,e.brushType===w.ArpeggioDown||e.brushType===w.BrushDown,s,i,e.brushDuration)}return t}fillBrushInfo(e,t,s,i,a,r){if(e.notes.length>0){let n=0;const o=r/(a-1)|0;for(let a=0;a<e.voice.bar.staff.tuning.length;a++){const e=s?a:t.length-1-a;i&1<<e&&(t[e]=n,n+=o)}}return t}generateNonTempoAutomation(e,t,s){switch(t.type){case y.Instrument:this.addProgramChange(e.voice.bar.staff.track,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,255&t.value),this.addProgramChange(e.voice.bar.staff.track,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,255&t.value);break;case y.Bank:this.addBankChange(e.voice.bar.staff.track,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,t.value),this.addBankChange(e.voice.bar.staff.track,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,t.value);break;case y.Balance:const i=cn.toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,Ot.PanCoarse,i),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,Ot.PanCoarse,i);break;case y.Volume:const a=cn.toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.primaryChannel,Ot.VolumeCoarse,a),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+s,e.voice.bar.staff.track.playbackInfo.secondaryChannel,Ot.VolumeCoarse,a)}}prepareSingleBeat(e){let t=-1,s=-1,i=e;for(;i&&(-1===t||-1===s);){for(const i of e.automations)switch(i.type){case y.Instrument:s=i.value;break;case y.Tempo:t=i.value}i=i.previousBeat}const a=e.voice.bar.staff.track,r=e.voice.bar.masterBar;-1===t&&(t=r.score.tempo);const n=e.playbackStart/r.calculateDuration();for(const e of r.tempoAutomations){if(!(e.ratioPosition<=n))break;t=e.value}-1===s&&(s=a.playbackInfo.program);const o=a.playbackInfo.volume;this.generateTrack(a),this._handler.addTimeSignature(0,r.timeSignatureNumerator,r.timeSignatureDenominator),this._handler.addTempo(0,t);const h=cn.toChannelShort(o);return this._handler.addControlChange(0,0,a.playbackInfo.primaryChannel,Ot.VolumeCoarse,h),this._handler.addControlChange(0,0,a.playbackInfo.secondaryChannel,Ot.VolumeCoarse,h),t}generateSingleBeat(e){const t=this.prepareSingleBeat(e);this.generateBeat(e,-e.playbackStart,e.voice.bar,t)}generateSingleNote(e){const t=this.prepareSingleBeat(e.beat);this.generateNote(e,0,e.beat.playbackDuration,t,new Int32Array(e.beat.voice.bar.staff.tuning.length),null)}}cn.DefaultDurationDead=30,cn.DefaultDurationPalmMute=80,cn.OrnamentKeysUp=[2,2,2,1,1,2,2,2,2,2,1,1],cn.OrnamentKeysDown=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],cn.PitchBendRangeInSemitones=16,cn.PitchValuePerSemitone=se.DefaultPitchWheel/cn.PitchBendRangeInSemitones,cn.MinBreakpointsPerSemitone=6,cn.MillisecondsPerBreakpoint=150,cn.RasgueadoDirections=new Map([[ye.Ii,[w.BrushDown,w.BrushUp]],[ye.Mi,[w.BrushDown,w.BrushDown]],[ye.MiiTriplet,[w.BrushDown,w.BrushDown,w.BrushUp]],[ye.MiiAnapaest,[w.BrushDown,w.BrushDown,w.BrushUp]],[ye.PmpTriplet,[w.BrushUp,w.BrushDown,w.BrushDown]],[ye.PmpAnapaest,[w.BrushUp,w.BrushDown,w.BrushDown]],[ye.PeiTriplet,[w.BrushUp,w.BrushDown,w.BrushDown]],[ye.PeiAnapaest,[w.BrushUp,w.BrushDown,w.BrushDown]],[ye.PaiTriplet,[w.BrushUp,w.BrushDown,w.BrushDown]],[ye.PaiAnapaest,[w.BrushUp,w.BrushDown,w.BrushDown]],[ye.AmiTriplet,[w.BrushDown,w.BrushDown,w.BrushDown]],[ye.AmiAnapaest,[w.BrushDown,w.BrushDown,w.BrushDown]],[ye.Ppp,[w.None,w.BrushDown,w.BrushUp]],[ye.Amii,[w.BrushDown,w.BrushDown,w.BrushDown,w.BrushUp]],[ye.Amip,[w.BrushDown,w.BrushDown,w.BrushDown,w.BrushUp]],[ye.Eami,[w.BrushDown,w.BrushDown,w.BrushDown,w.BrushDown]],[ye.Eamii,[w.BrushDown,w.BrushDown,w.BrushDown,w.BrushDown,w.BrushUp]],[ye.Peami,[w.BrushDown,w.BrushDown,w.BrushDown,w.BrushDown,w.BrushUp]]]),cn.RasgueadoDurations=new Map([[ye.Ii,[J.toTicks(k.Eighth),J.toTicks(k.Eighth)]],[ye.Mi,[J.toTicks(k.Eighth),J.toTicks(k.Eighth)]],[ye.MiiTriplet,[J.toTicks(k.Eighth)/3,J.toTicks(k.Eighth)/3,J.toTicks(k.Eighth)/3]],[ye.MiiAnapaest,[J.toTicks(k.Sixteenth),J.toTicks(k.Sixteenth),J.toTicks(k.Eighth)]],[ye.PmpTriplet,[J.toTicks(k.Eighth)/3,J.toTicks(k.Eighth)/3,J.toTicks(k.Eighth)/3]],[ye.PmpAnapaest,[J.toTicks(k.Sixteenth)/3,J.toTicks(k.Sixteenth)/3,J.toTicks(k.Eighth)/3]],[ye.PeiTriplet,[J.toTicks(k.Eighth)/3,J.toTicks(k.Eighth)/3,J.toTicks(k.Eighth)/3]],[ye.PeiAnapaest,[J.toTicks(k.Sixteenth),J.toTicks(k.Sixteenth),J.toTicks(k.Eighth)]],[ye.PaiTriplet,[J.toTicks(k.Eighth)/3,J.toTicks(k.Eighth)/3,J.toTicks(k.Eighth)/3]],[ye.PaiAnapaest,[J.toTicks(k.Sixteenth),J.toTicks(k.Sixteenth),J.toTicks(k.Eighth)]],[ye.AmiTriplet,[J.toTicks(k.Eighth)/3,J.toTicks(k.Eighth)/3,J.toTicks(k.Eighth)/3]],[ye.AmiAnapaest,[J.toTicks(k.Sixteenth)/3,J.toTicks(k.Sixteenth)/3,J.toTicks(k.Eighth)/3]],[ye.Ppp,[J.toTicks(k.Sixteenth)/3,J.toTicks(k.Sixteenth)/3,J.toTicks(k.Eighth)/3]],[ye.Amii,[J.toTicks(k.Sixteenth)/3,J.toTicks(k.Sixteenth)/3,J.toTicks(k.Sixteenth)/3,J.toTicks(k.Eighth)]],[ye.Amip,[J.toTicks(k.Sixteenth)/3,J.toTicks(k.Sixteenth)/3,J.toTicks(k.Sixteenth)/3,J.toTicks(k.Eighth)]],[ye.Eami,[J.toTicks(k.Sixteenth),J.toTicks(k.Sixteenth),J.toTicks(k.Sixteenth),J.toTicks(k.Sixteenth)]],[ye.Eamii,[J.toTicks(k.Sixteenth)/5,J.toTicks(k.Sixteenth)/5,J.toTicks(k.Sixteenth)/5,J.toTicks(k.Sixteenth)/5,J.toTicks(k.Sixteenth)/5]],[ye.Peami,[J.toTicks(k.Sixteenth)/5,J.toTicks(k.Sixteenth)/5,J.toTicks(k.Sixteenth)/5,J.toTicks(k.Sixteenth)/5,J.toTicks(k.Sixteenth)/5]]]);class dn{constructor(){this.startTick=0,this.endTick=0}}class un{constructor(e,t){this.width=0,this.height=0,this.x=e,this.y=t}getBoundingBoxTop(){return this.y}doLayout(){}paint(e,t,s){}}class pn extends un{constructor(e=0,t=0){super(e,t),this.beat=null,this.nextGlyph=null,this.previousGlyph=null}}class mn extends pn{constructor(e,t,s,i){super(e,t),this.glyphScale=0,this.center=!1,this.offsetX=0,this.offsetY=0,this.glyphScale=s,this.symbol=i}getBoundingBoxTop(){const e=this.renderer.smuflMetrics.glyphTop.get(this.symbol);return this.y-this.offsetY-e}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(this.symbol)*this.glyphScale,this.height=this.renderer.smuflMetrics.glyphHeights.get(this.symbol)*this.glyphScale}paint(e,t,s){if(0===this.width&&0===this.height)return;const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbol(e+this.x+this.offsetX,t+this.y+this.offsetY,this.glyphScale,this.symbol,this.center),s.color=i}}class gn extends pn{constructor(e,t,s,i){super(e,t),this.glyphScale=0,this.center=!1,this.offsetX=0,this.offsetY=0,this.glyphScale=s,this.symbols=i}getBoundingBoxTop(){let e=0;for(let t=0;t<this.symbols.length;t++){const s=this.renderer.smuflMetrics.glyphTop.get(this.symbols[t]);(0===t||s<e)&&(e=s)}return this.y-this.offsetY-e}doLayout(){this.width=0,this.height=0;for(let e=0;e<this.symbols.length;e++){const t=this.renderer.smuflMetrics.glyphWidths.get(this.symbols[e])*this.glyphScale,s=this.renderer.smuflMetrics.glyphHeights.get(this.symbols[e])*this.glyphScale;(0===e||t>this.width)&&(this.width=t),(0===e||s>this.height)&&(this.height=s)}}paint(e,t,s){if(0===this.width&&0===this.height)return;const i=s.color;this.colorOverride&&(s.color=this.colorOverride),s.fillMusicFontSymbols(e+this.x+this.offsetX,t+this.y+this.offsetY,this.glyphScale,this.symbols,this.center),s.color=i}}class fn extends mn{constructor(e,t,s,i){super(e,t,i?fn.GraceScale:1,fn.getSymbol(s)),this.centerOnStem=!1}paint(e,t,s){this.centerOnStem&&(this.center=!0),super.paint(e,t,s)}static getSymbol(e){switch(e){case k.QuadrupleWhole:return ne.NoteheadDoubleWholeSquare;case k.DoubleWhole:return ne.NoteheadDoubleWhole;case k.Whole:return ne.NoteheadWhole;case k.Half:return ne.NoteheadHalf;default:return ne.NoteheadBlack}}}fn.GraceScale=.75;class yn extends mn{constructor(e,t,s,i,a){super(e,t,a?fn.GraceScale:1,yn.getSymbol(s,i,a))}static getSymbol(e,t,s){if(s&&(e=k.Eighth),t===Pe.Up)switch(e){case k.Eighth:return ne.Flag8thUp;case k.Sixteenth:return ne.Flag16thUp;case k.ThirtySecond:return ne.Flag32ndUp;case k.SixtyFourth:return ne.Flag64thUp;case k.OneHundredTwentyEighth:return ne.Flag128thUp;case k.TwoHundredFiftySixth:return ne.Flag256thUp;default:return ne.Flag8thUp}switch(e){case k.Eighth:return ne.Flag8thDown;case k.Sixteenth:return ne.Flag16thDown;case k.ThirtySecond:return ne.Flag32ndDown;case k.SixtyFourth:return ne.Flag64thDown;case k.OneHundredTwentyEighth:case k.TwoHundredFiftySixth:return ne.Flag128thDown;default:return ne.Flag8thDown}}}class bn extends un{get onTimeX(){return this.onNotes.x+this.onNotes.centerX}constructor(e,t){super(0,0),this.ties=[],this.minWidth=0,this.beat=e,this.ties=[],this.voiceContainer=t}addTie(e){e.renderer=this.renderer,this.ties.push(e)}drawBeamHelperAsFlags(e){return e.hasFlag(!1,void 0)}registerLayoutingInfo(e){const t=this.preNotes.computedWidth+this.onNotes.centerX;let s=this.onNotes.computedWidth-this.onNotes.centerX;const i=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(this.beat.graceType!==T.None||i&&this.drawBeamHelperAsFlags(i))&&(s+=this.renderer.smuflMetrics.glyphWidths.get(ne.Flag8thUp)*fn.GraceScale);for(const e of this.ties)s+=e.width;e.addBeatSpring(this.beat,t,s)}applyLayoutingInfo(e){this.onNotes.updateBeamingHelper(),this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,this.preNotes.container=this,this.preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,this.onNotes.container=this,this.onNotes.doLayout(),this.onNotes.updateBeamingHelper();let e=this.beat.notes.length-1;for(;e>=0;)this.createTies(this.beat.notes[e--]);this.renderer.registerTies(this.ties),this.updateWidth()}updateWidth(){if(this.minWidth=this.preNotes.width+this.onNotes.width,!this.beat.isRest&&1===this.onNotes.beamingHelper.beats.length&&this.beat.duration>=k.Eighth){const e=yn.getSymbol(this.beat.duration,this.onNotes.beamingHelper.direction,this.beat.graceType!==T.None);this.minWidth+=this.renderer.smuflMetrics.glyphWidths.get(e)}let e=0;for(const t of this.ties)t.width>e&&(e=t.width);this.minWidth+=e,this.width=this.minWidth}scaleToWidth(e){this.onNotes.updateBeamingHelper(),this.width=e}createTies(e){}static getGroupId(e){return`b${e.id}`}paint(e,t,s){if(this.preNotes.isEmpty&&this.onNotes.isEmpty&&0===this.ties.length)return;s.beginGroup(bn.getGroupId(this.beat)),this.preNotes.paint(e+this.x,t+this.y,s),this.onNotes.paint(e+this.x,t+this.y,s);const i=e-this.voiceContainer.x-this.renderer.x,a=t-this.voiceContainer.y-this.renderer.y;for(let e=0,t=this.ties.length;e<t;e++){const t=this.ties[e];t.renderer=this.renderer,t.paint(i,a,s)}s.endGroup()}buildBoundingsLookup(e,t,s,i){const a=new Vr;if(a.beat=this.beat,this.beat.isEmpty)a.visualBounds=new Ts,a.visualBounds.x=t+this.x,a.visualBounds.y=e.visualBounds.y,a.visualBounds.w=this.width,a.visualBounds.h=e.visualBounds.h,a.realBounds=new Ts,a.realBounds.x=t+this.x,a.realBounds.y=e.realBounds.y,a.realBounds.w=this.width,a.realBounds.h=e.realBounds.h,a.onNotesX=t+this.x+this.onNotes.centerX;else{a.visualBounds=new Ts,a.visualBounds.x=t+this.x,this.preNotes.isEmpty?this.onNotes.isEmpty?a.visualBounds.x=t+this.x:a.visualBounds.x=t+this.x+this.onNotes.x:a.visualBounds.x=t+this.x+this.preNotes.x;let s=0;s=this.onNotes.isEmpty?this.preNotes.isEmpty?t+this.x+this.width:t+this.x+this.preNotes.x+this.preNotes.width:t+this.x+this.onNotes.x+this.onNotes.width,a.visualBounds.w=s-a.visualBounds.x;const i=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(i&&this.drawBeamHelperAsFlags(i)||this.beat.graceType!==T.None)&&(a.visualBounds.w+=this.renderer.smuflMetrics.glyphWidths.get(ne.Flag8thUp)*(this.beat.graceType!==T.None?fn.GraceScale:1)),a.visualBounds.y=e.visualBounds.y,a.visualBounds.h=e.visualBounds.h,a.realBounds=new Ts,a.realBounds.x=t+this.x,a.realBounds.y=e.realBounds.y,a.realBounds.w=this.width,a.realBounds.h=e.realBounds.h,a.onNotesX=t+this.x+this.onNotes.x+this.onNotes.centerX}e.addBeat(a),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(a,t+this.x,s+this.y)}}class Sn{constructor(){this.oldWidth=0,this.newWidth=0,this.settings=null}core(){return this.settings&&this.causeIssue()?this.settings.core:new Vc}causeIssue(){return this.settings=null,!0}}class wn{constructor(e){this.activeBeats=e}}class Bn{constructor(){this._midiEventQueue=new Pa,this.masterVolume=1,this.metronomeVolume=0,this.outSampleRate=44100,this.currentTempo=120,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.activeVoiceCount=0}noteOffAll(e){}resetSoft(){}resetPresets(){}loadPresets(e,t,s,i){}setupMetronomeChannel(e){}synthesizeSilent(e){this.fakeSynthesize()}processMidiMessage(e){}dispatchEvent(e){this._midiEventQueue.enqueue(e)}synthesize(e,t,s){return this.fakeSynthesize()}fakeSynthesize(){const e=[];for(;!this._midiEventQueue.isEmpty;){const t=this._midiEventQueue.dequeue();t.isMetronome&&this.metronomeVolume>0||t.event&&this.processMidiMessage(t.event),e.push(t)}return e}applyTranspositionPitches(e){}setChannelTranspositionPitch(e,t){}channelSetMute(e,t){}channelSetSolo(e,t){}resetChannelStates(){}channelSetMixVolume(e,t){}hasSamplesForProgram(e){return!0}hasSamplesForPercussion(e){return!0}}class kn extends Da{constructor(e,t){super(e,new Bn,t),this.synthesizer.output=e,this._backingTrackOutput=e,e.timeUpdate.on(t=>{const s=this.sequencer.mainTimePositionFromBackingTrack(t,e.backingTrackDuration);this.sequencer.fillMidiEventQueueToEndTime(s),this.synthesizer.fakeSynthesize(),this.updateTimePosition(s,!1),this.checkForFinish()})}updateMasterVolume(e){super.updateMasterVolume(e),this._backingTrackOutput.masterVolume=e}updatePlaybackSpeed(e){super.updatePlaybackSpeed(e),this._backingTrackOutput.playbackRate=e}onSampleRequest(){}loadMidiFile(e){this.isSoundFontLoaded||(this.isSoundFontLoaded=!0,this.soundFontLoaded.trigger()),super.loadMidiFile(e)}updateTimePosition(e,t){super.updateTimePosition(e,t),t&&this._backingTrackOutput.seekTo(this.sequencer.mainTimePositionToBackingTrack(e,this._backingTrackOutput.backingTrackDuration))}loadBackingTrack(e){const t=e.backingTrack;t&&(this._backingTrackOutput.loadBackingTrack(t),this.timePosition=0)}updateSyncPoints(e){this.sequencer.mainUpdateSyncPoints(e),this.tickPosition=this.tickPosition}}class Tn{constructor(){this.sampleRate=44100,this._seekPosition=0,this.ready=new $s,this.samplesPlayed=new qs,this.timeUpdate=new qs,this.sampleRequest=new $s}get handler(){return this._handler}set handler(e){e&&0!==this._seekPosition&&(e.seekTo(this._seekPosition),this._seekPosition=0),this._handler=e}get backingTrackDuration(){return this.handler?.backingTrackDuration??0}get playbackRate(){return this.handler?.playbackRate??1}set playbackRate(e){const t=this.handler;t&&(t.playbackRate=e)}get masterVolume(){return this.handler?.masterVolume??1}set masterVolume(e){const t=this.handler;t&&(t.masterVolume=e)}seekTo(e){const t=this.handler;t?t.seekTo(e):this._seekPosition=e}loadBackingTrack(e){}open(e){this.ready.trigger()}updatePosition(e){this.timeUpdate.trigger(e)}play(){this.handler?.play()}destroy(){}pause(){this.handler?.pause()}addSamples(e){}resetSamples(){}activate(){}async enumerateOutputDevices(){return[]}async setOutputDevice(e){}async getOutputDevice(){return null}}class _n extends kn{get handler(){return this.output.handler}set handler(e){this.output.handler=e}constructor(e){super(new Tn,e)}}class xn{constructor(){this._masterVolume=1,this._metronomeVolume=0,this._countInVolume=0,this._playbackSpeed=1,this._isLooping=!1,this._midiEventsPlayedFilter=[],this.finished=new $s,this.soundFontLoaded=new $s,this.soundFontLoadFailed=new qs,this.midiLoadFailed=new qs,this.midiEventsPlayed=new qs,this.ready=new $s(()=>this.isReady),this.readyForPlayback=new $s(()=>this.isReadyForPlayback),this.midiLoaded=new qs(()=>this._instance?.loadedMidiInfo??null),this.stateChanged=new qs(()=>new Ti(this.state,!1)),this.positionChanged=new qs(()=>this.currentPosition),this.playbackRangeChanged=new qs(()=>{const e=this.playbackRange;return e?new Ma(e):null})}get instance(){return this._instance}set instance(e){this._instance=e;const t=this._instanceEventUnregister;if(t)for(const e of t)e();if(e){const t=[];t.push(e.ready.on(()=>this.ready.trigger())),t.push(e.readyForPlayback.on(()=>this.readyForPlayback.trigger())),t.push(e.finished.on(()=>this.finished.trigger())),t.push(e.soundFontLoaded.on(()=>this.soundFontLoaded.trigger())),t.push(e.soundFontLoadFailed.on(e=>this.soundFontLoadFailed.trigger(e))),t.push(e.midiLoaded.on(e=>{this.midiLoaded.trigger(e)})),t.push(e.midiLoadFailed.on(e=>this.midiLoadFailed.trigger(e))),t.push(e.stateChanged.on(e=>this.stateChanged.trigger(e))),t.push(e.positionChanged.on(e=>{this.positionChanged.trigger(e)})),t.push(e.midiEventsPlayed.on(e=>this.midiEventsPlayed.trigger(e))),t.push(e.playbackRangeChanged.on(e=>this.playbackRangeChanged.trigger(e))),this._instanceEventUnregister=t,this.isReady?(e.masterVolume=this._masterVolume,e.metronomeVolume=this._metronomeVolume,e.countInVolume=this._countInVolume,e.playbackSpeed=this._playbackSpeed,e.isLooping=this._isLooping,e.midiEventsPlayedFilter=this._midiEventsPlayedFilter,this.ready.trigger()):t.push(e.ready.on(()=>{e.masterVolume=this._masterVolume,e.metronomeVolume=this._metronomeVolume,e.countInVolume=this._countInVolume,e.playbackSpeed=this._playbackSpeed,e.isLooping=this._isLooping,e.midiEventsPlayedFilter=this._midiEventsPlayedFilter}))}else this._instanceEventUnregister=void 0}get output(){return this._instance.output}get isReady(){return!!this._instance&&this._instance.isReady}get isReadyForPlayback(){return!!this._instance&&this._instance.isReadyForPlayback}get state(){return this._instance?this._instance.state:Ft.Paused}get logLevel(){return ee.logLevel}set logLevel(e){ee.logLevel=e,this._instance&&(this._instance.logLevel=e)}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Math.max(e,se.MinVolume),this._masterVolume=e,this._instance&&(this._instance.masterVolume=e)}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,se.MinVolume),this._metronomeVolume=e,this._instance&&(this._instance.metronomeVolume=e)}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){this._playbackSpeed=e,this._instance&&(this._instance.playbackSpeed=e)}get loadedMidiInfo(){return this._instance?this._instance.loadedMidiInfo:void 0}get currentPosition(){return this._instance?this._instance.currentPosition:new _i(0,0,0,0,!1,120,120)}get tickPosition(){return this._instance?this._instance.tickPosition:0}set tickPosition(e){this._instance&&(this._instance.tickPosition=e)}get timePosition(){return this._instance?this._instance.timePosition:0}set timePosition(e){this._instance&&(this._instance.timePosition=e)}get playbackRange(){return this._instance?this._instance.playbackRange:null}set playbackRange(e){this._instance&&(this._instance.playbackRange=e)}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._instance&&(this._instance.isLooping=e)}get countInVolume(){return this._countInVolume}set countInVolume(e){this._countInVolume=e,this._instance&&(this._instance.countInVolume=e)}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=e,this._instance&&(this._instance.midiEventsPlayedFilter=e)}destroy(){this._instance&&(this._instance.destroy(),this._instance=void 0)}play(){return!!this._instance&&this._instance.play()}pause(){this._instance&&this._instance.pause()}playPause(){this._instance&&this._instance.playPause()}stop(){this._instance&&this._instance.stop()}playOneTimeMidiFile(e){this._instance&&this._instance.playOneTimeMidiFile(e)}loadSoundFont(e,t){this._instance&&this._instance.loadSoundFont(e,t)}resetSoundFonts(){this._instance&&this._instance.resetSoundFonts()}loadMidiFile(e){this._instance&&this._instance.loadMidiFile(e)}loadBackingTrack(e){this._instance&&this._instance.loadBackingTrack(e)}updateSyncPoints(e){this._instance&&this._instance.updateSyncPoints(e)}applyTranspositionPitches(e){this._instance&&this._instance.applyTranspositionPitches(e)}setChannelTranspositionPitch(e,t){this._instance&&this._instance.setChannelTranspositionPitch(e,t)}setChannelMute(e,t){this._instance&&this._instance.setChannelMute(e,t)}resetChannelStates(){this._instance&&this._instance.resetChannelStates()}setChannelSolo(e,t){this._instance&&this._instance.setChannelSolo(e,t)}setChannelVolume(e,t){this._instance&&this._instance.setChannelVolume(e,t)}}class Nn{constructor(){this._width=0,this._score=null,this._trackIndexes=null,this.preRender=new qs,this.renderFinished=new qs,this.partialRenderFinished=new qs,this.partialLayoutFinished=new qs,this.postRenderFinished=new $s,this.error=new qs}get instance(){return this._instance}set instance(e){this._instance=e;const t=this._instanceEventUnregister;if(t)for(const e of t)e();if(e){const t=[];t.push(e.preRender.on(e=>this.preRender.trigger(e))),t.push(e.renderFinished.on(e=>this.renderFinished.trigger(e))),t.push(e.partialRenderFinished.on(e=>this.partialRenderFinished.trigger(e))),t.push(e.partialLayoutFinished.on(e=>this.partialLayoutFinished.trigger(e))),t.push(e.postRenderFinished.on(()=>this.postRenderFinished.trigger())),t.push(e.error.on(e=>this.error.trigger(e))),this._instanceEventUnregister=t,this._settings&&e.updateSettings(this._settings),e.width=this._width,null!==this._score&&e.renderScore(this._score,this._trackIndexes)}else this._instanceEventUnregister=void 0}get boundsLookup(){return this._instance?this._instance.boundsLookup:null}get width(){return this._instance?this._instance.width:0}set width(e){this._width=e,this._instance&&(this._instance.width=e)}render(){this._instance?.render()}resizeRender(){this._instance?.resizeRender()}renderScore(e,t){this._score=e,this._trackIndexes=t,this._instance?.renderScore(e,t)}renderResult(e){this._instance?.renderResult(e)}updateSettings(e){this._settings=e,this._instance?.updateSettings(e)}destroy(){this._instance?.destroy(),this._instance=void 0}}class Pn{constructor(e){this.bounds=null,this.beat=e}}class vn{get actualPlayerMode(){return this._actualPlayerMode}get renderer(){return this._renderer}get score(){return this._score}get tracks(){return this._tracks}constructor(t,s){this._startTime=0,this._trackIndexes=null,this._trackIndexLookup=null,this._isDestroyed=!1,this._score=null,this._tracks=[],this._actualPlayerMode=e.PlayerMode.Disabled,this._tickCache=null,this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null,this._previousTick=0,this._currentBeat=null,this._currentBeatBounds=null,this._isInitialBeatCursorUpdate=!0,this._previousStateForCursor=Ft.Paused,this._previousCursorCache=null,this._lastScroll=0,this._beatMouseDown=!1,this._noteMouseDown=!1,this._selectionStart=null,this._selectionEnd=null,this.beatMouseDown=new qs,this.beatMouseMove=new qs,this.beatMouseUp=new qs,this.noteMouseDown=new qs,this.noteMouseMove=new qs,this.noteMouseUp=new qs,this.resize=new qs,this.renderStarted=new qs,this.renderFinished=new qs,this.postRenderFinished=new $s,this.error=new qs,this.midiLoad=new qs,this.settingsUpdated=new $s,this.uiFacade=t,this.container=t.rootContainer,this.activeBeatsChanged=new qs(()=>this._player.state===Ft.Playing&&this._currentBeat?new wn(this._currentBeat.beatLookup.highlightedBeats.map(e=>e.beat)):null),this.playedBeatChanged=new qs(()=>this._player.state===Ft.Playing&&this._currentBeat?this._currentBeat.beat:null),this.scoreLoaded=new qs(()=>this._score?this._score:null),this.midiLoaded=new qs(()=>this._player.loadedMidiInfo??null),t.initialize(this,s),ee.logLevel=this.settings.core.logLevel,this.settings.handleBackwardsCompatibility(),Hc.printEnvironmentInfo(!1),this.canvasElement=t.createCanvasElement(),this.container.appendChild(this.canvasElement),this._renderer=new Nn,this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&Hc.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this._renderer.instance=this.uiFacade.createWorkerRenderer():this._renderer.instance=new Jr(this.settings),this.container.resize.on(Hc.throttle(()=>{this._isDestroyed||this.container.width!==this._renderer.width&&this.triggerResize()},t.resizeThrottle));const i=new Sn;i.oldWidth=this._renderer.width,i.newWidth=0|this.container.width,i.settings=this.settings,this.onResize(i),this._renderer.preRender.on(this.onRenderStarted.bind(this)),this._renderer.renderFinished.on(e=>{this.onRenderFinished(e)}),this._renderer.postRenderFinished.on(()=>{const e=Date.now()-this._startTime;ee.debug("rendering",`Rendering completed in ${e}ms`),this.onPostRenderFinished()}),this._renderer.preRender.on(e=>{this._startTime=Date.now()}),this._renderer.partialLayoutFinished.on(e=>this.appendRenderResult(e,!1)),this._renderer.partialRenderFinished.on(this.updateRenderResult.bind(this)),this._renderer.renderFinished.on(e=>{this.appendRenderResult(e,!0)}),this._renderer.error.on(this.onError.bind(this)),this.setupPlayerWrapper(),this.settings.player.playerMode!==e.PlayerMode.Disabled&&this.setupOrDestroyPlayer(),this.setupClickHandling(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}setupPlayerWrapper(){const e=new xn;this._player=e,e.ready.on(()=>{this.loadMidiForScore()}),e.readyForPlayback.on(()=>{if(this.onPlayerReady(),this.tracks)for(const t of this.tracks){const s=t.playbackInfo.volume/16;e.setChannelVolume(t.playbackInfo.primaryChannel,s),e.setChannelVolume(t.playbackInfo.secondaryChannel,s)}}),e.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),e.soundFontLoadFailed.on(e=>{this.onError(e)}),e.midiLoaded.on(this.onMidiLoaded.bind(this)),e.midiLoadFailed.on(e=>{this.onError(e)}),e.stateChanged.on(this.onPlayerStateChanged.bind(this)),e.positionChanged.on(this.onPlayerPositionChanged.bind(this)),e.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),e.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),e.finished.on(this.onPlayerFinished.bind(this))}destroy(){this._isDestroyed=!0,this._player.destroy(),this.uiFacade.destroy(),this._renderer.destroy()}updateSettings(){this.settings.handleBackwardsCompatibility();const e=this.score;e&&De.applyPitchOffsets(this.settings,e),this.updateRenderer(),this._renderer.updateSettings(this.settings),this.setupOrDestroyPlayer(),this.onSettingsUpdated()}updateRenderer(){const e=this._renderer;this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&Hc.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?e.instance instanceof Jr&&(e.destroy(),e.instance=this.uiFacade.createWorkerRenderer()):e.instance instanceof Jr||(e.destroy(),e.instance=new Jr(this.settings))}load(e,t){try{return this.uiFacade.load(e,e=>{this.renderScore(e,t)},e=>{this.onError(e)})}catch(e){return this.onError(e),!1}}renderScore(e,t){const s=[];if(t)if(0===t.length)e.tracks.length>0&&s.push(e.tracks[0]);else if(1===t.length&&-1===t[0])for(const t of e.tracks)s.push(t);else for(const i of t)i>=0&&i<=e.tracks.length&&s.push(e.tracks[i]);else e.tracks.length>0&&s.push(e.tracks[0]);this.internalRenderTracks(e,s)}renderTracks(t){if(t.length>0){const s=t[0].score;for(const i of t)if(i.score!==s)return void this.onError(new O(e.AlphaTabErrorType.General,"All rendered tracks must belong to the same score."));this.internalRenderTracks(s,t)}}internalRenderTracks(e,t){if(De.applyPitchOffsets(this.settings,e),e!==this.score){this._score=e,this._tracks=t,this._tickCache=null,this._trackIndexes=[];for(const e of t)this._trackIndexes.push(e.index);this._trackIndexLookup=new Set(this._trackIndexes),this.onScoreLoaded(e),this.loadMidiForScore(),this.render()}else{this._tracks=t;const s=De.computeFirstDisplayedBarIndex(e,this.settings),i=De.computeLastDisplayedBarIndex(e,this.settings,s);this._tickCache&&(this._tickCache.multiBarRestInfo=De.buildMultiBarRestInfo(this.tracks,s,i)),this._trackIndexes=[];for(const e of t)this._trackIndexes.push(e.index);this._trackIndexLookup=new Set(this._trackIndexes),this.render()}}triggerResize(){if(this.container.isVisible){const e=new Sn;e.oldWidth=this._renderer.width,e.newWidth=this.container.width,e.settings=this.settings,this.onResize(e),this._renderer.updateSettings(this.settings),this._renderer.width=this.container.width,this._renderer.resizeRender()}else ee.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{ee.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()})}appendRenderResult(e,t){t&&(this.canvasElement.width=e.totalWidth,this.canvasElement.height=e.totalHeight,this._cursorWrapper&&(this._cursorWrapper.width=e.totalWidth,this._cursorWrapper.height=e.totalHeight)),(e.width>0||e.height>0)&&this.uiFacade.beginAppendRenderResults(e),t&&this.uiFacade.beginAppendRenderResults(null)}updateRenderResult(e){e&&e.renderResult&&this.uiFacade.beginUpdateRenderResults(e)}tex(e,t){try{const s=new ft;s.logErrors=!0,s.initFromString(e,this.settings);const i=s.readScore();this.renderScore(i,t)}catch(e){this.onError(e)}}loadSoundFont(e,t=!1){return this.uiFacade.loadSoundFont(e,t)}resetSoundFonts(){this._player.resetSoundFonts()}render(){this.uiFacade.canRender?(this._renderer.width=this.container.width,this._renderer.renderScore(this.score,this._trackIndexes)):this.uiFacade.canRenderChanged.on(()=>this.render())}get tickCache(){return this._tickCache}get boundsLookup(){return this._renderer.boundsLookup}get player(){return this._player.instance?this._player:null}get isReadyForPlayback(){return this._player.isReadyForPlayback}get playerState(){return this._player.state}get masterVolume(){return this._player.masterVolume}set masterVolume(e){this._player.masterVolume=e}get metronomeVolume(){return this._player.metronomeVolume}set metronomeVolume(e){this._player.metronomeVolume=e}get countInVolume(){return this._player.countInVolume}set countInVolume(e){this._player.countInVolume=e}get midiEventsPlayedFilter(){return this._player.midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._player.midiEventsPlayedFilter=e}get tickPosition(){return this._player.tickPosition}set tickPosition(e){this._player.tickPosition=e}get timePosition(){return this._player.timePosition}set timePosition(e){this._player.timePosition=e}get endTick(){return this._player.currentPosition.endTick}get endTime(){return this._player.currentPosition.endTime}get playbackRange(){return this._player.playbackRange}set playbackRange(e){this._player.playbackRange=e,this.updateSelectionCursor(e)}get playbackSpeed(){return this._player.playbackSpeed}set playbackSpeed(e){this._player.playbackSpeed=e}get isLooping(){return this._player.isLooping}set isLooping(e){this._player.isLooping=e}destroyPlayer(){this._player.destroy(),this._previousTick=0,this.destroyCursors()}setupOrDestroyPlayer(){let t=this.settings.player.playerMode;if(t===e.PlayerMode.EnabledAutomatic){const s=this.score;if(!s)return!1;t=s?.backingTrack?.rawAudioFile?e.PlayerMode.EnabledBackingTrack:e.PlayerMode.EnabledSynthesizer}let s=null;if(t===this._actualPlayerMode)return this.updateCursors(),!1;switch(this.destroyPlayer(),this.updateCursors(),t){case e.PlayerMode.Disabled:s=null;break;case e.PlayerMode.EnabledSynthesizer:s=this.uiFacade.createWorkerPlayer();break;case e.PlayerMode.EnabledBackingTrack:s=this.uiFacade.createBackingTrackPlayer();break;case e.PlayerMode.EnabledExternalMedia:s=new _n(this.settings.player.bufferTimeInMilliseconds)}return this._actualPlayerMode=t,!!s&&(this._player.instance=s,!1)}loadMidiForScore(){if(!this.score)return;const e=this.score;ee.debug("AlphaTab","Generating Midi");const t=new ii,s=new jr(t),i=new cn(e,this.settings,s),a=De.computeFirstDisplayedBarIndex(e,this.settings),r=De.computeLastDisplayedBarIndex(e,this.settings,a);i.tickLookup.multiBarRestInfo=De.buildMultiBarRestInfo(this.tracks,a,r),i.applyTranspositionPitches=!1,i.generate(),this._tickCache=i.tickLookup,this.onMidiLoad(t);const n=this._player;n.loadMidiFile(t),n.loadBackingTrack(e),n.updateSyncPoints(i.syncPoints),n.applyTranspositionPitches(i.transpositionPitches)}updateSyncPoints(){if(!this.score)return;const e=this.score;this._player.updateSyncPoints(cn.generateSyncPoints(e))}changeTrackVolume(e,t){for(const s of e)this._player.setChannelVolume(s.playbackInfo.primaryChannel,t),this._player.setChannelVolume(s.playbackInfo.secondaryChannel,t)}changeTrackSolo(e,t){for(const s of e)this._player.setChannelSolo(s.playbackInfo.primaryChannel,t),this._player.setChannelSolo(s.playbackInfo.secondaryChannel,t)}changeTrackMute(e,t){for(const s of e)this._player.setChannelMute(s.playbackInfo.primaryChannel,t),this._player.setChannelMute(s.playbackInfo.secondaryChannel,t)}changeTrackTranspositionPitch(e,t){for(const s of e)this._player.setChannelTranspositionPitch(s.playbackInfo.primaryChannel,t),this._player.setChannelTranspositionPitch(s.playbackInfo.secondaryChannel,t)}play(){return this._player.play()}pause(){this._player.pause()}playPause(){this._player.playPause()}stop(){this._player.stop()}playBeat(e){const t=new ii,s=new jr(t);new cn(e.voice.bar.staff.track.score,this.settings,s).generateSingleBeat(e),this._player.playOneTimeMidiFile(t)}playNote(e){const t=new ii,s=new jr(t);new cn(e.beat.voice.bar.staff.track.score,this.settings,s).generateSingleNote(e),this._player.playOneTimeMidiFile(t)}destroyCursors(){this._cursorWrapper&&(this.uiFacade.destroyCursors(),this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null)}updateCursors(){const e=this.hasCursor;if(e&&!this._cursorWrapper){const e=this.uiFacade.createCursors();e&&(this._cursorWrapper=e.cursorWrapper,this._barCursor=e.barCursor,this._beatCursor=e.beatCursor,this._selectionWrapper=e.selectionWrapper,this._isInitialBeatCursorUpdate=!0),null!==this._currentBeat&&this.cursorUpdateBeat(this._currentBeat,!1,this._previousTick>10,1,!0)}else!e&&this._cursorWrapper&&this.destroyCursors()}cursorUpdateTick(e,t,s,i=!1,a=!1){this._previousTick=e;const r=this._tickCache;if(r){const n=this._trackIndexLookup;if(null!=n&&n.size>0){const o=r.findBeat(n,e,this._currentBeat);o&&this.cursorUpdateBeat(o,t,i,s,a||this.playerState===Ft.Paused)}}}cursorUpdateBeat(e,t,s,i,a=!1){const r=e.beat,n=e.nextBeat?.beat??null,o=e.duration,h=e.beatLookup.highlightedBeats;if(!r)return;const l=this._renderer.boundsLookup;if(!l)return;const c=this._currentBeat,d=this._previousCursorCache,u=this._previousStateForCursor;if(!a&&r===c?.beat&&l===d&&u===this._player.state&&c?.start===e.start)return;const p=l.findBeat(r);p&&(this._currentBeat=e,this._previousCursorCache=l,this._previousStateForCursor=this._player.state,this.uiFacade.beginInvoke(()=>{this.internalCursorUpdateBeat(r,n,o,t,h,l,p,s,e.cursorMode,i)}))}scrollToCursor(){const e=this._currentBeatBounds;e&&this.internalScrollToCursor(e.barBounds.masterBarBounds)}internalScrollToCursor(t){const s=this.uiFacade.getScrollContainer(),i=Hc.getLayoutEngineFactory(this.settings.display.layoutMode).vertical,a=this.settings.player.scrollMode;if(i){const i=t.realBounds.y+this.settings.player.scrollOffsetY;if(i!==this._lastScroll)switch(this._lastScroll=i,a){case e.ScrollMode.Continuous:const a=this.uiFacade.getOffset(s,this.container);this.uiFacade.scrollToY(s,a.y+i,this.settings.player.scrollSpeed);break;case e.ScrollMode.OffScreen:const r=s.scrollTop+this.uiFacade.getOffset(null,s).h;if(t.visualBounds.y+t.visualBounds.h>=r||t.visualBounds.y<s.scrollTop){const e=t.realBounds.y+this.settings.player.scrollOffsetY;this.uiFacade.scrollToY(s,e,this.settings.player.scrollSpeed)}}}else{const i=t.visualBounds.x;if(i!==this._lastScroll)switch(this._lastScroll=i,a){case e.ScrollMode.Continuous:const i=t.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=t.visualBounds.x,this.uiFacade.scrollToX(s,i,this.settings.player.scrollSpeed);break;case e.ScrollMode.OffScreen:const a=s.scrollLeft+this.uiFacade.getOffset(null,s).w;if(t.visualBounds.x+t.visualBounds.w>=a||t.visualBounds.x<s.scrollLeft){const e=t.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=t.visualBounds.x,this.uiFacade.scrollToX(s,e,this.settings.player.scrollSpeed)}}}}internalCursorUpdateBeat(t,s,i,a,r,n,o,h,l,c){const d=this._barCursor,u=this._beatCursor,p=o.barBounds.masterBarBounds,m=p.visualBounds,g=this._currentBeatBounds;this._currentBeatBounds=o,d&&d.setBounds(m.x,m.y,m.w,m.h);const f=this._player.state===Ft.Playing&&!a;let y=p.visualBounds.x+p.visualBounds.w;if(s&&l===$t.ToNextBext){const e=n.findBeat(s);e&&e.barBounds.masterBarBounds.staffSystemBounds===p.staffSystemBounds&&(y=e.onNotesX)}let b=o.onNotesX;if(u){if(this.settings.player.enableAnimatedBeatCursor){const e=y-o.onNotesX,t=this._previousTick-this._currentBeat.start,s=this._currentBeat.tickDuration>0?t/this._currentBeat.tickDuration:0;if(b=o.onNotesX+e*s,i-=i*s,f){(!g||this._isInitialBeatCursorUpdate||m.y!==g.barBounds.masterBarBounds.visualBounds.y||b<g.onNotesX||p.index>g.barBounds.masterBarBounds.index+1)&&(u.transitionToX(0,b),u.setBounds(b,m.y,1,m.h)),this.uiFacade.beginInvoke(()=>{const e=l===$t.ToNextBext?2:1,t=b+(y-b)*e;u.transitionToX(i/c*e,t)})}else u.transitionToX(0,b),u.setBounds(b,m.y,1,m.h)}else u.transitionToX(0,b),u.setBounds(b,m.y,1,m.h);this._isInitialBeatCursorUpdate=!1}else this._isInitialBeatCursorUpdate=!0;this.uiFacade.removeHighlights();let S=!1;if(f){if(this.settings.player.enableElementHighlighting)for(const e of r){const s=bn.getGroupId(e.beat);this.uiFacade.highlightElements(s,t.voice.bar.index)}h=!a,S=!0}h&&!this._beatMouseDown&&this.settings.player.scrollMode!==e.ScrollMode.Off&&this.internalScrollToCursor(p),S&&(this.onPlayedBeatChanged(t),this.onActiveBeatsChanged(new wn(r.map(e=>e.beat))))}onPlayedBeatChanged(e){this._isDestroyed||(this.playedBeatChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",e))}onActiveBeatsChanged(e){this._isDestroyed||(this.activeBeatsChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",e))}get hasCursor(){return this.settings.player.playerMode!==e.PlayerMode.Disabled&&this.settings.player.enableCursor}onBeatMouseDown(e,t){this._isDestroyed||(this.hasCursor&&this.settings.player.enableUserInteraction&&(this._selectionStart=new Pn(t),this._selectionEnd=null),this._beatMouseDown=!0,this.beatMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseDown",t,e))}onNoteMouseDown(e,t){this._isDestroyed||(this._noteMouseDown=!0,this.noteMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseDown",t,e))}onBeatMouseMove(e,t){this._isDestroyed||(this.settings.player.enableUserInteraction&&(this._selectionEnd&&this._selectionEnd.beat===t||(this._selectionEnd=new Pn(t),this.cursorSelectRange(this._selectionStart,this._selectionEnd))),this.beatMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseMove",t,e))}onNoteMouseMove(e,t){this._isDestroyed||(this.noteMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseMove",t,e))}onBeatMouseUp(e,t){if(!this._isDestroyed){if(this.hasCursor&&this.settings.player.enableUserInteraction){if(this._selectionEnd){const e=this._tickCache?.getBeatStart(this._selectionStart.beat)??this._selectionStart.beat.absolutePlaybackStart;if((this._tickCache?.getBeatStart(this._selectionEnd.beat)??this._selectionEnd.beat.absolutePlaybackStart)<e){const e=this._selectionStart;this._selectionStart=this._selectionEnd,this._selectionEnd=e}}if(this._selectionStart&&this._tickCache){const e=this._tickCache,t=e.getMasterBarStart(this._selectionStart.beat.voice.bar.masterBar);if(this._currentBeat=null,this._player.state===Ft.Paused&&this.cursorUpdateTick(this._tickCache.getBeatStart(this._selectionStart.beat),!1,1),this.tickPosition=t+this._selectionStart.beat.playbackStart,this._selectionEnd&&this._selectionStart.beat!==this._selectionEnd.beat){const s=e.getMasterBarStart(this._selectionEnd.beat.voice.bar.masterBar),i=new dn;i.startTick=t+this._selectionStart.beat.playbackStart,i.endTick=s+this._selectionEnd.beat.playbackStart+this._selectionEnd.beat.playbackDuration-50,this.playbackRange=i}else this._selectionStart=null,this.playbackRange=null,this.cursorSelectRange(this._selectionStart,this._selectionEnd)}}this.beatMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseUp",t,e),this._beatMouseDown=!1}}onNoteMouseUp(e,t){this._isDestroyed||(this.noteMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseUp",t,e),this._noteMouseDown=!1)}updateSelectionCursor(e){if(this._tickCache)if(e){const t=this._tickCache.findBeat(this._trackIndexLookup,e.startTick),s=this._tickCache.findBeat(this._trackIndexLookup,e.endTick);if(t&&s){const e=new Pn(t.beat),i=new Pn(s.beat);this.cursorSelectRange(e,i)}}else this.cursorSelectRange(null,null)}setupClickHandling(){this.canvasElement.mouseDown.on(e=>{if(!e.isLeftMouseButton)return;this.settings.player.enableUserInteraction&&e.preventDefault();const t=e.getX(this.canvasElement),s=e.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(t,s)??null;if(i&&(this.onBeatMouseDown(e,i),this.settings.core.includeNoteBounds)){const a=this._renderer.boundsLookup?.getNoteAtPos(i,t,s);a&&this.onNoteMouseDown(e,a)}}),this.canvasElement.mouseMove.on(e=>{if(!this._beatMouseDown)return;const t=e.getX(this.canvasElement),s=e.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(t,s)??null;if(i&&(this.onBeatMouseMove(e,i),this._noteMouseDown)){const a=this._renderer.boundsLookup?.getNoteAtPos(i,t,s);a&&this.onNoteMouseMove(e,a)}}),this.canvasElement.mouseUp.on(e=>{if(!this._beatMouseDown)return;this.settings.player.enableUserInteraction&&e.preventDefault();const t=e.getX(this.canvasElement),s=e.getY(this.canvasElement),i=this._renderer.boundsLookup?.getBeatAtPos(t,s)??null;if(this.onBeatMouseUp(e,i),this._noteMouseDown)if(i){const a=this._renderer.boundsLookup?.getNoteAtPos(i,t,s)??null;this.onNoteMouseUp(e,a)}else this.onNoteMouseUp(e,null)}),this._renderer.postRenderFinished.on(()=>{this._selectionStart&&this.hasCursor&&this.settings.player.enableUserInteraction&&this.cursorSelectRange(this._selectionStart,this._selectionEnd)})}cursorSelectRange(e,t){const s=this._renderer.boundsLookup;if(!s)return;const i=this._selectionWrapper;if(!i)return;if(i.clear(),!e||!t||e.beat===t.beat)return;e.bounds||(e.bounds=s.findBeat(e.beat)),t.bounds||(t.bounds=s.findBeat(t.beat));const a=this._tickCache?.getBeatStart(e.beat)??e.beat.absolutePlaybackStart;if((this._tickCache?.getBeatStart(t.beat)??t.beat.absolutePlaybackStart)<a){const s=e;e=t,t=s}const r=e.bounds.realBounds.x;let n=t.bounds.realBounds.x+t.bounds.realBounds.w;if(t.beat.index===t.beat.voice.beats.length-1&&(n=t.bounds.barBounds.masterBarBounds.realBounds.x+t.bounds.barBounds.masterBarBounds.realBounds.w),e.bounds.barBounds.masterBarBounds.staffSystemBounds!==t.bounds.barBounds.masterBarBounds.staffSystemBounds){const a=e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x,o=e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.x+e.bounds.barBounds.masterBarBounds.staffSystemBounds.visualBounds.w,h=this.uiFacade.createSelectionElement();h.setBounds(r,e.bounds.barBounds.masterBarBounds.visualBounds.y,o-r,e.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(h);const l=e.bounds.barBounds.masterBarBounds.staffSystemBounds.index+1,c=t.bounds.barBounds.masterBarBounds.staffSystemBounds.index;for(let e=l;e<c;e++){const t=s.staffSystems[e],r=this.uiFacade.createSelectionElement();r.setBounds(a,t.visualBounds.y,o-a,t.visualBounds.h),i.appendChild(r)}const d=this.uiFacade.createSelectionElement();d.setBounds(a,t.bounds.barBounds.masterBarBounds.visualBounds.y,n-a,t.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(d)}else{const t=this.uiFacade.createSelectionElement();t.setBounds(r,e.bounds.barBounds.masterBarBounds.visualBounds.y,n-r,e.bounds.barBounds.masterBarBounds.visualBounds.h),i.appendChild(t)}}onScoreLoaded(e){this._isDestroyed||(this.scoreLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"scoreLoaded",e),this.setupOrDestroyPlayer()||this.loadMidiForScore())}onResize(e){this._isDestroyed||(this.resize.trigger(e),this.uiFacade.triggerEvent(this.container,"resize",e))}onRenderStarted(e){this._isDestroyed||(this.renderStarted.trigger(e),this.uiFacade.triggerEvent(this.container,"renderStarted",e))}onRenderFinished(e){this._isDestroyed||(this.renderFinished.trigger(e),this.uiFacade.triggerEvent(this.container,"renderFinished",e))}onPostRenderFinished(){this._isDestroyed||(this._currentBeat=null,this.cursorUpdateTick(this._previousTick,!1,1,!0,!0),this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}onError(e){this._isDestroyed||(ee.error("API","An unexpected error occurred",e),this.error.trigger(e),this.uiFacade.triggerEvent(this.container,"error",e))}get playerReady(){return this._player.readyForPlayback}onPlayerReady(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerReady",null)}get playerFinished(){return this._player.finished}onPlayerFinished(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playerFinished",null)}get soundFontLoaded(){return this._player.soundFontLoaded}onSoundFontLoaded(){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null)}onMidiLoad(e){this._isDestroyed||(this.midiLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"midiLoad",e))}onMidiLoaded(e){this._isDestroyed||(this.midiLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",e))}get playerStateChanged(){return this._player.stateChanged}onPlayerStateChanged(e){if(!this._isDestroyed){if(!e.stopped&&e.state===Ft.Paused){const e=this._currentBeat,t=this._tickCache;e&&t&&(this._player.tickPosition=t.getBeatStart(e.beat))}this.uiFacade.triggerEvent(this.container,"playerStateChanged",e)}}get playerPositionChanged(){return this._player.positionChanged}onPlayerPositionChanged(e){this._isDestroyed||(this._previousTick=e.currentTick,this.uiFacade.beginInvoke(()=>{const t=e.modifiedTempo/e.originalTempo;this.cursorUpdateTick(e.currentTick,!1,t,!1,e.isSeek)}),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",e))}get midiEventsPlayed(){return this._player.midiEventsPlayed}onMidiEventsPlayed(e){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",e)}get playbackRangeChanged(){return this._player.playbackRangeChanged}onPlaybackRangeChanged(e){this._isDestroyed||this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",e)}onSettingsUpdated(){this._isDestroyed||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}async enumerateOutputDevices(){return await this._player.output.enumerateOutputDevices()}async setOutputDevice(e){await this._player.output.setOutputDevice(e)}async getOutputDevice(){return await this._player.output.getOutputDevice()}async exportAudio(t){if(!this.score)throw new O(e.AlphaTabErrorType.General,"No song loaded");let s;if(this._actualPlayerMode===e.PlayerMode.EnabledSynthesizer)s=this.uiFacade.createWorkerAudioExporter(this._player.instance);else s=this.uiFacade.createWorkerAudioExporter(null);const i=this.score,a=new ii,r=new jr(a),n=new cn(i,this.settings,r);n.applyTranspositionPitches=!1,n.generate();const o=new Fa;o.soundFonts=t.soundFonts,o.sampleRate=t.sampleRate,o.useSyncPoints=t.useSyncPoints,o.masterVolume=t.masterVolume,o.metronomeVolume=t.metronomeVolume,o.playbackRange=t.playbackRange;for(const[e,s]of t.trackVolume)if(e<this.score.tracks.length){const t=this.score.tracks[e];o.trackVolume.set(t.playbackInfo.primaryChannel,s),o.trackVolume.set(t.playbackInfo.secondaryChannel,s)}for(const[e,s]of t.trackTranspositionPitches)if(e<this.score.tracks.length){const t=this.score.tracks[e];o.trackTranspositionPitches.set(t.playbackInfo.primaryChannel,s),o.trackTranspositionPitches.set(t.playbackInfo.secondaryChannel,s)}return await s.initialize(o,a,n.syncPoints,n.transpositionPitches),s}}class En extends O{constructor(t,s){super(e.AlphaTabErrorType.General,t),this.xhr=s,Object.setPrototypeOf(this,En.prototype)}}class Mn{static loadAlphaTex(e,t){const s=new ft;return s.logErrors=!0,s.initFromString(e,t??new hr),s.readScore()}static loadScoreAsync(e,t,s,i){const a=new XMLHttpRequest;a.open("GET",e,!0,null,null),a.responseType="arraybuffer",a.onreadystatechange=()=>{if(a.readyState===XMLHttpRequest.DONE){const e=a.response;if(200===a.status||0===a.status&&e)try{const e=a.response,s=new Uint8Array(e),r=Mn.loadScoreFromBytes(s,i);t(r)}catch(e){s(e)}else 0===a.status?s(new En("You are offline!!\n Please Check Your Network.",a)):404===a.status?s(new En("Requested URL not found.",a)):500===a.status?s(new En("Internel Server Error.",a)):"parsererror"===a.statusText?s(new En("Error.\nParsing JSON Request failed.",a)):"timeout"===a.statusText?s(new En("Request Time out.",a)):s(new En(`Unknow Error: ${a.responseText}`,a))}},a.send()}static loadScoreFromBytes(e,t){t||(t=new hr);const s=Hc.buildImporters();ee.debug("ScoreLoader",`Loading score from ${e.length} bytes using ${s.length} importers`);let i=null;const a=ut.fromBuffer(e);for(const e of s){a.reset();try{ee.debug("ScoreLoader",`Importing using importer ${e.name}`),e.init(a,t),i=e.readScore(),ee.debug("ScoreLoader",`Score imported using ${e.name}`);break}catch(t){if(!(t instanceof Ze))throw ee.error("ScoreLoader","Score import failed due to unexpected error: ",t),t;ee.debug("ScoreLoader",`${e.name} does not support the file`)}}if(i)return i;throw new Ze("No compatible importer found for file")}}class Fn{get isLeftMouseButton(){return 0===this.mouseEvent.button}getX(e){const t=e.element,s=t.getBoundingClientRect().left+t.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-s}getY(e){const t=e.element,s=t.getBoundingClientRect().top+t.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-s}preventDefault(){this.mouseEvent.preventDefault()}constructor(e){this.mouseEvent=e}}class Cn{get width(){return this.element.offsetWidth}set width(e){this.element.style.width=`${e}px`}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(e){this.element.scrollLeft=e}get scrollTop(){return this.element.scrollTop}set scrollTop(e){this.element.scrollTop=e}get height(){return this.element.offsetHeight}set height(e){this.element.style.height=e>=0?`${e}px`:"100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}constructor(e){this._resizeListeners=0,this.lastBounds=new Ts,this.element=e,this.mouseDown={on:e=>{const t=t=>{e(new Fn(t))};return this.element.addEventListener("mousedown",t,!0),()=>{this.element.removeEventListener("mousedown",t,!0)}},off:e=>{}},this.mouseUp={on:e=>{const t=t=>{e(new Fn(t))};return this.element.addEventListener("mouseup",t,!0),()=>{this.element.removeEventListener("mouseup",t,!0)}},off:e=>{}},this.mouseMove={on:e=>{const t=t=>{e(new Fn(t))};return this.element.addEventListener("mousemove",t,!0),()=>{this.element.removeEventListener("mousemove",t,!0)}},off:e=>{}};const t=this;this.resize={on:function(e){return 0===t._resizeListeners&&Cn.resizeObserver.value.observe(t.element),t.element.addEventListener("resize",e,!0),t._resizeListeners++,()=>this.off(e)},off:e=>{this.element.removeEventListener("resize",e,!0),this._resizeListeners--,this._resizeListeners<=0&&(this._resizeListeners=0,Cn.resizeObserver.value.unobserve(this.element))}}}stopAnimation(){this.element.style.transition="none"}transitionToX(e,t){this.element.style.transition=`transform ${e}ms linear`,this.setBounds(t,Number.NaN,Number.NaN,Number.NaN)}setBounds(e,t,s,i){Number.isNaN(e)&&(e=this.lastBounds.x),Number.isNaN(t)&&(t=this.lastBounds.y),Number.isNaN(s)&&(s=this.lastBounds.w),Number.isNaN(i)&&(i=this.lastBounds.h),this.element.style.transform=`translate(${e}px, ${t}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=s,this.lastBounds.h=i}appendChild(e){this.element.appendChild(e.element)}clear(){this.element.innerHTML=""}}Cn.resizeObserver=new Q(()=>new ResizeObserver(e=>{for(const t of e){const e=new CustomEvent("resize",{detail:t});t.target.dispatchEvent(e)}}));class Dn{constructor(e){this._isStarted=!1,this.isFontLoaded=!1,this.fontLoaded=new qs,this._originalFamilies=e,this._families=e}checkForFontAvailability(){if(Hc.isRunningInWorker)return void(this.isFontLoaded=!1);if(this._isStarted)return;this._isStarted=!0;let e=0;const t=window.setInterval(()=>{ee.warning("Rendering",`Could not load font '${this._families[0]}' within ${5*(e+1)} seconds`,null),this._families.length>1?(this._families.shift(),e=0):e++},5e3);ee.debug("Font",`Start checking for font availablility: ${this._families.join(", ")}`);const s=e=>{this._families.length>1?(ee.debug("Font",`[${this._families[0]}] Loading Failed, switching to ${this._families[1]}`,e),this._families.shift(),window.setTimeout(()=>{a()},0)):(ee.error("Font",`[${this._originalFamilies.join(",")}] Loading Failed, rendering cannot start`,e),window.clearInterval(t))},i=e=>{ee.debug("Font",`[${e}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(t),this.fontLoaded.trigger(this._families[0])},a=async()=>{for(const e of this._families)if(await this.isFontAvailable(e,!1))return void i(e);try{await document.fonts.load(`1em ${this._families[0]}`)}catch(e){s(e)}return ee.debug("Font",`[${this._families[0]}] Font API signaled loaded`),await this.isFontAvailable(this._families[0],!0)?i(this._families[0]):s("Font not available"),!0};document.fonts.ready.then(()=>{a()})}isFontAvailable(e,t){return new Promise(s=>{const i=`1em ${e}`;if(document.fonts.check(i))s(!0);else if(t){ee.debug("Font",`Font ${e} not available, creating test element to trigger load`);const t=document.createElement("div");t.style.font=i,t.style.opacity="0",t.style.position="absolute",t.style.top="0",t.style.left="0",t.innerText=`Trigger ${e} load`,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t),document.fonts.check(i)?s(!0):s(!1)},200)}else s(!1)})}}class Ln extends Zs{constructor(){super(...arguments),this._audioNode=null,this._bufferCount=0,this._requestedBufferCount=0,this._outputBuffer=new Float32Array(0)}open(e){super.open(e),this._bufferCount=Math.floor(e*this.sampleRate/1e3/Zs.BufferSize),this._circularBuffer=new Js(Zs.BufferSize*this._bufferCount),this.onReady()}play(){super.play();const e=this._context;this._audioNode=e.createScriptProcessor(4096,0,2),this._audioNode.onaudioprocess=this.generateSound.bind(this),this._circularBuffer.clear(),this.requestBuffers(),this._source=e.createBufferSource(),this._source.buffer=this._buffer,this._source.loop=!0,this._source.connect(this._audioNode,0,0),this._source.start(0),this._audioNode.connect(e.destination,0,0)}pause(){super.pause(),this._audioNode&&this._audioNode.disconnect(0),this._audioNode=null}addSamples(e){this._circularBuffer.write(e,0,e.length),this._requestedBufferCount--}resetSamples(){this._circularBuffer.clear()}requestBuffers(){const e=this._bufferCount/2|0,t=e*Zs.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*Zs.BufferSize<t){for(let t=0;t<e;t++)this.onSampleRequest();this._requestedBufferCount+=e}}generateSound(e){const t=e.outputBuffer.getChannelData(0),s=e.outputBuffer.getChannelData(1),i=t.length+s.length;let a=this._outputBuffer;a.length!==i&&(a=new Float32Array(i),this._outputBuffer=a);const r=this._circularBuffer.read(a,0,Math.min(a.length,this._circularBuffer.count));let n=0;const o=Math.min(t.length,r);for(let e=0;e<o;e++)t[e]=a[n++],s[e]=a[n++];if(r<t.length)for(let e=r;e<t.length;e++)t[e]=0,s[e]=0;this.onSamplesPlayed(r/se.AudioChannels),this.requestBuffers()}}class In{get output(){return this._output}get isReady(){return this._workerIsReady&&this._outputIsReady}get isReadyForPlayback(){return this._workerIsReadyForPlayback}get state(){return this._state}get logLevel(){return ee.logLevel}get worker(){return this._synth}set logLevel(e){ee.logLevel=e,this._synth.postMessage({cmd:"alphaSynth.setLogLevel",value:e})}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Math.max(e,se.MinVolume),this._masterVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMasterVolume",value:e})}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,se.MinVolume),this._metronomeVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:e})}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,se.MinVolume),this._countInVolume=e,this._synth.postMessage({cmd:"alphaSynth.setCountInVolume",value:e})}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=e,this._synth.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:Hc.prepareForPostMessage(e)})}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){e=De.clamp(e,se.MinPlaybackSpeed,se.MaxPlaybackSpeed),this._playbackSpeed=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:e})}get loadedMidiInfo(){return this.loadedMidiInfo}get currentPosition(){return this._currentPosition}get tickPosition(){return this._currentPosition.currentTick}set tickPosition(e){e<0&&(e=0),this._currentPosition=new _i(this._currentPosition.currentTime,this._currentPosition.endTime,e,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTickPosition",value:e})}get timePosition(){return this._currentPosition.currentTime}set timePosition(e){e<0&&(e=0),this._currentPosition=new _i(e,this._currentPosition.endTime,this._currentPosition.currentTick,this._currentPosition.endTick,!0,this._currentPosition.originalTempo,this._currentPosition.modifiedTempo),this._synth.postMessage({cmd:"alphaSynth.setTimePosition",value:e})}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._synth.postMessage({cmd:"alphaSynth.setIsLooping",value:e})}get playbackRange(){return this._playbackRange}set playbackRange(e){e&&(e.startTick<0&&(e.startTick=0),e.endTick<0&&(e.endTick=0)),this._playbackRange=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackRange",value:Hc.prepareForPostMessage(e)})}constructor(e,t){this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=Ft.Paused,this._masterVolume=0,this._metronomeVolume=0,this._countInVolume=0,this._playbackSpeed=0,this._isLooping=!1,this._playbackRange=null,this._midiEventsPlayedFilter=[],this._currentPosition=new _i(0,0,0,0,!1,120,120),this.ready=new $s,this.readyForPlayback=new $s,this.finished=new $s,this.soundFontLoaded=new $s,this.soundFontLoadFailed=new qs,this.midiLoaded=new qs,this.midiLoadFailed=new qs,this.stateChanged=new qs,this.positionChanged=new qs,this.midiEventsPlayed=new qs,this.playbackRangeChanged=new qs,this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=Ft.Paused,this._masterVolume=0,this._metronomeVolume=0,this._playbackSpeed=0,this._isLooping=!1,this._playbackRange=null,this._output=e,this._output.ready.on(this.onOutputReady.bind(this)),this._output.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this._output.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this._output.open(t.player.bufferTimeInMilliseconds);try{this._synth=Hc.createWebWorker(t)}catch(e){ee.error("AlphaSynth",`Failed to create WebWorker: ${e}`)}this._synth.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this._synth.postMessage({cmd:"alphaSynth.initialize",sampleRate:this._output.sampleRate,logLevel:t.core.logLevel,bufferTimeInMilliseconds:t.player.bufferTimeInMilliseconds}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}destroy(){this._synth.postMessage({cmd:"alphaSynth.destroy"})}play(){return this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this._synth.postMessage({cmd:"alphaSynth.pause"})}playPause(){this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.playPause"})}stop(){this._synth.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:Ar.midiFileToJsObject(Hc.prepareForPostMessage(e))})}loadSoundFont(e,t){this._synth.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:Hc.prepareForPostMessage(e),append:t})}resetSoundFonts(){this._synth.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.loadMidi",midi:Ar.midiFileToJsObject(Hc.prepareForPostMessage(e))})}applyTranspositionPitches(e){this._synth.postMessage({cmd:"alphaSynth.applyTranspositionPitches",transpositionPitches:JSON.stringify(Array.from(Hc.prepareForPostMessage(e).entries()))})}setChannelTranspositionPitch(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelTranspositionPitch",channel:e,semitones:t})}setChannelMute(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelMute",channel:e,mute:t})}resetChannelStates(){this._synth.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelSolo",channel:e,solo:t})}setChannelVolume(e,t){t=Math.max(t,se.MinVolume),this._synth.postMessage({cmd:"alphaSynth.setChannelVolume",channel:e,volume:t})}handleWorkerMessage(e){const t=e.data;switch(t.cmd){case"alphaSynth.ready":this._workerIsReady=!0,this.checkReady();break;case"alphaSynth.destroyed":this._synth.terminate();break;case"alphaSynth.readyForPlayback":this._workerIsReadyForPlayback=!0,this.checkReadyForPlayback();break;case"alphaSynth.positionChanged":this._currentPosition=new _i(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek,t.originalTempo,t.modifiedTempo),this.positionChanged.trigger(this._currentPosition);break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new Ea(t.events.map(Ar.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this._state=t.state,this.stateChanged.trigger(new Ti(t.state,t.stopped));break;case"alphaSynth.playbackRangeChanged":this._playbackRange=t.playbackRange,this.playbackRangeChanged.trigger(new Ma(this._playbackRange));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(t.error);break;case"alphaSynth.midiLoaded":this.checkReadyForPlayback(),this._loadedMidiInfo=new _i(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek,t.originalTempo,t.modifiedTempo),this.midiLoaded.trigger(this._loadedMidiInfo);break;case"alphaSynth.midiLoadFailed":this.checkReadyForPlayback(),this.midiLoadFailed.trigger(t.error);break;case"alphaSynth.output.addSamples":this._output.addSamples(t.samples);break;case"alphaSynth.output.play":this._output.play();break;case"alphaSynth.output.pause":this._output.pause();break;case"alphaSynth.output.destroy":this._output.destroy();break;case"alphaSynth.output.resetSamples":this._output.resetSamples()}}checkReady(){this.isReady&&this.ready.trigger()}checkReadyForPlayback(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}onOutputSampleRequest(){this._synth.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(e){this._synth.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:e})}onOutputReady(){this._outputIsReady=!0,this.checkReady()}loadBackingTrack(e){}updateSyncPoints(e){}}class An{constructor(e,t){this._width=0,this.boundsLookup=null,this.preRender=new qs,this.partialRenderFinished=new qs,this.partialLayoutFinished=new qs,this.renderFinished=new qs,this.postRenderFinished=new $s,this.error=new qs,this._api=e;try{this._worker=Hc.createWebWorker(t)}catch(e){return void ee.error("Rendering",`Failed to create WebWorker: ${e}`)}this._worker.postMessage({cmd:"alphaTab.initialize",settings:this.serializeSettingsForWorker(t)}),this._worker.addEventListener("message",this.handleWorkerMessage.bind(this))}destroy(){this._worker.terminate()}updateSettings(e){this._worker.postMessage({cmd:"alphaTab.updateSettings",settings:this.serializeSettingsForWorker(e)})}serializeSettingsForWorker(e){const t=Ar.settingsToJsObject(Hc.prepareForPostMessage(e));return t.delete("player"),t}render(){this._worker.postMessage({cmd:"alphaTab.render"})}resizeRender(){this._worker.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(e){this._worker.postMessage({cmd:"alphaTab.renderResult",resultId:e})}get width(){return this._width}set width(e){this._width=e,this._worker.postMessage({cmd:"alphaTab.setWidth",width:e})}handleWorkerMessage(e){const t=e.data;switch(t.cmd){case"alphaTab.preRender":this.preRender.trigger(t.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(t.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(t.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(t.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=Yr.fromJson(t.boundsLookup,this._api.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(t.error)}}renderScore(e,t){const s=null==e?null:Ar.scoreToJsObject(Hc.prepareForPostMessage(e));this._worker.postMessage({cmd:"alphaTab.renderScore",score:s,trackIndexes:Hc.prepareForPostMessage(t),fontSizes:Wr.FontSizeLookupTables})}}class Rn{constructor(e,t,s,i){this.cursorWrapper=e,this.barCursor=t,this.beatCursor=s,this.selectionWrapper=i}}class On extends Cn{constructor(e,t,s){super(e),this._xscale=t,this._yscale=s}get width(){return this.element.offsetWidth/this._xscale}set width(e){this.element.style.width=e*this._xscale+"px"}get height(){return this.element.offsetHeight/this._yscale}set height(e){this.element.style.height=e>=0?e*this._yscale+"px":"100%"}setBounds(e,t,s,i){Number.isNaN(e)&&(e=this.lastBounds.x),Number.isNaN(t)&&(t=this.lastBounds.y),Number.isNaN(s)?s=this.lastBounds.w:s/=this._xscale,Number.isNaN(i)?i=this.lastBounds.h:i/=this._yscale,this.element.style.transform=`translate(${e}px, ${t}px) scale(${s}, ${i})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=s,this.lastBounds.h=i}}class Wn{constructor(){this.sampleRate=44100,this._updateInterval=0,this.ready=new $s,this.samplesPlayed=new qs,this.timeUpdate=new qs,this.sampleRequest=new $s}get backingTrackDuration(){const e=this.audioElement.duration??0;return Number.isFinite(e)?1e3*e:0}get playbackRate(){return this.audioElement.playbackRate}set playbackRate(e){this.audioElement.playbackRate=e}get masterVolume(){return this.audioElement.volume}set masterVolume(e){this.audioElement.volume=e}seekTo(e){this.audioElement.currentTime=e/1e3}loadBackingTrack(e){this.audioElement?.src&&URL.revokeObjectURL(this.audioElement.src);const t=new Blob([e.rawAudioFile]),s=this.audioElement.playbackRate;this.audioElement.src=URL.createObjectURL(t),this.audioElement.playbackRate=s}open(e){const t=document.createElement("audio");t.style.display="none",document.body.appendChild(t),t.addEventListener("seeked",()=>{this.updatePosition()}),t.addEventListener("timeupdate",()=>{this.updatePosition()}),this.audioElement=t,this.ready.trigger()}updatePosition(){const e=1e3*this.audioElement.currentTime;this.timeUpdate.trigger(e)}play(){this.audioElement.play(),this._updateInterval=window.setInterval(()=>{this.updatePosition()},50)}destroy(){const e=this.audioElement;e&&document.body.removeChild(e)}pause(){this.audioElement.pause(),window.clearInterval(this._updateInterval)}addSamples(e){}resetSamples(){}activate(){}async enumerateOutputDevices(){return Qs.enumerateOutputDevices()}async setOutputDevice(e){await Qs.checkSinkIdSupport()&&(e?await this.audioElement.setSinkId(e.deviceId):await this.audioElement.setSinkId(""))}async getOutputDevice(){if(!await Qs.checkSinkIdSupport())return null;const e=this.audioElement.sinkId;if("string"!=typeof e||""===e||"default"===e)return null;let t=Qs.findKnownDevice(e);if(t)return t;const s=await this.enumerateOutputDevices();return t=s.find(t=>t.deviceId===e),t||(ee.warning("WebAudio","Could not find output device in device list",e,s),null)}}class Hn{constructor(e,t){this._promise=null,this._exporterId=Hn._nextExporterId++,this._worker=e,this._ownsWorker=t}async initialize(e,t,s,i){const a=this.handleWorkerMessage.bind(this);this._worker.worker.addEventListener("message",a,!1),this._unsubscribe=()=>{this._worker.worker.removeEventListener("message",a,!1)},this._promise=Promise.withResolvers(),this._worker.worker.postMessage({cmd:"alphaSynth.exporter.initialize",exporterId:this._exporterId,options:Hc.prepareForPostMessage(e),midi:Ar.midiFileToJsObject(Hc.prepareForPostMessage(t)),syncPoints:Hc.prepareForPostMessage(s),transpositionPitches:Hc.prepareForPostMessage(i)}),await this._promise.promise}handleWorkerMessage(t){const s=t.data;if(s.exporterId!==this._exporterId)return;switch(s.cmd){case"alphaSynth.exporter.initialized":this._promise?.resolve(null),this._promise=null;break;case"alphaSynth.exporter.error":this._promise?.reject(s.error),this._promise=null;break;case"alphaSynth.exporter.rendered":this._promise?.resolve(s.chunk),this._promise=null;break;case"alphaSynth.destroyed":this._promise?.reject(new O(e.AlphaTabErrorType.General,"Worker was destroyed")),this._promise=null}}async render(t){if(this._promise)throw new O(e.AlphaTabErrorType.General,"There is already an ongoing operation, wait for initialize to complete before requesting render");return this._promise=Promise.withResolvers(),this._worker.worker.postMessage({cmd:"alphaSynth.exporter.render",exporterId:this._exporterId,milliseconds:t}),await this._promise.promise}destroy(){this._worker.worker.postMessage({cmd:"alphaSynth.exporter.destroy",exporterId:this._exporterId}),this._unsubscribe(),this._ownsWorker&&this._worker.destroy()}[Symbol.dispose](){this.destroy()}}Hn._nextExporterId=1,function(e){e[e.LayoutDone=0]="LayoutDone",e[e.RenderRequested=1]="RenderRequested",e[e.RenderDone=2]="RenderDone",e[e.Detached=3]="Detached"}(qt||(qt={}));class Gn{get resizeThrottle(){return 10}get canRender(){return this.areAllFontsLoaded()}areAllFontsLoaded(){let e=!1;for(const t of this._fontCheckers.values())t.isFontLoaded||(e=!0);return!e&&(ee.debug("Font",`All fonts loaded: ${this._fontCheckers.size}`),!0)}onFontLoaded(e){Wr.generateFontLookup(e),this.areAllFontsLoaded()&&this.canRenderChanged.trigger()}constructor(t){if(this._fontCheckers=new Map,this._contents=null,this._file=null,this._totalResultCount=0,this._initialTrackIndexes=null,this._barToElementLookup=new Map,this._resultIdToElementLookup=new Map,this.rootContainerBecameVisible=new $s,this.canRenderChanged=new $s,this._highlightedElements=[],this._scrollContainer=null,Hc.webPlatform!==e.WebPlatform.Browser&&Hc.webPlatform!==e.WebPlatform.BrowserModule)throw new O(e.AlphaTabErrorType.General,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");t.classList.add("alphaTab"),this.rootContainer=new Cn(t),this.areWorkersSupported="Worker"in window,this._intersectionObserver=new IntersectionObserver(this.onElementVisibilityChanged.bind(this),{threshold:[0,.01,1]}),this._intersectionObserver.observe(t)}onElementVisibilityChanged(e){for(const t of e){const e=t.target;if(e===this.rootContainer.element)t.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this._intersectionObserver.unobserve(this.rootContainer.element));else if("layoutResultId"in e&&this._api.settings.core.enableLazyLoading){const s=e;t.isIntersecting?s.renderedResultId!==s.layoutResultId?this._resultIdToElementLookup.has(s.layoutResultId)?s.resultState!==qt.RenderRequested&&(s.resultState=qt.RenderRequested,this._api.renderer.renderResult(s.layoutResultId)):e.replaceChildren():s.resultState===qt.Detached&&(e.replaceChildren(...s.renderedResult),s.resultState=qt.RenderDone):s.resultState===qt.RenderDone&&(s.resultState=qt.Detached,s.replaceChildren())}}}createWorkerRenderer(){return new An(this._api,this._api.settings)}initialize(t,s){let i;this._api=t,i=s instanceof hr?s:Ar.jsObjectToSettings(s);const a=this.getDataAttributes();nr.fromJson(i,a),i.notation.notationMode===e.NotationMode.SongBook&&i.setSongBookModeSettings(),t.settings=i,this.setupFontCheckers(i),this._initialTrackIndexes=this.parseTracks(i.core.tracks),this._contents="";const r=t.container;i.core.tex&&(this._contents=r.element.innerHTML,r.element.innerHTML=""),this.createStyleElements(i),this._file=i.core.file}setupFontCheckers(e){this.registerFontChecker(e.display.resources.copyrightFont),this.registerFontChecker(e.display.resources.effectFont),this.registerFontChecker(e.display.resources.graceFont),this.registerFontChecker(e.display.resources.markerFont),this.registerFontChecker(e.display.resources.tablatureFont),this.registerFontChecker(e.display.resources.titleFont),this.registerFontChecker(e.display.resources.wordsFont),this.registerFontChecker(e.display.resources.barNumberFont),this.registerFontChecker(e.display.resources.fretboardNumberFont),this.registerFontChecker(e.display.resources.subTitleFont)}registerFontChecker(e){if(!this._fontCheckers.has(e.families.join(", "))){const t=new Dn(e.families);this._fontCheckers.set(e.families.join(", "),t),t.fontLoaded.on(this.onFontLoaded.bind(this)),t.checkForFontAvailability()}}destroy(){this.rootContainer.element.innerHTML="";const e=this._webFont;e.usages--,e.usages<=0&&(e.element.remove(),Gn._registeredWebFonts.delete(e.hash))}createCanvasElement(){const e=document.createElement("div");return e.classList.add("at-surface",`at${this._webFont.fontSuffix}`),e.style.fontSize="0",e.style.overflow="hidden",e.style.lineHeight="0",e.style.position="relative",new Cn(e)}triggerEvent(e,t,s=null,i){const a=e.element;t=`alphaTab.${t}`;const r=document.createEvent("CustomEvent"),n=i?i.mouseEvent:null;if(r.initCustomEvent(t,!1,!1,s),n&&(r.originalEvent=n),a.dispatchEvent(r),window&&"jQuery"in window){const e=window.jQuery,i=[];i.push(s),n&&i.push(n),e(a).trigger(t,i)}}load(e,t,s){if(e instanceof Ke)return t(e),!0;if(e instanceof ArrayBuffer){const s=new Uint8Array(e);return t(Mn.loadScoreFromBytes(s,this._api.settings)),!0}return e instanceof Uint8Array?(t(Mn.loadScoreFromBytes(e,this._api.settings)),!0):"string"==typeof e&&(Mn.loadScoreAsync(e,t,s,this._api.settings),!0)}loadSoundFont(e,t){return!!this._api.player&&(e instanceof ArrayBuffer?(this._api.player.loadSoundFont(new Uint8Array(e),t),!0):e instanceof Uint8Array?(this._api.player.loadSoundFont(e,t),!0):"string"==typeof e&&(this._api.loadSoundFontFromUrl(e,t),!0))}initialRender(){this._api.renderer.preRender.on(e=>{this._totalResultCount=0,this._resultIdToElementLookup.clear(),this._barToElementLookup.clear()});const e=()=>{this._api.renderer.width=0|this.rootContainer.width,this._api.renderer.updateSettings(this._api.settings),this._contents?(this._api.tex(this._contents,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null):this._file&&Mn.loadScoreAsync(this._file,e=>{this._api.renderScore(e,this._initialTrackIndexes??void 0),this._initialTrackIndexes=null},e=>{this._api.onError(e)},this._api.settings)};this.rootContainer.isVisible?e():this.rootContainerBecameVisible.on(e)}createStyleElements(e){const t=this._api.container.element.ownerDocument;Gn.createSharedStyleElement(t);const s=e.core.smuflFontSources??Vc.buildDefaultSmuflFontSources(e.core.fontDirectory),i=Gn.cyrb53(s.values()),a=Gn._registeredWebFonts;if(a.has(i)){const e=a.get(i);return e.usages++,e.checker.fontLoaded.on(this.onFontLoaded.bind(this)),void(this._webFont=e)}const r=0===a.size?"":String(a.size),n=`alphaTab${r}`,o=`\n            @font-face {\n                font-display: block;\n                font-family: '${n}';\n                src: ${Array.from(s.entries()).map(e=>`url(${JSON.stringify(e[1])}) format('${Gn.cssFormat(e[0])}')`).join(",")};\n                font-weight: normal;\n                font-style: normal;\n            }\n            .at-surface.at${r} .at {\n                font-family: '${n}';\n                speak: none;\n                font-style: normal;\n                font-weight: normal;\n                font-variant: normal;\n                text-transform: none;\n                line-height: 1;\n                line-height: 1;\n                -webkit-font-smoothing: antialiased;\n                -moz-osx-font-smoothing: grayscale;\n                font-size: ${e.display.resources.engravingSettings.musicFontSize}px;\n                overflow: visible !important;\n            }`,h=t.createElement("style");h.id=`alphaTabStyle${r}`,h.innerHTML=o,t.getElementsByTagName("head").item(0).appendChild(h);const l=new Dn([n]);l.fontLoaded.on(this.onFontLoaded.bind(this)),this._fontCheckers.set(n,l),l.checkForFontAvailability(),e.display.resources.smuflFontFamilyName=n;const c={hash:i,element:h,fontSuffix:r,usages:1,checker:l};a.set(i,c),this._webFont=c}static cssFormat(t){switch(t){case e.FontFileFormat.EmbeddedOpenType:return"embedded-opentype";case e.FontFileFormat.Woff:return"woff";case e.FontFileFormat.Woff2:return"woff2";case e.FontFileFormat.OpenType:return"opentype";case e.FontFileFormat.TrueType:return"truetype";case e.FontFileFormat.Svg:return"svg"}}static cyrb53(e,t=0){let s=3735928559^t,i=1103547991^t;for(const t of e)for(let e=0;e<t.length;e++){const a=t.charCodeAt(e);s=Math.imul(s^a,2654435761),i=Math.imul(i^a,1597334677)}return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(s^s>>>13,3266489909),4294967296*(2097151&i)+(s>>>0)}static createSharedStyleElement(e){let t=e.getElementById("alphaTabStyle");if(!t){t=document.createElement("style"),t.id="alphaTabStyleShared";const e="\n                .at-surface * {\n                    cursor: default;\n                    vertical-align: top;\n                    overflow: visible;\n                }\n                .at-surface-svg text {\n                    dominant-baseline: alphabetic;\n                    white-space:pre;\n                }";t.innerHTML=e,document.getElementsByTagName("head").item(0).appendChild(t)}}parseTracks(e){if(!e)return[];const t=[];if("string"==typeof e)try{if("all"===e)return[-1];e=JSON.parse(e)}catch{e=[0]}if("number"==typeof e)t.push(e);else if("length"in e){const s=e.length,i=e;for(let e=0;e<s;e++){const s=i[e];let a=0;a="number"==typeof s?s:"index"in s?s.index:Number.parseInt(s.toString(),10),(a>=0||-1===a)&&t.push(a)}}else"index"in e&&t.push(e.index);return t}getDataAttributes(){const e=new Map,t=this._api.container.element;if(t.dataset)for(const s of Object.keys(t.dataset)){let i=t.dataset[s];try{const e=i;i=JSON.parse(e)}catch{""===i&&(i=null)}e.set(s,i)}else for(let s=0;s<t.attributes.length;s++){const i=t.attributes.item(s),a=i.nodeName;if(a.startsWith("data-")){const t=a.substr(5).split("-");let s=t[0];for(let e=1;e<t.length;e++)s+=t[e].substr(0,1).toUpperCase()+t[e].substr(1);let r=i.nodeValue;try{r=JSON.parse(r)}catch{""===r&&(r=null)}e.set(s,r)}}return e}beginUpdateRenderResults(e){if(!this._resultIdToElementLookup.has(e.id))return;const t=this._resultIdToElementLookup.get(e.id),s=e.renderResult;"string"==typeof s?t.innerHTML=s:"nodeType"in s&&t.replaceChildren(s),t.resultState=qt.RenderDone,t.renderedResultId=e.id,t.renderedResult=Array.from(t.children)}beginAppendRenderResults(e){const t=this._api.canvasElement.element;if(e){let s;this._totalResultCount<t.childElementCount?s=t.childNodes.item(this._totalResultCount):(s=document.createElement("div"),t.appendChild(s)),s.style.zIndex="1",s.style.position="absolute",s.style.left=`${e.x}px`,s.style.top=`${e.y}px`,s.style.width=`${e.width}px`,s.style.height=`${e.height}px`,s.style.display="inline-block",s.layoutResultId=e.id,s.resultState=qt.LayoutDone,s.renderedResultId=void 0,s.renderedResult=void 0,this._resultIdToElementLookup.set(e.id,s);for(let t=e.firstMasterBarIndex;t<=e.lastMasterBarIndex;t++)t>=0&&this._barToElementLookup.set(t,s);this._api.settings.core.enableLazyLoading&&(this._intersectionObserver.unobserve(s),this._intersectionObserver.observe(s)),this._totalResultCount++}else for(;t.childElementCount>this._totalResultCount;)this._api.settings.core.enableLazyLoading&&this._intersectionObserver.unobserve(t.lastChild),t.removeChild(t.lastElementChild)}createWorkerPlayer(){let t=null;const s="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&this._api.settings.player.outputMode===e.PlayerOutputMode.WebAudioAudioWorklets?(ee.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),t=new In(new ti(this._api.settings),this._api.settings)):s&&(ee.debug("Player","Will use webworkers for synthesizing and web audio api with ScriptProcessor for playback"),t=new In(new Ln,this._api.settings)),t?t.ready.on(()=>{this._api.settings.player.soundFont&&this._api.loadSoundFontFromUrl(this._api.settings.player.soundFont,!1)}):ee.error("Player","Player requires webworkers and web audio api, browser unsupported",null),t}createWorkerAudioExporter(e){const t=null===e||!(e instanceof In);return t&&(e=this.createWorkerPlayer()),new Hn(e,t)}beginInvoke(e){window.requestAnimationFrame(()=>{e()})}highlightElements(e,t){const s=this._barToElementLookup.get(t);if(s){const t=s.getElementsByClassName(e);for(let e=0;e<t.length;e++)t.item(e).classList.add("at-highlight"),this._highlightedElements.push(t.item(e))}}removeHighlights(){const e=this._highlightedElements;if(e){for(const t of e)t.classList.remove("at-highlight");this._highlightedElements=[]}}destroyCursors(){const e=this._api.container.element,t=e.querySelector(".at-cursors");e.removeChild(t)}createCursors(){const e=this._api.container.element,t=document.createElement("div");t.classList.add("at-cursors");const s=document.createElement("div");s.classList.add("at-selection");const i=this.createScalingElement(),a=this.createScalingElement(),r=i.element;r.classList.add("at-cursor-bar");const n=a.element;return n.classList.add("at-cursor-beat"),e.style.position="relative",e.style.textAlign="left",t.style.position="absolute",t.style.zIndex="1000",t.style.display="inline",t.style.pointerEvents="none",s.style.position="absolute",r.style.position="absolute",r.style.left="0",r.style.top="0",r.style.willChange="transform",i.width=1,i.height=1,i.setBounds(0,0,1,1),n.style.position="absolute",n.style.transition="all 0s linear",n.style.left="0",n.style.top="0",n.style.willChange="transform",a.width=3,a.height=1,a.setBounds(0,0,1,1),e.insertBefore(t,e.firstChild),t.appendChild(s),t.appendChild(r),t.appendChild(n),new Rn(new Cn(t),i,a,new Cn(s))}getOffset(e,t){const s=t.element,i=s.getBoundingClientRect();let a=i.top+s.ownerDocument.defaultView.pageYOffset,r=i.left+s.ownerDocument.defaultView.pageXOffset;if(e){const t=e.element,s=t.nodeName.toLowerCase();if("html"!==s&&"body"!==s){const s=this.getOffset(null,e);a=a+t.scrollTop-s.y,r=r+t.scrollLeft-s.x}}const n=new Ts;return n.x=r,n.y=a,n.w=i.width,n.h=i.height,n}getScrollContainer(){if(this._scrollContainer)return this._scrollContainer;let e="string"==typeof this._api.settings.player.scrollElement?document.querySelector(this._api.settings.player.scrollElement):this._api.settings.player.scrollElement;const t=e.nodeName.toLowerCase();if("html"===t||"body"===t)if("scrollingElement"in document)e=document.scrollingElement;else{e=-1!==navigator.userAgent.indexOf("WebKit")?document.body:document.documentElement}return this._scrollContainer=new Cn(e),this._scrollContainer}createSelectionElement(){return this.createScalingElement()}createScalingElement(){const e=document.createElement("div");e.style.position="absolute";const t=new On(e,100,100);return t.width=1,t.height=1,t.setBounds(0,0,1,1),t}scrollToY(e,t,s){this.internalScrollToY(e.element,t,s)}scrollToX(e,t,s){this.internalScrollToX(e.element,t,s)}internalScrollToY(e,t,s){if(this._api.settings.player.nativeBrowserSmoothScroll)e.scrollTo({top:t,behavior:"smooth"});else{const i=e.scrollTop,a=t-i;let r=0;const n=t=>{0===r&&(r=t);const o=t-r,h=Math.min(o/s,1);e.scrollTop=i+a*h|0,o<s&&window.requestAnimationFrame(n)};window.requestAnimationFrame(n)}}internalScrollToX(e,t,s){if(this._api.settings.player.nativeBrowserSmoothScroll)e.scrollTo({left:t,behavior:"smooth"});else{const i=e.scrollLeft,a=t-i;let r=0;const n=t=>{0===r&&(r=t);const o=t-r,h=Math.min(o/s,1);e.scrollLeft=i+a*h|0,o<s&&window.requestAnimationFrame(n)};window.requestAnimationFrame(n)}}createBackingTrackPlayer(){return new kn(new Wn,this._api.settings.player.bufferTimeInMilliseconds)}}Gn._registeredWebFonts=new Map;class Vn{constructor(e,t){this.loaded=e,this.total=t}}class Un extends vn{constructor(e,t){super(new Gn(e),t),this.soundFontLoad=new qs}tex(e,t){const s=this.uiFacade;super.tex(e,s.parseTracks(t))}print(t,s=null){const i=window.open("","","width=0,height=0"),a=i.document.createElement("div");t?a.style.width=t:this.settings.display.layoutMode===e.LayoutMode.Horizontal?a.style.width="297mm":a.style.width="210mm",i.document.write("\n        <!DOCTYPE html>\n        <html>\n          <head>\n            <style>\n            .at-surface {\n                width: auto !important;\n                height: auto !important;\n            }\n            .at-surface > div {\n                position: relative!important;\n                left: auto !important;\n                top: auto !important;\n                break-inside: avoid;\n            }\n            </style>\n          </head>\n          <body></body>\n        </html>\n        ");const r=this.score;r&&(r.artist&&r.title?i.document.title=`${r.title} - ${r.artist}`:r.title&&(i.document.title=`${r.title}`)),i.document.body.appendChild(a);const n=void 0!==window.screenLeft?window.screenLeft:window.left,o=void 0!==window.screenTop?window.screenTop:window.top,h="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,l="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,c=a.offsetWidth+50,d=window.innerHeight,u=(h/2|0)-(c/2|0)+n,p=(l/2|0)-(d/2|0)+o;i.resizeTo(c,d),i.moveTo(u,p),i.focus();const m=Ar.jsObjectToSettings(Ar.settingsToJsObject(this.settings));m.core.enableLazyLoading=!1,m.core.useWorkers=!0,m.core.file=null,m.core.tracks=null,m.player.enableCursor=!1,m.player.playerMode=e.PlayerMode.Disabled,m.player.enableElementHighlighting=!1,m.player.enableUserInteraction=!1,m.player.soundFont=null,m.display.scale=.8,m.display.stretchForce=.8,nr.fromJson(m,s);const g=new Un(a,m);i.onunload=()=>{g.destroy()},g.renderer.postRenderFinished.on(()=>{i.print()}),g.renderTracks(this.tracks)}downloadMidi(e=Et.SingleTrackMultiChannel){if(!this.score)return;const t=new ii;t.format=e;const s=new jr(t,!0);new cn(this.score,this.settings,s).generate();const i=t.toBinary(),a=this.score.title?`${this.score.title}.mid`:"File.mid",r=document.createElement("a");r.download=a;const n=new Blob([i],{type:"audio/midi"}),o=URL.createObjectURL(n);r.href=o,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}changeTrackMute(e,t){const s=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackMute(s,t)}changeTrackSolo(e,t){const s=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackSolo(s,t)}changeTrackVolume(e,t){const s=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackVolume(s,t)}trackIndexesToTracks(e){if(!this.score)return[];const t=[];if(1===e.length&&-1===e[0])for(const e of this.score.tracks)t.push(e);else for(const s of e)s>=0&&s<this.score.tracks.length&&t.push(this.score.tracks[s]);return t}loadSoundFontFromUrl(e,t){const s=this.player;if(!s)return;ee.debug("AlphaSynth",`Start loading Soundfont from url ${e}`);const i=new XMLHttpRequest;i.open("GET",e,!0,null,null),i.responseType="arraybuffer",i.onload=e=>{const s=new Uint8Array(i.response);this.loadSoundFont(s,t)},i.onerror=e=>{ee.error("AlphaSynth",`Loading failed: ${e.message}`),s.soundFontLoadFailed.trigger(new En(e.message,i))},i.onprogress=e=>{ee.debug("AlphaSynth",`Soundfont downloading: ${e.loaded}/${e.total} bytes`);const t=new Vn(e.loaded,e.total);this.soundFontLoad.trigger(t),this.uiFacade.triggerEvent(this.container,"soundFontLoad",t)},i.send()}}class zn{constructor(){this._initListeners=[]}exec(e,t,s){if("string"!=typeof t&&(s=[t],t="init"),95===t.charCodeAt(0)||"exec"===t)return null;const i=new jQuery(e),a=i.data("alphaTab");if("destroy"===t&&!a)return null;if("init"!==t&&!a)throw new Error("alphaTab not initialized");const r=this[t];if(r){const e=[i,a].concat(s);return r.apply(this,e)}return ee.error("Api",`Method '${t}' does not exist on jQuery.alphaTab`),null}init(e,t,s){if(!t){t=new Un(e[0],s),e.data("alphaTab",t);for(const i of this._initListeners)i(e,t,s)}}destroy(e,t){e.removeData("alphaTab"),t.destroy()}print(e,t,s,i){t.print(s,i)}load(e,t,s,i){return t.load(s,i)}render(e,t){t.render()}renderScore(e,t,s,i){t.renderScore(s,i)}renderTracks(e,t,s){t.renderTracks(s)}invalidate(e,t){t.render()}tex(e,t,s,i){t.tex(s,i)}muteTrack(e,t,s,i){t.changeTrackMute(s,i)}soloTrack(e,t,s,i){t.changeTrackSolo(s,i)}trackVolume(e,t,s,i){t.changeTrackVolume(s,i)}loadSoundFont(e,t,s,i){t.loadSoundFont(s,i)}resetSoundFonts(e,t){t.resetSoundFonts()}pause(e,t){t.pause()}play(e,t){return t.play()}playPause(e,t){t.playPause()}stop(e,t){t.stop()}api(e,t){return t}player(e,t){return t.player}isReadyForPlayback(e,t){return t.isReadyForPlayback}playerState(e,t){return t.playerState}masterVolume(e,t,s){return"number"==typeof s&&(t.masterVolume=s),t.masterVolume}metronomeVolume(e,t,s){return"number"==typeof s&&(t.metronomeVolume=s),t.metronomeVolume}countInVolume(e,t,s){return"number"==typeof s&&(t.countInVolume=s),t.countInVolume}midiEventsPlayedFilter(e,t,s){return Array.isArray(s)&&(t.midiEventsPlayedFilter=s),t.midiEventsPlayedFilter}playbackSpeed(e,t,s){return"number"==typeof s&&(t.playbackSpeed=s),t.playbackSpeed}tickPosition(e,t,s){return"number"==typeof s&&(t.tickPosition=s),t.tickPosition}timePosition(e,t,s){return"number"==typeof s&&(t.timePosition=s),t.timePosition}loop(e,t,s){return"boolean"==typeof s&&(t.isLooping=s),t.isLooping}renderer(e,t){return t.renderer}score(e,t){return t.score}settings(e,t){return t.settings}tracks(e,t){return t.tracks}_oninit(e){this._initListeners.push(e)}static restore(e){new jQuery(e).empty().removeData("alphaTab")}}var Xn,Yn,Jn,$n,qn,jn,Kn="function"==typeof SuppressedError?SuppressedError:function(e,t,s){var i=new Error(s);return i.name="SuppressedError",i.error=e,i.suppressed=t,i};class Qn{static enable(e,t){Qn.alphaSkia=t,Qn.initializeMusicFont(Qn.alphaSkia.AlphaSkiaTypeface.register(e))}static initializeMusicFont(e){Qn.defaultMusicTextStyle=new Qn.alphaSkia.AlphaSkiaTextStyle([e.familyName],e.weight,e.isItalic)}static registerFont(e,t){const s=Qn.alphaSkia.AlphaSkiaTypeface.register(e.buffer);return t||(t=Wa.withFamilyList([s.familyName],12,s.isItalic?Wt.Italic:Wt.Plain,s.weight>400?Ht.Bold:Ht.Regular)),t}get font(){return this._font}set font(e){if(this._font===e)return;this._font=e;const t=this.textStyleKey(e);if(this._textStyles.has(t))this._textStyle=this._textStyles.get(t);else{const s=new Qn.alphaSkia.AlphaSkiaTextStyle(e.families,e.weight===Ht.Bold?700:400,e.isItalic);this._textStyles.set(t,s),this._textStyle=s}}textStyleKey(e){return[...e.families,e.weight.toString(),e.isItalic?"italic":"upright"].join("_")}constructor(){this._color=new at(0,0,0,0),this._lineWidth=0,this._textStyle=null,this._scale=1,this._textStyles=new Map,this._font=new Wa("Arial",10,Wt.Plain),this._musicTextStyle=null,this.textAlign=we.Left,this.textBaseline=Be.Top,this._canvas=new Qn.alphaSkia.AlphaSkiaCanvas,this.color=new at(0,0,0,255)}destroy(){this._canvas[Symbol.dispose]();for(const e of this._textStyles.values())e[Symbol.dispose]()}onRenderFinished(){return null}beginRender(e,t){this._scale=this.settings.display.scale,this._canvas.beginRender(e,t,Hc.HighDpiFactor);const s=this.settings.display.resources.smuflFontFamilyName;s&&s!==Qn.defaultMusicTextStyle.familyNames[0]?this._textStyles.has(s)?this._musicTextStyle=this._textStyles.get(s):(this._musicTextStyle=new Qn.alphaSkia.AlphaSkiaTextStyle([s],Qn.defaultMusicTextStyle.weight,Qn.defaultMusicTextStyle.isItalic),this._textStyles.set(s,this._musicTextStyle)):this._musicTextStyle=Qn.defaultMusicTextStyle}endRender(){return this._canvas.endRender()}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._canvas.color=Qn.alphaSkia.AlphaSkiaCanvas.rgbaToColor(e.r,e.g,e.b,e.a))}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._canvas.lineWidth=e}fillRect(e,t,s,i){s>0&&this._canvas.fillRect(e*this._scale,t*this._scale,s*this._scale,i*this._scale)}strokeRect(e,t,s,i){const a=this.lineWidth%2==0?0:.5;this._canvas.strokeRect(e*this._scale+a,t*this._scale+a,s*this._scale,i*this._scale)}beginPath(){this._canvas.beginPath()}closePath(){this._canvas.closePath()}moveTo(e,t){this._canvas.moveTo(e*this._scale,t*this._scale)}lineTo(e,t){this._canvas.lineTo(e*this._scale,t*this._scale)}quadraticCurveTo(e,t,s,i){this._canvas.quadraticCurveTo(e*this._scale,t*this._scale,s*this._scale,i*this._scale)}bezierCurveTo(e,t,s,i,a,r){this._canvas.bezierCurveTo(e*this._scale,t*this._scale,s*this._scale,i*this._scale,a*this._scale,r*this._scale)}fillCircle(e,t,s){this._canvas.fillCircle(e*this._scale,t*this._scale,s*this._scale)}strokeCircle(e,t,s){this._canvas.strokeCircle(e*this._scale,t*this._scale,s*this._scale)}fill(){this._canvas.fill()}stroke(){this._canvas.stroke()}beginGroup(e){}endGroup(){}fillText(e,t,s){if(0===e.length)return;let i=Qn.alphaSkia.AlphaSkiaTextAlign.Left;switch(this.textAlign){case we.Left:i=Qn.alphaSkia.AlphaSkiaTextAlign.Left;break;case we.Center:i=Qn.alphaSkia.AlphaSkiaTextAlign.Center;break;case we.Right:i=Qn.alphaSkia.AlphaSkiaTextAlign.Right}let a=Qn.alphaSkia.AlphaSkiaTextBaseline.Top;switch(this.textBaseline){case Be.Top:a=Qn.alphaSkia.AlphaSkiaTextBaseline.Top;break;case Be.Middle:a=Qn.alphaSkia.AlphaSkiaTextBaseline.Middle;break;case Be.Bottom:a=Qn.alphaSkia.AlphaSkiaTextBaseline.Bottom;break;case Be.Alphabetic:a=Qn.alphaSkia.AlphaSkiaTextBaseline.Alphabetic}this._canvas.fillText(e,this._textStyle,this._font.size*this._scale,t*this._scale,s*this._scale,i,a)}measureText(e){const t={stack:[],error:void 0,hasError:!1};try{const s=function(e,t,s){if(null!=t){if("object"!=typeof t&&"function"!=typeof t)throw new TypeError("Object expected.");var i,a;if(s){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");i=t[Symbol.asyncDispose]}if(void 0===i){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");i=t[Symbol.dispose],s&&(a=i)}if("function"!=typeof i)throw new TypeError("Object not disposable.");a&&(i=function(){try{a.call(this)}catch(e){return Promise.reject(e)}}),e.stack.push({value:t,dispose:i,async:s})}else s&&e.stack.push({async:!0});return t}(t,this._canvas.measureText(e,this._textStyle,this._font.size,Qn.alphaSkia.AlphaSkiaTextAlign.Left,Qn.alphaSkia.AlphaSkiaTextBaseline.Alphabetic),!1),[i,a]=this.getTextWidthAndHeight(s,e);return new Je(i,a)}catch(e){t.error=e,t.hasError=!0}finally{!function(e){function t(t){e.error=e.hasError?new Kn(t,e.error,"An error was suppressed during disposal."):t,e.hasError=!0}var s,i=0;(function a(){for(;s=e.stack.pop();)try{if(!s.async&&1===i)return i=0,e.stack.push(s),Promise.resolve().then(a);if(s.dispose){var r=s.dispose.call(s.value);if(s.async)return i|=2,Promise.resolve(r).then(a,function(e){return t(e),a()})}else i|=1}catch(e){t(e)}if(1===i)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error})()}(t)}}getTextWidthAndHeight(e,t){let s=e.width;if(t.length>0&&s<1)for(let t=0;t<5&&(s=e.width,!(s>1));t++);return[s,e.actualBoundingBoxAscent+e.actualBoundingBoxDescent]}fillMusicFontSymbol(e,t,s,i,a){i!==ne.None&&this.fillMusicFontSymbolText(e,t,s,String.fromCharCode(i),a)}fillMusicFontSymbols(e,t,s,i,a){let r="";for(const e of i)e!==ne.None&&(r+=String.fromCharCode(e));this.fillMusicFontSymbolText(e,t,s,r,a)}fillMusicFontSymbolText(e,t,s,i,a){this._canvas.fillText(i,this._musicTextStyle,this.settings.display.resources.engravingSettings.musicFontSize*this._scale*s,e*this._scale,t*this._scale,a?Qn.alphaSkia.AlphaSkiaTextAlign.Center:Qn.alphaSkia.AlphaSkiaTextAlign.Left,Qn.alphaSkia.AlphaSkiaTextBaseline.Alphabetic)}beginRotate(e,t,s){this._canvas.beginRotate(e*this._scale,t*this._scale,s)}endRotate(){this._canvas.endRotate()}}Qn.defaultMusicTextStyle=null;class Zn{constructor(){this.buffer="",this._currentPath="",this._currentPathIsEmpty=!0,this.scale=1,this.color=new at(255,255,255,255),this.lineWidth=1,this.font=new Wa("Arial",10,Wt.Plain),this.textAlign=we.Left,this.textBaseline=Be.Top}destroy(){}beginRender(e,t){this.scale=this.settings.display.scale,this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${0|e}px" height="${0|t}px" class="at-surface-svg">\n`,this._currentPath="",this._currentPathIsEmpty=!0,this.textBaseline=Be.Top}beginGroup(e){this.buffer+=`<g class="${e}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(e,t,s,i){s>0&&(this.buffer+=`<rect x="${e*this.scale}" y="${t*this.scale}" width="${s*this.scale}" height="${i*this.scale}" fill="${this.color.rgba}" />\n`)}strokeRect(e,t,s,i){const a=this.lineWidth*this.scale%2==0?0:.5;this.buffer+=`<rect x="${e*this.scale+a}" y="${t*this.scale+a}" width="${s*this.scale}" height="${i*this.scale}" stroke="${this.color.rgba}"`,1!==this.lineWidth&&(this.buffer+=` stroke-width="${this.lineWidth*this.scale}"`),this.buffer+=' fill="transparent" />\n'}beginPath(){}closePath(){this._currentPath+=" z"}moveTo(e,t){this._currentPath+=` M${e*this.scale},${t*this.scale}`}lineTo(e,t){this._currentPathIsEmpty=!1,this._currentPath+=` L${e*this.scale},${t*this.scale}`}quadraticCurveTo(e,t,s,i){this._currentPathIsEmpty=!1,this._currentPath+=` Q${e*this.scale},${t*this.scale},${s*this.scale},${i*this.scale}`}bezierCurveTo(e,t,s,i,a,r){this._currentPathIsEmpty=!1,this._currentPath+=` C${e*this.scale},${t*this.scale},${s*this.scale},${i*this.scale},${a*this.scale},${r*this.scale}`}fillCircle(e,t,s){this._currentPathIsEmpty=!1,e*=this.scale,t*=this.scale,s*=this.scale,this._currentPath+=` M${e-s},${t} A1,1 0 0,0 ${e+s},${t} A1,1 0 0,0 ${e-s},${t} z`,this.fill()}strokeCircle(e,t,s){this._currentPathIsEmpty=!1,e*=this.scale,t*=this.scale,s*=this.scale,this._currentPath+=` M${e-s},${t} A1,1 0 0,0 ${e+s},${t} A1,1 0 0,0 ${e-s},${t} z`,this.stroke()}fill(){this._currentPathIsEmpty||(this.buffer+=`<path d="${this._currentPath}"`,"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this._currentPath="",this._currentPathIsEmpty=!0}stroke(){if(!this._currentPathIsEmpty){let e=`<path d="${this._currentPath}" stroke="${this.color.rgba}"`;1===this.lineWidth&&1===this.scale||(e+=` stroke-width="${this.lineWidth*this.scale}"`),e+=' style="fill: none" />',this.buffer+=e}this._currentPath="",this._currentPathIsEmpty=!0}fillText(e,t,s){if(""===e)return;let i=`<text x="${t*this.scale}" y="${s*this.scale}" style='stroke: none; font:${this.font.toCssString(this.settings.display.scale)}; ${this.getSvgBaseLine()}'`;"#000000"!==this.color.rgba&&(i+=` fill="${this.color.rgba}"`),this.textAlign!==we.Left&&(i+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),i+=`>${Zn.escapeText(e)}</text>`,this.buffer+=i}static escapeText(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(e){switch(e){case we.Left:return"start";case we.Center:return"middle";case we.Right:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case Be.Top:return"dominant-baseline: hanging";case Be.Bottom:return"dominant-baseline: ideographic";case Be.Alphabetic:return"";case Be.Middle:return"dominant-baseline: middle";default:return""}}measureText(e){return e?Wr.measureString(e,this.font.families,this.font.size,this.font.style,this.font.weight):new Je(0,0)}onRenderFinished(){return null}beginRotate(e,t,s){this.buffer+=`<g transform="translate(${e*this.scale} ,${t*this.scale}) rotate( ${s})">`}endRotate(){this.buffer+="</g>"}}class eo extends Zn{fillMusicFontSymbol(e,t,s,i,a){i!==ne.None&&this.fillMusicFontSymbolText(e,t,s,`&#${i};`,a)}fillMusicFontSymbols(e,t,s,i,a){let r="";for(const e of i)e!==ne.None&&(r+=`&#${e};`);this.fillMusicFontSymbolText(e,t,s,r,a)}fillMusicFontSymbolText(e,t,s,i,a){e*=this.scale,t*=this.scale,this.buffer+=`<g transform="translate(${e} ${t})" class="at" ><text`;const r=this.scale*s;this.buffer+=1!==r?` style="font-size: ${100*r}%; stroke:none"`:' style="stroke:none"',"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),a&&(this.buffer+=` text-anchor="${this.getSvgTextAlignment(we.Center)}"`),this.buffer+=`>${i}</text></g>`}}class to{constructor(){this.isInsideBracket=!0,this.isRelevantForBoundsLookup=!0,this.hideOnMultiTrack=!1,this.hideOnPercussionTrack=!1}canCreate(e,t){return!this.hideOnPercussionTrack||!t.isPercussion}}!function(e){e[e.PreNotes=0]="PreNotes",e[e.OnNotes=1]="OnNotes",e[e.MiddleNotes=2]="MiddleNotes",e[e.Stem=3]="Stem",e[e.PostNotes=4]="PostNotes",e[e.EndBeat=5]="EndBeat"}(Xn||(Xn={}));class so extends un{constructor(){super(...arguments),this.glyphs=null}get isEmpty(){return!this.glyphs||0===this.glyphs.length}getBoundingBoxTop(){let e=0;const t=this.glyphs;if(t)for(const s of t){const t=s.getBoundingBoxTop();t<e&&(e=t)}return e}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);let e=0,t=0;for(let s=0,i=this.glyphs.length;s<i;s++){const i=this.glyphs[s];i.renderer=this.renderer,i.doLayout(),e=Math.max(e,i.width),t=Math.max(t,i.y+i.height)}this.width=e,this.height=t}addGlyph(e){this.glyphs||(this.glyphs=[]),this.renderer&&(e.renderer=this.renderer),this.glyphs.push(e)}paint(e,t,s){const i=this.glyphs;if(i&&0!==i.length)for(const a of i)a.paint(e+this.x,t+this.y,s)}}class io extends so{constructor(){super(0,0),this.gap=0,this.glyphs=[]}doLayout(){}addGlyph(e){e.x=this.width,e.renderer=this.renderer,e.doLayout(),this.width=e.x+e.width+this.gap,super.addGlyph(e)}}class ao{static score(e,t,s,i=!1){if(!s.style&&!i)return;const a=ao.scoreDefaultColor(e.settings.display.resources,t);return new ro(e,t,s.style,a)}static scoreColor(e,t,s){const i=ao.scoreDefaultColor(e,t);if(s.style&&s.style.colors.has(t))return s.style.colors.get(t)??i}static scoreDefaultColor(e,t){return e.mainGlyphColor}static bar(e,t,s,i=!1){if(!s.style&&!i)return;let a=e.settings.display.resources.mainGlyphColor;switch(t){case m.StandardNotationRepeats:case m.GuitarTabsRepeats:case m.SlashRepeats:case m.NumberedRepeats:case m.StandardNotationClef:case m.GuitarTabsClef:case m.StandardNotationKeySignature:case m.NumberedKeySignature:case m.StandardNotationTimeSignature:case m.GuitarTabsTimeSignature:case m.SlashTimeSignature:case m.NumberedTimeSignature:break;case m.StandardNotationBarLines:case m.GuitarTabsBarLines:case m.SlashBarLines:case m.NumberedBarLines:a=e.settings.display.resources.barSeparatorColor;break;case m.StandardNotationBarNumber:case m.SlashBarNumber:case m.NumberedBarNumber:case m.GuitarTabsBarNumber:a=e.settings.display.resources.barNumberColor;break;case m.StandardNotationStaffLine:case m.GuitarTabsStaffLine:case m.SlashStaffLine:case m.NumberedStaffLine:a=e.settings.display.resources.staffLineColor}return new ro(e,t,s.style,a)}static voice(e,t,s,i=!1){if(!s.style&&!i)return;const a=0===s.index?e.settings.display.resources.mainGlyphColor:e.settings.display.resources.secondaryGlyphColor;return new ro(e,t,s.style,a)}static trackColor(e,t,s){const i=ao.trackDefaultColor(e,t);if(s.style&&s.style.colors.has(t))return s.style.colors.get(t)??i}static trackDefaultColor(e,t){let s=e.mainGlyphColor;switch(t){case _e.TrackName:case _e.SystemSeparator:case _e.StringTuning:break;case _e.BracesAndBrackets:s=e.barSeparatorColor}return s}static track(e,t,s,i=!1){if(!s.style&&!i)return;const a=ao.trackDefaultColor(e.settings.display.resources,t);return new ro(e,t,s.style,a)}static beatColor(e,t,s){const i=ao.beatDefaultColor(e,t,s);if(s.style&&s.style.colors.has(t))return s.style.colors.get(t)??i}static beatDefaultColor(e,t,s){return 0===s.voice.index?e.mainGlyphColor:e.secondaryGlyphColor}static beat(e,t,s,i=!1){if(!s.style&&!i)return;const a=ao.beatDefaultColor(e.settings.display.resources,t,s);return new ro(e,t,s.style,a)}static noteColor(e,t,s){const i=ao.noteDefaultColor(e,t,s);if(s.style&&s.style.colors.has(t))return s.style.colors.get(t)??i}static noteDefaultColor(e,t,s){return 0===s.beat.voice.index?e.mainGlyphColor:e.secondaryGlyphColor}static note(e,t,s,i=!1){if(!s.style&&!i)return;const a=0===s.beat.voice.index?e.settings.display.resources.mainGlyphColor:e.settings.display.resources.secondaryGlyphColor;return new ro(e,t,s.style,a)}}class ro{constructor(e,t,s,i){this._canvas=e,s&&s.colors.has(t)?(this._previousColor=e.color,e.color=s.colors.get(t)??i):s||(this._previousColor=e.color,e.color=i)}[Symbol.dispose](){this._previousColor&&(this._canvas.color=this._previousColor)}}class no extends so{constructor(e,t,s){super(e,t),this.voice=s,this.beatGlyphs=[],this.tupletGroups=[]}scaleToWidth(e){const t=this.renderer.layoutingInfo.spaceToForce(e);this.scaleToForce(t)}scaleToForce(e){this.width=this.renderer.layoutingInfo.calculateVoiceWidth(e);const t=this.renderer.layoutingInfo.buildOnTimePositions(e),s=this.beatGlyphs;for(let e=0,i=s.length;e<i;e++){const a=s[e];if(a.beat.graceType===T.None)a.x=t.get(a.beat.absoluteDisplayStart)-a.onTimeX;else{const i=a.beat.graceGroup.beats[0].absoluteDisplayStart,r=a.beat.graceGroup.id;if(a.beat.graceGroup.isComplete&&t.has(i)){a.x=t.get(i)-a.onTimeX;const e=this.renderer.layoutingInfo.allGraceRods.get(r),s=a.beat.graceGroup.beats[a.beat.graceGroup.beats.length-1].nextBeat,n=s?this.renderer.layoutingInfo.getPreBeatSize(s):0;a.x-=n,a.x-=e[a.beat.graceIndex].postSpringWidth,a.x+=e[a.beat.graceIndex].graceBeatWidth;const o=e[a.beat.graceGroup.beats.length-1];a.x-=o.graceBeatWidth}else{const t=this.renderer.layoutingInfo.incompleteGraceRods.get(r),i=t[a.beat.graceIndex].postSpringWidth-t[a.beat.graceIndex].preSpringWidth;e>0?0===a.beat.graceIndex?a.x=s[e-1].x+s[e-1].width:a.x=s[e-1].x+t[a.beat.graceIndex-1].postSpringWidth-t[a.beat.graceIndex-1].preSpringWidth-i:a.x=-i}}if(e>0){const t=a.x-s[e-1].x;s[e-1].scaleToWidth(t)}if(e===i-1){const e=this.width-s[s.length-1].x;a.scaleToWidth(e)}}}registerLayoutingInfo(e){const t=this.beatGlyphs;for(const s of t)s.registerLayoutingInfo(e)}applyLayoutingInfo(e){const t=this.beatGlyphs;for(const s of t)s.applyLayoutingInfo(e);this.scaleToForce(Math.max(this.renderer.settings.display.stretchForce,e.minStretchForce))}addGlyph(e){const t=e;e.x=0===this.beatGlyphs.length?0:this.beatGlyphs[this.beatGlyphs.length-1].x+this.beatGlyphs[this.beatGlyphs.length-1].width,e.renderer=this.renderer,e.doLayout(),this.beatGlyphs.push(t),this.width=e.x+e.width,t.beat.hasTuplet&&t.beat.tupletGroup.beats[0].id===t.beat.id&&this.tupletGroups.push(t.beat.tupletGroup)}doLayout(){}paint(e,t,s){const i=ao.voice(s,R.Glyphs,this.voice,!0);try{for(let i=0,a=this.beatGlyphs.length;i<a;i++)this.beatGlyphs[i].paint(e+this.x,t+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}no.KeySizeBeat="Beat";class oo{constructor(){this.staffId="",this.up=0,this.down=0}}class ho{constructor(){this.startBeat=null,this.startX=0,this.startY=0,this.endBeat=null,this.endX=0,this.endY=0}calcY(e){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(e-this.startX)+this.startY}}class lo{get isRestBeamHelper(){return 1===this.beats.length&&this.beats[0].isRest}hasLine(e,t){return e&&this.beatHasLine(t)||!e&&1===this.beats.length&&this.beatHasLine(t)}beatHasLine(e){return e.duration>k.Whole}hasFlag(e,t){return e&&this.beatHasFlag(t)||!e&&1===this.beats.length&&this.beatHasFlag(this.beats[0])}beatHasFlag(e){return!e.deadSlapped&&!e.isRest&&(e.duration>k.Quarter||e.graceType!==T.None)}constructor(e,t){this._beatLineXPositions=new Map,this._firstNonRestBeat=null,this._lastNonRestBeat=null,this.voice=null,this.beats=[],this.shortestDuration=k.QuadrupleWhole,this.hasTuplet=!1,this.slashBeats=[],this.lowestNoteInHelper=null,this._lowestNoteCompareValueInHelper=-1,this.highestNoteInHelper=null,this._highestNoteCompareValueInHelper=-1,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.graceType=T.None,this.minRestLine=null,this.beatOfMinRestLine=null,this.maxRestLine=null,this.beatOfMaxRestLine=null,this.direction=Pe.Up,this.drawingInfos=new Map,this._staff=e,this._renderer=t,this.beats=[]}getBeatLineX(e,t){return t=t??this.direction,this.hasBeatLineX(e)?t===Pe.Up?this._beatLineXPositions.get(e.index).up:this._beatLineXPositions.get(e.index).down:0}hasBeatLineX(e){return this._beatLineXPositions.has(e.index)}registerBeatLineX(e,t,s,i){const a=this.getOrCreateBeatPositions(t);a.staffId=e,a.up=s,a.down=i;for(const e of this.drawingInfos.values())e.startBeat===t?e.startX=this.getBeatLineX(t):e.endBeat===t&&(e.endX=this.getBeatLineX(t))}getOrCreateBeatPositions(e){return this._beatLineXPositions.has(e.index)||this._beatLineXPositions.set(e.index,new oo),this._beatLineXPositions.get(e.index)}finish(){this.direction=this.calculateDirection(),this._renderer.completeBeamingHelper(this)}calculateDirection(){if(!this.voice)return Pe.Up;if(null!==this.preferredBeamDirection)return this.preferredBeamDirection;if(this.voice.index>0)return this.invert(Pe.Down);if(this.voice.bar.isMultiVoice)return this.invert(Pe.Up);if(this.beats[0].graceType!==T.None)return this.invert(Pe.Up);if(this.highestNoteInHelper&&this.lowestNoteInHelper){const e=(this._renderer.getNoteY(this.highestNoteInHelper,Jn.Center)+this._renderer.getNoteY(this.lowestNoteInHelper,Jn.Center))/2;return this.invert(this._renderer.middleYPosition<e?Pe.Up:Pe.Down)}return this.invert(Pe.Up)}static computeLineHeightsForRest(e){switch(e){case k.QuadrupleWhole:case k.DoubleWhole:return[2,2];case k.Whole:return[0,1];case k.Half:return[1,0];case k.Quarter:return[3,3];case k.Eighth:return[2,2];case k.Sixteenth:return[2,4];case k.ThirtySecond:return[4,4];case k.SixtyFourth:return[4,6];case k.OneHundredTwentyEighth:return[6,6];case k.TwoHundredFiftySixth:return[6,8]}return[0,0]}applyRest(e,t){if(this._lastNonRestBeat&&e.index>=this._lastNonRestBeat.index||this._firstNonRestBeat&&e.index<=this._firstNonRestBeat.index)return;let s=t,i=t;const a=lo.computeLineHeightsForRest(e.duration);s-=a[0],i+=a[1];const r=this.minRestLine,n=this.maxRestLine;(null===r||r>s)&&(this.minRestLine=s,this.beatOfMinRestLine=e),(null===n||n<i)&&(this.maxRestLine=i,this.beatOfMaxRestLine=e)}invert(e){return this.invertBeamDirection?e===Pe.Down?Pe.Up:Pe.Down:e}checkBeat(e){e.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=e.voice);let t=!1;if(0===this.beats.length)t=!0;else switch(this.beats[this.beats.length-1].beamingMode){case be.Auto:case be.ForceSplitOnSecondaryToNext:t=lo.canJoin(this.beats[this.beats.length-1],e);break;case be.ForceSplitToNext:t=!1;break;case be.ForceMergeWithNext:t=!0}return t&&(null==this.preferredBeamDirection&&null!==e.preferredBeamDirection&&(this.preferredBeamDirection=e.preferredBeamDirection),e.hasTuplet&&(this.hasTuplet=!0),e.isTremolo&&(!this.tremoloDuration||this.tremoloDuration<e.tremoloSpeed)&&(this.tremoloDuration=e.tremoloSpeed),e.graceType!==T.None&&(this.graceType=e.graceType),e.isRest?0===this.beats.length&&this.beats.push(e):(this.isRestBeamHelper&&(this.beats=[]),this.beats.push(e),this.checkNote(e.minNote),this.checkNote(e.maxNote),this.shortestDuration<e.duration&&(this.shortestDuration=e.duration),this._firstNonRestBeat||(this._firstNonRestBeat=e),this._lastNonRestBeat=e),e.slashed&&this.slashBeats.push(e)),t}checkNote(e){if(!e)return;let t,s;this.voice&&e.isPercussion?(t=-Vs.getPercussionLine(this.voice.bar,Vs.getNoteValue(e)),s=t):(t=Vs.getNoteValue(e),s=t,e.harmonicType!==N.None&&e.harmonicType!==N.Natural&&(s=e.realValue-this._staff.displayTranspositionPitch)),(!this.lowestNoteInHelper||t<this._lowestNoteCompareValueInHelper)&&(this.lowestNoteInHelper=e,this._lowestNoteCompareValueInHelper=t),(!this.highestNoteInHelper||s>this._highestNoteCompareValueInHelper)&&(this.highestNoteInHelper=e,this._highestNoteCompareValueInHelper=s)}static canJoin(e,t){if(!e||!t||e.graceType!==t.graceType||e.graceType===T.BendGrace||t.graceType===T.BendGrace||e.deadSlapped||t.deadSlapped)return!1;if(e.graceType!==T.None&&t.graceType!==T.None)return!0;const s=e.voice.bar;if(s!==t.voice.bar)return!1;const i=e.playbackStart,a=t.playbackStart;if(!lo.canJoinDuration(e.duration)||!lo.canJoinDuration(t.duration))return i===a;if(e.tupletGroup!==t.tupletGroup)return!1;if(e.hasTuplet&&t.hasTuplet&&e.tupletGroup===t.tupletGroup&&e.tupletGroup.isFull)return!0;let r=J.QuarterTime;if(8===s.masterBar.timeSignatureDenominator)s.masterBar.timeSignatureNumerator%3==0&&(r+=J.QuarterTime/2|0);return((r+i)/r|0)===((r+a)/r|0)}static canJoinDuration(e){switch(e){case k.Whole:case k.Half:case k.Quarter:return!1;default:return!0}}static isFullBarJoin(e,t,s){return De.getIndex(e.duration)-2-s>0&&De.getIndex(t.duration)-2-s>0}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}isPositionFrom(e,t){return!this._beatLineXPositions.has(t.index)||(this._beatLineXPositions.get(t.index).staffId===e||!this._beatLineXPositions.get(t.index).staffId)}}class co{constructor(e,t){this.topY=0,this.bottomY=0,this.topY=e,this.bottomY=t}}class uo{constructor(e){this.topY=-1e3,this.bottomY=-1e3,this.slots=[],this.beat=e}addSlot(e,t){if(this.slots.push(new co(e,t)),-1e3===this.topY)this.topY=e,this.bottomY=t;else{const s=Math.min(e,t),i=Math.max(e,t);s<this.topY&&(this.topY=s),i>this.bottomY&&(this.bottomY=i)}}}class po{constructor(){this.reservedLayoutAreasByDisplayTime=new Map,this.restDurationsByDisplayTime=new Map}getBeatMinMaxY(){let e=-1e3,t=-1e3;for(const s of this.reservedLayoutAreasByDisplayTime.values())-1e3===e?(e=s.topY,t=s.bottomY):(e>s.topY&&(e=s.topY),t<s.bottomY&&(t=s.bottomY));return-1e3===e?[0,0]:[e,t]}reserveBeatSlot(e,t,s){t!==s&&(this.reservedLayoutAreasByDisplayTime.has(e.displayStart)||this.reservedLayoutAreasByDisplayTime.set(e.displayStart,new uo(e)),this.reservedLayoutAreasByDisplayTime.get(e.displayStart).addSlot(t,s),e.isRest&&this.registerRest(e))}registerRest(e){this.restDurationsByDisplayTime.has(e.displayStart)||this.restDurationsByDisplayTime.set(e.displayStart,new Map),this.restDurationsByDisplayTime.get(e.displayStart).has(e.playbackDuration)||this.restDurationsByDisplayTime.get(e.displayStart).set(e.playbackDuration,e.id)}applyRestCollisionOffset(e,t,s){if(e.voice.index>0&&this.reservedLayoutAreasByDisplayTime.has(e.playbackStart)){const i=lo.computeLineHeightsForRest(e.duration).map(e=>e*s),a=t-i[0],r=t+i[1];let n=a;const o=this.reservedLayoutAreasByDisplayTime.get(e.playbackStart);let h=!1;for(const e of o.slots)if(a>=e.topY&&a<=e.bottomY||r>=e.topY&&r<=e.bottomY){h=!0;break}if(h){n=1===e.voice.index?o.topY-i[1]-i[0]:o.bottomY;const t=n+i[0]+i[1],r=2*s,h=Math.ceil(Math.abs(n-a)/r);return o.addSlot(n,t),n<a?h*-r:h*r}}return 0}}class mo{constructor(e){this.beamHelpers=[],this.beamHelperLookup=[],this.preferredBeamDirection=null,this._renderer=e,this.collisionHelper=new po}initialize(){const e=this._renderer,t=this._renderer.bar;let s=null,i=null;for(let a=0,r=t.voices.length;a<r;a++){const r=t.voices[a];this.beamHelpers.push([]),this.beamHelperLookup.push(new Map);for(let a=0,n=r.beats.length;a<n;a++){const n=r.beats[a];let o;n.graceType!==T.None?o=i:(o=s,i=null),o&&o.checkBeat(n)||(o&&o.finish(),o=new lo(t.staff,e),o.preferredBeamDirection=this.preferredBeamDirection,o.checkBeat(n),n.graceType!==T.None?i=o:s=o,this.beamHelpers[r.index].push(o)),this.beamHelperLookup[r.index].set(n.index,o)}s&&s.finish(),i&&i.finish(),s=null,i=null}}getBeamingHelperForBeat(e){return this.beamHelperLookup[e.voice.index].get(e.index)}}class go extends pn{constructor(e,t,s){super(e,t),this._textRow=0,this._fretRow=0,this._firstFretSpacing=0,this._chord=s}doLayout(){super.doLayout();const e=this.renderer.resources;this._textRow=1.5*e.effectFont.size,this._fretRow=1.5*e.effectFont.size,this._chord.firstFret>1?this._firstFretSpacing=this.renderer.smuflMetrics.chordDiagramFretSpacing:this._firstFretSpacing=0,this.height=this._textRow+this._fretRow+go.Frets*this.renderer.smuflMetrics.chordDiagramFretSpacing+2*this.renderer.smuflMetrics.chordDiagramPaddingY,this.width=this._firstFretSpacing+(this._chord.strings.length-1)*this.renderer.smuflMetrics.chordDiagramStringSpacing+2*this.renderer.smuflMetrics.chordDiagramPaddingX}paint(e,t,s){e+=this.x+this.renderer.smuflMetrics.chordDiagramPaddingX+this._firstFretSpacing,t+=this.y;const i=this.renderer.smuflMetrics.chordDiagramStringSpacing,a=this.renderer.smuflMetrics.chordDiagramFretSpacing,r=this.renderer.resources,n=r.engravingSettings.chordDiagramLineWidth,o=this.width-2*this.renderer.smuflMetrics.chordDiagramPaddingX-this._firstFretSpacing+n,h=r.engravingSettings.glyphHeights.get(ne.FretboardFilledCircle),l=r.engravingSettings.glyphTop.get(ne.FretboardFilledCircle),c=r.engravingSettings.glyphHeights.get(ne.FretboardX)/2,d=r.engravingSettings.glyphHeights.get(ne.FretboardO)/2,u=s.textAlign,p=s.textBaseline;s.font=r.effectFont,s.textAlign=we.Center,s.textBaseline=Be.Top,this._chord.showName&&s.fillText(this._chord.name,e+o/2,t+r.effectFont.size/2),t+=this._textRow,s.font=r.fretboardNumberFont,s.textBaseline=Be.Middle;for(let a=0;a<this._chord.strings.length;a++){const r=e+a*i,n=t+this._fretRow/2;let o=this._chord.strings[this._chord.strings.length-a-1];o<0?$e.fillMusicFontSymbolSafe(s,r,n+c,1,ne.FretboardX,!0):0===o?$e.fillMusicFontSymbolSafe(s,r,n+d,1,ne.FretboardO,!0):(o-=this._chord.firstFret-1,s.fillText(o.toString(),r,n))}t+=this._fretRow;for(let r=0;r<this._chord.strings.length;r++){const o=e+r*i;s.fillRect(o,t,n,a*go.Frets+1)}this._chord.firstFret>1?(s.textAlign=we.Left,s.fillText(this._chord.firstFret.toString(),e-this._firstFretSpacing,t+a/2),s.fillRect(e,t,o,n)):s.fillRect(e,t-this.renderer.smuflMetrics.chordDiagramNutHeight/2,o,this.renderer.smuflMetrics.chordDiagramNutHeight);for(let i=0;i<=go.Frets;i++){const r=t+i*a;s.fillRect(e,r,o,this.renderer.smuflMetrics.chordDiagramFretHeight)}const m=new Map;for(const e of this._chord.barreFrets){const t=[-1,-1];m.set(e-this._chord.firstFret,t)}for(let r=0;r<this._chord.strings.length;r++){let o=this._chord.strings[r];if(o>0){if(o-=this._chord.firstFret,m.has(o)){const e=m.get(o);(-1===e[0]||r<e[0])&&(e[0]=r),(-1===e[1]||r>e[1])&&(e[1]=r)}const c=t+o*a+a/2+.5,d=e+(this._chord.strings.length-r-1)*i+n/2;$e.fillMusicFontSymbolSafe(s,d,c+l-h/2,1,ne.FretboardFilledCircle,!0)}}for(const[r,n]of m){const o=t+r*a+a/2+.5,l=e+(this._chord.strings.length-n[1]-1)*i,c=e+(this._chord.strings.length-n[0]-1)*i;s.fillRect(l,o-h/2,c-l,h)}s.textAlign=u,s.textBaseline=p}}go.Frets=5;class fo extends so{constructor(e,t,s=we.Center){super(e,t),this._glyphWidth=0,this.glyphs=[],this._align=s}doLayout(){const e=this.renderer.smuflMetrics.rowContainerGap,t=this._glyphWidth-e;let s=0;switch(this._align){case we.Left:s=0;break;case we.Center:s=(this.width-t)/2;break;case we.Right:s=this.width-t}for(const t of this.glyphs)t.x=s,s+=t.width+e}addGlyphToRow(e){this.glyphs.push(e),this._glyphWidth+=e.width+this.renderer.smuflMetrics.rowContainerGap,e.height>this.height&&(this.height=e.height)}}class yo extends so{constructor(e,t,s=we.Center){super(e,t),this._rows=[],this.height=0,this.glyphs=[],this._align=s}doLayout(){let e=0,t=0;const s=this.renderer.smuflMetrics.rowContainerGap;this._rows=[];let i=new fo(e,t,this._align);i.renderer=this.renderer,i.width=this.width;for(const a of this.glyphs){const r=e+a.width+s;r<this.width?(i.addGlyphToRow(a),e=Math.ceil(r)):(i.isEmpty||(i.doLayout(),this._rows.push(i),t+=i.height+s),e=0,i=new fo(e,t,this._align),i.renderer=this.renderer,i.width=this.width,i.addGlyphToRow(a),e+=Math.ceil(a.width+s))}i.isEmpty||(i.doLayout(),this._rows.push(i),t+=Math.ceil(i.height+this.renderer.smuflMetrics.rowContainerPadding)),this.height=t}paint(e,t,s){for(const i of this._rows)i.paint(e+this.x,t+this.y,s)}}class bo extends yo{addChord(e){if(e.strings.length>0){const t=new go(0,0,e);t.renderer=this.renderer,t.doLayout(),this.glyphs.push(t)}}paint(e,t,s){if(this.glyphs.length>0){const i=ao.score(s,ke.ChordDiagramList,this.renderer.scoreRenderer.score);try{super.paint(e,t,s)}finally{i?.[Symbol.dispose]?.()}}}}class So extends pn{constructor(e,t,s,i,a=we.Left,r=null,n){super(e,t),this._lineHeights=null,this._lines=s.split("\n"),this.font=i,this.textAlign=a,this.textBaseline=r,this.colorOverride=n}doLayout(){super.doLayout(),this._lineHeights=[];const e=this.renderer.scoreRenderer.canvas;for(const t of this._lines){e.font=this.font;const s=e.measureText(t),i=s.height;this._lineHeights.push(i),this.height+=i,this.width=Math.max(this.width,s.width)}}paint(e,t,s){const i=s.color;s.color=this.colorOverride??i,s.font=this.font;const a=s.textAlign,r=s.textBaseline;s.textAlign=this.textAlign,null!==this.textBaseline&&(s.textBaseline=this.textBaseline);let n=t+this.y;for(let t=0;t<this._lines.length;t++)s.fillText(this._lines[t],e+this.x,n),n+=this._lineHeights[t];s.textAlign=a,s.textBaseline=r,s.color=i}}class wo{get staffId(){return this._factory.staffId}get contentTop(){return this.y+this.staveTop+this.topSpacing+this.topOverflow}get contentBottom(){return this.y+this.topSpacing+this.topOverflow+this.staveBottom}constructor(e,t,s){this._sharedLayoutData=new Map,this.barRenderers=[],this.x=0,this.y=0,this.height=0,this.index=0,this.staffIndex=0,this.isFirstInSystem=!1,this.trackIndex=0,this.staveTop=0,this.topSpacing=0,this.bottomSpacing=0,this.staveBottom=0,this._factory=s,this.trackIndex=e,this.modelStaff=t}getSharedLayoutData(e,t){return this._sharedLayoutData.has(e)?this._sharedLayoutData.get(e):t}setSharedLayoutData(e,t){this._sharedLayoutData.set(e,t)}get isInsideBracket(){return this._factory.isInsideBracket}get isRelevantForBoundsLookup(){return this._factory.isRelevantForBoundsLookup}registerStaffTop(e){this.staveTop=e}registerStaffBottom(e){this.staveBottom=e}addBarRenderer(e){e.staff=this,e.index=this.barRenderers.length,e.reLayout(),this.barRenderers.push(e),this.system.layout.registerBarRenderer(this.staffId,e)}addBar(e,t,s){const i=this._factory.create(this.system.layout.renderer,e);i.additionalMultiRestBars=s,i.staff=this,i.index=this.barRenderers.length,i.layoutingInfo=t,i.doLayout(),i.registerLayoutingInfo();const a=i.barDisplayWidth;a>0&&this.system.layout.systemsLayoutMode===Yn.FromModelWithWidths&&(i.width=a),this.barRenderers.push(i),e&&this.system.layout.registerBarRenderer(this.staffId,i)}revertLastBar(){const e=this.barRenderers[this.barRenderers.length-1];this.barRenderers.splice(this.barRenderers.length-1,1),this.system.layout.unregisterBarRenderer(this.staffId,e);for(const e of this.barRenderers)e.applyLayoutingInfo();return e}scaleToWidth(e){this._sharedLayoutData=new Map;const t=this.topOverflow;let s=0;switch(this.system.layout.systemsLayoutMode){case Yn.Automatic:const i=(e-this.system.computedWidth)/this.barRenderers.length;for(const e of this.barRenderers){e.x=s,e.y=this.topSpacing+t;const a=e.computedWidth+i;e.scaleToWidth(a),s+=e.width}break;case Yn.FromModelWithScale:e-=this.system.accoladeWidth;const a=this.system.totalBarDisplayScale;for(const i of this.barRenderers){i.x=s,i.y=this.topSpacing+t;const r=i.barDisplayScale*e/a;i.scaleToWidth(r),s+=i.width}break;case Yn.FromModelWithWidths:for(const e of this.barRenderers){e.x=s,e.y=this.topSpacing+t;const i=e.barDisplayWidth;i>0?e.scaleToWidth(i):e.scaleToWidth(e.computedWidth),s+=e.width}}}get topOverflow(){let e=0;for(let t=0,s=this.barRenderers.length;t<s;t++){const s=this.barRenderers[t];s.topOverflow>e&&(e=s.topOverflow)}return e}get bottomOverflow(){let e=0;for(let t=0,s=this.barRenderers.length;t<s;t++){const s=this.barRenderers[t];s.bottomOverflow>e&&(e=s.bottomOverflow)}return e}calculateHeightForAccolade(){this.topSpacing=this._factory.getStaffPaddingTop(this),this.bottomSpacing=this._factory.getStaffPaddingBottom(this),this.height=this.barRenderers.length>0?this.barRenderers[0].height:0,this.height>0&&(this.height+=Math.ceil(this.topSpacing+this.topOverflow+this.bottomOverflow+this.bottomSpacing))}finalizeStaff(){this.topSpacing=this._factory.getStaffPaddingTop(this),this.bottomSpacing=this._factory.getStaffPaddingBottom(this),this.height=0;let e=!1,t=this.topOverflow;for(let s=0;s<this.barRenderers.length;s++)this.barRenderers[s].y=this.topSpacing+t,this.height=Math.max(this.height,this.barRenderers[s].height),this.barRenderers[s].finalizeRenderer()&&(e=!0);if(e){t=this.topOverflow;for(let e=0;e<this.barRenderers.length;e++)this.barRenderers[e].y=this.topSpacing+t;for(let e=0;e<this.barRenderers.length;e++)this.barRenderers[e].finalizeRenderer()}this.height>0&&(this.height+=this.topSpacing+t+this.bottomOverflow+this.bottomSpacing),this.height=Math.ceil(this.height)}paint(e,t,s,i,a){if(0!==this.height&&0!==a)for(let r=i,n=Math.min(i+a,this.barRenderers.length);r<n;r++)this.barRenderers[r].paint(e+this.x,t+this.y,s)}}class Bo{constructor(){this.timePosition=0,this.longestDuration=0,this.smallestDuration=0,this.force=0,this.springConstant=0,this.preBeatWidth=0,this.graceBeatWidth=0,this.postSpringWidth=0,this.allDurations=new Set}get springWidth(){return this.preSpringWidth+this.postSpringWidth}get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}}class ko{constructor(){this._timeSortedSprings=[],this._minTime=-1,this._onTimePositionsForce=0,this._onTimePositions=new Map,this._incompleteGraceRodsWidth=0,this._minDuration=ko.MinDuration,this.version=0,this.preBeatSize=0,this.postBeatSize=0,this.minStretchForce=0,this.totalSpringConstant=0,this.incompleteGraceRods=new Map,this.allGraceRods=new Map,this.springs=new Map,this.height=0}updateMinStretchForce(e){this.minStretchForce<e&&(this.minStretchForce=e)}getPreBeatSize(e){if(e.graceType!==T.None){const t=e.graceGroup.id;return this.allGraceRods.get(t)[e.graceIndex].preBeatWidth}const t=e.absoluteDisplayStart;return this.springs.has(t)?this.springs.get(t).preBeatWidth:0}getPostBeatSize(e){if(e.graceType!==T.None){const t=e.graceGroup.id;return this.allGraceRods.get(t)[e.graceIndex].postSpringWidth}const t=e.absoluteDisplayStart;return this.springs.has(t)?this.springs.get(t).postSpringWidth:0}addSpring(e,t,s,i,a){let r;if(this.version++,this.springs.has(e))r=this.springs.get(e),r.postSpringWidth<a&&(r.postSpringWidth=a),r.graceBeatWidth<s&&(r.graceBeatWidth=s),r.preBeatWidth<i&&(r.preBeatWidth=i),t<r.smallestDuration&&(r.smallestDuration=t),t>r.longestDuration&&(r.longestDuration=t),r.allDurations.add(t);else{if(r=new Bo,r.timePosition=e,r.allDurations.add(t),this._timeSortedSprings.length>0){const e=this._timeSortedSprings[this._timeSortedSprings.length-1];for(const t of e.allDurations)e.timePosition;t<this._minDuration&&(this._minDuration=t)}r.longestDuration=t,r.postSpringWidth=a,r.graceBeatWidth=s,r.preBeatWidth=i,this.springs.set(e,r);const n=this._timeSortedSprings;let o=n.length-1;for(;o>0&&n[o].timePosition>e;)o--;this._timeSortedSprings.splice(o+1,0,r)}return(-1===this._minTime||this._minTime>e)&&(this._minTime=e),r}addBeatSpring(e,t,s){const i=e.absoluteDisplayStart;if(e.graceType!==T.None){const a=e.graceGroup.id;this.allGraceRods.has(a)||this.allGraceRods.set(a,new Array(e.graceGroup.beats.length)),e.graceGroup.isComplete||this.incompleteGraceRods.has(a)||this.incompleteGraceRods.set(a,new Array(e.graceGroup.beats.length));const r=this.allGraceRods.get(a)[e.graceIndex];if(r)r.postSpringWidth<s&&(r.postSpringWidth=s),r.preBeatWidth<t&&(r.preBeatWidth=t);else{const r=new Bo;r.timePosition=i,r.postSpringWidth=s,r.preBeatWidth=t,e.graceGroup.isComplete||(this.incompleteGraceRods.get(a)[e.graceIndex]=r),this.allGraceRods.get(a)[e.graceIndex]=r}}else{let a=0;if(e.graceGroup&&this.allGraceRods.has(e.graceGroup.id))for(const t of this.allGraceRods.get(e.graceGroup.id))a+=t.springWidth;this.addSpring(i,e.displayDuration,a,t,s)}}finish(){for(const[e,t]of this.allGraceRods){let e=0;for(const s of t)e+=s.preBeatWidth,s.graceBeatWidth=e,e+=s.postSpringWidth}this._incompleteGraceRodsWidth=0;for(const e of this.incompleteGraceRods.values())for(const t of e)this._incompleteGraceRodsWidth+=t.preBeatWidth+t.postSpringWidth;this.calculateSpringConstants(),this.version++}calculateSpringConstants(){let e=0;const t=this._timeSortedSprings;if(0===t.length)return this.totalSpringConstant=-1,void(this.minStretchForce=-1);for(let s=0;s<t.length;s++){const i=t[s];let a=0;if(s===t.length-1)a=i.longestDuration;else{const e=t[s+1];a=Math.abs(e.timePosition-i.timePosition)}i.springConstant=this.calculateSpringConstant(i,a),e+=1/i.springConstant}this.totalSpringConstant=1/e,this.minStretchForce=0;for(let e=0;e<t.length;e++){const s=t[e];let i=0;if(e===t.length-1)i=s.postSpringWidth;else{const a=t[e+1];i=s.postSpringWidth+a.preSpringWidth}0===e&&(i+=s.preSpringWidth);const a=i*s.springConstant;this.updateMinStretchForce(a)}}paint(e,t,s){}calculateSpringConstant(e,t){t<=0&&(t=J.toTicks(k.TwoHundredFiftySixth)),0===e.smallestDuration&&(e.smallestDuration=t);const s=e.smallestDuration,i=this._minDuration,a=ko.MinDurationWidth;return s/t*(1/((1+.85*Math.log2(t/i))*a))}spaceToForce(e){return-1!==this.totalSpringConstant?(this._timeSortedSprings.length>0&&(e-=this._timeSortedSprings[0].preSpringWidth),e-=this._incompleteGraceRodsWidth,Math.max(e,0)*this.totalSpringConstant):-1}calculateVoiceWidth(e){let t=0;return-1!==this.totalSpringConstant&&(t=this.calculateWidth(e,this.totalSpringConstant)),this._timeSortedSprings.length>0&&(t+=this._timeSortedSprings[0].preSpringWidth),t+=this._incompleteGraceRodsWidth,t}calculateWidth(e,t){return e/t}buildOnTimePositions(e){if(-1===this.totalSpringConstant)return new Map;if(De.isAlmostEqualTo(this._onTimePositionsForce,e)&&this._onTimePositions)return this._onTimePositions;this._onTimePositionsForce=e;const t=new Map;this._onTimePositions=t;const s=this._timeSortedSprings;if(0===s.length)return t;let i=s[0].preSpringWidth;for(let a=0;a<s.length;a++)t.set(s[a].timePosition,i),i+=this.calculateWidth(e,s[a].springConstant);return t}}ko.MinDuration=30,ko.MinDurationWidth=7;class To{constructor(){this.width=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.additionalMultiBarRestIndexes=null,this.renderers=[]}get lastMasterBarIndex(){return this.additionalMultiBarRestIndexes?this.additionalMultiBarRestIndexes[this.additionalMultiBarRestIndexes.length-1]:this.masterBar.index}}class _o{constructor(e,t){this.staves=[],this.stavesRelevantForBoundsLookup=[],this.firstStaffInBracket=null,this.lastStaffInBracket=null,this.bracket=null,this.staffSystem=e,this.track=t}addStaff(e){this.staves.push(e),e.isRelevantForBoundsLookup&&this.stavesRelevantForBoundsLookup.push(e)}}class xo{constructor(){this.firstStaffInBracket=null,this.lastStaffInBracket=null,this.drawAsBrace=!1,this.braceScale=1,this.width=0,this.index=0}finalizeBracket(e){if(this.firstStaffInBracket===this.lastStaffInBracket)return void(this.width=0);const t=e.glyphHeights.get(ne.Brace),s=e.glyphWidths.get(ne.Brace);if(this.drawAsBrace?this.width=s:this.width=e.bracketThickness,!this.drawAsBrace||!this.firstStaffInBracket||!this.lastStaffInBracket)return;const i=this.firstStaffInBracket.contentTop,a=(this.lastStaffInBracket.contentBottom-i)/t;this.braceScale=a,this.width=s*this.braceScale}}class No extends xo{constructor(e){super(),this.track=e,this.drawAsBrace=No.isTrackDrawAsBrace(e)}includesStaff(e){return e.modelStaff.track===this.track}static isTrackDrawAsBrace(e){return e.staves.filter(e=>e.showStandardNotation).length>1}}class Po extends No{includesStaff(e){return e.modelStaff.track===this.track||!this.drawAsBrace&&this.track.playbackInfo.program===e.modelStaff.track.playbackInfo.program}}class vo{constructor(e){this._allStaves=[],this._firstStaffInBrackets=null,this._lastStaffInBrackets=null,this._accoladeSpacingCalculated=!1,this._brackets=[],this._hasSystemSeparator=!1,this.x=0,this.y=0,this.index=0,this.accoladeWidth=0,this.isFull=!1,this.width=0,this.computedWidth=0,this.totalBarDisplayScale=0,this.isLast=!1,this.masterBarsRenderers=[],this.staves=[],this.layout=e,this.topPadding=e.renderer.settings.display.systemPaddingTop,this.bottomPadding=e.renderer.settings.display.systemPaddingBottom}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].lastMasterBarIndex}addMasterBarRenderers(e,t){if(0===e.length)return null;this.masterBarsRenderers.push(t),t.layoutingInfo.preBeatSize=0;let s=0;for(let e=0,i=this.staves.length;e<i;e++){const i=this.staves[e];for(let e=0,a=i.staves.length;e<a;e++){const a=i.staves[e],r=t.renderers[s++];a.addBarRenderer(r)}}return this.calculateAccoladeSpacing(e),this.updateWidthFromLastBar(),t}addBars(e,t,s){const i=new To;i.additionalMultiBarRestIndexes=s,i.layoutingInfo=new ko,i.masterBar=e[0].score.masterBars[t],this.masterBarsRenderers.push(i);const a=i.layoutingInfo;for(const e of this.staves)for(const r of e.staves){const n=e.track.staves[r.modelStaff.index].bars[t],o=null==s?null:s.map(t=>e.track.staves[r.modelStaff.index].bars[t]);r.addBar(n,a,o);const h=r.barRenderers[r.barRenderers.length-1];i.renderers.push(h),h.isLinkedToPrevious&&(i.isLinkedToPrevious=!0),h.canWrap||(i.canWrap=!1)}return this.calculateAccoladeSpacing(e),a.finish(),i.width=this.updateWidthFromLastBar(),i}revertLastBar(){if(this.masterBarsRenderers.length>1){const e=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let t=0,s=0;for(let e=0,i=this._allStaves.length;e<i;e++){const i=this._allStaves[e].revertLastBar(),a=i.computedWidth;a>t&&(t=a);const r=i.barDisplayScale;r>s&&(s=r)}return this.width-=t,this.computedWidth-=t,this.totalBarDisplayScale-=s,e}return null}updateWidthFromLastBar(){let e=0,t=0;for(let s=0,i=this._allStaves.length;s<i;s++){const i=this._allStaves[s],a=i.barRenderers[i.barRenderers.length-1];a.applyLayoutingInfo(),a.computedWidth>e&&(e=a.computedWidth);const r=a.barDisplayScale;r>t&&(t=r)}return this.width+=e,this.computedWidth+=e,this.totalBarDisplayScale+=t,e}calculateAccoladeSpacing(t){const s=this.layout.renderer.settings;if(!this._accoladeSpacingCalculated){this._accoladeSpacingCalculated=!0,this.accoladeWidth=0;const i=this.layout.renderer.score.stylesheet;if(this.layout.renderer.settings.notation.isNotationElementVisible(e.NotationElement.TrackNames)){const e=1===this.layout.renderer.tracks.length?i.singleTrackTrackNamePolicy:i.multiTrackTrackNamePolicy,a=0===this.index?i.firstSystemTrackNameMode:i.otherSystemsTrackNameMode,h=0===this.index?i.firstSystemTrackNameOrientation:i.otherSystemsTrackNameOrientation;let l=!1;switch(e){case r.Hidden:break;case r.FirstSystem:l=0===this.index;break;case r.AllSystems:l=!0}let c=!1;if(l){const e=this.layout.renderer.canvas,i=s.display.resources.effectFont;e.font=i;for(const s of t){let t="";switch(a){case n.FullName:t=s.name;break;case n.ShortName:t=s.shortName}if(t.length>0){c=!0;const s=e.measureText(t);switch(h){case o.Horizontal:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,s.width));break;case o.Vertical:this.accoladeWidth=Math.ceil(Math.max(this.accoladeWidth,s.height))}}}c&&(this.accoladeWidth+=s.display.systemLabelPaddingLeft,this.accoladeWidth+=s.display.systemLabelPaddingRight)}}let a=0;for(const e of this._allStaves)e.y=a,e.calculateHeightForAccolade(),a+=e.height;let h=0;for(const e of this._brackets)e.finalizeBracket(s.display.resources.engravingSettings),h=Math.max(h,e.width);this.accoladeWidth+=h,this.width+=this.accoladeWidth,this.computedWidth+=this.accoladeWidth}}getStaffTrackGroup(e){for(let t=0,s=this.staves.length;t<s;t++){const s=this.staves[t];if(s.track===e)return s}return null}addStaff(e,t){let s=this.getStaffTrackGroup(e);if(s||(s=new _o(this,e),this.staves.push(s)),t.staffTrackGroup=s,t.system=this,t.index=this._allStaves.length,this._allStaves.push(t),s.addStaff(t),t.isInsideBracket){this._firstStaffInBrackets||(this._firstStaffInBrackets=t,t.isFirstInSystem=!0),s.firstStaffInBracket||(s.firstStaffInBracket=t),this._lastStaffInBrackets=t,s.lastStaffInBracket=t;let i=this._brackets.find(e=>e.includesStaff(t));if(!i)switch(e.score.stylesheet.bracketExtendMode){case a.NoBrackets:break;case a.GroupStaves:i=new No(e),i.index=this._brackets.length,this._brackets.push(i);break;case a.GroupSimilarInstruments:i=new Po(e),i.index=this._brackets.length,this._brackets.push(i)}i&&(i.firstStaffInBracket||(i.firstStaffInBracket=t),i.lastStaffInBracket=t,s.bracket=i)}}get height(){return 0===this._allStaves.length?0:Math.ceil(this._allStaves[this._allStaves.length-1].y+this._allStaves[this._allStaves.length-1].height+this.topPadding+this.bottomPadding)}scaleToWidth(e){for(let t=0,s=this._allStaves.length;t<s;t++)this._allStaves[t].scaleToWidth(e);this.width=e}paint(e,t,s){if(this.paintPartial(e+this.x,t+this.y+this.topPadding,s,0,this.masterBarsRenderers.length),this._hasSystemSeparator){const i=ao.track(s,_e.SystemSeparator,this._allStaves[0].modelStaff.track);try{const i=this.layout.renderer.settings.display.resources.engravingSettings,a=Math.min(0,i.glyphBottom.get(ne.SystemDivider)??0);$e.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+this.height+a,1,ne.SystemDivider,!1),$e.fillMusicFontSymbolSafe(s,e+this.x+this.width-i.glyphWidths.get(ne.SystemDivider),t+this.y+this.height+a,1,ne.SystemDivider,!1)}finally{i?.[Symbol.dispose]?.()}}}paintPartial(t,s,i,a,h){for(let e=0,r=this._allStaves.length;e<r;e++)this._allStaves[e].paint(t,s,i,a,h);const l=this.layout.renderer.settings.display.resources;if(this.staves.length>0&&0===a){i.color=l.barSeparatorColor;const a=this.layout.renderer.settings,h=this.layout.renderer.settings.notation.isNotationElementVisible(e.NotationElement.TrackNames);if(i.font=l.effectFont,h){const e=this.layout.renderer.score.stylesheet,h=1===this.layout.renderer.tracks.length?e.singleTrackTrackNamePolicy:e.multiTrackTrackNamePolicy,l=0===this.index?e.firstSystemTrackNameMode:e.otherSystemsTrackNameMode,c=0===this.index?e.firstSystemTrackNameOrientation:e.otherSystemsTrackNameOrientation;let d=!1;switch(h){case r.Hidden:break;case r.FirstSystem:d=0===this.index;break;case r.AllSystems:d=!0}if(d){const e=i.textBaseline,r=i.textAlign;for(const e of this.staves)if(e.firstStaffInBracket&&e.lastStaffInBracket){const r=s+e.firstStaffInBracket.contentTop,h=s+e.lastStaffInBracket.contentBottom;let d="";switch(l){case n.FullName:d=e.track.name;break;case n.ShortName:d=e.track.shortName}const u=ao.track(i,_e.TrackName,e.track);try{if(d.length>0){const s=t+e.firstStaffInBracket.x-a.display.accoladeBarPaddingRight-(e.bracket?.width??0)-a.display.systemLabelPaddingRight;switch(c){case o.Horizontal:i.textBaseline=Be.Middle,i.textAlign=we.Right,i.fillText(d,s,(r+h)/2);break;case o.Vertical:i.textBaseline=Be.Bottom,i.textAlign=we.Center;const e=.1;i.beginRotate(s,(r+h)/2,-90-e),i.fillText(d,0,0),i.endRotate()}}}finally{u?.[Symbol.dispose]?.()}}i.textBaseline=e,i.textAlign=r}}if(this._allStaves.length>0){let e=null;for(const a of this._allStaves)if(a.isInsideBracket){if(null!==e){const r=e.contentBottom,n=a.contentTop,o=t+e.x,h=e.barRenderers[0],c=ao.bar(i,h.staffLineBarSubElement,h.bar);try{const e=Math.ceil(n-r);i.fillRect(o,s+r,l.engravingSettings.thinBarlineThickness,e)}finally{c?.[Symbol.dispose]?.()}}e=a}}for(const e of this._brackets)if(e.firstStaffInBracket&&e.lastStaffInBracket){const r=t+e.firstStaffInBracket.x,n=e.width,o=a.display.accoladeBarPaddingRight;let h=s+e.firstStaffInBracket.contentTop,l=s+e.lastStaffInBracket.contentBottom;if(e.drawAsBrace)$e.fillMusicFontSymbolSafe(i,r-o-n,l,e.braceScale,ne.Brace);else if(e.firstStaffInBracket!==e.lastStaffInBracket){const e=n/2;h-=e,l+=2*e,i.fillRect(r-o-n,h,n,Math.ceil(l-h));const t=r-o-n;$e.fillMusicFontSymbolSafe(i,t,h,1,ne.BracketTop),$e.fillMusicFontSymbolSafe(i,t,Math.floor(l),1,ne.BracketBottom)}}}}finalizeSystem(){const e=this.layout.renderer.settings;if(0===this.index&&(this.topPadding=e.display.firstSystemPaddingTop),this.isLast)this.bottomPadding=e.display.lastSystemPaddingBottom;else if(this.layout.renderer.score.stylesheet.useSystemSignSeparator&&this.layout.renderer.tracks.length>1){const t=e.display.resources.engravingSettings.glyphHeights.get(ne.SystemDivider);this.bottomPadding=Math.max(this.bottomPadding,t),this._hasSystemSeparator=!0}let t=0;for(const e of this._allStaves)e.x=this.accoladeWidth,e.y=t,e.finalizeStaff(),t+=e.height;for(const t of this._brackets)t.finalizeBracket(e.display.resources.engravingSettings)}buildBoundingsLookup(e,t){if(this.layout.renderer.boundsLookup.isFinished)return;const s=this._firstStaffInBrackets,i=this._lastStaffInBrackets;if(!s||!i)return;t+=this.topPadding;const a=this._allStaves[this._allStaves.length-1],r=t+this.y+s.y,n=t+this.y+i.y+i.height,o=t+this.y+this._allStaves[0].y,h=t+this.y+a.y+a.height,l=t+this.y+s.y+s.topSpacing+s.topOverflow+(s.barRenderers.length>0?s.barRenderers[0].topPadding:0),c=n-r,d=t+this.y+a.y+a.height-a.bottomSpacing-a.bottomOverflow-(a.barRenderers.length>0?a.barRenderers[0].bottomPadding:0)-l,u=h-o,p=this.x+s.x,m=new Xr;m.visualBounds=new Ts,m.visualBounds.x=e+this.x,m.visualBounds.y=t+this.y,m.visualBounds.w=this.width,m.visualBounds.h=this.height-this.topPadding-this.bottomPadding,m.realBounds=new Ts,m.realBounds.x=e+this.x,m.realBounds.y=t+this.y,m.realBounds.w=this.width,m.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaffSystem(m);const g=new Map;for(let e=0;e<this.staves.length;e++)for(const s of this.staves[e].stavesRelevantForBoundsLookup)for(const e of s.barRenderers){let i;g.has(e.bar.masterBar.index)?i=g.get(e.bar.masterBar.index):(i=new Ur,i.index=e.bar.masterBar.index,i.isFirstOfLine=e.isFirstOfLine,i.realBounds=new Ts,i.realBounds.x=p+e.x,i.realBounds.y=o,i.realBounds.w=e.width,i.realBounds.h=u,i.visualBounds=new Ts,i.visualBounds.x=p+e.x,i.visualBounds.y=r,i.visualBounds.w=e.width,i.visualBounds.h=c,i.lineAlignedBounds=new Ts,i.lineAlignedBounds.x=p+e.x,i.lineAlignedBounds.y=l,i.lineAlignedBounds.w=e.width,i.lineAlignedBounds.h=d,this.layout.renderer.boundsLookup.addMasterBar(i),g.set(i.index,i)),e.buildBoundingsLookup(i,p,t+this.y+s.y)}}getBarX(e){if(!this._firstStaffInBrackets||0===this.layout.renderer.tracks.length)return 0;const t=this.layout.renderer.tracks[0].staves[0].bars[e];return this.layout.getRendererForBar(this._firstStaffInBrackets.staffId,t).x}}class Eo extends yo{constructor(e,t){super(e,t,we.Left)}}class Mo extends so{constructor(e,t,s,i){super(e,t),this._tuning=s,this._trackLabel=i,this.glyphs=[]}doLayout(){if(!(this.glyphs.length>0)){this.createGlyphs(this._tuning);for(const e of this.glyphs)e.renderer=this.renderer,e.doLayout()}}paint(e,t,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),super.paint(e,t,s),s.color=i}createGlyphs(e){const t=this.renderer.resources;if(this.height=0,this._trackLabel.length>0){const e=new So(0,this.height,this._trackLabel,t.effectFont,we.Left);e.renderer=this.renderer,e.doLayout(),this.height+=e.height,this.addGlyph(e)}if(e.name.length>0){const s=new So(0,this.height,e.name,t.effectFont,we.Left);s.renderer=this.renderer,s.doLayout(),this.height+=s.height,this.addGlyph(s)}const s=this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,i=this.renderer.smuflMetrics.glyphHeights.get(ne.GuitarString0)*s;this.renderer.scoreRenderer.canvas.font=t.effectFont;const a=(i+this.renderer.scoreRenderer.canvas.measureText(" = Gb").width)*t.engravingSettings.tuningGlyphStringColumnScale;if(this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this._trackLabel).width,Math.max(this.renderer.scoreRenderer.canvas.measureText(e.name).width,2*a)),!e.isStandard){const r=0|Math.ceil(e.tunings.length/2);let n=0;const o=this.height+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;let h=o;for(let l=0,c=e.tunings.length;l<c;l++){const c=ne.GuitarString0+(l+1);this.addGlyph(new mn(n,h+i,s,c));const d=` = ${nt.getTextForTuning(e.tunings[l],!1)}`;this.addGlyph(new So(n+i,h+i/2,d,t.effectFont,we.Left,Be.Middle)),h+=i+this.renderer.smuflMetrics.tuningGlyphStringRowPadding;const u=h;this.height<u&&(this.height=u),l===r-1&&(h=o,n+=a)}}}}class Fo{constructor(e,t){this.args=e,this.renderCallback=t}}!function(e){e[e.Automatic=0]="Automatic",e[e.FromModelWithScale=1]="FromModelWithScale",e[e.FromModelWithWidths=2]="FromModelWithWidths"}(Yn||(Yn={}));class Co{get scaledWidth(){return Math.round(this.width/this.renderer.settings.display.scale)}constructor(e){this._barRendererLookup=new Map,this.pagePadding=null,this.width=0,this.height=0,this.multiBarRestInfo=null,this.headerGlyphs=new Map,this.footerGlyphs=new Map,this.chordDiagrams=null,this.tuningGlyph=null,this.systemsLayoutMode=Yn.Automatic,this._lazyPartials=new Map,this.firstBarIndex=0,this.lastBarIndex=0,this.renderer=e}resize(){this._lazyPartials.clear(),this.doResize()}layoutAndRender(){this._lazyPartials.clear();const e=this.renderer.score;this.firstBarIndex=De.computeFirstDisplayedBarIndex(e,this.renderer.settings),this.lastBarIndex=De.computeLastDisplayedBarIndex(e,this.renderer.settings,this.firstBarIndex),this.multiBarRestInfo=De.buildMultiBarRestInfo(this.renderer.tracks,this.firstBarIndex,this.lastBarIndex),this.pagePadding=this.renderer.settings.display.padding.map(e=>e/this.renderer.settings.display.scale),this.pagePadding||(this.pagePadding=[0,0,0,0]),1===this.pagePadding.length?this.pagePadding=[this.pagePadding[0],this.pagePadding[0],this.pagePadding[0],this.pagePadding[0]]:2===this.pagePadding.length&&(this.pagePadding=[this.pagePadding[0],this.pagePadding[1],this.pagePadding[0],this.pagePadding[1]]),this.createScoreInfoGlyphs(),this.doLayoutAndRender()}registerPartial(e,t){if(0===e.height)return;const s=this.renderer.settings.display.scale;e.x*=s,e.y*=s,e.width*=s,e.height*=s,e.totalWidth*=s,e.totalHeight*=s,this.renderer.settings.core.enableLazyLoading?(this._lazyPartials.set(e.id,new Fo(e,t)),this.renderer.partialLayoutFinished.trigger(e)):(this.renderer.partialLayoutFinished.trigger(e),this.internalRenderLazyPartial(e,t))}internalRenderLazyPartial(e,t){const s=this.renderer.canvas;s.beginRender(e.width,e.height),t(s),e.renderResult=s.endRender(),this.renderer.partialRenderFinished.trigger(e)}renderLazyPartial(e){if(this._lazyPartials.has(e)){const t=this._lazyPartials.get(e);this.internalRenderLazyPartial(t.args,t.renderCallback)}}createHeaderFooterGlyph(e,t,s,i){switch(s){case ke.WordsAndMusic:if(t.words!==t.music)return;break;case ke.Words:case ke.Music:if(t.words===t.music)return;break;case ke.CopyrightSecondLine:if(!this.headerGlyphs.has(ke.Copyright))return}const a=e.display.resources,r=e.notation,n=t.style&&t.style.headerAndFooter.has(s)?t.style.headerAndFooter.get(s):je.defaultHeaderAndFooter.get(s);let o=void 0===n.isVisible||n.isVisible;if(void 0!==i&&(o=r.isNotationElementVisible(i)),!o)return;const h=n.buildText(t);return h?new So(0,0,h,a.getFontForElement(s),n.textAlign,void 0,ao.scoreColor(a,s,t)):void 0}createScoreInfoGlyphs(){ee.debug("ScoreLayout","Creating score info glyphs");const t=this.renderer.settings,s=this.renderer.score;this.headerGlyphs=new Map,this.footerGlyphs=new Map;const i=new Oo(this.renderer,this.renderer.tracks[0].staves[0].bars[0]);for(const[e,a]of Co.HeaderElements.value){const r=this.createHeaderFooterGlyph(t,s,e,a);r&&(r.renderer=i,r.doLayout(),this.headerGlyphs.set(e,r))}for(const[e,a]of Co.FooterElements.value){const r=this.createHeaderFooterGlyph(t,s,e,a);r&&(r.renderer=i,r.doLayout(),this.footerGlyphs.set(e,r))}const a=t.notation,r=t.display.resources;if(a.isNotationElementVisible(e.NotationElement.GuitarTuning)){const e=[];for(const t of this.renderer.tracks)for(const i of t.staves){let a=!i.isPercussion&&i.isStringed&&i.tuning.length>0&&i.showTablature;if(s.stylesheet.perTrackDisplayTuning&&s.stylesheet.perTrackDisplayTuning.has(t.index)&&!1===s.stylesheet.perTrackDisplayTuning.get(t.index)&&(a=!1),a){e.push(i);break}}if(e.length>0&&s.stylesheet.globalDisplayTuning){this.tuningGlyph=new Eo(0,0),this.tuningGlyph.renderer=i;for(const t of e)if(t.stringTuning.tunings.length>0){const s=e.length>1?t.track.name:"",a=new Mo(0,0,t.stringTuning,s);a.colorOverride=ao.trackColor(r,_e.StringTuning,t.track),a.renderer=i,a.doLayout(),this.tuningGlyph.addGlyph(a)}}else this.tuningGlyph=null}if(a.isNotationElementVisible(e.NotationElement.ChordDiagrams)){this.chordDiagrams=new bo(0,0),this.chordDiagrams.renderer=i;const e=new Set;for(const t of this.renderer.tracks){if(s.stylesheet.globalDisplayChordDiagramsOnTop&&(null==s.stylesheet.perTrackChordDiagramsOnTop||!s.stylesheet.perTrackChordDiagramsOnTop.has(t.index)||s.stylesheet.perTrackChordDiagramsOnTop.get(t.index)))for(const s of t.staves){const t=s.chords;if(t)for(const[,s]of t)e.has(s.uniqueId)||s.showDiagram&&(e.add(s.uniqueId),this.chordDiagrams.addChord(s))}}this.chordDiagrams.isEmpty&&(this.chordDiagrams=null)}else this.chordDiagrams=null}createEmptyStaffSystem(){const e=new vo(this);for(let t=0;t<this.renderer.tracks.length;t++){const s=this.renderer.tracks[t];for(let i=0;i<s.staves.length;i++){const a=s.staves[i],r=Hc.staveProfiles.get(this.renderer.settings.display.staveProfile);for(const i of r)i.canCreate(s,a)&&e.addStaff(s,new wo(t,a,i))}}return e}registerBarRenderer(e,t){if(this._barRendererLookup.has(e)||this._barRendererLookup.set(e,new Map),this._barRendererLookup.get(e).set(t.bar.id,t),t.additionalMultiRestBars)for(const s of t.additionalMultiRestBars)this._barRendererLookup.get(e).set(s.id,t)}unregisterBarRenderer(e,t){if(this._barRendererLookup.has(e)){const s=this._barRendererLookup.get(e);if(s.delete(t.bar.id),t.additionalMultiRestBars)for(const e of t.additionalMultiRestBars)s.delete(e.id)}}getRendererForBar(e,t){const s=t.id;return this._barRendererLookup.has(e)&&this._barRendererLookup.get(e).has(s)?this._barRendererLookup.get(e).get(s):null}layoutAndRenderBottomScoreInfo(e){e=Math.round(e);const t=new Hr;t.x=0,t.y=e;let s=0;const i=this.renderer.settings.display.resources,a=[];let r=0;for(const[e,t]of Co.FooterElements.value)if(this.footerGlyphs.has(e)){const t=this.footerGlyphs.get(e);t.y=s,this.alignScoreInfoGlyph(t),s+=t.height,a.push(t),r=Math.max(r,Math.round(t.x+t.width))}return s=Math.round(s),a.length>0&&(t.width=r,t.height=s,t.totalWidth=this.scaledWidth,t.totalHeight=e+t.height,this.registerPartial(t,e=>{e.color=i.scoreInfoColor,e.textAlign=we.Left,e.textBaseline=Be.Top;for(const t of a)t.paint(0,0,e)})),e+s}alignScoreInfoGlyph(e){if(Hc.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical)switch(e.textAlign){case we.Left:e.x=this.pagePadding[0];break;case we.Center:e.x=this.scaledWidth/2;break;case we.Right:e.x=this.scaledWidth-this.pagePadding[2]}else e.x=this.firstBarX,e.textAlign=we.Left}layoutAndRenderAnnotation(e){const t=this.renderer.settings.display.resources,s=Wa.withFamilyList(t.copyrightFont.families,12,Wt.Plain,Ht.Bold),i=new Oo(this.renderer,this.renderer.tracks[0].staves[0].bars[0]),a=new So(0,0,"rendered by alphaTab",s,we.Center,void 0,t.mainGlyphColor);a.renderer=i,a.doLayout(),this.alignScoreInfoGlyph(a);const r=new Hr;return r.width=a.x+a.width,r.x=0,r.height=12,r.y=e,r.totalWidth=this.scaledWidth,r.totalHeight=e+12,r.firstMasterBarIndex=-1,r.lastMasterBarIndex=-1,this.registerPartial(r,e=>{e.color=t.mainGlyphColor,e.font=s,e.textAlign=we.Left,e.textBaseline=Be.Top,a.paint(0,0,e)}),e+12}}Co.HeaderElements=new Q(()=>new Map([[ke.Title,e.NotationElement.ScoreTitle],[ke.SubTitle,e.NotationElement.ScoreSubTitle],[ke.Artist,e.NotationElement.ScoreArtist],[ke.Album,e.NotationElement.ScoreAlbum],[ke.Words,e.NotationElement.ScoreWords],[ke.Music,e.NotationElement.ScoreMusic],[ke.WordsAndMusic,e.NotationElement.ScoreWordsAndMusic],[ke.Transcriber,void 0]])),Co.FooterElements=new Q(()=>new Map([[ke.Copyright,e.NotationElement.ScoreCopyright],[ke.CopyrightSecondLine,void 0]]));class Do extends so{constructor(){super(0,0),this._effectGlyphs=[],this._normalGlyphs=[],this.computedWidth=0}doLayout(){let e=0;if(this.glyphs)for(let t=0,s=this.glyphs.length;t<s;t++){const s=this.glyphs[t];s.x=e,s.renderer=this.renderer,s.doLayout(),e+=s.width}this.width=e,this.computedWidth=e}noteLoop(e){for(let t=this.container.beat.notes.length-1;t>=0;t--)e(this.container.beat.notes[t])}addEffect(e){super.addGlyph(e),this._effectGlyphs.push(e)}addNormal(e){super.addGlyph(e),this._normalGlyphs.push(e)}get effectElement(){}paint(e,t,s){this.paintEffects(e,t,s),this.paintNormal(e,t,s)}paintNormal(e,t,s){for(const i of this._normalGlyphs)i.paint(e+this.x,t+this.y,s)}paintEffects(e,t,s){const i=this.effectElement?ao.beat(s,this.effectElement,this.container.beat):void 0;try{for(const i of this._effectGlyphs)i.paint(e+this.x,t+this.y,s)}finally{i?.[Symbol.dispose]?.()}}}class Lo extends Do{constructor(){super(...arguments),this.centerX=0}updateBeamingHelper(){}buildBoundingsLookup(e,t,s){}getNoteX(e,t){return 0}getNoteY(e,t){return 0}getHighestNoteY(){return 0}getLowestNoteY(){return 0}}class Io extends un{constructor(e,t,s,i,a=1){super(e,t),this._scale=0,this._symbols=[],this._symbols=Io.getSymbols(s),this._scale=a,this._baseline=i}static getSymbols(e){const t=[];for(;e>0;){const s=e%10;t.unshift(Io.getSymbol(s)),e=e/10|0}return t}static getSymbol(e){switch(e){case 0:return ne.TimeSig0;case 1:return ne.TimeSig1;case 2:return ne.TimeSig2;case 3:return ne.TimeSig3;case 4:return ne.TimeSig4;case 5:return ne.TimeSig5;case 6:return ne.TimeSig6;case 7:return ne.TimeSig7;case 8:return ne.TimeSig8;case 9:return ne.TimeSig9;default:return ne.None}}doLayout(){let e=0;for(const t of this._symbols)e+=this.renderer.smuflMetrics.glyphWidths.get(t);this.width=e}paint(e,t,s){switch(this._baseline){case Be.Top:t+=this.renderer.smuflMetrics.glyphBottom.get(this._symbols[0]);break;case Be.Bottom:t+=this.renderer.smuflMetrics.glyphTop.get(this._symbols[0])}s.fillMusicFontSymbols(e+this.x,t+this.y,this._scale,this._symbols)}}class Ao extends un{constructor(){super(0,0),this._numberGlyph=[]}doLayout(){this.width=Ao.RestSymbols.reduce((e,t)=>e+this.renderer.smuflMetrics.glyphWidths.get(t),0),this.renderer.registerOverflowTop(this.renderer.getLineHeight(1));const e=this.renderer.additionalMultiRestBars.length+1;this._numberGlyph=Io.getSymbols(e)}paint(e,t,s){s.fillMusicFontSymbols(e+this.x,t+this.y+this.renderer.height/2,1,Ao.RestSymbols);const i=this.renderer.getLineY(-1.5);s.fillMusicFontSymbols(e+this.x+this.width/2,t+this.y+i|0,1,this._numberGlyph,!0)}}Ao.RestSymbols=[ne.RestHBarLeft,ne.RestHBarMiddle,ne.RestHBarMiddle,ne.RestHBarMiddle,ne.RestHBarRight];class Ro extends bn{constructor(e){super(Ro.getOrCreatePlaceholderBeat(e),e),this.preNotes=new Do,this.onNotes=new Lo}doLayout(){this.renderer.showMultiBarRest&&this.onNotes.addNormal(new Ao),super.doLayout()}static getOrCreatePlaceholderBeat(e){if(e.voice.beats.length>1)return e.voice.beats[0];const t=new Ye;return t.voice=e.voice,t}}!function(e){e[e.TopWithStem=0]="TopWithStem",e[e.Top=1]="Top",e[e.Center=2]="Center",e[e.Bottom=3]="Bottom",e[e.BottomWithStem=4]="BottomWithStem",e[e.StemUp=5]="StemUp",e[e.StemDown=6]="StemDown"}(Jn||(Jn={})),function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"}($n||($n={}));class Oo{get nextRenderer(){return this.bar&&this.bar.nextBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.nextBar):null}get previousRenderer(){return this.bar&&this.bar.previousBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staffId,this.bar.previousBar):null}get lastBar(){return this.additionalMultiRestBars?this.additionalMultiRestBars[this.additionalMultiRestBars.length-1]:this.bar}get showMultiBarRest(){return!1}constructor(e,t){this._preBeatGlyphs=new io,this._voiceContainers=new Map,this._postBeatGlyphs=new io,this._ties=[],this.additionalMultiRestBars=null,this.x=0,this.y=0,this.width=0,this.computedWidth=0,this.height=0,this.index=0,this.topOverflow=0,this.bottomOverflow=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.wasFirstOfLine=!1,this._appliedLayoutingInfo=0,this.isFinalized=!1,this.topPadding=0,this.bottomPadding=0,this.scoreRenderer=e,this.bar=t,t&&(this.helpers=new mo(this))}registerTies(e){this._ties.push(...e)}get middleYPosition(){return 0}registerOverflowTop(e){return(e=Math.ceil(e))>this.topOverflow&&(this.topOverflow=e,!0)}registerOverflowBottom(e){return(e=Math.ceil(e))>this.bottomOverflow&&(this.bottomOverflow=e,!0)}scaleToWidth(e){const t=e-this._preBeatGlyphs.width-this._postBeatGlyphs.width;for(const e of this._voiceContainers.values())e.scaleToWidth(t);this._postBeatGlyphs.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width+t,this.width=e}get resources(){return this.settings.display.resources}get smuflMetrics(){return this.resources.engravingSettings}get settings(){return this.scoreRenderer.settings}get barDisplayScale(){return this.staff.system.staves.length>1?this.bar.masterBar.displayScale:this.bar.displayScale}get barDisplayWidth(){return this.staff.system.staves.length>1?this.bar.masterBar.displayWidth:this.bar.displayWidth}get isFirstOfLine(){return 0===this.index}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}registerLayoutingInfo(){const e=this.layoutingInfo,t=this._preBeatGlyphs.width;e.preBeatSize<t&&(e.preBeatSize=t);for(const t of this._voiceContainers.values())t.registerLayoutingInfo(e),t.x,t.width;const s=this._postBeatGlyphs.width;e.postBeatSize<s&&(e.postBeatSize=s)}applyLayoutingInfo(){if(this._appliedLayoutingInfo>=this.layoutingInfo.version)return!1;this._appliedLayoutingInfo=this.layoutingInfo.version,this._preBeatGlyphs.width=this.layoutingInfo.preBeatSize;let e=this._preBeatGlyphs.x+this._preBeatGlyphs.width;for(const t of this._voiceContainers.values()){t.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width,t.applyLayoutingInfo(this.layoutingInfo);const s=t.x+t.width;e<s&&(e=s)}this._postBeatGlyphs.x=Math.floor(e),this._postBeatGlyphs.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.computedWidth=this.width;const t=this.barDisplayWidth;return t>0&&this.scoreRenderer.layout.systemsLayoutMode===Yn.FromModelWithWidths&&(this.width=t,this.computedWidth=t),!0}finalizeRenderer(){this.isFinalized=!0;let e=!1;const t=this.y-this.staff.topSpacing,s=this.y+this.height+this.staff.bottomSpacing;for(const i of this._ties)if(i.doLayout(),i.height>0){const a=i.y+i.height-s;a>0&&this.registerOverflowBottom(a)&&(e=!0);const r=i.y-t;r<0&&this.registerOverflowTop(-1*r)&&(e=!0)}return e}doLayout(){if(!this.bar)return;this.helpers.initialize(),this._ties=[],this._preBeatGlyphs=new io,this._preBeatGlyphs.renderer=this,this._voiceContainers.clear(),this._postBeatGlyphs=new io,this._postBeatGlyphs.renderer=this;for(let e=0;e<this.bar.voices.length;e++){const t=this.bar.voices[e];if(this.hasVoiceContainer(t)){const s=new no(0,0,t);s.renderer=this,this._voiceContainers.set(this.bar.voices[e].index,s)}}if(this.bar.simileMark===c.SecondOfDouble&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.additionalMultiRestBars){const e=new Ro(this.getVoiceContainer(this.bar.voices[0]));this.addBeatGlyph(e)}else this.createBeatGlyphs();this.createPostBeatGlyphs(),this.updateSizes();for(const e of this.helpers.beamHelpers)for(const t of e)t.finish();this.computedWidth=this.width;const e=this.height,t=this._preBeatGlyphs.glyphs;if(t)for(const s of t){const t=s.getBoundingBoxTop();t<0&&this.registerOverflowTop(-1*t);const i=t+s.height;i>e&&this.registerOverflowBottom(i-e)}const s=this._postBeatGlyphs.glyphs;if(s)for(const t of s){const s=t.getBoundingBoxTop();s<0&&this.registerOverflowTop(-1*s);const i=s+t.height;i>e&&this.registerOverflowBottom(i-e)}}hasVoiceContainer(e){return!(!this.additionalMultiRestBars&&0!==e.index)||!e.isEmpty}updateSizes(){this.staff.registerStaffTop(this.topPadding),this.staff.registerStaffBottom(this.height-this.bottomPadding);const e=this._voiceContainers,t=this.beatGlyphsStart;let s=t;for(const i of e.values()){i.x=t,i.doLayout();const e=i.x+i.width;s<e&&(s=e)}this._postBeatGlyphs.x=Math.floor(s),this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.height+=this.layoutingInfo.height,this.height=Math.ceil(this.height)}addPreBeatGlyph(e){e.renderer=this,this._preBeatGlyphs.addGlyph(e)}addBeatGlyph(e){e.renderer=this,e.preNotes.renderer=this,e.onNotes.renderer=this,e.onNotes.beamingHelper=this.helpers.beamHelperLookup[e.beat.voice.index].get(e.beat.index),this.getVoiceContainer(e.beat.voice).addGlyph(e)}getVoiceContainer(e){return this._voiceContainers.has(e.index)?this._voiceContainers.get(e.index):void 0}getBeatContainer(e){return this.getVoiceContainer(e.voice)?.beatGlyphs?.[e.index]}getPreNotesGlyphForBeat(e){return this.getBeatContainer(e)?.preNotes}getOnNotesGlyphForBeat(e){return this.getBeatContainer(e)?.onNotes}paint(e,t,s){this.paintBackground(e,t,s),s.color=this.resources.mainGlyphColor,this._preBeatGlyphs.paint(e+this.x,t+this.y,s);for(const i of this._voiceContainers.values())i.paint(e+this.x,t+this.y,s);s.color=this.resources.mainGlyphColor,this._postBeatGlyphs.paint(e+this.x,t+this.y,s)}paintBackground(e,t,s){this.layoutingInfo.paint(e+this.x+this._preBeatGlyphs.x+this._preBeatGlyphs.width,t+this.y+this.height,s)}buildBoundingsLookup(e,t,s){const i=new Gr;i.bar=this.bar,i.visualBounds=new Ts,i.visualBounds.x=t+this.x,i.visualBounds.y=s+this.y+this.topPadding,i.visualBounds.w=this.width,i.visualBounds.h=this.height-this.topPadding-this.bottomPadding,i.realBounds=new Ts,i.realBounds.x=t+this.x,i.realBounds.y=s+this.y,i.realBounds.w=this.width,i.realBounds.h=this.height,e.addBar(i);for(const[e,a]of this._voiceContainers){const r=this.bar.isEmpty&&0===e;if(!a.voice.isEmpty||r)for(let e=0,n=a.beatGlyphs.length;e<n;e++){a.beatGlyphs[e].buildBoundingsLookup(i,t+this.x+a.x,s+this.y+a.y,r)}}}addPostBeatGlyph(e){this._postBeatGlyphs.addGlyph(e)}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine}createBeatGlyphs(){for(const e of this.bar.voices)this.hasVoiceContainer(e)&&this.createVoiceGlyphs(e)}createVoiceGlyphs(e){}createPostBeatGlyphs(){}get beatGlyphsStart(){return this._preBeatGlyphs.x+this._preBeatGlyphs.width}get postBeatGlyphsStart(){return this._postBeatGlyphs.x}getBeatX(e,t=Xn.PreNotes){const s=this.getBeatContainer(e);if(s)switch(t){case Xn.PreNotes:return s.voiceContainer.x+s.x;case Xn.OnNotes:return s.voiceContainer.x+s.x+s.onNotes.x;case Xn.MiddleNotes:return s.voiceContainer.x+s.x+s.onTimeX;case Xn.Stem:const t=s.onNotes.beamingHelper?s.onNotes.beamingHelper.getBeatLineX(e):s.onNotes.x+s.onNotes.width/2;return s.voiceContainer.x+t;case Xn.PostNotes:return s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.width;case Xn.EndBeat:return s.voiceContainer.x+s.x+s.width}return 0}getRatioPositionX(e){const t=this.bar.isEmpty?this.beatGlyphsStart:this.getBeatX(this.bar.voices[0].beats[0],Xn.OnNotes);return t+(this.postBeatGlyphsStart-t)*e}getNoteX(e,t){const s=this.getBeatContainer(e.beat);return s?s.voiceContainer.x+s.x+s.onNotes.x+s.onNotes.getNoteX(e,t):0}getNoteY(e,t){const s=this.getOnNotesGlyphForBeat(e.beat);return s?s.getNoteY(e,t):Number.NaN}reLayout(){(this.wasFirstOfLine&&!this.isFirstOfLine||!this.wasFirstOfLine&&this.isFirstOfLine)&&this.recreatePreBeatGlyphs(),this.updateSizes(),this.registerLayoutingInfo()}recreatePreBeatGlyphs(){this._preBeatGlyphs=new io,this._preBeatGlyphs.renderer=this,this.createPreBeatGlyphs()}paintSimileMark(e,t,s){const i=ao.voice(s,R.Glyphs,this.bar.voices[0],!0);try{switch(this.bar.simileMark){case c.Simple:s.beginGroup(bn.getGroupId(this.bar.voices[0].beats[0])),$e.fillMusicFontSymbolSafe(s,e+this.x+this.width/2,t+this.y+this.height/2,1,ne.Repeat1Bar,!0),s.endGroup();break;case c.SecondOfDouble:s.beginGroup(bn.getGroupId(this.bar.voices[0].beats[0])),s.beginGroup(bn.getGroupId(this.bar.previousBar.voices[0].beats[0])),$e.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+this.height/2,1,ne.Repeat2Bars,!0),s.endGroup(),s.endGroup()}}finally{i?.[Symbol.dispose]?.()}}completeBeamingHelper(e){}getBeatDirection(e){return this.helpers.getBeamingHelperForBeat(e).direction}}!function(e){e[e.SinglePreBeat=0]="SinglePreBeat",e[e.SingleOnBeat=1]="SingleOnBeat",e[e.SingleOnBeatToEnd=2]="SingleOnBeatToEnd",e[e.GroupedOnBeat=3]="GroupedOnBeat",e[e.GroupedOnBeatToEnd=4]="GroupedOnBeatToEnd",e[e.FullBar=5]="FullBar"}(qn||(qn={}));class Wo extends un{constructor(e,t){super(0,0),this._uniqueEffectGlyphs=[],this._effectGlyphs=[],this.isEmpty=!0,this.previousBand=null,this.isLinkedToPrevious=!1,this.firstBeat=null,this.lastBeat=null,this.height=0,this.originalHeight=0,this.slot=null,this.voice=e,this.info=t}doLayout(){super.doLayout();for(let e=0;e<this.renderer.bar.voices.length;e++)this._effectGlyphs.push(new Map),this._uniqueEffectGlyphs.push([])}createGlyph(e){if(e.voice===this.voice&&this.info.shouldCreateGlyph(this.renderer.settings,e)&&(!this.info.hideOnMultiTrack||0===this.renderer.staff.trackIndex)){if(this.isEmpty=!1,this.firstBeat&&!e.isBefore(this.firstBeat)||(this.firstBeat=e),!this.lastBeat||e.isAfter(this.lastBeat))switch(this.lastBeat=e,this.info.sizingMode){case qn.SingleOnBeatToEnd:case qn.GroupedOnBeatToEnd:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat)}const t=this.createOrResizeGlyph(this.info.sizingMode,e);t.height>this.height&&(this.height=t.height,this.originalHeight=t.height)}}resetHeight(){this.height=this.originalHeight}createOrResizeGlyph(e,t){let s;switch(e){case qn.FullBar:case qn.SinglePreBeat:case qn.SingleOnBeat:case qn.SingleOnBeatToEnd:return s=this.info.createNewGlyph(this.renderer,t),s.renderer=this.renderer,s.beat=t,s.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,s),this._uniqueEffectGlyphs[t.voice.index].push(s),s;case qn.GroupedOnBeat:case qn.GroupedOnBeatToEnd:const i=e===qn.GroupedOnBeat?qn.SingleOnBeat:qn.SingleOnBeatToEnd;if(t.index>0||this.renderer.index>0){const e=t.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,e)){let s=null;if(t.index>0&&this._effectGlyphs[t.voice.index].has(e.index))s=this._effectGlyphs[t.voice.index].get(e.index);else if(this.renderer.index>0){const t=this.renderer.previousRenderer.getBand(e.voice,this.info.effectId);if(t){const i=t._effectGlyphs[e.voice.index];i.has(e.index)&&(s=i.get(e.index))}}const a=this.createOrResizeGlyph(i,t);return s&&this.info.canExpand(e,t)&&(s.nextGlyph=a,a.previousGlyph=s,this.isLinkedToPrevious=!0),a}return this.createOrResizeGlyph(i,t)}return this.createOrResizeGlyph(i,t);default:return this.createOrResizeGlyph(qn.SingleOnBeat,t)}}paint(e,t,s){super.paint(e,t,s);for(let i=0,a=this._uniqueEffectGlyphs.length;i<a;i++){const a=this._uniqueEffectGlyphs[i];for(let i=0,r=a.length;i<r;i++){const r=a[i],n=ao.beat(s,Se.Effects,r.beat,!1);try{r.paint(e+this.x,t+this.y,s)}finally{n?.[Symbol.dispose]?.()}}}}alignGlyphs(){for(let e=0;e<this._effectGlyphs.length;e++)for(const t of this._effectGlyphs[e].keys())this.alignGlyph(this.info.sizingMode,this.renderer.bar.voices[e].beats[t])}alignGlyph(e,t){const s=this._effectGlyphs[t.voice.index].get(t.index),i=this.renderer.getBeatContainer(t);switch(e){case qn.SinglePreBeat:const e=this.renderer.layoutingInfo.getPreBeatSize(t);s.x=this.renderer.beatGlyphsStart+i.x-e;break;case qn.SingleOnBeat:case qn.GroupedOnBeat:s.x=this.renderer.beatGlyphsStart+i.x;break;case qn.SingleOnBeatToEnd:case qn.GroupedOnBeatToEnd:if(s.x=this.renderer.beatGlyphsStart+i.x,i.beat.isLastOfVoice)s.width=this.renderer.width-s.x;else{const e=this.renderer.layoutingInfo.getPostBeatSize(t);s.width=e}break;case qn.FullBar:s.width=this.renderer.width}}}class Ho{constructor(){this.uniqueEffectId=null,this.y=0,this.height=0,this.firstBeat=null,this.lastBeat=null}}class Go{constructor(){this.bands=[],this.shared=new Ho}update(e){e.info.canShareBand||(this.shared.uniqueEffectId=e.info.effectId),e.slot=this,this.bands.push(e),e.height>this.shared.height&&(this.shared.height=e.height),this.shared.firstBeat&&!e.firstBeat.isBefore(this.shared.firstBeat)||(this.shared.firstBeat=e.firstBeat),this.shared.lastBeat&&!e.lastBeat.isAfter(this.shared.lastBeat)||(this.shared.lastBeat=e.lastBeat)}canBeUsed(e){return(!this.shared.uniqueEffectId&&e.info.canShareBand||e.info.effectId===this.shared.uniqueEffectId)&&(!this.shared.firstBeat||this.shared.lastBeat.isBefore(e.firstBeat)||this.shared.lastBeat.isBefore(this.shared.firstBeat))}}class Vo{constructor(){this.slots=[],this._effectSlot=new Map}getOrCreateSlot(e){if(this._effectSlot.has(e.info.effectId)){const t=this._effectSlot.get(e.info.effectId);if(t.canBeUsed(e))return t}for(const t of this.slots)if(t.canBeUsed(e))return t;const t=new Go;return this.slots.push(t),t}register(e){const t=this.getOrCreateSlot(e);t.update(e),this._effectSlot.set(e.info.effectId,t)}}class Uo extends Oo{constructor(e,t,s){super(e,t),this._bands=[],this._bandLookup=new Map,this.sizingInfo=null,this._infos=s}updateSizes(){this.topOverflow=0,this.bottomOverflow=0,this.topPadding=0,this.bottomPadding=0,this.updateHeight(),super.updateSizes()}finalizeRenderer(){let e=super.finalizeRenderer();return this.updateHeight()&&(e=!0),e}updateHeight(){if(!this.sizingInfo)return!1;let e=0;for(const t of this.sizingInfo.slots){t.shared.y=e;for(const s of t.bands)s.y=e,s.height=t.shared.height;e+=t.shared.height+this.settings.display.effectBandPaddingBottom}return e=Math.ceil(e),e!==this.height&&(this.height=e,!0)}applyLayoutingInfo(){const e=!super.applyLayoutingInfo();if(this.index>0){const e=this.previousRenderer;this.sizingInfo=e.sizingInfo}else this.sizingInfo=new Vo;for(const e of this._bands)e.resetHeight(),e.alignGlyphs(),e.isEmpty||this.sizingInfo.register(e);return this.updateHeight(),e}scaleToWidth(e){super.scaleToWidth(e);for(const e of this._bands)e.alignGlyphs()}createBeatGlyphs(){this._bands=[],this._bandLookup=new Map;for(const e of this.bar.voices)if(this.hasVoiceContainer(e))for(const t of this._infos){const s=new Wo(e,t);s.renderer=this,s.doLayout(),this._bands.push(s),this._bandLookup.set(`${e.index}.${t.effectId}`,s)}super.createBeatGlyphs();for(const e of this._bands)e.isLinkedToPrevious&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(e){for(const t of e.beats){const s=new bn(t,this.getVoiceContainer(e));s.preNotes=new Do,s.onNotes=new Lo,this.addBeatGlyph(s);for(const e of this._bands)e.createGlyph(t)}}paint(e,t,s){this.paintBackground(e,t,s);for(const i of this._bands)s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isEmpty||i.paint(e+this.x,t+this.y,s)}getBand(e,t){const s=`${e.index}.${t}`;return this._bandLookup.has(s)?this._bandLookup.get(s):null}}class zo extends to{get staffId(){return this._staffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.effectStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.effectStaffPaddingBottom}constructor(e,t,s=null){super(),this.infos=t,this._staffId=e,this.isInsideBracket=!1,this.isRelevantForBoundsLookup=!1,this.shouldShow=s}canCreate(e,t){const s=this.shouldShow;return super.canCreate(e,t)&&(!s||s(e,t))}create(e,t){return new Uo(e,t,this.infos.filter(t=>e.settings.notation.isNotationElementVisible(t.notationElement)))}}class Xo extends pn{constructor(e,t,s,i,a,r){super(e,t),this._endingsString="",this._endings=De.getAlternateEndingsList(s),this._openLine=i,this._closeLine=a,this._indent=r}doLayout(){super.doLayout(),this.height=this.renderer.resources.wordsFont.size+2*this.renderer.smuflMetrics.alternateEndingsPadding;let e="";for(let t=0,s=this._endings.length;t<s;t++)e+=this._endings[t]+1,e+=". ";this._endingsString=e}paint(e,t,s){let i=this._closeLine?this.width-s.lineWidth:this.width;if(this.renderer.bar.getActualBarLineRight()===g.LightHeavy&&(i-=this.renderer.smuflMetrics.thickBarlineThickness+this.renderer.smuflMetrics.barlineSeparation),e=(0|e)+s.lineWidth/2,t=(0|t)+s.lineWidth/2,this._indent&&(e+=this.renderer.smuflMetrics.alternateEndingsPadding,i-=this.renderer.smuflMetrics.alternateEndingsPadding),this._openLine?(s.moveTo(e+this.x,t+this.y+this.height),s.lineTo(e+this.x,t+this.y)):s.moveTo(e+this.x,t+this.y),s.lineTo(e+this.x+i,t+this.y),this._closeLine&&s.lineTo(e+this.x+i,t+this.y+this.height),s.stroke(),this._openLine){const i=s.textBaseline;s.textBaseline=Be.Top;const a=this.renderer.resources;s.font=a.wordsFont,s.fillText(this._endingsString,e+this.x+this.renderer.smuflMetrics.alternateEndingsPadding,t+this.y+this.renderer.smuflMetrics.alternateEndingsPadding),s.textBaseline=i}}}class Yo{get effectId(){return this.notationElement.toString()}}class Jo extends Yo{get notationElement(){return e.NotationElement.EffectAlternateEndings}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return qn.FullBar}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&0!==t.voice.bar.masterBar.alternateEndings}createNewGlyph(e,t){const s=t.voice.bar.masterBar,i=null===s.previousMasterBar||s.alternateEndings!==s.previousMasterBar.alternateEndings;let a=s.isRepeatEnd||null===s.nextMasterBar||s.alternateEndings!==s.nextMasterBar.alternateEndings;s.repeatGroup.closings.some(e=>e.index>=s.index)||(a=!1);const r=null!==s.previousMasterBar&&s.alternateEndings!==s.previousMasterBar.alternateEndings&&s.previousMasterBar.alternateEndings>0;return new Xo(0,0,s.alternateEndings,i,a,r)}canExpand(e,t){return!0}}class $o extends pn{constructor(e){super(),this.forceGroupedRendering=!1,this.endOnBarLine=!1,this.endPosition=e}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff.system===this.renderer.staff.system}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff.system===this.renderer.staff.system}paint(e,t,s){if(this.isLinkedWithPrevious)return;if(!this.isLinkedWithNext&&!this.forceGroupedRendering)return void this.paintNonGrouped(e,t,s);let i;if(!this.isLinkedWithNext&&this.forceGroupedRendering)i=this;else for(i=this.nextGlyph;i.isLinkedWithNext;)i=i.nextGlyph;const a=i.renderer,r=i.beat,n=this.endPosition,o=e-this.renderer.x,h=this.calculateEndX(a,r,o,n);this.paintGrouped(e,t,h,s)}calculateEndX(e,t,s,i){return t?s+e.x+e.getBeatX(t,i):s+e.x+this.x+this.width}paintNonGrouped(e,t,s){const i=e-this.renderer.x,a=this.calculateEndX(this.renderer,this.beat,i,this.endPosition);this.paintGrouped(e,t,a,s)}}class qo extends $o{constructor(e,t=!0){super(Xn.OnNotes),this._labelWidth=0,this._label=e,this._dashed=t}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=Xn.EndBeat,this.forceGroupedRendering=!0),super.doLayout(),this.renderer.scoreRenderer.canvas.font=this.renderer.resources.effectFont;const e=this.renderer.scoreRenderer.canvas.measureText(this._label);this.height=e.height,this._labelWidth=e.width}paintNonGrouped(e,t,s){const i=this.renderer.resources;s.font=i.effectFont;const a=s.textBaseline;s.textBaseline=Be.Middle,s.fillText(this._label,e+this.x-this._labelWidth/2,t+this.y+this.height/2),s.textBaseline=a}paintGrouped(e,t,s,i){this.paintNonGrouped(e,t,i);const a=this.renderer.smuflMetrics.lineRangedGlyphDashGap,r=this.renderer.smuflMetrics.lineRangedGlyphDashSize,n=this.renderer.smuflMetrics.pedalLineThickness,o=e+this.x+this._labelWidth/2+a/2,h=t+this.y+this.height/2-n/2;if(this._dashed){if(s>o){let e=o;for(;e<s;){const t=Math.min(e+r,s);i.fillRect(e,h,t-e,n),e+=r+a}i.fillRect(s,h-r/2+n/2,n,r)}}else i.fillRect(o,h,s-o,n),i.fillRect(s-n,h,n,r/2)}}class jo extends Yo{get notationElement(){return e.NotationElement.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isBarre}get sizingMode(){return qn.GroupedOnBeat}createNewGlyph(e,t){let s="";switch(t.barreShape){case fe.None:case fe.Full:break;case fe.Half:s+="1/2"}return s+=`B ${jo.toRoman(t.barreFret)}`,new qo(s,!1)}static toRoman(e){let t="";if(e>0)for(const[s,i]of jo.RomanLetters){const a=Math.floor(e/i);e-=a*i,t+=s.repeat(a)}return t}canExpand(e,t){return e.barreFret===t.barreFret&&e.barreShape===t.barreShape}}jo.RomanLetters=new Map([["L",50],["XL",40],["X",10],["IX",9],["V",5],["IV",4],["I",1]]);class Ko extends pn{constructor(e){super(0,0),this._text="",this._textWidth=0,this._textHeight=0,this._timer=e}doLayout(){const e=this._timer/6e4|0,t=(this._timer-6e4*e)/1e3|0;this._text=`${e}:${t.toString().padStart(2,"0")}`;const s=this.renderer.scoreRenderer.canvas;s.font=this.renderer.resources.timerFont;const i=s.measureText(this._text);this._textHeight=s.font.size+2*this.renderer.smuflMetrics.beatTimerPadding,this._textWidth=i.width+2*this.renderer.smuflMetrics.beatTimerPadding,this.height=this._textHeight+2*this.renderer.smuflMetrics.beatTimerPadding}paint(e,t,s){const i=this._textWidth/2|0;s.strokeRect(e+this.x-i,t+this.y+this.renderer.smuflMetrics.beatTimerPadding,this._textWidth,this._textHeight);const a=s.font,r=s.textBaseline,n=s.textAlign;s.font=this.renderer.resources.timerFont,s.textBaseline=Be.Middle,s.textAlign=we.Center,s.fillText(this._text,e+this.x,t+this.y+this.height/2),s.font=a,s.textBaseline=r,s.textAlign=n}}class Qo extends Yo{get notationElement(){return e.NotationElement.EffectBeatTimer}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){return t.showTimer}createNewGlyph(e,t){return new Ko(t.timer??0)}canExpand(e,t){return!0}}class Zo extends Yo{get notationElement(){return e.NotationElement.EffectCapo}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){return 0===t.index&&0===t.voice.bar.index&&0!==t.voice.bar.staff.capo}createNewGlyph(e,t){return new So(0,0,`Capo. fret ${t.voice.bar.staff.capo}`,e.resources.effectFont,we.Left)}canExpand(e,t){return!1}}class eh extends Yo{get notationElement(){return e.NotationElement.EffectChordNames}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){return t.hasChord}createNewGlyph(e,t){return new So(0,0,t.chord.name,e.resources.effectFont,we.Center)}canExpand(e,t){return!1}}class th extends $o{constructor(e,t,s){super(Xn.EndBeat),this._crescendo=B.None,this._crescendo=s,this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(ne.DynamicCrescendoHairpin)}paintGrouped(e,t,s,i){const a=e+this.x,r=this.height,n=this.renderer.smuflMetrics.glyphWidths.get(ne.NoteheadBlack)/2;i.beginPath(),this._crescendo===B.Crescendo?(s-=n,i.moveTo(s,t+this.y),i.lineTo(a,t+this.y+r/2),i.lineTo(s,t+this.y+r)):(s-=n,i.moveTo(a,t+this.y),i.lineTo(s,t+this.y+r/2),i.lineTo(a,t+this.y+r));const o=i.lineWidth;i.lineWidth=this.renderer.smuflMetrics.hairpinThickness,i.stroke(),i.lineWidth=o}}class sh extends Yo{get notationElement(){return e.NotationElement.EffectCrescendo}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.crescendo!==B.None}createNewGlyph(e,t){return new th(0,0,t.crescendo)}canExpand(e,t){return e.crescendo===t.crescendo}}class ih extends un{constructor(e){super(0,0),this._scale=1,this._symbols=e}doLayout(){this.height=0;const e=this.renderer.smuflMetrics.directionsScale;this._scale=e;for(const t of this._symbols){const s=this.renderer.smuflMetrics.glyphHeights.get(t)*e;s>this.height&&(this.height=s)}}paint(e,t,s){s.fillMusicFontSymbols(e+this.x,t+this.y+this.height,this._scale,this._symbols,!0)}}class ah extends un{constructor(e){super(0,0),this._text=e}doLayout(){const e=this.renderer.scoreRenderer.canvas;e.font=this.renderer.resources.directionsFont,this.height=e.measureText(this._text).height}paint(e,t,s){const i=s.font,a=s.textBaseline,r=s.textAlign;s.font=this.renderer.resources.directionsFont,s.textBaseline=Be.Middle,s.textAlign=we.Right,s.fillText(this._text,e+this.x,t+this.y+this.height/2),s.font=i,s.textBaseline=a,s.textAlign=r}}class rh extends pn{constructor(e,t,s){super(e,t),this._barBeginGlyphs=[],this._barEndGlyphs=[],this._directions=s}doLayout(){const e=this._directions;e.has(xe.TargetSegnoSegno)&&this._barBeginGlyphs.push(new ih([ne.Segno,ne.Segno])),e.has(xe.TargetSegno)&&this._barBeginGlyphs.push(new ih([ne.Segno])),e.has(xe.TargetDoubleCoda)&&this._barBeginGlyphs.push(new ih([ne.Coda,ne.Coda])),e.has(xe.TargetCoda)&&this._barBeginGlyphs.push(new ih([ne.Coda])),e.has(xe.TargetFine)&&this._barEndGlyphs.push(new ah("Fine")),e.has(xe.JumpDaDoubleCoda)&&this._barEndGlyphs.push(new ah("To Double Coda")),e.has(xe.JumpDaCoda)&&this._barEndGlyphs.push(new ah("To Coda")),e.has(xe.JumpDalSegnoSegno)&&this._barEndGlyphs.push(new ah("D.S.S.")),e.has(xe.JumpDalSegnoSegnoAlCoda)&&this._barEndGlyphs.push(new ah("D.S.S. al Coda")),e.has(xe.JumpDalSegnoSegnoAlDoubleCoda)&&this._barEndGlyphs.push(new ah("D.S.S. al Double Coda")),e.has(xe.JumpDalSegnoSegnoAlFine)&&this._barEndGlyphs.push(new ah("D.S.S. al Fine")),e.has(xe.JumpDalSegno)&&this._barEndGlyphs.push(new ah("D.S.")),e.has(xe.JumpDalSegnoAlCoda)&&this._barEndGlyphs.push(new ah("D.S. al Coda")),e.has(xe.JumpDalSegnoAlDoubleCoda)&&this._barEndGlyphs.push(new ah("D.S. al Double Coda")),e.has(xe.JumpDalSegnoAlFine)&&this._barEndGlyphs.push(new ah("D.S. al Fine")),e.has(xe.JumpDaCapo)&&this._barEndGlyphs.push(new ah("D.C.")),e.has(xe.JumpDaCapoAlCoda)&&this._barEndGlyphs.push(new ah("D.C. al Coda")),e.has(xe.JumpDaCapoAlDoubleCoda)&&this._barEndGlyphs.push(new ah("D.C. al Double Coda")),e.has(xe.JumpDaCapoAlFine)&&this._barEndGlyphs.push(new ah("D.C. al Fine"));const t=this.doSideLayout(this._barBeginGlyphs),s=this.doSideLayout(this._barEndGlyphs);this.height=Math.max(t,s)}doSideLayout(e){let t=0;const s=this.renderer.settings.display.effectBandPaddingBottom;for(const i of e)i.y=t,i.renderer=this.renderer,i.doLayout(),t+=i.height+s;return t}paint(e,t,s){for(const i of this._barBeginGlyphs)i.paint(e+this.x,t+this.y,s);for(const i of this._barEndGlyphs)i.paint(e+this.x+this.width,t+this.y,s)}}class nh extends Yo{get notationElement(){return e.NotationElement.EffectDirections}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return qn.FullBar}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&null!==t.voice.bar.masterBar.directions&&t.voice.bar.masterBar.directions.size>0}createNewGlyph(e,t){return new rh(0,0,t.voice.bar.masterBar.directions)}canExpand(e,t){return!0}}class oh extends mn{constructor(e,t,s){super(e,t,1,oh.getSymbol(s))}doLayout(){super.doLayout(),this.center=!0,this.height=this.renderer.smuflMetrics.glyphHeights.get(ne.DynamicForte);const e=this.renderer.smuflMetrics.glyphTop.get(ne.DynamicForte);this.offsetY=e}static getSymbol(e){switch(e){case f.PPP:return ne.DynamicPPP;case f.PP:return ne.DynamicPP;case f.P:return ne.DynamicPiano;case f.MP:return ne.DynamicMP;case f.MF:return ne.DynamicMF;case f.F:return ne.DynamicForte;case f.FF:return ne.DynamicFF;case f.FFF:return ne.DynamicFFF;case f.PPPP:return ne.DynamicPPPP;case f.PPPPP:case f.PPPPPP:return ne.DynamicPPPPP;case f.FFFF:return ne.DynamicFFFF;case f.FFFFF:return ne.DynamicFFFFF;case f.FFFFFF:return ne.DynamicFFFFFF;case f.SF:return ne.DynamicSforzando1;case f.SFP:return ne.DynamicSforzandoPiano;case f.SFPP:return ne.DynamicSforzandoPianissimo;case f.FP:return ne.DynamicFortePiano;case f.RF:return ne.DynamicRinforzando1;case f.RFZ:return ne.DynamicRinforzando2;case f.SFZ:return ne.DynamicSforzato;case f.SFFZ:return ne.DynamicSforzatoFF;case f.FZ:return ne.DynamicForzando;case f.N:return ne.DynamicNiente;case f.PF:return ne.DynamicPF;case f.SFZP:return ne.DynamicSforzatoPiano;default:return ne.None}}}class hh extends Yo{get notationElement(){return e.NotationElement.EffectDynamics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){return this.internalShouldCreateGlyph(t)}internalShouldCreateGlyph(e){if(e.voice.bar.staff.track.score.stylesheet.hideDynamics||e.isEmpty||e.voice.isEmpty||e.isRest)return!1;const t=this.getPreviousDynamicsBeat(e);let s=0===e.voice.index&&!t||e.dynamics!==t?.dynamics;if(s&&e.voice.index>0)for(const t of e.voice.bar.voices)if(t.index<e.voice.index){const i=t.getBeatAtPlaybackStart(e.playbackStart);i&&e.dynamics===i.dynamics&&this.internalShouldCreateGlyph(i)&&(s=!1)}return s}getPreviousDynamicsBeat(e){let t=e.previousBeat;for(;null!=t;){if(!t.isRest)return t;t=t.previousBeat}return null}createNewGlyph(e,t){return new oh(0,0,t.dynamics)}canExpand(e,t){return!0}}class lh extends mn{constructor(e){super(0,0,1,lh.getSymbol(e)),this.center=!0}static getSymbol(e){switch(e){case me.FadeIn:return ne.GuitarFadeIn;case me.FadeOut:return ne.GuitarFadeOut;case me.VolumeSwell:return ne.GuitarVolumeSwell}return ne.None}paint(e,t,s){super.paint(e,t+this.height,s)}}class ch extends Yo{get notationElement(){return e.NotationElement.EffectFadeIn}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){return t.fade!==me.None}createNewGlyph(e,t){return new lh(t.fade)}canExpand(e,t){return!0}}class dh extends mn{constructor(e,t,s){super(e,t,1,dh.getSymbol(s))}static getSymbol(e){switch(e){case Ne.Short:return ne.FermataShortAbove;case Ne.Medium:return ne.FermataAbove;case Ne.Long:return ne.FermataLongAbove;default:return ne.None}}paint(e,t,s){super.paint(e-this.width/2,t+this.height,s)}}class uh extends Yo{get notationElement(){return e.NotationElement.EffectFermata}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){return 0===t.voice.index&&!!t.fermata}createNewGlyph(e,t){return new dh(0,0,t.fermata.type)}canExpand(e,t){return!0}}class ph{constructor(e,t){this.line=0,this.line=e,this.symbols=t}}class mh extends so{constructor(){super(0,0),this._infos=new Map}get isEmpty(){return 0===this._infos.size}addFingers(t){const s=this.renderer.settings;if(s.notation.fingeringMode!==e.FingeringMode.ScoreDefault&&s.notation.fingeringMode!==e.FingeringMode.ScoreForcePiano)return;const i=mh.fingerToMusicFontSymbol(this.renderer.settings,t.beat,t.leftHandFinger,!0);i!==ne.None&&this.addFinger(t,i);const a=mh.fingerToMusicFontSymbol(this.renderer.settings,t.beat,t.rightHandFinger,!1);a!==ne.None&&this.addFinger(t,a)}static fingerToMusicFontSymbol(t,s,i,a){if(t.notation.fingeringMode===e.FingeringMode.ScoreForcePiano||t.notation.fingeringMode===e.FingeringMode.SingleNoteEffectBandForcePiano||H.isPiano(s.voice.bar.staff.track.playbackInfo.program))switch(i){case x.Unknown:case x.NoOrDead:return ne.None;case x.Thumb:return ne.Fingering1;case x.IndexFinger:return ne.Fingering2;case x.MiddleFinger:return ne.Fingering3;case x.AnnularFinger:return ne.Fingering4;case x.LittleFinger:return ne.Fingering5;default:return ne.None}if(a)switch(i){case x.Unknown:return ne.None;case x.NoOrDead:return ne.Fingering0;case x.Thumb:return ne.FingeringTLower;case x.IndexFinger:return ne.Fingering1;case x.MiddleFinger:return ne.Fingering2;case x.AnnularFinger:return ne.Fingering3;case x.LittleFinger:return ne.Fingering4;default:return ne.None}switch(i){case x.Unknown:case x.NoOrDead:return ne.None;case x.Thumb:return ne.FingeringPLower;case x.IndexFinger:return ne.FingeringILower;case x.MiddleFinger:return ne.FingeringMLower;case x.AnnularFinger:return ne.FingeringALower;case x.LittleFinger:return ne.FingeringCLower;default:return ne.None}}addFinger(e,t){const s=this.renderer,i=s.getNoteLine(e);if(this._infos.has(i)){this._infos.get(i).symbols.push(t)}else{const a=new ph(i,[t]);a.color=ao.noteColor(s.resources,de.StandardNotationEffects,e),this._infos.set(i,a)}}doLayout(){const e=this.renderer;for(const[t,s]of this._infos){const t=new gn(0,0,1,s.symbols);t.colorOverride=s.color,t.renderer=e,t.y=e.getScoreY(s.line),t.doLayout(),t.offsetY=t.height/2,this.addGlyph(t),this.width=Math.max(this.width,t.width)}for(const e of this.glyphs){const t=e;t.x=this.width/2,t.center=!0}}}class gh extends Yo{get notationElement(){return e.NotationElement.EffectFingering}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(t,s){return!(0!==s.voice.index||s.isRest||t.notation.fingeringMode!==e.FingeringMode.SingleNoteEffectBand&&t.notation.fingeringMode!==e.FingeringMode.SingleNoteEffectBandForcePiano)&&(1===s.notes.length&&s.notes[0].isFingering)}createNewGlyph(e,t){let s=x.Unknown,i=!1;const a=t.notes[0];a.leftHandFinger!==x.Unknown?(s=a.leftHandFinger,i=!0):a.rightHandFinger!==x.Unknown&&(s=a.rightHandFinger);const r=mh.fingerToMusicFontSymbol(e.settings,t,s,i),n=new mn(0,0,1,r);return n.center=!0,n.renderer=e,n.doLayout(),n.offsetY=e.smuflMetrics.glyphTop.get(n.symbol),n}canExpand(e,t){return!0}}class fh extends Yo{get notationElement(){return e.NotationElement.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.SinglePreBeat}shouldCreateGlyph(e,t){const s=t.voice.bar.masterBar;return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&s.isFreeTime&&(0===s.index||s.isFreeTime!==s.previousMasterBar.isFreeTime)}createNewGlyph(e,t){return new So(0,0,"Free time",e.resources.effectFont,we.Left)}canExpand(e,t){return!0}}class yh extends mn{constructor(e,t,s=!1){super(e,t,fn.GraceScale,ne.GuitarGolpe),this.center=s}doLayout(){super.doLayout(),this.offsetY=this.height}}class bh extends Yo{constructor(e,t){super(),this._type=e,this._shouldCreate=t}get notationElement(){return e.NotationElement.EffectGolpe}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){const s=this._shouldCreate;return t.golpe===this._type&&(!s||s(e,t))}createNewGlyph(e,t){return new yh(0,0,!0)}canExpand(e,t){return!1}}class Sh extends Yo{constructor(){super(...arguments),this.lastCreateInfo=null}shouldCreateGlyph(e,t){this.lastCreateInfo=[];for(let e=0,s=t.notes.length;e<s;e++){const s=t.notes[e];this.shouldCreateGlyphForNote(s)&&this.lastCreateInfo.push(s)}return this.lastCreateInfo.length>0}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(e,t){return!0}}class wh extends Sh{get effectId(){return this._effectId}get notationElement(){return e.NotationElement.EffectHarmonics}constructor(e){switch(super(),this._beat=null,this._harmonicType=e,e){case N.None:this._effectId="harmonics-none";break;case N.Natural:this._effectId="harmonics-natural";break;case N.Artificial:this._effectId="harmonics-artificial";break;case N.Pinch:this._effectId="harmonics-pinch";break;case N.Tap:this._effectId="harmonics-tap";break;case N.Semi:this._effectId="harmonics-semi";break;case N.Feedback:this._effectId="harmonics-feedback";break;default:this._effectId=""}}shouldCreateGlyphForNote(e){return!(!e.isHarmonic||e.harmonicType!==this._harmonicType)&&(e.beat!==this._beat&&(this._beat=e.beat),!0)}get sizingMode(){return qn.GroupedOnBeat}createNewGlyph(e,t){return new qo(wh.harmonicToString(this._harmonicType))}static harmonicToString(e){switch(e){case N.Natural:return"N.H.";case N.Artificial:return"A.H.";case N.Pinch:return"P.H.";case N.Tap:return"T.H.";case N.Semi:return"S.H.";case N.Feedback:return"Fdbk."}return""}}class Bh extends mn{constructor(){super(0,0,1,ne.GuitarLeftHandTapping),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(this.symbol)}}class kh extends Sh{get notationElement(){return e.NotationElement.EffectTap}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyphForNote(e){return e.isLeftHandTapped}createNewGlyph(e,t){return new Bh}}class Th extends Yo{get notationElement(){return e.NotationElement.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isLetRing}get sizingMode(){return qn.GroupedOnBeat}createNewGlyph(e,t){return new qo("LetRing")}canExpand(e,t){return!0}}class _h extends pn{constructor(e,t,s,i,a=we.Center){super(e,t),this._lines=s,this.font=i,this.textAlign=a}doLayout(){super.doLayout(),this.height=this.font.size*this._lines.length}paint(e,t,s){s.font=this.font;const i=s.textAlign;s.textAlign=this.textAlign;for(let i=0;i<this._lines.length;i++)this._lines[i]&&s.fillText(this._lines[i],e+this.x,t+this.y+i*this.font.size);s.textAlign=i}}class xh extends Yo{get notationElement(){return e.NotationElement.EffectLyrics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.lyrics}createNewGlyph(e,t){return new _h(0,0,t.lyrics,e.resources.effectFont,we.Center)}canExpand(e,t){return!0}}class Nh extends Yo{get notationElement(){return e.NotationElement.EffectMarker}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return qn.SinglePreBeat}shouldCreateGlyph(e,t){return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&t.voice.bar.masterBar.isSectionStart}createNewGlyph(e,t){return new So(0,0,t.voice.bar.masterBar.section.marker?`[${t.voice.bar.masterBar.section.marker}] ${t.voice.bar.masterBar.section.text}`:t.voice.bar.masterBar.section.text,e.resources.markerFont,we.Left)}canExpand(e,t){return!0}}class Ph extends mn{constructor(e){super(0,0,1,Ph.getSymbol(e)),this.center=!0}static getSymbol(e){switch(e){case ce.InvertedTurn:return ne.OrnamentTurnInverted;case ce.Turn:return ne.OrnamentTurn;case ce.UpperMordent:return ne.OrnamentShortTrill;case ce.LowerMordent:return ne.OrnamentMordent}return ne.None}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(ne.OrnamentMordent),this.offsetY=this.renderer.smuflMetrics.glyphTop.get(ne.OrnamentMordent)}}class vh extends Yo{get notationElement(){return e.NotationElement.EffectNoteOrnament}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){return t.notes.some(e=>e.ornament!==ce.None)}createNewGlyph(e,t){return new Ph(t.notes.find(e=>e.ornament!==ce.None).ornament)}canExpand(e,t){return!1}}class Eh extends $o{constructor(e,t){super(Xn.PostNotes),this._ottava=e,this._aboveStaff=t}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(ne.QuindicesimaAlta)}paintNonGrouped(e,t,s){this.paintOttava(e,t,s)}paintOttava(e,t,s){let i=0;switch(this._ottava){case l._15ma:i=this.renderer.smuflMetrics.glyphWidths.get(ne.QuindicesimaAlta),$e.fillMusicFontSymbolSafe(s,e+this.x-i/2,t+this.y+this.height,1,ne.QuindicesimaAlta,!1);break;case l._8va:i=this.renderer.smuflMetrics.glyphWidths.get(ne.OttavaAlta),$e.fillMusicFontSymbolSafe(s,e+this.x-i/2,t+this.y+this.height,1,ne.OttavaAlta,!1);break;case l._8vb:i=this.renderer.smuflMetrics.glyphWidths.get(ne.OttavaBassaVb),$e.fillMusicFontSymbolSafe(s,e+this.x-i/2,t+this.y+this.height,1,ne.OttavaBassaVb,!1);break;case l._15mb:i=1*(this.renderer.smuflMetrics.glyphWidths.get(ne.Quindicesima)+this.renderer.smuflMetrics.glyphWidths.get(ne.OctaveBaselineM)+this.renderer.smuflMetrics.glyphWidths.get(ne.OctaveBaselineB)),$e.fillMusicFontSymbolsSafe(s,e+this.x-i/2,t+this.y+this.height,1,[ne.Quindicesima,ne.OctaveBaselineM,ne.OctaveBaselineB],!1)}return i/2}paintGrouped(e,t,s,i){const a=this.paintOttava(e,t,i),r=this.renderer.smuflMetrics.lineRangedGlyphDashGap,n=e+this.x+a+r;let o=t+this.y;const h=.5*this.height;o+=this._aboveStaff?0:this.height;const l=this.renderer.smuflMetrics.lineRangedGlyphDashSize,c=i.lineWidth;if(i.lineWidth=this.renderer.smuflMetrics.octaveLineThickness,s>n){let e=n;for(;e<s;)i.beginPath(),i.moveTo(e,0|o),i.lineTo(Math.min(e+l,s),0|o),e+=l+r,i.stroke();i.beginPath(),this._aboveStaff?(i.moveTo(s,o),i.lineTo(s,o+h)):(i.moveTo(s,o),i.lineTo(s,o-h)),i.stroke()}i.lineWidth=c}}class Mh extends Yo{get effectId(){return"ottavia-"+(this._aboveStaff?"above":"below")}get notationElement(){return e.NotationElement.EffectOttavia}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.GroupedOnBeat}constructor(e){super(),this._aboveStaff=e}shouldCreateGlyph(e,t){switch(t.ottava){case l._15ma:case l._8va:return this._aboveStaff;case l._8vb:case l._15mb:return!this._aboveStaff}return!1}createNewGlyph(e,t){return new Eh(t.ottava,this._aboveStaff)}canExpand(e,t){return e.ottava===t.ottava}}class Fh extends Sh{get notationElement(){return e.NotationElement.EffectPalmMute}shouldCreateGlyphForNote(e){return e.isPalmMute}get sizingMode(){return qn.GroupedOnBeat}createNewGlyph(e,t){return new qo("P.M.")}}class Ch extends Sh{get notationElement(){return e.NotationElement.EffectPickSlide}shouldCreateGlyphForNote(e){return e.slideOutType===E.PickSlideDown||e.slideOutType===E.PickSlideUp}get sizingMode(){return qn.GroupedOnBeat}createNewGlyph(e,t){return new qo("P.S.")}}class Dh extends mn{constructor(e,t,s){super(e,t,fn.GraceScale,Dh.getSymbol(s)),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}static getSymbol(e){switch(e){case he.Up:return ne.StringsUpBow;case he.Down:return ne.StringsDownBow;default:return ne.None}}}class Lh extends Yo{get notationElement(){return e.NotationElement.EffectPickStroke}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){return t.pickStroke!==he.None}createNewGlyph(e,t){return new Dh(0,0,t.pickStroke)}canExpand(e,t){return!0}}class Ih extends Yo{get notationElement(){return e.NotationElement.EffectRasgueado}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.hasRasgueado}get sizingMode(){return qn.GroupedOnBeat}createNewGlyph(e,t){return new qo("rasg.")}canExpand(e,t){return!0}}class Ah extends $o{constructor(e,t,s,i=!1){super(Xn.EndBeat),this._symbol=ne.None,this._repeatOffsetX=0,this._symbolOffsetY=0,this._type=s,this.x=e,this.y=t,this._partialWaves=i}doLayout(){switch(super.doLayout(),this._type){case M.Slight:this._symbol=this.slightVibratoGlyph;break;case M.Wide:this._symbol=this.wideVibratoGlyph}this._repeatOffsetX=this.renderer.smuflMetrics.repeatOffsetX.get(this._symbol),this._symbolOffsetY=this.renderer.smuflMetrics.glyphTop.get(this._symbol),this.height=this.renderer.smuflMetrics.glyphHeights.get(this._symbol)}paintGrouped(e,t,s,i){let a=(s-(e+this.x))/this._repeatOffsetX;this._partialWaves||(a=Math.floor(a)),a<1&&(a=1);const r=[];for(let e=0;e<a;e++)r.push(this._symbol);i.fillMusicFontSymbols(e+this.x,t+this.y+this._symbolOffsetY,1,r,!1)}}class Rh extends Ah{get slightVibratoGlyph(){return ne.GuitarVibratoStroke}get wideVibratoGlyph(){return ne.GuitarWideVibratoStroke}}class Oh extends Ah{get slightVibratoGlyph(){return ne.WiggleSawtoothNarrow}get wideVibratoGlyph(){return ne.WiggleSawtooth}}class Wh extends Yo{get notationElement(){return e.NotationElement.EffectSlightBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.vibrato===M.Slight}createNewGlyph(e,t){return new Oh(0,0,M.Slight)}canExpand(e,t){return!0}}class Hh extends Sh{get notationElement(){return e.NotationElement.EffectSlightNoteVibrato}shouldCreateGlyphForNote(e){let t=e.vibrato===M.Slight||e.isTieDestination&&e.tieOrigin.vibrato===M.Slight;return this._hideOnTiedBend&&t&&e.isTieDestination&&e.tieOrigin.hasBend&&(t=!1),t}get sizingMode(){return qn.GroupedOnBeatToEnd}createNewGlyph(e,t){return new Rh(0,0,M.Slight)}constructor(e){super(),this._hideOnTiedBend=e}}class Gh extends pn{constructor(){super(0,0)}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(ne.KeyboardPedalPed)}paint(e,t,s){const i=this.renderer,a=t+this.y,r=this.height,n=i.bar.sustainPedals,o=this.renderer.smuflMetrics.glyphWidths.get(ne.KeyboardPedalPed),h=this.renderer.smuflMetrics.glyphWidths.get(ne.KeyboardPedalUp);let l=0;for(;l<n.length;){let t=n[l];for(;null!=t;){const i=e+this.renderer.getRatioPositionX(t.ratioPosition);let c=0;if(t.pedalType===p.Down?($e.fillMusicFontSymbolSafe(s,i,a+r,1,ne.KeyboardPedalPed,!0),c=o/2+this.renderer.smuflMetrics.sustainPedalLinePadding):t.pedalType===p.Up&&($e.fillMusicFontSymbolSafe(s,i,a+r,1,ne.KeyboardPedalUp,!0),c=h/2+this.renderer.smuflMetrics.sustainPedalLinePadding),t.nextPedalMarker)if(t.nextPedalMarker.bar===t.bar){let n=e+this.renderer.getRatioPositionX(t.nextPedalMarker.ratioPosition)-this.renderer.smuflMetrics.sustainPedalLinePadding;switch(t.nextPedalMarker.pedalType){case p.Down:n-=o/2;break;case p.Hold:break;case p.Up:n-=h/2}const l=i+c;n>l&&s.fillRect(l,a+r-this.renderer.smuflMetrics.pedalLineThickness,n-l,this.renderer.smuflMetrics.pedalLineThickness)}else{const t=e+this.x+this.width,n=i+c;s.fillRect(n,a+r-this.renderer.smuflMetrics.pedalLineThickness,t-n,this.renderer.smuflMetrics.pedalLineThickness)}if(0===l&&t.previousPedalMarker){const t=e+this.x,n=i-c;s.fillRect(t,a+r-this.renderer.smuflMetrics.pedalLineThickness,n-t,this.renderer.smuflMetrics.pedalLineThickness)}l++,null!=t.nextPedalMarker&&t.nextPedalMarker.bar!==t.bar?(t=null,l=n.length):t=t.nextPedalMarker}}}}class Vh extends Yo{get notationElement(){return e.NotationElement.EffectSustainPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return qn.FullBar}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&t.voice.bar.sustainPedals.length>0}createNewGlyph(e,t){return new Gh}canExpand(e,t){return!0}}class Uh extends Yo{get notationElement(){return e.NotationElement.EffectTap}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){return t.slap||t.pop||t.tap}createNewGlyph(e,t){const s=e.resources;return t.slap?new So(0,0,"S",s.effectFont,we.Left):t.pop?new So(0,0,"P",s.effectFont,we.Left):new So(0,0,"T",s.effectFont,we.Left)}canExpand(e,t){return!0}}class zh extends pn{constructor(e){super(0,0),this.tempoAutomations=e}doLayout(){super.doLayout();const e=this.renderer.resources;this.height=this.renderer.smuflMetrics.glyphHeights.get(ne.MetNoteQuarterUp)*e.engravingSettings.tempoNoteScale}paint(e,t,s){for(const i of this.tempoAutomations){let a=e+this.renderer.getRatioPositionX(i.ratioPosition);const r=this.renderer.resources;s.font=r.markerFont;const n=t+this.y+this.height+this.renderer.smuflMetrics.glyphBottom.get(ne.MetNoteQuarterUp)*r.engravingSettings.tempoNoteScale,o=s.textBaseline;if(s.textBaseline=Be.Alphabetic,i.text){const e=`${i.text} `,t=s.measureText(e);s.fillText(e,a,n),a+=t.width}else a-=r.engravingSettings.glyphWidths.get(ne.MetNoteQuarterUp)/2;$e.fillMusicFontSymbolSafe(s,a,n,r.engravingSettings.tempoNoteScale,ne.MetNoteQuarterUp),a+=this.renderer.smuflMetrics.glyphWidths.get(ne.MetNoteQuarterUp)*r.engravingSettings.tempoNoteScale,s.fillText(` = ${i.value.toString()}`,a,n),s.textBaseline=o,a+=s.measureText(` = ${i.value.toString()}`).width}}}class Xh extends Yo{get notationElement(){return e.NotationElement.EffectTempo}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return qn.SinglePreBeat}shouldCreateGlyph(e,t){return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&t.voice.bar.masterBar.tempoAutomations.length>0}createNewGlyph(e,t){return new zh(t.voice.bar.masterBar.tempoAutomations)}canExpand(e,t){return!0}}class Yh extends Yo{get notationElement(){return e.NotationElement.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.text}createNewGlyph(e,t){return new So(0,0,t.text,e.resources.effectFont,we.Left)}canExpand(e,t){return!0}}class Jh extends $o{constructor(e,t){super(Xn.EndBeat),this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=this.renderer.smuflMetrics.glyphHeights.get(ne.OrnamentTrill)}paintGrouped(e,t,s,i){const a=this.renderer.smuflMetrics.glyphWidths.get(ne.OrnamentTrill),r=e+this.x+a,n=this.renderer.smuflMetrics.repeatOffsetX.get(ne.WiggleTrill),o=Math.ceil((s-r)/n),h=[ne.OrnamentTrill];for(let e=0;e<o;e++)h.push(ne.WiggleTrill);i.fillMusicFontSymbols(e+this.x-a/2,t+this.y+this.height,1,h,!1)}}class $h extends Sh{get notationElement(){return e.NotationElement.EffectTrill}shouldCreateGlyphForNote(e){return e.isTrill}get sizingMode(){return qn.GroupedOnBeatToEnd}createNewGlyph(e,t){return new Jh(0,0)}}!function(e){e[e.EighthEighth=0]="EighthEighth",e[e.SixteenthSixteenth=1]="SixteenthSixteenth",e[e.QuarterTripletEighthTriplet=2]="QuarterTripletEighthTriplet",e[e.EighthSixteenthTriplet=3]="EighthSixteenthTriplet",e[e.EighthDottedSixteenth=4]="EighthDottedSixteenth",e[e.SixteenthDottedThirtySecond=5]="SixteenthDottedThirtySecond",e[e.SixteenthEighthDotted=6]="SixteenthEighthDotted",e[e.ThirtySecondSixteenthDotted=7]="ThirtySecondSixteenthDotted"}(jn||(jn={}));class qh extends pn{constructor(e){super(0,0),this._tupletHeight=0,this._tupletPadding=0,this._tripletFeel=e}doLayout(){super.doLayout();const e=this.renderer.smuflMetrics.tempoNoteScale;this.height=this.renderer.smuflMetrics.glyphHeights.get(ne.MetNoteQuarterUp)*e,this._tupletHeight=this.renderer.smuflMetrics.glyphHeights.get(ne.Tuplet3)*e,this._tupletPadding=this.renderer.smuflMetrics.tripletFeelBracketPadding,this.height+=this._tupletHeight}paint(e,t,s){e+=this.x,t+=this.y;let i=jn.EighthEighth,a=jn.EighthEighth;switch(this._tripletFeel){case A.NoTripletFeel:i=jn.EighthEighth,a=jn.EighthEighth;break;case A.Triplet8th:i=jn.EighthEighth,a=jn.QuarterTripletEighthTriplet;break;case A.Triplet16th:i=jn.SixteenthSixteenth,a=jn.EighthSixteenthTriplet;break;case A.Dotted8th:i=jn.EighthEighth,a=jn.EighthDottedSixteenth;break;case A.Dotted16th:i=jn.SixteenthSixteenth,a=jn.SixteenthDottedThirtySecond;break;case A.Scottish8th:i=jn.EighthEighth,a=jn.SixteenthEighthDotted;break;case A.Scottish16th:i=jn.SixteenthSixteenth,a=jn.ThirtySecondSixteenthDotted}const r=this.renderer.smuflMetrics.tempoNoteScale,n=t+this.renderer.smuflMetrics.glyphTop.get(ne.MetNoteQuarterUp)*r,o=t+this.height,h=s.textBaseline;s.textBaseline=Be.Bottom,s.font=this.renderer.resources.effectFont,s.fillText("(",e,o),e+=s.measureText("( ").width,e=this.drawGroup(e,n+this._tupletHeight,s,i),s.fillText(" = ",e,o),e+=s.measureText(" = ").width,e=this.drawGroup(e,n+this._tupletHeight,s,a),s.fillText(" )",e,o),s.textBaseline=h}drawGroup(e,t,s,i){const a=this.renderer.smuflMetrics.tempoNoteScale;let r=[],n=[];const o=[];let h=ne.None;switch(i){case jn.EighthEighth:o.push(we.Center),r=[ne.MetNoteQuarterUp],n=[ne.MetNoteQuarterUp];break;case jn.SixteenthSixteenth:o.push(we.Center),o.push(we.Center),r=[ne.MetNoteQuarterUp],n=[ne.MetNoteQuarterUp];break;case jn.QuarterTripletEighthTriplet:r=[ne.MetNoteQuarterUp],n=[ne.MetNote8thUp],h=ne.Tuplet3;break;case jn.EighthSixteenthTriplet:o.push(we.Center),o.push(we.Right),r=[ne.MetNoteQuarterUp],n=[ne.MetNoteQuarterUp],h=ne.Tuplet3;break;case jn.EighthDottedSixteenth:o.push(we.Center),o.push(we.Right),r=[ne.MetNoteQuarterUp,ne.Space,ne.MetAugmentationDot],n=[ne.MetNoteQuarterUp];break;case jn.SixteenthDottedThirtySecond:o.push(we.Center),o.push(we.Center),o.push(we.Right),r=[ne.MetNoteQuarterUp,ne.Space,ne.MetAugmentationDot],n=[ne.MetNoteQuarterUp];break;case jn.SixteenthEighthDotted:o.push(we.Center),o.push(we.Left),r=[ne.MetNoteQuarterUp],n=[ne.MetNoteQuarterUp,ne.Space,ne.MetAugmentationDot];break;case jn.ThirtySecondSixteenthDotted:o.push(we.Center),o.push(we.Center),o.push(we.Left),r=[ne.MetNoteQuarterUp],n=[ne.MetNoteQuarterUp,ne.Space,ne.MetAugmentationDot]}const l=this.renderer.smuflMetrics.glyphWidths.get(ne.MetNoteQuarterUp)*a,c=e+l-this.renderer.smuflMetrics.stemThickness*a,d=c+2*l+this.renderer.smuflMetrics.stemThickness*a,u=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamThickness,p=this.renderer.smuflMetrics.tempoNoteScale*this.renderer.smuflMetrics.beamSpacing,m=this.renderer.smuflMetrics.brokenBeamWidth*a;let g=t-this.renderer.smuflMetrics.glyphHeights.get(ne.MetNoteQuarterUp)*a+u;if(h!==ne.None){const t=(e+d)/2,i=g-this._tupletHeight-this._tupletPadding,r=this.renderer.smuflMetrics.glyphTop.get(h)*a,n=this.renderer.smuflMetrics.glyphWidths.get(h)*a;$e.fillMusicFontSymbolSafe(s,t,i+r,a,h,!0);const o=t-n/2-this._tupletPadding,l=t+n/2+this._tupletPadding,c=this._tupletHeight/2,u=s.lineWidth;s.beginPath(),s.moveTo(e,i+c+c),s.lineTo(e,i+c),s.lineTo(o,i+c),s.moveTo(l,i+c),s.lineTo(d,i+c),s.lineTo(d,i+c+c),s.lineWidth=this.renderer.smuflMetrics.tupletBracketThickness*a,s.stroke(),s.lineWidth=u}s.fillMusicFontSymbols(e,t,a,r,!1),e+=l,e+=l,s.fillMusicFontSymbols(e,t,a,n,!1),e+=l,n[n.length-1]!==ne.MetAugmentationDot&&n[0]!==ne.MetNote8thUp||(e+=l);for(const e of o){switch(e){case we.Left:s.fillRect(c,g,m,u);break;case we.Center:s.fillRect(c,g,d-c,u);break;case we.Right:s.fillRect(d-m,g,m,u)}g+=u+p}return e}}class jh extends Yo{get notationElement(){return e.NotationElement.EffectTripletFeel}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return qn.SinglePreBeat}shouldCreateGlyph(e,t){return 0===t.index&&(0===t.voice.bar.masterBar.index&&t.voice.bar.masterBar.tripletFeel!==A.NoTripletFeel||t.voice.bar.masterBar.index>0&&t.voice.bar.masterBar.tripletFeel!==t.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(e,t){return new qh(t.voice.bar.masterBar.tripletFeel)}canExpand(e,t){return!0}}class Kh extends mn{constructor(e){super(0,0,1,Kh.getSymbol(e)),this.center=!0}static getSymbol(e){switch(e){case ge.Open:return ne.GuitarOpenPedal;case ge.Closed:return ne.GuitarClosePedal}return ne.None}paint(e,t,s){super.paint(e,t+this.height,s)}}class Qh extends Yo{get notationElement(){return e.NotationElement.EffectWahPedal}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.SingleOnBeat}shouldCreateGlyph(e,t){return t.wahPedal!==ge.None}createNewGlyph(e,t){return new Kh(t.wahPedal)}canExpand(e,t){return!1}}class Zh extends Yo{get notationElement(){return e.NotationElement.EffectWhammyBar}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return qn.GroupedOnBeat}shouldCreateGlyph(e,t){return t.hasWhammyBar}createNewGlyph(e,t){return new qo("w/bar")}canExpand(e,t){return!0}}class el extends Yo{get notationElement(){return e.NotationElement.EffectWideBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return qn.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.vibrato===M.Wide}createNewGlyph(e,t){return new Oh(0,0,M.Wide)}canExpand(e,t){return!0}}class tl extends Sh{get notationElement(){return e.NotationElement.EffectWideNoteVibrato}shouldCreateGlyphForNote(e){return e.vibrato===M.Wide||e.isTieDestination&&e.tieOrigin.vibrato===M.Wide}get sizingMode(){return qn.GroupedOnBeatToEnd}createNewGlyph(e,t){return new Rh(0,0,M.Wide)}}class sl{constructor(){this.x=0,this.width=0,this.masterBars=[]}}class il extends Co{constructor(){super(...arguments),this._system=null}get name(){return"HorizontalScreen"}get supportsResize(){return!1}get firstBarX(){let e=this.pagePadding[0];return this._system&&(e+=this._system.accoladeWidth),e}doResize(){}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case e.SystemsLayoutMode.Automatic:this.systemsLayoutMode=Yn.Automatic;break;case e.SystemsLayoutMode.UseModelLayout:this.systemsLayoutMode=Yn.FromModelWithWidths}const t=this.renderer.score;let s=this.renderer.settings.display.startBar;s--,s=Math.min(t.masterBars.length-1,Math.max(0,s));let i=s,a=this.renderer.settings.display.barCount;a<=0&&(a=t.masterBars.length),a=s+a-1,a=Math.min(t.masterBars.length-1,Math.max(0,a)),this._system=this.createEmptyStaffSystem(),this._system.isLast=!0,this._system.x=this.pagePadding[0],this._system.y=this.pagePadding[1];const r=this.renderer.settings.display.barCountPerPartial,n=[];let o=new sl,h=0;for(;i<=a;){const e=this.multiBarRestInfo,s=null!==e&&e.has(i)?e.get(i):null,a=this._system.addBars(this.renderer.tracks,i,s);if(0===o.masterBars.length&&a.isLinkedToPrevious&&n.length>0){const e=n[n.length-1];e.masterBars.push(t.masterBars[i]),e.width+=a.width,h+=a.width,o.x+=h}else o.masterBars.push(t.masterBars[i]),o.width+=a.width,o.masterBars.length>=r&&(0===n.length&&(o.width+=this._system.accoladeWidth+this.pagePadding[0]),h+=o.width,n.push(o),ee.debug(this.name,`Finished partial from bar ${o.masterBars[0].index} to ${o.masterBars[o.masterBars.length-1].index}`,null),o=new sl,o.x=h);i++}o.masterBars.length>0&&(0===n.length&&(o.width+=this._system.accoladeWidth+this.pagePadding[0]),n.push(o),ee.debug(this.name,`Finished partial from bar ${o.masterBars[0].index} to ${o.masterBars[o.masterBars.length-1].index}`,null)),this.finalizeStaffSystem();const l=this.renderer.settings.display.scale;this.height=Math.floor(this._system.y+this._system.height)*l,this.width=(this._system.x+this._system.width+this.pagePadding[2])*l,i=0;let c=0;for(let e=0;e<n.length;e++){const t=n[e],s=new Hr;s.x=c,s.y=0,s.totalWidth=this.width/l,s.totalHeight=this.height/l,s.width=t.width,s.height=this.height/l,s.firstMasterBarIndex=t.masterBars[0].index,s.lastMasterBarIndex=t.masterBars[t.masterBars.length-1].index,c+=t.width;const a=i,r=e;this._system.buildBoundingsLookup(0,0),this.registerPartial(s,e=>{let s=this._system.getBarX(t.masterBars[0].index)+this._system.accoladeWidth;0===r&&(s-=this._system.x+this._system.accoladeWidth),e.color=this.renderer.settings.display.resources.mainGlyphColor,e.textAlign=we.Left,ee.debug(this.name,`Rendering partial from bar ${t.masterBars[0].index} to ${t.masterBars[t.masterBars.length-1].index}`,null),this._system.paintPartial(-s,this._system.y,e,a,t.masterBars.length)}),i+=t.masterBars.length}this.height=this.layoutAndRenderBottomScoreInfo(this.height),this.height=this.layoutAndRenderAnnotation(this.height),this.height+=this.pagePadding[3]}finalizeStaffSystem(){this._system.scaleToWidth(this._system.width),this._system.finalizeSystem()}}class al extends Co{constructor(){super(...arguments),this._systems=[],this._allMasterBarRenderers=[],this._barsFromPreviousSystem=[]}get name(){return"PageView"}doLayoutAndRender(){switch(this.renderer.settings.display.systemsLayoutMode){case e.SystemsLayoutMode.Automatic:this.systemsLayoutMode=Yn.Automatic;break;case e.SystemsLayoutMode.UseModelLayout:this.systemsLayoutMode=Yn.FromModelWithScale}let t=this.pagePadding[1];this.width=this.renderer.width,this._allMasterBarRenderers=[],t=this.layoutAndRenderScoreInfo(t,-1),t=this.layoutAndRenderTunings(t,-1),t=this.layoutAndRenderChordDiagrams(t,-1),t=this.layoutAndRenderScore(t),t=this.layoutAndRenderBottomScoreInfo(t),t=this.layoutAndRenderAnnotation(t),this.height=(t+this.pagePadding[3])*this.renderer.settings.display.scale}get supportsResize(){return!0}get firstBarX(){let e=this.pagePadding[0];return this._systems.length>0&&(e+=this._systems[0].accoladeWidth),e}doResize(){let e=this.pagePadding[1];this.width=this.renderer.width;const t=this.height;e=this.layoutAndRenderScoreInfo(e,t),e=this.layoutAndRenderTunings(e,t),e=this.layoutAndRenderChordDiagrams(e,t),e=this.resizeAndRenderScore(e,t),e=this.layoutAndRenderBottomScoreInfo(e),e=this.layoutAndRenderAnnotation(e),this.height=(e+this.pagePadding[3])*this.renderer.settings.display.scale}layoutAndRenderTunings(e,t=-1){if(!this.tuningGlyph)return e;const s=this.renderer.settings.display.resources;this.tuningGlyph.x=this.pagePadding[0],this.tuningGlyph.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.tuningGlyph.doLayout();const i=Math.round(this.tuningGlyph.height),a=new Hr;return a.x=0,a.y=e,a.width=this.scaledWidth,a.height=i,a.totalWidth=this.scaledWidth,a.totalHeight=t<0?e+a.height:t,this.registerPartial(a,e=>{e.color=s.scoreInfoColor,e.textAlign=we.Center,this.tuningGlyph.paint(0,0,e)}),e+i}layoutAndRenderChordDiagrams(e,t=-1){if(!this.chordDiagrams)return e;const s=this.renderer.settings.display.resources;this.chordDiagrams.x=this.pagePadding[0],this.chordDiagrams.width=this.scaledWidth-this.pagePadding[0]-this.pagePadding[2],this.chordDiagrams.doLayout();const i=Math.round(this.chordDiagrams.height),a=new Hr;return a.x=0,a.y=e,a.width=this.scaledWidth,a.height=i,a.totalWidth=this.scaledWidth,a.totalHeight=t<0?e+i:t,this.registerPartial(a,e=>{e.color=s.scoreInfoColor,e.textAlign=we.Center,this.chordDiagrams.paint(0,0,e)}),e+i}layoutAndRenderScoreInfo(e,t=-1){ee.debug(this.name,"Layouting score info");const s=new Hr;s.x=0,s.y=e;let i=0;const a=this.renderer.settings.display.resources,r=[];for(const[e,t]of Co.HeaderElements.value)if(this.headerGlyphs.has(e)){const t=this.headerGlyphs.get(e);t.y=i,this.alignScoreInfoGlyph(t);let s=t.font.size;if(e===ke.Words&&this.headerGlyphs.has(ke.Music)){this.headerGlyphs.get(ke.Music).textAlign!==t.textAlign&&(s=0)}i+=s,r.push(t)}return r.length>0&&(i=Math.floor(i+17),s.width=this.scaledWidth,s.height=i,s.totalWidth=this.scaledWidth,s.totalHeight=t<0?e+s.height:t,this.registerPartial(s,e=>{e.color=a.scoreInfoColor,e.textAlign=we.Center;for(const t of r)t.paint(0,0,e)})),e+i}resizeAndRenderScore(e,t){if(this.renderer.settings.display.barsPerRow>0||this.systemsLayoutMode===Yn.FromModelWithScale)for(let s=0;s<this._systems.length;s++){const i=this._systems[s];this.fitSystem(i),e+=this.paintSystem(i,t)}else{this._systems=[];let s=0;const i=this.maxWidth;let a=this.createEmptyStaffSystem();for(a.index=this._systems.length,a.x=this.pagePadding[0],a.y=e;s<this._allMasterBarRenderers.length;){let r=this._allMasterBarRenderers[s];if(a.width+r.width<=i||0===a.masterBarsRenderers.length)a.addMasterBarRenderers(this.renderer.tracks,r),s++;else{for(;r&&!r.canWrap&&a.masterBarsRenderers.length>1;)r=a.revertLastBar(),s--;a.isFull=!0,a.isLast=this.lastBarIndex===a.lastBarIndex,this._systems.push(a),this.fitSystem(a),e+=this.paintSystem(a,t),a=this.createEmptyStaffSystem(),a.index=this._systems.length,a.x=this.pagePadding[0],a.y=e}}a.isLast=this.lastBarIndex===a.lastBarIndex,this.fitSystem(a),e+=this.paintSystem(a,t)}return e}layoutAndRenderScore(e){let t=this.firstBarIndex;const s=this.lastBarIndex;for(this._systems=[];t<=s;){const i=this.createStaffSystem(t,s);this._systems.push(i),i.x=this.pagePadding[0],i.y=e,t=i.lastBarIndex+1,this.fitSystem(i),ee.debug(this.name,`Rendering partial from bar ${i.firstBarIndex} to ${i.lastBarIndex}`,null),e+=this.paintSystem(i,e)}return e}paintSystem(e,t){const s=Math.floor(e.height),i=new Hr;return i.x=0,i.y=e.y,i.totalWidth=this.scaledWidth,i.totalHeight=t,i.width=this.scaledWidth,i.height=s,i.firstMasterBarIndex=e.firstBarIndex,i.lastMasterBarIndex=e.lastBarIndex,e.buildBoundingsLookup(0,0),this.registerPartial(i,t=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=we.Left,e.paint(0,-i.y/this.renderer.settings.display.scale,t)}),s}fitSystem(e){e.isFull||e.width>this.maxWidth||this.renderer.settings.display.justifyLastSystem?e.scaleToWidth(this.maxWidth):e.scaleToWidth(e.width),e.finalizeSystem()}getBarsPerSystem(e){let t=this.renderer.settings.display.barsPerRow;if(this.systemsLayoutMode===Yn.FromModelWithScale){let s,i;this.renderer.tracks.length>1?(s=this.renderer.score.defaultSystemsLayout,i=this.renderer.score.systemsLayout):(s=this.renderer.tracks[0].defaultSystemsLayout,i=this.renderer.tracks[0].systemsLayout),t=e<i.length?i[e]:s}return t}createStaffSystem(e,t){const s=this.createEmptyStaffSystem();s.index=this._systems.length;const i=this.getBarsPerSystem(s.index),a=this.maxWidth,r=t+1;let n=e;for(;n<r;){if(this._barsFromPreviousSystem.length>0)for(const e of this._barsFromPreviousSystem)s.addMasterBarRenderers(this.renderer.tracks,e),n=e.lastMasterBarIndex;else{const e=this.multiBarRestInfo,t=null!==e&&e.has(n)?e.get(n):null,i=s.addBars(this.renderer.tracks,n,t);this._allMasterBarRenderers.push(i),n=i.lastMasterBarIndex}this._barsFromPreviousSystem=[];let e=!1;if((-1===i&&s.width>=a&&0!==s.masterBarsRenderers.length||s.masterBarsRenderers.length===i+1)&&(e=!0),e){let e=s.revertLastBar();if(e)for(this._barsFromPreviousSystem.push(e);e&&!e.canWrap&&s.masterBarsRenderers.length>1;)e=s.revertLastBar(),e&&this._barsFromPreviousSystem.push(e);return s.isFull=!0,s.isLast=!1,this._barsFromPreviousSystem.reverse(),s}let t=!1,r=!0;for(const e of this.renderer.tracks)e.lineBreaks&&e.lineBreaks.has(n+1)?t=!0:r=!1;if(t&&r)return s.isFull=!0,s.isLast=!1,s;s.x=0,n++}return s.isLast=t===s.lastBarIndex,s}get maxWidth(){return this.scaledWidth-this.pagePadding[0]-this.pagePadding[2]}}class rl extends un{constructor(e,t,s){super(e,t),this.width=s}}class nl extends un{doLayout(){this.width=this.renderer.smuflMetrics.thinBarlineThickness}}class ol extends nl{constructor(e,t,s){super(e,t),this._isRepeat=s}doLayout(){this.width=this._isRepeat?this.renderer.smuflMetrics.repeatEndingLineThickness:this.renderer.smuflMetrics.thinBarlineThickness}paint(e,t,s){s.fillRect(e+this.x,t+this.y,this.renderer.smuflMetrics.thinBarlineThickness,this.height)}}class hl extends nl{paint(e,t,s){const i=this.renderer.smuflMetrics.thinBarlineThickness/2,a=this.renderer.getLineHeight(1);let r=t+this.y+.5*a+i;const n=t+this.y+this.height;for(;r<n;)s.fillCircle(e+this.x,r,i),r+=a}}class ll extends nl{paint(e,t,s){const i=this.renderer.smuflMetrics.dashedBarlineDashLength,a=e+this.x-this.width/2,r=Math.ceil(this.height/2/i),n=t+this.y+this.height,o=this.renderer.smuflMetrics.dashedBarlineGapLength,h=s.lineWidth;if(s.lineWidth=this.renderer.smuflMetrics.dashedBarlineThickness,s.beginPath(),r<1)s.moveTo(a,t+this.y),s.lineTo(a,n);else{let e=t+this.y;for(;e<n;){s.moveTo(a,e);const t=Math.min(n-e,i);s.lineTo(a,e+t),e+=i+o}}s.stroke(),s.lineWidth=h}}class cl extends nl{doLayout(){this.width=this.renderer.smuflMetrics.thickBarlineThickness}paint(e,t,s){s.fillRect(e+this.x,t+this.y,this.width,this.height)}}class dl extends nl{doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(ne.RepeatDot)}paint(e,t,s){const i=this.renderer,a=i.heightLineCount%2==0?1:.5,r=t+this.y+this.height/2,n=i.getLineHeight(a),o=i.smuflMetrics.glyphTop.get(ne.RepeatDot)-i.smuflMetrics.glyphHeights.get(ne.RepeatDot)/2;$e.fillMusicFontSymbolSafe(s,e+this.x,r+o-n,1,ne.RepeatDot),$e.fillMusicFontSymbolSafe(s,e+this.x,r+o+n,1,ne.RepeatDot)}}class ul extends nl{paint(e,t,s){const i=this.renderer;if(i.drawnLineCount-1<=2)return;const a=i.smuflMetrics.staffLineThickness/2,r=(i.drawnLineCount-1)/2,n=i.getLineY(r-1)-a,o=i.getLineY(r+1)+a;s.fillRect(e+this.x,t+n,i.smuflMetrics.thinBarlineThickness,o-n)}}class pl extends nl{paint(e,t,s){const i=this.renderer.getLineHeight(1),a=-i/2+1;s.fillRect(e+this.x,t+this.y+a,1,i)}}class ml extends io{constructor(e){super(),this._isRight=e}doLayout(){const e=this.renderer.bar,t=e.masterBar,s=this._isRight?e.getActualBarLineRight():e.getActualBarLineLeft(0===this.renderer.index),i=this._isRight&&t.isRepeatEnd||!this._isRight&&t.isRepeatStart;let a=g.Automatic;if(!this._isRight){const e=this.renderer.previousRenderer;if(e&&e.staff===this.renderer.staff&&(a=e.bar.getActualBarLineRight(),s===a))return}switch(this._isRight&&t.isRepeatEnd&&(this.addGlyph(new dl(0,0)),this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation),s){case g.Dashed:this.addGlyph(new ll(0,0));break;case g.Dotted:this.addGlyph(new hl(0,0));break;case g.Heavy:a!==g.LightHeavy&&a!==g.HeavyHeavy&&this.addGlyph(new cl(0,0));break;case g.HeavyHeavy:a!==g.LightHeavy&&a!==g.Heavy&&this.addGlyph(new cl(0,0)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new cl(0,0));break;case g.HeavyLight:a!==g.LightHeavy&&a!==g.Heavy&&a!==g.HeavyHeavy&&this.addGlyph(new cl(0,0)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new ol(0,0,i));break;case g.LightHeavy:a!==g.HeavyLight&&a!==g.Regular&&a!==g.LightLight&&this.addGlyph(new ol(0,0,i)),this.width+=this.renderer.smuflMetrics.thinThickBarlineSeparation,this.addGlyph(new cl(0,0));break;case g.LightLight:a!==g.HeavyLight&&a!==g.Regular&&this.addGlyph(new ol(0,0,i)),this.width+=this.renderer.smuflMetrics.barlineSeparation,this.addGlyph(new ol(0,0,i));break;case g.None:break;case g.Regular:a!==g.HeavyLight&&a!==g.LightLight&&this.addGlyph(new ol(0,0,i));break;case g.Short:this.addGlyph(new ul(0,0));break;case g.Tick:this.addGlyph(new pl(0,0))}this._isRight||t.isRepeatStart&&(this.width+=this.renderer.smuflMetrics.repeatBarlineDotSeparation,this.addGlyph(new dl(0,0)));const r=this.renderer,n=r.smuflMetrics.staffLineThickness,o=this.y+r.topPadding-n,h=this.y+this.renderer.height-this.renderer.bottomPadding-o;for(const e of this.glyphs)e.y=o,e.height=h}paint(e,t,s){const i=this.renderer,a=ao.bar(s,i.barLineBarSubElement,this.renderer.bar,!0);try{super.paint(e,t,s)}finally{a?.[Symbol.dispose]?.()}}}class gl extends un{constructor(e,t,s){super(e,t),this._count=0,this._count=0,this._count=s}doLayout(){this.width=0}paint(e,t,s){const i=ao.bar(s,this.renderer.repeatsBarSubElement,this.renderer.bar);try{const i=this.renderer.resources,a=s.textAlign;s.font=i.barNumberFont,s.textAlign=we.Right;const r=`x${this._count}`,n=s.measureText(r).width/1.5;s.fillText(r,e+this.x-n,t+this.y),s.textAlign=a}finally{i?.[Symbol.dispose]?.()}}}class fl extends un{constructor(e,t,s){super(e,t),this._number=`${s}  `}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.barNumberFont,this.width=this.renderer.scoreRenderer.canvas.measureText(this._number).width}paint(e,t,s){if(!this.renderer.staff.isFirstInSystem)return;const i=ao.bar(s,this.renderer.barNumberBarSubElement,this.renderer.bar,!0);try{const i=this.renderer.resources,a=s.textBaseline;s.textBaseline=Be.Top,s.font=i.barNumberFont,s.fillText(this._number,e+this.x,t+this.y),s.textBaseline=a}finally{i?.[Symbol.dispose]?.()}}}class yl extends Oo{constructor(){super(...arguments),this.firstLineY=0,this._startSpacing=!1,this.tupletSize=0}get lineOffset(){return this.lineSpacing}get tupletOffset(){return.5*this.smuflMetrics.oneStaffSpace}get topGlyphOverflow(){return this.smuflMetrics.oneStaffSpace}get bottomGlyphOverflow(){return this.smuflMetrics.oneStaffSpace}initLineBasedSizes(){this.topPadding=this.topGlyphOverflow,this.bottomPadding=this.bottomGlyphOverflow,this.height=this.lineOffset*(this.heightLineCount-1)+this.topPadding+this.bottomPadding}updateSizes(){this.initLineBasedSizes(),this.adjustSizes(),this.updateFirstLineY(),super.updateSizes()}adjustSizes(){}updateFirstLineY(){const e=this.lineOffset*(this.heightLineCount-1),t=(this.drawnLineCount-1)*this.lineOffset,s=this.smuflMetrics.staffLineThickness/2;this.firstLineY=(this.topPadding+(e-t)/2|0)-s}doLayout(){this.initLineBasedSizes(),this.updateFirstLineY(),this.tupletSize=this.smuflMetrics.glyphHeights.get(ne.Tuplet0),super.doLayout()}getLineY(e){return this.firstLineY+this.getLineHeight(e)}getLineHeight(e){return this.lineOffset*e}paintBackground(e,t,s){super.paintBackground(e,t,s),this.paintStaffLines(e,t,s),this.paintSimileMark(e,t,s)}paintStaffLines(e,t,s){const i=ao.bar(s,this.staffLineBarSubElement,this.bar,!0);try{const i=[];for(let e=0,t=this.drawnLineCount;e<t;e++)i.push([]);this.additionalMultiRestBars||this.collectSpaces(i);for(const e of i)e.sort((e,t)=>e[0]>t[0]?1:e[0]<t[0]?-1:0);const a=this.width,r=this.smuflMetrics.staffLineThickness/2;for(let n=0;n<this.drawnLineCount;n++){const o=this.getLineY(n)-r;let h=0;for(const a of i[n])s.fillRect(e+this.x+h,t+this.y+o,a[0]-h,this.smuflMetrics.staffLineThickness),h=a[0]+a[1];s.fillRect(e+this.x+h,t+this.y+o,a-h,this.smuflMetrics.staffLineThickness)}}finally{i?.[Symbol.dispose]?.()}}collectSpaces(e){}createStartSpacing(){if(this._startSpacing)return;const e=0===this.index?this.settings.display.firstStaffPaddingLeft:this.settings.display.staffPaddingLeft;this.addPreBeatGlyph(new rl(0,0,e)),this._startSpacing=!0}paintTuplets(e,t,s,i,a=!1){for(const r of this.bar.voices)if(this.hasVoiceContainer(r)){const n=this.getVoiceContainer(r);for(const r of n.tupletGroups)this.paintTupletHelper(e+this.beatGlyphsStart,t,s,r,i,a)}}getTupletBeamDirection(e){return this.getBeamDirection(e)}paintTupletHelper(e,t,s,i,a,r){const n=this.resources,o=s.textAlign,h=s.textBaseline;let l;s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.textAlign=we.Center,s.textBaseline=Be.Middle;const c=i.beats[0].tupletNumerator,d=i.beats[0].tupletDenominator;if(2===c&&3===d)l=[ne.Tuplet2];else if(3===c&&2===d)l=[ne.Tuplet3];else if(4===c&&6===d)l=[ne.Tuplet4];else if(5===c&&4===d)l=[ne.Tuplet5];else if(6===c&&4===d)l=[ne.Tuplet6];else if(7===c&&4===d)l=[ne.Tuplet7];else if(9===c&&8===d)l=[ne.Tuplet9];else if(10===c&&8===d)l=[ne.Tuplet1,ne.Tuplet0];else if(11===c&&8===d)l=[ne.Tuplet1,ne.Tuplet1];else if(12===c&&8===d)l=[ne.Tuplet1,ne.Tuplet2];else if(13===c&&8===d)l=[ne.Tuplet1,ne.Tuplet3];else{l=[];const e=ne.Tuplet0;c>10?(l.push(e+Math.floor(c/10)),l.push(e+(c-10))):l.push(e+c),l.push(ne.TupletColon),d>10?(l.push(e+Math.floor(d/10)),l.push(e+(d-10))):l.push(e+d)}const u=this.tupletOffset,p=this.tupletSize,m=ao.beat(s,a,i.beats[0]);try{const a=s.lineWidth;if(s.lineWidth=this.smuflMetrics.tupletBracketThickness,1!==i.beats.length&&i.isFull){const a=i.beats[0],o=i.beats[i.beats.length-1];let h=null,c=null;for(let e=0;e<i.beats.length;e++)if(!i.beats[e].isRest){h=i.beats[e];break}for(let e=i.beats.length-1;e>=0;e--)if(!i.beats[e].isRest){c=i.beats[e];break}let d=!1;h||(h=a,d=!0),c||(c=o);const m=this.getBeatX(a,Xn.OnNotes)-this.beatGlyphsStart,g=this.getBeatX(o,Xn.PostNotes)-this.beatGlyphsStart,f=this.helpers.beamHelperLookup[i.voice.index].get(h.index),y=this.helpers.beamHelperLookup[i.voice.index].get(c.index),b=this.getTupletBeamDirection(f);let S=this.calculateBeamYWithDirection(f,m,b),w=this.calculateBeamYWithDirection(y,g,b);d&&(S=Math.max(S,w),w=S);const B=u+.5*p;b===Pe.Down?(S+=B,w+=B):(S-=B,w-=B);const k=l.reduce((e,t)=>e+n.engravingSettings.glyphWidths.get(t),0),T=.5*n.engravingSettings.oneStaffSpace,_=(m+g)/2,x=_-k/2-T,N=_+k/2+T,P=(w-S)/(g-m),v=S-P*m,E=P*x+v,M=P*_+v,F=P*N+v,C=b===Pe.Down?S-.5*p:S+.5*p,D=b===Pe.Down?w-.5*p:w+.5*p,L=s.lineWidth%2==0?0:.5;e+=L,t+=L,x>m&&(s.beginPath(),s.moveTo(e+this.x+m,t+this.y+C),r?s.quadraticCurveTo(e+this.x+(x+m)/2,t+this.y+E,e+this.x+x,t+this.y+E):(s.lineTo(e+this.x+m,t+this.y+S),s.lineTo(e+this.x+x,t+this.y+E)),s.moveTo(e+this.x+N,t+this.y+F),r?s.quadraticCurveTo(e+this.x+(g+N)/2,t+this.y+F,e+this.x+g,t+this.y+D):(s.lineTo(e+this.x+g,t+this.y+w),s.lineTo(e+this.x+g,t+this.y+D)),s.stroke()),s.fillMusicFontSymbols(e+this.x+_,t+this.y+M+.5*p,1,l,!0)}else for(const a of i.beats){const r=this.helpers.beamHelperLookup[i.voice.index].get(a.index);if(!r)continue;const n=this.getTupletBeamDirection(r),o=r.getBeatLineX(a);let h=this.calculateBeamYWithDirection(r,o,n);n===Pe.Down?h+=u+p:h-=u+p,s.fillMusicFontSymbols(e+this.x+o,t+this.y+h,1,l,!0)}s.textAlign=o,s.textBaseline=h,s.lineWidth=a}finally{m?.[Symbol.dispose]?.()}}paintBeams(e,t,s,i,a){for(const r of this.helpers.beamHelpers)for(const n of r)this.paintBeamHelper(e+this.beatGlyphsStart,t,s,n,i,a)}drawBeamHelperAsFlags(e){return 1===e.beats.length}paintBeamHelper(e,t,s,i,a,r){s.color=0===i.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,i.isRestBeamHelper||(this.drawBeamHelperAsFlags(i)?this.paintFlag(e,t,s,i,a):this.paintBar(e,t,s,i,r))}shouldPaintFlag(t,s){return t.graceType!==T.BendGrace&&(!t.deadSlapped&&(!!s.hasBeatLineX(t)&&((t.graceType===T.None||this.settings.notation.notationMode!==e.NotationMode.SongBook)&&(t.duration!==k.Whole&&t.duration!==k.DoubleWhole&&t.duration!==k.QuadrupleWhole))))}paintFlag(e,t,s,i,a){for(const r of i.beats){if(!this.shouldPaintFlag(r,i))continue;const n=r.graceType!==T.None,o=i.getBeatLineX(r),h=this.getBeamDirection(i),l=t+this.y+this.getFlagTopY(r,h),c=t+this.y+this.getFlagBottomY(r,h);let d=0;if(d=h===Pe.Down?c:l,!i.hasLine(!0,r))continue;this.paintBeamingStem(r,t+this.y,e+this.x+o,l,c,s);const u=ao.beat(s,a,r);try{let t=0;if(i.hasFlag(!0,r)){const i=new yn(e+this.x+o,d,r.duration,h,n);i.renderer=this,i.doLayout(),i.paint(0,0,s),t=i.width/2}r.graceType===T.BeforeBeat&&(h===Pe.Down?$e.fillMusicFontSymbolSafe(s,e+this.x+o+t/2,(l+c-this.smuflMetrics.glyphHeights.get(ne.GraceNoteSlashStemDown))/2,fn.GraceScale,ne.GraceNoteSlashStemDown,!0):$e.fillMusicFontSymbolSafe(s,e+this.x+o+t/2,(l+c+this.smuflMetrics.glyphHeights.get(ne.GraceNoteSlashStemUp))/2,fn.GraceScale,ne.GraceNoteSlashStemUp,!0))}finally{u?.[Symbol.dispose]?.()}}}getFlagStemSize(e,t=!1){let s=0;switch(e){case k.QuadrupleWhole:case k.Half:case k.Quarter:case k.Eighth:case k.Sixteenth:case k.ThirtySecond:case k.SixtyFourth:case k.OneHundredTwentyEighth:case k.TwoHundredFiftySixth:s=this.smuflMetrics.standardStemLength+this.smuflMetrics.stemFlagOffsets.get(e);break;default:s=t?this.smuflMetrics.standardStemLength:0}return s}recreatePreBeatGlyphs(){this._startSpacing=!1,super.recreatePreBeatGlyphs()}calculateBeamY(e,t){return this.calculateBeamYWithDirection(e,t,this.getBeamDirection(e))}createPreBeatGlyphs(){super.createPreBeatGlyphs(),this.addPreBeatGlyph(new ml(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new fl(0,this.getLineHeight(-.25),this.bar.index+1))}createPostBeatGlyphs(){super.createPostBeatGlyphs();const e=this.lastBar;this.addPostBeatGlyph(new ml(!0)),e.masterBar.isRepeatEnd&&e.masterBar.repeatCount>2&&this.addPostBeatGlyph(new gl(0,this.getLineHeight(-.25),this.bar.masterBar.repeatCount))}paintBar(e,t,s,i,a){const r=this.getBeamDirection(i),n=i.graceType!==T.None?fn.GraceScale:1;let o=(this.smuflMetrics.beamSpacing+this.smuflMetrics.beamThickness)*n,h=this.smuflMetrics.beamThickness*n;r===Pe.Down&&(o=-o,h=-h);for(let l=0,c=i.beats.length;l<c;l++){const c=i.beats[l];if(!i.hasBeatLineX(c)||c.deadSlapped)continue;const d=i.getBeatLineX(c),u=t+this.y+this.getBarLineStart(c,r),p=t+this.y+this.calculateBeamY(i,d)|0;u<p?this.paintBeamingStem(c,t+this.y,e+this.x+d,u,p,s):this.paintBeamingStem(c,t+this.y,e+this.x+d,p,u,s);const m=ao.beat(s,a,c);try{const a=this.smuflMetrics.brokenBeamWidth*n,r=De.getIndex(c.duration)-2,u=t+this.y;for(let t=0;t<r;t++){let n=0,p=0,m=0,g=0;const f=u+t*o;if(l<i.beats.length-1){const o=lo.isFullBarJoin(c,i.beats[l+1],t);if(t===r-1&&o&&c.beamingMode===be.ForceSplitOnSecondaryToNext)n=d,p=n+a,m=f+this.calculateBeamY(i,n),g=f+this.calculateBeamY(i,p),yl.paintSingleBar(s,e+this.x+n,m,e+this.x+p,g,h),p=i.getBeatLineX(i.beats[l+1]),n=p-a,m=f+this.calculateBeamY(i,n),g=f+this.calculateBeamY(i,p),yl.paintSingleBar(s,e+this.x+n,m,e+this.x+p,g,h);else{if(o)n=d,p=i.getBeatLineX(i.beats[l+1]);else{if(0!==l&&lo.isFullBarJoin(i.beats[l-1],c,t))continue;n=d,p=n+a}m=f+this.calculateBeamY(i,n),g=f+this.calculateBeamY(i,p),0===t&&(m|=0,g|=0),yl.paintSingleBar(s,e+this.x+n,m,e+this.x+p,g,h)}}else l>0&&!lo.isFullBarJoin(c,i.beats[l-1],t)&&(n=d-a,p=d,p=d,m=f+this.calculateBeamY(i,n),g=f+this.calculateBeamY(i,p),yl.paintSingleBar(s,e+this.x+n,m,e+this.x+p,g,h))}}finally{m?.[Symbol.dispose]?.()}}if(i.graceType===T.BeforeBeat){const a=i.getBeatLineX(i.beats[0]),n=this.smuflMetrics.glyphWidths.get(ne.Flag8thUp)*fn.GraceScale;let l=t+this.y+this.calculateBeamY(i,a)|0;l+=h+o,r===Pe.Down?$e.fillMusicFontSymbolSafe(s,e+this.x+a+n/2,l,fn.GraceScale,ne.GraceNoteSlashStemDown,!0):$e.fillMusicFontSymbolSafe(s,e+this.x+a+n/2,l,fn.GraceScale,ne.GraceNoteSlashStemUp,!0)}}static paintSingleBar(e,t,s,i,a,r){e.beginPath(),e.moveTo(t,s),e.lineTo(i,a),e.lineTo(i,a+r),e.lineTo(t,s+r),e.closePath(),e.fill()}}class bl extends un{constructor(e,t,s){super(0,0),this.yOffset=0,this.startNoteRenderer=null,this.endNoteRenderer=null,this.tieDirection=Pe.Up,this._startX=0,this._startY=0,this._endX=0,this._endY=0,this._tieHeight=0,this._shouldDraw=!1,this.startBeat=e,this.endBeat=t,this.forEnd=s}doLayout(){if(this.width=0,!this.endBeat)return void(this._shouldDraw=!1);const e=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar);this.startNoteRenderer=e;const t=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.endBeat.voice.bar);if(this.endNoteRenderer=t,this._startX=0,this._endX=0,this._startY=0,this._endY=0,this.height=0,this._shouldDraw=!1,this.tieDirection=e?this.getBeamDirection(this.startBeat,e):this.getBeamDirection(this.endBeat,t),!this.forEnd&&e?(e!==t?(this._startX=e.x+this.getStartX(),this._startY=e.y+this.getStartY()+this.yOffset,t&&e.staff===t.staff?(this._endX=t.x+this.getEndX(),this._endY=t.y+this.getEndY()+this.yOffset):(this._endX=e.x+e.width,this._endY=this._startY)):(this._startX=e.x+this.getStartX(),this._endX=t.x+this.getEndX(),this._startY=e.y+this.getStartY()+this.yOffset,this._endY=t.y+this.getEndY()+this.yOffset),this._shouldDraw=!0):e&&e.staff===t.staff||(this._startX=t.x,this._endX=t.x+this.getEndX(),this._startY=t.y+this.getEndY()+this.yOffset,this._endY=this._startY,this._shouldDraw=!0),this._shouldDraw)if(this.y=Math.min(this._startY,this._endY),this.shouldDrawBendSlur())this._tieHeight=0;else{this._tieHeight=this.getTieHeight(this._startX,this._startY,this._endX,this._endY);const e=bl.calculateActualTieHeight(1,this._startX,this._startY,this._endX,this._endY,this.tieDirection===Pe.Down,this._tieHeight,this.renderer.smuflMetrics.tieMidpointThickness);if(this.height=e.h,this.tieDirection===Pe.Up){const t=this.y-e.y;t>0&&(this.y-=t)}}}paint(e,t,s){this._shouldDraw&&(this.shouldDrawBendSlur()?bl.drawBendSlur(s,e+this._startX,t+this._startY,e+this._endX,t+this._endY,this.tieDirection===Pe.Down,1,this.renderer.smuflMetrics.tieHeight):bl.paintTie(s,1,e+this._startX,t+this._startY,e+this._endX,t+this._endY,this.tieDirection===Pe.Down,this._tieHeight,this.renderer.smuflMetrics.tieMidpointThickness))}shouldDrawBendSlur(){return!1}getTieHeight(e,t,s,i){return this.renderer.smuflMetrics.tieHeight}getBeamDirection(e,t){return Pe.Down}getStartY(){return 0}getEndY(){return 0}getStartX(){return 0}getEndX(){return 0}static calculateActualTieHeight(e,t,s,i,a,r,n,o){const h=bl.computeBezierControlPoints(e,t,s,i,a,r,n,o);t=h[0],s=h[1];const l=h[2],c=h[3];i=h[6],a=h[7];const d=(t-l)/(t-2*l+i),u=bl.calculateExtrema(t,s,l,c,i,a,d),p=u.length>0?Math.min(t,i,u[0]):Math.min(t,i),m=u.length>0?Math.max(t,i,u[0]):Math.max(t,i),g=(s-c)/(s-2*c+a),f=bl.calculateExtrema(t,s,l,c,i,a,g),y=f.length>0?Math.min(s,a,f[1]):Math.min(s,a),b=f.length>0?Math.max(s,a,f[1]):Math.max(s,a),S=new Ts;return S.x=p,S.y=y,S.w=m-p,S.h=b-y,S}static calculateExtrema(e,t,s,i,a,r,n){if(n<=0||1<=n)return[];const o=e+(s-e)*n,h=t+(i-t)*n;return[o+(s+(a-s)*n-o)*n,h+(i+(r-i)*n-h)*n]}static computeBezierControlPoints(e,t,s,i,a,r,n,o){if(t===i&&s===a)return[];if(i<t){let e=t;t=i,i=e,e=s,s=a,a=e}n*=e,o*=e,r&&(n*=-1,o*=-1),e>=1&&(o*=1.2);const h=a-s,l=i-t,c=Math.sqrt(l*l+h*h);let d=t+.25*c,u=s-n,p=t+.75*c,m=s-n,g=t+.75*c,f=s-n-o,y=t+.25*c,b=s-n-o;const S=Math.atan2(h,l);return[d,u]=bl.rotate(d,u,t,s,S),[p,m]=bl.rotate(p,m,t,s,S),[g,f]=bl.rotate(g,f,t,s,S),[y,b]=bl.rotate(y,b,t,s,S),[t,s,d,u,p,m,i,a,g,f,y,b,t,s]}static rotate(e,t,s,i,a){const r=e-s,n=t-i;return[s+(r*Math.cos(a)-n*Math.sin(a)),i+(r*Math.sin(a)+n*Math.cos(a))]}static paintTie(e,t,s,i,a,r,n,o,h){const l=bl.computeBezierControlPoints(t,s,i,a,r,n,o,h);e.beginPath(),e.moveTo(l[0],l[1]),e.bezierCurveTo(l[2],l[3],l[4],l[5],l[6],l[7]),e.bezierCurveTo(l[8],l[9],l[10],l[11],l[12],l[13]),e.closePath(),e.fill()}static drawBendSlur(e,t,s,i,a,r,n,o,h){let l=a-s,c=i-t;const d=Math.sqrt(l*l+c*c);r?l*=-1:c*=-1,l/=d,c/=d;let u=o*n;i-t<20&&(u/=2);const p=(i+t)/2+u*l,m=(a+s)/2+u*c;if(e.beginPath(),e.moveTo(t,s),e.lineTo(p,m),e.lineTo(i,a),e.stroke(),h){const t=e.measureText(h).width,s=r?0:-e.font.size;e.fillText(h,p-t/2,m+s)}}}class Sl extends bl{constructor(e,t,s=!1){super(e?e.beat:null,t?t.beat:null,s),this.startNote=e,this.endNote=t}get isLeftHandTap(){return this.startNote===this.endNote}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(e,t){return Pe.Up}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,Jn.Top)}getEndY(){return this.getStartY()}getStartX(){return this.isLeftHandTap?this.getEndX()-this.startNoteRenderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,$n.Center)}getEndX(){return this.isLeftHandTap?this.endNoteRenderer.getNoteX(this.endNote,$n.Left):this.endNoteRenderer.getNoteX(this.endNote,$n.Center)}}class wl extends bl{constructor(e,t,s=!1){super(e.beat,t.beat,s),this.startNote=e,this.endNote=t}get isLeftHandTap(){return this.startNote===this.endNote}getTieHeight(e,t,s,i){return this.isLeftHandTap?this.startNoteRenderer.smuflMetrics.tieHeight:super.getTieHeight(e,t,s,i)}getBeamDirection(e,t){return this.isLeftHandTap?Pe.Up:wl.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(e){return e.string>3?Pe.Up:Pe.Down}getStartY(){return this.isLeftHandTap?this.startNoteRenderer.getNoteY(this.startNote,Jn.Center):this.tieDirection===Pe.Up?this.startNoteRenderer.getNoteY(this.startNote,Jn.Top):this.startNoteRenderer.getNoteY(this.startNote,Jn.Bottom)}getEndY(){return this.getStartY()}getStartX(){return this.isLeftHandTap?this.getEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,$n.Center)}getEndX(){return this.isLeftHandTap?this.endNoteRenderer.getNoteX(this.endNote,$n.Left):this.endNoteRenderer.getNoteX(this.endNote,$n.Center)}}class Bl extends wl{constructor(e,t,s,i=!1){super(e,t,i),this._direction=Pe.Up,this._forSlide=s}getTieHeight(e,t,s,i){return Math.log(s-e+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(e,t,s,i){if(this._forSlide!==s)return!1;if(this.forEnd!==i)return!1;if(this.startNote.beat.id!==e.beat.id)return!1;if(this.endNote.beat.id!==t.beat.id)return!1;switch(this._direction){case Pe.Up:e.realValue>this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue>this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break;case Pe.Down:e.realValue<this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue<this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat)}return!0}paint(e,t,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),a=this.getBeamDirection(this.startBeat,i),r=`numbered.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${a}`,n=this.renderer;n.staff.getSharedLayoutData(r,!1)||(n.staff.setSharedLayoutData(r,!0),super.paint(e,t,s))}}class kl extends bn{constructor(){super(...arguments),this._effectSlurs=[]}createTies(e){if(e.isVisible){if(e.isTieOrigin&&e.tieDestination.isVisible){const t=new Sl(e,e.tieDestination,!1);this.addTie(t)}if(e.isTieDestination){const t=new Sl(e.tieOrigin,e,!0);this.addTie(t)}if(e.isLeftHandTapped&&!e.isHammerPullDestination){const t=new Sl(e,e,!1);this.addTie(t)}if(e.isEffectSlurOrigin&&e.effectSlurDestination){let t=!1;for(const s of this._effectSlurs)if(s.tryExpand(e,e.effectSlurDestination,!1,!1)){t=!0;break}if(!t){const t=new Bl(e,e.effectSlurDestination,!1,!1);this._effectSlurs.push(t),this.addTie(t)}}if(e.isEffectSlurDestination&&e.effectSlurOrigin){let t=!1;for(const s of this._effectSlurs)if(s.tryExpand(e.effectSlurOrigin,e,!1,!0)){t=!0;break}if(!t){const t=new Bl(e.effectSlurOrigin,e,!1,!0);this._effectSlurs.push(t),this.addTie(t)}}}}}class Tl extends un{constructor(e,t,s,i,a){super(e,t),this._isGrace=i,this._number=s,this._beat=a}paint(e,t,s){const i=this._beat.isRest?ao.beat(s,Se.NumberedRests,this._beat):this._beat.notes.length>0?ao.note(s,de.NumberedNumber,this._beat.notes[0]):void 0;try{const i=this.renderer.resources;s.font=this._isGrace?i.numberedNotationGraceFont:i.numberedNotationFont,s.textBaseline=Be.Middle,s.textAlign=we.Left,s.fillText(this._number.toString(),e+this.x,t+this.y)}finally{i?.[Symbol.dispose]?.()}}doLayout(){const e=this.renderer.resources,t=this._isGrace?e.numberedNotationGraceFont:e.numberedNotationFont,s=this.renderer.scoreRenderer.canvas;s.font=t;const i=s.measureText(`${this._number}`);this.height=i.height,this.width=i.width}}class _l{constructor(){this.x=0,this.y=-3e3,this.width=0}}class xl extends so{constructor(){super(0,0)}doLayout(){if(!this.glyphs||0===this.glyphs.length)return void(this.width=0);this.glyphs.sort((e,t)=>e.y<t.y?-1:e.y>t.y?1:0);const e=[];e.push(new _l);for(let t=0,s=this.glyphs.length;t<s;t++){const s=this.glyphs[t];s.renderer=this.renderer,s.doLayout();let i=0;for(;e[i].y>s.y;)i++,i===e.length&&e.push(new _l);s.x=i,e[i].y=s.y+s.height,e[i].width<s.width&&(e[i].width=s.width)}this.width=0;const t=this.renderer.smuflMetrics.accidentalPadding;for(const s of e)this.width+=s.width+t,s.x=this.width;for(let t=0,s=this.glyphs.length;t<s;t++){const s=this.glyphs[t],i=e[s.x];s.x=this.width-i.x}}}class Nl extends mn{constructor(e,t,s,i){super(e,t,i,Nl.getMusicSymbol(s))}static getMusicSymbol(e){switch(e){case oe.Natural:return ne.AccidentalNatural;case oe.Sharp:return ne.AccidentalSharp;case oe.Flat:return ne.AccidentalFlat;case oe.NaturalQuarterNoteUp:return ne.AccidentalQuarterToneSharpNaturalArrowUp;case oe.SharpQuarterNoteUp:return ne.AccidentalThreeQuarterTonesSharpArrowUp;case oe.FlatQuarterNoteUp:return ne.AccidentalQuarterToneFlatArrowUp;case oe.DoubleSharp:return ne.AccidentalDoubleSharp;case oe.DoubleFlat:return ne.AccidentalDoubleFlat}return ne.None}}class Pl extends mn{constructor(e,t){super(e,t,1,ne.AugmentationDot)}doLayout(){super.doLayout(),this.offsetX=this.width/2,this.width*=1.5}}class vl extends un{constructor(e,t,s){super(e,t),this._beat=s}doLayout(){this.width=this.renderer.smuflMetrics.numberedDashGlyphWidth+this.renderer.smuflMetrics.numberedDashGlyphPadding,this.height=this.renderer.smuflMetrics.numberedBarRendererBarSize}paint(e,t,s){const i=ao.beat(s,Se.NumberedDuration,this._beat);try{const i=this.renderer.smuflMetrics.numberedDashGlyphPadding;s.fillRect(e+this.x,Math.ceil(t+this.y-this.height),this.width-i,this.height)}finally{i?.[Symbol.dispose]?.()}}}class El extends un{constructor(){super(0,0)}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(ne.NoteheadSlashWhiteHalf)}paint(e,t,s){const i=this.renderer,a=i.getLineHeight(i.heightLineCount-1),r=i.getLineY(0)+i.getLineHeight(i.drawnLineCount-1)/2-a/2,n=s.lineWidth;s.lineWidth=this.renderer.smuflMetrics.deadSlappedLineWidth,s.moveTo(e+this.x,t+r),s.lineTo(e+this.x+this.width,t+r+a),s.moveTo(e+this.x,t+r+a),s.lineTo(e+this.x+this.width,t+r),s.stroke(),s.lineWidth=n}}class Ml extends Do{constructor(){super(...arguments),this.isNaturalizeAccidental=!1,this.accidental=oe.None}get effectElement(){return Se.NumberedEffects}doLayout(){if(!this.container.beat.isRest&&!this.container.beat.isEmpty){const e=new xl;if(e.renderer=this.renderer,this.container.beat.notes.length>0){const t=this.container.beat.notes[0],s=t?t.accidentalMode:P.Default,i=Vs.getNoteValue(t);let a=De.computeAccidental(this.renderer.bar.keySignature,s,i,t.hasQuarterToneOffset);if(a===oe.Natural){a=this.renderer.bar.keySignature+7<7?oe.Sharp:oe.Flat,this.isNaturalizeAccidental=!0}if(a!==oe.None){this.accidental=a;const s=this.renderer,i=ao.noteColor(s.resources,de.NumberedAccidentals,t),r=new Nl(0,s.getLineY(0),a,t.beat.graceType!==T.None?fn.GraceScale*fn.GraceScale:fn.GraceScale);r.colorOverride=i,r.renderer=this.renderer,e.addGlyph(r),this.addNormal(e),this.addNormal(new rl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))}}}super.doLayout()}}class Fl extends Lo{constructor(){super(...arguments),this.noteHeads=null,this.deadSlapped=null,this.octaveDots=0}get effectElement(){return Se.NumberedEffects}getNoteX(e,t){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let e=s.x;switch(t){case $n.Left:break;case $n.Center:e+=s.width/2;break;case $n.Right:e+=s.width}return e}return 0}buildBoundingsLookup(e,t,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new zr;i.note=this.container.beat.notes[0],i.noteHeadBounds=new Ts,i.noteHeadBounds.x=t+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,e.addNote(i)}}getLowestNoteY(){return this.internalGetNoteY(Jn.Center)}getHighestNoteY(){return this.internalGetNoteY(Jn.Center)}getNoteY(e,t){return this.internalGetNoteY(t)}internalGetNoteY(e){let t=null;if(this.noteHeads?t=this.noteHeads:this.deadSlapped&&(t=this.deadSlapped),t){let s=this.y+t.y;switch(e){case Jn.Top:case Jn.TopWithStem:s-=t.height/2;break;case Jn.Center:break;case Jn.Bottom:case Jn.BottomWithStem:s+=t.height/2;case Jn.StemUp:case Jn.StemDown:}return s}return 0}updateBeamingHelper(){if(this.beamingHelper){let e=null;this.noteHeads?e=this.noteHeads:this.deadSlapped&&(e=this.deadSlapped),e&&this.beamingHelper.registerBeatLineX("numbered",this.container.beat,this.container.x+this.x+e.x,this.container.x+this.x+e.x+e.width)}}doLayout(){const e=this.renderer;e.shortestDuration<this.container.beat.duration&&(e.shortestDuration=this.container.beat.duration);const t=e.getLineY(e.getNoteLine());if(!this.container.beat.isEmpty){let s="0";if(this.container.beat.notes.length>0){const t=this.renderer.bar.keySignatureType,i=this.renderer.bar.keySignature,a=i+7,r=(t===u.Minor?Fl.MinorKeySignatureOneValues:Fl.MajorKeySignatureOneValues)[a],n=this.container.beat.notes[0];if(n.isDead)s="X";else{const t=n.displayValue-r,o=t<0?(t%12+12)%12:t%12;let h=t<0?(Math.abs(t)+12)/12|0:t/12|0;t<0&&(h*=-1),this.octaveDots=h,e.registerOctave(h);let l=(De.keySignatureIsSharp(i)||De.keySignatureIsNatural(i)?Vs.FlatNoteSteps:Vs.SharpNoteSteps)[o]+1;De.AccidentalNotes[o]&&!this.container.preNotes.isNaturalizeAccidental&&(a<7?l++:l--),s=l.toString()}}if(this.container.beat.deadSlapped){const e=new El;e.renderer=this.renderer,e.doLayout(),this.deadSlapped=e,this.addEffect(e)}else{const e=this.container.beat.graceType!==T.None,i=new Tl(0,t,s,e,this.container.beat);this.noteHeads=i,this.addNormal(i)}if(this.container.beat.dots>0&&this.container.beat.duration>=k.Quarter)for(let t=0;t<this.container.beat.dots;t++){const t=new Pl(0,e.getLineY(0));t.renderer=this.renderer,this.addEffect(t)}let i=0;switch(this.container.beat.duration){case k.QuadrupleWhole:i=16;break;case k.DoubleWhole:i=8;break;case k.Whole:i=4;break;case k.Half:i=2}let a=i;for(let e=0;e<this.container.beat.dots;e++)a=a/2|0,i+=a;for(let t=0;t<i-1;t++){const t=new vl(0,e.getLineY(0),this.container.beat);t.renderer=this.renderer,this.addNormal(t)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}}Fl.MajorKeySignatureOneValues=[59,66,61,68,63,58,65,60,67,62,69,64,71,66,61],Fl.MinorKeySignatureOneValues=[71,66,73,68,63,70,65,72,67,74,69,64,71,66,73];class Cl extends un{constructor(e){super(0,0),this._isOpen=e}doLayout(){super.doLayout(),this.width=this.renderer.smuflMetrics.ghostParenthesisWidth+this.renderer.smuflMetrics.ghostParenthesisPadding}paint(e,t,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride),this._isOpen?bl.paintTie(s,1,e+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,t+this.y+this.height,e+this.x+this.renderer.smuflMetrics.ghostParenthesisWidth,t+this.y,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness):bl.paintTie(s,1,e+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,t+this.y,e+this.x+this.renderer.smuflMetrics.ghostParenthesisPadding,t+this.y+this.height,!1,this.renderer.smuflMetrics.ghostParenthesisWidth/2,this.renderer.smuflMetrics.tieMidpointThickness),s.color=i}}class Dl extends so{constructor(e,t,s,i,a,r){super(e,t),this._numerator=0,this._denominator=0,this.barSubElement=m.StandardNotationTimeSignature,this._numerator=s,this._denominator=i,this._isCommon=a,this._isFreeTime=r}paint(e,t,s){const i=ao.bar(s,this.barSubElement,this.renderer.bar);try{super.paint(e,t,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){if(this._isCommon&&2===this._numerator&&2===this._denominator){const e=new mn(0,0,this.commonScale,ne.TimeSigCutCommon);this.addGlyph(e),super.doLayout()}else if(this._isCommon&&4===this._numerator&&4===this._denominator){const e=new mn(0,0,this.commonScale,ne.TimeSigCommon);this.addGlyph(e),super.doLayout()}else{const e=new Io(0,0,this._numerator,Be.Top,this.numberScale),t=new Io(0,0,this._denominator,Be.Bottom,this.numberScale);this.addGlyph(e),this.addGlyph(t),super.doLayout();const s=this.width;e.x=(s-e.width)/2,t.x=(s-t.width)/2,this.width=Math.max(e.x+e.width,t.x+t.width)}if(this._isFreeTime){const e=2*this.renderer.smuflMetrics.oneStaffSpace,t=new Cl(!0);t.renderer=this.renderer,t.y=-e,t.height=2*e,t.doLayout();for(const e of this.glyphs)e.x+=t.width;this.width+=t.width,this.addGlyph(t);const s=new Cl(!1);s.renderer=this.renderer,s.x=this.width,s.y=-e,s.height=2*e,s.doLayout(),this.addGlyph(s),this.width+=s.width}}}class Ll extends Dl{get commonScale(){return 1}get numberScale(){return 1}}class Il extends un{constructor(e,t,s,i){super(e,t),this._text="",this._accidental=oe.None,this._accidentalOffset=0,this._keySignature=s,this._keySignatureType=i}doLayout(){super.doLayout();const e="1 = ";let t="",s=oe.None;switch(this._keySignatureType){case u.Major:switch(this._keySignature){case d.Cb:t="  C",s=oe.Flat;break;case d.Gb:t="  G",s=oe.Flat;break;case d.Db:t="  D",s=oe.Flat;break;case d.Ab:t="  A",s=oe.Flat;break;case d.Eb:t="  E",s=oe.Flat;break;case d.Bb:t="  B",s=oe.Flat;break;case d.F:t="F";break;case d.C:t="C",s=oe.None;break;case d.G:t="G",s=oe.None;break;case d.D:t="D",s=oe.None;break;case d.A:t="A",s=oe.None;break;case d.E:t="E",s=oe.None;break;case d.B:t="B",s=oe.None;break;case d.FSharp:t="  F",s=oe.Sharp;break;case d.CSharp:t="  C",s=oe.Sharp}break;case u.Minor:switch(this._keySignature){case d.Cb:t="  a",s=oe.Flat;break;case d.Gb:t="  e",s=oe.Flat;break;case d.Db:t="  b",s=oe.Flat;break;case d.Ab:t="f",s=oe.None;break;case d.Eb:t="c",s=oe.None;break;case d.Bb:t="g",s=oe.None;break;case d.F:t="d";break;case d.C:t="a",s=oe.None;break;case d.G:t="e",s=oe.None;break;case d.D:t="b",s=oe.None;break;case d.A:t="  f",s=oe.Sharp;break;case d.E:t="  c",s=oe.Sharp;break;case d.B:t="  g",s=oe.Sharp;break;case d.FSharp:t="  d",s=oe.Sharp;break;case d.CSharp:t="  a",s=oe.Sharp}}this._text=e+t,this._accidental=s;const i=this.renderer.scoreRenderer.canvas,a=this.renderer.resources;i.font=a.numberedNotationFont,this._accidentalOffset=i.measureText(e).width,this.width=i.measureText(e+t).width}paint(e,t,s){const i=ao.bar(s,m.NumberedKeySignature,this.renderer.bar);try{const i=this.renderer.resources;s.font=i.numberedNotationFont,s.textBaseline=Be.Middle,s.fillText(this._text,e+this.x,t+this.y),this._accidental!==oe.None&&$e.fillMusicFontSymbolSafe(s,e+this.x+this._accidentalOffset,t+this.y,1,Nl.getMusicSymbol(this._accidental),!1)}finally{i?.[Symbol.dispose]?.()}}}class Al extends yl{get dotSpacing(){return 2*this.smuflMetrics.glyphHeights.get(ne.AugmentationDot)}registerOctave(e){null===this.lowestOctave?(this.lowestOctave=e,this.highestOctave=e):(e<this.lowestOctave&&(this.lowestOctave=e),e>this.highestOctave&&(this.highestOctave=e))}get repeatsBarSubElement(){return m.NumberedRepeats}get barNumberBarSubElement(){return m.NumberedBarNumber}get barLineBarSubElement(){return m.NumberedBarLines}get staffLineBarSubElement(){return m.NumberedStaffLine}constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this.shortestDuration=k.QuadrupleWhole,this.lowestOctave=null,this.highestOctave=null,this._isOnlyNumbered=!t.staff.showSlash&&!t.staff.showTablature&&!t.staff.showStandardNotation}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 0}get bottomGlyphOverflow(){return 0}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s,Se.NumberedDuration,Se.NumberedDuration),this.paintTuplets(e,t,s,Se.NumberedTuplet,!0)}doLayout(){super.doLayout();let e=!1;for(const t of this.bar.voices)if(this.hasVoiceContainer(t)){if(this.getVoiceContainer(t).tupletGroups.length>0){e=!0;break}}if(e&&this.registerOverflowTop(this.tupletSize),!this.bar.isEmpty){const e=De.getIndex(this.shortestDuration)-2,t=this.dotSpacing;if(e>0){const s=(e-1)*this.smuflMetrics.numberedBarRendererBarSpacing+this.smuflMetrics.numberedBarRendererBarSize;let i=0;const a=this.lowestOctave;null!==a&&(i=Math.abs(a)*t+this.smuflMetrics.glyphHeights.get(ne.AugmentationDot)),this.registerOverflowBottom(s+i)}const s=this.highestOctave;if(null!==s){const e=Math.abs(s)*t+this.smuflMetrics.glyphHeights.get(ne.AugmentationDot);this.registerOverflowTop(e)}}}paintFlag(e,t,s,i,a){this.paintBar(e,t,s,i,a)}paintBar(e,t,s,i,a){if(0===i.beats.length)return;const r=this.resources;for(let n=0,o=i.beats.length;n<o;n++){const o=i.beats[n],h=ao.beat(s,a,o);try{const a=this.smuflMetrics.numberedBarRendererBarSpacing,h=this.smuflMetrics.numberedBarRendererBarSize,l=De.getIndex(o.duration)-2,c=t+this.y,d=this.getBeatX(o,Xn.PreNotes)-this.beatGlyphsStart,u=this.calculateBeamY(i,d);for(let t=0;t<l;t++){let r=0,l=0,p=0;const m=c+t*a;n===i.beats.length-1?(r=d,l=this.getBeatX(o,Xn.PostNotes)-this.beatGlyphsStart):(r=d,l=this.getBeatX(i.beats[n+1],Xn.PreNotes)-this.beatGlyphsStart),p=m+u,s.fillRect(e+this.x+r,p,l-r,h)}const p=this.getBeatContainer(o).onNotes;let m=p instanceof Fl?p.octaveDots:0;const g=this.dotSpacing;let f=0,y=0;m>0?(f=c+this.getLineY(0)-r.numberedNotationFont.size,y=-1*g):m<0&&(f=c+u+l*(a+h),y=g);const b=this.getBeatX(o,Xn.MiddleNotes)-this.beatGlyphsStart;m=Math.abs(m);for(let t=0;t<m;t++)$e.fillMusicFontSymbolSafe(s,e+this.x+b,f,1,ne.AugmentationDot,!0),f+=y}finally{h?.[Symbol.dispose]?.()}}}getNoteLine(){return 0}get tupletOffset(){return super.tupletOffset+1.5*this.resources.numberedNotationFont.size}getFlagTopY(e,t){return this.getLineY(0)-this.resources.numberedNotationFont.size}getFlagBottomY(e,t){return this.getLineY(0)-this.resources.numberedNotationFont.size}getBeamDirection(e){return Pe.Down}getTupletBeamDirection(e){return Pe.Up}getNoteY(e,t){let s=super.getNoteY(e,t);return Number.isNaN(s)&&(s=this.getLineY(0)),s}calculateBeamYWithDirection(e,t,s){const i=this.resources.numberedNotationFont;return this.getLineY(0)+i.size}getBarLineStart(e,t){const s=this.smuflMetrics.glyphHeights.get(ne.NoteheadBlack);return this.getLineY(0)-s/2}createPreBeatGlyphs(){this.wasFirstOfLine=this.isFirstOfLine,(0===this.index||this.bar.masterBar.isRepeatStart&&this._isOnlyNumbered)&&this.addPreBeatGlyph(new ml(!1)),this.createLinePreBeatGlyphs(),this.addPreBeatGlyph(new fl(0,this.getLineHeight(-.25),this.bar.index+1))}createLinePreBeatGlyphs(){this.bar.previousBar&&this.bar.keySignature===this.bar.previousBar.keySignature||(this.createStartSpacing(),this.createKeySignatureGlyphs()),this._isOnlyNumbered&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createKeySignatureGlyphs(){this.addPreBeatGlyph(new Il(0,this.getLineY(0),this.bar.keySignature,this.bar.keySignatureType))}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new rl(0,0,this.smuflMetrics.oneStaffSpace));const e=this.bar.masterBar,t=new Ll(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(null==e.previousMasterBar||e.isFreeTime!==e.previousMasterBar.isFreeTime));t.barSubElement=m.NumberedTimeSignature,this.addPreBeatGlyph(t)}createPostBeatGlyphs(){this._isOnlyNumbered&&super.createPostBeatGlyphs()}createVoiceGlyphs(e){for(const t of e.beats){const s=new kl(t,this.getVoiceContainer(e));s.preNotes=0===e.index?new Ml:new Do,s.onNotes=0===e.index?new Fl:new Lo,this.addBeatGlyph(s)}}paintBeamingStem(e,t,s,i,a,r){}}Al.StaffId="numbered";class Rl extends to{get staffId(){return Al.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new Al(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showNumbered}}class Ol extends mn{constructor(e,t,s,i){super(e,t,1,Ol.getSymbol(s,i)),this._clef=s,this._clefOttava=i}doLayout(){this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(ne.GClef),this.offsetX=this.width/2}static getSymbol(e,t){switch(e){case h.Neutral:return ne.UnpitchedPercussionClef1;case h.C3:case h.C4:return t===l._8vb?ne.CClef8vb:ne.CClef;case h.F4:switch(t){case l._15ma:return ne.FClef15ma;case l._8va:return ne.FClef8va;case l._8vb:return ne.FClef8vb;case l._15mb:return ne.FClef15mb;default:return ne.FClef}case h.G2:switch(t){case l._15ma:return ne.GClef15ma;case l._8va:return ne.GClef8va;case l._8vb:return ne.GClef8vb;case l._15mb:return ne.GClef15mb;default:return ne.GClef}default:return ne.None}}paint(e,t,s){const i=ao.bar(s,m.StandardNotationClef,this.renderer.bar);try{switch(super.paint(e,t,s),this._clef){case h.C3:case h.C4:if(this._clefOttava===l._8vb)return;break;case h.F4:case h.G2:return}let i,a=!1;switch(this._clefOttava){case l._15ma:i=ne.Clef15,a=!0;break;case l._8va:i=ne.Clef8,a=!0;break;case l._8vb:i=ne.Clef8;break;case l._15mb:i=ne.Clef15;break;default:return}const r=this.width/2,n=a?this.renderer.smuflMetrics.glyphTop.get(this.symbol):this.renderer.smuflMetrics.glyphBottom.get(this.symbol)-this.renderer.smuflMetrics.glyphHeights.get(i);$e.fillMusicFontSymbolSafe(s,e+this.x+r,t+this.y-n,1,i,!0)}finally{i?.[Symbol.dispose]?.()}}}class Wl extends pn{constructor(e,t,s){super(e,t),this._note=s}static getSymbol(e,t){switch(e){case _.None:return ne.None;case _.Normal:return t?ne.ArticAccentAbove:ne.ArticAccentBelow;case _.Heavy:return t?ne.ArticMarcatoAbove:ne.ArticMarcatoBelow;case _.Tenuto:return t?ne.ArticTenutoAbove:ne.ArticTenutoBelow;default:return ne.None}}doLayout(){this.width=this.renderer.smuflMetrics.glyphWidths.get(ne.ArticAccentAbove),this.height=this.renderer.smuflMetrics.glyphHeights.get(ne.ArticAccentAbove)}paint(e,t,s){const i=this.renderer.getBeatDirection(this._note.beat),a=Wl.getSymbol(this._note.accentuated,i===Pe.Down),r=i===Pe.Up?t+this.y:t+this.y+this.height;$e.fillMusicFontSymbolSafe(s,e+this.x,r,1,a,!0)}}class Hl extends mn{constructor(e,t,s){super(e,t,s?fn.GraceScale:1,ne.NoteheadXOrnate)}}class Gl extends mn{constructor(e,t,s,i){super(e,t,i?fn.GraceScale:1,Gl.getSymbol(s))}static getSymbol(e){switch(e){case k.QuadrupleWhole:case k.DoubleWhole:case k.Whole:case k.Half:return ne.NoteheadDiamondWhiteWide;default:return ne.NoteheadDiamondBlackWide}}}class Vl{constructor(e,t,s){this.line=0,this.line=e,this.isGhost=t,this.color=s}}class Ul extends un{constructor(e){super(0,0),this._infos=[],this._glyphs=[],this.isEmpty=!0,this._isOpen=e}addParenthesis(t){const s=this.renderer,i=s.getNoteLine(t),a=t.isGhost||this.isTiedBend(t)&&s.settings.notation.isNotationElementVisible(e.NotationElement.ParenthesisOnTiedBends),r=ao.noteColor(s.resources,de.Effects,t);this.add(new Vl(i,a,r))}addParenthesisOnLine(e,t){const s=new Vl(e,t,void 0);this.add(s)}add(e){this._infos.push(e),e.isGhost&&(this.isEmpty=!1)}isTiedBend(e){return!!e.isTieDestination&&(!!e.tieOrigin.hasBend||this.isTiedBend(e.tieOrigin))}doLayout(){const e=this.renderer;this._infos.sort((e,t)=>e.line-t.line);let t=null;const s=e.getScoreHeight(1);for(let i=0,a=this._infos.length;i<a;i++){let a;if(this._infos[i].isGhost)if(t){const a=e.getScoreY(this._infos[i].line)+s;t.height=a-t.y}else a=new Cl(this._isOpen),a.colorOverride=this._infos[i].color,a.renderer=this.renderer,a.y=e.getScoreY(this._infos[i].line)-s,a.height=2*s,a.doLayout(),this._glyphs.push(a),t=a;else t=null}this.width=this._glyphs.length>0?this._glyphs[0].width:0}paint(e,t,s){super.paint(e,t,s);for(const i of this._glyphs)i.paint(e+this.x,t+this.y,s)}}class zl{constructor(e,t){this.steps=0,this.glyph=e,this.steps=t}}class Xl extends un{constructor(){super(0,0),this._infos=[],this.minNote=null,this.maxNote=null,this.upLineX=0,this.downLineX=0,this.noteStartX=0}getLowestNoteY(){return this.maxNote?this.renderer.getScoreY(this.maxNote.steps):0}getHighestNoteY(){return this.minNote?this.renderer.getScoreY(this.minNote.steps):0}add(e,t){const s=new zl(e,t);this._infos.push(s),(!this.minNote||this.minNote.steps>s.steps)&&(this.minNote=s),(!this.maxNote||this.maxNote.steps<s.steps)&&(this.maxNote=s)}doLayout(){this._infos.sort((e,t)=>t.steps-e.steps);let e=0,t=0,s=!0,i=0,a=!1;const r=this.direction,n=this.renderer.smuflMetrics,o=this.scale,h=new Map;for(let r=0,l=this._infos.length;r<l;r++){const l=this._infos[r].glyph;if(l.renderer=this.renderer,l.doLayout(),r>0&&Math.abs(i-this._infos[r].steps)<=1?s?(s=!1,h.set(r,!1)):(a=!0,s=!0,h.set(r,!0)):(s=!1,h.set(r,!1)),n.stemUp.has(l.symbol)){const t=n.stemUp.get(l.symbol).x*o;t>e&&(e=t)}else{const t=n.glyphWidths.get(l.symbol)*o;t>e&&(e=t)}if(n.stemDown.has(l.symbol)){const s=n.stemDown.get(l.symbol).x*o;if(s>t){const i=s-t;t=s,e+=i}}i=this._infos[r].steps}const l=a||r===Pe.Up?e:t;let c=0;for(let e=0,s=this._infos.length;e<s;e++){const s=this._infos[e].glyph;h.get(e)?s.x=l:(s.x=t,n.stemDown.has(s.symbol)&&(s.x-=n.stemDown.get(s.symbol).x*o)),s.x+=this.noteStartX,c=Math.max(c,s.x+s.width),s instanceof fn&&s.centerOnStem&&(s.x=l)}a?(this.upLineX=l,this.downLineX=l):(this.upLineX=e,this.downLineX=t),this.width=c}paint(e,t,s){e+=this.x,t+=this.y,this.paintLedgerLines(e,t,s);const i=this._infos;for(const a of i)a.glyph.renderer=this.renderer,a.glyph.paint(e,t,s)}paintLedgerLines(e,t,s){if(!this.minNote)return;const i=this.renderer,a=ao.bar(s,m.StandardNotationStaffLine,i.bar,!0);try{const a=this.scale,r=this.renderer.smuflMetrics.legerLineExtension*a,n=this.width-this.noteStartX+2*r,o=i.getLineHeight(1),h=i.getLineY(-1),l=i.getLineY(i.drawnLineCount),c=i.getLineY(this.minNote.steps/2),d=i.getLineY(this.maxNote.steps/2),u=this.renderer.smuflMetrics.legerLineThickness*a/2;let p=h;for(;p>=c;)s.fillRect(e-r+this.noteStartX,t+p-u,n,this.renderer.smuflMetrics.legerLineThickness*a),p-=o;for(p=l;p<=d;)s.fillRect(e-r+this.noteStartX,t+p-u,n,this.renderer.smuflMetrics.legerLineThickness*a),p+=o}finally{a?.[Symbol.dispose]?.()}}}class Yl extends mn{constructor(e,t,s){super(e,t,1,Yl.getSymbol(s))}static getSymbol(e){switch(e){case k.ThirtySecond:return ne.Tremolo3;case k.Sixteenth:return ne.Tremolo2;case k.Eighth:return ne.Tremolo1;default:return ne.None}}}class Jl extends Xl{constructor(){super(...arguments),this._noteGlyphLookup=new Map,this._notes=[],this._deadSlapped=null,this._tremoloPicking=null,this.aboveBeatEffects=new Map,this.belowBeatEffects=new Map}get direction(){return this.beamingHelper.direction}get scale(){return this.beat.graceType!==T.None?fn.GraceScale:1}getNoteX(e,t){if(this._noteGlyphLookup.has(e.id)){const s=this._noteGlyphLookup.get(e.id);let i=this.x+s.x;switch(t){case $n.Left:break;case $n.Center:i+=s.width/2;break;case $n.Right:i+=s.width}return i}return 0}getNoteY(e,t){if(this._noteGlyphLookup.has(e.id)){const s=this._noteGlyphLookup.get(e.id);return this.internalGetNoteY(s,t)}return 0}internalGetNoteY(e,t){let s=this.y+e.y;const i=this.beat.graceType!==T.None?fn.GraceScale:1;switch(t){case Jn.TopWithStem:s-=(this.renderer.smuflMetrics.stemUp.has(e.symbol)?this.renderer.smuflMetrics.stemUp.get(e.symbol).bottomY:0)*i,s-=this.renderer.smuflMetrics.standardStemLength*i;const t=this.renderer.centerStaffStemY(this.beamingHelper);return Math.min(t,s);case Jn.Top:s-=e.height/2;break;case Jn.Center:break;case Jn.Bottom:s+=e.height/2;break;case Jn.BottomWithStem:s-=(this.renderer.smuflMetrics.stemDown.has(e.symbol)?this.renderer.smuflMetrics.stemDown.get(e.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(e.symbol)/2)*i,s+=this.renderer.smuflMetrics.standardStemLength*i;const a=this.renderer.centerStaffStemY(this.beamingHelper);return Math.max(a,s);case Jn.StemUp:s-=(this.renderer.smuflMetrics.stemUp.has(e.symbol)?this.renderer.smuflMetrics.stemUp.get(e.symbol).bottomY:0)*i;break;case Jn.StemDown:s-=(this.renderer.smuflMetrics.stemDown.has(e.symbol)?this.renderer.smuflMetrics.stemDown.get(e.symbol).topY:-this.renderer.smuflMetrics.glyphHeights.get(e.symbol)/2)*i}return s}addMainNoteGlyph(e,t,s){super.add(e,s),this._noteGlyphLookup.set(t.id,e),this._notes.push(t)}addEffectNoteGlyph(e,t){super.add(e,t)}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.upLineX,e+this.x+this.downLineX)}doLayout(){super.doLayout();const e=this.renderer;this.beat.deadSlapped&&(this._deadSlapped=new El,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),this.width=this._deadSlapped.width);let t=0,s=0;const i=this.renderer.smuflMetrics.onNoteEffectPadding;this.beat.deadSlapped?(s=e.getScoreY(0),t=e.getScoreY(e.heightLineCount)):this.direction===Pe.Up?(s=this.internalGetNoteY(this.maxNote.glyph,Jn.Bottom)+i,t=this.internalGetNoteY(this.minNote.glyph,Jn.TopWithStem)-i):(s=this.internalGetNoteY(this.maxNote.glyph,Jn.BottomWithStem)+i,t=this.internalGetNoteY(this.minNote.glyph,Jn.Top)-i);let a=null,r=null;for(const e of this.aboveBeatEffects.values())e.renderer=this.renderer,e.doLayout(),t-=e.height,e.y=t,(null===a||a>t)&&(a=t),(null===r||r<t)&&(r=t),t-=i;for(const e of this.belowBeatEffects.values())e.renderer=this.renderer,e.doLayout(),e.y=s,(null===a||a>s)&&(a=s),(null===r||r<s)&&(r=s),s+=e.height+i;if(null!==a&&e.registerBeatEffectOverflows(a,r??0),this.beat.isTremolo&&!this.beat.deadSlapped){const e=this.direction;let t=0;if(e===Pe.Up){t=(this.internalGetNoteY(this.minNote.glyph,Jn.TopWithStem)+this.internalGetNoteY(this.minNote.glyph,Jn.StemUp))/2}else{t=(this.internalGetNoteY(this.maxNote.glyph,Jn.StemDown)+this.internalGetNoteY(this.maxNote.glyph,Jn.BottomWithStem))/2}let s=e===Pe.Up?this.upLineX:this.downLineX;const i=this.beat.tremoloSpeed;this.beat.duration<k.Half&&(s=this.width/2),this._tremoloPicking=new Yl(s,t,i),this._tremoloPicking.renderer=this.renderer,this._tremoloPicking.doLayout()}}buildBoundingsLookup(e,t,s){for(const i of this._notes)if(this._noteGlyphLookup.has(i.id)){const a=this._noteGlyphLookup.get(i.id),r=new zr;r.note=i,r.noteHeadBounds=new Ts,r.noteHeadBounds.x=t+this.x+a.x,r.noteHeadBounds.y=s+this.y+a.y-a.height/2,r.noteHeadBounds.w=a.width,r.noteHeadBounds.h=a.height,e.addNote(r)}}paint(e,t,s){this.paintEffects(e,t,s),super.paint(e,t,s)}paintEffects(e,t,s){const i=ao.beat(s,Se.StandardNotationEffects,this.beat);try{for(const i of this.aboveBeatEffects.values())i.paint(e+this.x+this.width/2,t+this.y,s);for(const i of this.belowBeatEffects.values())i.paint(e+this.x+this.width/2,t+this.y,s);this._tremoloPicking&&this._tremoloPicking.paint(e,t,s),this._deadSlapped&&this._deadSlapped.paint(e,t,s)}finally{i?.[Symbol.dispose]?.()}}}class $l extends mn{constructor(e,t,s){super(e,t,1,$l.getSymbol(s))}static getSymbol(e){switch(e){case k.QuadrupleWhole:return ne.RestLonga;case k.DoubleWhole:return ne.RestDoubleWhole;case k.Whole:return ne.RestWhole;case k.Half:return ne.RestHalf;case k.Quarter:return ne.RestQuarter;case k.Eighth:return ne.Rest8th;case k.Sixteenth:return ne.Rest16th;case k.ThirtySecond:return ne.Rest32nd;case k.SixtyFourth:return ne.Rest64th;case k.OneHundredTwentyEighth:return ne.Rest128th;case k.TwoHundredFiftySixth:return ne.Rest256th;default:return ne.None}}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,s){this.internalPaint(e,t,s,Se.StandardNotationRests)}internalPaint(e,t,s,i){const a=ao.beat(s,i,this.beat);try{super.paint(e,t,s)}finally{a?.[Symbol.dispose]?.()}}}class ql extends Xl{get scale(){return fn.GraceScale}get direction(){return Pe.Up}constructor(e,t=!1){super(),this._showParenthesis=!1,this._noteValueLookup=new Map,this._accidentals=new xl,this._preNoteParenthesis=null,this._postNoteParenthesis=null,this.isEmpty=!0,this.noteHeadOffset=0,this._beat=e,this._showParenthesis=t,t&&(this._preNoteParenthesis=new Ul(!0),this._postNoteParenthesis=new Ul(!1))}containsNoteValue(e){return this._noteValueLookup.has(e)}getNoteValueY(e){return this._noteValueLookup.has(e)?this.y+this._noteValueLookup.get(e).y:0}addGlyph(e,t,s){const i=this.renderer,a=new fn(0,0,k.Quarter,!0),r=i.accidentalHelper.applyAccidentalForValue(this._beat,e,t,!0),n=i.accidentalHelper.getNoteLineForValue(e,!1);if(a.y=i.getScoreY(n),this._showParenthesis&&(this._preNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.addParenthesisOnLine(n,!0),this._postNoteParenthesis.addParenthesisOnLine(n,!0)),r!==oe.None){const e=new Nl(0,a.y,r,fn.GraceScale);e.renderer=this.renderer,this._accidentals.renderer=this.renderer,this._accidentals.addGlyph(e)}this._noteValueLookup.set(e,a),this.add(a,n),this.isEmpty=!1}doLayout(){let e=0;this._showParenthesis&&(this._preNoteParenthesis.x=e,this._preNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.doLayout(),e+=this._preNoteParenthesis.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this._accidentals.isEmpty||(e+=this._accidentals.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this._accidentals.x=e,this._accidentals.renderer=this.renderer,this._accidentals.doLayout(),e+=this._accidentals.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding),this.noteStartX=e,super.doLayout(),this.noteHeadOffset=this.noteStartX+(this.width-this.noteStartX)/2,this._showParenthesis&&(this._postNoteParenthesis.x=this.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding,this._postNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.doLayout(),this.width+=this._postNoteParenthesis.width+this.renderer.smuflMetrics.bendNoteHeadElementPadding)}paint(e,t,s){this._accidentals.isEmpty||this._accidentals.paint(e+this.x,t+this.y,s),this._showParenthesis&&(this._preNoteParenthesis.paint(e+this.x,t+this.y,s),this._postNoteParenthesis.paint(e+this.x,t+this.y,s)),super.paint(e,t,s)}}class jl extends un{constructor(){super(...arguments),this.BendNoteHeads=[]}drawBendSlur(e,t,s,i,a,r,n,o){bl.drawBendSlur(e,t,s,i,a,r,n,this.renderer.smuflMetrics.tieHeight,o)}doLayout(){super.doLayout(),this.width=0;for(const e of this.BendNoteHeads)e.doLayout(),this.width+=e.width}getTieDirection(e,t){return t.getBeatDirection(e)===Pe.Up?Pe.Down:Pe.Up}}class Kl extends jl{constructor(e){super(0,0),this._endGlyph=null,this._beat=e}doLayout(){const t=this.renderer.settings.notation.notationMode;switch(this._beat.whammyBarType){case ue.None:case ue.Custom:case ue.Hold:return;case ue.Dive:case ue.PrediveDive:{const e=new ql(this._beat,!1);this._endGlyph=e,e.renderer=this.renderer;const t=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(const s of this._beat.notes)s.isTieOrigin||e.addGlyph(this.getBendNoteValue(s,t),t.value%2!=0,void 0);e.doLayout(),this.BendNoteHeads.push(e)}break;case ue.Dip:if(t===e.NotationMode.SongBook){const e=this.renderer.resources;this.renderer.simpleWhammyOverflow=e.tablatureFont.size+this.renderer.smuflMetrics.songBookWhammyDipHeight}else{const t=new ql(this._beat,!1);if(t.renderer=this.renderer,this.renderer.settings.notation.notationMode===e.NotationMode.GuitarPro){const e=this._beat.whammyBarPoints[1];for(const s of this._beat.notes)t.addGlyph(this.getBendNoteValue(s,this._beat.whammyBarPoints[1]),e.value%2!=0,void 0)}t.doLayout(),this.BendNoteHeads.push(t);const s=new ql(this._beat,!1);if(s.renderer=this.renderer,this._endGlyph=s,this.renderer.settings.notation.notationMode===e.NotationMode.GuitarPro){const e=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(const t of this._beat.notes)s.addGlyph(this.getBendNoteValue(t,e),e.value%2!=0,void 0)}s.doLayout(),this.BendNoteHeads.push(s)}case ue.Predive:}super.doLayout()}paint(t,s,i){const a=this._beat;switch(a.whammyBarType){case ue.None:case ue.Custom:return}const r=this.renderer.settings.notation.notationMode,n=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,a.voice.bar),o=ao.beat(i,Se.StandardNotationEffects,a);try{const o=t+n.x+n.getBeatX(a,Xn.MiddleNotes),h=this.getTieDirection(a,n);let l=1===this._beat.notes.length?h:Pe.Up;const c=i.textAlign,d=this.renderer.smuflMetrics.glyphHeights.get(ne.NoteheadBlack);for(let c=0;c<a.notes.length;c++){const u=a.notes[c],p=ao.note(i,de.StandardNotationEffects,u);try{let p=s+n.y;c>0&&c>=(this._beat.notes.length/2|0)&&(l=Pe.Down),l===Pe.Down?p+=n.getNoteY(u,Jn.Bottom):p+=n.getNoteY(u,Jn.Top);let m=t+n.x;a.isLastOfVoice?m+=n.postBeatGlyphsStart:m+=n.getBeatX(a,Xn.EndBeat),this._endGlyph&&(m-=this._endGlyph.upLineX);const g=a.whammyStyle===b.Gradual&&0===c?"grad.":"";let f=null;u.isTieOrigin&&(f=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,u.tieDestination.beat.voice.bar),f&&f.staff===n.staff?m=t+f.x+f.getBeatX(u.tieDestination.beat,Xn.MiddleNotes):f=null);let y=d*fn.GraceScale*.5;l===Pe.Up&&(y=-y);const S=a.whammyBarPoints.length>0?this.getBendNoteValue(u,a.whammyBarPoints[a.whammyBarPoints.length-1]):0;let w=0,B=!1;switch(this.BendNoteHeads.length>0&&this.BendNoteHeads[0].containsNoteValue(S)?(w=this.BendNoteHeads[0].getNoteValueY(S)+y,B=!0):f&&(u.isTieOrigin&&u.tieDestination.beat.hasWhammyBar||u.beat.isContinuedWhammy)?(w=s+f.y+f.getNoteY(u.tieDestination,Jn.Top),B=!0,l===Pe.Down&&(w+=d)):u.isTieOrigin&&(w=f?s+f.y+f.getNoteY(u.tieDestination,Jn.Top):p,l===Pe.Down&&(w+=d)),a.whammyBarType){case ue.Hold:u.isTieOrigin&&bl.paintTie(i,1,o,p,m,w,h===Pe.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case ue.Dive:if(0===c){this.BendNoteHeads[0].x=m-this.BendNoteHeads[0].noteHeadOffset;const e=this.BendNoteHeads[0].y;this.BendNoteHeads[0].y=s+n.y,this.BendNoteHeads[0].paint(0,0,i),this.BendNoteHeads[0].containsNoteValue(S)&&(w-=e,w+=this.BendNoteHeads[0].y)}B?this.drawBendSlur(i,o,p,m,w,l===Pe.Down,1,g):u.isTieOrigin&&bl.paintTie(i,1,o,p,m,w,h===Pe.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness);break;case ue.Dip:if(r===e.NotationMode.SongBook){if(0===c){const e=t+n.x+n.getBeatX(this._beat,Xn.OnNotes),a=t+n.x+n.getBeatX(this._beat,Xn.PostNotes),r=(e+a)/2,o=((this._beat.whammyBarPoints[1].value-this._beat.whammyBarPoints[0].value)/4|0).toString();i.font=this.renderer.resources.tablatureFont,i.fillText(o,r,s+this.y);const h=s+this.y+i.font.size,l=h+this.renderer.smuflMetrics.songBookWhammyDipHeight;this._beat.whammyBarPoints[1].value>this._beat.whammyBarPoints[0].value?(i.moveTo(e,l),i.lineTo(r,h),i.lineTo(a,l)):(i.moveTo(e,h),i.lineTo(r,l),i.lineTo(a,h)),i.stroke()}u.isTieOrigin&&bl.paintTie(i,1,o,p,m,w,h===Pe.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness)}else{const e=(o+m)/2;this.BendNoteHeads[0].x=e-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=s+n.y,this.BendNoteHeads[0].paint(0,0,i);const t=this.getBendNoteValue(u,a.whammyBarPoints[1]),r=this.BendNoteHeads[0].getNoteValueY(t)+y;this.drawBendSlur(i,o,p,e,r,l===Pe.Down,1,g),this.BendNoteHeads[1].x=m-this.BendNoteHeads[1].noteHeadOffset,this.BendNoteHeads[1].y=s+n.y,this.BendNoteHeads[1].paint(0,0,i),w=this.BendNoteHeads[1].getNoteValueY(S)+y,this.drawBendSlur(i,e,r,m,w,l===Pe.Down,1,g)}break;case ue.PrediveDive:case ue.Predive:let d=t+n.x+n.getBeatX(u.beat,Xn.PreNotes);d+=n.getPreNotesGlyphForBeat(u.beat).prebendNoteHeadOffset;const f=s+n.y+n.getScoreY(n.accidentalHelper.getNoteLineForValue(u.displayValue-(u.beat.whammyBarPoints[0].value/2|0),!1))+y;this.drawBendSlur(i,d,f,o,p,l===Pe.Down,1,g),this.BendNoteHeads.length>0&&(this.BendNoteHeads[0].x=m-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=s+n.y,this.BendNoteHeads[0].paint(0,0,i),this.drawBendSlur(i,o,p,m,w,l===Pe.Down,1,g))}}finally{p?.[Symbol.dispose]?.()}}i.textAlign=c}finally{o?.[Symbol.dispose]?.()}}getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}}class Ql extends mn{constructor(e,t,s,i,a){super(e,t,a?fn.GraceScale:1,s.getSymbol(i)),this._isGrace=a,this._articulation=s}paint(e,t,s){const i=s.color;this.colorOverride&&(s.color=this.colorOverride);const a=this._isGrace?1:0;$e.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+a,this.glyphScale,this.symbol,!1),this._articulation.techniqueSymbol!==ne.None&&this._articulation.techniqueSymbolPlacement===le.Inside&&$e.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+a,this.glyphScale,this._articulation.techniqueSymbol,!1),s.color=i}doLayout(){super.doLayout(),0===this.width&&(this.height=this.renderer.smuflMetrics.glyphWidths.get(ne.NoteheadBlack)),0===this.height&&(this.height=this.renderer.smuflMetrics.glyphHeights.get(ne.NoteheadBlack))}}class Zl extends mn{constructor(e,t){super(e,t,fn.GraceScale,ne.ArticStaccatoAbove),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}class ec extends mn{constructor(e,t){super(e,t,.5,ne.PictEdgeOfCymbal),this.center=!0}doLayout(){super.doLayout(),this.offsetY=this.height}}class tc extends pn{constructor(){super(...arguments),this._strings=new Set}addString(e){this._strings.add(e)}doLayout(){const e=this.renderer.smuflMetrics.glyphWidths.get(ne.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;this.height=(e+this.renderer.smuflMetrics.stringNumberCirclePadding)*this._strings.size,this.width=e}paint(e,t,s){const i=this.renderer.bar.staff.tuning.length;let a=0;const r=this.renderer.smuflMetrics.glyphWidths.get(ne.GuitarString0)*this.renderer.smuflMetrics.tuningGlyphCircleNumberScale;for(const n of this._strings){const o=i-n,h=ne.GuitarString1+o;$e.fillMusicFontSymbolSafe(s,e+this.x,t+this.y+r+a,this.renderer.smuflMetrics.tuningGlyphCircleNumberScale,h,!0),a+=r+this.renderer.smuflMetrics.stringNumberCirclePadding}}}const sc=Object.freeze(Object.defineProperty({__proto__:null,BarBounds:Gr,get BeamDirection(){return Pe},BeatBounds:Vr,Bounds:Ts,BoundsLookup:Yr,MasterBarBounds:Ur,NoteBounds:zr,RenderFinishedEventArgs:Hr,ScoreRenderer:Jr,StaffSystemBounds:Xr},Symbol.toStringTag,{value:"Module"}));class ic extends mn{constructor(e,t,s,i,a){super(e,t,i?fn.GraceScale:1,ic.getSymbol(s)),this.beatEffects=new Map,this.noteHeadElement=de.SlashNoteHead,this.effectElement=Se.SlashEffects,this._symbol=ic.getSymbol(s),this.beat=a}paint(e,t,s){const i=0===this.beat.notes.length?void 0:ao.note(s,this.noteHeadElement,this.beat.notes[0]);try{super.paint(e,t,s),this.paintEffects(e,t,s)}finally{i?.[Symbol.dispose]?.()}}paintEffects(e,t,s){const i=ao.beat(s,this.effectElement,this.beat);try{for(const i of this.beatEffects.values())i.paint(e+this.x,t+this.y,s)}finally{i?.[Symbol.dispose]?.()}}doLayout(){super.doLayout();const e=this.renderer.smuflMetrics.onNoteEffectPadding;let t=this.renderer.smuflMetrics.glyphHeights.get(this._symbol);for(const s of this.beatEffects.values())s.y+=t,s.x+=this.width/2,s.renderer=this.renderer,s.doLayout(),t+=s.height+e}static getSymbol(e){switch(e){case k.QuadrupleWhole:case k.DoubleWhole:case k.Whole:return ne.NoteheadSlashWhiteWhole;case k.Half:return ne.NoteheadSlashWhiteHalf;default:return ne.NoteheadSlashHorizontalEnds}}updateBeamingHelper(e){if(this.beamingHelper){const t=this._symbol,s=this.renderer.smuflMetrics.stemUp.has(t)?this.renderer.smuflMetrics.stemUp.get(t).x:0,i=this.renderer.smuflMetrics.stemDown.has(t)?this.renderer.smuflMetrics.stemDown.get(t).x:0;this.beamingHelper.registerBeatLineX("slash",this.beat,e+this.x+s,e+this.x+i)}}}class ac extends Lo{constructor(){super(...arguments),this._collisionOffset=-1e3,this._skipPaint=!1,this.noteHeads=null,this.restGlyph=null}get effectElement(){return Se.StandardNotationEffects}getNoteX(e,t){return this.noteHeads?this.noteHeads.getNoteX(e,t):0}buildBoundingsLookup(e,t,s){this.noteHeads&&this.noteHeads.buildBoundingsLookup(e,t+this.x,s+this.y)}getLowestNoteY(){return this.noteHeads?this.noteHeads.getLowestNoteY():0}getHighestNoteY(){return this.noteHeads?this.noteHeads.getHighestNoteY():0}getNoteY(e,t){return this.noteHeads?this.noteHeads.getNoteY(e,t):0}updateBeamingHelper(){if(this.noteHeads)this.noteHeads.updateBeamingHelper(this.container.x+this.x);else if(this.restGlyph&&(this.restGlyph.updateBeamingHelper(this.container.x+this.x),this.renderer.bar.isMultiVoice&&-1e3===this._collisionOffset)){this._collisionOffset=this.renderer.helpers.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this._collisionOffset;const e=this.renderer.helpers.collisionHelper.restDurationsByDisplayTime;e.has(this.container.beat.playbackStart)&&e.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&e.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this._skipPaint=!0)}}paint(e,t,s){this._skipPaint||super.paint(e,t,s)}doLayout(){const e=this.renderer;if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let t=2*Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2);this.container.beat.duration===k.Whole&&1!==this.renderer.bar.staff.standardNotationLineCount&&3!==this.renderer.bar.staff.standardNotationLineCount&&(t-=2);const s=new $l(0,e.getScoreY(t),this.container.beat.duration);if(this.restGlyph=s,s.beat=this.container.beat,s.beamingHelper=this.beamingHelper,this.addNormal(s),this.renderer.bar.isMultiVoice)if(0===this.container.beat.voice.index){const t=lo.computeLineHeightsForRest(this.container.beat.duration),i=s.y-e.getScoreHeight(t[0]),a=s.y+e.getScoreHeight(t[1]);this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,i,a)}else this.renderer.helpers.collisionHelper.registerRest(this.container.beat);if(this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,t),this.container.beat.dots>0)for(let e=0;e<this.container.beat.dots;e++){const e=new so(0,0);e.renderer=this.renderer,this.createBeatDot(t,e),this.addEffect(e)}}else{const t=new Jl;this.noteHeads=t,t.beat=this.container.beat,t.beamingHelper=this.beamingHelper;const s=new Ul(!1);s.renderer=this.renderer;for(const e of this.container.beat.notes)!e.isVisible||e.beat.slashed&&0!==e.index||(this.createNoteGlyph(e),s.addParenthesis(e));if(this.addNormal(t),s.isEmpty||this.addEffect(s),this.container.beat.hasWhammyBar){const e=new Kl(this.container.beat);e.renderer=this.renderer,e.doLayout(),this.container.ties.push(e)}if(this.container.beat.dots>0)for(let t=0;t<this.container.beat.dots;t++){const t=new so(0,0);t.renderer=this.renderer;for(const s of this.container.beat.notes){this.createBeatDot(e.getNoteLine(s),t).colorOverride=ao.noteColor(e.resources,de.StandardNotationEffects,s)}this.addEffect(t)}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads&&(this.centerX=this.noteHeads.x+this.noteHeads.width/2)}createBeatDot(e,t){const s=this.renderer,i=new Pl(0,s.getScoreY(e));return t.addGlyph(i),i}createNoteHeadGlyph(e){const t=this.container.beat.graceType!==T.None,s=e.style;if(void 0!==s?.noteHead){const i=new fn(0,0,e.beat.duration,t);return i.symbol=s.noteHead,s.noteHeadCenterOnStem&&(i.centerOnStem=!0),i}if(e.beat.voice.bar.staff.isPercussion){const s=Ie.getArticulation(e);if(s)return new Ql(0,0,s,e.beat.duration,t);ee.warning("Rendering",`No articulation found for percussion instrument ${e.percussionArticulation}`)}return e.beat.slashed?new ic(0,0,e.beat.duration,t,e.beat):e.isDead?new Hl(0,0,t):e.beat.graceType===T.BendGrace?new fn(0,0,k.Quarter,!0):e.harmonicType===N.Natural?new Gl(0,0,e.beat.duration,t):new fn(0,0,e.beat.duration,t)}createNoteGlyph(e){if(e.beat.graceType===T.BendGrace&&!e.hasBend)return;const t=this.renderer,s=this.createNoteHeadGlyph(e);let i;if(s.colorOverride=ao.noteColor(t.resources,de.StandardNotationNoteHead,e),i=e.beat.slashed?t.heightLineCount-1:t.getNoteLine(e),s.y=t.getScoreY(i),this.noteHeads.addMainNoteGlyph(s,e,i),!e.beat.slashed&&e.harmonicType!==N.None&&e.harmonicType!==N.Natural){const a=e.displayValue+e.harmonicPitch,r=new Gl(0,0,e.beat.duration,this.container.beat.graceType!==T.None);r.colorOverride=s.colorOverride,i=t.accidentalHelper.getNoteLineForValue(a,!1),r.y=t.getScoreY(i),this.noteHeads.addEffectNoteGlyph(r,i)}const a=this.noteHeads.belowBeatEffects,r=this.noteHeads.aboveBeatEffects,n=this.beamingHelper.direction===Pe.Up?this.noteHeads.belowBeatEffects:this.noteHeads.aboveBeatEffects;if(e.isStaccato&&!a.has("Staccato")&&n.set("Staccato",new Zl(0,0)),e.accentuated!==_.Normal||a.has("Accent")||n.set("Accent",new Wl(0,0,e)),e.accentuated!==_.Heavy||a.has("HAccent")||n.set("HAccent",new Wl(0,0,e)),e.accentuated!==_.Tenuto||a.has("Tenuto")||n.set("Tenuto",new Wl(0,0,e)),e.showStringNumber&&e.isStringed){let t;r.has("StringNumber")?t=r.get("StringNumber"):(t=new tc(0,0),r.set("StringNumber",t)),t.addString(e.string)}if(e.isPercussion){const t=Ie.getArticulation(e);if(t&&t.techniqueSymbolPlacement!==le.Inside){let e;switch(t.techniqueSymbolPlacement){case le.Above:e=this.noteHeads.aboveBeatEffects;break;case le.Below:e=this.noteHeads.belowBeatEffects;break;case le.Outside:e=n;break;default:return}switch(t.techniqueSymbol){case ne.PictEdgeOfCymbal:e.set("PictEdgeOfCymbal",new ec(0,0));break;case ne.ArticStaccatoAbove:e.set("ArticStaccatoAbove",new Zl(0,0));break;case ne.StringsUpBow:e.set("StringsUpBow",new Dh(0,0,he.Up));break;case ne.StringsDownBow:e.set("StringsDownBow",new Dh(0,0,he.Down));break;case ne.GuitarGolpe:e.set("GuitarGolpe",new yh(0,0,!0))}}}}}class rc extends un{constructor(e){super(0,0),this._beat=e}doLayout(){if(this._beat.brushType===w.ArpeggioUp||this._beat.brushType===w.ArpeggioDown){const e=new Rh(0,0,M.Slight,!0);e.renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e,this.width=e.height}else this.width=0}paint(e,t,s){if(this._beat.brushType===w.ArpeggioUp||this._beat.brushType===w.ArpeggioDown){const i=this.renderer,a=i.lineOffset,r=t+this.y+(i.getNoteY(this._beat.maxNote,Jn.Bottom)-a),n=t+this.y+i.getNoteY(this._beat.minNote,Jn.Top)+a,o=e+this.x+this.width/2,h=this.renderer.smuflMetrics.glyphWidths.get(ne.ArrowheadBlackDown),l=this._noteVibratoGlyph;if(this._beat.brushType===w.ArpeggioUp){const t=r+h,i=n-h;l.width=Math.abs(i-t),s.beginRotate(e+this.x,i,-90),l.paint(0,0,s),s.endRotate(),s.beginPath(),s.moveTo(o,n),s.lineTo(o+h/2,n-h),s.lineTo(o-h/2,n-h),s.closePath(),s.fill()}else if(this._beat.brushType===w.ArpeggioDown){const t=r+h,i=n;l.width=Math.abs(i-t),s.beginRotate(e+this.x,t,90),l.paint(0,-l.height,s),s.endRotate(),s.beginPath(),s.moveTo(o,r),s.lineTo(o+h/2,r+h),s.lineTo(o-h/2,r+h),s.closePath(),s.fill()}}}}class nc extends Do{constructor(){super(...arguments),this._prebends=null,this.accidentals=null}get prebendNoteHeadOffset(){return this._prebends?this._prebends.x+this._prebends.noteHeadOffset:0}get effectElement(){return Se.StandardNotationEffects}doLayout(){if(!this.container.beat.isRest){const e=new xl;e.renderer=this.renderer;const t=new mh;t.renderer=this.renderer;const s=new Ul(!0);s.renderer=this.renderer;const i=new ql(this.container.beat,!0);this._prebends=i,i.renderer=this.renderer;let a=!1;for(const r of this.container.beat.notes){const n=ao.noteColor(this.renderer.resources,de.StandardNotationEffects,r);if(r.isVisible){if(r.hasBend)switch(r.bendType){case S.PrebendBend:case S.Prebend:case S.PrebendRelease:i.addGlyph(r.displayValue-(r.bendPoints[0].value/2|0),!1,n)}else if(r.beat.hasWhammyBar)switch(r.beat.whammyBarType){case ue.PrediveDive:case ue.Predive:this._prebends.addGlyph(r.displayValue-(r.beat.whammyBarPoints[0].value/2|0),!1,n)}switch(this.createAccidentalGlyph(r,e),s.addParenthesis(r),t.addFingers(r),r.slideInType){case v.IntoFromBelow:case v.IntoFromAbove:a=!0}}}a&&this.addNormal(new rl(0,0,this.renderer.smuflMetrics.simpleSlideWidth*(this.container.beat.graceType!==T.None?fn.GraceScale:1))),i.isEmpty||(this.addEffect(i),this.addNormal(new rl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==T.None?fn.GraceScale:1)))),this.container.beat.brushType!==w.None&&(this.addEffect(new rc(this.container.beat)),this.addNormal(new rl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==T.None?fn.GraceScale:1)))),t.isEmpty||(this.isEmpty||this.addNormal(new rl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==T.None?fn.GraceScale:1))),this.addEffect(t),this.addNormal(new rl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==T.None?fn.GraceScale:1)))),s.isEmpty||this.addEffect(s),e.isEmpty||(this.accidentals=e,this.isEmpty||this.addNormal(new rl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==T.None?fn.GraceScale:1))),this.addNormal(e),this.addNormal(new rl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding*(this.container.beat.graceType!==T.None?fn.GraceScale:1))))}super.doLayout()}createAccidentalGlyph(e,t){const s=this.renderer;let i=s.accidentalHelper.applyAccidental(e),a=s.getNoteLine(e);const r=this.container.beat.graceType!==T.None,n=ao.noteColor(s.resources,de.StandardNotationAccidentals,e),o=r?fn.GraceScale:1;if(i!==oe.None){const e=new Nl(0,s.getScoreY(a),i,o);e.colorOverride=n,e.renderer=this.renderer,t.addGlyph(e)}if(e.harmonicType!==N.None&&e.harmonicType!==N.Natural){const h=e.displayValue+e.harmonicPitch;i=s.accidentalHelper.applyAccidentalForValue(e.beat,h,r,!1),a=s.accidentalHelper.getNoteLineForValue(h,!1);const l=new Nl(0,s.getScoreY(a),i,o);l.colorOverride=n,l.renderer=this.renderer,t.addGlyph(l)}}}class oc extends jl{constructor(e){super(0,0),this._notes=[],this._endNoteGlyph=null,this._middleNoteGlyph=null,this._beat=e}addBends(e){if(this._notes.push(e),e.isTieOrigin)return;const t=ao.noteColor(this.renderer.resources,de.StandardNotationEffects,e);switch(e.bendType){case S.Bend:case S.PrebendRelease:case S.PrebendBend:{let s=this._endNoteGlyph;s||(s=new ql(e.beat,!1),s.renderer=this.renderer,this._endNoteGlyph=s,this.BendNoteHeads.push(s));const i=e.bendPoints[e.bendPoints.length-1];s.addGlyph(this.getBendNoteValue(e,i),i.value%2!=0,t)}break;case S.Release:if(!e.isTieOrigin){let s=this._endNoteGlyph;s||(s=new ql(e.beat,!1),s.renderer=this.renderer,this._endNoteGlyph=s,this.BendNoteHeads.push(s));const i=e.bendPoints[e.bendPoints.length-1];s.addGlyph(this.getBendNoteValue(e,i),i.value%2!=0,t)}break;case S.BendRelease:{let s=this._middleNoteGlyph;s||(s=new ql(e.beat,!1),this._middleNoteGlyph=s,s.renderer=this.renderer,this.BendNoteHeads.push(s));const i=e.bendPoints[1];s.addGlyph(this.getBendNoteValue(e,e.bendPoints[1]),i.value%2!=0,t);let a=this._endNoteGlyph;a||(a=new ql(e.beat,!1),a.renderer=this.renderer,this._endNoteGlyph=a,this.BendNoteHeads.push(a));const r=e.bendPoints[e.bendPoints.length-1];a.addGlyph(this.getBendNoteValue(e,r),r.value%2!=0,t)}}}paint(e,t,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._beat.voice.bar),a=e+i.x+i.getBeatX(this._beat,Xn.MiddleNotes);let r=e+i.x;this._beat.isLastOfVoice?r+=i.postBeatGlyphsStart:r+=i.getBeatX(this._beat.nextBeat,Xn.PreNotes),this._endNoteGlyph&&(r-=this._endNoteGlyph.upLineX);const n=(a+r)/2;this._middleNoteGlyph&&(this._middleNoteGlyph.x=n-this._middleNoteGlyph.noteHeadOffset,this._middleNoteGlyph.y=t+i.y,this._middleNoteGlyph.paint(0,0,s)),this._endNoteGlyph&&(this._endNoteGlyph.x=r-this._endNoteGlyph.noteHeadOffset,this._endNoteGlyph.y=t+i.y,this._endNoteGlyph.paint(0,0,s)),this._notes.sort((e,t)=>t.displayValue-e.displayValue);const o=this._beat.graceType===T.BendGrace?this._beat.nextBeat:this._beat;let h=1===this._notes.length?this.getTieDirection(o,i):Pe.Up;const l=this.renderer.smuflMetrics.glyphHeights.get(ne.NoteheadBlack);for(let o=0;o<this._notes.length;o++){const c=this._notes[o],d=ao.note(s,de.StandardNotationEffects,c);try{o>0&&o>=(this._notes.length/2|0)&&(h=Pe.Down);let d=t+i.y+i.getNoteY(c,Jn.Top),u=l*fn.GraceScale*.5;h===Pe.Down&&(d+=l);const p=c.bendStyle===b.Gradual?"grad.":"";if(c.isTieOrigin){const r=c.tieDestination,n=r?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,r.beat.voice.bar):null;if(n&&n.staff===i.staff){const i=e+n.x+n.getBeatX(r.beat,Xn.MiddleNotes);let o=t+n.y+n.getNoteY(r,Jn.Top);h===Pe.Down&&(o+=l),c.bendType===S.Hold||c.bendType===S.Prebend?bl.paintTie(s,1,a,d,i,o,h===Pe.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(s,a,d,i,o,h===Pe.Down,1,p)}else{const r=e+i.x+i.width,n=c.tieDestination.realValue;i.accidentalHelper.applyAccidentalForValue(c.beat,n,!1,!0);const o=t+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(n,!1));c.bendType===S.Hold||c.bendType===S.Prebend?bl.paintTie(s,1,a,d,r,o,h===Pe.Down,this.renderer.smuflMetrics.tieHeight,this.renderer.smuflMetrics.slurMidpointThickness):this.drawBendSlur(s,a,d,r,o,h===Pe.Down,1,p)}switch(c.bendType){case S.Prebend:case S.PrebendBend:case S.PrebendRelease:let r=e+i.x+i.getBeatX(c.beat,Xn.PreNotes);r+=i.getPreNotesGlyphForBeat(c.beat).prebendNoteHeadOffset;const n=t+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(c.displayValue-(c.bendPoints[0].value/2|0),!1))+u;this.drawBendSlur(s,r,n,a,d,h===Pe.Down,1)}}else{h===Pe.Up&&(u=-u);let o=0,l=0;switch(c.bendType){case S.Bend:o=this.getBendNoteValue(c,c.bendPoints[c.bendPoints.length-1]),l=this._endNoteGlyph.getNoteValueY(o)+u,this.drawBendSlur(s,a,d,r,l,h===Pe.Down,1,p);break;case S.BendRelease:const m=this.getBendNoteValue(c,c.bendPoints[1]),g=this._middleNoteGlyph.getNoteValueY(m)+u;this.drawBendSlur(s,a,d,n,g,h===Pe.Down,1,p),o=this.getBendNoteValue(c,c.bendPoints[c.bendPoints.length-1]),l=this._endNoteGlyph.getNoteValueY(o)+u,this.drawBendSlur(s,n,g,r,l,h===Pe.Down,1,p);break;case S.Release:this.BendNoteHeads.length>0&&(o=this.getBendNoteValue(c,c.bendPoints[c.bendPoints.length-1]),l=this.BendNoteHeads[0].getNoteValueY(o)+u,this.drawBendSlur(s,a,d,r,l,h===Pe.Down,1,p));break;case S.Prebend:case S.PrebendBend:case S.PrebendRelease:let f=e+i.x+i.getBeatX(c.beat,Xn.PreNotes);f+=i.getPreNotesGlyphForBeat(c.beat).prebendNoteHeadOffset;const y=t+i.y+i.getScoreY(i.accidentalHelper.getNoteLineForValue(c.displayValue-(c.bendPoints[0].value/2|0),!1))+u;this.drawBendSlur(s,f,y,a,d,h===Pe.Down,1),this.BendNoteHeads.length>0&&(o=this.getBendNoteValue(c,c.bendPoints[c.bendPoints.length-1]),l=this.BendNoteHeads[0].getNoteValueY(o)+u,this.drawBendSlur(s,a,d,r,l,h===Pe.Down,1,p))}}}finally{d?.[Symbol.dispose]?.()}}}getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}}class hc extends bl{constructor(e,t,s=!1){super(e,t,s)}doLayout(){super.doLayout()}getBeamDirection(e,t){return e.isRest?Pe.Up:t.getBeatDirection(e)===Pe.Up?Pe.Down:Pe.Up}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):this.tieDirection===Pe.Up?this.startNoteRenderer.getNoteY(this.startBeat.maxNote,Jn.Top):this.startNoteRenderer.getNoteY(this.startBeat.minNote,Jn.Bottom)}getEndY(){const e=this.endNoteRenderer;if(this.endBeat.isRest)return this.tieDirection===Pe.Up?e.getScoreY(9):e.getScoreY(0);const t=this.startNoteRenderer.getBeatDirection(this.startBeat),s=e.getBeatDirection(this.endBeat);return t!==s&&this.startBeat.graceType===T.None?s===this.tieDirection?this.tieDirection===Pe.Up?e.getNoteY(this.endBeat.maxNote,Jn.TopWithStem):e.getNoteY(this.endBeat.minNote,Jn.BottomWithStem):this.tieDirection===Pe.Up?e.getNoteY(this.endBeat.maxNote,Jn.BottomWithStem):e.getNoteY(this.endBeat.minNote,Jn.TopWithStem):this.tieDirection===Pe.Up?e.getNoteY(this.endBeat.maxNote,Jn.Top):e.getNoteY(this.endBeat.minNote,Jn.Bottom)}getStartX(){return this.startNoteRenderer.getBeatX(this.startBeat,Xn.MiddleNotes)}getEndX(){const e=this.endNoteRenderer.getBeatDirection(this.endBeat);return this.endNoteRenderer.getBeatX(this.endBeat,this.endBeat.duration>k.Whole&&e===this.tieDirection?Xn.Stem:Xn.MiddleNotes)}}class lc extends un{constructor(e,t,s,i){super(0,0),this._outType=t,this._inType=e,this._startNote=s,this._parent=i}doLayout(){this.width=0}paint(e,t,s){this.paintSlideIn(e,t,s),this.drawSlideOut(e,t,s)}paintSlideIn(e,t,s){const i=this.renderer,a=i.smuflMetrics.simpleSlideWidth;let r=e+i.x+i.getNoteX(this._startNote,$n.Left)-i.smuflMetrics.preNoteEffectPadding;const n=t+i.y+i.getNoteY(this._startNote,Jn.Center);let o=r-a,h=t+i.y;switch(this._inType){case v.IntoFromBelow:h+=i.getNoteY(this._startNote,Jn.Bottom);break;case v.IntoFromAbove:h+=i.getNoteY(this._startNote,Jn.Top);break;default:return}const l=this.getAccidentalsWidth(i,this._startNote.beat);o-=l,r-=l,this.paintSlideLine(s,!1,o,r,h,n)}getAccidentalsWidth(e,t){const s=e.getPreNotesGlyphForBeat(t);return s&&s.accidentals?s.accidentals.width:0}drawSlideOut(e,t,s){const i=this.renderer,a=i.smuflMetrics.simpleSlideWidth,r=i.smuflMetrics.postNoteEffectPadding;let n=0,o=0,h=0,l=0,c=!1;switch(this._outType){case E.Shift:case E.Legato:if(n=e+i.x+i.getBeatX(this._startNote.beat,Xn.PostNotes)+r,o=t+i.y+i.getNoteY(this._startNote,Jn.Center),this._startNote.slideTarget){const s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(h=e+s.x+s.getBeatX(this._startNote.slideTarget.beat,Xn.PreNotes)-r,l=t+s.y+s.getNoteY(this._startNote.slideTarget,Jn.Center)):(h=e+i.x+i.width,l=this._startNote.slideTarget.realValue>this._startNote.realValue?t+i.y+i.getNoteY(this._startNote,Jn.Top):t+i.y+i.getNoteY(this._startNote,Jn.Bottom))}else h=e+i.x+this._parent.x,l=o;break;case E.OutUp:n=e+i.x+i.getNoteX(this._startNote,$n.Right)+r,o=t+i.y+i.getNoteY(this._startNote,Jn.Center),h=n+a,l=t+i.y+i.getNoteY(this._startNote,Jn.Top);break;case E.OutDown:n=e+i.x+i.getNoteX(this._startNote,$n.Right)+r,o=t+i.y+i.getNoteY(this._startNote,Jn.Center),h=n+a,l=t+i.y+i.getNoteY(this._startNote,Jn.Bottom);break;case E.PickSlideUp:n=e+i.x+i.getNoteX(this._startNote,$n.Right)+2*r,o=t+i.y+i.getNoteY(this._startNote,Jn.Center),l=t+i.y+i.getNoteY(this._startNote,Jn.Top),h=e+i.x+i.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,Xn.PreNotes)),c=!0;break;case E.PickSlideDown:n=e+i.x+i.getNoteX(this._startNote,$n.Right)+2*r,o=t+i.y+i.getNoteY(this._startNote,Jn.Center),l=t+i.y+i.getNoteY(this._startNote,Jn.Bottom),h=e+i.x+i.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,Xn.PreNotes)),c=!0;break;default:return}this.paintSlideLine(s,c,n,h,o,l)}paintSlideLine(e,t,s,i,a,r){if(t){const t=new Rh(0,0,M.Slight);t.renderer=this.renderer,t.doLayout(),a-=t.height/2;const n=i-s,o=(r-=t.height/2)-a,h=Math.sqrt(Math.pow(o,2)+Math.pow(n,2));t.width=n;const l=Math.asin(o/h)*(180/Math.PI);e.beginRotate(s,a,l),t.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(s,a),e.lineTo(i,r),e.stroke()}}class cc extends hc{constructor(e,t,s=!1){super(e.beat,t.beat,s),this._startNote=e,this._endNote=t}getTieHeight(e,t,s,i){return Math.log2(s-e+1)*this.renderer.settings.notation.slurHeight/2}getStartY(){return this.isStartCentered()?this.tieDirection===Pe.Up?this.startNoteRenderer.getNoteY(this._startNote,Jn.Top):this.startNoteRenderer.getNoteY(this._startNote,Jn.Bottom):this.startNoteRenderer.getNoteY(this._startNote,Jn.Center)}getEndY(){return this.isEndCentered()?this.isEndOnStem()?this.tieDirection===Pe.Up?this.endNoteRenderer.getNoteY(this._endNote,Jn.TopWithStem):this.endNoteRenderer.getNoteY(this._endNote,Jn.BottomWithStem):this.tieDirection===Pe.Up?this.endNoteRenderer.getNoteY(this._endNote,Jn.Top):this.endNoteRenderer.getNoteY(this._endNote,Jn.Bottom):this.endNoteRenderer.getNoteY(this._endNote,Jn.Center)}isStartCentered(){return this._startNote===this._startNote.beat.maxNote&&this.tieDirection===Pe.Up||this._startNote===this._startNote.beat.minNote&&this.tieDirection===Pe.Down}isEndCentered(){return this._startNote.beat.graceType===T.None&&(this._endNote===this._endNote.beat.maxNote&&this.tieDirection===Pe.Up||this._endNote===this._endNote.beat.minNote&&this.tieDirection===Pe.Down)}isEndOnStem(){const e=this.endNoteRenderer;return this.startNoteRenderer.getBeatDirection(this.startBeat)!==e.getBeatDirection(this.endBeat)&&this.startBeat.graceType===T.None}getStartX(){return this.isStartCentered()?this.startNoteRenderer.getBeatX(this._startNote.beat,Xn.MiddleNotes):this.startNoteRenderer.getNoteX(this._startNote,$n.Right)}getEndX(){return this.isEndCentered()?this.isEndOnStem()?this.endNoteRenderer.getBeatX(this._endNote.beat,Xn.Stem):this.endNoteRenderer.getNoteX(this._endNote,$n.Center):this.endNoteRenderer.getBeatX(this._endNote.beat,Xn.PreNotes)}}class dc extends bl{constructor(e,t,s=!1){super(e?e.beat:null,t?t.beat:null,s),this.startNote=e,this.endNote=t}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(e,t){return t.getBeatDirection(e)===Pe.Up?Pe.Down:Pe.Up}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):this.tieDirection===Pe.Up?this.startNoteRenderer.getNoteY(this.startNote,Jn.Top):this.startNoteRenderer.getNoteY(this.startNote,Jn.Bottom)}getEndY(){const e=this.endNoteRenderer;return this.endBeat.isRest?this.tieDirection===Pe.Up?e.getScoreY(9):e.getScoreY(0):this.tieDirection===Pe.Up?e.getNoteY(this.endNote,Jn.Top):e.getNoteY(this.endNote,Jn.Bottom)}getStartX(){return this.startNoteRenderer.getBeatX(this.startNote.beat,Xn.PostNotes)}getEndX(){return this.endNoteRenderer.getBeatX(this.endNote.beat,Xn.PreNotes)}}class uc extends bn{constructor(){super(...arguments),this._bend=null,this._effectSlur=null,this._effectEndSlur=null}doLayout(){this._effectSlur=null,this._effectEndSlur=null,super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(e.isVisible){if(e.isTieOrigin&&!e.hasBend&&!e.beat.hasWhammyBar&&e.beat.graceType!==T.BendGrace&&e.tieDestination&&e.tieDestination.isVisible){const t=new dc(e,e.tieDestination,!1);this.addTie(t)}if(e.isTieDestination&&!e.tieOrigin.hasBend&&!e.beat.hasWhammyBar){const t=new dc(e.tieOrigin,e,!0);this.addTie(t)}if(e.slideInType!==v.None||e.slideOutType!==E.None){const t=new lc(e.slideInType,e.slideOutType,e,this);this.addTie(t)}if(e.isSlurOrigin&&e.slurDestination&&e.slurDestination.isVisible){const t=new cc(e,e.slurDestination,!1);this.addTie(t)}if(e.isSlurDestination){const t=new cc(e.slurOrigin,e,!0);this.addTie(t)}if(!this._effectSlur&&e.isEffectSlurOrigin&&e.effectSlurDestination){const t=new cc(e,e.effectSlurDestination,!1);this._effectSlur=t,this.addTie(t)}if(!this._effectEndSlur&&e.beat.isEffectSlurDestination&&e.beat.effectSlurOrigin){const t=this.onNotes.beamingHelper.direction,s=t===Pe.Up?e.beat.effectSlurOrigin.minNote:e.beat.effectSlurOrigin.maxNote,i=t===Pe.Up?e.beat.minNote:e.beat.maxNote,a=new cc(s,i,!0);this._effectEndSlur=a,this.addTie(a)}if(e.hasBend){if(!this._bend){const t=new oc(e.beat);this._bend=t,t.renderer=this.renderer,this.addTie(t)}this._bend.addBends(e)}if(this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let e=this.beat.nextBeat;for(;e.nextBeat&&e.nextBeat.isLegatoDestination;)e=e.nextBeat;this.addTie(new hc(this.beat,e,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let e=this.beat.previousBeat;for(;e.previousBeat&&e.previousBeat.isLegatoOrigin;)e=e.previousBeat;this.addTie(new hc(e,this.beat,!0))}}}}class pc extends io{paint(e,t,s){const i=ao.bar(s,m.StandardNotationKeySignature,this.renderer.bar);try{super.paint(e,t,s)}finally{i?.[Symbol.dispose]?.()}}}class mc extends yl{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this.beatEffectsMinY=null,this.beatEffectsMaxY=null,this.accidentalHelper=new Vs(this)}get repeatsBarSubElement(){return m.StandardNotationRepeats}get barNumberBarSubElement(){return m.StandardNotationBarNumber}get barLineBarSubElement(){return m.StandardNotationBarLines}get staffLineBarSubElement(){return m.StandardNotationStaffLine}get showMultiBarRest(){return!0}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return this.bar.staff.standardNotationLineCount}registerBeatEffectOverflows(e,t){const s=this.beatEffectsMinY;(null==s||e<s)&&(this.beatEffectsMinY=e);const i=this.beatEffectsMaxY;(null==i||t>i)&&(this.beatEffectsMaxY=t)}getScoreY(e){return super.getLineY(e/2)}getScoreHeight(e){return super.getLineHeight(e/2)}doLayout(){if(super.doLayout(),!this.bar.isEmpty&&this.accidentalHelper.maxLineBeat){const e=this.getScoreY(-2),t=this.getScoreY(2*this.heightLineCount),s=this.simpleWhammyOverflow,i=this.beatEffectsMinY;if(null!==i){const t=e-i;t>0&&this.registerOverflowTop(t)}const a=this.beatEffectsMaxY;if(null!==a){const e=a-t;e>0&&this.registerOverflowBottom(e)}this.registerOverflowTop(s);const r=this.getScoreHeight(1);let n=0,o=0;for(const e of this.helpers.beamHelpers)for(const t of e)if(t.isRestBeamHelper){if(t.minRestLine){const e=this.getScoreY(t.maxRestLine)-r;e<n&&(n=e)}if(t.maxRestLine){const e=this.getScoreY(t.maxRestLine)+r;e<n&&(n=e)}}else if(1===t.beats.length)if(t.beats[0].duration>=k.Half)if(t.direction===Pe.Up){let e=this.getFlagTopY(t.beats[0],t.direction);t.hasTuplet&&(e-=this.tupletSize+this.tupletOffset),e<n&&(n=e);const s=this.getFlagBottomY(t.beats[0],t.direction)+r;s>o&&(o=s)}else{let e=this.getFlagBottomY(t.beats[0],t.direction);t.hasTuplet&&(e+=this.tupletSize+this.tupletOffset),e>o&&(o=e);const s=this.getFlagTopY(t.beats[0],t.direction)-r;s<n&&(n=s)}else{const e=this.getBeatContainer(t.beats[0]);if(e){let s=e.onNotes.getHighestNoteY()-r,i=e.onNotes.getLowestNoteY()+r;t.direction===Pe.Up?t.hasTuplet&&(s-=this.tupletSize+this.tupletOffset):t.hasTuplet&&(i+=this.tupletSize+this.tupletOffset),i>o&&(o=i),s<n&&(n=s)}}else{this.ensureDrawingInfo(t,t.direction);const e=t.drawingInfos.get(t.direction);if(t.direction===Pe.Up){let s=Math.min(e.startY,e.endY);t.hasTuplet&&(s-=this.tupletSize+this.tupletOffset),s<n&&(n=s);const i=this.getBarLineStart(t.beatOfLowestNote,t.direction)+r;i>o&&(o=i)}else{let s=Math.max(e.startY,e.endY);t.hasTuplet&&(s+=this.tupletSize+this.tupletOffset),s>o&&(o=s);const i=this.getBarLineStart(t.beatOfHighestNote,t.direction)-r;i<n&&(n=i)}}n<e&&this.registerOverflowTop(Math.abs(n)+s),o>t&&this.registerOverflowBottom(Math.abs(o)-t)}}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s,Se.StandardNotationFlags,Se.StandardNotationBeams),this.paintTuplets(e,t,s,Se.StandardNotationTuplet)}getSlashFlagY(){const e=(this.heightLineCount-1)/2;return this.getLineY(e)}getFlagTopY(e,t){if(e.slashed){let s=this.getSlashFlagY();const i=ic.getSymbol(e.duration),a=e.graceType!==T.None?fn.GraceScale:1;return t===Pe.Down?s-=this.smuflMetrics.stemDown.has(i)?this.smuflMetrics.stemDown.get(i).topY*a:0:(s-=this.smuflMetrics.stemUp.has(i)?this.smuflMetrics.stemUp.get(i).bottomY*a:0,s-=this.smuflMetrics.standardStemLength+a),s}const s=this.accidentalHelper.getMinLineNote(e);if(s)return this.getBeatContainer(e).onNotes.getNoteY(s,t===Pe.Up?Jn.TopWithStem:Jn.StemDown);let i=this.getScoreY(this.accidentalHelper.getMinLine(e));if(t===Pe.Up){const t=e.graceType!==T.None?fn.GraceScale:1;i-=this.smuflMetrics.standardStemLength*t}return i}getFlagBottomY(e,t){if(e.slashed){let s=this.getSlashFlagY();const i=ic.getSymbol(e.duration),a=e.graceType!==T.None?fn.GraceScale:1;return t===Pe.Down?(s-=this.smuflMetrics.stemDown.has(i)?this.smuflMetrics.stemDown.get(i).topY*a:0,s+=this.smuflMetrics.standardStemLength+a):s-=this.smuflMetrics.stemUp.has(i)?this.smuflMetrics.stemUp.get(i).bottomY*a:0,s}const s=this.accidentalHelper.getMaxLineNote(e);if(s)return this.getBeatContainer(e).onNotes.getNoteY(s,t===Pe.Up?Jn.StemUp:Jn.BottomWithStem);let i=this.getScoreY(this.accidentalHelper.getMaxLine(e));if(t===Pe.Down){const t=e.graceType!==T.None?fn.GraceScale:1;i+=this.smuflMetrics.standardStemLength*t}return i}getBeamDirection(e){return e.direction}centerStaffStemY(e){return this.bar.staff.standardNotationLineCount===ot.DefaultStandardNotationLineCount?this.getScoreY(this.bar.staff.standardNotationLineCount-1):e.direction===Pe.Up?this.getScoreY(2*this.bar.staff.standardNotationLineCount):this.getScoreY(0)}getStemBottomY(e){throw new Error("Method not implemented.")}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}getNoteY(e,t){if(e.beat.slashed){const e=(this.heightLineCount-1)/2;return this.getLineY(e)}let s=super.getNoteY(e,t);if(Number.isNaN(s)){const i=Vs.computeLineWithoutAccidentals(this.bar,e);s=this.getScoreY(i);const a=e.beat.graceType===T.None?1:fn.GraceScale,r=this.smuflMetrics.standardStemLength*a,n=this.smuflMetrics.glyphHeights.get(fn.getSymbol(e.beat.duration))*a;switch(t){case Jn.TopWithStem:s-=r;break;case Jn.Top:s-=n/2;break;case Jn.Center:break;case Jn.Bottom:s+=n/2;break;case Jn.BottomWithStem:s+=r;case Jn.StemUp:case Jn.StemDown:}}return s}applyLayoutingInfo(){const e=super.applyLayoutingInfo();if(e&&this.bar.isMultiVoice){const e=this.getScoreY(-2),t=this.getScoreY(2*this.heightLineCount),s=this.helpers.collisionHelper.getBeatMinMaxY();s[0]<e&&this.registerOverflowTop(Math.abs(s[0])),s[1]>t&&this.registerOverflowBottom(Math.abs(s[1])-t)}return e}calculateBeamYWithDirection(e,t,s){return 0===e.beats.length?s===Pe.Up?this.getFlagTopY(e.beats[0],s):this.getFlagBottomY(e.beats[0],s):(this.ensureDrawingInfo(e,s),e.drawingInfos.get(s).calcY(t))}ensureDrawingInfo(e,t){if(!e.drawingInfos.has(t)){const s=e.graceType!==T.None?fn.GraceScale:1,i=De.getIndex(e.shortestDuration)-2;let a=this.smuflMetrics.standardStemLength*s;if(e.tremoloDuration){const t=(this.smuflMetrics.beamThickness+this.smuflMetrics.beamSpacing)*s;e.shortestDuration>k.Eighth?e.tremoloDuration===k.Eighth?a+=t:a+=1.5*t:e.tremoloDuration===k.ThirtySecond&&(a+=1.5*t)}const r=new ho;e.drawingInfos.set(t,r);const n=e.beats[0],o=e.beats[e.beats.length-1],h=e.isRestBeamHelper;r.startBeat=n,r.startX=e.getBeatLineX(n),r.startY=h?t===Pe.Up?this.getScoreY(e.minRestLine):this.getScoreY(e.maxRestLine):t===Pe.Up?this.getFlagTopY(n,t):this.getFlagBottomY(n,t),r.endBeat=o,r.endX=e.getBeatLineX(o),r.endY=h?t===Pe.Up?this.getScoreY(e.minRestLine):this.getScoreY(e.maxRestLine):t===Pe.Up?this.getFlagTopY(o,t):this.getFlagBottomY(o,t);const l=this.smuflMetrics.oneStaffSpace;if(t===Pe.Down&&r.startY>r.endY&&r.startY-r.endY>l&&(r.endY=r.startY-l),t===Pe.Down&&r.endY>r.startY&&r.endY-r.startY>l&&(r.startY=r.endY-l),t===Pe.Up&&r.startY<r.endY&&r.endY-r.startY>l&&(r.endY=r.startY+l),t===Pe.Up&&r.endY<r.startY&&r.startY-r.endY>l&&(r.startY=r.endY+l),e.beats.length>1){if(t===Pe.Up){const t=this.getScoreY(this.accidentalHelper.getMinLine(e.beatOfHighestNote))-a,s=r.calcY(e.getBeatLineX(e.beatOfHighestNote))-t;s>0&&(r.startY-=s,r.endY-=s)}else{const t=this.getScoreY(this.accidentalHelper.getMaxLine(e.beatOfLowestNote))+a-r.calcY(e.getBeatLineX(e.beatOfLowestNote));t>0&&(r.startY+=t,r.endY+=t)}if(null!==e.minRestLine||null!==e.maxRestLine){const s=e.graceType!==T.None?fn.GraceScale:1;let a=i*(this.smuflMetrics.beamSpacing+this.smuflMetrics.beamThickness)*s;if(a+=this.smuflMetrics.beamSpacing,t===Pe.Up&&null!==e.minRestLine){const t=this.getScoreY(e.minRestLine)-a,s=r.calcY(e.getBeatLineX(e.beatOfMinRestLine))-t;s>0&&(r.startY-=s,r.endY-=s)}else if(t===Pe.Down&&null!==e.maxRestLine){const t=this.getScoreY(e.maxRestLine)+a-r.calcY(e.getBeatLineX(e.beatOfMaxRestLine));t>0&&(r.startY+=t,r.endY+=t)}}if(e.slashBeats.length>0)for(const t of e.slashBeats){const s=r.calcY(e.getBeatLineX(t)),i=(e.direction===Pe.Up?this.getFlagTopY(t,e.direction):this.getFlagBottomY(t,e.direction))-s;i>0&&(r.startY+=i,r.endY+=i)}}if(i>2&&!h){const e=this.smuflMetrics.beamSpacing*s,a=this.smuflMetrics.beamThickness*s,n=i*a+(i-1)*e;if(t===Pe.Up){const t=r.startY+2*a+e-n,s=r.startY-t;s>0&&(r.startY-=s,r.endY-=s)}else{const t=r.startY-2*a+e+n-r.startY;t>0&&(r.startY+=t,r.endY+=t)}}}}getBarLineStart(e,t){if(e.slashed)return t===Pe.Down?this.getFlagTopY(e,t):this.getFlagBottomY(e,t);if(t===Pe.Up){const t=this.accidentalHelper.getMaxLineNote(e);return t?this.getBeatContainer(e).onNotes.getNoteY(t,Jn.StemUp):this.getScoreY(this.accidentalHelper.getMaxLine(e))}const s=this.accidentalHelper.getMinLineNote(e);return s?this.getBeatContainer(e).onNotes.getNoteY(s,Jn.StemDown):this.getScoreY(this.accidentalHelper.getMinLine(e))}createLinePreBeatGlyphs(){let e=!1;if(this.isFirstOfLine||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let t=0;switch(this.bar.clef){case h.Neutral:t=this.bar.staff.standardNotationLineCount-1;break;case h.F4:t=2;break;case h.C3:t=4;break;case h.C4:t=2;break;case h.G2:t=6}this.createStartSpacing(),this.addPreBeatGlyph(new Ol(0,this.getScoreY(t),this.bar.clef,this.bar.clefOttava)),this.addPreBeatGlyph(new rl(0,0,this.smuflMetrics.preBeatGlyphSpacing)),e=!0}(e||0===this.index&&this.bar.keySignature!==d.C||this.bar.previousBar&&this.bar.keySignature!==this.bar.previousBar.keySignature)&&(this.createStartSpacing(),this.createKeySignatureGlyphs()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createKeySignatureGlyphs(){let e=0;const t=this.bar.keySignature,s=this.bar.previousBar?this.bar.previousBar.keySignature:0;switch(this.bar.clef){case h.Neutral:e=0;break;case h.G2:e=1;break;case h.F4:e=3;break;case h.C3:e=2;break;case h.C4:e=0}const i=new pc;i.gap=this.smuflMetrics.accidentalPadding,i.renderer=this;const a=new Map,r=[];if(De.keySignatureIsSharp(t))for(let s=0;s<Math.abs(t);s++){const t=mc.SharpKsSteps[s]+e;r.push(new Nl(0,this.getScoreY(t),oe.Sharp,1)),a.set(t,!0)}else for(let s=0;s<Math.abs(t);s++){const t=mc.FlatKsSteps[s]+e;r.push(new Nl(0,this.getScoreY(t),oe.Flat,1)),a.set(t,!0)}if(this.bar.keySignature===d.C){const t=Math.abs(s),r=De.keySignatureIsSharp(s)?mc.SharpKsSteps:mc.FlatKsSteps;for(let s=0;s<t;s++){const t=r[s]+e;a.has(t)||i.addGlyph(new Nl(0,this.getScoreY(r[s]+e),oe.Natural,1))}}for(const e of r)i.addGlyph(e);this.addPreBeatGlyph(i),i.isEmpty||this.addPreBeatGlyph(new rl(0,0,this.smuflMetrics.preBeatGlyphSpacing))}createTimeSignatureGlyphs(){const e=this.bar.staff.standardNotationLineCount-1;this.addPreBeatGlyph(new Ll(0,this.getScoreY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime)),this.addPreBeatGlyph(new rl(0,0,this.smuflMetrics.preBeatGlyphSpacing))}createVoiceGlyphs(e){for(const t of e.beats){const s=new uc(t,this.getVoiceContainer(e));s.preNotes=new nc,s.onNotes=new ac,this.addBeatGlyph(s)}}getNoteLine(e){return this.accidentalHelper.getNoteLine(e)}completeBeamingHelper(e){if(this.bar.isMultiVoice&&e.highestNoteInHelper&&e.lowestNoteInHelper){let t=0,s=0,i=0;e.hasTuplet&&(i+=2*this.resources.effectFont.size),e.direction===Pe.Up?(t=this.getNoteY(e.highestNoteInHelper,Jn.TopWithStem)-i,s=this.getNoteY(e.lowestNoteInHelper,Jn.Bottom)):(t=this.getNoteY(e.highestNoteInHelper,Jn.Top),s=this.getNoteY(e.lowestNoteInHelper,Jn.BottomWithStem)+i);for(const i of e.beats)this.helpers.collisionHelper.reserveBeatSlot(i,t,s)}}paintBeamingStem(e,t,s,i,a,r){const n=ao.beat(r,Se.StandardNotationStem,e);try{r.fillRect(s,i,this.smuflMetrics.stemThickness,a-i)}finally{n?.[Symbol.dispose]?.()}}}mc.StaffId="score",mc.SharpKsSteps=[-1,2,-2,1,4,0,3],mc.FlatKsSteps=[3,0,4,1,5,2,6];class gc extends to{get staffId(){return mc.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new mc(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showStandardNotation}}class fc extends bl{constructor(e,t,s=!1){super(e.beat,t.beat,s),this.startNote=e,this.endNote=t}get isLeftHandTap(){return this.startNote===this.endNote}getTieHeight(e,t,s,i){return this.isLeftHandTap?this.startNoteRenderer.smuflMetrics.tieHeight:super.getTieHeight(e,t,s,i)}getBeamDirection(e,t){return Pe.Down}static getBeamDirectionForNote(e){return Pe.Down}getStartY(){return this.startNoteRenderer.getNoteY(this.startNote,Jn.Center)}getEndY(){return this.getStartY()}getStartX(){return this.isLeftHandTap?this.getEndX()-this.renderer.smuflMetrics.leftHandTabTieWidth:this.startNoteRenderer.getNoteX(this.startNote,$n.Right)}getEndX(){return this.endNoteRenderer.getNoteX(this.endNote,$n.Left)}}class yc extends bn{constructor(){super(...arguments),this._tiedNoteTie=null}createTies(e){if(e.isVisible){if(!this._tiedNoteTie&&e.isTieOrigin&&e.tieDestination.isVisible){const t=new fc(e,e.tieDestination,!1);this._tiedNoteTie=t,this.addTie(t)}if(!this._tiedNoteTie&&e.isTieDestination){const t=new fc(e.tieOrigin,e,!0);this._tiedNoteTie=t,this.addTie(t)}}}}class bc extends $l{updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,s){super.internalPaint(e,t,s,Se.SlashRests)}}class Sc extends Lo{constructor(){super(...arguments),this.noteHeads=null,this.deadSlapped=null,this.restGlyph=null}get effectElement(){return Se.SlashEffects}getNoteX(e,t){let s=null;if(this.noteHeads?s=this.noteHeads:this.deadSlapped&&(s=this.deadSlapped),s){let e=s.x;switch(t){case $n.Left:break;case $n.Center:e+=s.width/2;break;case $n.Right:e+=s.width}return e}return 0}buildBoundingsLookup(e,t,s){if(this.noteHeads&&this.container.beat.notes.length>0){const i=new zr;i.note=this.container.beat.notes[0],i.noteHeadBounds=new Ts,i.noteHeadBounds.x=t+this.x+this.noteHeads.x,i.noteHeadBounds.y=s+this.y+this.noteHeads.y-this.noteHeads.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,e.addNote(i)}}getLowestNoteY(){return this.noteHeads?this.noteHeads.y:0}getHighestNoteY(){return this.noteHeads?this.noteHeads.y:0}getNoteY(e,t){let s=null,i=ne.None;if(this.noteHeads?(s=this.noteHeads,i=ic.getSymbol(e.beat.duration)):this.deadSlapped&&(s=this.deadSlapped),s){let e=this.y+s.y;switch(t){case Jn.Top:case Jn.TopWithStem:e-=s.height/2;break;case Jn.Center:break;case Jn.Bottom:case Jn.BottomWithStem:e+=s.height/2;break;case Jn.StemUp:e-=this.renderer.smuflMetrics.stemUp.has(i)?this.renderer.smuflMetrics.stemUp.get(i).bottomY:0;break;case Jn.StemDown:e-=this.renderer.smuflMetrics.stemDown.has(i)?this.renderer.smuflMetrics.stemDown.get(i).topY:0}return e}return 0}updateBeamingHelper(){this.noteHeads?this.noteHeads.updateBeamingHelper(this.container.x+this.x):this.deadSlapped?this.beamingHelper&&this.beamingHelper.registerBeatLineX("slash",this.container.beat,this.container.x+this.x+this.deadSlapped.x+this.width,this.container.x+this.x+this.deadSlapped.x):this.restGlyph&&this.restGlyph.updateBeamingHelper(this.container.x+this.x)}doLayout(){const e=this.renderer,t=e.getNoteLine(),s=e.getLineY(t);if(this.container.beat.deadSlapped){const e=new El;e.renderer=this.renderer,e.doLayout(),this.deadSlapped=e,this.addEffect(e)}else if(!this.container.beat.isEmpty)if(this.container.beat.isRest){const e=new bc(0,s,this.container.beat.duration);this.restGlyph=e,e.beat=this.container.beat,e.beamingHelper=this.beamingHelper,this.addNormal(e),this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,0)}else{const e=this.container.beat.graceType!==T.None,t=new ic(0,s,this.container.beat.duration,e,this.container.beat);this.noteHeads=t,t.beat=this.container.beat,t.beamingHelper=this.beamingHelper,this.addNormal(t)}if(this.container.beat.dots>0)for(let t=0;t<this.container.beat.dots;t++)this.addEffect(new Pl(0,e.getLineY(e.getNoteLine())-e.getLineHeight(.5)));super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteHeads?this.centerX=this.noteHeads.x+this.noteHeads.width/2:this.deadSlapped&&(this.centerX=this.deadSlapped.x+this.deadSlapped.width/2)}}class wc extends yl{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this._isOnlySlash=!t.staff.showTablature&&!t.staff.showStandardNotation,this.helpers.preferredBeamDirection=Pe.Up}get repeatsBarSubElement(){return m.SlashRepeats}get barNumberBarSubElement(){return m.SlashBarNumber}get barLineBarSubElement(){return m.SlashBarLines}get staffLineBarSubElement(){return m.SlashStaffLine}get lineSpacing(){return this.smuflMetrics.oneStaffSpace}get heightLineCount(){return 5}get drawnLineCount(){return 1}get bottomGlyphOverflow(){return 0}paint(e,t,s){super.paint(e,t,s),this.paintBeams(e,t,s,Se.SlashFlags,Se.SlashBeams),this.paintTuplets(e,t,s,Se.SlashTuplet)}doLayout(){super.doLayout();let e=!1;for(const t of this.bar.voices)if(this.hasVoiceContainer(t)){if(this.getVoiceContainer(t).tupletGroups.length>0){e=!0;break}}e&&this.registerOverflowTop(this.tupletSize)}getNoteLine(){return 0}getFlagTopY(e,t){const s=this.smuflMetrics.glyphHeights.get(ne.NoteheadSlashWhiteHalf);let i=this.getLineY(0)-s/2;return t===Pe.Up&&(i-=this.getFlagStemSize(e.duration,!0)),i}getFlagBottomY(e,t){const s=this.smuflMetrics.glyphHeights.get(ne.NoteheadSlashWhiteHalf);let i=this.getLineY(0)-s/2;return t===Pe.Down&&(i+=this.getFlagStemSize(e.duration,!0)),i}getBeamDirection(e){return Pe.Up}getNoteY(e,t){let s=super.getNoteY(e,t);return Number.isNaN(s)&&(s=this.getLineY(0)),s}calculateBeamYWithDirection(e,t,s){return this.getLineY(0)-this.getFlagStemSize(e.shortestDuration)}getBarLineStart(e,t){const s=this.smuflMetrics.glyphHeights.get(ne.NoteheadSlashWhiteHalf);return this.getLineY(0)-s/2}createLinePreBeatGlyphs(){this._isOnlySlash&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new rl(0,0,this.smuflMetrics.oneStaffSpace));const e=this.bar.masterBar,t=new Ll(0,this.getLineY(0),e.timeSignatureNumerator,e.timeSignatureDenominator,e.timeSignatureCommon,e.isFreeTime&&(null==e.previousMasterBar||e.isFreeTime!==e.previousMasterBar.isFreeTime));t.barSubElement=m.SlashTimeSignature,this.addPreBeatGlyph(t)}createVoiceGlyphs(e){for(const t of e.beats){const s=new yc(t,this.getVoiceContainer(e));s.preNotes=new Do,s.onNotes=0===e.index?new Sc:new Lo,this.addBeatGlyph(s)}}paintBeamingStem(e,t,s,i,a,r){const n=ao.beat(r,Se.SlashStem,e);try{const e=r.lineWidth;r.lineWidth=this.smuflMetrics.stemThickness,r.beginPath(),r.moveTo(s,i),r.lineTo(s,a),r.stroke(),r.lineWidth=e}finally{n?.[Symbol.dispose]?.()}}}wc.StaffId="slash";class Bc extends to{get staffId(){return wc.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}create(e,t){return new wc(e,t)}canCreate(e,t){return super.canCreate(e,t)&&t.showSlash}}class kc extends j{constructor(e=0,t=0){super(e,t),this.lineValue=0,this.lineValue=t}}class Tc extends un{constructor(){super(0,0),this._notes=[],this._renderPoints=new Map,this._preBendMinValue=-1,this._bendMiddleMinValue=-1,this._bendEndMinValue=-1,this._bendEndContinuedMinValue=-1,this._releaseMinValue=-1,this._releaseContinuedMinValue=-1,this._maxBendValue=-1}addBends(e){this._notes.push(e);const t=this.createRenderingPoints(e);this._renderPoints.set(e.id,t),(-1===this._maxBendValue||this._maxBendValue<e.maxBendPoint.value)&&(this._maxBendValue=e.maxBendPoint.value);let s=0;switch(e.bendType){case S.Bend:s=t[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||s<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=s):(-1===this._bendEndMinValue||s<this._bendEndMinValue)&&(this._bendEndMinValue=s);break;case S.Release:s=t[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):s>0&&(-1===this._releaseMinValue||s<this._releaseMinValue)&&(this._releaseMinValue=s);break;case S.BendRelease:s=t[1].value,(-1===this._bendMiddleMinValue||s<this._bendMiddleMinValue)&&(this._bendMiddleMinValue=s),s=t[2].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):s>0&&(-1===this._releaseMinValue||s<this._releaseMinValue)&&(this._releaseMinValue=s);break;case S.Prebend:s=t[0].value,(-1===this._preBendMinValue||s<this._preBendMinValue)&&(this._preBendMinValue=s);break;case S.PrebendBend:s=t[0].value,(-1===this._preBendMinValue||s<this._preBendMinValue)&&(this._preBendMinValue=s),s=t[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||s<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=s):(-1===this._bendEndMinValue||s<this._bendEndMinValue)&&(this._bendEndMinValue=s);break;case S.PrebendRelease:s=t[0].value,(-1===this._preBendMinValue||s<this._preBendMinValue)&&(this._preBendMinValue=s),s=t[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||s<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=s):s>0&&(-1===this._releaseMinValue||s<this._releaseMinValue)&&(this._releaseMinValue=s)}}doLayout(){super.doLayout();const e=this._maxBendValue*this.renderer.smuflMetrics.tabBendPerValueHeight;this.renderer.registerOverflowTop(e);let t=0;for(const e of this._notes){const s=this._renderPoints.get(e.id);switch(e.bendType){case S.Bend:s[1].lineValue=e.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case S.Release:t=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(s[1].lineValue=t);break;case S.BendRelease:s[1].lineValue=this._bendMiddleMinValue,t=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(s[2].lineValue=t);break;case S.Prebend:s[0].lineValue=this._preBendMinValue;break;case S.PrebendBend:s[0].lineValue=this._preBendMinValue,s[1].lineValue=e.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case S.PrebendRelease:s[0].lineValue=this._preBendMinValue,t=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue,t>=0&&(s[1].lineValue=t)}}this.width=0,this._notes.sort((e,t)=>e.isStringed?e.string-t.string:e.realValue-t.realValue)}createRenderingPoints(e){const t=[];switch(e.bendType){case S.Custom:for(const s of e.bendPoints)t.push(new kc(s.offset,s.value));break;case S.BendRelease:t.push(new kc(0,e.bendPoints[0].value)),t.push(new kc(j.MaxPosition/2|0,e.bendPoints[1].value)),t.push(new kc(j.MaxPosition,e.bendPoints[3].value));break;case S.Bend:case S.Hold:case S.Prebend:case S.PrebendBend:case S.PrebendRelease:case S.Release:t.push(new kc(0,e.bendPoints[0].value)),t.push(new kc(j.MaxPosition,e.bendPoints[1].value))}return t}paint(e,t,s){const i=s.color;this._notes.length>1&&(s.color=this.renderer.resources.secondaryGlyphColor);for(const a of this._notes){const r=this._renderPoints.get(a.id),n=this.renderer;let o=a,h=!1,l=null,c=!1;const d=a.bendStyle===b.Gradual?"grad.":"";let u=null;for(;o.isTieOrigin;){const e=o.tieDestination;if(l=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,e.beat.voice.bar),!l||n.staff!==l.staff)break;if(o=e,h=!0,o.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes||o.vibrato!==M.None){c=!0;break}}u=o.beat,l=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,u.voice.bar),u.isLastOfVoice&&!o.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(u=null);let p=0,m=0;const g=t+n.y,f=this.renderer.smuflMetrics.glyphWidths.get(ne.ArrowheadBlackDown);p=e+n.x,r[0].value>0||a.isContinuedBend?p+=n.getBeatX(a.beat,Xn.MiddleNotes):p+=n.getNoteX(a,$n.Right),m=!u||u.isLastOfVoice&&!c?e+l.x+l.postBeatGlyphsStart:c||!u.nextBeat?e+l.x+l.getBeatX(u,Xn.MiddleNotes):a.bendType===S.Hold?e+l.x+l.getBeatX(u.nextBeat,Xn.OnNotes):e+l.x+l.getBeatX(u.nextBeat,Xn.PreNotes),h||(m-=f);const y=(m-p)/j.MaxPosition;s.beginPath();for(let e=0,t=r.length-1;e<t;e++){const t=r[e];let i=r[e+1];0!==e||0===t.value||a.isTieDestination||this.paintBend(a,new kc(0,0),t,p,g,y,d,s),a.bendType!==S.Prebend?(0===e&&(p+=this.renderer.smuflMetrics.postNoteEffectPadding),this.paintBend(a,t,i,p,g,y,d,s)):a.isTieOrigin&&a.tieDestination.hasBend&&(i=new kc(j.MaxPosition,t.value),i.lineValue=t.lineValue,this.paintBend(a,t,i,p,g,y,d,s))}if(o.vibrato!==M.None){const i=m-e+f-l.x,a=g-t-this.renderer.smuflMetrics.tabBendPerValueHeight*r[r.length-1].lineValue,n=new Rh(i,a,o.vibrato);n.beat=o.beat,n.renderer=l,n.doLayout(),n.paint(e+l.x,t,s)}s.color=i}}paintBend(e,t,s,i,a,r,n,o){const h=this.renderer,l=this.renderer.resources,c=h.lineOffset/2,d=i+r*t.offset,u=this.renderer.smuflMetrics.tabBendPerValueHeight;let p=a-u*t.lineValue;0===t.value?s.offset===t.offset?p+=h.getNoteY(e.beat.maxStringNote,Jn.Top)-c/2:p+=h.getNoteY(e,Jn.Center):p+=c;const m=i+r*s.offset;let g=a-u*s.lineValue;0===s.lineValue?g+=h.getNoteY(e,Jn.Center):g+=c;let f=0;const y=this.renderer.smuflMetrics.glyphWidths.get(ne.ArrowheadBlackDown);s.value>t.value?(g+y>p&&(g=p-y),o.beginPath(),o.moveTo(m,g),o.lineTo(m-.5*y,g+y),o.lineTo(m+.5*y,g+y),o.closePath(),o.fill(),f=y):s.value!==t.value&&(g<p&&(g=p+y),o.beginPath(),o.moveTo(m,g),o.lineTo(m-.5*y,g-y),o.lineTo(m+.5*y,g-y),o.closePath(),o.fill(),f=-y);const b=o.lineWidth;if(o.lineWidth=this.renderer.smuflMetrics.arrowShaftThickness,o.beginPath(),t.value===s.value){if(t.lineValue>0){let e=m;const t=this.renderer.smuflMetrics.tabBendDashSize,s=d+t;if((e-d)/(2*t)<1)o.moveTo(e,p),o.lineTo(d,p);else for(;e>s;)o.moveTo(e,p),o.lineTo(e-t,p),e-=2*t;o.stroke()}}else m>d?(o.moveTo(d,p),o.bezierCurveTo((d+m)/2,p,m,p,m,g+f),o.stroke()):(o.moveTo(d,p),o.lineTo(m,g),o.stroke());if(n&&t.offset<s.offset){o.font=l.graceFont;const e=o.measureText(n);let t=0,s=0;if(p>g){const i=Math.abs(p-g);t=i>e.height?p-i/2:p,s=(d+m-e.width)/2}else t=p,s=m-e.width;o.fillText(n,s,t)}if(0!==s.value&&t.value!==s.value){let e=s.value;const i=s.value>t.value;e=Math.abs(e);let r="";if(4===e)r="full",e-=4;else if(e>=4||e<=-4){const t=e/4|0;r+=t,e-=4*t}if(e>0&&(r+=Tc.getFractionSign(e)),""!==r){g=a-u*s.value;let e=g;i||(e=p+1*Math.abs(g-p)/3),o.font=l.tablatureFont;const t=o.measureText(r),n=e-t.height/1.5,h=m-t.width/2;o.fillText(r,h,n-l.engravingSettings.tabBendLabelPadding)}}o.lineWidth=b}static getFractionSign(e){switch(e){case 1:return"¼";case 2:return"½";case 3:return"¾";default:return`${e}/ 4`}}}class _c extends un{constructor(e,t,s,i){super(0,0),this._inType=e,this._outType=t,this._startNote=s,this._parent=i}doLayout(){this.width=0}paint(e,t,s){this.paintSlideIn(e,t,s),this.paintSlideOut(e,t,s)}paintSlideIn(e,t,s){const i=this.renderer,a=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight;let n=0,o=0,h=0,l=0;const c=this.renderer.smuflMetrics.preNoteEffectPadding;switch(this._inType){case v.IntoFromBelow:h=e+i.x+i.getNoteX(this._startNote,$n.Left)-c,l=t+i.y+i.getNoteY(this._startNote,Jn.Center)-r,n=h-a,o=t+i.y+i.getNoteY(this._startNote,Jn.Center)+r;break;case v.IntoFromAbove:h=e+i.x+i.getNoteX(this._startNote,$n.Left)-c,l=t+i.y+i.getNoteY(this._startNote,Jn.Center)+r,n=h-a,o=t+i.y+i.getNoteY(this._startNote,Jn.Center)-r;break;default:return}this.paintSlideLine(s,!1,n,h,o,l)}paintSlideOut(e,t,s){const i=this.renderer,a=this.renderer.smuflMetrics.simpleSlideWidth,r=this.renderer.smuflMetrics.simpleSlideHeight;let n=0,o=0,h=0,l=0,c=!1;const d=this.renderer.smuflMetrics.postNoteEffectPadding;switch(this._outType){case E.Shift:case E.Legato:if(n=e+i.x+i.getBeatX(this._startNote.beat,Xn.PostNotes)+d,o=t+i.y+i.getNoteY(this._startNote,Jn.Center),this._startNote.slideTarget){const s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this._startNote.slideTarget.beat.voice.bar);s&&s.staff===i.staff?(h=e+s.x+s.getBeatX(this._startNote.slideTarget.beat,Xn.OnNotes)-d,l=t+s.y+s.getNoteY(this._startNote.slideTarget,Jn.Center)):(h=e+i.x+i.width,l=o),this._startNote.slideTarget.fret>this._startNote.fret?(o+=r,l-=r):(o-=r,l+=r)}else h=e+i.x+this._parent.x,l=o;break;case E.OutUp:n=e+i.x+i.getNoteX(this._startNote,$n.Right)+d,o=t+i.y+i.getNoteY(this._startNote,Jn.Center)+r,h=n+a,l=t+i.y+i.getNoteY(this._startNote,Jn.Center)-r;break;case E.OutDown:n=e+i.x+i.getNoteX(this._startNote,$n.Right)+d,o=t+i.y+i.getNoteY(this._startNote,Jn.Center)-r,h=n+a,l=t+i.y+i.getNoteY(this._startNote,Jn.Center)+r;break;case E.PickSlideDown:n=e+i.x+i.getNoteX(this._startNote,$n.Right)+2*d,o=t+i.y+i.getNoteY(this._startNote,Jn.Center),h=e+i.x+i.width,l=o+3*r,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,Xn.PreNotes)),c=!0;break;case E.PickSlideUp:n=e+i.x+i.getNoteX(this._startNote,$n.Right)+2*d,o=t+i.y+i.getNoteY(this._startNote,Jn.Center),h=e+i.x+i.width,l=o-3*r,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(h=e+i.x+i.getBeatX(this._startNote.beat.nextBeat,Xn.PreNotes)),c=!0;break;default:return}this.paintSlideLine(s,c,n,h,o,l)}paintSlideLine(e,t,s,i,a,r){if(t){const t=new Rh(0,0,M.Slight);t.renderer=this.renderer,t.doLayout(),a-=t.height/2;const n=i-s,o=(r-=t.height/2)-a,h=Math.sqrt(Math.pow(o,2)+Math.pow(n,2));t.width=n;const l=Math.asin(o/h)*(180/Math.PI);e.beginRotate(s,a,l),t.paint(0,0,e),e.endRotate()}else e.beginPath(),e.moveTo(s,a),e.lineTo(i,r),e.stroke()}}class xc extends wl{constructor(e,t,s,i=!1){super(e,t,i),this._direction=wl.getBeamDirectionForNote(e),this._forSlide=s}getTieHeight(e,t,s,i){return Math.log(s-e+1)*this.renderer.settings.notation.slurHeight/2}tryExpand(e,t,s,i){if(this._forSlide!==s)return!1;if(this.forEnd!==i)return!1;if(this.startNote.beat.id!==e.beat.id)return!1;if(this.endNote.beat.id!==t.beat.id)return!1;if(this._direction!==wl.getBeamDirectionForNote(e))return!1;switch(this._direction){case Pe.Up:e.realValue>this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue>this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break;case Pe.Down:e.realValue<this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue<this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat)}return!0}paint(e,t,s){const i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,this.startBeat.voice.bar),a=this.getBeamDirection(this.startBeat,i),r=`tab.slur.${this.startNote.beat.id}.${this.endNote.beat.id}.${a}`,n=this.renderer;n.staff.getSharedLayoutData(r,!1)||(n.staff.setSharedLayoutData(r,!0),super.paint(e,t,s))}}class Nc extends bn{constructor(){super(...arguments),this._bend=null,this._effectSlurs=[]}drawBeamHelperAsFlags(e){return e.hasFlag(this.renderer.drawBeamHelperAsFlags(e),this.beat)}doLayout(){this._effectSlurs=[],super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){if(!e.isVisible)return;const t=this.renderer;if(e.isTieOrigin&&t.showTiedNotes&&e.tieDestination.isVisible){const t=new wl(e,e.tieDestination,!1);this.addTie(t)}if(e.isTieDestination&&t.showTiedNotes){const t=new wl(e.tieOrigin,e,!0);this.addTie(t)}if(e.isLeftHandTapped&&!e.isHammerPullDestination){const t=new wl(e,e,!1);this.addTie(t)}if(e.isEffectSlurOrigin&&e.effectSlurDestination){let t=!1;for(const s of this._effectSlurs)if(s.tryExpand(e,e.effectSlurDestination,!1,!1)){t=!0;break}if(!t){const t=new xc(e,e.effectSlurDestination,!1,!1);this._effectSlurs.push(t),this.addTie(t)}}if(e.isEffectSlurDestination&&e.effectSlurOrigin){let t=!1;for(const s of this._effectSlurs)if(s.tryExpand(e.effectSlurOrigin,e,!1,!0)){t=!0;break}if(!t){const t=new xc(e.effectSlurOrigin,e,!1,!0);this._effectSlurs.push(t),this.addTie(t)}}if(e.slideInType!==v.None||e.slideOutType!==E.None){const t=new _c(e.slideInType,e.slideOutType,e,this);this.addTie(t)}if(e.hasBend){if(!this._bend){const e=new Tc;this._bend=e,e.renderer=this.renderer,this.addTie(e)}this._bend.addBends(e)}}}class Pc extends un{constructor(e,t,s){super(e,t),this._noteString=null,this._trillNoteString=null,this._trillNoteStringWidth=0,this.isEmpty=!1,this.noteStringWidth=0,this._note=s}doLayout(){const t=this._note;let s=t.fret-t.beat.voice.bar.staff.transpositionPitch;if(t.harmonicType===N.Natural&&0!==t.harmonicValue&&(s=t.harmonicValue-t.beat.voice.bar.staff.transpositionPitch),t.isTieDestination)0===t.beat.index&&this.renderer.settings.notation.notationMode===e.NotationMode.GuitarPro||(t.bendType===S.Bend||t.bendType===S.BendRelease)&&this.renderer.settings.notation.isNotationElementVisible(e.NotationElement.TabNotesOnTiedBends)?this._noteString=`(${(t.tieOrigin.fret-t.beat.voice.bar.staff.transpositionPitch).toString()})`:this._noteString="";else if(this._noteString=t.isDead?"x":s.toString(),t.isGhost)this._noteString=`(${this._noteString})`;else if(t.harmonicType===N.Natural){const e=this._noteString.indexOf(String.fromCharCode(46));e>=0&&(this._noteString=this._noteString.substr(0,e+2)),this._noteString=`<${this._noteString}>`}if(t.isTrill)this._trillNoteString=`(${(t.trillFret-t.beat.voice.bar.staff.transpositionPitch).toString()})`;else if(De.isAlmostEqualTo(t.harmonicValue,0))this._trillNoteString="";else switch(t.harmonicType){case N.Artificial:case N.Pinch:case N.Tap:case N.Semi:case N.Feedback:let e=(s+t.harmonicValue).toString();const i=e.indexOf(String.fromCharCode(46));i>=0&&(e=e.substr(0,i+2)),this._trillNoteString=`<${e}>`;break;default:this._trillNoteString=""}if(this.isEmpty=!this._noteString,!this.isEmpty){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont;const e=!!this._trillNoteString;this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this._noteString+(e?" ":"")).width,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,e&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this._trillNoteStringWidth=3+this.renderer.scoreRenderer.canvas.measureText(this._trillNoteString).width,this.width+=this._trillNoteStringWidth)}}paint(e,t,s){if(this.isEmpty)return;const i=this.noteStringWidth+this._trillNoteStringWidth,a=e+this.x+(this.width-i)/2;this.paintTrill(a,t,s);const r=ao.note(s,de.GuitarTabFretNumber,this._note);try{s.fillText(this._noteString,a,t+this.y)}finally{r?.[Symbol.dispose]?.()}}paintTrill(e,t,s){const i=ao.note(s,de.GuitarTabFretNumber,this._note);try{const i=this.renderer.scoreRenderer.canvas.font;this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,s.fillText(this._trillNoteString,e+this.noteStringWidth,t+this.y),this.renderer.scoreRenderer.canvas.font=i}finally{i?.[Symbol.dispose]?.()}}buildBoundingsLookup(e,t,s){const i=new zr;i.note=this._note,i.noteHeadBounds=new Ts,i.noteHeadBounds.x=t+this.x,i.noteHeadBounds.y=s+this.y-this.height/2,i.noteHeadBounds.w=this.width,i.noteHeadBounds.h=this.height,e.addNote(i)}}class vc extends un{constructor(e,t,s){super(e,t),this._notes=[],this._deadSlapped=null,this.maxStringNote=null,this.minStringNote=null,this.beatEffects=new Map,this.notesPerString=new Map,this.noteStringWidth=0,this._isGrace=s}buildBoundingsLookup(e,t,s){for(const i of this._notes)i.buildBoundingsLookup(e,t+this.x,s+this.y)}getNoteX(e,t){if(this.notesPerString.has(e.string)){const s=this.notesPerString.get(e.string);let i=this.x+s.x;switch(t){case $n.Left:break;case $n.Center:i+=s.noteStringWidth/2;break;case $n.Right:i+=s.width}return i}return 0}getLowestNoteY(){return this.maxStringNote?this.getNoteY(this.maxStringNote,Jn.Center):0}getHighestNoteY(){return this.minStringNote?this.getNoteY(this.minStringNote,Jn.Center):0}getNoteY(e,t){if(this.notesPerString.has(e.string)){const s=this.notesPerString.get(e.string);let i=this.y+s.y;switch(t){case Jn.Top:case Jn.TopWithStem:i-=s.height/2;break;case Jn.Center:break;case Jn.Bottom:case Jn.BottomWithStem:i+=s.height/2;case Jn.StemUp:case Jn.StemDown:}return i}return 0}doLayout(){let e=0;if(this.beat.deadSlapped)this._deadSlapped=new El,this._deadSlapped.renderer=this.renderer,this._deadSlapped.doLayout(),e=this._deadSlapped.width,this.noteStringWidth=e;else{let t=0;for(let s=0,i=this._notes.length;s<i;s++){const i=this._notes[s];i.renderer=this.renderer,i.doLayout(),i.width>e&&(e=i.width),i.noteStringWidth>t&&(t=i.noteStringWidth)}this.noteStringWidth=t;const s=this.renderer.resources.tablatureFont.size;let i=this.getNoteY(this.minStringNote,Jn.Center)+s/2;const a=this.renderer.smuflMetrics.onNoteEffectPadding;for(const e of this.beatEffects.values())e.y+=i,e.x+=this.width/2,e.renderer=this.renderer,i+=e.height+a,e.doLayout()}this.width=e}addNoteGlyph(e,t){this._notes.push(e),this.notesPerString.set(t.string,e),(!this.minStringNote||t.string<this.minStringNote.string)&&(this.minStringNote=t),(!this.maxStringNote||t.string>this.maxStringNote.string)&&(this.maxStringNote=t)}paint(e,t,s){if(e+=this.x,t+=this.y,this.beat.deadSlapped)this._deadSlapped?.paint(e,t,s);else{const i=this.renderer.resources,a=s.textBaseline;s.textBaseline=Be.Middle,s.font=this._isGrace?i.graceFont:i.tablatureFont;const r=this._notes,n=this.width;for(const i of r)i.renderer=this.renderer,i.width=n,i.paint(e,t,s);s.textBaseline=a;const o=ao.beat(s,Se.GuitarTabEffects,this.beat);try{for(const i of this.beatEffects.values())i.paint(e,t,s)}finally{o?.[Symbol.dispose]?.()}}}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}}class Ec extends mn{constructor(e,t,s,i){super(e,t,1,$l.getSymbol(i)),this._isVisibleRest=s}doLayout(){super.doLayout()}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,s){if(this._isVisibleRest){const i=ao.beat(s,Se.GuitarTabRests,this.beat);try{super.paint(e,t,s)}finally{i?.[Symbol.dispose]?.()}}}}class Mc extends un{constructor(e){super(0,0),this._isSimpleDip=!1,this._beat=e,this._renderPoints=this.createRenderingPoints(e)}createRenderingPoints(e){if(e.whammyBarType===ue.Custom)return e.whammyBarPoints;const t=[];switch(e.whammyBarType){case ue.Dive:case ue.Hold:case ue.PrediveDive:case ue.Predive:t.push(new j(0,e.whammyBarPoints[0].value)),t.push(new j(j.MaxPosition,e.whammyBarPoints[1].value));break;case ue.Dip:t.push(new j(0,e.whammyBarPoints[0].value)),t.push(new j(j.MaxPosition/2|0,e.whammyBarPoints[1].value)),t.push(new j(j.MaxPosition,e.whammyBarPoints[e.whammyBarPoints.length-1].value))}return t}doLayout(){super.doLayout(),this._isSimpleDip=this.renderer.settings.notation.notationMode===e.NotationMode.SongBook&&this._beat.whammyBarType===ue.Dip;let t=null,s=null,i=this._beat;for(;i&&i.hasWhammyBar;)(!t||t.value>i.minWhammyPoint.value)&&(t=i.minWhammyPoint),(!s||s.value<i.maxWhammyPoint.value)&&(s=i.maxWhammyPoint),i=i.nextBeat;let a=s.value>0?Math.abs(this.getOffset(s.value)):0;(a>0||0!==this._beat.whammyBarPoints[0].value||this.renderer.settings.notation.isNotationElementVisible(e.NotationElement.ZerosOnDiveWhammys))&&(a+=this.renderer.resources.tablatureFont.size+this.renderer.smuflMetrics.tabWhammyTextPadding);const r=t.value<0?Math.abs(this.getOffset(t.value)):0,n=this.renderer.staff.getSharedLayoutData(Mc.TopOffsetSharedDataKey,-1);let o=n;a>n&&(this.renderer.staff.setSharedLayoutData(Mc.TopOffsetSharedDataKey,a),o=a);const h=this.renderer.staff.getSharedLayoutData(Mc.BottomOffsetSharedDataKey,-1);let l=h;r>h&&(this.renderer.staff.setSharedLayoutData(Mc.BottomOffsetSharedDataKey,r),l=h),this.height=a+r,this.renderer.registerOverflowTop(o+l)}getOffset(e){if(0===e)return 0;let t=this.renderer.smuflMetrics.tabWhammyPerHalfHeight+Math.log2(Math.abs(e)/2)*this.renderer.smuflMetrics.tabWhammyPerHalfHeight;return e<0&&(t=-t),t}paint(t,s,i){const a=ao.beat(i,Se.StandardNotationEffects,this._beat);try{const a=this.renderer;let r=this._beat.nextBeat,n=null,o=Xn.PreNotes;r&&(n=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staffId,r.voice.bar),n&&n.staff===a.staff&&(n===a||r.hasWhammyBar)?o=!r.hasWhammyBar||a.settings.notation.notationMode===e.NotationMode.SongBook&&r.whammyBarType===ue.Dip?Xn.PreNotes:Xn.MiddleNotes:(r=null,n=null));let h=0,l=0;this._isSimpleDip?(h=t+a.x+a.getBeatX(this._beat,Xn.OnNotes),l=t+a.x+a.getBeatX(this._beat,Xn.PostNotes)):(h=t+a.x+a.getBeatX(this._beat,Xn.MiddleNotes),l=n?t+n.x+n.getBeatX(r,o):t+a.x+a.postBeatGlyphsStart);const c=i.textAlign,d=i.textBaseline;if(i.textAlign=we.Center,i.textBaseline=Be.Alphabetic,this._renderPoints.length>=2){const e=(l-h)/j.MaxPosition;i.beginPath();const t=s+this.renderer.staff.getSharedLayoutData(Mc.TopOffsetSharedDataKey,0);let a=this._beat.whammyStyle===b.Gradual?"grad.":"";for(let s=0,r=this._renderPoints.length-1;s<r;s++){const r=this._renderPoints[s],n=this._renderPoints[s+1];let o=0===s;0!==s||0===r.value||this._beat.isContinuedWhammy||(this.paintWhammy(!1,new j(0,0),r,h,t,e,i),o=!1),this.paintWhammy(o,r,n,h,t,e,i,a),a=""}i.stroke()}i.textAlign=c,i.textBaseline=d}finally{a?.[Symbol.dispose]?.()}}paintWhammy(t,s,i,a,r,n,o,h){const l=a+n*s.offset,c=a+n*i.offset,d=r-this.getOffset(s.value),u=r-this.getOffset(i.value);if(s.offset===i.offset){const e=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(u-d)/(2*e)<1)o.moveTo(l,d),o.lineTo(c,u);else{const t=Math.max(d,u);let s=Math.min(d,u);for(;t>s;)o.moveTo(l,s),o.lineTo(l,s+e),s+=2*e}o.stroke()}else if(s.value===i.value){const e=this.renderer.smuflMetrics.tabWhammyDashSize;if(Math.abs(c-l)/(2*e)<1)o.moveTo(l,d),o.lineTo(c,u);else{let t=Math.max(l,c);const s=Math.min(l,c);for(;t>s;)o.moveTo(t,d),o.lineTo(t-e,d),t-=2*e}o.stroke()}else o.moveTo(l,d),o.lineTo(c,u);const p=this.renderer.smuflMetrics.tabWhammyTextPadding;!t||this._beat.isContinuedWhammy||this._isSimpleDip||(this.renderer.settings.notation.isNotationElementVisible(e.NotationElement.ZerosOnDiveWhammys)&&o.fillText("0",l,d-p),h&&o.fillText(h,l,d-p));let m=Math.abs(i.value);if((0!==m||this.renderer.settings.notation.isNotationElementVisible(e.NotationElement.ZerosOnDiveWhammys)&&!this._isSimpleDip)&&s.value!==i.value){let e="";if(i.value<0&&(e+="-"),m>=4){const t=m/4|0;e+=t,m-=4*t}else 0===m&&(e+="0");m>0&&(e+=Tc.getFractionSign(m));let t=0;t=this._isSimpleDip||s.offset===i.offset?Math.min(d,u):u;const a=c;o.fillText(e,a,t-p)}}}Mc.TopOffsetSharedDataKey="tab.whammy.topoffset",Mc.BottomOffsetSharedDataKey="tab.whammy.bottomffset";class Fc extends Lo{constructor(){super(...arguments),this.slash=null,this.noteNumbers=null,this.restGlyph=null}get effectElement(){return Se.GuitarTabEffects}getNoteX(e,t){return this.noteNumbers?this.noteNumbers.getNoteX(e,t):0}getNoteY(e,t){return this.noteNumbers?this.noteNumbers.getNoteY(e,t):0}getLowestNoteY(){return this.noteNumbers?this.noteNumbers.getLowestNoteY():0}getHighestNoteY(){return this.noteNumbers?this.noteNumbers.getHighestNoteY():0}buildBoundingsLookup(e,t,s){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(e,t+this.x,s+this.y)}doLayout(){const t=this.renderer,s=[];if(this.container.beat.isRest){const e=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),s=t.getTabY(e),i=new Ec(0,s,t.showRests,this.container.beat.duration);if(this.restGlyph=i,i.beat=this.container.beat,i.beamingHelper=this.beamingHelper,this.addNormal(i),this.container.beat.dots>0&&t.showRests)for(let e=0;e<this.container.beat.dots;e++)this.addEffect(new Pl(0,s))}else{const i=this.renderer.settings.notation.smallGraceTabNotes&&this.container.beat.graceType!==T.None;let a;if(this.container.beat.slashed&&!this.container.beat.notes.some(e=>e.isTieDestination)){const e=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),s=t.getLineY(e),r=new ic(0,s,this.container.beat.duration,i,this.container.beat);r.noteHeadElement=de.GuitarTabFretNumber,r.effectElement=Se.GuitarTabEffects,this.slash=r,r.beat=this.container.beat,r.beamingHelper=this.beamingHelper,this.addNormal(r),a=r.beatEffects}else{const e=new vc(0,0,i);this.noteNumbers=e,e.beat=this.container.beat,e.beamingHelper=this.beamingHelper;for(const e of this.container.beat.notes)e.isVisible&&this.createNoteGlyph(e);this.addNormal(e),a=e.beatEffects}if(this.container.beat.hasWhammyBar){const e=new Mc(this.container.beat);e.renderer=this.renderer,e.doLayout(),this.container.ties.push(e)}if(this.container.beat.isTremolo&&!a.has("tremolo")){const e=this.container.beat.tremoloSpeed,t=new Yl(0,0,e);t.offsetY=this.renderer.smuflMetrics.glyphTop.get(t.symbol),a.set("tremolo",t),s.push(t)}if(this.container.beat.dots>0&&t.rhythmMode!==e.TabRhythmMode.Hidden)for(let e=0;e<this.container.beat.dots;e++)this.addEffect(new Pl(0,t.lineOffset*t.bar.staff.tuning.length+t.settings.notation.rhythmHeight))}if(this.isEmpty)return;let i=0;for(let e=0,t=this.glyphs.length;e<t;e++){const t=this.glyphs[e];t.x=i,t.renderer=this.renderer,t.doLayout(),i+=t.width}this.width=i,this.computedWidth=i,this.container.beat.isEmpty?this.centerX=this.width/2:this.restGlyph?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.noteNumbers?this.centerX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2:this.slash&&(this.centerX=this.slash.x+this.slash.width/2);for(const e of s)e.x=this.centerX}updateBeamingHelper(){this.noteNumbers?this.noteNumbers.updateBeamingHelper(this.container.x+this.x):this.restGlyph?this.restGlyph.updateBeamingHelper(this.container.x+this.x):this.slash&&this.slash.updateBeamingHelper(this.container.x+this.x)}createNoteGlyph(e){const t=this.renderer,s=new Pc(0,0,e),i=e.beat.voice.bar.staff.tuning.length-e.string;s.y=t.getTabY(i),s.renderer=this.renderer,s.doLayout(),this.noteNumbers.addNoteGlyph(s,e);const a=s.y-s.height/2,r=a+s.height;this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,a,r)}}class Cc extends un{constructor(e){super(0,0),this._beat=e}doLayout(){if(this.width=this.renderer.smuflMetrics.glyphWidths.get(ne.ArrowheadBlackDown),this._beat.brushType===w.ArpeggioUp){const e=new Rh(0,0,M.Slight,!0);e.renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e}else if(this._beat.brushType===w.ArpeggioDown){const e=new Rh(0,0,M.Slight,!0);e.renderer=this.renderer,e.doLayout(),this._noteVibratoGlyph=e}}paint(e,t,s){const i=this.renderer,a=t+this.x+i.getNoteY(this._beat.maxStringNote,Jn.Top),r=t+this.y+i.getNoteY(this._beat.minStringNote,Jn.Bottom),n=e+this.x+this.width/2,o=this.renderer.smuflMetrics.glyphWidths.get(ne.ArrowheadBlackDown);if(this._beat.brushType!==w.None){if(this._beat.brushType===w.BrushUp||this._beat.brushType===w.BrushDown)s.beginPath(),s.moveTo(n,a),s.lineTo(n,r),s.stroke();else if(this._beat.brushType===w.ArpeggioUp){const t=this._noteVibratoGlyph,i=a,n=r-o;t.width=Math.abs(n-i),s.beginRotate(e+this.x,n,-90),t.paint(0,(this.width-t.height)/2,s),s.endRotate()}else if(this._beat.brushType===w.ArpeggioDown){const t=this._noteVibratoGlyph,i=a+o,n=r;t.width=Math.abs(n-i),s.beginRotate(e+this.x,i,90),t.paint(0,-(this.width-t.height/2),s),s.endRotate()}this._beat.brushType===w.BrushUp||this._beat.brushType===w.ArpeggioUp?(s.beginPath(),s.moveTo(n,r),s.lineTo(n+o/2,r-o),s.lineTo(n-o/2,r-o),s.closePath(),s.fill()):(s.beginPath(),s.moveTo(n,a),s.lineTo(n+o/2,a+o),s.lineTo(n-o/2,a+o),s.closePath(),s.fill())}}}class Dc extends Do{doLayout(){this.container.beat.brushType===w.None||this.container.beat.isRest||(this.addEffect(new Cc(this.container.beat)),this.addNormal(new rl(0,0,this.renderer.smuflMetrics.preNoteEffectPadding))),super.doLayout()}get effectElement(){return Se.GuitarTabEffects}}class Lc extends mn{constructor(e,t){super(e,t,1,ne.SixStringTabClef)}doLayout(){this.symbol=this.renderer.bar.staff.tuning.length<=4?ne.FourStringTabClef:ne.SixStringTabClef,this.center=!0,super.doLayout(),this.width=this.renderer.smuflMetrics.glyphWidths.get(ne.GClef),this.offsetX=this.width/2}}class Ic extends Dl{doLayout(){this.barSubElement=m.GuitarTabsTimeSignature,super.doLayout()}get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?fn.GraceScale:1}}class Ac extends yl{get showMultiBarRest(){return this._showMultiBarRest}get repeatsBarSubElement(){return m.GuitarTabsRepeats}get barNumberBarSubElement(){return m.GuitarTabsBarNumber}get barLineBarSubElement(){return m.GuitarTabsBarLines}get staffLineBarSubElement(){return m.GuitarTabsStaffLine}constructor(e,t){super(e,t),this._hasTuplets=!1,this.showTimeSignature=!1,this.showRests=!1,this.showTiedNotes=!1,this._showMultiBarRest=!1,t.staff.showStandardNotation||(this.showTimeSignature=!0,this.showRests=!0,this.showTiedNotes=!0,this._showMultiBarRest=!0)}get lineSpacing(){return this.smuflMetrics.tabLineSpacing}get heightLineCount(){return this.bar.staff.tuning.length}get drawnLineCount(){return this.bar.staff.tuning.length}get rhythmMode(){let t=this.settings.notation.rhythmMode;return t===e.TabRhythmMode.Automatic&&(t=this.bar.staff.showStandardNotation?e.TabRhythmMode.Hidden:e.TabRhythmMode.ShowWithBars),t}getTabY(e){return super.getLineY(e)}getTabHeight(e){return super.getLineHeight(e)}collectSpaces(e){const t=this.smuflMetrics.staffLineThickness;for(const s of this.bar.voices)if(this.hasVoiceContainer(s)){const i=this.getVoiceContainer(s);for(const s of i.beatGlyphs){const a=s.onNotes,r=a.noteNumbers;if(r)for(const[n,o]of r.notesPerString)o.isEmpty||e[this.bar.staff.tuning.length-n].push(new Float32Array([i.x+s.x+a.x+r.x-t,r.width+2*t]))}}}adjustSizes(){if(this.rhythmMode!==e.TabRhythmMode.Hidden){let e=k.Whole;for(const t of this.helpers.beamHelpers)for(const s of t)s.tremoloDuration&&(!e||e<s.tremoloDuration)&&(e=s.tremoloDuration);switch(e){case k.Eighth:this.height+=this.smuflMetrics.glyphHeights.get(ne.Tremolo1);break;case k.Sixteenth:this.height+=this.smuflMetrics.glyphHeights.get(ne.Tremolo2);break;case k.ThirtySecond:this.height+=this.smuflMetrics.glyphHeights.get(ne.Tremolo3)}this.height+=this.settings.notation.rhythmHeight,this.bottomPadding+=this.settings.notation.rhythmHeight}}doLayout(){if(super.doLayout(),this.rhythmMode!==e.TabRhythmMode.Hidden){this._hasTuplets=!1;for(const e of this.bar.voices)if(this.hasVoiceContainer(e)){if(this.getVoiceContainer(e).tupletGroups.length>0){this._hasTuplets=!0;break}}this._hasTuplets&&this.registerOverflowBottom(this.tupletSize)}}createLinePreBeatGlyphs(){if(this.isFirstOfLine){const e=(this.bar.staff.tuning.length-1)/2;this.createStartSpacing(),this.addPreBeatGlyph(new Lc(0,this.getTabY(e)))}this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator||this.bar.previousBar&&this.bar.masterBar.isFreeTime&&this.bar.masterBar.isFreeTime!==this.bar.previousBar.masterBar.isFreeTime)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs())}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new rl(0,0,this.smuflMetrics.oneStaffSpace));const e=(this.bar.staff.tuning.length+1)/2-1;this.addPreBeatGlyph(new Ic(0,this.getTabY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon,this.bar.masterBar.isFreeTime))}createVoiceGlyphs(e){if(this.additionalMultiRestBars){const t=new Ro(this.getVoiceContainer(e));this.addBeatGlyph(t)}else for(const t of e.beats){const s=new Nc(t,this.getVoiceContainer(e));s.preNotes=new Dc,s.onNotes=new Fc,this.addBeatGlyph(s)}}paint(t,s,i){super.paint(t,s,i),this.rhythmMode!==e.TabRhythmMode.Hidden&&(this.paintBeams(t,s,i,Se.GuitarTabFlags,Se.GuitarTabBeams),this.paintTuplets(t,s,i,Se.GuitarTabTuplet))}drawBeamHelperAsFlags(t){return super.drawBeamHelperAsFlags(t)||this.rhythmMode===e.TabRhythmMode.ShowWithBeams}getFlagTopY(e,t){const s=this.getOnNotesGlyphForBeat(e);return s.noteNumbers&&e.duration!==k.Half?s.noteNumbers.getNoteY(s.noteNumbers.minStringNote,Jn.Bottom)+this.smuflMetrics.staffLineThickness:this.height-this.settings.notation.rhythmHeight-this.tupletSize}getFlagBottomY(e,t){return this.getFlagAndBarPos()}getFlagStemSize(e,t=!1){return 0}getBarLineStart(e,t){return this.getFlagTopY(e,t)}getBeamDirection(e){return Pe.Down}getFlagAndBarPos(){return this.height-(this._hasTuplets?this.tupletSize/2:0)}calculateBeamYWithDirection(e,t,s){return this.getFlagAndBarPos()}shouldPaintFlag(e,t){return!!super.shouldPaintFlag(e,t)&&(e.graceType===T.None&&this.drawBeamHelperAsFlags(t))}paintBeamingStem(e,t,s,i,a,r){if(a<i){const e=a;a=i,i=e}const n=ao.beat(r,Se.GuitarTabStem,e);try{let n=[];this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(e.displayStart)&&(n=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(e.displayStart).slots.slice(),n.sort((e,t)=>e.topY-t.topY));let o=a;for(;o>i;){let e=i;if(!(n.length>0&&n[n.length-1].bottomY>e)){r.fillRect(s,e,this.smuflMetrics.stemThickness,o-e);break}{const i=n.pop();e=t+i.bottomY,r.fillRect(s,e,this.smuflMetrics.stemThickness,o-e),o=t+i.topY}}}finally{n?.[Symbol.dispose]?.()}}}Ac.StaffId="tab";class Rc extends to{get staffId(){return Ac.StaffId}getStaffPaddingTop(e){return e.system.layout.renderer.settings.display.notationStaffPaddingTop}getStaffPaddingBottom(e){return e.system.layout.renderer.settings.display.notationStaffPaddingBottom}constructor(){super(),this.showTimeSignature=null,this.showRests=null,this.showTiedNotes=null,this.hideOnPercussionTrack=!0}canCreate(e,t){return t.showTablature&&t.tuning.length>0&&super.canCreate(e,t)}create(e,t){const s=new Ac(e,t);return null!==this.showRests&&(s.showRests=this.showRests),null!==this.showTimeSignature&&(s.showTimeSignature=this.showTimeSignature),null!==this.showTiedNotes&&(s.showTiedNotes=this.showTiedNotes),s}}class Oc{constructor(e,t){this.vertical=e,this.createLayout=t}}class Wc{constructor(e,t){this.supportsWorkers=e,this.createCanvas=t}}class Hc{static get globalThis(){if(void 0===Hc._globalThis){try{Hc._globalThis=globalThis}catch{}void 0===Hc._globalThis&&(Hc._globalThis=self),void 0===Hc._globalThis&&(Hc._globalThis=global),void 0===Hc._globalThis&&(Hc._globalThis=window),void 0===Hc._globalThis&&(Hc._globalThis=Function("return this")())}return Hc._globalThis}static get isRunningInWorker(){return"WorkerGlobalScope"in Hc.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in Hc.globalThis}static throttle(e,t){let s=0;return()=>{Hc.globalThis.clearTimeout(s),s=Hc.globalThis.setTimeout(e,t)}}static detectScriptFile(){if(!Hc.isRunningInWorker&&Hc.globalThis.ALPHATAB_ROOT){let e=Hc.globalThis.ALPHATAB_ROOT;return e=Hc.ensureFullUrl(e),e=Hc.appendScriptName(e),e}try{const e={};if(e&&-1===e.indexOf("file://"))return e}catch{}return"document"in Hc.globalThis&&document.currentScript&&document.currentScript instanceof HTMLScriptElement?document.currentScript.src:null}static ensureFullUrl(e){if(!e)return"";if(!e.startsWith("http")&&!e.startsWith("https")&&!e.startsWith("file")){let t="";const s=Hc.globalThis.location;if(t+=s.protocol?.toString(),t+="//"?.toString(),s.hostname&&(t+=s.hostname?.toString()),s.port&&(t+=":"?.toString(),t+=s.port?.toString()),!e.startsWith("/")){const e=s.pathname.split("/").slice(0,-1).join("/");e.length>0&&(e.startsWith("/")||(t+="/"?.toString()),t+=e?.toString())}return e.startsWith("/")||(t+="/"?.toString()),t+=e?.toString(),t}return e}static appendScriptName(e){return e&&!e.endsWith(".js")&&(e.endsWith("/")||(e+="/"),e+="alphaTab.js"),e}static detectFontDirectory(){if(!Hc.isRunningInWorker&&Hc.globalThis.ALPHATAB_FONT)return Hc.ensureFullUrl(Hc.globalThis.ALPHATAB_FONT);const e=Hc.scriptFile;if(e){const t=e.lastIndexOf(String.fromCharCode(47));if(t>=0)return`${e.substr(0,t)}/font/`}return null}static registerJQueryPlugin(){if(!Hc.isRunningInWorker&&Hc.globalThis&&"jQuery"in Hc.globalThis){const e=Hc.globalThis.jQuery,t=new zn;e.fn.alphaTab=function(e){const s=Array.prototype.slice.call(arguments,1);return 1===this.length?t.exec(this[0],e,s):this.each((i,a)=>{t.exec(a,e,s)})},e.alphaTab={restore:zn.restore},e.fn.alphaTab.fn=t}}static getRenderEngineFactory(e){return e&&Hc.renderEngines.has(e)?Hc.renderEngines.get(e):Hc.renderEngines.get("default")}static getLayoutEngineFactory(t){return t&&Hc.layoutEngines.has(t)?Hc.layoutEngines.get(t):Hc.layoutEngines.get(e.LayoutMode.Page)}static buildImporters(){return[new ws,new Hs,new Is,new Ys,new Ss,new ft]}static createDefaultRenderEngines(){const e=new Map;return e.set("svg",new Wc(!0,()=>new eo)),e.set("default",e.get("svg")),e.set("skia",new Wc(!1,()=>new Qn)),Hc.createPlatformSpecificRenderEngines(e),e}static enableAlphaSkia(e,t){Qn.enable(e,t)}static registerAlphaSkiaCustomFont(e){return Qn.registerFont(e)}static createPlatformSpecificRenderEngines(e){e.set("html5",new Wc(!1,()=>new qr))}static createDefaultRenderers(){return[new zo(Hc.StaffIdBeforeSlashAlways,[new Xh,new jh,new Nh,new nh,new Jo,new fh,new Yh,new Qo,new eh]),new Bc,new zo(Hc.StaffIdBeforeScoreAlways,[new uh,new jo,new vh,new Ih,new Qh]),new zo(Hc.StaffIdBeforeScoreHideable,[new Zh,new $h,new Mh(!0),new el,new Wh,new tl,new Hh(!1),new kh,new bh(pe.Finger)],(e,t)=>t.showStandardNotation),new gc,new zo(Hc.StaffIdBeforeNumberedAlways,[new sh,new Mh(!1),new hh,new bh(pe.Thumb,(e,t)=>t.voice.bar.staff.showStandardNotation),new Vh]),new Rl,new zo(Hc.StaffIdBeforeTabAlways,[new xh]),new zo(Hc.StaffIdBeforeTabHideable,[new $h,new el,new Wh,new tl,new Hh(!0),new Uh,new ch,new wh(N.Natural),new wh(N.Artificial),new wh(N.Pinch),new wh(N.Tap),new wh(N.Semi),new wh(N.Feedback),new Th,new Zo,new gh,new Fh,new Lh,new Ch,new kh,new bh(pe.Finger,(e,t)=>!t.voice.bar.staff.showStandardNotation)],(e,t)=>t.showTablature),new Rc,new zo(Hc.StaffIdBeforeEndAlways,[new bh(pe.Thumb,(e,t)=>!t.voice.bar.staff.showStandardNotation)])]}static createDefaultStaveProfiles(){const t=new Map,s=Hc.createDefaultRenderers();t.set(e.StaveProfile.Default,s),t.set(e.StaveProfile.ScoreTab,s);const i=new Set([Hc.StaffIdBeforeSlashAlways,Hc.StaffIdBeforeScoreAlways,Hc.StaffIdBeforeNumberedAlways,Hc.StaffIdBeforeTabAlways,mc.StaffId,Hc.StaffIdBeforeEndAlways]);t.set(e.StaveProfile.Score,s.filter(e=>i.has(e.staffId)));const a=new Set([Hc.StaffIdBeforeSlashAlways,Hc.StaffIdBeforeScoreAlways,Hc.StaffIdBeforeNumberedAlways,Hc.StaffIdBeforeTabAlways,Ac.StaffId,Hc.StaffIdBeforeEndAlways]);return t.set(e.StaveProfile.Tab,Hc.createDefaultRenderers().filter(e=>{if(e instanceof Rc){const t=e;t.showTimeSignature=!0,t.showRests=!0,t.showTiedNotes=!0}return a.has(e.staffId)})),t.set(e.StaveProfile.TabMixed,Hc.createDefaultRenderers().filter(e=>{if(e instanceof Rc){const t=e;t.showTimeSignature=!1,t.showRests=!1,t.showTiedNotes=!1}return a.has(e.staffId)})),t}static createDefaultLayoutEngines(){const t=new Map;return t.set(e.LayoutMode.Page,new Oc(!0,e=>new al(e))),t.set(e.LayoutMode.Horizontal,new Oc(!1,e=>new il(e))),t}static initializeMain(t,s){Hc.isRunningInWorker||Hc.isRunningInAudioWorklet||(Hc.webPlatform!==e.WebPlatform.Browser&&Hc.webPlatform!==e.WebPlatform.BrowserModule||(Hc.registerJQueryPlugin(),Hc.HighDpiFactor=window.devicePixelRatio),Hc.createWebWorker=t,Hc.createAudioWorklet=s)}static get alphaTabWorker(){return Hc.globalThis.Worker}static get alphaTabUrl(){return Hc.globalThis.URL}static initializeWorker(){if(!Hc.isRunningInWorker)throw new O(e.AlphaTabErrorType.General,"Not running in worker, cannot run worker initialization");$r.init(),Rr.init(),Hc.createWebWorker=t=>{throw new O(e.AlphaTabErrorType.General,"Nested workers are not supported")}}static initializeAudioWorklet(){if(!Hc.isRunningInAudioWorklet)throw new O(e.AlphaTabErrorType.General,"Not running in audio worklet, cannot run worklet initialization");ei.init()}static detectWebPack(){try{if("function"==typeof __webpack_require__)return!0}catch{}return!1}static detectVite(){try{if("string"==typeof __BASE__)return!0}catch{}return!1}static detectWebPlatform(){if(!(void 0!==Hc.globalThis.Window&&Hc.globalThis instanceof Hc.globalThis.Window))try{if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return e.WebPlatform.NodeJs}catch{}try{const t={};if(t&&"string"==typeof t&&!t.startsWith("file://"))return e.WebPlatform.BrowserModule}catch{}return e.WebPlatform.Browser}static printEnvironmentInfo(e=!0){const t=e?e=>{ee.log.debug("VersionInfo",e)}:e=>{ee.debug("VersionInfo",e)};W.print(t),t(`High DPI: ${Hc.HighDpiFactor}`),Hc.printPlatformInfo(t)}static printPlatformInfo(t){t(`Platform: ${e.WebPlatform[Hc.webPlatform]}`),t(`WebPack: ${Hc.isWebPackBundled}`),t(`Vite: ${Hc.isViteBundled}`),Hc.webPlatform!==e.WebPlatform.NodeJs&&(t(`Browser: ${navigator.userAgent}`),t(`Window Size: ${window.outerWidth}x${window.outerHeight}`),t(`Screen Size: ${window.screen.width}x${window.screen.height}`))}static prepareForPostMessage(e){if(!e)return e;if("object"==typeof e){const t=e.__v_raw;if(t)return Hc.prepareForPostMessage(t)}return e}static quoteJsonString(e){return JSON.stringify(e)}}var Gc;Hc.StaffIdBeforeSlashAlways="before-slash-always",Hc.StaffIdBeforeScoreAlways="before-score-always",Hc.StaffIdBeforeScoreHideable="before-score-hideable",Hc.StaffIdBeforeNumberedAlways="before-numbered-always",Hc.StaffIdBeforeTabAlways="before-tab-always",Hc.StaffIdBeforeTabHideable="before-tab-hideable",Hc.StaffIdBeforeEndAlways="before-end-always",Hc.HighDpiFactor=1,Hc._globalThis=void 0,Hc.webPlatform=Hc.detectWebPlatform(),Hc.isWebPackBundled=Hc.detectWebPack(),Hc.isViteBundled=Hc.detectVite(),Hc.scriptFile=Hc.detectScriptFile(),Hc.fontDirectory=Hc.detectFontDirectory(),Hc.renderEngines=Hc.createDefaultRenderEngines(),Hc.layoutEngines=Hc.createDefaultLayoutEngines(),Hc.staveProfiles=Hc.createDefaultStaveProfiles(),e.FontFileFormat=void 0,(Gc=e.FontFileFormat||(e.FontFileFormat={}))[Gc.EmbeddedOpenType=0]="EmbeddedOpenType",Gc[Gc.Woff=1]="Woff",Gc[Gc.Woff2=2]="Woff2",Gc[Gc.OpenType=3]="OpenType",Gc[Gc.TrueType=4]="TrueType",Gc[Gc.Svg=5]="Svg";class Vc{static buildDefaultSmuflFontSources(t){const s=new Map,i=t??"";return s.set(e.FontFileFormat.Woff2,`${i}Bravura.woff2`),s.set(e.FontFileFormat.Woff,`${i}Bravura.woff`),s.set(e.FontFileFormat.OpenType,`${i}Bravura.otf`),s}constructor(){this.scriptFile=null,this.fontDirectory=null,this.smuflFontSources=null,this.file=null,this.tex=!1,this.tracks=null,this.enableLazyLoading=!0,this.engine="default",this.logLevel=e.LogLevel.Info,this.useWorkers=!0,this.includeNoteBounds=!1,this.scriptFile=Hc.scriptFile,this.fontDirectory=Hc.fontDirectory}}const Uc=Object.freeze(Object.defineProperty({__proto__:null,AlphaTexImporter:ft,ScoreImporter:Qe,ScoreLoader:Mn,UnsupportedFormatError:Ze},Symbol.toStringTag,{value:"Module"})),zc=Object.freeze(Object.defineProperty({__proto__:null,ByteBuffer:ut,IOHelper:dt},Symbol.toStringTag,{value:"Module"}));class Xc{init(e,t){this.data=e,this.settings=t}export(e,t=null){const s=ut.withCapacity(1024);return this.init(s,t??new hr),this.writeScore(e),s.toArray()}}class Yc{constructor(){this.start="",this.end="",this.comment="",this.hasContent=!1}}class Jc{constructor(){this.tex="",this.isStartOfLine=!0,this.indentString="",this.currentIndent=0,this.comments=!1,this._groups=[],this._singleLineComment=""}beginGroup(e,t,s=""){const i=new Yc;i.start=e,i.end=t,i.comment=s,this._groups.push(i)}writeSingleLineComment(e,t=!1){this.comments&&e&&(t?this._singleLineComment=`// ${e}`:this.writeLine(`// ${e}`))}dropSingleLineComment(){this._singleLineComment=""}writeInlineComment(e){this.comments&&e&&this.write(`/* ${e} */`)}endGroup(){const e=this._groups.pop();e.hasContent&&this.write(e.end)}indent(){this.indentString.length>0&&this.currentIndent++}outdent(){this.indentString.length>0&&this.currentIndent--}preWrite(){if(this._singleLineComment){const e=this._singleLineComment;this._singleLineComment="",this.writeLine(e)}if(this.isStartOfLine&&this.indentString.length>0)for(let e=0;e<this.currentIndent;e++)this.tex+=this.indentString;if(this.isStartOfLine=!1,this._singleLineComment&&(this.tex+=this._singleLineComment),this._groups.length>0){const e=this._groups[this._groups.length-1];e.hasContent||(e.hasContent=!0,this.tex+=e.start,this.comments&&this.writeInlineComment(e.comment))}}write(e){this.preWrite(),this.tex+=e,this.isStartOfLine=!1}writeGroupItem(t){if(0===this._groups.length)throw new O(e.AlphaTabErrorType.General,"Wrong usage of writeGroupItem, this is an internal error.");const s=this._groups[this._groups.length-1].hasContent;this.preWrite(),s&&(this.tex+=" "),this.tex+=t,this.isStartOfLine=!1}writeString(e){this.preWrite(),this.tex+=Hc.quoteJsonString(e),this.tex+=" "}writeStringMeta(e,t,s=!1){(0!==t.length||s)&&(this.preWrite(),this.tex+=`\\${e} `,this.tex+=Hc.quoteJsonString(t),this.writeLine())}writeMeta(e,t){this.preWrite(),this.tex+=`\\${e} `,t&&(this.tex+=t),this.writeLine()}writeLine(e){this.preWrite(),void 0!==e&&(this.tex+=e),this.indentString.length>0?this.tex+="\n":this.tex.endsWith(" ")||(this.tex+=" "),this.isStartOfLine=!0}}class $c extends Xc{get name(){return"alphaTex"}exportToString(e,t=null){return this.settings=t??new hr,this.scoreToAlphaTexString(e)}writeScore(e){const t=dt.stringToBytes(this.scoreToAlphaTexString(e));this.data.write(t,0,t.length)}scoreToAlphaTexString(e){const t=new Jc;return t.comments=this.settings.exporter.comments,t.indentString=this.settings.exporter.indent>0?" ".repeat(this.settings.exporter.indent):"",this.writeScoreTo(t,e),t.tex}writeScoreTo(e,t){e.writeSingleLineComment("Score Metadata"),e.writeStringMeta("album",t.album),e.writeStringMeta("artist",t.artist),e.writeStringMeta("copyright",t.copyright),e.writeStringMeta("instructions",t.instructions),e.writeStringMeta("music",t.music),e.writeStringMeta("notices",t.notices),e.writeStringMeta("subtitle",t.subTitle),e.writeStringMeta("title",t.title),e.writeStringMeta("words",t.words),e.writeStringMeta("tab",t.tab),e.write(`\\tempo ${t.tempo} `),t.tempoLabel&&e.writeString(t.tempoLabel),e.writeLine(),t.defaultSystemsLayout!==$c.DefaultScore.defaultSystemsLayout&&e.writeMeta("defaultSystemsLayout",`${t.defaultSystemsLayout}`),t.systemsLayout.length>0&&e.writeMeta("systemsLayout",t.systemsLayout.join(" ")),this.writeStyleSheetTo(e,t.stylesheet),e.writeLine(".");for(const s of t.tracks)e.writeLine(),this.writeTrackTo(e,s);const s=t.exportFlatSyncPoints();if(s.length>0){e.writeLine(".");for(const t of s)t.barPosition>0?e.writeMeta("sync",`${t.barIndex} ${t.barOccurence} ${t.millisecondOffset}`):e.writeMeta("sync",`${t.barIndex} ${t.barOccurence} ${t.millisecondOffset} ${t.barPosition}`)}}writeStyleSheetTo(e,t){e.writeSingleLineComment("Score Stylesheet"),t.hideDynamics&&e.writeMeta("hideDynamics"),t.bracketExtendMode!==$c.DefaultScore.stylesheet.bracketExtendMode&&e.writeMeta("bracketExtendMode",a[t.bracketExtendMode]),t.useSystemSignSeparator&&e.writeMeta("useSystemSignSeparator"),t.multiTrackMultiBarRest&&e.writeMeta("multiBarRest"),t.singleTrackTrackNamePolicy!==$c.DefaultScore.stylesheet.singleTrackTrackNamePolicy&&e.writeMeta("singleTrackTrackNamePolicy",r[t.singleTrackTrackNamePolicy]),t.multiTrackTrackNamePolicy!==$c.DefaultScore.stylesheet.multiTrackTrackNamePolicy&&e.writeMeta("multiTrackTrackNamePolicy",r[t.multiTrackTrackNamePolicy]),t.firstSystemTrackNameMode!==$c.DefaultScore.stylesheet.firstSystemTrackNameMode&&e.writeMeta("firstSystemTrackNameMode",n[t.firstSystemTrackNameMode]),t.otherSystemsTrackNameMode!==$c.DefaultScore.stylesheet.otherSystemsTrackNameMode&&e.writeMeta("otherSystemsTrackNameMode",n[t.otherSystemsTrackNameMode]),t.firstSystemTrackNameOrientation!==$c.DefaultScore.stylesheet.firstSystemTrackNameOrientation&&e.writeMeta("firstSystemTrackNameOrientation",o[t.firstSystemTrackNameOrientation]),t.otherSystemsTrackNameOrientation!==$c.DefaultScore.stylesheet.otherSystemsTrackNameOrientation&&e.writeMeta("otherSystemsTrackNameOrientation",o[t.otherSystemsTrackNameOrientation])}writeTrackTo(e,t){e.write("\\track "),e.writeString(t.name),t.shortName.length>0&&e.writeString(t.shortName),e.writeLine(" {"),e.indent(),e.writeSingleLineComment("Track Properties"),t.color.rgba!==$c.DefaultTrack.color.rgba&&(e.write(" color "),e.writeString(t.color.rgba),e.writeLine()),t.defaultSystemsLayout!==$c.DefaultTrack.defaultSystemsLayout&&(e.write(` defaultSystemsLayout ${t.defaultSystemsLayout}`),e.writeLine()),t.systemsLayout.length>0&&(e.write(` systemsLayout ${t.systemsLayout.join(" ")}`),e.writeLine()),e.writeLine(` volume ${t.playbackInfo.volume}`),e.writeLine(` balance ${t.playbackInfo.balance}`),t.playbackInfo.isMute&&e.writeLine(" mute"),t.playbackInfo.isSolo&&e.writeLine(" solo"),t.score.stylesheet.perTrackMultiBarRest&&t.score.stylesheet.perTrackMultiBarRest.has(t.index)&&e.writeLine(" multibarrest"),e.writeLine(` instrument ${t.isPercussion?"percussion":H.getName(t.playbackInfo.program)}`),t.playbackInfo.bank>0&&e.writeLine(` bank ${t.playbackInfo.bank}`),e.outdent(),e.writeLine("}"),e.indent();for(const s of t.staves)this.writeStaffTo(e,s);e.outdent()}writeStaffTo(e,t){e.write("\\staff "),e.beginGroup("{","}","Staff Properties"),t.showStandardNotation&&(t.standardNotationLineCount!==ot.DefaultStandardNotationLineCount?e.writeGroupItem(`score ${t.standardNotationLineCount}`):e.writeGroupItem("score")),t.showTablature&&e.writeGroupItem("tabs"),t.showSlash&&e.writeGroupItem("slash"),t.showNumbered&&e.writeGroupItem("numbered"),e.endGroup(),e.writeLine(),e.indent();const s=Math.max(...t.filledVoices)+1;for(let i=0;i<s;i++){s>1&&(e.write("\\voice "),e.writeInlineComment(`Voice ${i+1}`),e.writeLine(),e.indent());for(const s of t.bars)this.writeBarTo(e,s,i);s>1&&e.outdent()}e.outdent()}writeBarTo(e,t,s){if(t.index>0&&e.writeLine("|"),0===s){let s=!1;if(0===t.index){const i=e.tex.length;this.writeStaffMetaTo(e,t.staff),s=e.tex.length>i}if(0===t.staff.index&&0===t.staff.track.index){const i=e.tex.length;this.writeMasterBarMetaTo(e,t.masterBar),s=e.tex.length>i}s&&e.writeLine()}e.writeSingleLineComment(`Bar ${t.index+1}`),e.indent(),this.writeBarMetaTo(e,t),t.isEmpty?e.writeSingleLineComment("empty bar"):this.writeVoiceTo(e,t.voices[s]),e.outdent()}writeStaffMetaTo(e,t){if(e.writeSingleLineComment(`Staff ${t.index+1} Metadata`),0!==t.capo&&e.writeMeta("capo",`${t.capo}`),t.isPercussion)e.writeMeta("articulation","defaults");else if(t.isStringed){e.write("\\tuning");for(const s of t.stringTuning.tunings)e.write(` ${nt.getTextForTuning(s,!0)}`);t.track.score.stylesheet.perTrackDisplayTuning&&t.track.score.stylesheet.perTrackDisplayTuning.has(t.track.index)&&e.write(" hide"),t.stringTuning.name.length>0&&(e.write(" "),e.writeString(t.stringTuning.name)),e.writeLine()}0!==t.transpositionPitch&&e.writeMeta("transpose",""+-t.transpositionPitch);const s=De.displayTranspositionPitches.has(t.track.playbackInfo.program)?De.displayTranspositionPitches.get(t.track.playbackInfo.program):0;if(t.displayTranspositionPitch!==s&&e.writeMeta("displaytranspose",""+-t.displayTranspositionPitch),e.writeMeta("accidentals","auto"),null!=t.chords)for(const[s,i]of t.chords)this.writeChordTo(e,i)}writeChordTo(e,t){if(e.write("\\chord {"),t.firstFret>0&&e.write(`firstfret ${t.firstFret} `),e.write(`showdiagram ${t.showDiagram?"true":"false"} `),e.write(`showfingering ${t.showFingering?"true":"false"} `),e.write(`showname ${t.showName?"true":"false"} `),t.barreFrets.length>0){const s=t.barreFrets.map(e=>`${e}`).join(" ");e.write(`barre ${s} `)}e.write("} "),e.writeString(t.name);for(let s=0;s<t.staff.tuning.length;s++){const i=s<t.strings.length?`${t.strings[s]} `:"x ";e.write(i)}e.writeLine()}writeMasterBarMetaTo(e,t){if(e.writeSingleLineComment(`Masterbar ${t.index+1} Metadata`,!0),0!==t.alternateEndings&&(e.write("\\ae ("),e.write(De.getAlternateEndingsList(t.alternateEndings).map(e=>e+1).join(" ")),e.writeLine(")")),t.isRepeatStart&&e.writeMeta("ro"),t.isRepeatEnd&&e.writeMeta("rc",`${t.repeatCount}`),0!==t.index&&t.timeSignatureCommon===t.previousMasterBar?.timeSignatureCommon&&t.timeSignatureNumerator===t.previousMasterBar.timeSignatureNumerator&&t.timeSignatureDenominator===t.previousMasterBar.timeSignatureDenominator||(t.timeSignatureCommon?e.writeStringMeta("ts ","common"):e.writeLine(`\\ts ${t.timeSignatureNumerator} ${t.timeSignatureDenominator}`)),(t.index>0&&t.tripletFeel!==t.previousMasterBar?.tripletFeel||0===t.index&&t.tripletFeel!==A.NoTripletFeel)&&e.writeMeta("tf",A[t.tripletFeel]),t.isFreeTime&&e.writeMeta("ft"),null!=t.section&&(e.write("\\section "),e.writeString(t.section.marker),e.writeString(t.section.text),e.writeLine()),t.isAnacrusis&&e.writeMeta("ac"),1!==t.displayScale&&e.writeMeta("scale",t.displayScale.toFixed(3)),t.displayWidth>0&&e.writeMeta("width",`${t.displayWidth}`),t.directions)for(const s of t.directions){let t=xe[s];t.startsWith("Target")?t=t.substring(6):t.startsWith("Jump")&&(t=t.substring(4)),e.writeMeta("jump",t)}for(const s of t.tempoAutomations)e.write(`\\tempo { ${s.value} `),s.text&&e.writeString(s.text),e.writeLine(`${s.ratioPosition} }`);e.dropSingleLineComment()}writeBarMetaTo(e,t){e.writeSingleLineComment(`Bar ${t.index+1} Metadata`,!0);const s=e.tex.length;if(0!==t.index&&t.clef===t.previousBar?.clef||e.writeMeta("clef",h[t.clef]),0===t.index&&t.clefOttava!==l.Regular||t.clefOttava!==t.previousBar?.clefOttava){let s=l[t.clefOttava];s.startsWith("_")&&(s=s.substring(1)),e.writeMeta("ottava",s)}(0===t.index&&t.simileMark!==c.None||t.simileMark!==t.previousBar?.simileMark)&&e.writeMeta("simile",c[t.simileMark]),1!==t.displayScale&&e.writeMeta("scale",t.displayScale.toFixed(3)),t.displayWidth>0&&e.writeMeta("width",`${t.displayWidth}`);for(const s of t.sustainPedals)switch(s.pedalType){case p.Down:e.writeMeta("spd",`${s.ratioPosition}`);break;case p.Hold:e.writeMeta("sph",`${s.ratioPosition}`);break;case p.Up:e.writeMeta("spu",`${s.ratioPosition}`)}if(t.barLineLeft!==g.Automatic&&e.writeMeta("barlineleft",g[t.barLineLeft]),t.barLineRight!==g.Automatic&&e.writeMeta("barlineright",g[t.barLineRight]),0===t.index||t.keySignature!==t.previousBar.keySignature||t.keySignatureType!==t.previousBar.keySignatureType){let s="";if(t.keySignatureType===u.Minor)switch(t.keySignature){case d.Cb:s="abminor";break;case d.Gb:s="ebminor";break;case d.Db:s="bbminor";break;case d.Ab:s="fminor";break;case d.Eb:s="cminor";break;case d.Bb:s="gminor";break;case d.F:s="dminor";break;case d.C:s="aminor";break;case d.G:s="eminor";break;case d.D:s="bminor";break;case d.A:s="f#minor";break;case d.E:s="c#minor";break;case d.B:s="g#minor";break;case d.FSharp:s="d#minor";break;case d.CSharp:s="a#minor";break;default:s=d[t.keySignature]}else switch(t.keySignature){case d.FSharp:s="f#";break;case d.CSharp:s="c#";break;default:s=d[t.keySignature]}e.writeStringMeta("ks",s)}e.tex.length>s&&e.writeLine(),e.dropSingleLineComment()}writeVoiceTo(e,t){if(t.isEmpty)e.writeSingleLineComment("empty voice");else{e.writeSingleLineComment(`Bar ${t.bar.index+1} / Voice ${t.index+1} contents`);for(const s of t.beats)this.writeBeatTo(e,s)}}writeBeatTo(e,t){if(t.isRest)e.write("r");else if(0===t.notes.length)e.write("()");else{t.notes.length>1&&e.write("(");for(const s of t.notes)s.index>0&&e.write(" "),this.writeNoteTo(e,s);t.notes.length>1&&e.write(")")}e.write(`.${t.duration}`),this.writeBeatEffectsTo(e,t),e.writeLine()}writeBeatEffectsTo(e,t){switch(e.beginGroup("{","}"),t.fade){case me.FadeIn:e.writeGroupItem("f");break;case me.FadeOut:e.writeGroupItem("fo");break;case me.VolumeSwell:e.writeGroupItem("vs")}if(t.vibrato===M.Slight?e.writeGroupItem("v"):t.vibrato===M.Wide&&e.writeGroupItem("vw"),t.slap&&e.writeGroupItem("s"),t.pop&&e.writeGroupItem("p"),t.tap&&e.writeGroupItem("tt"),t.dots>=2?e.writeGroupItem("dd"):t.dots>0&&e.writeGroupItem("d"),t.pickStroke===he.Up?e.writeGroupItem("su"):t.pickStroke===he.Down&&e.writeGroupItem("sd"),t.hasTuplet&&e.writeGroupItem(`tu ${t.tupletNumerator} ${t.tupletDenominator}`),t.hasWhammyBar){switch(e.writeGroupItem("tbe"),t.whammyBarType){case ue.Custom:e.writeGroupItem("custom");break;case ue.Dive:e.writeGroupItem("dive");break;case ue.Dip:e.writeGroupItem("dip");break;case ue.Hold:e.writeGroupItem("hold");break;case ue.Predive:e.writeGroupItem("predive");break;case ue.PrediveDive:e.writeGroupItem("predivedive")}switch(t.whammyStyle){case b.Default:break;case b.Gradual:e.writeGroupItem("gradual");break;case b.Fast:e.writeGroupItem("fast")}e.beginGroup("(",")");for(const s of t.whammyBarPoints)e.writeGroupItem(` ${s.offset} ${s.value}`);e.endGroup()}switch(t.brushType){case w.BrushUp:e.writeGroupItem(`bu ${t.brushDuration}`);break;case w.BrushDown:e.writeGroupItem(`bd ${t.brushDuration}`);break;case w.ArpeggioUp:e.writeGroupItem(`au ${t.brushDuration}`);break;case w.ArpeggioDown:e.writeGroupItem(`ad ${t.brushDuration}`)}if(null!=t.chord&&(e.writeGroupItem("ch "),e.writeString(t.chord.name)),t.ottava!==l.Regular){let s=l[t.ottava];s.startsWith("_")&&(s=s.substring(1)),e.writeGroupItem(`ot ${s}`)}if(t.hasRasgueado&&e.writeGroupItem(`rasg ${ye[t.rasgueado]}`),null!=t.text&&(e.writeGroupItem("txt "),e.writeString(t.text)),null!=t.lyrics&&t.lyrics.length>0)if(t.lyrics.length>1)for(let s=0;s<t.lyrics.length;s++)e.writeGroupItem(`lyrics ${s} `),e.writeString(t.lyrics[s]);else e.writeGroupItem("lyrics "),e.writeString(t.lyrics[0]);switch(t.graceType){case T.OnBeat:e.writeGroupItem("gr ob");break;case T.BeforeBeat:e.writeGroupItem("gr");break;case T.BendGrace:e.writeGroupItem("gr b")}switch(t.isTremolo&&e.writeGroupItem(`tp ${t.tremoloSpeed}`),t.crescendo){case B.Crescendo:e.writeGroupItem("cre");break;case B.Decrescendo:e.writeGroupItem("dec")}(0===t.voice.bar.index&&0===t.index||t.dynamics!==t.previousBeat?.dynamics)&&e.writeGroupItem(`dy ${f[t.dynamics].toLowerCase()}`);const s=t.fermata;null!=s&&e.writeGroupItem(`fermata ${Ne[s.type]} ${s.length}`),t.isLegatoOrigin&&e.writeGroupItem("legatoorigin");for(const s of t.automations)switch(s.type){case y.Tempo:e.writeGroupItem(`tempo ${s.value}`),s.text.length>0&&(e.write(" "),e.writeString(s.text));break;case y.Volume:e.writeGroupItem(`volume ${s.value}`);break;case y.Instrument:t.voice.bar.staff.isPercussion||e.writeGroupItem(`instrument ${H.getName(s.value)}`);break;case y.Balance:e.writeGroupItem(`balance ${s.value}`)}switch(t.wahPedal){case ge.Open:e.writeGroupItem("waho");break;case ge.Closed:e.writeGroupItem("wahc")}switch(t.isBarre&&e.writeGroupItem(`barre ${t.barreFret} ${fe[t.barreShape]}`),t.slashed&&e.writeGroupItem("slashed"),t.deadSlapped&&e.writeGroupItem("ds"),t.golpe){case pe.Thumb:e.writeGroupItem("glpt");break;case pe.Finger:e.writeGroupItem("glpf")}if(t.invertBeamDirection?e.writeGroupItem("beam invert"):null!==t.preferredBeamDirection&&e.writeGroupItem(`beam ${Pe[t.preferredBeamDirection]}`),t.beamingMode!==be.Auto)switch(t.beamingMode){case be.ForceSplitToNext:e.writeGroupItem("beam split");break;case be.ForceMergeWithNext:e.writeGroupItem("beam merge");break;case be.ForceSplitOnSecondaryToNext:e.writeGroupItem("beam splitsecondary")}t.showTimer&&e.writeGroupItem("timer"),e.endGroup()}writeNoteTo(e,t){if(t.index>0&&e.write(" "),t.isPercussion)e.writeString(Ie.getArticulationName(t));else if(t.isPiano)e.write(nt.getTextForTuning(t.realValueWithoutHarmonic,!0));else{if(!t.isStringed)throw new Error("What kind of note");{e.write(`${t.fret}`);const s=t.beat.voice.bar.staff.tuning.length-t.string+1;e.write(`.${s}`)}}this.writeNoteEffectsTo(e,t)}writeNoteEffectsTo(e,t){if(e.beginGroup("{","}"),t.hasBend){e.writeGroupItem(`be ${S[t.bendType]}`),t.bendStyle!==b.Default&&e.writeGroupItem(`${b[t.bendStyle]} `),e.beginGroup("(",")");for(const s of t.bendPoints)e.writeGroupItem(`${s.offset} ${s.value}`);e.endGroup()}switch(t.harmonicType){case N.Natural:e.writeGroupItem("nh");break;case N.Artificial:e.writeGroupItem(`ah ${t.harmonicValue}`);break;case N.Pinch:e.writeGroupItem(`ph ${t.harmonicValue}`);break;case N.Tap:e.writeGroupItem(`th ${t.harmonicValue}`);break;case N.Semi:e.writeGroupItem(`sh ${t.harmonicValue}`);break;case N.Feedback:e.writeGroupItem(`fh ${t.harmonicValue}`)}switch(t.showStringNumber&&e.writeGroupItem("string"),t.isTrill&&e.writeGroupItem(`tr ${t.trillFret} ${t.trillSpeed}`),t.vibrato){case M.Slight:e.writeGroupItem("v");break;case M.Wide:e.writeGroupItem("vw")}switch(t.slideInType){case v.IntoFromBelow:e.writeGroupItem("sib");break;case v.IntoFromAbove:e.writeGroupItem("sia")}switch(t.slideOutType){case E.Shift:e.writeGroupItem("ss");break;case E.Legato:e.writeGroupItem("sl");break;case E.OutUp:e.writeGroupItem("sou");break;case E.OutDown:e.writeGroupItem("sod");break;case E.PickSlideDown:e.writeGroupItem("psd");break;case E.PickSlideUp:e.writeGroupItem("psu")}switch(t.isHammerPullOrigin&&e.writeGroupItem("h"),t.isLeftHandTapped&&e.writeGroupItem("lht"),t.isGhost&&e.writeGroupItem("g"),t.accentuated){case _.Normal:e.writeGroupItem("ac");break;case _.Heavy:e.writeGroupItem("hac");break;case _.Tenuto:e.writeGroupItem("ten")}switch(t.isPalmMute&&e.writeGroupItem("pm"),t.isStaccato&&e.writeGroupItem("st"),t.isLetRing&&e.writeGroupItem("lr"),t.isDead&&e.writeGroupItem("x"),t.isTieDestination&&e.writeGroupItem("t"),t.leftHandFinger){case x.Thumb:e.writeGroupItem("lf 1");break;case x.IndexFinger:e.writeGroupItem("lf 2");break;case x.MiddleFinger:e.writeGroupItem("lf 3");break;case x.AnnularFinger:e.writeGroupItem("lf 4");break;case x.LittleFinger:e.writeGroupItem("lf 5")}switch(t.rightHandFinger){case x.Thumb:e.writeGroupItem("rf 1");break;case x.IndexFinger:e.writeGroupItem("rf 2");break;case x.MiddleFinger:e.writeGroupItem("rf 3");break;case x.AnnularFinger:e.writeGroupItem("rf 4");break;case x.LittleFinger:e.writeGroupItem("rf 5")}if(t.isVisible||e.writeGroupItem("hide"),t.isSlurOrigin){const s=`s${t.id}`;e.writeGroupItem(`slur ${s}`)}if(t.isSlurDestination){const s=`s${t.slurOrigin.id}`;e.writeGroupItem(`slur ${s}`)}switch(t.isTrill&&e.writeGroupItem(`tr ${t.trillFret} ${t.trillSpeed}`),t.accidentalMode!==P.Default&&e.writeGroupItem(`acc ${P[t.accidentalMode]}`),t.ornament){case ce.InvertedTurn:e.writeGroupItem("iturn");break;case ce.Turn:e.writeGroupItem("turn");break;case ce.UpperMordent:e.writeGroupItem("umordent");break;case ce.LowerMordent:e.writeGroupItem("lmordent")}e.endGroup()}}var qc;$c.DefaultScore=new Ke,$c.DefaultTrack=new lt,function(e){e[e.SteelGuitar=1]="SteelGuitar",e[e.AcousticGuitar=2]="AcousticGuitar",e[e.TwelveStringGuitar=3]="TwelveStringGuitar",e[e.ElectricGuitar=4]="ElectricGuitar",e[e.Bass=5]="Bass",e[e.ClassicalGuitar=23]="ClassicalGuitar",e[e.UprightBass=6]="UprightBass",e[e.Ukulele=7]="Ukulele",e[e.Banjo=8]="Banjo",e[e.Mandolin=9]="Mandolin",e[e.Piano=10]="Piano",e[e.Synth=12]="Synth",e[e.Strings=11]="Strings",e[e.Brass=13]="Brass",e[e.Reed=14]="Reed",e[e.Woodwind=15]="Woodwind",e[e.Vocal=16]="Vocal",e[e.PitchedIdiophone=17]="PitchedIdiophone",e[e.Fx=21]="Fx",e[e.PercussionKit=18]="PercussionKit",e[e.Idiophone=19]="Idiophone",e[e.Membraphone=20]="Membraphone"}(qc||(qc={}));class jc{constructor(e,t,s=null){if(this.icon=qc.Piano,this.icon=e,this.instrumentSetName=t,s)this.instrumentSetType=s;else{const e=t.split(" ");e[0]=e[0].substr(0,1).toLowerCase()+e[0].substr(1),this.instrumentSetType=e.join("")}}}class Kc{constructor(){this._rhythmIdLookup=new Map}writeXml(e){const t=new as;return this._rhythmIdLookup=new Map,this.writeDom(t,e),t.toFormattedString("",!0)}writeDom(e,t){const s=e.addElement("GPIF");s.addElement("GPVersion").innerText="8.1.3";const i=s.addElement("GPRevision");i.attributes.set("required","12024"),i.attributes.set("recommended","13000"),i.innerText="13007";const a=s.addElement("Encoding");a.addElement("EncodingDescription").innerText="GP8";const r=new es;r.nodeType=Tt.Comment,r.value=`Written by alphaTab ${W.version} (${W.commit})`,a.addChild(r),this.writeScoreNode(s,t),this.writeMasterTrackNode(s,t),this.writeBackingTrackNode(s,t),this.writeAudioTracksNode(s,t),this.writeTracksNode(s,t),this.writeMasterBarsNode(s,t),this.writeAssets(s,t);const n=s.addElement("Bars"),o=s.addElement("Voices"),h=s.addElement("Beats"),l=s.addElement("Notes"),c=s.addElement("Rhythms");for(const e of t.tracks)for(const t of e.staves)for(const e of t.bars){this.writeBarNode(n,e);for(const t of e.voices){this.writeVoiceNode(o,t);for(const e of t.beats){this.writeBeatNode(h,e,c);for(const t of e.notes)this.writeNoteNode(l,t)}}}}writeAssets(e,t){if(!t.backingTrack?.rawAudioFile)return;const s=e.addElement("Assets").addElement("Asset");s.attributes.set("id",this.backingTrackAssetId),this.backingTrackAssetFileName="Content/Assets/backing-track",s.addElement("EmbeddedFilePath").setCData(this.backingTrackAssetFileName)}writeBackingTrackNode(e,t){if(!t.backingTrack?.rawAudioFile)return;const s=e.addElement("BackingTrack");this.backingTrackAssetId="0",s.addElement("IconId").innerText="21",s.addElement("Color").innerText="0 0 0",s.addElement("Name").setCData("Audio Track"),s.addElement("ShortName").setCData("a.track"),s.addElement("PlaybackState").innerText="Default",s.addElement("Enabled").innerText="true",s.addElement("Source").innerText="Local",s.addElement("AssetId").innerText="0";const i=s.addElement("ChannelStrip");i.addElement("Parameters").innerText="0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.500000 0.000000 0.500000 0.500000 0.800000 0.500000 0.500000 0.500000",i.addElement("YouTubeVideoUrl").innerText="",i.addElement("Filter").innerText="6",i.addElement("FramesPerPixel").innerText="400";const a=void 0!==this.backingTrackFramePadding?this.backingTrackFramePadding:0;s.addElement("FramePadding").innerText=`${a}`,s.addElement("Semitones").innerText="0",s.addElement("Cents").innerText="0"}writeNoteNode(e,t){const s=e.addElement("Note");s.attributes.set("id",t.id.toString()),this.writeNoteProperties(s,t),t.isGhost&&(s.addElement("AntiAccent").innerText="normal"),t.isLetRing&&s.addElement("LetRing"),t.isTrill&&(s.addElement("Trill").innerText=t.trillValue.toString());let i=0;switch(t.isStaccato&&(i|=1),t.accentuated){case _.Normal:i|=8;break;case _.Heavy:i|=4;break;case _.Tenuto:i|=16}if(i>0&&(s.addElement("Accent").innerText=i.toString()),t.isTieOrigin||t.isTieDestination){const e=s.addElement("Tie");e.attributes.set("origin",t.isTieOrigin?"true":"false"),e.attributes.set("destination",t.isTieDestination?"true":"false")}switch(t.vibrato){case M.Slight:s.addElement("Vibrato").innerText="Slight";break;case M.Wide:s.addElement("Vibrato").innerText="Wide"}if(t.isFingering){switch(t.leftHandFinger){case x.Thumb:s.addElement("LeftFingering").innerText="P";break;case x.IndexFinger:s.addElement("LeftFingering").innerText="I";break;case x.MiddleFinger:s.addElement("LeftFingering").innerText="M";break;case x.AnnularFinger:s.addElement("LeftFingering").innerText="A";break;case x.LittleFinger:s.addElement("LeftFingering").innerText="C"}switch(t.rightHandFinger){case x.Thumb:s.addElement("RightFingering").innerText="P";break;case x.IndexFinger:s.addElement("RightFingering").innerText="I";break;case x.MiddleFinger:s.addElement("RightFingering").innerText="M";break;case x.AnnularFinger:s.addElement("RightFingering").innerText="A";break;case x.LittleFinger:s.addElement("RightFingering").innerText="C"}}t.percussionArticulation>=0?s.addElement("InstrumentArticulation").innerText=t.percussionArticulation.toString():s.addElement("InstrumentArticulation").innerText="0",t.ornament!==ce.None&&(s.addElement("Ornament").innerText=ce[t.ornament])}writeNoteProperties(e,t){const s=e.addElement("Properties");if(this.writeConcertPitch(s,t),this.writeTransposedPitch(s,t),t.isStringed&&(this.writeSimplePropertyNode(s,"String","String",(t.string-1).toString()),this.writeSimplePropertyNode(s,"Fret","Fret",t.fret.toString()),this.writeSimplePropertyNode(s,"Midi","Number",t.realValue.toString()),t.showStringNumber&&this.writeSimplePropertyNode(s,"ShowStringNumber","Enable",null)),t.isPiano&&(this.writeSimplePropertyNode(s,"Octave","Number",t.octave.toString()),this.writeSimplePropertyNode(s,"Tone","Step",t.tone.toString()),this.writeSimplePropertyNode(s,"Midi","Number",t.realValue.toString())),t.beat.tap&&this.writeSimplePropertyNode(s,"Tapped","Enable",null),t.harmonicType!==N.None){switch(t.harmonicType){case N.Natural:this.writeSimplePropertyNode(s,"HarmonicType","HType","Natural");break;case N.Artificial:this.writeSimplePropertyNode(s,"HarmonicType","HType","Artificial");break;case N.Pinch:this.writeSimplePropertyNode(s,"HarmonicType","HType","Pinch");break;case N.Tap:this.writeSimplePropertyNode(s,"HarmonicType","HType","Tap");break;case N.Semi:this.writeSimplePropertyNode(s,"HarmonicType","HType","Semi");break;case N.Feedback:this.writeSimplePropertyNode(s,"HarmonicType","HType","Feedback")}0!==t.harmonicValue&&this.writeSimplePropertyNode(s,"HarmonicFret","HFret",t.harmonicValue.toString())}t.isDead&&this.writeSimplePropertyNode(s,"Muted","Enable",null),t.isPalmMute&&this.writeSimplePropertyNode(s,"PalmMuted","Enable",null),t.hasBend&&this.writeBend(s,t),t.isHammerPullOrigin&&this.writeSimplePropertyNode(s,"HopoOrigin","Enable",null),t.isHammerPullDestination&&this.writeSimplePropertyNode(s,"HopoDestination","Enable",null),t.isLeftHandTapped&&this.writeSimplePropertyNode(s,"LeftHandTapped","Enable",null);let i=0;switch(t.slideInType){case v.IntoFromAbove:i|=32;break;case v.IntoFromBelow:i|=16}switch(t.slideOutType){case E.Shift:i|=1;break;case E.Legato:i|=2;break;case E.OutDown:i|=4;break;case E.OutUp:i|=8;break;case E.PickSlideDown:i|=64;break;case E.PickSlideUp:i|=128}i>0&&this.writeSimplePropertyNode(s,"Slide","Flags",i.toString())}writeTransposedPitch(e,t){t.isPercussion?this.writePitch(e,"ConcertPitch","C","-1",""):this.writePitchForValue(e,"TransposedPitch",t.displayValueWithoutBend,t.accidentalMode,t.beat.voice.bar.keySignature)}writeConcertPitch(e,t){t.isPercussion?this.writePitch(e,"ConcertPitch","C","-1",""):this.writePitchForValue(e,"ConcertPitch",t.realValueWithoutHarmonic,t.accidentalMode,t.beat.voice.bar.keySignature)}writePitchForValue(e,t,s,i,a){let r=0,n=0,o="",h="";const l=()=>{switch(r=s%12,n=s/12|0,o=Kc.defaultSteps[r],De.computeAccidental(a,P.Default,s,!1)){case oe.None:case oe.Natural:h="";break;case oe.Sharp:h="#";break;case oe.Flat:h="b";break;case oe.DoubleSharp:h="x";break;case oe.DoubleFlat:h="bb"}};switch(l(),i){case P.Default:break;case P.ForceNone:case P.ForceNatural:h="";break;case P.ForceSharp:h="#";break;case P.ForceDoubleSharp:"#"===h&&(s-=2,l()),h="x";break;case P.ForceFlat:"#"===h&&(s+=1,l()),h="b";break;case P.ForceDoubleFlat:"#"===h&&(s+=2,l()),h="bb"}this.writePitch(e,t,o,n.toString(),h)}writePitch(e,t,s,i,a){const r=e.addElement("Property");r.attributes.set("name",t);const n=r.addElement("Pitch");n.addElement("Step").innerText=s,n.addElement("Accidental").innerText=a,n.addElement("Octave").innerText=i}writeBend(e,t){t.hasBend&&t.bendPoints.length<=4&&this.writeStandardBend(e,t.bendPoints)}writeStandardBend(e,t){this.writeSimplePropertyNode(e,"Bended","Enable",null);const s=t[0],i=t[t.length-1];let a,r;switch(t.length){case 4:a=t[1],r=t[2];break;case 3:a=t[1],r=t[1];break;default:a=new j((s.offset+i.offset)/2,(s.value+i.value)/2),r=a}this.writeSimplePropertyNode(e,"BendDestinationOffset","Float",this.toBendOffset(i.offset).toString()),this.writeSimplePropertyNode(e,"BendDestinationValue","Float",this.toBendValue(i.value).toString()),this.writeSimplePropertyNode(e,"BendMiddleOffset1","Float",this.toBendOffset(a.offset).toString()),this.writeSimplePropertyNode(e,"BendMiddleOffset2","Float",this.toBendOffset(r.offset).toString()),this.writeSimplePropertyNode(e,"BendMiddleValue","Float",this.toBendValue(a.value).toString()),this.writeSimplePropertyNode(e,"BendOriginOffset","Float",this.toBendOffset(s.offset).toString()),this.writeSimplePropertyNode(e,"BendOriginValue","Float",this.toBendValue(s.value).toString())}toBendValue(e){return 25*e}toBendOffset(e){return e/j.MaxPosition*100}writeBeatNode(e,t,s){const i=e.addElement("Beat");if(i.attributes.set("id",t.id.toString()),i.addElement("Dynamic").innerText=f[t.dynamics],t.fade!==me.None&&(i.addElement("Fadding").innerText=me[t.fade]),t.isTremolo)switch(t.tremoloSpeed){case k.Eighth:i.addElement("Tremolo").innerText="1/2";break;case k.Sixteenth:i.addElement("Tremolo").innerText="1/4";break;case k.ThirtySecond:i.addElement("Tremolo").innerText="1/8"}switch(t.hasChord&&i.addElement("Chord").setCData(t.chordId),t.crescendo!==B.None&&(i.addElement("Hairpin").innerText=B[t.crescendo]),t.brushType){case w.ArpeggioUp:i.addElement("Arpeggio").innerText="Up";break;case w.ArpeggioDown:i.addElement("Arpeggio").innerText="Down"}switch(t.text&&i.addElement("FreeText").setCData(t.text),t.graceType){case T.OnBeat:case T.BeforeBeat:i.addElement("GraceNotes").innerText=T[t.graceType]}if(t.ottava!==l.Regular&&(i.addElement("Ottavia").innerText=l[t.ottava].substr(1)),t.hasWhammyBar&&this.writeWhammyNode(i,t),t.isLegatoOrigin||t.isLegatoDestination){const e=i.addElement("Legato");e.attributes.set("origin",t.isLegatoOrigin?"true":"false"),e.attributes.set("destination",t.isLegatoDestination?"true":"false")}if(this.writeRhythm(i,t,s),null!==t.preferredBeamDirection)switch(t.preferredBeamDirection){case Pe.Up:i.addElement("TransposedPitchStemOrientation").innerText="Upward",i.addElement("UserTransposedPitchStemOrientation").innerText="Upward";break;case Pe.Down:i.addElement("TransposedPitchStemOrientation").innerText="Downward",i.addElement("UserTransposedPitchStemOrientation").innerText="Downward"}i.addElement("ConcertPitchStemOrientation").innerText="Undefined",t.slashed&&i.addElement("Slashed"),t.deadSlapped&&i.addElement("DeadSlapped"),t.notes.length>0&&(i.addElement("Notes").innerText=t.notes.map(e=>e.id).join(" ")),t.golpe!==pe.None&&(i.addElement("Golpe").innerText=pe[t.golpe]),t.wahPedal!==ge.None&&(i.addElement("Wah").innerText=ge[t.wahPedal]),t.showTimer&&(i.addElement("Timer").innerText=(t.timer??0).toString()),this.writeBeatProperties(i,t),this.writeBeatXProperties(i,t),t.lyrics&&t.lyrics.length>0&&this.writeBeatLyrics(i,t.lyrics)}writeBeatLyrics(e,t){const s=e.addElement("Lyrics");for(const e of t){s.addElement("Line").setCData(e)}}writeBeatXProperties(e,t){const s=e.addElement("XProperties");switch(t.brushDuration>0&&this.writeSimpleXPropertyNode(s,"687935489","Int",t.brushDuration.toString()),t.beamingMode){case be.ForceSplitToNext:this.writeSimpleXPropertyNode(s,"1124204546","Int","2");break;case be.ForceMergeWithNext:this.writeSimpleXPropertyNode(s,"1124204546","Int","1");break;case be.ForceSplitOnSecondaryToNext:this.writeSimpleXPropertyNode(s,"1124204552","Int","1")}}writeBeatProperties(e,t){const s=e.addElement("Properties");switch(t.brushType){case w.BrushUp:this.writeSimplePropertyNode(s,"Brush","Direction","Up");break;case w.BrushDown:this.writeSimplePropertyNode(s,"Brush","Direction","Down")}switch(t.pickStroke){case he.Up:this.writeSimplePropertyNode(s,"PickStroke","Direction","Up");break;case he.Down:this.writeSimplePropertyNode(s,"PickStroke","Direction","Down")}switch(t.slap&&this.writeSimplePropertyNode(s,"Slapped","Enable",null),t.pop&&this.writeSimplePropertyNode(s,"Popped","Enable",null),t.vibrato){case M.Wide:this.writeSimplePropertyNode(s,"VibratoWTremBar","Strength","Wide");break;case M.Slight:this.writeSimplePropertyNode(s,"VibratoWTremBar","Strength","Slight")}if(t.isBarre)switch(this.writeSimplePropertyNode(s,"BarreFret","Fret",t.barreFret.toString()),t.barreShape){case fe.Full:this.writeSimplePropertyNode(s,"BarreString","String","0");break;case fe.Half:this.writeSimplePropertyNode(s,"BarreString","String","1")}if(t.rasgueado!==ye.None){let e="";switch(t.rasgueado){case ye.Ii:e="ii_1";break;case ye.Mi:e="mi_1";break;case ye.MiiTriplet:e="mii_1";break;case ye.MiiAnapaest:e="mii_2";break;case ye.PmpTriplet:e="pmp_1";break;case ye.PmpAnapaest:e="pmp_2";break;case ye.PeiTriplet:e="pei_1";break;case ye.PeiAnapaest:e="pei_2";break;case ye.PaiTriplet:e="pai_1";break;case ye.PaiAnapaest:e="pai_2";break;case ye.AmiTriplet:e="ami_1";break;case ye.AmiAnapaest:e="ami_2";break;case ye.Ppp:e="ppp_1";break;case ye.Amii:e="amii_1";break;case ye.Amip:e="amip_1";break;case ye.Eami:e="eami_1";break;case ye.Eamii:e="eamii_1";break;case ye.Peami:e="peami_1"}this.writeSimplePropertyNode(s,"Rasgueado","Rasgueado",e)}}writeRhythm(e,t,s){const i=`${t.duration}_${t.dots}_${t.tupletNumerator}_${t.tupletDenominator}';`;let a;if(this._rhythmIdLookup.has(i))a=this._rhythmIdLookup.get(i);else{a=this._rhythmIdLookup.size.toString(),this._rhythmIdLookup.set(i,a);const e=s.addElement("Rhythm");if(e.attributes.set("id",a),t.hasTuplet){const s=e.addElement("PrimaryTuplet");s.attributes.set("num",t.tupletNumerator.toString()),s.attributes.set("den",t.tupletDenominator.toString())}t.dots>0&&e.addElement("AugmentationDot").attributes.set("count",t.dots.toString());let r="Quarter";switch(t.duration){case k.QuadrupleWhole:r="Long";break;case k.DoubleWhole:r="DoubleWhole";break;case k.Whole:r="Whole";break;case k.Half:r="Half";break;case k.Quarter:r="Quarter";break;case k.Eighth:r="Eighth";break;case k.Sixteenth:r="16th";break;case k.ThirtySecond:r="32nd";break;case k.SixtyFourth:r="64th";break;case k.OneHundredTwentyEighth:r="128th";break;case k.TwoHundredFiftySixth:r="256th"}e.addElement("NoteValue").innerText=r}e.addElement("Rhythm").attributes.set("ref",a)}writeWhammyNode(e,t){t.hasWhammyBar&&t.whammyBarPoints.length<=4&&this.writeStandardWhammy(e,t.whammyBarPoints)}writeStandardWhammy(e,t){const s=e.addElement("Whammy"),i=t[0],a=t[t.length-1];let r,n;switch(t.length){case 4:r=t[1],n=t[2];break;case 3:r=t[1],n=t[1];break;default:r=new j((i.offset+a.offset)/2,(i.value+a.value)/2),n=r}s.attributes.set("destinationOffset",this.toBendOffset(a.offset).toString()),s.attributes.set("destinationValue",this.toBendValue(a.value).toString()),s.attributes.set("middleOffset1",this.toBendOffset(r.offset).toString()),s.attributes.set("middleOffset2",this.toBendOffset(n.offset).toString()),s.attributes.set("middleValue",this.toBendValue(r.value).toString()),s.attributes.set("originOffset",this.toBendOffset(i.offset).toString()),s.attributes.set("originValue",this.toBendValue(i.value).toString())}writeScoreNode(e,t){const s=e.addElement("Score");s.addElement("Title").setCData(t.title),s.addElement("SubTitle").setCData(t.subTitle),s.addElement("Artist").setCData(t.artist),s.addElement("Album").setCData(t.album),s.addElement("Words").setCData(t.words),s.addElement("Music").setCData(t.music),s.addElement("WordsAndMusic").setCData(t.words===t.music?t.words:""),s.addElement("Copyright").setCData(t.copyright),s.addElement("Tabber").setCData(t.tab),s.addElement("Instructions").setCData(t.instructions),s.addElement("Notices").setCData(t.notices),s.addElement("FirstPageHeader").setCData(""),s.addElement("FirstPageFooter").setCData(""),s.addElement("PageHeader").setCData(""),s.addElement("PageFooter").setCData(""),s.addElement("ScoreSystemsDefaultLayout").setCData(t.defaultSystemsLayout.toString()),s.addElement("ScoreSystemsLayout").setCData(t.systemsLayout.join(" ")),s.addElement("ScoreZoomPolicy").innerText="Value",s.addElement("ScoreZoom").innerText="1",s.addElement("MultiVoice").innerText="1>"}writeMasterTrackNode(e,t){const s=e.addElement("MasterTrack");s.addElement("Tracks").innerText=t.tracks.map(e=>e.index).join(" ");const i=s.addElement("Automations");if(t.masterBars.length>0&&t.masterBars[0].isAnacrusis&&s.addElement("Anacrusis"),0===t.masterBars[0].tempoAutomations.length){const e=i.addElement("Automation");e.addElement("Type").innerText="Tempo",e.addElement("Linear").innerText="false",e.addElement("Bar").innerText="0",e.addElement("Position").innerText="0",e.addElement("Visible").innerText="true",e.addElement("Value").innerText=`${t.tempo} 2`,t.tempoLabel&&(e.addElement("Text").innerText=t.tempoLabel)}const a=t.masterBars[0].syncPoints?t.masterBars[0].syncPoints.find(e=>0===e.ratioPosition&&0===e.syncPointValue.barOccurence):void 0,r=a?a.syncPointValue.millisecondOffset:0;this.backingTrackFramePadding=r/1e3*Kc.SampleRate*-1|0;const n=new Q(()=>cn.buildModifiedTempoLookup(t));for(const e of t.masterBars){for(const t of e.tempoAutomations){const s=i.addElement("Automation");s.addElement("Type").innerText="Tempo",s.addElement("Linear").innerText=t.isLinear?"true":"false",s.addElement("Bar").innerText=e.index.toString(),s.addElement("Position").innerText=t.ratioPosition.toString(),s.addElement("Visible").innerText="true",s.addElement("Value").innerText=`${t.value} 2`,t.text&&(s.addElement("Text").innerText=t.text)}if(e.syncPoints)for(const s of e.syncPoints){const a=i.addElement("Automation");a.addElement("Type").innerText="SyncPoint",a.addElement("Linear").innerText="false",a.addElement("Bar").innerText=e.index.toString(),a.addElement("Position").innerText=s.ratioPosition.toString(),a.addElement("Visible").innerText="true";const o=a.addElement("Value");o.addElement("BarIndex").innerText=e.index.toString(),o.addElement("BarOccurrence").innerText=s.syncPointValue.barOccurence.toString(),o.addElement("ModifiedTempo").innerText=n.value.get(s).syncBpm.toString(),o.addElement("OriginalTempo").innerText=t.tempo.toString();let h=(s.syncPointValue.millisecondOffset-r)/1e3*Kc.SampleRate;h=Math.floor(h+.5),o.addElement("FrameOffset").innerText=h.toString()}}}writeAudioTracksNode(e,t){e.addElement("AudioTracks")}writeTracksNode(e,t){const s=e.addElement("Tracks");for(const e of t.tracks)this.writeTrackNode(s,e)}writeTrackNode(e,t){const s=e.addElement("Track");s.attributes.set("id",t.index.toString()),s.addElement("Name").setCData(t.name),s.addElement("ShortName").setCData(t.shortName),s.addElement("Color").innerText=`${t.color.r} ${t.color.g} ${t.color.b}`,s.addElement("SystemsDefautLayout").innerText=t.defaultSystemsLayout.toString(),s.addElement("SystemsLayout").innerText=t.systemsLayout.join(" "),s.addElement("AutoBrush"),s.addElement("PalmMute").innerText="0",s.addElement("PlayingStyle").innerText=H.isGuitar(t.playbackInfo.program)?"StringedPick":"Default",s.addElement("UseOneChannelPerString"),s.addElement("IconId").innerText=Kc.getIconId(t.playbackInfo).toString(),this.writeInstrumentSetNode(s,t),this.writeTransposeNode(s,t),this.writeRseNode(s,t),s.addElement("ForcedSound").innerText="-1",this.writeMidiConnectionNode(s,t),t.playbackInfo.isSolo?s.addElement("PlaybackState").innerText="Solo":t.playbackInfo.isMute?s.addElement("PlaybackState").innerText="Mute":s.addElement("PlaybackState").innerText="Default",s.addElement("AudioEngineState").innerText="MIDI",this.writeLyricsNode(s,t),this.writeStavesNode(s,t),this.writeSoundsAndAutomations(s,t)}static getIconId(e){return 9===e.primaryChannel?Kc.DrumKitProgramInfo.icon:Kc.MidiProgramInfoLookup.has(e.program)?Kc.MidiProgramInfoLookup.get(e.program).icon:qc.SteelGuitar}writeSoundAndAutomation(e,t,s,i,a,r,n,o,h=0){const l=e.addElement("Sound");l.addElement("Name").setCData(s),l.addElement("Label").setCData(s),l.addElement("Path").setCData(i),l.addElement("Role").setCData(a);const c=l.addElement("MIDI"),d=H.bankToLsbMsb(o);c.addElement("LSB").innerText=d[0].toString(),c.addElement("MSB").innerText=d[1].toString(),c.addElement("Program").innerText=n.toString();const u=t.addElement("Automation");u.addElement("Type").innerText="Sound",u.addElement("Linear").innerText="false",u.addElement("Bar").innerText=r.toString(),u.addElement("Position").innerText=h.toString(),u.addElement("Visible").innerText="true",u.addElement("Value").setCData(`${i};${s};${a}`)}writeSoundsAndAutomations(e,t){const s=e.addElement("Sounds"),i=e.addElement("Automations");if(t.staves.length>0&&t.staves[0].bars.length>0){const e=`Track_${t.index}_Initial`,a=`Midi/${t.playbackInfo.program}`,r="Factory";let n=!1,o=t.playbackInfo.bank;for(const h of t.staves)for(const l of h.bars)for(const h of l.voices)for(const c of h.beats){const h=c.getAutomation(y.Instrument),d=0===l.index&&0===c.index,u=c.getAutomation(y.Bank);if(u&&(o=u.value),h){const u=d?e:`ProgramChange_${c.id}`,p=d?a:`Midi/${h.value}`,m=d?r:"User";d||n||(this.writeSoundAndAutomation(s,i,e,a,r,t.staves[0].bars[0].index,t.playbackInfo.program,t.playbackInfo.bank),n=!0),this.writeSoundAndAutomation(s,i,u,p,m,l.index,h.value,o,h.ratioPosition),d&&(n=!0)}}}for(const e of t.staves)for(const t of e.bars)for(const e of t.sustainPedals)if(e.pedalType!==p.Hold){const s=i.addElement("Automation");switch(s.addElement("Type").innerText="SustainPedal",s.addElement("Linear").innerText="false",s.addElement("Bar").innerText=t.index.toString(),s.addElement("Position").innerText=e.ratioPosition.toString(),s.addElement("Visible").innerText="true",e.pedalType){case p.Down:s.addElement("Value").innerText="0 1";break;case p.Up:s.addElement("Value").innerText="0 3"}}}writeMidiConnectionNode(e,t){const s=e.addElement("MidiConnection");s.addElement("Port").innerText=t.playbackInfo.port.toString(),s.addElement("PrimaryChannel").innerText=t.playbackInfo.primaryChannel.toString(),s.addElement("SecondaryChannel").innerText=t.playbackInfo.secondaryChannel.toString(),s.addElement("ForeOneChannelPerString").innerText="false"}writeRseNode(e,t){const s=e.addElement("RSE").addElement("ChannelStrip");s.attributes.set("version","E56");s.addElement("Parameters").innerText=`0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 1 0.5 ${t.playbackInfo.balance/16} ${t.playbackInfo.volume/16} 0.5 0.5 0.5`}writeStavesNode(e,t){const s=e.addElement("Staves");for(const e of t.staves)this.writeStaffNode(s,e)}writeStaffNode(e,t){const s=e.addElement("Staff").addElement("Properties");if(this.writeSimplePropertyNode(s,"CapoFret","Fret",t.capo.toString()),this.writeSimplePropertyNode(s,"FretCount","Fret","24"),t.tuning.length>0){const e=s.addElement("Property");switch(e.attributes.set("name","Tuning"),e.addElement("Pitches").innerText=t.tuning.slice().reverse().join(" "),e.addElement("Label").setCData(t.tuningName),e.addElement("LabelVisible").innerText=t.tuningName?"true":"false",e.addElement("Flat"),t.tuning.length){case 3:e.addElement("Instrument").innerText="Shamisen";break;case 4:105===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Banjo":42===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Cello":43===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Contrabass":40===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Violin":41===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Viola":e.addElement("Instrument").innerText="Bass";break;case 5:105===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Banjo":e.addElement("Instrument").innerText="Bass";break;case 6:105===t.track.playbackInfo.program?e.addElement("Instrument").innerText="Banjo":t.track.playbackInfo.program<=39?e.addElement("Instrument").innerText="Bass":e.addElement("Instrument").innerText="Guitar";break;case 7:t.track.playbackInfo.program<=39?e.addElement("Instrument").innerText="Bass":e.addElement("Instrument").innerText="Guitar";break;default:e.addElement("Instrument").innerText="Guitar"}}this.writeSimplePropertyNode(s,"PartialCapoFret","Fret","0"),this.writeSimplePropertyNode(s,"PartialCapoStringFlags","Bitset",t.tuning.map(e=>"0").join("")),this.writeSimplePropertyNode(s,"TuningFlat","Enable",null),this.writeDiagramCollection(s,t,"DiagramCollection"),this.writeDiagramCollection(s,t,"DiagramWorkingSet")}writeDiagramCollection(e,t,s){const i=e.addElement("Property");i.attributes.set("name",s);const a=i.addElement("Items"),r=t.chords;if(r)for(const[e,t]of r){const s=a.addElement("Item");s.attributes.set("id",e),s.attributes.set("name",t.name);const i=s.addElement("Diagram");i.attributes.set("stringCount",t.strings.length.toString()),i.attributes.set("fretCount","5"),i.attributes.set("baseFret",(t.firstFret-1).toString()),i.attributes.set("barStates",t.strings.map(e=>"1").join(" "));const r=[],n=new Map;for(let e=0;e<t.strings.length;e++){const s=t.strings[e];if(-1!==s){const a=i.addElement("Fret"),o=t.strings.length-1-e;a.attributes.set("string",o.toString()),a.attributes.set("fret",(s-t.firstFret+1).toString()),n.has(s)||(n.set(s,[]),r.push(s)),n.get(s).push(o)}}r.sort();const o=i.addElement("Fingering");if(t.barreFrets.length>0){const e=[x.LittleFinger,x.AnnularFinger,x.MiddleFinger,x.IndexFinger];for(const s of r){const i=n.get(s);if(i.length>1&&t.barreFrets.indexOf(s)>=0){const a=e.length>0?e.pop():x.IndexFinger;for(const e of i){const i=o.addElement("Position");switch(a){case x.LittleFinger:i.attributes.set("finger","Pinky");break;case x.AnnularFinger:i.attributes.set("finger","Ring");break;case x.MiddleFinger:i.attributes.set("finger","Middle");break;case x.IndexFinger:i.attributes.set("finger","Index")}i.attributes.set("fret",(s-t.firstFret+1).toString()),i.attributes.set("string",e.toString())}}}}const h=i.addElement("Property");h.attributes.set("name","ShowName"),h.attributes.set("type","bool"),h.attributes.set("value",t.showName?"true":"false");const l=i.addElement("Property");l.attributes.set("name","ShowDiagram"),l.attributes.set("type","bool"),l.attributes.set("value",t.showDiagram?"true":"false");const c=i.addElement("Property");c.attributes.set("name","ShowFingering"),c.attributes.set("type","bool"),c.attributes.set("value",t.showFingering?"true":"false");const d=i.addElement("Chord"),u=d.addElement("KeyNote");u.attributes.set("step","C"),u.attributes.set("accidental","Natural");const p=d.addElement("BassNote");p.attributes.set("step","C"),p.attributes.set("accidental","Natural");const m=d.addElement("Degree");m.attributes.set("interval","Third"),m.attributes.set("alteration","Major"),m.attributes.set("omitted","false");const g=d.addElement("Degree");g.attributes.set("interval","Fifth"),g.attributes.set("alteration","Perfect"),g.attributes.set("omitted","false")}}writeSimplePropertyNode(e,t,s,i){const a=e.addElement("Property");a.attributes.set("name",t);const r=a.addElement(s);return null!==i&&(r.innerText=i),a}writeSimpleXPropertyNode(e,t,s,i){const a=e.addElement("XProperty");a.attributes.set("id",t);const r=a.addElement(s);return null!==i&&(r.innerText=i),a}writeLyricsNode(e,t){const s=e.addElement("Lyrics");s.attributes.set("dispatched","true");const i=[];for(const e of t.staves[0].bars)for(const t of e.voices)if(!t.isEmpty)for(const s of t.beats)if(s.lyrics)for(let t=0;t<s.lyrics.length;t++){for(;t>=i.length;){const t=new tt;t.startBar=e.index,t.text="[Empty]",i.push(t)}const a=i[t];a.text="[Empty]"===a.text?s.lyrics[t]:`${a.text} ${s.lyrics[t].split(" ").join("+")}`}for(let e=0;e<i.length;e++){const t=s.addElement("Line");t.addElement("Text").setCData(i[e].text),t.addElement("Offset").innerText=i[e].startBar.toString()}}writeTransposeNode(e,t){const s=e.addElement("Transpose"),i=Math.floor(t.staves[0].displayTranspositionPitch/12),a=t.staves[0].displayTranspositionPitch-12*i;s.addElement("Chromatic").innerText=a.toString(),s.addElement("Octave").innerText=i.toString()}writeInstrumentSetNode(e,t){const s=e.addElement("InstrumentSet"),i=t.staves[0];if(s.addElement("LineCount").innerText=i.standardNotationLineCount.toString(),t.percussionArticulations.length>0||i.isPercussion){const e=t.percussionArticulations.length>0?t.percussionArticulations:Array.from(Ie.instrumentArticulations.values());s.addElement("Name").innerText=Kc.DrumKitProgramInfo.instrumentSetName,s.addElement("Type").innerText=Kc.DrumKitProgramInfo.instrumentSetType;let i="",a=new es;const r=new Map,n=s.addElement("Elements");for(const t of e){{const e=n.addElement("Element");let s=t.elementType;if(r.has(s)){const e=r.get(s);s+=` ${e}`,r.set(s,e+1)}else r.set(s,1);i=s,e.addElement("Name").innerText=s,e.addElement("Type").innerText=t.elementType,a=e.addElement("Articulations")}const e=a.addElement("Articulation");switch(e.addElement("Name").innerText=`${i} ${a.childNodes.length}`,e.addElement("StaffLine").innerText=t.staffLine.toString(),e.addElement("Noteheads").innerText=[this.mapMusicSymbol(t.noteHeadDefault),this.mapMusicSymbol(t.noteHeadHalf),this.mapMusicSymbol(t.noteHeadWhole)].join(" "),t.techniqueSymbolPlacement){case le.Below:e.addElement("TechniquePlacement").innerText="below";break;case le.Outside:e.addElement("TechniquePlacement").innerText="outside";break;case le.Inside:e.addElement("TechniquePlacement").innerText="inside";break;case le.Above:e.addElement("TechniquePlacement").innerText="above"}e.addElement("TechniqueSymbol").innerText=this.mapMusicSymbol(t.techniqueSymbol),e.addElement("InputMidiNumbers").innerText="",e.addElement("OutputMidiNumber").innerText=t.outputMidiNumber.toString()}}else{const e=Kc.MidiProgramInfoLookup.has(t.playbackInfo.program)?Kc.MidiProgramInfoLookup.get(t.playbackInfo.program):Kc.MidiProgramInfoLookup.get(0);s.addElement("Name").innerText=e.instrumentSetName,s.addElement("Type").innerText=e.instrumentSetType;const i=s.addElement("Elements").addElement("Element");i.addElement("Pitched").innerText="Pitched",i.addElement("Type").innerText="pitched",i.addElement("SoundbankName").innerText="";const a=i.addElement("Articulations").addElement("Articulation");a.addElement("Name").innerText="",a.addElement("StaffLine").innerText="0",a.addElement("Noteheads").innerText="noteheadBlack noteheadHalf noteheadWhole",a.addElement("TechniquePlacement").innerText="outside",a.addElement("TechniqueSymbol").innerText="",a.addElement("InputMidiNumbers").innerText="",a.addElement("OutputRSESound").innerText="",a.addElement("OutputMidiNumber").innerText="0"}}mapMusicSymbol(e){if(e===ne.None)return"";const t=ne[e];return t.substring(0,1).toLowerCase()+t.substring(1)}writeMasterBarsNode(e,t){const s=e.addElement("MasterBars");for(const e of t.masterBars)this.writeMasterBarNode(s,e)}writeMasterBarNode(e,t){const s=e.addElement("MasterBar"),i=s.addElement("Key");let a=t.score.tracks[0].staves[0].bars[t.index].keySignature;const r=t.score.tracks[0].staves[0].bars[t.index].keySignatureType,n=De.flooredDivision(t.score.tracks[0].staves[0].displayTranspositionPitch,12);a=De.transposeKey(a,-n),i.addElement("AccidentalCount").innerText=a.toString(),i.addElement("Mode").innerText=u[r],i.addElement("Sharps").innerText="Sharps",s.addElement("Time").innerText=`${t.timeSignatureNumerator}/${t.timeSignatureDenominator}`,t.isFreeTime&&s.addElement("FreeTime");const o=[];for(const e of t.score.tracks)for(const s of e.staves)o.push(s.bars[t.index].id.toString());if(s.addElement("Bars").innerText=o.join(" "),t.isDoubleBar&&s.addElement("DoubleBar"),t.isSectionStart){const e=s.addElement("Section");e.addElement("Letter").setCData(t.section.marker),e.addElement("Text").setCData(t.section.text)}if(t.isRepeatStart||t.isRepeatEnd){const e=s.addElement("Repeat");e.attributes.set("start",t.isRepeatStart?"true":"false"),e.attributes.set("end",t.isRepeatEnd?"true":"false"),t.isRepeatEnd&&e.attributes.set("count",t.repeatCount.toString())}if(t.alternateEndings>0){let e=t.alternateEndings;const i=[];let a=0;for(;e>0;)1==(e>>a&1)&&(i.push(a+1),e&=~(1<<a)),a++;s.addElement("AlternateEndings").innerText=i.join(" ")}if(t.tripletFeel!==A.NoTripletFeel&&(s.addElement("TripletFeel").innerText=A[t.tripletFeel]),t.directions&&t.directions.size>0){const e=s.addElement("Directions");for(const s of t.directions)switch(s){case xe.TargetFine:e.addElement("Target").innerText="Fine";break;case xe.TargetSegno:e.addElement("Target").innerText="Segno";break;case xe.TargetSegnoSegno:e.addElement("Target").innerText="SegnoSegno";break;case xe.TargetCoda:e.addElement("Target").innerText="Coda";break;case xe.TargetDoubleCoda:e.addElement("Target").innerText="DoubleCoda";break;case xe.JumpDaCapo:e.addElement("Jump").innerText="DaCapo";break;case xe.JumpDaCapoAlCoda:e.addElement("Jump").innerText="DaCapoAlCoda";break;case xe.JumpDaCapoAlDoubleCoda:e.addElement("Jump").innerText="DaCapoAlDoubleCoda";break;case xe.JumpDaCapoAlFine:e.addElement("Jump").innerText="DaCapoAlFine";break;case xe.JumpDalSegno:e.addElement("Jump").innerText="DaSegno";break;case xe.JumpDalSegnoAlCoda:e.addElement("Jump").innerText="DaSegnoAlCoda";break;case xe.JumpDalSegnoAlDoubleCoda:e.addElement("Jump").innerText="DaSegnoAlDoubleCoda";break;case xe.JumpDalSegnoAlFine:e.addElement("Jump").innerText="DaSegnoAlFine";break;case xe.JumpDalSegnoSegno:e.addElement("Jump").innerText="DaSegnoSegno";break;case xe.JumpDalSegnoSegnoAlCoda:e.addElement("Jump").innerText="DaSegnoSegnoAlCoda";break;case xe.JumpDalSegnoSegnoAlDoubleCoda:e.addElement("Jump").innerText="DaSegnoSegnoAlDoubleCoda";break;case xe.JumpDalSegnoSegnoAlFine:e.addElement("Jump").innerText="DaSegnoSegnoAlFine";break;case xe.JumpDaCoda:e.addElement("Jump").innerText="DaCoda";break;case xe.JumpDaDoubleCoda:e.addElement("Jump").innerText="DaDoubleCoda"}}this.writeFermatas(s,t)}writeFermatas(e,t){const s=t.fermata?.size??0;if(0!==s&&s>0){const s=e.addElement("Fermatas");for(const[e,i]of t.fermata)this.writeFermata(s,e,i)}}writeFermata(e,t,s){let i=-1,a=1;if(t>0)for(;a<10&&(i=t/J.QuarterTime*a,i!==Math.floor(i));)i=-1,a++;else i=0,a=1;if(-1===i)return;const r=e.addElement("Fermata");r.addElement("Type").innerText=Ne[s.type],r.addElement("Length").innerText=s.length.toString(),r.addElement("Offset").innerText=`${i}/${a}`}writeBarNode(e,t){const s=e.addElement("Bar");s.attributes.set("id",t.id.toString()),s.addElement("Voices").innerText=t.voices.map(e=>e.isEmpty?"-1":e.id.toString()).join(" "),s.addElement("Clef").innerText=h[t.clef],t.clefOttava!==l.Regular&&(s.addElement("Ottavia").innerText=l[t.clefOttava].substr(1)),t.simileMark!==c.None&&(s.addElement("SimileMark").innerText=c[t.simileMark])}writeVoiceNode(e,t){if(t.isEmpty)return;const s=e.addElement("Voice");s.attributes.set("id",t.id.toString()),s.addElement("Beats").innerText=t.beats.map(e=>e.id).join(" ")}}Kc.SampleRate=44100,Kc.MidiProgramInfoLookup=new Map([[0,new jc(qc.Piano,"Acoustic Piano")],[1,new jc(qc.Piano,"Acoustic Piano")],[2,new jc(qc.Piano,"Electric Piano")],[3,new jc(qc.Piano,"Acoustic Piano")],[4,new jc(qc.Piano,"Electric Piano")],[5,new jc(qc.Piano,"Electric Piano")],[6,new jc(qc.Piano,"Harpsichord")],[7,new jc(qc.Piano,"Harpsichord")],[8,new jc(qc.PitchedIdiophone,"Celesta")],[9,new jc(qc.PitchedIdiophone,"Vibraphone")],[10,new jc(qc.PitchedIdiophone,"Vibraphone")],[11,new jc(qc.PitchedIdiophone,"Vibraphone")],[12,new jc(qc.PitchedIdiophone,"Xylophone")],[13,new jc(qc.PitchedIdiophone,"Xylophone")],[14,new jc(qc.PitchedIdiophone,"Vibraphone")],[15,new jc(qc.Banjo,"Banjo")],[16,new jc(qc.Piano,"Electric Organ")],[17,new jc(qc.Piano,"Electric Organ")],[18,new jc(qc.Piano,"Electric Organ")],[19,new jc(qc.Piano,"Electric Organ")],[20,new jc(qc.Piano,"Electric Organ")],[21,new jc(qc.Piano,"Electric Organ")],[22,new jc(qc.Woodwind,"Recorder")],[23,new jc(qc.Piano,"Electric Organ")],[24,new jc(qc.ClassicalGuitar,"Nylon Guitar")],[25,new jc(qc.SteelGuitar,"Steel Guitar")],[26,new jc(qc.SteelGuitar,"Electric Guitar")],[27,new jc(qc.ElectricGuitar,"Electric Guitar")],[28,new jc(qc.ElectricGuitar,"Electric Guitar")],[29,new jc(qc.ElectricGuitar,"Electric Guitar")],[30,new jc(qc.SteelGuitar,"Electric Guitar")],[31,new jc(qc.SteelGuitar,"Electric Guitar")],[32,new jc(qc.Bass,"Acoustic Bass")],[33,new jc(qc.Bass,"Electric Bass")],[34,new jc(qc.Bass,"Electric Bass")],[35,new jc(qc.Bass,"Acoustic Bass")],[36,new jc(qc.Bass,"Electric Bass")],[37,new jc(qc.Bass,"Electric Bass")],[38,new jc(qc.Synth,"Synth Bass")],[39,new jc(qc.Synth,"Synth Bass")],[40,new jc(qc.Strings,"Violin")],[41,new jc(qc.Strings,"Viola")],[42,new jc(qc.Strings,"Cello")],[43,new jc(qc.Strings,"Contrabass")],[44,new jc(qc.Strings,"Violin")],[45,new jc(qc.Strings,"Violin")],[46,new jc(qc.Piano,"Harp")],[47,new jc(qc.Membraphone,"Timpani")],[48,new jc(qc.Strings,"Violin")],[49,new jc(qc.Strings,"Violin")],[50,new jc(qc.Strings,"Violin")],[51,new jc(qc.Strings,"Violin")],[52,new jc(qc.Vocal,"Voice")],[53,new jc(qc.Vocal,"Voice")],[54,new jc(qc.Vocal,"Voice")],[55,new jc(qc.Synth,"Pad Synthesizer")],[56,new jc(qc.Brass,"Trumpet")],[57,new jc(qc.Brass,"Trombone")],[58,new jc(qc.Brass,"Tuba")],[59,new jc(qc.Brass,"Trumpet")],[60,new jc(qc.Brass,"French Horn")],[61,new jc(qc.Brass,"Trumpet")],[62,new jc(qc.Brass,"Trumpet")],[63,new jc(qc.Brass,"Trumpet")],[64,new jc(qc.Reed,"Saxophone")],[65,new jc(qc.Reed,"Saxophone")],[66,new jc(qc.Reed,"Saxophone")],[67,new jc(qc.Reed,"Saxophone")],[68,new jc(qc.Reed,"Oboe")],[69,new jc(qc.Reed,"English Horn")],[70,new jc(qc.Reed,"Bassoon")],[71,new jc(qc.Reed,"Clarinet")],[72,new jc(qc.Reed,"Piccolo")],[73,new jc(qc.Woodwind,"Flute")],[74,new jc(qc.Woodwind,"Recorder")],[75,new jc(qc.Woodwind,"Flute")],[76,new jc(qc.Woodwind,"Recorder")],[77,new jc(qc.Woodwind,"Flute")],[78,new jc(qc.Woodwind,"Recorder")],[79,new jc(qc.Woodwind,"Flute")],[80,new jc(qc.Synth,"Lead Synthesizer")],[81,new jc(qc.Synth,"Lead Synthesizer")],[82,new jc(qc.Synth,"Lead Synthesizer")],[83,new jc(qc.Synth,"Lead Synthesizer")],[84,new jc(qc.Synth,"Lead Synthesizer")],[85,new jc(qc.Synth,"Lead Synthesizer")],[86,new jc(qc.Synth,"Lead Synthesizer")],[87,new jc(qc.Synth,"Lead Synthesizer")],[88,new jc(qc.Synth,"Pad Synthesizer")],[89,new jc(qc.Synth,"Pad Synthesizer")],[90,new jc(qc.Synth,"Pad Synthesizer")],[91,new jc(qc.Synth,"Pad Synthesizer")],[92,new jc(qc.Synth,"Pad Synthesizer")],[93,new jc(qc.Synth,"Pad Synthesizer")],[94,new jc(qc.Synth,"Pad Synthesizer")],[95,new jc(qc.Synth,"Pad Synthesizer")],[96,new jc(qc.Fx,"Pad Synthesizer")],[97,new jc(qc.Fx,"Pad Synthesizer")],[98,new jc(qc.Fx,"Pad Synthesizer")],[99,new jc(qc.Fx,"Pad Synthesizer")],[100,new jc(qc.Fx,"Lead Synthesizer")],[101,new jc(qc.Fx,"Lead Synthesizer")],[102,new jc(qc.Fx,"Lead Synthesizer")],[103,new jc(qc.Fx,"Trumpet")],[104,new jc(qc.ElectricGuitar,"Banjo")],[105,new jc(qc.Banjo,"Banjo")],[106,new jc(qc.Ukulele,"Ukulele")],[107,new jc(qc.Banjo,"Banjo")],[108,new jc(qc.PitchedIdiophone,"Xylophone")],[109,new jc(qc.Reed,"Bassoon")],[110,new jc(qc.Strings,"Violin")],[111,new jc(qc.Woodwind,"Flute")],[112,new jc(qc.PitchedIdiophone,"Xylophone")],[113,new jc(qc.Idiophone,"Celesta")],[114,new jc(qc.PitchedIdiophone,"Vibraphone")],[115,new jc(qc.Idiophone,"Xylophone")],[116,new jc(qc.Membraphone,"Xylophone")],[117,new jc(qc.Membraphone,"Xylophone")],[118,new jc(qc.Membraphone,"Xylophone")],[119,new jc(qc.Idiophone,"Celesta")],[120,new jc(qc.Fx,"Steel Guitar")],[121,new jc(qc.Fx,"Recorder")],[122,new jc(qc.Fx,"Recorder")],[123,new jc(qc.Fx,"Recorder")],[124,new jc(qc.Fx,"Recorder")],[125,new jc(qc.Fx,"Recorder")],[126,new jc(qc.Fx,"Recorder")],[127,new jc(qc.Fx,"Timpani")]]),Kc.DrumKitProgramInfo=new jc(qc.PercussionKit,"Drums","drumKit"),Kc.defaultSteps=["C","C","D","D","E","F","F","G","G","A","A","B"];class Qc{static buildCrc32Lookup(){const e=new Uint32Array(256);for(let t=0;t<e.length;t++){let s=t;for(let e=0;e<8;e++)s=1&~s?s>>>1:s>>>1^3988292384;e[t]=s}return e}get value(){return~this._checkValue}constructor(){this._checkValue=Qc.CrcInit,this.reset()}update(e,t,s){for(let i=0;i<s;i++)this._checkValue=Qc.Crc32Lookup[255&(this._checkValue^e[t+i])]^this._checkValue>>>8}reset(){this._checkValue=Qc.CrcInit}}Qc.Crc32Lookup=Qc.buildCrc32Lookup(),Qc.CrcInit=4294967295;class Zc{}Zc.MAX_WBITS=15,Zc.WSIZE=1<<Zc.MAX_WBITS,Zc.WMASK=Zc.WSIZE-1,Zc.MIN_MATCH=3,Zc.MAX_MATCH=258,Zc.DEFAULT_MEM_LEVEL=8,Zc.PENDING_BUF_SIZE=1<<Zc.DEFAULT_MEM_LEVEL+8,Zc.HASH_BITS=Zc.DEFAULT_MEM_LEVEL+7,Zc.HASH_SIZE=1<<Zc.HASH_BITS,Zc.HASH_SHIFT=(Zc.HASH_BITS+Zc.MIN_MATCH-1)/Zc.MIN_MATCH,Zc.HASH_MASK=Zc.HASH_SIZE-1,Zc.MIN_LOOKAHEAD=Zc.MAX_MATCH+Zc.MIN_MATCH+1,Zc.MAX_DIST=Zc.WSIZE-Zc.MIN_LOOKAHEAD;class ed{constructor(e,t,s,i){this.length=null,this.numCodes=0,this.codes=null,this.huffman=e,this.minNumCodes=s,this.maxLength=i,this.freqs=new Int16Array(t),this.bitLengthCounts=new Int32Array(i)}reset(){for(let e=0;e<this.freqs.length;e++)this.freqs[e]=0;this.codes=null,this.length=null}buildTree(){const e=this.freqs.length,t=new Int32Array(e);let s=0,i=0;for(let a=0;a<e;a++){const e=this.freqs[a];if(0!==e){let r=s++;for(;r>0;){const s=Math.floor((r-1)/2);if(!(this.freqs[t[s]]>e))break;t[r]=t[s],r=s}t[r]=a,i=a}}for(;s<2;){const e=i<2?++i:0;t[s++]=e}this.numCodes=Math.max(i+1,this.minNumCodes);const a=s,r=new Int32Array(4*s-2),n=new Int32Array(2*s-1);let o=a;for(let e=0;e<s;e++){const s=t[e];r[2*e]=s,r[2*e+1]=-1,n[e]=this.freqs[s]<<8,t[e]=e}do{const e=t[0];let i=t[--s],a=0,h=1;for(;h<s;)h+1<s&&n[t[h]]>n[t[h+1]]&&h++,t[a]=t[h],a=h,h=2*h+1;let l=n[i];for(;h=a,a>0&&(a=Math.floor((h-1)/2),n[t[a]]>l);)t[h]=t[a];t[h]=i;const c=t[0];i=o++,r[2*i]=e,r[2*i+1]=c;const d=Math.min(255&n[e],255&n[c]);for(l=n[e]+n[c]-d+1,n[i]=l,a=0,h=1;h<s;)h+1<s&&n[t[h]]>n[t[h+1]]&&h++,t[a]=t[h],a=h,h=2*a+1;for(;h=a,h>0&&(a=Math.floor((h-1)/2),n[t[a]]>l);)t[h]=t[a];t[h]=i}while(s>1);this.buildLength(r)}buildLength(e){this.length=new Uint8Array(this.freqs.length);const t=Math.floor(e.length/2),s=Math.floor((t+1)/2);let i=0;for(let e=0;e<this.maxLength;e++)this.bitLengthCounts[e]=0;const a=new Int32Array(t);a[t-1]=0;for(let s=t-1;s>=0;s--)if(-1!==e[2*s+1]){let t=a[s]+1;t>this.maxLength&&(t=this.maxLength,i++),a[e[2*s]]=t,a[e[2*s+1]]=t}else{const t=a[s];this.bitLengthCounts[t-1]++,this.length[e[2*s]]=a[s]}if(0===i)return;let r=this.maxLength-1;do{for(;0===this.bitLengthCounts[--r];);do{this.bitLengthCounts[r]--,this.bitLengthCounts[++r]++,i-=1<<this.maxLength-1-r}while(i>0&&r<this.maxLength-1)}while(i>0);this.bitLengthCounts[this.maxLength-1]+=i,this.bitLengthCounts[this.maxLength-2]-=i;let n=2*s;for(let t=this.maxLength;0!==t;t--){let s=this.bitLengthCounts[t-1];for(;s>0;){const i=2*e[n++];-1===e[i+1]&&(this.length[e[i]]=t,s--)}}}getEncodedLength(){let e=0;for(let t=0;t<this.freqs.length;t++)e+=this.freqs[t]*this.length[t];return e}calcBLFreq(e){let t,s,i,a=-1,r=0;for(;r<this.numCodes;){i=1;const n=this.length[r];for(0===n?(t=138,s=3):(t=6,s=3,a!==n&&(e.freqs[n]++,i=0)),a=n,r++;r<this.numCodes&&a===this.length[r]&&(r++,!(++i>=t)););i<s?e.freqs[a]+=i:0!==a?e.freqs[ed.Repeat3To6]++:i<=10?e.freqs[ed.Repeat3To10]++:e.freqs[ed.Repeat11To138]++}}setStaticCodes(e,t){this.codes=e,this.length=t}buildCodes(){const e=new Int32Array(this.maxLength);let t=0;this.codes=new Int16Array(this.freqs.length);for(let s=0;s<this.maxLength;s++)e[s]=t,t+=this.bitLengthCounts[s]<<15-s;for(let t=0;t<this.numCodes;t++){const s=this.length[t];s>0&&(this.codes[t]=td.bitReverse(e[s-1]),e[s-1]+=1<<16-s)}}writeTree(e){let t,s,i,a=-1,r=0;for(;r<this.numCodes;){i=1;const n=this.length[r];for(0===n?(t=138,s=3):(t=6,s=3,a!==n&&(e.writeSymbol(n),i=0)),a=n,r++;r<this.numCodes&&a===this.length[r]&&(r++,!(++i>=t)););if(i<s)for(;i-- >0;)e.writeSymbol(a);else 0!==a?(e.writeSymbol(ed.Repeat3To6),this.huffman.pending.writeBits(i-3,2)):i<=10?(e.writeSymbol(ed.Repeat3To10),this.huffman.pending.writeBits(i-3,3)):(e.writeSymbol(ed.Repeat11To138),this.huffman.pending.writeBits(i-11,7))}}writeSymbol(e){this.huffman.pending.writeBits(65535&this.codes[e],this.length[e])}}ed.Repeat3To6=16,ed.Repeat3To10=17,ed.Repeat11To138=18;class td{static staticInit(){let e=0;for(;e<144;)td.staticLCodes[e]=td.bitReverse(48+e<<8),td.staticLLength[e++]=8;for(;e<256;)td.staticLCodes[e]=td.bitReverse(256+e<<7),td.staticLLength[e++]=9;for(;e<280;)td.staticLCodes[e]=td.bitReverse(-256+e<<9),td.staticLLength[e++]=7;for(;e<td.LITERAL_NUM;)td.staticLCodes[e]=td.bitReverse(-88+e<<8),td.staticLLength[e++]=8;for(e=0;e<td.DIST_NUM;e++)td.staticDCodes[e]=td.bitReverse(e<<11),td.staticDLength[e]=5}static bitReverse(e){return td.bit4Reverse[15&e]<<12|td.bit4Reverse[e>>4&15]<<8|td.bit4Reverse[e>>8&15]<<4|td.bit4Reverse[e>>12]}constructor(e){this.last_lit=0,this.extra_bits=0,this.pending=e,this.literalTree=new ed(this,td.LITERAL_NUM,257,15),this.distTree=new ed(this,td.DIST_NUM,1,15),this.blTree=new ed(this,td.BITLEN_NUM,4,7),this.d_buf=new Int16Array(td.BUFSIZE),this.l_buf=new Uint8Array(td.BUFSIZE)}isFull(){return this.last_lit>=td.BUFSIZE}reset(){this.last_lit=0,this.extra_bits=0,this.literalTree.reset(),this.distTree.reset(),this.blTree.reset()}flushStoredBlock(e,t,s,i){this.pending.writeBits((td.STORED_BLOCK<<1)+(i?1:0),3),this.pending.alignToByte(),this.pending.writeShort(s),this.pending.writeShort(~s),this.pending.writeBlock(e,t,s),this.reset()}flushBlock(e,t,s,i){this.literalTree.freqs[td.EOF_SYMBOL]++,this.literalTree.buildTree(),this.distTree.buildTree(),this.literalTree.calcBLFreq(this.blTree),this.distTree.calcBLFreq(this.blTree),this.blTree.buildTree();let a=4;for(let e=18;e>a;e--)this.blTree.length[td.BL_ORDER[e]]>0&&(a=e+1);let r=14+3*a+this.blTree.getEncodedLength()+this.literalTree.getEncodedLength()+this.distTree.getEncodedLength()+this.extra_bits,n=this.extra_bits;for(let e=0;e<td.LITERAL_NUM;e++)n+=this.literalTree.freqs[e]*td.staticLLength[e];for(let e=0;e<td.DIST_NUM;e++)n+=this.distTree.freqs[e]*td.staticDLength[e];r>=n&&(r=n),t>=0&&s+4<r>>3?this.flushStoredBlock(e,t,s,i):r===n?(this.pending.writeBits((td.STATIC_TREES<<1)+(i?1:0),3),this.literalTree.setStaticCodes(td.staticLCodes,td.staticLLength),this.distTree.setStaticCodes(td.staticDCodes,td.staticDLength),this.compressBlock(),this.reset()):(this.pending.writeBits((td.DYN_TREES<<1)+(i?1:0),3),this.sendAllTrees(a),this.compressBlock(),this.reset())}sendAllTrees(e){this.blTree.buildCodes(),this.literalTree.buildCodes(),this.distTree.buildCodes(),this.pending.writeBits(this.literalTree.numCodes-257,5),this.pending.writeBits(this.distTree.numCodes-1,5),this.pending.writeBits(e-4,4);for(let t=0;t<e;t++)this.pending.writeBits(this.blTree.length[td.BL_ORDER[t]],3);this.literalTree.writeTree(this.blTree),this.distTree.writeTree(this.blTree)}compressBlock(){for(let e=0;e<this.last_lit;e++){const t=255&this.l_buf[e];let s=this.d_buf[e];if(0!==s--){const e=td.Lcode(t);this.literalTree.writeSymbol(e);let i=Math.floor((e-261)/4);i>0&&i<=5&&this.pending.writeBits(t&(1<<i)-1,i);const a=td.Dcode(s);this.distTree.writeSymbol(a),i=Math.floor(a/2)-1,i>0&&this.pending.writeBits(s&(1<<i)-1,i)}else this.literalTree.writeSymbol(t)}this.literalTree.writeSymbol(td.EOF_SYMBOL)}tallyDist(e,t){this.d_buf[this.last_lit]=e,this.l_buf[this.last_lit++]=t-3;const s=td.Lcode(t-3);this.literalTree.freqs[s]++,s>=265&&s<285&&(this.extra_bits+=Math.floor((s-261)/4));const i=td.Dcode(e-1);return this.distTree.freqs[i]++,i>=4&&(this.extra_bits+=Math.floor(i/2)-1),this.isFull()}tallyLit(e){return this.d_buf[this.last_lit]=0,this.l_buf[this.last_lit++]=e,this.literalTree.freqs[e]++,this.isFull()}static Lcode(e){if(255===e)return 285;let t=257;for(;e>=8;)t+=4,e>>=1;return t+e}static Dcode(e){let t=0;for(;e>=4;)t+=2,e>>=1;return t+e}}td.BUFSIZE=1<<Zc.DEFAULT_MEM_LEVEL+6,td.LITERAL_NUM=286,td.STORED_BLOCK=0,td.STATIC_TREES=1,td.DYN_TREES=2,td.DIST_NUM=30,td.staticLCodes=new Int16Array(td.LITERAL_NUM),td.staticLLength=new Uint8Array(td.LITERAL_NUM),td.staticDCodes=new Int16Array(td.DIST_NUM),td.staticDLength=new Uint8Array(td.DIST_NUM),td.BL_ORDER=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],td.bit4Reverse=new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15]),td.BITLEN_NUM=19,td.EOF_SYMBOL=256,td.staticInit();class sd{constructor(e){this.maxChain=128,this.niceLength=128,this.goodLength=8,this.insertHashIndex=0,this.lookahead=0,this.inputBuf=null,this.inputOff=0,this.inputEnd=0,this.prevAvailable=!1,this.matchStart=0,this.matchLen=0,this.pending=e,this.huffman=new td(e),this.inputCrc=new Qc,this.window=new Uint8Array(2*Zc.WSIZE),this.head=new Int16Array(Zc.HASH_SIZE),this.prev=new Int16Array(Zc.WSIZE),this.blockStart=1,this.strstart=1}reset(){this.huffman.reset(),this.inputCrc.reset(),this.blockStart=1,this.strstart=1,this.lookahead=0,this.prevAvailable=!1,this.matchLen=Zc.MIN_MATCH-1;for(let e=0;e<Zc.HASH_SIZE;e++)this.head[e]=0;for(let e=0;e<Zc.WSIZE;e++)this.prev[e]=0}updateHash(){this.insertHashIndex=this.window[this.strstart]<<Zc.HASH_SHIFT^this.window[this.strstart+1]}needsInput(){return this.inputEnd===this.inputOff}setInput(e,t,s){const i=t+s;this.inputBuf=e,this.inputOff=t,this.inputEnd=i}deflate(e,t){let s;do{this.fillWindow();const i=e&&this.inputOff===this.inputEnd;s=this.deflateSlow(i,t)}while(this.pending.isFlushed&&s);return s}deflateSlow(e,t){if(this.lookahead<Zc.MIN_LOOKAHEAD&&!e)return!1;for(;this.lookahead>=Zc.MIN_LOOKAHEAD||e;){if(0===this.lookahead)return this.prevAvailable&&this.huffman.tallyLit(255&this.window[this.strstart-1]),this.prevAvailable=!1,this.huffman.flushBlock(this.window,this.blockStart,this.strstart-this.blockStart,t),this.blockStart=this.strstart,!1;this.strstart>=2*Zc.WSIZE-Zc.MIN_LOOKAHEAD&&this.slideWindow();const e=this.matchStart;let s=this.matchLen;if(this.lookahead>=Zc.MIN_MATCH){const e=this.insertString();0!==e&&this.strstart-e<=Zc.MAX_DIST&&this.findLongestMatch(e)&&this.matchLen===Zc.MIN_MATCH&&this.strstart-this.matchStart>sd.TooFar&&(this.matchLen=Zc.MIN_MATCH-1)}if(s>=Zc.MIN_MATCH&&this.matchLen<=s){this.huffman.tallyDist(this.strstart-1-e,s),s-=2;do{this.strstart++,this.lookahead--,this.lookahead>=Zc.MIN_MATCH&&this.insertString()}while(--s>0);this.strstart++,this.lookahead--,this.prevAvailable=!1,this.matchLen=Zc.MIN_MATCH-1}else this.prevAvailable&&this.huffman.tallyLit(255&this.window[this.strstart-1]),this.prevAvailable=!0,this.strstart++,this.lookahead--;if(this.huffman.isFull()){let e=this.strstart-this.blockStart;this.prevAvailable&&e--;const s=t&&0===this.lookahead&&!this.prevAvailable;return this.huffman.flushBlock(this.window,this.blockStart,e,s),this.blockStart+=e,!s}}return!0}findLongestMatch(e){let t,s=this.strstart;const i=s+Math.min(Zc.MAX_MATCH,this.lookahead)-1,a=Math.max(s-Zc.MAX_DIST,0),r=this.window,n=this.prev;let o=this.maxChain;const h=Math.min(this.niceLength,this.lookahead);if(this.matchLen=Math.max(this.matchLen,Zc.MIN_MATCH-1),s+this.matchLen>i)return!1;let l=r[s+this.matchLen-1],c=r[s+this.matchLen];this.matchLen>=this.goodLength&&(o>>=2);do{if(t=e,s=this.strstart,r[t+this.matchLen]===c&&r[t+this.matchLen-1]===l&&r[t]===r[s]&&r[++t]===r[++s]){switch((i-s)%8){case 1:if(r[++s]===r[++t])break;break;case 2:if(r[++s]===r[++t]&&r[++s]===r[++t])break;break;case 3:if(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t])break;break;case 4:if(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t])break;break;case 5:if(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t])break;break;case 6:if(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t])break;break;case 7:if(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t])break}if(r[s]===r[t])do{if(s===i){++s,++t;break}}while(r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]&&r[++s]===r[++t]);if(s-this.strstart>this.matchLen){if(this.matchStart=e,this.matchLen=s-this.strstart,this.matchLen>=h)break;l=r[s-1],c=r[s]}e=65535&n[e&Zc.WMASK]}}while(e>a&&0!==--o);return this.matchLen>=Zc.MIN_MATCH}insertString(){const e=(this.insertHashIndex<<Zc.HASH_SHIFT^this.window[this.strstart+(Zc.MIN_MATCH-1)])&Zc.HASH_MASK,t=this.head[e];return this.prev[this.strstart&Zc.WMASK]=t,this.head[e]=this.strstart,this.insertHashIndex=e,65535&t}fillWindow(){if(this.strstart>=Zc.WSIZE+Zc.MAX_DIST&&this.slideWindow(),this.lookahead<Zc.MIN_LOOKAHEAD&&this.inputOff<this.inputEnd){let e=2*Zc.WSIZE-this.lookahead-this.strstart;e>this.inputEnd-this.inputOff&&(e=this.inputEnd-this.inputOff),this.window.set(this.inputBuf.subarray(this.inputOff,this.inputOff+e),this.strstart+this.lookahead),this.inputCrc.update(this.inputBuf,this.inputOff,e),this.inputOff+=e,this.lookahead+=e}this.lookahead>=Zc.MIN_MATCH&&this.updateHash()}slideWindow(){this.window.set(this.window.subarray(Zc.WSIZE,Zc.WSIZE+Zc.WSIZE),0),this.matchStart-=Zc.WSIZE,this.strstart-=Zc.WSIZE,this.blockStart-=Zc.WSIZE;for(let e=0;e<Zc.HASH_SIZE;++e){const t=65535&this.head[e];this.head[e]=t>=Zc.WSIZE?t-Zc.WSIZE:0}for(let e=0;e<Zc.WSIZE;e++){const t=65535&this.prev[e];this.prev[e]=t>=Zc.WSIZE?t-Zc.WSIZE:0}}}sd.TooFar=4096;class id{get isFlushed(){return 0===this._end}constructor(e){this._start=0,this._end=0,this._bits=0,this.bitCount=0,this._buffer=new Uint8Array(e)}reset(){this._start=0,this._end=0,this.bitCount=0}writeShortMSB(e){this._buffer[this._end++]=e>>8&255,this._buffer[this._end++]=255&e}writeShort(e){this._buffer[this._end++]=e,this._buffer[this._end++]=e>>8}writeBlock(e,t,s){this._buffer.set(e.subarray(t,t+s),this._end),this._end+=s}flush(e,t,s){return this.bitCount>=8&&(this._buffer[this._end++]=255&this._bits,this._bits>>=8,this.bitCount-=8),s>this._end-this._start?(s=this._end-this._start,e.set(this._buffer.subarray(this._start,this._start+s),t),this._start=0,this._end=0):(e.set(this._buffer.subarray(this._start,this._start+s),t),this._start+=s),s}writeBits(e,t){this._bits|=e<<this.bitCount,this.bitCount+=t,this.bitCount>=16&&(this._buffer[this._end++]=255&this._bits,this._buffer[this._end++]=this._bits>>8&255,this._bits>>=16,this.bitCount-=16)}alignToByte(){this.bitCount>0&&(this._buffer[this._end++]=255&this._bits,this.bitCount>8&&(this._buffer[this._end++]=this._bits>>8&255)),this._bits=0,this.bitCount=0}}class ad{get inputCrc(){return this._engine.inputCrc.value}constructor(){this._state=0,this._pending=new id(Zc.PENDING_BUF_SIZE),this._engine=new sd(this._pending),this.reset()}get isNeedingInput(){return this._engine.needsInput()}get isFinished(){return this._state===ad.FinishedState&&this._pending.isFlushed}reset(){this._state=ad.BusyState,this._pending.reset(),this._engine.reset()}setInput(e,t,s){this._engine.setInput(e,t,s)}deflate(e,t,s){const i=s;for(;;){const a=this._pending.flush(e,t,s);if(t+=a,0===(s-=a)||this._state===ad.FinishedState)break;if(!this._engine.deflate(0!==(this._state&ad.IsFlushing),0!==(this._state&ad.IsFinishing)))switch(this._state){case ad.BusyState:return i-s;case ad.FlushingState:let e=8+(7&-this._pending.bitCount);for(;e>0;)this._pending.writeBits(2,10),e-=10;this._state=ad.BusyState;break;case ad.FinishingState:this._pending.alignToByte(),this._state=ad.FinishedState}}return i-s}finish(){this._state|=ad.IsFlushing|ad.IsFinishing}}ad.IsFlushing=4,ad.IsFinishing=8,ad.BusyState=16,ad.FlushingState=20,ad.FinishingState=28,ad.FinishedState=30;class rd{constructor(e,t,s,i,a){this.entry=e,this.crc32=t,this.localHeaderOffset=s,this.compressionMode=i,this.compressedSize=a}}class nd{constructor(e){this._centralDirectoryHeaders=[],this._deflater=new ad,this._data=e}writeEntry(e){const t=Qt.CompressionMethodDeflate,s=ut.empty(),i=this.compress(s,e.data,t),a=s.toArray(),r=new rd(e,i,this._data.bytesWritten,t,s.length);this._centralDirectoryHeaders.push(r),dt.writeInt32LE(this._data,Qt.LocalFileHeaderSignature),dt.writeUInt16LE(this._data,10),dt.writeUInt16LE(this._data,2048),dt.writeUInt16LE(this._data,t),dt.writeInt16LE(this._data,0),dt.writeInt16LE(this._data,0),dt.writeInt32LE(this._data,i),dt.writeInt32LE(this._data,a.length),dt.writeInt32LE(this._data,e.data.length),dt.writeInt16LE(this._data,e.fullName.length),dt.writeInt16LE(this._data,0);const n=dt.stringToBytes(e.fullName);this._data.write(n,0,n.length),this._data.write(a,0,a.length)}compress(e,t,s){if(s!==Qt.CompressionMethodDeflate){const s=new Qc;return s.update(t,0,t.length),e.write(t,0,t.length),s.value}const i=new Uint8Array(512);for(this._deflater.reset(),this._deflater.setInput(t,0,t.length);!this._deflater.isNeedingInput;){const t=this._deflater.deflate(i,0,i.length);if(t<=0)break;e.write(i,0,t)}for(this._deflater.finish();!this._deflater.isFinished;){const t=this._deflater.deflate(i,0,i.length);if(t<=0)break;e.write(i,0,t)}return this._deflater.inputCrc}end(){const e=this._data.bytesWritten;for(const e of this._centralDirectoryHeaders)this.writeCentralDirectoryHeader(e);const t=this._data.bytesWritten;this.writeEndOfCentralDirectoryRecord(e,t)}writeEndOfCentralDirectoryRecord(e,t){dt.writeInt32LE(this._data,Qt.EndOfCentralDirSignature),dt.writeInt16LE(this._data,0),dt.writeInt16LE(this._data,0),dt.writeInt16LE(this._data,this._centralDirectoryHeaders.length),dt.writeInt16LE(this._data,this._centralDirectoryHeaders.length),dt.writeInt32LE(this._data,t-e),dt.writeInt32LE(this._data,e),dt.writeInt16LE(this._data,0)}writeCentralDirectoryHeader(e){dt.writeInt32LE(this._data,Qt.CentralFileHeaderSignature),dt.writeUInt16LE(this._data,10),dt.writeUInt16LE(this._data,10),dt.writeUInt16LE(this._data,2048),dt.writeUInt16LE(this._data,e.compressionMode),dt.writeInt16LE(this._data,0),dt.writeInt16LE(this._data,0),dt.writeInt32LE(this._data,e.crc32),dt.writeInt32LE(this._data,e.compressedSize),dt.writeInt32LE(this._data,e.entry.data.length),dt.writeInt16LE(this._data,e.entry.fullName.length),dt.writeInt16LE(this._data,0),dt.writeInt16LE(this._data,0),dt.writeInt16LE(this._data,0),dt.writeInt16LE(this._data,0),dt.writeInt32LE(this._data,0),dt.writeInt32LE(this._data,e.localHeaderOffset);const t=dt.stringToBytes(e.entry.fullName);this._data.write(t,0,t.length)}}const od=Object.freeze(Object.defineProperty({__proto__:null,AlphaTexExporter:$c,Gp7Exporter:class extends Xc{get name(){return"Guitar Pro 7-8"}writeScore(e){ee.debug(this.name,"Writing data entries");const t=new Kc,s=t.writeXml(e),i=_s.writeForScore(e),a=Fs.writeForScore(e),r=Ls.writeForScore(e);ee.debug(this.name,"Writing ZIP entries");const n=new nd(this.data);n.writeEntry(new Qt("VERSION",dt.stringToBytes("7.0"))),n.writeEntry(new Qt("Content/",new Uint8Array(0))),n.writeEntry(new Qt("Content/BinaryStylesheet",i)),n.writeEntry(new Qt("Content/PartConfiguration",a)),n.writeEntry(new Qt("Content/LayoutConfiguration",r)),n.writeEntry(new Qt("Content/score.gpif",dt.stringToBytes(s))),t.backingTrackAssetFileName&&n.writeEntry(new Qt(t.backingTrackAssetFileName,e.backingTrack.rawAudioFile)),n.end()}},ScoreExporter:Xc},Symbol.toStringTag,{value:"Module"}));class hd extends ai{constructor(){super(0,0,Mt.EndOfTrack)}writeTo(t){throw new O(e.AlphaTabErrorType.General,"Deprecated event, serialization not supported")}}var ld,cd,dd;!function(e){e[e.SequenceNumber=0]="SequenceNumber",e[e.TextEvent=1]="TextEvent",e[e.CopyrightNotice=2]="CopyrightNotice",e[e.SequenceOrTrackName=3]="SequenceOrTrackName",e[e.InstrumentName=4]="InstrumentName",e[e.LyricText=5]="LyricText",e[e.MarkerText=6]="MarkerText",e[e.CuePoint=7]="CuePoint",e[e.PatchName=8]="PatchName",e[e.PortName=9]="PortName",e[e.MidiChannel=32]="MidiChannel",e[e.MidiPort=33]="MidiPort",e[e.EndOfTrack=47]="EndOfTrack",e[e.Tempo=81]="Tempo",e[e.SmpteOffset=84]="SmpteOffset",e[e.TimeSignature=88]="TimeSignature",e[e.KeySignature=89]="KeySignature",e[e.SequencerSpecific=127]="SequencerSpecific"}(ld||(ld={}));class ud extends hd{get metaStatus(){return ld.EndOfTrack}}!function(e){e[e.SystemExclusive=240]="SystemExclusive",e[e.MtcQuarterFrame=241]="MtcQuarterFrame",e[e.SongPosition=242]="SongPosition",e[e.SongSelect=243]="SongSelect",e[e.TuneRequest=246]="TuneRequest",e[e.SystemExclusive2=247]="SystemExclusive2"}(cd||(cd={}));class pd extends hd{}!function(e){e[e.MetronomeTick=0]="MetronomeTick",e[e.Rest=1]="Rest"}(dd||(dd={}));class md extends pd{constructor(){super(...arguments),this.data=new Uint8Array}get isMetronome(){return!1}get metronomeNumerator(){return-1}get metronomeDurationInTicks(){return-1}get metronomeDurationInMilliseconds(){return-1}get isRest(){return!1}get manufacturerId(){return 0}}md.AlphaTabManufacturerId=125;const gd=Object.freeze(Object.defineProperty({__proto__:null,AlphaSynthMidiFileHandler:jr,AlphaTabMetronomeEvent:oi,AlphaTabRestEvent:hi,AlphaTabSysExEvent:ni,get AlphaTabSystemExclusiveEvents(){return dd},BeatTickLookup:en,BeatTickLookupItem:Zr,ControlChangeEvent:ui,get ControllerType(){return Ot},DeprecatedMidiEvent:hd,EndOfTrackEvent:yi,MasterBarTickLookup:sn,MasterBarTickLookupTempoChange:tn,MetaDataEvent:class extends ud{constructor(){super(...arguments),this.data=new Uint8Array}},MetaEvent:ud,get MetaEventType(){return ld},MetaNumberEvent:class extends ud{constructor(){super(...arguments),this.value=0}},Midi20PerNotePitchBendEvent:class extends hd{constructor(){super(...arguments),this.noteKey=0,this.pitch=0}},MidiEvent:ai,get MidiEventType(){return Mt},MidiFile:ii,get MidiFileFormat(){return Et},MidiFileGenerator:cn,MidiTickLookup:rn,MidiTickLookupFindBeatResult:an,get MidiTickLookupFindBeatResultCursorMode(){return $t},MidiTrack:si,NoteBendEvent:fi,NoteEvent:li,NoteOffEvent:di,NoteOnEvent:ci,PitchBendEvent:gi,ProgramChangeEvent:pi,SystemCommonEvent:pd,get SystemCommonType(){return cd},SystemExclusiveEvent:md,TempoChangeEvent:mi,TimeSignatureEvent:ri},Symbol.toStringTag,{value:"Module"})),fd=Object.freeze(Object.defineProperty({__proto__:null,get AccentuationType(){return _},get AccidentalType(){return oe},Automation:q,get AutomationType(){return y},BackingTrack:xs,Bar:Y,get BarLineStyle(){return g},BarStyle:X,get BarSubElement(){return m},get BarreShape(){return fe},Beat:Ye,get BeatBeamingMode(){return be},BeatStyle:Xe,get BeatSubElement(){return Se},BendPoint:j,get BendStyle(){return b},get BendType(){return S},get BracketExtendMode(){return a},get BrushType(){return w},Chord:et,get Clef(){return h},Color:at,get CrescendoType(){return B},get Direction(){return xe},get Duration(){return k},get DynamicValue(){return f},ElementStyle:U,get FadeType(){return me},Fermata:pt,get FermataType(){return Ne},get Fingers(){return x},Font:Wa,get FontStyle(){return Wt},get FontWeight(){return Ht},get GolpeType(){return pe},GraceGroup:ie,get GraceType(){return T},get HarmonicType(){return N},HeaderFooterStyle:qe,InstrumentArticulation:Le,JsonConverter:Ar,get KeySignature(){return d},get KeySignatureType(){return u},Lyrics:tt,MasterBar:te,get MusicFontSymbol(){return ne},Note:Oe,get NoteAccidentalMode(){return P},get NoteOrnament(){return ce},NoteStyle:Re,get NoteSubElement(){return de},get Ottavia(){return l},get PickStroke(){return he},PlaybackInformation:rt,get Rasgueado(){return ye},RenderStylesheet:G,RepeatGroup:V,Score:Ke,ScoreStyle:je,get ScoreSubElement(){return ke},Section:st,get SimileMark(){return c},get SlideInType(){return v},get SlideOutType(){return E},Staff:ot,SustainPedalMarker:z,get SustainPedalMarkerType(){return p},SyncPointData:$,get TechniqueSymbolPlacement(){return le},Track:lt,get TrackNameMode(){return n},get TrackNameOrientation(){return o},get TrackNamePolicy(){return r},TrackStyle:ht,get TrackSubElement(){return _e},get TripletFeel(){return A},Tuning:nt,TupletGroup:We,get VibratoType(){return M},Voice:re,VoiceStyle:ae,get VoiceSubElement(){return R},get WahPedal(){return ge},get WhammyType(){return ue}},Symbol.toStringTag,{value:"Module"})),yd=Object.freeze(Object.defineProperty({__proto__:null,CssFontSvgCanvas:eo,Cursors:Rn,FontSizeDefinition:Or,FontSizes:Wr,MeasuredText:Je,SvgCanvas:Zn,get TextAlign(){return we},get TextBaseline(){return Be}},Symbol.toStringTag,{value:"Module"})),bd=Object.freeze(Object.defineProperty({__proto__:null,ActiveBeatsChangedEventArgs:wn,AlphaSynth:La,AlphaSynthAudioWorkletOutput:ti,AlphaSynthBase:Da,AlphaSynthScriptProcessorOutput:Ln,AlphaSynthWebAudioOutputBase:Zs,AlphaSynthWebWorkerApi:In,AudioExportChunk:Ca,AudioExportOptions:Fa,BackingTrackSyncPoint:Si,CircularSampleBuffer:Js,MidiEventsPlayedEventArgs:Ea,PlaybackRange:dn,PlaybackRangeChangedEventArgs:Ma,get PlayerState(){return Ft},PlayerStateChangedEventArgs:Ti,PositionChangedEventArgs:_i},Symbol.toStringTag,{value:"Module"})),Sd=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));Hc.isRunningInWorker?Hc.initializeWorker():Hc.isRunningInAudioWorklet?Hc.initializeAudioWorklet():Hc.initializeMain(t=>{if(Hc.webPlatform===e.WebPlatform.NodeJs)throw new O(e.AlphaTabErrorType.General,"Workers not yet supported in Node.js");if(Hc.webPlatform===e.WebPlatform.BrowserModule||Hc.isWebPackBundled||Hc.isViteBundled){ee.debug("AlphaTab","Creating webworker");try{return new Hc.alphaTabWorker(new Hc.alphaTabUrl("./alphaTab.worker.ts",{}),{type:"module"})}catch(e){ee.debug("AlphaTab","ESM webworker construction with direct URL failed",e)}let e="";try{e=new Hc.alphaTabUrl("./alphaTab.worker.ts",{});const t=`import ${JSON.stringify(e)}`,s=new Blob([t],{type:"application/javascript"});return new Worker(URL.createObjectURL(s),{type:"module"})}catch(t){ee.debug("AlphaTab","ESM webworker construction with blob import failed",e,t)}try{if(!t.core.scriptFile)throw new Error("Could not detect alphaTab script file");e=t.core.scriptFile;const s=`import ${JSON.stringify(t.core.scriptFile)}`,i=new Blob([s],{type:"application/javascript"});return new Worker(URL.createObjectURL(i),{type:"module"})}catch(e){ee.debug("AlphaTab","ESM webworker construction with blob import failed",t.core.scriptFile,e)}}if(!t.core.scriptFile)throw new O(e.AlphaTabErrorType.General,"Could not detect alphaTab script file, cannot initialize renderer");try{ee.debug("AlphaTab","Creating Blob worker");const e=`importScripts('${t.core.scriptFile}')`,s=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(s))}catch{return ee.warning("Rendering","Could not create inline worker, fallback to normal worker"),new Worker(t.core.scriptFile)}},(t,s)=>{if(Hc.webPlatform===e.WebPlatform.NodeJs)throw new O(e.AlphaTabErrorType.General,"Audio Worklets not yet supported in Node.js");if(Hc.webPlatform===e.WebPlatform.BrowserModule||Hc.isWebPackBundled||Hc.isViteBundled){ee.debug("AlphaTab","Creating Module worklet");return t.audioWorklet.addModule(new Hc.alphaTabUrl("./alphaTab.worklet.ts",{}))}return ee.debug("AlphaTab","Creating Script worklet"),t.audioWorklet.addModule(s.core.scriptFile)}),e.AlphaTabApi=Un,e.AlphaTabApiBase=vn,e.AlphaTabError=O,e.ConsoleLogger=Z,e.CoreSettings=Vc,e.DisplaySettings=za,e.EngravingSettings=Va,e.EngravingStemInfo=Ga,e.Environment=Hc,e.ExporterSettings=or,e.FileLoadError=En,e.FormatError=it,e.ImporterSettings=Xa,e.Logger=ee,e.NotationSettings=K,e.PlayerSettings=$a,e.ProgressEventArgs=Vn,e.RenderEngineFactory=Wc,e.RenderingResources=Ua,e.ResizeEventArgs=Sn,e.Settings=hr,e.SlidePlaybackSettings=Ja,e.VibratoPlaybackSettings=Ya,e.exporter=od,e.importer=Uc,e.io=zc,e.json=Sd,e.meta=W,e.midi=gd,e.model=fd,e.platform=yd,e.rendering=sc,e.synth=bd,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
